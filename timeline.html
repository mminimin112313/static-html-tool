<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지능형 사건 기록 시스템 v10.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid.js for Sequence Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        /* General Custom Styles */
        body { font-family: 'Pretendard', sans-serif; }
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        .record-entity { color: #2563eb; font-weight: 600; cursor: pointer; }
        .record-source { color: #15803d; font-weight: 600; cursor: pointer; }
        .record-relation { color: #c2410c; font-weight: bold; }
        .record-page { color: #a16207; font-size: 0.8rem; font-style: italic; }
        
        #context-panel.hidden { transform: translateX(100%); }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        
        .dragging { opacity: 0.5; background: #e0e7ff; border: 1px dashed #4f46e5; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        
        .summary-tag { transition: all 0.2s ease-in-out; }
        .summary-tag:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .todo-item input:checked + span { text-decoration: line-through; color: #9ca3af; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #autocomplete-box .selected { background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased text-slate-800">

    <!-- App Container -->
    <div id="app" class="flex h-screen overflow-hidden">

        <!-- Left Panel -->
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col flex-shrink-0">
            <div class="p-4 border-b border-slate-200">
                <h1 class="text-xl font-bold text-slate-700">사건 목록</h1>
            </div>
            <div class="p-4">
                <button id="show-add-case-modal-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    새 사건 추가
                </button>
            </div>
            <nav id="case-list" class="flex-1 overflow-y-auto p-2 space-y-1"></nav>
            
            <div id="case-summary-panel" class="p-4 border-t border-slate-200 hidden flex-1 overflow-y-auto">
                <h3 class="font-semibold text-slate-600 text-sm mb-2">주요 인물</h3>
                <div id="summary-entities" class="flex flex-wrap gap-2 text-xs"></div>
                <h3 class="font-semibold text-slate-600 text-sm mt-4 mb-2">주요 출처/자료</h3>
                <div id="summary-sources" class="flex flex-wrap gap-2 text-xs"></div>
            </div>

            <div class="p-4 border-t border-slate-200 space-y-2">
                <button id="backup-btn" class="w-full bg-slate-600 text-white py-2 px-4 rounded-lg hover:bg-slate-700">데이터 백업</button>
                <label class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 cursor-pointer text-center block">
                    데이터 복원 <input type="file" id="restore-input" class="hidden" accept=".json">
                </label>
            </div>
        </aside>

        <!-- Main Panel -->
        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
            <header class="p-4 border-b border-slate-200 bg-white flex-shrink-0">
                <h2 id="current-case-name" class="text-2xl font-bold text-slate-800">사건을 선택하세요</h2>
            </header>
            
            <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
                <div id="input-area" class="p-4 bg-white border-b border-slate-200 shadow-sm flex-shrink-0 relative">
                    <form id="record-form">
                        <input type="text" id="record-input" placeholder="날짜 #개체 > #개체 내용 @출처.페이지" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" autocomplete="off" disabled>
                    </form>
                    <div id="autocomplete-box" class="absolute bg-white border border-slate-300 rounded-md shadow-lg z-10 hidden w-[calc(100%-2rem)] mt-1 max-h-48 overflow-y-auto"></div>
                </div>
                
                <div class="px-4 pt-2 bg-white border-b border-slate-200 flex-shrink-0 flex justify-between items-center">
                    <div id="view-tabs" class="flex space-x-4">
                        <button data-view="list" class="tab-btn py-2 px-1 border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700 active">기록</button>
                        <button data-view="timeline" class="tab-btn py-2 px-1 border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700">타임라인</button>
                        <button data-view="sequence" class="tab-btn py-2 px-1 border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700">시퀀스</button>
                        <button data-view="files" class="tab-btn py-2 px-1 border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700">자료</button>
                        <button data-view="todos" class="tab-btn py-2 px-1 border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700">할 일</button>
                        <button data-view="memo" class="tab-btn py-2 px-1 border-b-2 border-transparent text-sm font-medium text-slate-500 hover:text-slate-700">메모</button>
                    </div>
                    <div class="flex items-center gap-2">
                         <input type="search" id="search-input" placeholder="#인물 AND @출처 OR '키워드'" class="w-64 p-1.5 border border-slate-300 rounded-md text-sm hidden">
                         <button id="clear-filter-btn" class="text-sm text-slate-500 hover:text-slate-800 hidden">초기화</button>
                         <button id="export-btn" class="text-sm bg-slate-200 px-3 py-1.5 rounded-md hover:bg-slate-300 hidden">내보내기</button>
                    </div>
                </div>

                <div id="view-container" class="flex-1 overflow-auto bg-slate-100 relative">
                    <div id="list-view" class="p-4"></div>
                    <div id="timeline-view" class="hidden p-4"></div>
                    <div id="sequence-view" class="hidden p-4 text-center bg-white"></div>
                    <div id="files-view" class="hidden p-4"></div>
                    <div id="todos-view" class="hidden p-4"></div>
                    <div id="memo-view" class="hidden p-4 h-full"></div>
                    <div id="placeholder-view" class="p-8 text-center text-slate-500"><p>사건을 선택하면 기록을 볼 수 있습니다.</p></div>
                    <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-75 hidden items-center justify-center flex-col gap-4"><div class="loader"></div><p>데이터를 불러오는 중...</p></div>
                </div>
            </div>
        </main>

        <!-- Right Panel (Context) -->
        <aside id="context-panel" class="w-96 bg-white border-l border-slate-200 p-4 transform transition-transform hidden flex-col flex-shrink-0">
            <div class="flex justify-between items-center border-b border-slate-200 pb-2 mb-4">
                <h3 id="context-title" class="text-lg font-bold">상세 정보</h3>
                <button id="close-context-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="context-content" class="flex-1 overflow-y-auto"></div>
        </aside>
    </div>

    <!-- Modals -->
    <div id="add-case-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium text-slate-900 text-center">새 사건 추가</h3>
            <form id="add-case-form" class="mt-4 space-y-3">
                <input type="text" id="new-case-name" placeholder="사건명" class="w-full p-2 border border-slate-300 rounded-md" required>
                <input type="text" id="new-case-number" placeholder="사건 번호 (선택)" class="w-full p-2 border border-slate-300 rounded-md">
                <div class="flex justify-end gap-2 pt-2">
                    <button id="cancel-case-btn" type="button" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">취소</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">저장</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        mermaid.initialize({ startOnLoad: false, theme: 'base', themeVariables: {
            'background': '#ffffff',
            'primaryColor': '#f1f5f9', 
            'primaryTextColor': '#0f172a', 
            'lineColor': '#64748b',
            'actorBkg': '#e2e8f0', 
            'actorBorder': '#94a3b8',
            'actorTextColor': '#1e293b',
            'messageTextColor': '#334155',
            'noteBkgColor': '#fefce8',
            'noteTextColor': '#713f12',
            'noteBorderColor': '#facc15',
            'sequenceNumberColor': '#ffffff',
        }});

        // --- DATABASE MODULE ---
        const DB_NAME = 'LawyerAppData_v9';
        const DB_VERSION = 1;
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject("DB error: " + e.target.errorCode);
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('cases')) db.createObjectStore('cases', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('records')) {
                        const s = db.createObjectStore('records', { keyPath: 'id', autoIncrement: true });
                        s.createIndex('caseId', 'caseId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('entities')) {
                        const s = db.createObjectStore('entities', { keyPath: 'id', autoIncrement: true });
                        s.createIndex('name', 'name', { unique: true });
                    }
                    if (!db.objectStoreNames.contains('sources')) {
                        const s = db.createObjectStore('sources', { keyPath: 'id', autoIncrement: true });
                        s.createIndex('name', 'name', { unique: true });
                    }
                    if (!db.objectStoreNames.contains('files')) {
                        const s = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                        s.createIndex('caseId', 'caseId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('todos')) {
                        const s = db.createObjectStore('todos', { keyPath: 'id', autoIncrement: true });
                        s.createIndex('caseId', 'caseId', { unique: false });
                    }
                };
            });
        }

        const dbActions = {
            add: (s, i) => new Promise((res, rej) => { const r = getStore(s, 'readwrite').add(i); r.onsuccess = ()=>res(r.result); r.onerror = ()=>rej(r.error); }),
            update: (s, i) => new Promise((res, rej) => { const r = getStore(s, 'readwrite').put(i); r.onsuccess = ()=>res(r.result); r.onerror = ()=>rej(r.error); }),
            getAll: (s) => new Promise((res, rej) => { const r = getStore(s, 'readonly').getAll(); r.onsuccess = ()=>res(r.result); r.onerror = ()=>rej(r.error); }),
            getById: (s, id) => new Promise((res, rej) => { const r = getStore(s, 'readonly').get(id); r.onsuccess = ()=>res(r.result); r.onerror = ()=>rej(r.error); }),
            delete: (s, id) => new Promise((res, rej) => { const r = getStore(s, 'readwrite').delete(id); r.onsuccess = ()=>res(); r.onerror = ()=>rej(r.error); }),
            getByCase: (s, id) => new Promise((res, rej) => { const r = getStore(s, 'readonly').index('caseId').getAll(id); r.onsuccess = ()=>res(r.result); r.onerror = ()=>rej(r.error); }),
            findByName: (s, n) => new Promise((res, rej) => { const r = getStore(s, 'readonly').index('name').get(n); r.onsuccess = ()=>res(r.result); r.onerror = ()=>rej(r.error); }),
            clearStore: (s) => new Promise((res, rej) => { const r = getStore(s, 'readwrite').clear(); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }),
        };
        function getStore(s, m) { return db.transaction(s, m).objectStore(s); }

        // --- PARSER MODULE ---
        function parseRecordText(rawText) {
            let text = rawText;
            const dateRegex = /^((?:\d{2,4})[.\-/년\s]+(?:\d{1,2})[.\-/월\s]+(?:\d{1,2})[일\s]*\.?)\s*/;
            const dateMatch = text.match(dateRegex);
            let eventTime = new Date();
            if (dateMatch) {
                const dateStr = dateMatch[1].replace(/[년월일]/g, '.').replace(/\s/g, '');
                const parts = dateStr.split('.').filter(p => p);
                if (parts.length === 3) {
                    let year = parseInt(parts[0]);
                    if (year < 100) year += 2000;
                    const month = parseInt(parts[1]) - 1;
                    const day = parseInt(parts[2]);
                    eventTime = new Date(year, month, day);
                    text = text.substring(dateMatch[0].length);
                }
            }

            const allEntities = [...text.matchAll(/#([^\s#@>]+)/g)].map(m => m[1]);
            const allSources = [...text.matchAll(/@([^\s#@.>]+)(?:\.(\d+))?/g)].map(m => ({ name: m[1], page: m[2] ? parseInt(m[2], 10) : null }));
            
            const relations = [];
            const relationIndex = text.indexOf('>');
            let description = text;

            if (relationIndex > -1) {
                const before = text.substring(0, relationIndex);
                const after = text.substring(relationIndex + 1);
                const fromEntities = [...before.matchAll(/#([^\s#@>]+)/g)].map(m => m[1]);
                const toEntities = [...after.matchAll(/#([^\s#@>]+)/g)].map(m => m[1]);

                if (fromEntities.length > 0 && toEntities.length > 0) {
                    const from = fromEntities[fromEntities.length - 1];
                    toEntities.forEach(to => relations.push({ from, to, type: '>' }));
                }
            }
            
            description = description.replace(/#[^\s#@>]+/g, '').replace(/@[^\s#@.>]+(\.\d+)?/g, '').replace('>', '').trim();
            
            return { rawText, eventTime: eventTime.toISOString().split('T')[0], description, entities: [...new Set(allEntities)], sources: allSources, relations };
        }
        
        // --- FILTER PARSER ---
        function parseFilterQuery(query) {
            const orGroups = query.split(/\s+OR\s+/i);
            return orGroups.map(andGroup => {
                const andConditions = andGroup.match(/(?:[^\s"]+|"[^"]*")+/g) || [];
                return andConditions.filter(c => c.toUpperCase() !== 'AND').map(condition => {
                    if (condition.startsWith('#')) return { type: 'entity', value: condition.substring(1) };
                    if (condition.startsWith('@')) return { type: 'source', value: condition.substring(1) };
                    if (condition.startsWith('/') && condition.endsWith('/')) return { type: 'regex', value: new RegExp(condition.slice(1, -1), 'i') };
                    return { type: 'text', value: condition.replace(/"/g, '') };
                });
            });
        }

        async function applyFilter(records, parsedQuery) {
            return records.filter(record => {
                return parsedQuery.some(andGroup => {
                    return andGroup.every(condition => {
                        const text = record.rawText.toLowerCase();
                        switch (condition.type) {
                            case 'entity': return record.entities.includes(condition.value);
                            case 'source': return record.sources.some(s => s.name === condition.value);
                            case 'regex': return condition.value.test(record.rawText);
                            case 'text': return text.includes(condition.value.toLowerCase());
                            default: return false;
                        }
                    });
                });
            });
        }

        // --- GLOBAL STATE & ELEMENTS ---
        let appState = { currentCaseId: null, currentView: 'list', draggedElement: null, searchTerm: '' };
        const caseListEl = document.getElementById('case-list');
        const currentCaseNameEl = document.getElementById('current-case-name');
        const recordInputEl = document.getElementById('record-input');
        const addCaseModalEl = document.getElementById('add-case-modal');
        const mainContentEl = document.getElementById('main-content');
        const placeholderViewEl = document.getElementById('placeholder-view');
        const caseSummaryPanel = document.getElementById('case-summary-panel');
        const searchInputEl = document.getElementById('search-input');
        const exportBtnEl = document.getElementById('export-btn');
        const clearFilterBtnEl = document.getElementById('clear-filter-btn');
        const loadingOverlayEl = document.getElementById('loading-overlay');
        const autocompleteBoxEl = document.getElementById('autocomplete-box');
        const contextTitleEl = document.getElementById('context-title');
        const contextContentEl = document.getElementById('context-content');
        const views = { list: document.getElementById('list-view'), timeline: document.getElementById('timeline-view'), sequence: document.getElementById('sequence-view'), files: document.getElementById('files-view'), todos: document.getElementById('todos-view'), memo: document.getElementById('memo-view') };

        // --- RENDER FUNCTIONS ---
        async function renderCases() {
            const cases = await dbActions.getAll('cases');
            caseListEl.innerHTML = cases.map(c => `<a href="#" data-id="${c.id}" class="block px-4 py-2 text-sm rounded-md ${c.id === appState.currentCaseId ? 'bg-blue-100 text-blue-800 font-semibold' : 'text-slate-600 hover:bg-slate-100'}"><p class="font-medium">${c.caseName}</p><p class="text-xs text-slate-500">${c.caseNumber || ''}</p></a>`).join('');
        }

        async function renderMainView() {
            loadingOverlayEl.style.display = 'flex';
            const hasCase = !!appState.currentCaseId;
            mainContentEl.classList.toggle('hidden', !hasCase);
            placeholderViewEl.classList.toggle('hidden', hasCase);
            caseSummaryPanel.classList.toggle('hidden', !hasCase);
            searchInputEl.classList.toggle('hidden', !hasCase);
            clearFilterBtnEl.classList.toggle('hidden', !hasCase);
            exportBtnEl.classList.toggle('hidden', !hasCase || appState.currentView !== 'timeline');
            document.getElementById('input-area').style.display = appState.currentView === 'list' ? 'block' : 'none';

            if (!hasCase) { loadingOverlayEl.style.display = 'none'; return; }

            Object.values(views).forEach(v => v.classList.add('hidden'));
            views[appState.currentView].classList.remove('hidden');
            
            let records = (await dbActions.getByCase('records', appState.currentCaseId)).sort((a, b) => a.sequence - b.sequence);
            
            if (appState.searchTerm) {
                const parsedQuery = parseFilterQuery(appState.searchTerm);
                records = await applyFilter(records, parsedQuery);
            }

            await renderCaseSummary(records);

            switch(appState.currentView) {
                case 'list': await renderRecordList(records); break;
                case 'timeline': await renderEnhancedTimeline(records); break;
                case 'sequence': await renderSequenceDiagram(records); break;
                case 'files': await renderFiles(); break;
                case 'todos': await renderTodos(); break;
                case 'memo': await renderMemo(); break;
            }
            loadingOverlayEl.style.display = 'none';
        }

        async function renderRecordList(records) {
            views.list.innerHTML = records.length ? '' : `<p class="text-center text-slate-500">${appState.searchTerm ? '필터와 일치하는 기록이 없습니다.' : '아직 기록이 없습니다.'}</p>`;
            for (const record of records) {
                const el = document.createElement('div');
                el.className = "bg-white p-3 rounded-lg shadow-sm mb-2 border border-slate-200 relative group";
                el.dataset.id = record.id;
                
                const viewDiv = document.createElement('div');
                viewDiv.className = 'record-view';
                viewDiv.innerHTML = await renderRecordContent(record);
                
                const editDiv = document.createElement('div');
                editDiv.className = 'record-edit hidden';
                editDiv.innerHTML = renderEditForm(record);

                el.appendChild(viewDiv);
                el.appendChild(editDiv);
                views.list.appendChild(el);
            }
        }
        
        async function renderRecordContent(record) {
            const escapeHtml = (str) => str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            let text = record.rawText;

            const placeholder = "___RELATION___";
            if (record.relations.length > 0) {
                const relationIndex = text.indexOf('>');
                if(relationIndex > -1) {
                    text = text.substring(0, relationIndex) + placeholder + text.substring(relationIndex + 1);
                }
            }
            
            text = escapeHtml(text);
            
            const entities = await Promise.all(record.entityIds.map(id => dbActions.getById('entities', id)));
            for (const entity of entities) if (entity) text = text.replace(new RegExp(`#${entity.name}`, 'g'), `<span class="record-entity" data-type="entity" data-id="${entity.id}">#${entity.name}</span>`);
            
            const sources = await Promise.all(record.sourceIds.map(id => dbActions.getById('sources', id)));
            for (const source of sources) {
                if (source) {
                    const recordSource = record.sources.find(s => s.name === source.name);
                    const pageText = recordSource && recordSource.page ? ` <span class="record-page">(p.${recordSource.page})</span>` : '';
                    text = text.replace(new RegExp(`@${source.name}(?:\\.${recordSource.page})?`, 'g'), `<span class="record-source" data-type="source" data-id="${source.id}">@${source.name}</span>${pageText}`);
                }
            }

            text = text.replace(placeholder, '<span class="record-relation">&gt;</span>');

            return `<div class="flex items-start"><span draggable="true" class="drag-handle text-slate-400 mr-3 mt-1 cursor-grab active:cursor-grabbing"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></span><div class="flex-1"><p class="text-slate-800 whitespace-pre-wrap">${text}</p><p class="text-xs text-slate-500 text-right mt-2">${record.eventTime}</p></div></div><div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1"><button class="edit-record-btn text-slate-500 hover:text-blue-600 p-1" title="수정"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg></button><button class="delete-record-btn text-slate-500 hover:text-red-600 p-1" title="삭제"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>`;
        }
        
        function renderEditForm(record) { return `<textarea class="w-full p-2 border border-slate-300 rounded-md h-24">${record.rawText}</textarea><div class="flex justify-end gap-2 mt-2"><button class="cancel-edit-btn px-3 py-1 bg-slate-200 rounded text-sm hover:bg-slate-300">취소</button><button class="save-edit-btn px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">저장</button></div>`; }

        async function renderEnhancedTimeline(records) {
            views.timeline.innerHTML = records.length ? `<table class="w-full bg-white rounded-lg shadow-md"><thead class="bg-slate-50 text-left text-sm font-semibold text-slate-600"><tr><th class="p-3 w-1/6">날짜</th><th class="p-3 w-3/6">핵심 내용</th><th class="p-3 w-1/6">관련 인물</th><th class="p-3 w-1/6">출처</th></tr></thead><tbody class="divide-y divide-slate-200"></tbody></table>` : `<p class="text-center text-slate-500">${appState.searchTerm ? '필터와 일치하는 기록이 없습니다.' : '타임라인을 표시할 기록이 없습니다.'}</p>`;
            if (!records.length) return;
            const tbody = views.timeline.querySelector('tbody');
            for (const record of records) {
                const entities = (await Promise.all(record.entityIds.map(id => dbActions.getById('entities', id)))).filter(Boolean).map(e => e.name).join(', ');
                const sources = (await Promise.all(record.sourceIds.map(id => dbActions.getById('sources', id)))).filter(Boolean).map(s => s.name).join(', ');
                tbody.innerHTML += `<tr class="text-sm text-slate-700 hover:bg-slate-50"><td class="p-3 font-medium whitespace-nowrap">${record.eventTime}</td><td class="p-3 whitespace-pre-wrap">${record.description.replace(/>/g, '&gt;')}</td><td class="p-3">${entities}</td><td class="p-3">${sources}</td></tr>`;
            }
        }

        async function renderSequenceDiagram(records) {
            const relations = records.filter(r => r.relations && r.relations.length > 0);
            if (relations.length === 0) { views.sequence.innerHTML = `<p>${appState.searchTerm ? '필터와 일치하는 기록이 없습니다.' : '시퀀스 다이어그램으로 표시할 상호작용(&gt;) 기록이 없습니다.'}</p>`; return; }
            
            const orderedParticipants = [];
            relations.forEach(r => {
                r.relations.forEach(rel => {
                    if (!orderedParticipants.includes(rel.from)) orderedParticipants.push(rel.from);
                    if (!orderedParticipants.includes(rel.to)) orderedParticipants.push(rel.to);
                });
            });

            const mermaidCode = `sequenceDiagram\nautonumber\n${orderedParticipants.map(p => `participant ${p}`).join('\n')}\n${relations.map(r => r.relations.map(rel => { const desc = r.description.replace(/>/g, '').replace(/:/g, '').replace(/"/g, '#quot;'); return `${rel.from}->>${rel.to}: ${desc}<br/>(${r.eventTime})`; }).join('\n')).join('\n')}`;
            views.sequence.innerHTML = `<div class="mermaid">${mermaidCode}</div>`;
            await mermaid.run({ nodes: [views.sequence.querySelector('.mermaid')] });
        }

        async function renderFiles() {
            views.files.innerHTML = `<div class="mb-4"><label class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 cursor-pointer text-center block">자료 업로드<input type="file" id="file-upload-input" class="hidden" multiple></label></div><div id="file-list" class="space-y-2"></div>`;
            const files = await dbActions.getByCase('files', appState.currentCaseId);
            const fileListEl = document.getElementById('file-list');
            fileListEl.innerHTML = files.length ? '' : '<p class="text-center text-slate-500">업로드된 자료가 없습니다.</p>';
            files.forEach(file => { fileListEl.innerHTML += `<div class="bg-white p-3 rounded-md shadow-sm border flex justify-between items-center"><span class="font-medium flex items-center gap-2">${getFileIcon(file.type)} ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)</span><button class="download-file-btn text-blue-600 hover:underline" data-id="${file.id}">다운로드</button></div>`; });
        }

        async function renderTodos() {
            views.todos.innerHTML = `<form id="add-todo-form" class="flex gap-2 mb-4"><input type="text" id="new-todo-input" class="flex-1 p-2 border rounded-md" placeholder="새로운 할 일..." required><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">추가</button></form><div id="todo-list" class="space-y-2"></div>`;
            const todos = await dbActions.getByCase('todos', appState.currentCaseId);
            const todoListEl = document.getElementById('todo-list');
            todoListEl.innerHTML = todos.length ? '' : '<p class="text-center text-slate-500">할 일이 없습니다.</p>';
            todos.forEach(todo => { todoListEl.innerHTML += `<div class="todo-item bg-white p-3 rounded-md shadow-sm border flex items-center"><input type="checkbox" data-id="${todo.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3" ${todo.isCompleted ? 'checked' : ''}><span>${todo.task}</span></div>`; });
        }

        async function renderMemo() {
            const caseData = await dbActions.getById('cases', appState.currentCaseId);
            views.memo.innerHTML = `<textarea id="memo-textarea" class="w-full h-full p-3 border rounded-md resize-none" placeholder="사건에 대한 메모를 자유롭게 작성하세요...">${caseData.memo || ''}</textarea>`;
        }
        
        async function renderCaseSummary(records) {
            const entitySet = new Map(), sourceSet = new Map();
            for (const record of records) {
                for (const id of record.entityIds) if (!entitySet.has(id)) entitySet.set(id, (await dbActions.getById('entities', id)).name);
                for (const id of record.sourceIds) if (!sourceSet.has(id)) sourceSet.set(id, (await dbActions.getById('sources', id)).name);
            }
            document.getElementById('summary-entities').innerHTML = [...entitySet.entries()].map(([id, name]) => `<span class="summary-tag bg-blue-100 text-blue-800 px-2 py-1 rounded-full cursor-pointer" data-filter="#${name}">#${name}</span>`).join('') + `<span class="summary-tag bg-slate-200 px-2 py-1 rounded-full cursor-pointer" data-filter="">전체</span>`;
            document.getElementById('summary-sources').innerHTML = [...sourceSet.entries()].map(([id, name]) => `<span class="summary-tag bg-green-100 text-green-800 px-2 py-1 rounded-full cursor-pointer" data-filter="@${name}">@${name}</span>`).join('');
        }
        
        // --- EVENT LISTENERS & LOGIC ---
        document.getElementById('show-add-case-modal-btn').addEventListener('click', () => addCaseModalEl.classList.remove('hidden'));
        document.getElementById('cancel-case-btn').addEventListener('click', () => addCaseModalEl.classList.add('hidden'));
        document.getElementById('add-case-form').addEventListener('submit', async (e) => { e.preventDefault(); const n = document.getElementById('new-case-name').value.trim(); if (n) { await dbActions.add('cases', { caseName: n, caseNumber: document.getElementById('new-case-number').value.trim() }); addCaseModalEl.classList.add('hidden'); e.target.reset(); await renderCases(); } });
        caseListEl.addEventListener('click', async (e) => { const l = e.target.closest('a'); if (l) { e.preventDefault(); appState.currentCaseId = Number(l.dataset.id); const c = await dbActions.getById('cases', appState.currentCaseId); currentCaseNameEl.textContent = c.caseName; recordInputEl.disabled = false; recordInputEl.focus(); searchInputEl.value = ''; appState.searchTerm = ''; await renderCases(); await renderMainView(); } });
        document.getElementById('record-form').addEventListener('submit', async (e) => { e.preventDefault(); const t = recordInputEl.value.trim(); if (!t || !appState.currentCaseId) return; const rs = await dbActions.getByCase('records', appState.currentCaseId); const maxSeq = rs.reduce((m, r) => Math.max(m, r.sequence || 0), 0); const p = parseRecordText(t); const eIds = await Promise.all(p.entities.map(async (n) => (await dbActions.findByName('entities', n) || {id: await dbActions.add('entities', {name: n})}).id)); const sIds = await Promise.all(p.sources.map(async (s) => (await dbActions.findByName('sources', s.name) || {id: await dbActions.add('sources', {name: s.name})}).id)); await dbActions.add('records', { caseId: appState.currentCaseId, ...p, entityIds: eIds, sourceIds: sIds, sequence: maxSeq + 1 }); recordInputEl.value = ''; await renderMainView(); });
        views.list.addEventListener('click', async (e) => { const t = e.target; const el = t.closest('[data-id]'); if (!el) return; const id = Number(el.dataset.id); if (t.closest('.delete-record-btn')) { if (confirm('이 기록을 삭제하시겠습니까?')) { await dbActions.delete('records', id); await renderMainView(); } } else if (t.closest('.edit-record-btn')) { el.querySelector('.record-view').classList.add('hidden'); el.querySelector('.record-edit').classList.remove('hidden'); el.querySelector('textarea').focus(); } else if (t.closest('.cancel-edit-btn')) { el.querySelector('.record-view').classList.remove('hidden'); el.querySelector('.record-edit').classList.add('hidden'); } else if (t.closest('.save-edit-btn')) { const newT = el.querySelector('textarea').value; const oldR = await dbActions.getById('records', id); const p = parseRecordText(newT); const eIds = await Promise.all(p.entities.map(async (n) => (await dbActions.findByName('entities', n) || {id: await dbActions.add('entities', {name: n})}).id)); const sIds = await Promise.all(p.sources.map(async (s) => (await dbActions.findByName('sources', s.name) || {id: await dbActions.add('sources', {name: s.name})}).id)); const upR = { ...oldR, ...p, entityIds: eIds, sourceIds: sIds }; await dbActions.update('records', upR); el.querySelector('.record-view').innerHTML = await renderRecordContent(upR); el.querySelector('.record-view').classList.remove('hidden'); el.querySelector('.record-edit').classList.add('hidden'); } });
        views.list.addEventListener('dragstart', (e) => { if (e.target.closest('.drag-handle')) { appState.draggedElement = e.target.closest('[data-id]'); appState.draggedElement.classList.add('dragging'); } else { e.preventDefault(); } });
        views.list.addEventListener('dragover', (e) => { e.preventDefault(); const t = e.target.closest('[data-id]'); if (t && t !== appState.draggedElement) { const r = t.getBoundingClientRect(); const n = (e.clientY - r.top) / (r.bottom - r.top) > .5; views.list.insertBefore(appState.draggedElement, n && t.nextSibling || t); } });
        views.list.addEventListener('drop', async (e) => { e.preventDefault(); if (!appState.draggedElement) return; appState.draggedElement.classList.remove('dragging'); const els = [...views.list.querySelectorAll('[data-id]')]; for (let i = 0; i < els.length; i++) { const id = Number(els[i].dataset.id); const r = await dbActions.getById('records', id); if (r.sequence !== i + 1) { r.sequence = i + 1; await dbActions.update('records', r); } } appState.draggedElement = null; });
        document.getElementById('view-tabs').addEventListener('click', (e) => { const b = e.target.closest('.tab-btn'); if (b && b.dataset.view !== appState.currentView) { document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); appState.currentView = b.dataset.view; renderMainView(); } });
        searchInputEl.addEventListener('input', (e) => { appState.searchTerm = e.target.value; renderMainView(); });
        clearFilterBtnEl.addEventListener('click', () => { searchInputEl.value = ''; appState.searchTerm = ''; renderMainView(); });
        caseSummaryPanel.addEventListener('click', (e) => { const t = e.target.closest('.summary-tag'); if (t) { searchInputEl.value = t.dataset.filter; appState.searchTerm = t.dataset.filter; renderMainView(); } });
        exportBtnEl.addEventListener('click', async () => { if (!appState.currentCaseId || appState.currentView !== 'timeline') { alert('표 타임라인 뷰에서만 내보내기가 가능합니다.'); return; } let rs = (await dbActions.getByCase('records', appState.currentCaseId)).sort((a, b) => a.sequence - b.sequence); let csv = "data:text/csv;charset=utf-8,날짜,핵심 내용,관련 인물,출처\n"; for (const r of rs) { const es = (await Promise.all(r.entityIds.map(id => dbActions.getById('entities', id)))).filter(Boolean).map(e => e.name).join('; '); const ss = (await Promise.all(r.sourceIds.map(id => dbActions.getById('sources', id)))).filter(Boolean).map(s => s.name).join('; '); const row = [r.eventTime, `"${r.description.replace(/>/g, '>')}"`, `"${es}"`, `"${ss}"`].join(','); csv += row + "\n"; } const uri = encodeURI(csv); const link = document.createElement("a"); link.setAttribute("href", uri); link.setAttribute("download", `timeline_export_${new Date().toISOString().split('T')[0]}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); });
        document.getElementById('backup-btn').addEventListener('click', async () => { if (!db) return; const data = {}; for (const s of db.objectStoreNames) { data[s] = await dbActions.getAll(s); } const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `lawyer-app-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(a.href); });
        document.getElementById('restore-input').addEventListener('change', (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = async (ev) => { try { const data = JSON.parse(ev.target.result); if (confirm('정말로 데이터를 복원하시겠습니까? 현재 모든 데이터가 교체됩니다.')) { for (const s of db.objectStoreNames) { await dbActions.clearStore(s); if (data[s]) { for (const i of data[s]) { const { id, ...item } = i; await dbActions.add(s, item); } } } alert('데이터 복원이 완료되었습니다.'); location.reload(); } } catch (err) { console.error("Restore error:", err); alert('파일 복원 중 오류 발생'); } }; r.readAsText(f); e.target.value = ''; });
        document.getElementById('close-context-btn').addEventListener('click', () => document.getElementById('context-panel').classList.add('hidden'));
        views.files.addEventListener('change', async (e) => { if (e.target.id === 'file-upload-input') { for (const file of e.target.files) { await dbActions.add('files', { caseId: appState.currentCaseId, name: file.name, type: file.type, size: file.size, data: file }); } renderFiles(); } });
        views.files.addEventListener('click', async (e) => { if (e.target.classList.contains('download-file-btn')) { const fileData = await dbActions.getById('files', Number(e.target.dataset.id)); const a = document.createElement('a'); a.href = URL.createObjectURL(fileData.data); a.download = fileData.name; a.click(); URL.revokeObjectURL(a.href); } });
        views.todos.addEventListener('submit', async (e) => { if (e.target.id === 'add-todo-form') { e.preventDefault(); const input = document.getElementById('new-todo-input'); const task = input.value.trim(); if (task) { await dbActions.add('todos', { caseId: appState.currentCaseId, task, isCompleted: false }); input.value = ''; renderTodos(); } } });
        views.todos.addEventListener('change', async (e) => { if (e.target.type === 'checkbox') { const todo = await dbActions.getById('todos', Number(e.target.dataset.id)); todo.isCompleted = e.target.checked; await dbActions.update('todos', todo); } });
        views.memo.addEventListener('input', async (e) => { if (e.target.id === 'memo-textarea') { const caseData = await dbActions.getById('cases', appState.currentCaseId); caseData.memo = e.target.value; await dbActions.update('cases', caseData); } });
        async function initializeApp() { await openDB(); await renderCases(); await renderMainView(); }
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
