<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사건 타임라인 시각화 도구 v15 (Final Polished)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- SortableJS CDN for robust drag-and-drop functionality -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /*
            DESIGN SYSTEM DEFINITION (v15.0) - The Final Polished Release
            - Principal Product Designer: Gemini

            CORE FIXES & ENHANCEMENTS:
            1.  Polished Deletion Flow: Replaced the clunky `window.confirm()` with a custom, beautifully animated confirmation modal that is consistent with the app's UI. This provides a safer and more pleasant user experience.
            2.  Smoother Modal Closing: Added subtle hover and active transitions to the modal 'X' close buttons for a more responsive and less "jarring" feel.
            3.  Code Refinement: Encapsulated the confirmation logic into a reusable UI function (UI.ConfirmationModal.show), making the code cleaner and more maintainable.
        */

        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --success-color: #28a745;
            --bg-color: #f8f9fa;
            --panel-bg: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --danger-color: #dc3545;
            --danger-hover: #b22222;
            --default-event-color: #212529; /* JS logic relies on this hex value */
            --note-bg: #fffbe6;
            --placeholder-bg: #e9ecef;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;

            --sidebar-width: 280px;
            --font-family: 'Poppins', 'Noto Sans KR', sans-serif;
            --transition-speed: 0.2s;
        }

        html, body { height: 100%; margin: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-primary); display: flex; flex-direction: column; overflow: hidden; }
        
        .app-wrapper { display: flex; flex-direction: column; height: 100%; }
        .top-nav { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 var(--spacing-md); height: 60px; background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color); z-index: 1000; }
        .top-nav-left { display: flex; align-items: center; gap: var(--spacing-sm); }
        .hamburger-menu, #settings-toggle { background: none; border: none; cursor: pointer; padding: var(--spacing-sm); color: var(--text-primary); border-radius: 50%; transition: background-color var(--transition-speed) ease; }
        .hamburger-menu:hover, #settings-toggle:hover { background-color: var(--placeholder-bg); }
        #current-project-title { font-size: 1.2rem; font-weight: 500; margin: 0; }
        main.app-content { flex-grow: 1; display: flex; overflow: auto; background-color: #e9ecef; padding: var(--spacing-md); }
        #diagram-container { margin: auto; background: var(--panel-bg); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .chat-input-footer { flex-shrink: 0; padding: var(--spacing-md) var(--spacing-lg); background-color: #f1f3f5; border-top: 1px solid var(--border-color); }
        #event-form { display: flex; gap: var(--spacing-sm); align-items: center; }
        #event-input { flex-grow: 1; height: 44px; padding: 0 16px; border-radius: 22px; border: 1px solid var(--border-color); font-size: 1rem; transition: box-shadow var(--transition-speed); }
        #event-input:focus { box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); border-color: var(--primary-color); outline: none; }
        #event-input:disabled { background-color: var(--placeholder-bg); }
        #send-button { width: 44px; height: 44px; border-radius: 50%; border: none; background-color: var(--primary-color); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background-color var(--transition-speed), transform var(--transition-speed); }
        #send-button:hover:not(:disabled) { background-color: var(--primary-hover); }
        #send-button:active:not(:disabled) { transform: scale(0.9); }
        #send-button:disabled { background-color: var(--text-secondary); cursor: not-allowed; }

        .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100%; background-color: var(--panel-bg); border-right: 1px solid var(--border-color); transform: translateX(calc(-1 * var(--sidebar-width))); transition: transform 0.3s ease-in-out; z-index: 1002; display: flex; flex-direction: column; }
        .sidebar.is-open { transform: translateX(0); box-shadow: 0 0 25px rgba(0,0,0,0.1); }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .sidebar-overlay.is-visible { opacity: 1; visibility: visible; }
        .sidebar-header { padding: var(--spacing-md); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #project-list { list-style: none; padding: var(--spacing-sm) 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        #project-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px var(--spacing-md); cursor: pointer; transition: background-color var(--transition-speed); }
        #project-list li:hover { background-color: var(--placeholder-bg); }
        #project-list li.active { background-color: var(--primary-color); color: white; }
        #project-list li.active:hover { background-color: var(--primary-hover); }
        .delete-project-btn { background: none; border: none; cursor: pointer; color: var(--danger-color); opacity: 0; padding: 4px; transition: opacity var(--transition-speed), background-color var(--transition-speed); border-radius: 50%; }
        #project-list li:hover .delete-project-btn { opacity: 1; }
        #project-list li:hover .delete-project-btn:hover { background-color: rgba(220, 53, 69, 0.1); }
        #project-list li.active .delete-project-btn { color: white; }
        .sidebar-footer { padding: var(--spacing-md); border-top: 1px solid var(--border-color); flex-shrink: 0; }
        button { transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed); }
        button:active { transform: scale(0.97); }
        #new-project-controls button, #new-project-form button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        #new-project-btn { background-color: var(--primary-color); color: white; width: 100%; }
        #new-project-btn:hover { background-color: var(--primary-hover); }
        #new-project-form { display: none; gap: var(--spacing-sm); }
        #new-project-name { flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); }
        .confirm-btn { background-color: var(--primary-color); color: white; }
        .confirm-btn:hover { background-color: var(--primary-hover); }
        .cancel-btn, .secondary-btn { background-color: var(--placeholder-bg); }
        .cancel-btn:hover, .secondary-btn:hover { background-color: #ddd; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: flex; align-items: center; justify-content: center; z-index: 1003; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal-overlay.is-visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease, opacity 0.3s; }
        .modal-overlay.is-visible .modal-content { transform: scale(1); opacity: 1; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--border-color); }
        .modal-header h2, .modal-header h4 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 1.8rem; line-height: 1; padding: 0 var(--spacing-sm); color: var(--text-secondary); cursor: pointer; border-radius: 50%; transition: color var(--transition-speed), background-color var(--transition-speed); }
        .modal-close-btn:hover { color: var(--text-primary); background-color: var(--placeholder-bg); }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); padding: 0 var(--spacing-lg); }
        .modal-tab-btn { padding: var(--spacing-md) var(--spacing-sm); margin-right: var(--spacing-md); background: none; border: none; cursor: pointer; font-size: 1rem; border-bottom: 3px solid transparent; color: var(--text-secondary); }
        .modal-tab-btn.active { border-bottom-color: var(--primary-color); color: var(--text-primary); font-weight: 500; }
        .modal-body { display: flex; padding: var(--spacing-lg); gap: var(--spacing-lg); overflow: hidden; flex-grow: 1; }
        .modal-tab-content { display: none; width: 100%; }
        .modal-tab-content.active { display: flex; gap: var(--spacing-lg); flex-grow: 1; }

        #actor-list-pane, #event-list-pane { flex: 2; display: flex; flex-direction: column; overflow: hidden; }
        #color-editor-pane { flex: 1; display: none; flex-direction: column; border-left: 1px solid var(--border-color); padding-left: var(--spacing-lg); }
        #color-editor-pane.visible { display: flex; }
        #actor-order-list, #modal-event-list-container { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        #actor-order-list li, #modal-event-list-container li { display: flex; align-items: center; padding: 10px; margin-bottom: var(--spacing-sm); border: 1px solid var(--border-color); border-radius: 6px; transition: background-color var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed); }
        #actor-order-list li { cursor: grab; background-color: var(--panel-bg); user-select: none; }
        #actor-order-list li:hover { background-color: var(--placeholder-bg); }
        #actor-order-list li.sortable-ghost { opacity: 0.4; background: #cce5ff; }
        #modal-event-list-container li { justify-content: space-between; cursor: pointer; }
        #modal-event-list-container li:hover { background-color: var(--placeholder-bg); }
        #modal-event-list-container li.active { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0,123,255,0.2); background-color: #f2f6ff;}
        #modal-event-list-container .event-edit-form { display: flex; width: 100%; gap: var(--spacing-sm); }
        #modal-event-list-container .event-edit-input { flex-grow: 1; border: 1px solid var(--primary-color); padding: 4px 8px; border-radius: 4px; }
        .modal-toolbar { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); }
        .sort-btn { background: var(--placeholder-bg); border: 1px solid transparent; padding: 6px 12px; border-radius: 15px; cursor: pointer; }
        .sort-btn.active { background: var(--primary-color); color: white; }

        .color-swatch { width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; cursor: pointer; box-shadow: 0 0 0 1px var(--border-color); transition: transform var(--transition-speed); }
        .color-swatch:hover { transform: scale(1.1); }
        .editor-actions, .confirmation-actions { margin-top: auto; display: flex; gap: var(--spacing-sm); }
        .confirmation-actions { justify-content: flex-end; }
        .editor-actions button, .confirmation-actions button { flex-grow: 1; border: none; padding: 10px; border-radius: 6px; cursor: pointer;}
        #edit-event-btn { background-color: var(--primary-hover); color: white; }
        .danger-btn { background-color: var(--danger-color); color: white; }
        .danger-btn:hover { background-color: var(--danger-hover); }
    </style>
</head>
<body>
    <div class="app-wrapper">
         <nav class="top-nav">
            <div class="top-nav-left">
                <button class="hamburger-menu" aria-label="프로젝트 목록 열기"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                <h1 id="current-project-title">로딩 중...</h1>
            </div>
            <button id="settings-toggle" aria-label="설정 열기"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22-.07.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg></button>
        </nav>
        <aside class="sidebar"></aside>
        <div class="sidebar-overlay"></div>
        <main class="app-content"><div id="diagram-container"></div></main>
        <footer class="chat-input-footer">
            <form id="event-form">
                <input type="text" id="event-input" placeholder="이벤트 입력 (예: 2025.3.4. 갑 을 .. 죽임)" autocomplete="off" disabled>
                <button type="submit" id="send-button" aria-label="전송" disabled></button>
            </form>
        </footer>
    </div>
    <div id="settings-modal" class="modal-overlay"></div>
    <div id="confirmation-modal" class="modal-overlay"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State ---
        let db;
        let projects = [];
        let currentProjectId = null;
        let selectedEventIdForModal = null;
        let currentSortForModal = 'time';
        let isEditingEventId = null;
        let sortableInstance = null;
        const PRESET_COLORS = ['#d9534f', '#f0ad4e', '#5cb85c', '#337ab7', '#5bc0de', '#777777', '#f783ac', '#6f42c1', '#20c997', '#fd7e14'];
        const DEFAULT_EVENT_COLOR_HEX = '#212529'; // Use a constant for JS logic
        
        // --- DOM Elements ---
        const projectTitleEl = document.getElementById('current-project-title');
        const diagramContainer = document.getElementById('diagram-container');
        const eventInput = document.getElementById('event-input');
        const sendButton = document.getElementById('send-button');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.querySelector('.sidebar-overlay');
        const settingsModalOverlay = document.getElementById('settings-modal');
        const confirmationModalOverlay = document.getElementById('confirmation-modal');

        // --- Database Handler ---
        const DB = {
            init: () => new Promise((resolve, reject) => { const req = indexedDB.open('TimelineProjectsDB_v15', 1); req.onerror = e => reject(e.target.errorCode); req.onsuccess = e => { db = e.target.result; resolve(db); }; req.onupgradeneeded = e => e.target.result.createObjectStore('projects', { keyPath: 'id', autoIncrement: true }); }),
            getProjects: () => new Promise((resolve, reject) => { try { const tx = db.transaction('projects', 'readonly'); tx.objectStore('projects').getAll().onsuccess = e => resolve(e.target.result); tx.onerror = e => reject(e.target.error); } catch(err) { reject(err); } }),
            saveProject: project => new Promise((resolve, reject) => { try { const tx = db.transaction('projects', 'readwrite'); tx.objectStore('projects').put(project).onsuccess = e => resolve(e.target.result); tx.onerror = e => reject(e.target.error); } catch(err) { reject(err); } }),
            deleteProject: id => new Promise((resolve, reject) => { try { const tx = db.transaction('projects', 'readwrite'); tx.objectStore('projects').delete(id).onsuccess = () => resolve(); tx.onerror = e => reject(e.target.error); } catch(err) { reject(err); } })
        };
        
        // --- Core Logic ---
        function getCurrentProject() { return projects.find(p => p.id === currentProjectId) || null; }

        async function createNewProject(name) {
            try {
                const newProject = { name, events: [], eventColorMap: {}, eventIdCounter: 0, actorOrder: [], createdAt: new Date() };
                const newId = await DB.saveProject(newProject);
                newProject.id = newId;
                projects.push(newProject);
                await switchProject(newId);
            } catch (err) { console.error("Failed to create project:", err); alert("프로젝트 생성 실패"); }
        }
        
        async function switchProject(id) {
            currentProjectId = id;
            localStorage.setItem('timeline_lastProjectId_v15', id);
            mainUpdate();
            UI.Sidebar.renderProjectList();
            UI.Sidebar.close();
        }

        function parseEventString(line) {
            const match = line.match(/^([\d\.\s-]+)\.\s*(.*?)\s*\.\.\s*(.*)$/);
            if (!match) return null;
            const [, dateStr, actorsStr, action] = match.map(s => s.trim());
            const eventActors = actorsStr.split(/\s+/).filter(Boolean);
            if (eventActors.length === 0) return null;
            const dateParts = dateStr.split('.').map(Number);
            const eventDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2] || 1);
            return { date: eventDate.toISOString(), dateStr, actors: eventActors, action, type: eventActors.length > 1 ? 'interaction' : 'solo' };
        }

        async function addEvent(line) {
            const project = getCurrentProject();
            if (!project) return;
            const parsedEvent = parseEventString(line);
            if (!parsedEvent) { alert("입력 형식이 올바르지 않습니다."); return; }
            
            project.events.push({ id: project.eventIdCounter, ...parsedEvent });
            project.eventIdCounter++;
            parsedEvent.actors.forEach(actor => { if (!project.actorOrder.includes(actor)) project.actorOrder.push(actor); });
            
            try { await DB.saveProject(project); mainUpdate(); } catch(err) { console.error("Failed to add event:", err); alert("이벤트 저장 실패"); }
        }

        async function handleDeleteProject(id) {
            const projectToDelete = projects.find(p => p.id === id);
            if (!projectToDelete) return;

            UI.ConfirmationModal.show(`정말로 '${projectToDelete.name}' 프로젝트를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`, async () => {
                 try {
                    await DB.deleteProject(id);
                    projects = projects.filter(p => p.id !== id);
                    if (currentProjectId === id) {
                        const latestProject = projects.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                        currentProjectId = latestProject ? latestProject.id : null;
                        localStorage.setItem('timeline_lastProjectId_v15', currentProjectId);
                    }
                    mainUpdate();
                    UI.Sidebar.renderProjectList();
                } catch(err) { console.error("Failed to delete project:", err); alert("프로젝트 삭제 실패"); }
            });
        }

        // --- UI Module ---
        const UI = {
            Sidebar: {
                init: () => {
                    sidebar.innerHTML = `
                        <div class="sidebar-header"><h2>프로젝트</h2></div>
                        <ul id="project-list"></ul>
                        <div class="sidebar-footer">
                            <div id="new-project-controls"><button id="new-project-btn">+ 새 프로젝트 만들기</button></div>
                            <form id="new-project-form">
                                <input type="text" id="new-project-name" placeholder="프로젝트 이름" required>
                                <button type="submit" class="confirm-btn">확인</button>
                                <button type="button" class="cancel-btn">취소</button>
                            </form>
                        </div>`;
                },
                open: () => { sidebar.classList.add('is-open'); sidebarOverlay.classList.add('is-visible'); },
                close: () => { sidebar.classList.remove('is-open'); sidebarOverlay.classList.remove('is-visible'); },
                renderProjectList: () => {
                    const listEl = document.getElementById('project-list');
                    listEl.innerHTML = '';
                    if (projects.length === 0) { listEl.innerHTML = '<li style="padding:12px 16px; color: var(--text-secondary);">프로젝트 없음</li>'; return; }
                    projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(p => {
                        const li = document.createElement('li');
                        li.dataset.id = p.id;
                        if (p.id === currentProjectId) li.classList.add('active');
                        li.innerHTML = `<span>${p.name}</span><button class="delete-project-btn" data-id="${p.id}">&times;</button>`;
                        listEl.appendChild(li);
                    });
                },
                showNewProjectForm: (show) => {
                    document.getElementById('new-project-controls').style.display = show ? 'none' : 'block';
                    document.getElementById('new-project-form').style.display = show ? 'flex' : 'none';
                    if(show) document.getElementById('new-project-name').focus();
                }
            },
            Diagram: {
                render: (project) => {
                    diagramContainer.innerHTML = '';
                    if (!project || !project.events || project.events.length === 0) {
                        diagramContainer.innerHTML = `<div style="text-align:center; color: var(--text-secondary); padding: 2rem;"><h2>타임라인</h2><p>하단 입력창에 이벤트를 추가하세요.</p></div>`;
                        return;
                    }
                    const allActorsInEvents = new Set();
                    project.events.forEach(e => e.actors.forEach(a => allActorsInEvents.add(a)));
                    const actorOrder = project.actorOrder || [];
                    const sortedActors = [...actorOrder].filter(actor => allActorsInEvents.has(actor));
                    allActorsInEvents.forEach(actor => { if (!sortedActors.includes(actor)) sortedActors.push(actor); });

                    const PADDING = 50, ACTOR_WIDTH = 120, ACTOR_SPACING = 160, STEP_HEIGHT = 100, LIFELINE_TOP_Y = 80;
                    const contentWidth = PADDING * 2 + (sortedActors.length > 0 ? (sortedActors.length - 1) * (ACTOR_WIDTH + ACTOR_SPACING) + ACTOR_WIDTH : 0);
                    const sortedEvents = [...project.events].sort((a,b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
                    const contentHeight = PADDING * 2 + LIFELINE_TOP_Y + sortedEvents.length * STEP_HEIGHT;
                    const actorPositions = new Map();
                    sortedActors.forEach((actor, i) => actorPositions.set(actor, PADDING + ACTOR_WIDTH / 2 + i * (ACTOR_WIDTH + ACTOR_SPACING)));
                    
                    let svgContent = '', defs = `<filter id="drop-shadow" x="-0.3" y="-0.3" width="1.6" height="1.6"><feGaussianBlur in="SourceAlpha" stdDeviation="3"/><feOffset dx="2" dy="2" result="offsetblur"/><feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>`;
                    sortedActors.forEach(actor => {
                        const x = actorPositions.get(actor);
                        svgContent += `<g style="filter:url(#drop-shadow);"><rect x="${x - ACTOR_WIDTH / 2}" y="20" width="${ACTOR_WIDTH}" height="40" rx="8" ry="8" fill="#fff" stroke="#aaa" /><text x="${x}" y="45" text-anchor="middle" font-family="var(--font-family)" font-weight="500">${actor}</text></g><line x1="${x}" y1="${LIFELINE_TOP_Y}" x2="${x}" y2="${contentHeight - PADDING}" stroke="#ccc" stroke-dasharray="5,5" />`;
                    });
                    
                    sortedEvents.forEach((event, i) => {
                        const y = LIFELINE_TOP_Y + (i + 1) * STEP_HEIGHT;
                        const eventColor = (project.eventColorMap || {})[event.id] || DEFAULT_EVENT_COLOR_HEX;
                        if (event.type === 'interaction') {
                            const sourceX = actorPositions.get(event.actors[0]), destX = actorPositions.get(event.actors[1]);
                            if (sourceX === undefined || destX === undefined) return;
                            const markerId = `arrowhead-${event.id}-${eventColor.replace('#','')}`;
                            svgContent += `<g><line x1="${sourceX}" y1="${y}" x2="${destX}" y2="${y}" stroke="${eventColor}" stroke-width="2" marker-end="url(#${markerId})"/><text x="${(sourceX + destX) / 2}" y="${y - 12}" text-anchor="middle" fill="${eventColor}" font-size="14px" font-weight="500">${event.action}</text><text x="${(sourceX + destX) / 2}" y="${y + 20}" text-anchor="middle" fill="var(--text-secondary)" font-size="12px">${event.dateStr}</text></g>`;
                            defs += `<marker id="${markerId}" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="${eventColor}"></path></marker>`;
                        } else {
                            const x = actorPositions.get(event.actors[0]);
                            if (x === undefined) return;
                            const noteW = 160, noteH = 70;
                            svgContent += `<g transform="translate(${x + 15}, ${y - noteH/2})"><path d="M0 0 H${noteW-10} L${noteW} 10 V${noteH} H0Z" fill="var(--note-bg)" stroke="${eventColor}" style="filter:url(#drop-shadow);" /><path d="M${noteW-10} 0 V10 H${noteW} Z" fill="rgba(0,0,0,0.15)" /><foreignObject x="5" y="5" width="${noteW - 10}" height="${noteH - 10}"><div xmlns="http://www.w3.org/1999/xhtml" style="font-family: var(--font-family); font-size: 13px; color: ${eventColor}; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; line-height: 1.3;"><b>${event.action}</b><div style="font-size: 11px; color: var(--text-secondary);">${event.dateStr}</div></div></foreignObject></g><line x1="${x}" y1="${y}" x2="${x+15}" y2="${y}" stroke="${eventColor}" stroke-dasharray="3,3" />`;
                        }
                    });
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("width", contentWidth);
                    svg.setAttribute("height", contentHeight);
                    svg.innerHTML = `<defs>${defs}</defs>${svgContent}`;
                    diagramContainer.appendChild(svg);
                }
            },
            SettingsModal: {
                open: function() {
                    const project = getCurrentProject();
                    if(!project) { alert("프로젝트를 선택해주세요."); return; }
                    settingsModalOverlay.innerHTML = `
                    <div class="modal-content">
                        <header class="modal-header">
                            <h2>설정</h2>
                            <button class="modal-close-btn" aria-label="닫기">&times;</button>
                        </header>
                        <div class="modal-tabs">
                            <button class="modal-tab-btn active" data-tab="events">이벤트</button>
                            <button class="modal-tab-btn" data-tab="actors">인물</button>
                        </div>
                        <div class="modal-body">
                            <div id="events-tab" class="modal-tab-content active">
                                 <div id="event-list-pane">
                                    <div class="modal-toolbar"><button class="sort-btn active" data-sort="time">시간순</button><button class="sort-btn" data-sort="id">등록순</button></div>
                                    <ul id="modal-event-list-container"></ul>
                                 </div>
                                 <div id="color-editor-pane"></div>
                            </div>
                            <div id="actors-tab" class="modal-tab-content">
                                <div id="actor-list-pane">
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0;">인물을 드래그하여 다이어그램 순서를 변경하세요.</p>
                                    <ul id="actor-order-list"></ul>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    settingsModalOverlay.classList.add('is-visible');
                    UI.SettingsModal.renderEventTab();
                    UI.SettingsModal.setupEventListeners();
                },
                close: () => {
                    isEditingEventId = null;
                    selectedEventIdForModal = null;
                    if (sortableInstance) {
                        sortableInstance.destroy();
                        sortableInstance = null;
                    }
                    settingsModalOverlay.classList.remove('is-visible');
                },
                switchTab: (tabName) => {
                    settingsModalOverlay.querySelectorAll('.modal-tab-btn, .modal-tab-content').forEach(el => el.classList.remove('active'));
                    const tabBtn = settingsModalOverlay.querySelector(`.modal-tab-btn[data-tab="${tabName}"]`);
                    const tabContent = settingsModalOverlay.querySelector(`#${tabName}-tab`);
                    if(tabBtn) tabBtn.classList.add('active');
                    if(tabContent) tabContent.classList.add('active');

                    isEditingEventId = null;
                    if(tabName === 'actors') UI.SettingsModal.renderActorTab();
                    else UI.SettingsModal.renderEventTab();
                },
                renderActorTab: () => {
                     const project = getCurrentProject();
                     if(!project) return;
                     const allActors = new Set();
                     project.events.forEach(e => e.actors.forEach(a => allActors.add(a)));
                     const actorOrder = project.actorOrder || [];
                     const sortedActors = [...actorOrder].filter(actor => allActors.has(actor));
                     allActors.forEach(actor => { if (!sortedActors.includes(actor)) sortedActors.push(actor); });
                     
                     const listEl = document.getElementById('actor-order-list');
                     if(!listEl) return;
                     listEl.innerHTML = '';
                     sortedActors.forEach(actor => {
                         const li = document.createElement('li');
                         li.textContent = actor;
                         li.dataset.actor = actor;
                         listEl.appendChild(li);
                     });
                     UI.SettingsModal.setupDragDrop();
                },
                renderEventTab: () => {
                    const project = getCurrentProject();
                    if(!project) return;
                    const container = document.getElementById('modal-event-list-container');
                    if(!container) return;

                    const events = [...project.events];
                    if (currentSortForModal === 'time') events.sort((a,b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
                    else events.sort((a,b) => a.id - b.id);
                    
                    container.innerHTML = '';
                    events.forEach(event => {
                        const li = document.createElement('li');
                        li.dataset.eventId = event.id;
                        if(event.id === selectedEventIdForModal) li.classList.add('active');

                        if(event.id === isEditingEventId) {
                            const originalText = `${event.dateStr}. ${event.actors.join(' ')} .. ${event.action}`;
                            li.innerHTML = `
                                <form class="event-edit-form" data-event-id="${event.id}">
                                    <input type="text" class="event-edit-input" value="${originalText}">
                                    <button type="submit" class="confirm-btn" style="padding: 4px 8px;">저장</button>
                                    <button type="button" class="cancel-edit-btn" style="padding: 4px 8px;">취소</button>
                                </form>
                            `;
                        } else {
                             const color = project.eventColorMap[event.id] || '#ccc';
                            li.innerHTML = `
                                <span>${event.dateStr}: ${event.actors.join(', ')} → ${event.action}</span>
                                <span style="width: 20px; height: 20px; background-color: ${color}; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1)"></span>
                            `;
                        }
                        container.appendChild(li);
                    });
                    UI.SettingsModal.renderColorEditor();
                },
                renderColorEditor: () => {
                     const pane = document.getElementById('color-editor-pane');
                     if(!pane) return;
                     const project = getCurrentProject();
                     const event = project.events.find(e => e.id === selectedEventIdForModal);

                     if (!event || isEditingEventId !== null) {
                         pane.classList.remove('visible');
                         pane.innerHTML = '';
                         return;
                     }
                     
                     pane.classList.add('visible');
                     pane.innerHTML = `
                        <h4>'${event.action}' 편집</h4>
                        <div id="preset-colors" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                            ${PRESET_COLORS.map(c => `<button class="color-swatch" data-color="${c}" style="background-color: ${c};"></button>`).join('')}
                        </div>
                        <label for="custom-color-picker">사용자 지정 색상:</label>
                        <input type="color" id="custom-color-picker" value="${project.eventColorMap[event.id] || '#000000'}">
                        <div class="editor-actions">
                           <button id="edit-event-btn" class="confirm-btn">내용 수정</button>
                           <button id="delete-event-btn" class="danger-btn">이벤트 삭제</button>
                        </div>
                     `;
                },
                setupDragDrop: () => {
                    const listEl = document.getElementById('actor-order-list');
                    if(!listEl) return;
                    if(sortableInstance) sortableInstance.destroy();
                    
                    sortableInstance = new Sortable(listEl, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: async (evt) => {
                            const newOrder = [...evt.target.children].map(li => li.dataset.actor);
                            const project = getCurrentProject();
                            if(project) {
                                project.actorOrder = newOrder;
                                await DB.saveProject(project);
                                mainUpdate();
                            }
                        }
                    });
                },
                setupEventListeners: () => {
                    const modal = settingsModalOverlay;
                    if(!modal) return;
                    
                    modal.addEventListener('click', async e => {
                        const project = getCurrentProject();
                        if (!project) return;

                        if (e.target.matches('.modal-tab-btn')) UI.SettingsModal.switchTab(e.target.dataset.tab);
                        else if(e.target.matches('.sort-btn')) {
                            currentSortForModal = e.target.dataset.sort;
                            modal.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
                            e.target.classList.add('active');
                            UI.SettingsModal.renderEventTab();
                        }
                        else if(e.target.closest('#modal-event-list-container li') && !e.target.closest('.event-edit-form')) {
                            const li = e.target.closest('li');
                            if (isEditingEventId !== null && isEditingEventId !== parseInt(li.dataset.eventId)) {
                                isEditingEventId = null; 
                            }
                            selectedEventIdForModal = parseInt(li.dataset.eventId);
                            UI.SettingsModal.renderEventTab();
                        }
                        else if(e.target.matches('.color-swatch')) {
                            project.eventColorMap[selectedEventIdForModal] = e.target.dataset.color;
                            await DB.saveProject(project);
                            UI.SettingsModal.renderEventTab();
                            mainUpdate();
                        }
                        else if(e.target.id === 'delete-event-btn') {
                            const eventToDelete = project.events.find(ev => ev.id === selectedEventIdForModal);
                            if(eventToDelete) {
                                UI.ConfirmationModal.show(`'${eventToDelete.action}' 이벤트를 삭제하시겠습니까?`, async () => {
                                    project.events = project.events.filter(ev => ev.id !== selectedEventIdForModal);
                                    delete project.eventColorMap[selectedEventIdForModal];
                                    const deletedId = selectedEventIdForModal;
                                    selectedEventIdForModal = null;
                                    isEditingEventId = isEditingEventId === deletedId ? null : isEditingEventId;
                                    await DB.saveProject(project);
                                    UI.SettingsModal.renderEventTab();
                                    mainUpdate();
                                });
                            }
                        }
                        else if (e.target.id === 'edit-event-btn') {
                            isEditingEventId = selectedEventIdForModal;
                            UI.SettingsModal.renderEventTab();
                        }
                        else if(e.target.matches('.cancel-edit-btn')) {
                            isEditingEventId = null;
                            UI.SettingsModal.renderEventTab();
                        }
                    });

                    modal.addEventListener('submit', async e => {
                        if(e.target.matches('.event-edit-form')) {
                            e.preventDefault();
                            const eventId = parseInt(e.target.dataset.eventId);
                            const input = e.target.querySelector('.event-edit-input');
                            const newEventData = parseEventString(input.value);

                            if(!newEventData) {
                                alert("잘못된 형식입니다. 수정을 취소합니다.");
                                isEditingEventId = null;
                                UI.SettingsModal.renderEventTab();
                                return;
                            }
                            const project = getCurrentProject();
                            const eventIndex = project.events.findIndex(ev => ev.id === eventId);
                            if(eventIndex > -1) {
                                const originalEvent = project.events[eventIndex];
                                newEventData.actors.forEach(actor => { if (!project.actorOrder.includes(actor)) project.actorOrder.push(actor); });
                                project.events[eventIndex] = { ...originalEvent, ...newEventData };
                                await DB.saveProject(project);
                                isEditingEventId = null;
                                UI.SettingsModal.renderEventTab();
                                mainUpdate();
                            }
                        }
                    });
                    
                    modal.addEventListener('change', async e => {
                        const project = getCurrentProject();
                        if (!project) return;
                        if(e.target.id === 'custom-color-picker') {
                            project.eventColorMap[selectedEventIdForModal] = e.target.value;
                            await DB.saveProject(project);
                            UI.SettingsModal.renderEventTab();
                            mainUpdate();
                        }
                    });
                }
            },
            ConfirmationModal: {
                show: (message, onConfirm) => {
                    confirmationModalOverlay.innerHTML = `
                        <div class="modal-content" style="max-width: 450px;">
                            <div class="modal-header">
                                <h4>삭제 확인</h4>
                                <button class="modal-close-btn">&times;</button>
                            </div>
                            <div class="modal-body" style="flex-direction: column; gap: var(--spacing-md);">
                                <p style="margin: 0; line-height: 1.6;">${message}</p>
                                <div class="confirmation-actions">
                                    <button class="secondary-btn" data-action="cancel">취소</button>
                                    <button class="danger-btn" data-action="confirm">삭제</button>
                                </div>
                            </div>
                        </div>`;
                    confirmationModalOverlay.classList.add('is-visible');

                    const confirmBtn = confirmationModalOverlay.querySelector('[data-action="confirm"]');
                    const cancelBtn = confirmationModalOverlay.querySelector('[data-action="cancel"]');
                    const closeBtn = confirmationModalOverlay.querySelector('.modal-close-btn');

                    const cleanup = () => {
                        UI.ConfirmationModal.hide();
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', cleanup);
                        closeBtn.removeEventListener('click', cleanup);
                    }

                    const handleConfirm = () => {
                        onConfirm();
                        cleanup();
                    }

                    confirmBtn.addEventListener('click', handleConfirm, { once: true });
                    cancelBtn.addEventListener('click', cleanup, { once: true });
                    closeBtn.addEventListener('click', cleanup, { once: true });
                },
                hide: () => {
                    confirmationModalOverlay.classList.remove('is-visible');
                }
            }
        };
        
        // --- App Main Update & Initialization ---
        function mainUpdate() {
            const project = getCurrentProject();
            if (!project) {
                projectTitleEl.textContent = "프로젝트 없음";
                diagramContainer.innerHTML = `<div style="text-align:center; padding: 2rem; color: var(--text-secondary);"><h2>환영합니다!</h2><p>왼쪽 메뉴에서 새 프로젝트를 만들어 타임라인 작성을 시작하세요.</p></div>`;
                eventInput.disabled = true;
                sendButton.disabled = true;
                sendButton.innerHTML = '';
                return;
            }
            projectTitleEl.textContent = project.name;
            eventInput.disabled = false;
            sendButton.disabled = false;
            sendButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3.4 20.4l17.45-7.48c.81-.35.81-1.49 0-1.84L3.4 3.6c-.66-.29-1.39.2-1.39.91L2 9.12c0 .5.37.93.87.99L17 12 2.87 13.88c-.5.07-.87.5-.87 1l.01 4.61c0 .71.73 1.2 1.39.91z"/></svg>`;
            UI.Diagram.render(project);
        }

        async function initializeApp() {
            try {
                await DB.init();
                projects = await DB.getProjects();
                
                let lastId = localStorage.getItem('timeline_lastProjectId_v15');
                currentProjectId = lastId ? parseInt(lastId) : null;
                if (!projects.find(p => p.id === currentProjectId)) {
                    const latestProject = projects.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                    currentProjectId = latestProject ? latestProject.id : null;
                }
                
                setupEventListeners();
                UI.Sidebar.renderProjectList();
                mainUpdate();
            } catch (err) {
                console.error("Application initialization failed:", err);
                projectTitleEl.textContent = "앱 로드 실패";
            }
        }
        
        function setupEventListeners(){
            UI.Sidebar.init();
            document.querySelector('.hamburger-menu').addEventListener('click', UI.Sidebar.open);
            sidebarOverlay.addEventListener('click', UI.Sidebar.close);

            document.getElementById('new-project-btn').addEventListener('click', () => UI.Sidebar.showNewProjectForm(true));
            document.querySelector('#new-project-form .cancel-btn').addEventListener('click', () => UI.Sidebar.showNewProjectForm(false));
            document.getElementById('new-project-form').addEventListener('submit', async e => {
                e.preventDefault();
                const input = document.getElementById('new-project-name');
                if (input.value.trim()) {
                    await createNewProject(input.value.trim());
                    input.value = '';
                    UI.Sidebar.showNewProjectForm(false);
                }
            });

            document.getElementById('project-list').addEventListener('click', e => {
                const li = e.target.closest('li[data-id]');
                const deleteBtn = e.target.closest('.delete-project-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    handleDeleteProject(parseInt(deleteBtn.dataset.id));
                } else if (li) {
                    switchProject(parseInt(li.dataset.id));
                }
            });

            document.getElementById('event-form').addEventListener('submit', e => {
                e.preventDefault();
                if (eventInput.value.trim()) {
                    addEvent(eventInput.value.trim());
                    eventInput.value = '';
                }
            });
            
            document.getElementById('settings-toggle').addEventListener('click', UI.SettingsModal.open);
            settingsModalOverlay.addEventListener('click', e => {
                if (e.target.matches('.modal-close-btn') || e.target.id === 'settings-modal') {
                    UI.SettingsModal.close();
                }
            });
            confirmationModalOverlay.addEventListener('click', e => {
                if (e.target.id === 'confirmation-modal') {
                     UI.ConfirmationModal.hide();
                }
            })
        }
        
        initializeApp();
    });
    </script>
</body>
</html>

