<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini File Store 관리자 (Pure CSS Fix)</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Pure CSS Implementation (Tailwind Replication) -->
    <style>
        :root {
            /* Tailwind Default Palette Colors */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --gray-950: #030712;

            --blue-400: #60a5fa;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --blue-800: #1e40af;
            
            --green-400: #4ade80;
            --green-600: #16a34a;
            --green-700: #15803d;
            --green-900: #14532d;

            --red-400: #f87171;
            --red-600: #dc2626;
            --red-700: #b91c1c;
            --red-900: #7f1d1d;

            --yellow-300: #fde047;
            --yellow-900: #713f12;

            /* Semantic Mapping */
            --bg-body: var(--gray-950);
            --bg-card: var(--gray-900);
            --bg-panel: var(--gray-800);
            --bg-input: var(--gray-700);
            
            --border-color: var(--gray-700);
            
            --text-white: #ffffff;
            --text-main: var(--gray-300);
            --text-muted: var(--gray-500);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Layout & Utilities --- */
        .h-screen { height: 100vh; }
        .h-full { height: 100%; }
        .w-full { width: 100%; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .flex-1 { flex: 1; }
        .flex-shrink-0 { flex-shrink: 0; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-4 > * + * { margin-left: 1rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .hidden { display: none; }
        .block { display: block; }
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .cursor-pointer { cursor: pointer; }

        /* --- Typography --- */
        .text-white { color: var(--text-white); }
        .text-gray-300 { color: var(--gray-300); }
        .text-gray-400 { color: var(--gray-400); }
        .text-gray-500 { color: var(--gray-500); }
        .text-blue-400 { color: var(--blue-400); }
        .text-red-400 { color: var(--red-400); }
        .text-green-400 { color: var(--green-400); }
        
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .text-center { text-align: center; }

        /* --- Specific Components (Tailwind Replica) --- */
        
        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 0.5rem; font-weight: 600; transition: all 0.2s;
            border: none; cursor: pointer;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-icon { padding: 0.5rem; border-radius: 9999px; background: transparent; color: var(--gray-400); }
        .btn-icon:hover { color: var(--text-white); background-color: var(--gray-700); }
        
        .btn-primary { background-color: var(--blue-600); color: white; padding: 0.5rem 1rem; }
        .btn-primary:hover:not(:disabled) { background-color: var(--blue-700); }
        
        .btn-primary-lg { background-color: var(--blue-600); color: white; padding: 0.75rem 1.5rem; font-weight: 700; }
        .btn-primary-lg:hover:not(:disabled) { background-color: var(--blue-700); }

        .btn-success { background-color: var(--green-600); color: white; padding: 0.5rem 1rem; }
        .btn-success:hover:not(:disabled) { background-color: var(--green-700); }

        .btn-danger-soft { background-color: var(--gray-700); color: white; padding: 0.5rem; }
        .btn-danger-soft:hover:not(:disabled) { background-color: var(--red-600); }

        .btn-nav { width: 100%; display: flex; align-items: center; justify-content: center; background-color: var(--blue-600); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .btn-nav:hover { background-color: var(--blue-700); }

        /* Inputs */
        .input-field {
            width: 100%; padding: 0.75rem 1rem; background-color: var(--gray-800); color: white;
            border: 1px solid var(--gray-600); border-radius: 0.5rem; outline: none;
        }
        .input-field:focus { border-color: var(--blue-500); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }

        /* Cards (Exact Replica) */
        .card {
            background-color: var(--gray-900);
            border: 1px solid var(--gray-700);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* shadow-xl */
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card:hover {
            transform: translateY(-0.25rem); /* -translate-y-1 */
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2); /* shadow-blue-500/20 */
        }

        /* Sidebar */
        .sidebar {
            width: 18rem; background-color: var(--gray-900); border-right: 1px solid var(--gray-700);
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-item {
            display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem;
            color: var(--gray-300); cursor: pointer; transition: background-color 0.15s;
            justify-content: space-between;
        }
        .sidebar-item:hover { background-color: var(--gray-800); }
        .sidebar-item.active { background-color: var(--blue-800); color: white; }

        /* Header */
        .header {
            background-color: var(--gray-900); border-bottom: 1px solid var(--gray-700);
            padding: 1rem; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }

        /* Grid */
        .grid-dashboard {
            display: grid; gap: 1.5rem;
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        @media (min-width: 768px) { .grid-dashboard { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .grid-dashboard { grid-template-columns: repeat(3, minmax(0, 1fr)); } }

        /* Badges */
        .badge { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background-color: var(--green-900); color: var(--green-400); }
        .badge-yellow { background-color: var(--yellow-900); color: var(--yellow-300); }
        .badge-red { background-color: var(--red-900); color: var(--red-400); }

        /* Table */
        .table-container {
            background-color: var(--gray-900); border-radius: 0.5rem; border: 1px solid var(--gray-700); overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background-color: var(--gray-800); }
        th {
            padding: 0.75rem 1.5rem; text-align: left; font-size: 0.75rem; font-weight: 500;
            color: var(--gray-300); text-transform: uppercase; letter-spacing: 0.05em;
        }
        tbody tr { border-top: 1px solid var(--gray-700); }
        tbody tr:hover { background-color: var(--gray-800); }
        td { padding: 1rem 1.5rem; white-space: nowrap; font-size: 0.875rem; color: var(--gray-300); }
        td.font-medium { font-weight: 500; color: white; }

        /* Chat Styles */
        .chat-container {
            display: flex; flex-direction: column; height: 100%;
        }
        .chat-messages {
            flex: 1; overflow-y: auto;
        }
        .chat-input-wrapper {
            flex-shrink: 0; padding: 1rem; background-color: var(--gray-950);
        }
        .msg-row { width: 100%; padding: 1.5rem; display: flex; gap: 1rem; max-width: 100%; }
        .msg-row.user { background-color: var(--gray-800); }
        .msg-row.model { background-color: var(--gray-900); }
        .avatar {
            flex-shrink: 0; width: 2rem; height: 2rem; border-radius: 9999px;
            background-color: var(--gray-700); display: flex; align-items: center; justify-content: center;
        }
        
        /* Markdown Content */
        .markdown-body { color: var(--gray-300); line-height: 1.6; font-size: 1rem; }
        .markdown-body strong { color: white; font-weight: 700; }
        .markdown-body p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin: 0.5em 0; }
        .markdown-body code { background-color: var(--gray-800); padding: 0.2em 0.4em; border-radius: 0.25rem; font-family: monospace; font-size: 0.9em; }
        .markdown-body pre { background-color: var(--gray-950); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1em 0; border: 1px solid var(--gray-700); }
        .markdown-body pre code { background-color: transparent; padding: 0; }
        .markdown-body a { color: var(--blue-400); text-decoration: underline; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .markdown-body th, .markdown-body td { border: 1px solid var(--gray-600); padding: 0.5rem; }
        .markdown-body th { background-color: var(--gray-700); color: white; }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1); width: 1.25rem; height: 1.25rem;
            border-radius: 50%; border-left-color: var(--blue-500); animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--gray-900); }
        ::-webkit-scrollbar-thumb { background: var(--gray-700); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gray-600); }
        
        .drag-over { border-style: dashed !important; border-color: var(--blue-500) !important; background-color: var(--gray-900) !important; }
    </style>
</head>
<body>
    <noscript>이 앱을 실행하려면 JavaScript가 필요합니다.</noscript>
    <div id="root"></div>

    <script type="text/babel">
(function() { // IIFE START

const { useState, useEffect, useRef, useMemo, useCallback } = React;

/* --- Icons --- */
const IconFolder = () => <i className="bi bi-folder text-xl"></i>;
const IconChat = () => <i className="bi bi-chat-dots text-xl"></i>;
const IconTrash = () => <i className="bi bi-trash text-xl"></i>;
const IconFile = () => <i className="bi bi-file-earmark-text text-xl"></i>;
const IconCloudUpload = () => <i className="bi bi-cloud-arrow-up text-xl"></i>;
const IconPlus = () => <i className="bi bi-plus-lg text-xl"></i>;
const IconSpinner = () => <div className="spinner"></div>;
const IconArrowLeft = () => <i className="bi bi-arrow-left text-xl"></i>;
const IconSearch = () => <i className="bi bi-search text-xl"></i>;
const IconCopy = () => <i className="bi bi-clipboard"></i>;
const IconCheck = () => <i className="bi bi-check-lg"></i>;
const IconUser = () => <i className="bi bi-person text-xl"></i>;
const IconGemini = () => <i className="bi bi-gem text-xl"></i>;
const IconEdit = () => <i className="bi bi-pencil"></i>;
const IconUploadQueue = () => <i className="bi bi-cloud-arrow-up text-xl"></i>;
const IconSettings = () => <i className="bi bi-gear text-xl"></i>;
const IconXCircle = () => <i className="bi bi-x-circle text-xl"></i>;
const IconExternalLink = () => <i className="bi bi-box-arrow-up-right text-xs"></i>;

/* --- API & Utils --- */
const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/';
const UPLOAD_BASE_URL = 'https://generativelanguage.googleapis.com/upload/v1beta/';
const DB_NAME = 'GeminiFileStoreDB';
const CHAT_STORE = 'chats';

function openDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, 1); request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains(CHAT_STORE)) { db.createObjectStore(CHAT_STORE, { keyPath: 'id' }); } }; request.onsuccess = (event) => { resolve(event.target.result); }; request.onerror = (event) => { reject('IndexedDB error'); }; }); }
function dbRequest(storeName, mode, operation) { return new Promise(async (resolve, reject) => { try { const db = await openDB(); const tx = db.transaction(storeName, mode); const store = tx.objectStore(storeName); operation(store, resolve, reject); tx.oncomplete = () => { if (mode !== 'readonly') { resolve(); } }; tx.onerror = (event) => { reject(event.target.error); }; } catch (error) { reject(error); } }); }
function getChatsFromDB() { return dbRequest(CHAT_STORE, 'readonly', (store, resolve) => { const request = store.getAll(); request.onsuccess = () => resolve(request.result); }); }
function saveChatToDB(chat) { return dbRequest(CHAT_STORE, 'readwrite', (store) => { store.put(chat); }); }
function deleteChatFromDB(chatId) { return dbRequest(CHAT_STORE, 'readwrite', (store) => { store.delete(chatId); }); }

async function apiRequest(endpoint, options = {}, apiKey) {
  let url = `${API_BASE_URL}${endpoint}`;
  if (options.params) { const query = new URLSearchParams(options.params).toString(); if (query) url += `?${query}`; }
  const headers = { 'Content-Type': 'application/json', 'x-goog-api-key': apiKey, ...options.headers };
  try {
    const response = await fetch(url, { ...options, method: options.method || 'GET', headers, params: undefined }); 
    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error?.message || response.statusText); }
    return await response.json();
  } catch (error) { console.error(`API Request Failed:`, error); throw error; }
}

async function apiUploadRequest(endpoint, file, metadata, apiKey) {
  const params = new URLSearchParams(); if (metadata.displayName) params.append('displayName', metadata.displayName);
  const url = `${UPLOAD_BASE_URL}${endpoint}?${params.toString()}`;
  const formData = new FormData(); formData.append('file', file);
  const response = await fetch(url, { method: 'POST', headers: { 'x-goog-api-key': apiKey }, body: formData });
  if (!response.ok) throw new Error(await response.text());
  return await response.json();
}

function formatBytes(bytes, decimals = 2) { if (!bytes || bytes === 0) return 'N/A'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return `${parseFloat((bytes / Math.pow(k, i)).toFixed(decimals < 0 ? 0 : decimals))} ${sizes[i]}`; }
function useClipboard(timeout = 1500) { const [copied, setCopied] = useState(false); const copy = useCallback((text) => { navigator.clipboard.writeText(text).then(() => { setCopied(true); setTimeout(() => setCopied(false), timeout); }); }, [timeout]); return [copied, copy]; }

/* --- Components (Fixed CSS & Logic) --- */

function SettingsModal({ isOpen, onClose, apiKey, setApiKey, systemInstruction, setSystemInstruction, selectedModel, setSelectedModel }) {
  const [localApiKey, setLocalApiKey] = useState(apiKey);
  const [localInstruction, setLocalInstruction] = useState(systemInstruction);
  const [localModel, setLocalModel] = useState(selectedModel); 
  if (!isOpen) return null;
  const handleSave = () => { setApiKey(localApiKey); setSystemInstruction(localInstruction); setSelectedModel(localModel); localStorage.setItem('gemini-api-key', localApiKey); localStorage.setItem('gemini-system-instruction', localInstruction); localStorage.setItem('gemini-selected-model', localModel); onClose(); };

  return (
    <div className="absolute top-0 left-0 w-full h-full flex items-center justify-center" style={{backgroundColor: 'rgba(0,0,0,0.75)', zIndex: 50}}>
      <div className="card w-full" style={{maxWidth: '36rem'}}>
        <h2 className="text-2xl font-bold text-white mb-6">설정</h2>
        <div className="space-y-4">
          <div><label className="block text-sm font-medium text-gray-300 mb-2">API Key</label><input type="password" value={localApiKey} onChange={(e) => setLocalApiKey(e.target.value)} className="input-field" /></div>
          <div><label className="block text-sm font-medium text-gray-300 mb-2">모델</label><select value={localModel} onChange={(e) => setLocalModel(e.target.value)} className="input-field"><option value="gemini-2.5-pro">Gemini 2.5 Pro</option><option value="gemini-2.5-flash">Gemini 2.5 Flash</option></select></div>
          <div><label className="block text-sm font-medium text-gray-300 mb-2">프롬프트</label><textarea rows="5" value={localInstruction} onChange={(e) => setLocalInstruction(e.target.value)} className="input-field" style={{resize:'none'}} /></div>
          <div className="flex justify-end space-x-4 mt-6"><button onClick={onClose} className="btn" style={{backgroundColor: 'var(--gray-600)', color:'white', padding:'0.5rem 1.5rem'}}>취소</button><button onClick={handleSave} className="btn btn-primary">저장</button></div>
        </div>
      </div>
    </div>
  );
}

function Header({ apiKey, onLogout, pendingOperations, removeOperation, onOpenSettings }) {
  const [showOps, setShowOps] = useState(false);
  const opCount = Object.keys(pendingOperations).length;

  return (
    <header className="header">
      <div className="flex items-center space-x-2"><IconGemini /><h1 className="text-xl font-bold text-white">File Store Manager</h1></div>
      <div className="flex items-center space-x-4">
        <div className="relative">
          <button onClick={() => setShowOps(!showOps)} className="btn btn-icon"><IconUploadQueue />{opCount > 0 && <span className="absolute top-0 right-0 block w-5 h-5 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center">{opCount}</span>}</button>
          {showOps && opCount > 0 && (
            <div className="absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 p-4">
              <h3 className="font-semibold text-white mb-2">진행중인 작업</h3>
              <ul className="max-h-64 overflow-y-auto space-y-2">{Object.values(pendingOperations).map(op => (<li key={op.id} className="flex justify-between text-sm text-gray-300"><span>{op.description}</span><button onClick={()=>removeOperation(op.id)} className="text-red-400 text-xs">닫기</button></li>))}</ul>
            </div>
          )}
        </div>
        <span className="text-sm text-gray-500 hidden md:block">Key: ...{apiKey.slice(-4)}</span>
        <button onClick={onOpenSettings} className="btn btn-icon"><IconSettings /></button>
        <button onClick={onLogout} className="btn" style={{backgroundColor:'var(--gray-700)', color:'white', padding:'0.5rem 1rem'}}>로그아웃</button>
      </div>
    </header>
  );
}

function ChatSidebar({ chats, selectedChat, onSelectChat, onCreateNewChat, onDeleteChat, onUpdateChat, onNavigateBack, currentStoreName }) {
  const [editingChatId, setEditingChatId] = useState(null);
  const [newTitle, setNewTitle] = useState('');
  const handleStartEdit = (chat) => { setEditingChatId(chat.id); setNewTitle(chat.title); };
  const handleSaveEdit = (chat) => { if (newTitle.trim()) { onUpdateChat({ ...chat, title: newTitle.trim() }); } setEditingChatId(null); };
  const filteredChats = chats.filter(c => c.storeName === selectedChat.storeName);

  return (
    <div className="sidebar">
      <div className="p-4 border-b border-gray-700">
        <button onClick={onNavigateBack} className="flex items-center space-x-2 text-sm text-gray-400 hover:text-white mb-3"><IconArrowLeft /> <span>모든 프로젝트</span></button>
        <h2 className="text-lg font-semibold text-white truncate" title={currentStoreName}>{currentStoreName}</h2>
      </div>
      <div className="p-4"><button onClick={onCreateNewChat} className="btn-nav"><IconPlus /> <span className="ml-2">새 채팅 시작</span></button></div>
      <nav className="flex-1 overflow-y-auto px-2 py-2 space-y-1">
        {filteredChats.map(chat => (
          <div key={chat.id} className={`sidebar-item ${selectedChat?.id === chat.id ? 'active' : ''}`}>
            {editingChatId === chat.id ? (
              <input type="text" value={newTitle} onChange={(e) => setNewTitle(e.target.value)} onBlur={() => handleSaveEdit(chat)} onKeyDown={(e) => e.key === 'Enter' && handleSaveEdit(chat)} className="input-field p-1 text-sm" autoFocus />
            ) : (
              <span className="flex-1 truncate" onClick={() => onSelectChat(chat)}>{chat.title}</span>
            )}
            <div className="flex items-center space-x-1 ml-2">
               {editingChatId !== chat.id && <button onClick={() => handleStartEdit(chat)} className="text-gray-500 hover:text-white"><IconEdit /></button>}
               <button onClick={() => onDeleteChat(chat.id)} className="text-gray-500 hover:text-red-400"><IconTrash /></button>
            </div>
          </div>
        ))}
      </nav>
    </div>
  );
}

function FileSearchStoreList({ stores, onCreateStore, onDeleteStore, onSelectStoreForDocs, onSelectStoreForChat, deletingStoreName }) {
  const [newStoreName, setNewStoreName] = useState('');
  const handleSubmit = (e) => { e.preventDefault(); if (newStoreName.trim()) { onCreateStore(newStoreName.trim()); setNewStoreName(''); } };

  return (
    <div className="animate-fade-in">
      <div className="bg-gray-900 rounded-lg border border-gray-700 p-6 mb-8 shadow-lg">
        <form onSubmit={handleSubmit} className="flex space-x-4">
          <input type="text" value={newStoreName} onChange={(e) => setNewStoreName(e.target.value)} className="input-field flex-1" placeholder="새 프로젝트 (스토어) 이름" />
          <button type="submit" className="btn-primary-lg flex items-center space-x-2"><IconPlus /> <span>생성</span></button>
        </form>
      </div>
      <h2 className="text-2xl font-bold text-white mb-6">프로젝트 대시보드 ({stores.length})</h2>
      <div className="grid-dashboard">
        {stores.map(store => (
          <div key={store.name} className="card">
            <div>
              <h3 className="text-xl font-bold text-white mb-2 truncate">{store.displayName}</h3>
              <p className="text-sm text-gray-500 truncate mb-4">{store.name}</p>
              <div className="flex space-x-4 text-sm text-gray-400 mb-6">
                <span className="flex items-center space-x-1"><IconFile /> <span>{store.activeDocumentsCount || 0} Docs</span></span>
                <span className="flex items-center space-x-1"><IconFolder /> <span>{formatBytes(store.sizeBytes)}</span></span>
              </div>
            </div>
            <div className="border-t border-gray-700 mt-4 pt-4 flex items-center space-x-2">
              <button onClick={() => onSelectStoreForDocs(store)} className="flex-1 btn-primary text-sm flex items-center justify-center space-x-2"><IconFolder /> <span>문서</span></button>
              <button onClick={() => onSelectStoreForChat(store)} className="flex-1 btn-success text-sm flex items-center justify-center space-x-2"><IconChat /> <span>채팅</span></button>
              <button onClick={() => onDeleteStore(store.name)} disabled={deletingStoreName === store.name} className="btn-danger-soft rounded-lg p-2">{deletingStoreName === store.name ? <IconSpinner /> : <IconTrash />}</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function DocumentList({ store, documents, onDeleteDocument, onUploadFiles, onSelectDocument, onBack, isLoading }) {
  const [uploadQueue, setUploadQueue] = useState([]); 
  const [isDragging, setIsDragging] = useState(false);
  const fileInputRef = useRef(null);
  const handleFilesChange = (files) => { if (files && files.length > 0) setUploadQueue(prev => [...prev, ...Array.from(files)]); };
  const handleUploadAll = () => { if(uploadQueue.length > 0) { onUploadFiles(store.name, uploadQueue); setUploadQueue([]); } };
  const handleDrop = (e) => { e.preventDefault(); setIsDragging(false); handleFilesChange(e.dataTransfer.files); };

  return (
    <div className={`animate-fade-in ${isDragging ? 'drag-over' : ''}`} onDragOver={(e) => {e.preventDefault(); setIsDragging(true)}} onDragLeave={() => setIsDragging(false)} onDrop={handleDrop}>
      <button onClick={onBack} className="flex items-center space-x-2 text-sm text-blue-400 hover:text-blue-300 mb-6"><IconArrowLeft /><span>프로젝트 대시보드로 돌아가기</span></button>
      <h2 className="text-2xl font-bold text-white mb-6">문서 관리: <span className="text-blue-400">{store.displayName}</span></h2>
      
      <div className={`mb-8 p-6 bg-gray-900 rounded-lg shadow-lg border border-gray-700 transition-all text-center`}>
        <input type="file" ref={fileInputRef} onChange={(e) => handleFilesChange(e.target.files)} multiple className="hidden" id="file-upload" />
        <label htmlFor="file-upload" className="cursor-pointer block p-8 border-2 border-dashed border-gray-600 rounded-lg">
          <div className="flex justify-center mb-2"><i className="bi bi-cloud-arrow-up text-4xl text-gray-500"></i></div>
          <p className="text-blue-400 font-semibold">파일 선택</p>
          <p className="text-sm text-gray-400">또는 파일을 드래그 앤 드롭하세요</p>
        </label>
        {uploadQueue.length > 0 && (
          <div className="mt-6 text-left">
            <h4 className="font-semibold text-white mb-3">업로드 대기열 ({uploadQueue.length})</h4>
            <ul className="max-h-48 overflow-y-auto space-y-2 bg-gray-800 p-3 rounded-lg border border-gray-700">
              {uploadQueue.map((f, i) => <li key={i} className="flex justify-between text-sm text-gray-300 p-2 bg-gray-700 rounded"><span>{f.name}</span><button onClick={()=>{setUploadQueue(uploadQueue.filter((_,idx)=>idx!==i))}} className="text-red-400"><IconXCircle/></button></li>)}
            </ul>
            <button onClick={handleUploadAll} className="btn-success w-full mt-4 flex justify-center items-center space-x-2"><IconCloudUpload /> <span>모두 업로드</span></button>
          </div>
        )}
      </div>

      <div className="table-container">
        <table>
          <thead><tr><th>표시 이름</th><th>상태</th><th>크기</th><th>MIME 유형</th><th className="text-right">작업</th></tr></thead>
          <tbody>
            {isLoading && !documents.length ? <tr><td colSpan="5" className="text-center py-8"><div className="flex justify-center"><IconSpinner /></div></td></tr> :
              documents.map(doc => (
                <tr key={doc.name}>
                  <td className="font-medium">{doc.displayName}</td>
                  <td><span className={`badge ${doc.state === 'ACTIVE' ? 'badge-green' : 'badge-yellow'}`}>{doc.state}</span></td>
                  <td>{formatBytes(doc.sizeBytes)}</td>
                  <td>{doc.mimeType}</td>
                  <td className="text-right space-x-2">
                    <button onClick={() => onSelectDocument(doc)} disabled={doc.state !== 'ACTIVE'} className="text-blue-400 hover:text-blue-300"><IconSearch /></button>
                    <button onClick={() => onDeleteDocument(doc.name)} className="text-red-400 hover:text-red-300"><IconTrash /></button>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  );
}

function DocumentSearch({ document, apiKey, onBack }) {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const handleSearch = async (e) => { e.preventDefault(); setIsLoading(true); try { const data = await apiRequest(`${document.name}:query`, { method: 'POST', body: JSON.stringify({ query, resultsCount: 10 }) }, apiKey); setResults(data.relevantChunks || []); } catch (err) { console.error(err); } finally { setIsLoading(false); } };

  return (
    <div className="animate-fade-in">
      <button onClick={onBack} className="flex items-center space-x-2 text-sm text-blue-400 hover:text-blue-300 mb-6"><IconArrowLeft /> <span>돌아가기</span></button>
      <h2 className="text-2xl font-bold text-white mb-2">시맨틱 검색: <span className="text-blue-400">{document.displayName}</span></h2>
      <form onSubmit={handleSearch} className="mb-8 flex space-x-4">
        <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} className="input-field flex-1" placeholder="문서 내용 검색..." />
        <button type="submit" className="btn-primary flex items-center space-x-2" disabled={isLoading}>{isLoading ? <IconSpinner /> : <IconSearch />} <span>검색</span></button>
      </form>
      <div className="space-y-4">
        {results.map((chunk, index) => (
          <div key={index} className="bg-gray-900 border border-gray-700 rounded-lg p-4">
            <p className="text-sm text-blue-400 mb-2 font-mono">청크 ID: ...{chunk.chunk.name.split('/').pop()}</p>
            <p className="text-gray-300 whitespace-pre-wrap">{chunk.chunk.text}</p>
          </div>
        ))}
      </div>
    </div>
  );
}

function ChatInterface({ chat, apiKey, systemInstruction, onUpdateChat, selectedModel }) { 
  const [messages, setMessages] = useState(chat.messages || []);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef(null);

  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isLoading]);

  const handleSubmit = async (e) => {
    e.preventDefault(); if (!input.trim() || isLoading) return;
    const newMsgs = [...messages, { role: 'user', text: input.trim() }];
    setMessages(newMsgs); setInput(''); setIsLoading(true);
    
    try {
      const payload = {
        systemInstruction: { parts: [{ text: systemInstruction || "정확한 출처를 명시하세요." }] },
        contents: [...newMsgs.map(m => ({ role: m.role, parts: [{ text: m.text }] }))],
        tools: [{ fileSearch: { fileSearchStoreNames: [chat.storeName] } }]
      };
      
      const data = await apiRequest(`models/${selectedModel || 'gemini-2.5-flash'}:generateContent`, { method: 'POST', body: JSON.stringify(payload) }, apiKey);
      const botMsg = { role: 'model', text: data.candidates[0].content.parts[0].text, groundingMetadata: data.candidates[0].groundingMetadata };
      
      const finalMsgs = [...newMsgs, botMsg];
      setMessages(finalMsgs); onUpdateChat({ ...chat, messages: finalMsgs });
    } catch (err) { console.error(err); } finally { setIsLoading(false); }
  };

  const ChatMessage = ({ message }) => {
    const html = useMemo(() => window.marked ? window.marked.parse(message.text) : message.text, [message.text]);
    return (
      <div className={`msg-row ${message.role}`}>
        <div className="avatar">{message.role === 'user' ? <IconUser /> : <IconGemini />}</div>
        <div className="flex-1 overflow-hidden">
          <div className="markdown-body" dangerouslySetInnerHTML={{ __html: html }} />
          {message.groundingMetadata?.groundingAttributions?.length > 0 && (
            <div className="mt-4 pt-3 border-t border-gray-700">
              <span className="text-xs text-gray-400 font-semibold">참조:</span>
              <div className="flex flex-wrap gap-2 mt-2">
                {message.groundingMetadata.groundingAttributions.map((attr, i) => (
                  <a key={i} href={attr.web?.uri} target="_blank" className="flex items-center space-x-1 text-xs bg-blue-900 text-blue-300 px-2 py-1 rounded-full hover:bg-blue-800">
                    <span>{attr.file?.displayName || '출처'}...</span><IconExternalLink />
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  return (
    <div className="chat-container animate-fade-in">
      <div className="chat-messages">
        {messages.length === 0 && !isLoading && <div className="flex h-full items-center justify-center text-gray-500">무엇이든 물어보세요.</div>}
        {messages.map((m, i) => <ChatMessage key={i} message={m} />)}
        {isLoading && <div className="msg-row model"><div className="avatar"><IconGemini/></div><div className="flex items-center ml-4"><IconSpinner /><span className="ml-2 text-gray-400">생각 중...</span></div></div>}
        <div ref={messagesEndRef} />
      </div>
      <div className="chat-input-wrapper">
        <form onSubmit={handleSubmit} className="max-w-4xl mx-auto flex space-x-4">
          <textarea rows="1" value={input} onChange={(e) => setInput(e.target.value)} className="input-field flex-1" style={{resize:'none', overflowY:'auto', maxHeight:'200px'}} placeholder="질문 입력... (Shift+Enter 줄바꿈)" onKeyDown={(e) => {if(e.key==='Enter' && !e.shiftKey) {e.preventDefault(); handleSubmit(e)}} }/>
          <button type="submit" className="btn-primary font-bold px-6" disabled={isLoading || !input.trim()}>전송</button>
        </form>
      </div>
    </div>
  );
}

function App() {
  const [apiKey, setApiKey] = useState(localStorage.getItem('gemini-api-key') || '');
  const [systemInstruction, setSystemInstruction] = useState(localStorage.getItem('gemini-system-instruction') || '');
  const [selectedModel, setSelectedModel] = useState(localStorage.getItem('gemini-selected-model') || 'gemini-2.5-flash');
  const [apiKeyValid, setApiKeyValid] = useState(false);
  const [isLoading, setIsLoading] = useState(true); // Added loading state
  
  const [currentView, setCurrentView] = useState('STORES'); 
  const [selectedStore, setSelectedStore] = useState(null);
  const [selectedDoc, setSelectedDoc] = useState(null);
  const [selectedChat, setSelectedChat] = useState(null);
  const [stores, setStores] = useState([]);
  const [documents, setDocuments] = useState([]);
  const [chats, setChats] = useState([]);
  const [pendingOperations, setPendingOperations] = useState({});
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [deletingStoreName, setDeletingStoreName] = useState(null);

  const validateApiKey = async (key) => { 
    if(!key) { setIsLoading(false); return; }
    setIsLoading(true);
    try { await apiRequest('fileSearchStores', { method: 'GET' }, key); setApiKeyValid(true); } catch { setApiKeyValid(false); } finally { setIsLoading(false); }
  };
  useEffect(() => { validateApiKey(apiKey); }, [apiKey]);
  useEffect(() => { if(apiKeyValid) { listStores(); loadChats(); } }, [apiKeyValid]);

  const addOperation = (id, desc) => setPendingOperations(prev => ({...prev, [id]: {id, description: desc}}));
  const removeOperation = (id) => setPendingOperations(prev => { const n = {...prev}; delete n[id]; return n; });

  const listStores = async () => { const data = await apiRequest('fileSearchStores', {}, apiKey); setStores(data.fileSearchStores || []); };
  const createStore = async (name) => { await apiRequest('fileSearchStores', { method: 'POST', body: JSON.stringify({ displayName: name }) }, apiKey); listStores(); };
  const deleteStore = async (name) => { setDeletingStoreName(name); try { await apiRequest(name, { method: 'DELETE', params: { force: true } }, apiKey); listStores(); } finally { setDeletingStoreName(null); } };
  
  const listDocuments = async (name) => { const data = await apiRequest(`${name}/documents`, {}, apiKey); setDocuments(data.documents || []); };
  const uploadFiles = async (storeName, files) => { for(const f of files) { const opId = Math.random(); addOperation(opId, `${f.name} 업로드`); await apiUploadRequest(`${storeName}:uploadToFileSearchStore`, f, {displayName:f.name}, apiKey); removeOperation(opId); } listDocuments(storeName); };
  const deleteDocument = async (name) => { await apiRequest(name, { method: 'DELETE' }, apiKey); if(selectedStore) listDocuments(selectedStore.name); };

  const loadChats = async () => { setChats(await getChatsFromDB()); };
  const createNewChat = (store) => { const c = { id: crypto.randomUUID(), storeName: store.name, title: '새 채팅', messages: [] }; setChats([c, ...chats]); setSelectedChat(c); saveChatToDB(c); setCurrentView('CHAT'); };
  const updateChat = (c) => { setSelectedChat(c); saveChatToDB(c); setChats(chats.map(chat => chat.id === c.id ? c : chat)); };
  const deleteChat = (id) => { deleteChatFromDB(id); setChats(chats.filter(c => c.id !== id)); if(selectedChat?.id === id) setCurrentView('STORES'); };

  if (isLoading) return <div className="h-screen flex items-center justify-center text-white"><IconSpinner /></div>;

  if (!apiKey || !apiKeyValid) return (
    <div className="h-screen flex items-center justify-center bg-gray-900">
      <div className="card" style={{width:'24rem'}}>
        <h2 className="text-3xl font-bold text-center text-blue-400 mb-6">Gemini Manager</h2>
        <input type="password" className="input-field mb-6" placeholder="API Key 입력" onBlur={(e)=>setApiKey(e.target.value)} />
        <button className="btn-primary w-full py-3 font-bold" onClick={()=>validateApiKey(apiKey)}>시작하기</button>
      </div>
    </div>
  );

  return (
    <div className="flex h-screen w-full bg-gray-950">
      <SettingsModal isOpen={isSettingsOpen} onClose={()=>setIsSettingsOpen(false)} apiKey={apiKey} setApiKey={setApiKey} systemInstruction={systemInstruction} setSystemInstruction={setSystemInstruction} selectedModel={selectedModel} setSelectedModel={setSelectedModel} />
      
      {currentView === 'CHAT' && <ChatSidebar chats={chats} selectedChat={selectedChat} onSelectChat={(c)=>updateChat(c)} onCreateNewChat={()=>createNewChat(selectedStore)} onDeleteChat={deleteChat} onUpdateChat={updateChat} onNavigateBack={()=>setCurrentView('STORES')} currentStoreName={selectedStore?.displayName} />}
      
      <div className="flex-1 flex flex-col h-full overflow-hidden">
        <Header apiKey={apiKey} onLogout={()=>{setApiKey(''); setApiKeyValid(false)}} pendingOperations={pendingOperations} removeOperation={removeOperation} onOpenSettings={()=>setIsSettingsOpen(true)} />
        
        {/* Main Layout Logic Fix: Chat view needs to fill height, others scroll */}
        <main className={`flex-1 w-full ${currentView !== 'CHAT' ? 'overflow-y-auto p-8' : 'overflow-hidden h-full'}`}>
          <div className={`h-full ${currentView !== 'CHAT' ? 'max-w-7xl mx-auto' : 'w-full'}`}>
            {currentView === 'STORES' && <FileSearchStoreList stores={stores} onCreateStore={createStore} onDeleteStore={deleteStore} onSelectStoreForDocs={(s)=>{setSelectedStore(s); listDocuments(s.name); setCurrentView('DOCS')}} onSelectStoreForChat={(s)=>{setSelectedStore(s); const existing = chats.find(c=>c.storeName===s.name); if(existing){updateChat(existing); setCurrentView('CHAT')}else{createNewChat(s)}}} deletingStoreName={deletingStoreName} />}
            {currentView === 'DOCS' && <DocumentList store={selectedStore} documents={documents} onDeleteDocument={deleteDocument} onUploadFiles={uploadFiles} onSelectDocument={(d)=>{setSelectedDoc(d); setCurrentView('DOC_SEARCH')}} onBack={()=>setCurrentView('STORES')} />}
            {currentView === 'DOC_SEARCH' && <DocumentSearch document={selectedDoc} apiKey={apiKey} onBack={()=>setCurrentView('DOCS')} />}
            {currentView === 'CHAT' && <ChatInterface chat={selectedChat} apiKey={apiKey} systemInstruction={systemInstruction} onUpdateChat={updateChat} selectedModel={selectedModel} />}
          </div>
        </main>
      </div>
    </div>
  );
}

const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(<App />);

})(); // IIFE END
    </script>
</body>
</html>
