<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KNBASE 1.1.5</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-app: #ffffff;
            --text-primary: #262626;
            --text-secondary: #737373;
            --border: #dbdbdb;
            --accent: #0095f6; /* Insta Blue */
            --danger: #ed4956;
            --bg-msg-me: #3797f0;
            --bg-msg-other: #efefef;
        }

        body {
            background-color: #fafafa;
            color: var(--text-primary);
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .slide-right { animation: slideRight 0.3s ease-out; }
        @keyframes slideRight { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .slide-left { animation: slideLeft 0.3s ease-out; }
        @keyframes slideLeft { from { transform: translateX(0); } to { transform: translateX(-100%); } }

        /* Markdown & Code */
        .prose p { margin-bottom: 0.5rem; line-height: 1.5; }
        .prose code { background: rgba(0,0,0,0.05); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; color: #d63384; }
        .prose pre { background: #262626; color: white; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        
        /* Spinner */
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(0,0,0,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Safe Area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Dropdown */
        .dropdown-menu {
            position: absolute; top: 100%; right: 0; mt: 0.5rem;
            background: white; border: 1px solid var(--border); border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; min-width: 140px;
            animation: fadeIn 0.1s ease-out;
        }
        .dropdown-item {
            display: flex; align-items: center; gap: 0.5rem; width: 100%;
            padding: 0.5rem 1rem; text-align: left; font-size: 0.875rem;
            color: var(--text-primary); hover:bg-gray-50; cursor: pointer;
        }
        .dropdown-item:hover { background-color: #fafafa; }
        .dropdown-item.danger { color: var(--danger); }
        
        /* Project Sidebar (was Chat List) */
        .project-sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 40;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);
            display: flex;
        }
        .project-sidebar-desktop {
             width: 280px; 
             border-r: 1px solid var(--border);
             flex-shrink: 0;
        }
        @media (min-width: 768px) {
            /* On Desktop, make the overlay static, allowing it to take space as a flex item */
            .project-sidebar-overlay { 
                position: static;
                width: 280px;
                background: none;
                backdrop-filter: none;
                z-index: 1;
            }
        }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen flex flex-col md:flex-row"></div>

    <script type="text/babel">
    
    /* --- UTILS --- */
    const copyToClipboard = (text) => {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {}, () => fallbackCopy(text));
        } else { fallbackCopy(text); }
    };
    const fallbackCopy = (text) => {
        const ta = document.createElement("textarea");
        ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.focus(); ta.select();
        try { document.execCommand('copy'); } catch (err) { console.error('Copy failed', err); }
        document.body.removeChild(ta);
    };
    const fmtCount = (n) => {
        if (!n) return '0';
        if (n >= 1000000) return (n/1000000).toFixed(1) + 'm';
        if (n >= 1000) return (n/1000).toFixed(1) + 'k';
        return n.toString();
    };
    const fmtSize = (bytes) => {
        if (!+bytes) return '0b';
        const k = 1024;
        const sizes = ['b', 'kb', 'mb', 'gb', 'tb'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))}${sizes[i]}`;
    };

    /* --- SERVICES --- */
    class GeminiService {
        constructor(apiKey) { this.apiKey = apiKey; this.baseUrl = 'https://generativelanguage.googleapis.com/v1beta/'; }
        
        async request(ep, opts={}) {
            let url = `${this.baseUrl}${ep}`;
            const cfg = { ...opts, headers: { 'Content-Type': 'application/json', 'x-goog-api-key': this.apiKey, ...opts.headers } };
            
            // Handle params
            if (opts.params) {
                const p = new URLSearchParams();
                Object.entries(opts.params).forEach(([k,v]) => { if (v!=null) p.append(k,v); });
                const qs = p.toString(); if (qs) url += `?${qs}`; delete cfg.params;
            }

            // Exponential Backoff Retry Logic
            for (let i = 0; i < 5; i++) {
                try {
                    const res = await fetch(url, cfg);
                    if (!res.ok) { 
                        const e = await res.json().catch(()=>({})); 
                        const errorMessage = e.error?.message || res.statusText;
                        if (res.status === 429 || res.status >= 500) { // Throttle or Server Error: Retry
                             if (i < 4) { await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); continue; }
                             throw new Error(`API Error: ${errorMessage}`);
                        }
                        throw new Error(errorMessage);
                    }
                    return res.json();
                } catch (error) {
                    if (i === 4 || !error.message.includes('API Error')) throw error; // Re-throw unretryable errors immediately
                }
            }
        }
        
        async generateContent(model, msgs, instr, store) {
            const payload = {
                contents: msgs.map(m => ({ role: m.role, parts: [{ text: m.text }] })),
                systemInstruction: { parts: [{ text: instr }] },
                tools: store ? [{ fileSearch: { fileSearchStoreNames: [store] } }] : []
            };
            return this.request(`models/${model}:generateContent`, { method: 'POST', body: JSON.stringify(payload) });
        }
        async listStores() { return (await this.request('fileSearchStores')).fileSearchStores || []; }
        async createStore(n, d) { return this.request('fileSearchStores', { method: 'POST', body: JSON.stringify({ displayName: n, description: d }) }); }
        async deleteStore(n) { return this.request(n, { method: 'DELETE', params: { force: true } }); }
        async listDocuments(s) {
            let all=[], pt=null;
            do { const r = await this.request(`${s}/documents`, { params: { pageSize: 20, pageToken: pt } }); if(r.documents) all.push(...r.documents); pt = r.nextPageToken; } while(pt);
            return all;
        }
        async queryDocument(d, q) { return this.request(`${d}:query`, { method: 'POST', body: JSON.stringify({ query: q, resultsCount: 10 }) }); }
        
        // Polling logic for long-running operations
        async pollOperation(opName) {
            const op = await this.request(opName, { method: 'GET' });
            if (op.done) {
                if (op.error) throw new Error(op.error.message);
                return op.response;
            }
            return new Promise(resolve => setTimeout(() => resolve(this.pollOperation(opName)), 2000));
        }

        async uploadFile(s, f) {
             const url = `https://generativelanguage.googleapis.com/upload/v1beta/${s}:uploadToFileSearchStore?displayName=${encodeURIComponent(f.name)}`;
             const fd = new FormData(); fd.append('file', f);
             
             // Simple fetch without retry for file upload due to complexity of re-uploading
             const res = await fetch(url, { method: 'POST', headers: { 'x-goog-api-key': this.apiKey }, body: fd });
             
             if(!res.ok) { const text = await res.text(); throw new Error(`Upload Failed: ${text}`); }
             return res.json();
        }
    }

    class StorageService {
        constructor(dbName='GeminiKN_DB') { this.dbName = dbName; this.db = null; }
        async init() {
            return new Promise((res, rej) => {
                const req = indexedDB.open(this.dbName, 1);
                req.onupgradeneeded = e => { e.target.result.createObjectStore('chats', { keyPath: 'id' }); };
                req.onsuccess = e => { this.db = e.target.result; res(this.db); };
                req.onerror = rej;
            });
        }
        async getChats() {
            if (!this.db) await this.init();
            return new Promise(res => { 
                const tx = this.db.transaction('chats', 'readonly'); 
                const req = tx.objectStore('chats').getAll(); 
                req.onsuccess = () => res(req.result.sort((a,b) => (b.updated||0) - (a.updated||0))); 
            });
        }
        async saveChat(c) { 
            if (!this.db) await this.init(); 
            return new Promise(res => { 
                const tx = this.db.transaction('chats', 'readwrite'); 
                tx.objectStore('chats').put({ ...c, updated: Date.now() }); 
                tx.oncomplete = res; 
            }); 
        }
        async deleteChat(id) { 
            if (!this.db) await this.init(); 
            return new Promise(res => { 
                const tx = this.db.transaction('chats', 'readwrite'); 
                tx.objectStore('chats').delete(id); 
                tx.oncomplete = res; 
            }); 
        }
        async getChatsByStore(storeName) {
            const allChats = await this.getChats();
            return allChats.filter(c => c.storeName === storeName);
        }
    }

    /* --- CONSTANTS --- */
    const BASE_XML_START = `<?xml version="1.0" encoding="UTF-8"?>\n<AIFramework_V3>\n<Cognitive_Core>\n`;
    const BASE_XML_END = `\n</AIFramework_V3>`;
    const LEGAL_RESEARCHER_PROMPT = `${BASE_XML_START}<Persona>ë‹¹ì‹ ì€ 'ìˆ˜ì„ ì¬íŒì—°êµ¬ì›'ì…ë‹ˆë‹¤. ë²•ì› ì‹¤ë¬´ì œìš”, ë²•ë ¹, íŒë¡€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ì¶œì²˜ì™€ í•¨ê»˜ ë‹µë³€í•˜ì„¸ìš”.</Persona>${BASE_XML_END}`;
    const DATA_ANALYST_PROMPT = `${BASE_XML_START}<Persona>ë‹¹ì‹ ì€ 'ìˆ˜ì„ ë°ì´í„° ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸'ì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•˜ì„¸ìš”.</Persona>${BASE_XML_END}`;
    const BIZ_CONSULTANT_PROMPT = `${BASE_XML_START}<Persona>ë‹¹ì‹ ì€ 'ì „ëµ ì»¨ì„¤í„´íŠ¸'ì…ë‹ˆë‹¤. MECEí•˜ê²Œ ë¶„ì„í•˜ê³  ì†”ë£¨ì…˜ì„ ì œì•ˆí•˜ì„¸ìš”.</Persona>${BASE_XML_END}`;
    const LEGAL_WRITER_PROMPT = `${BASE_XML_START}<Persona>ë‹¹ì‹ ì€ 'ì „ë¬¸ ë²•ë¥  ì„œë©´ ì‘ì„±ê°€'ì…ë‹ˆë‹¤. ë…¼ë¦¬ì ì´ê³  ê°„ê²°í•œ ì„œë©´ì„ ì‘ì„±í•˜ì„¸ìš”.</Persona>${BASE_XML_END}`;
    const LEGAL_ADVISOR_PROMPT = `${BASE_XML_START}<Persona>ë‹¹ì‹ ì€ 'ë²•ë¥  ìë¬¸ì—­'ì…ë‹ˆë‹¤. ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì„í•˜ê³  í˜„ì‹¤ì ì¸ ì¡°ì–¸ì„ ì œê³µí•˜ì„¸ìš”.</Persona>${BASE_XML_END}`;

    const DEFAULT_PERSONAS = [
        { id: 'legal_researcher', name: 'ë²•ë¥  ì—°êµ¬ì›', icon: 'âš–ï¸', instr: LEGAL_RESEARCHER_PROMPT },
        { id: 'data_analyst', name: 'ë°ì´í„° ë¶„ì„ê°€', icon: 'ğŸ“Š', instr: DATA_ANALYST_PROMPT },
        { id: 'biz_consultant', name: 'ë¹„ì¦ˆë‹ˆìŠ¤ ì»¨ì„¤í„´íŠ¸', icon: 'ğŸ’¼', instr: BIZ_CONSULTANT_PROMPT },
        { id: 'legal_writer', name: 'ì„œë©´ ì‘ì„±ê°€', icon: 'âœï¸', instr: LEGAL_WRITER_PROMPT },
        { id: 'legal_advisor', name: 'ë²•ë¥  ìë¬¸ì—­', icon: 'ğŸ¤', instr: LEGAL_ADVISOR_PROMPT }
    ];

    /* --- COMPONENTS --- */
    const Icon = ({ name, size=20, className="" }) => <i className={`bi bi-${name} ${className}`} style={{fontSize: size}}></i>;
    const Avatar = ({ isModel, icon }) => (
        <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 border border-gray-200 overflow-hidden ${isModel ? 'bg-gradient-to-tr from-indigo-500 to-purple-500 text-white' : 'bg-gray-200 text-gray-600'}`}>
            {isModel ? (icon ? <span className="text-sm">{icon}</span> : <Icon name="stars" size={14}/>) : <Icon name="person-fill" size={16}/>}
        </div>
    );
    const NavBar = ({ currentPath, onStatusClick, operationCount }) => {
        const nav = (path) => window.location.hash = path;
        const items = [
            { id: '/', icon: 'house-door', activeIcon: 'house-door-fill', label: 'í™ˆ' },
            { id: '/settings', icon: 'gear', activeIcon: 'gear-fill', label: 'ì„¤ì •' },
        ];
        return (
            <>
                <div className="hidden md:flex flex-col w-[244px] border-r border-[#dbdbdb] h-full px-3 py-8 bg-white z-20 flex-shrink-0">
                    <div className="px-4 mb-8 flex items-center justify-between">
                         <h1 className="text-xl font-bold italic tracking-tight" style={{fontFamily:'cursive'}}>KNBASE 1.1.5</h1>
                         <button onClick={onStatusClick} className="relative p-2 rounded-full hover:bg-gray-100 text-gray-500">
                            <Icon name="cloud-arrow-up-fill" size={20}/>
                            {operationCount > 0 && <span className="absolute top-0 right-0 flex h-3 w-3 items-center justify-center rounded-full bg-red-500 text-[8px] text-white font-bold">!</span>}
                         </button>
                    </div>
                    <div className="space-y-2">
                        {items.map(item => (
                            <button key={item.id} onClick={()=>nav(item.id)} className={`flex items-center gap-4 p-3 rounded-lg transition-all hover:bg-gray-50 ${currentPath===item.id ? 'font-bold bg-gray-50' : ''} w-full`}>
                                <Icon name={currentPath===item.id ? item.activeIcon : item.icon} size={24} className="transition-transform group-hover:scale-110"/>
                                <span className="text-md">{item.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
                <div className="md:hidden fixed bottom-0 left-0 right-0 h-[60px] border-t border-[#dbdbdb] bg-white flex items-center justify-around z-50 pb-safe">
                    {items.map(item => (
                        <button key={item.id} onClick={()=>nav(item.id)} className="p-3">
                            <Icon name={currentPath===item.id ? item.activeIcon : item.icon} size={24} />
                        </button>
                    ))}
                    <button onClick={onStatusClick} className="relative p-3">
                         <Icon name="cloud-arrow-up-fill" size={24}/>
                         {operationCount > 0 && <span className="absolute top-1 right-1 flex h-3 w-3 items-center justify-center rounded-full bg-red-500 text-[8px] text-white font-bold">!</span>}
                    </button>
                </div>
            </>
        );
    };

    const ProjectMenu = ({ isOpen, onClose, onOpen, onDelete }) => {
        if (!isOpen) return null;
        return (
            <div className="absolute top-8 right-2 bg-white border border-[#dbdbdb] rounded-lg shadow-lg z-20 w-32 overflow-hidden fade-in">
                <button onClick={(e)=>{e.stopPropagation(); onOpen(); onClose();}} className="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 text-gray-700">ì—´ê¸°</button>
                <button onClick={(e)=>{e.stopPropagation(); onDelete(); onClose();}} className="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 text-red-500 border-t border-gray-100">ì‚­ì œ</button>
            </div>
        );
    };
    
    // [NEW] Project Modal Component
    const ProjectModal = ({ isOpen, onClose, onCreate }) => {
        const [name, setName] = React.useState('');
        const [desc, setDesc] = React.useState('');
        if (!isOpen) return null;

        const handleSubmit = () => {
            if (!name.trim()) return;
            onCreate(name.trim(), desc.trim());
            setName(''); setDesc(''); onClose();
        };

        return (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in">
                <div className="bg-white rounded-xl p-6 w-11/12 max-w-sm shadow-2xl slide-up">
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="folder-plus" size={20}/> ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</h3>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">í”„ë¡œì íŠ¸ ì´ë¦„*</label>
                            <input type="text" className="w-full border rounded p-2 text-sm focus:ring-1 focus:ring-blue-400" placeholder="ì˜ˆ: 2024ë…„ ë²•ë¥  ìë¬¸" value={name} onChange={e=>setName(e.target.value)} />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">ì„¤ëª… (ì„ íƒ)</label>
                            <textarea className="w-full border rounded p-2 text-sm h-16 resize-none focus:ring-1 focus:ring-blue-400" placeholder="í”„ë¡œì íŠ¸ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…" value={desc} onChange={e=>setDesc(e.target.value)} />
                        </div>
                    </div>
                    <div className="flex justify-end gap-3 mt-6">
                        <button onClick={onClose} className="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">ì·¨ì†Œ</button>
                        <button onClick={handleSubmit} disabled={!name.trim()} className="px-4 py-2 bg-black text-white rounded-lg text-sm font-semibold hover:bg-gray-800 disabled:opacity-50">ìƒì„±</button>
                    </div>
                </div>
            </div>
        );
    };


    // New Component: Operation Status Drawer
    const OperationStatus = ({ isOpen, onClose, operations, removeOperation }) => {
        if (!isOpen) return null;
        const opArray = Object.values(operations).sort((a,b) => b.timestamp - a.timestamp);

        return (
            <div className="fixed inset-0 md:left-[280px] bg-black/30 backdrop-blur-sm z-40 flex justify-end">
                <div className="bg-white w-full max-w-xs h-full border-l border-[#dbdbdb] shadow-xl slide-right flex flex-col">
                    <div className="p-4 border-b border-[#efefef] flex justify-between items-center flex-shrink-0">
                        <h3 className="font-bold text-lg">ì‘ì—… ìƒíƒœ ({opArray.length})</h3>
                        <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 text-gray-600"><Icon name="x-lg" size={16}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {opArray.length === 0 && <div className="text-center text-gray-400 py-10 text-sm">ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                        {opArray.map(op => (
                            <div key={op.id} className={`p-3 rounded-lg border shadow-sm ${op.status==='failed'?'border-red-400 bg-red-50':op.status==='succeeded'?'border-green-400 bg-green-50':(op.status==='indexing' || op.status==='processing')?'border-blue-400 bg-blue-50':'border-gray-300 bg-gray-50'}`}>
                                <div className="flex items-start justify-between">
                                    <div className="font-medium text-sm text-[#262626] truncate pr-2">{op.description}</div>
                                    {op.status === 'processing' && <div className="spinner w-4 h-4 text-blue-500 border-blue-200 border-t-blue-500 flex-shrink-0"></div>}
                                    {op.status === 'indexing' && <div className="spinner w-4 h-4 text-amber-500 border-amber-200 border-t-amber-500 flex-shrink-0"></div>}
                                    {op.status === 'succeeded' && <Icon name="check-circle-fill" className="text-green-500 flex-shrink-0"/>}
                                    {op.status === 'failed' && <Icon name="x-circle-fill" className="text-red-500 flex-shrink-0"/>}
                                </div>
                                <div className="text-xs mt-1 text-gray-600">
                                    {op.status === 'processing' && 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...'}
                                    {op.status === 'indexing' && 'ë¬¸ì„œ ìƒ‰ì¸ ìƒì„± ì¤‘...'}
                                    {op.status === 'succeeded' && 'ì‘ì—… ì„±ê³µ'}
                                    {op.status === 'failed' && `ì˜¤ë¥˜: ${op.error || 'ì•Œ ìˆ˜ ì—†ìŒ'}`}
                                </div>
                                {(op.status === 'succeeded' || op.status === 'failed') && (
                                     <button onClick={()=>removeOperation(op.id)} className="text-xs text-gray-500 hover:underline mt-1">ë‹«ê¸°</button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    };

    // Renamed ChatList to ProjectSidebar
    const ProjectSidebar = ({ store, chats, activeChat, onSelectChat, onNewChat, onDeleteChat, onRenameChat, onBackToHome, isOpen, onClose }) => {
        const [editId, setEditId] = React.useState(null);
        const [editTitle, setEditTitle] = React.useState('');

        const handleRename = (chat) => {
            if (editTitle.trim() && editTitle !== chat.title) {
                onRenameChat(chat.id, editTitle.trim());
            }
            setEditId(null);
            setEditTitle('');
        };
        
        // Use `isOpen` only for the mobile overlay logic
        const isDesktop = window.matchMedia('(min-width: 768px)').matches;
        if (!isDesktop && !isOpen) return null;

        const listContent = (
            // w-64 is for mobile overlay width, md:w-full makes it fill the flex container on desktop
            <div className={`w-64 md:w-full bg-white h-full flex flex-col flex-shrink-0 shadow-lg md:shadow-none ${!isDesktop && isOpen ? 'slide-right' : 'slide-left'} transition-transform duration-300`}>
                
                {/* DESKTOP/MOBILE HEADER FOR SIDEBAR: Back to Home + Project Name */}
                <div className="p-4 border-b border-[#efefef] flex items-center flex-shrink-0">
                    <button onClick={onBackToHome} className="text-gray-500 hover:text-black p-1 mr-2 rounded-full hover:bg-gray-100"><Icon name="arrow-left" size={20}/></button>
                    <h3 className="font-bold text-lg truncate min-w-0 flex-1" title={store.displayName}>{store.displayName}</h3>
                    {/* Mobile close button for overlay */}
                    <button onClick={onClose} className="md:hidden p-2 rounded-full hover:bg-gray-100 text-gray-600"><Icon name="x-lg" size={16}/></button>
                </div>
                
                <div className="p-3 flex-shrink-0">
                    {/* NOTE: onNewChat does not call onClose() so the sidebar stays open on desktop */}
                    <button onClick={() => { onNewChat(); if(!isDesktop) onClose(); }} className="w-full flex items-center justify-center gap-2 py-2 bg-[#0095f6] text-white rounded-lg font-semibold text-sm hover:opacity-90">
                        <Icon name="chat-left-text" size={16}/> ìƒˆ ëŒ€í™” ì‹œì‘
                    </button>
                </div>

                <div className="flex-1 overflow-y-auto px-2 space-y-1 no-scrollbar">
                    {chats.map(c => (
                        <div key={c.id} className={`flex items-center justify-between p-3 rounded-lg cursor-pointer transition hover:bg-gray-50 group ${activeChat?.id === c.id ? 'bg-blue-50 font-semibold' : ''}`}
                             onClick={() => { onSelectChat(c); if(!isDesktop) onClose(); }}>
                            
                            {editId === c.id ? (
                                <input 
                                    autoFocus 
                                    className="border rounded px-2 py-1 text-sm w-3/4"
                                    value={editTitle} 
                                    onChange={e => setEditTitle(e.target.value)} 
                                    onBlur={() => handleRename(c)}
                                    onKeyDown={e => { if (e.key === 'Enter') e.target.blur(); }}
                                    onClick={e => e.stopPropagation()} 
                                />
                            ) : (
                                <>
                                    <span className="text-sm truncate pr-2">{c.title || 'ì œëª© ì—†ìŒ'}</span>
                                    <div className={`flex gap-1 opacity-0 group-hover:opacity-100 transition flex-shrink-0 ${activeChat?.id === c.id ? 'opacity-100' : ''}`}>
                                        <button onClick={e=>{e.stopPropagation(); setEditId(c.id); setEditTitle(c.title || 'ìƒˆ ëŒ€í™”');}} className="p-1 rounded hover:bg-gray-200 text-gray-500"><Icon name="pencil" size={14}/></button>
                                        <button onClick={e=>{e.stopPropagation(); if(confirm('ì´ ëŒ€í™” ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) onDeleteChat(c.id);}} className="p-1 rounded hover:bg-red-200 text-red-500"><Icon name="trash" size={14}/></button>
                                    </div>
                                </>
                            )}
                        </div>
                    ))}
                    {!chats.length && <div className="text-center text-gray-400 py-10 text-sm">ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                </div>
            </div>
        );

        return (
            // This div is fixed/full screen on mobile, and static/flex item on desktop (due to CSS).
            <div className="project-sidebar-overlay"> 
                {listContent}
            </div>
        );
    };


    // New Component: ContextCard for Better Search Results
    const ContextCard = ({ result }) => {
        const [expanded, setExpanded] = React.useState(false);
        
        // Safely extract content
        const rawText = result.chunk?.data?.stringValue || result.chunk?.text || '';
        const cleanText = rawText.replace(/<[^>]*>/g, ''); // Simple strip tags for preview
        const score = result.chunkRelevanceScore || result.score || 0;
        const scorePercent = (score * 100).toFixed(0);
        
        let scoreColor = 'bg-gray-100 text-gray-600';
        if(score > 0.7) scoreColor = 'bg-green-100 text-green-700';
        else if(score > 0.5) scoreColor = 'bg-yellow-100 text-yellow-700';

        const copyJson = () => {
            copyToClipboard(JSON.stringify(result, null, 2));
        };

        return (
            <div className="bg-white border border-[#dbdbdb] rounded-lg p-4 mb-4 shadow-sm hover:shadow-md transition slide-up">
                <div className="flex justify-between items-start mb-2">
                    <div className="flex items-center gap-2 min-w-0">
                        <div className="w-8 h-8 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center flex-shrink-0"><Icon name="file-earmark-text" size={14}/></div>
                        <div className="min-w-0 flex-1">
                             <div className="text-sm font-bold text-[#262626] truncate">{result.document?.displayName || 'Unknown Document'}</div>
                             <div className={`text-[10px] font-bold px-1.5 py-0.5 rounded w-fit ${scoreColor}`}>{scorePercent}% Match</div>
                        </div>
                    </div>
                    <button onClick={()=>setExpanded(!expanded)} className="text-gray-400 hover:text-black p-1"><Icon name={expanded ? "chevron-up" : "chevron-down"}/></button>
                </div>
                
                <div className={`text-sm text-[#262626] leading-relaxed ${expanded ? '' : 'line-clamp-3'} whitespace-pre-wrap break-words`}>
                    {expanded ? rawText : cleanText}
                </div>
                
                {expanded && (
                    <div className="mt-3 pt-3 border-t border-gray-100">
                        <div className="flex justify-between items-center mb-2">
                             <span className="text-xs font-mono text-gray-400">RAW JSON</span>
                             <button onClick={copyJson} className="text-xs text-[#0095f6] hover:underline flex items-center gap-1"><Icon name="clipboard"/> Copy JSON</button>
                        </div>
                        <div className="bg-[#1e1e1e] rounded p-3 overflow-x-auto text-xs font-mono text-green-400 max-h-60">
                            <pre>{JSON.stringify(result, null, 2)}</pre>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    /* --- VIEWS --- */
    const SettingsView = ({ config, setConfig }) => {
        const [tab, setTab] = React.useState('GENERAL');
        const [editId, setEditId] = React.useState(null);
        const [form, setForm] = React.useState({ name: '', icon: '', instr: '' });

        const handleSave = () => {
            if (!form.name || !form.instr) return console.error('ì´ë¦„ê³¼ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            let updated;
            if (editId) {
                updated = (config.personas || DEFAULT_PERSONAS).map(p => p.id === editId ? { ...form, id: editId } : p);
                setEditId(null);
            } else {
                const p = { ...form, id: crypto.randomUUID(), icon: form.icon || 'ğŸ¤–' };
                updated = [...(config.personas || DEFAULT_PERSONAS), p];
            }
            setConfig({ ...config, personas: updated });
            setForm({ name: '', icon: '', instr: '' });
        };

        const handleEdit = (p) => { setEditId(p.id); setForm({ name: p.name, icon: p.icon, instr: p.instr }); };
        const handleCancel = () => { setEditId(null); setForm({ name: '', icon: '', instr: '' }); };
        const handleDelete = (id) => { if(window.confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { setConfig({ ...config, personas: config.personas.filter(p => p.id !== id) }); if (editId === id) handleCancel(); } };

        return (
            <div className="flex flex-col h-full bg-white fade-in">
                <div className="h-[60px] border-b border-[#dbdbdb] flex items-center px-6 bg-white"><h2 className="font-bold text-lg">ì„¤ì •</h2></div>
                <div className="flex border-b border-[#dbdbdb]">
                    <button onClick={()=>setTab('GENERAL')} className={`flex-1 py-3 text-sm font-medium ${tab==='GENERAL'?'border-b-2 border-black text-black':'text-gray-500'}`}>ì¼ë°˜</button>
                    <button onClick={()=>setTab('PERSONA')} className={`flex-1 py-3 text-sm font-medium ${tab==='PERSONA'?'border-b-2 border-black text-black':'text-gray-500'}`}>í˜ë¥´ì†Œë‚˜ ê´€ë¦¬</button>
                </div>
                <div className="flex-1 overflow-y-auto p-6 bg-[#fafafa]">
                    {tab === 'GENERAL' && (
                        <div className="space-y-6 max-w-2xl mx-auto">
                            <div className="bg-white p-4 rounded-lg border border-[#dbdbdb] shadow-sm">
                                <label className="block text-xs font-bold text-gray-500 mb-2">API KEY</label>
                                <input type="password" className="w-full border rounded p-2 bg-gray-50 text-sm" value={config.key} onChange={e=>setConfig({...config, key:e.target.value})} />
                            </div>
                            <div className="bg-white p-4 rounded-lg border border-[#dbdbdb] shadow-sm">
                                <label className="block text-xs font-bold text-gray-500 mb-2">MODEL</label>
                                <select className="w-full border rounded p-2 bg-white text-sm" value={config.model} onChange={e=>setConfig({...config, model:e.target.value})}>
                                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                    <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash Preview</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                                </select>
                            </div>
                        </div>
                    )}
                    {tab === 'PERSONA' && (
                        <div className="space-y-6 max-w-2xl mx-auto">
                            <div className="bg-white p-4 rounded-lg border border-[#dbdbdb] shadow-sm">
                                <h3 className="font-bold mb-4 text-sm">{editId ? 'í˜ë¥´ì†Œë‚˜ ìˆ˜ì •' : 'ìƒˆ í˜ë¥´ì†Œë‚˜ ë“±ë¡'}</h3>
                                <div className="flex gap-2 mb-2">
                                    <input className="border rounded p-2 w-12 text-center" placeholder="icon" value={form.icon} onChange={e=>setForm({...form, icon:e.target.value})} />
                                    <input className="border rounded p-2 flex-1 text-sm" placeholder="ì´ë¦„ (ì˜ˆ: ë²•ë¥  ì „ë¬¸ê°€)" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                                </div>
                                <textarea className="w-full border rounded p-2 text-sm h-40 mb-2 resize-none" placeholder="ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì…ë ¥..." value={form.instr} onChange={e=>setForm({...form, instr:e.target.value})} />
                                <div className="flex gap-2">
                                    <button onClick={handleSave} className="flex-1 bg-black text-white py-2 rounded text-sm font-bold hover:opacity-80">{editId ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}</button>
                                    {editId && <button onClick={handleCancel} className="px-4 border border-gray-300 rounded text-sm hover:bg-gray-50">ì·¨ì†Œ</button>}
                                </div>
                            </div>
                            <div className="space-y-3">
                                <h3 className="font-bold text-sm text-gray-500">ë“±ë¡ëœ í˜ë¥´ì†Œë‚˜</h3>
                                {(config.personas || DEFAULT_PERSONAS).map(p => (
                                    <div key={p.id} className={`bg-white p-4 rounded-lg border flex items-start justify-between shadow-sm ${editId===p.id ? 'border-blue-500 ring-1 ring-blue-500' : 'border-[#dbdbdb]'}`}>
                                        <div className="flex gap-3 overflow-hidden">
                                            <div className="text-2xl bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">{p.icon}</div>
                                            <div className="min-w-0">
                                                <div className="font-bold text-sm truncate">{p.name}</div>
                                                <div className="text-xs text-gray-500 line-clamp-1">{p.instr.substring(0, 50)}...</div>
                                            </div>
                                        </div>
                                        <div className="flex gap-1 flex-shrink-0">
                                            <button onClick={()=>handleEdit(p)} className="text-gray-400 hover:text-blue-500 p-2 rounded"><Icon name="pencil"/></button>
                                            <button onClick={()=>handleDelete(p.id)} className="text-gray-400 hover:text-red-500 p-2 rounded"><Icon name="trash"/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const HomeView = ({ stores, onCreate, onSelect, onDelete, isLoading, error, navigate }) => {
        const [menuOpenId, setMenuOpenId] = React.useState(null);
        const [isModalOpen, setIsModalOpen] = React.useState(false);

        React.useEffect(() => {
            const closeMenu = () => setMenuOpenId(null);
            window.addEventListener('click', closeMenu);
            return () => window.removeEventListener('click', closeMenu);
        }, []);

        if (isLoading) {
            return (
                <div className="flex-1 overflow-y-auto pt-8 px-6 pb-24 no-scrollbar">
                    <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                        <div className="spinner w-12 h-12 mb-4 border-gray-400 border-t-gray-600"></div>
                        <p className="text-lg font-light">í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        <p className="text-sm text-gray-400 mt-2">API í‚¤ì™€ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            );
        }
        
        if (error && error !== "API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.") {
            return (
                <div className="flex-1 overflow-y-auto pt-8 px-6 pb-24 no-scrollbar">
                    <div className="flex flex-col items-center justify-center py-20 bg-red-50/50 border-2 border-dashed border-red-300 rounded-xl mx-auto max-w-lg">
                        <Icon name="exclamation-triangle-fill" size={40} className="text-red-500 mb-4"/>
                        <p className="text-lg font-bold text-red-700">API ì—°ê²° ì˜¤ë¥˜</p>
                        <p className="text-sm text-red-500 mt-2 text-center px-4">í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.</p>
                        <p className="text-xs text-red-400 mt-1 text-center px-4">ì˜¤ë¥˜ ìƒì„¸: {error}</p>
                        <button onClick={() => navigate('/settings')} className="mt-4 text-[#0095f6] font-semibold text-sm hover:underline">API í‚¤ ì„¤ì •ìœ¼ë¡œ ì´ë™</button>
                    </div>
                </div>
            );
        }

        return (
            <div className="w-full h-full flex flex-col overflow-hidden">
                <ProjectModal isOpen={isModalOpen} onClose={()=>setIsModalOpen(false)} onCreate={onCreate}/>
                <div className="flex-1 overflow-y-auto pt-8 px-6 pb-24 no-scrollbar">
                    {/* í”„ë¡œì íŠ¸ ìƒì„± ë²„íŠ¼ì„ ê°€ì¥ ì•ì— ë°°ì¹˜ */}
                    <div className="flex gap-4 mb-8 overflow-x-auto pb-2 no-scrollbar">
                        <div onClick={()=>setIsModalOpen(true)} className="flex flex-col items-center gap-2 cursor-pointer min-w-[72px]">
                            <div className="w-16 h-16 rounded-full border-[1px] border-gray-300 flex items-center justify-center bg-white hover:bg-gray-50 shadow-sm transition">
                                <Icon name="plus-lg" size={24} className="text-gray-400"/>
                            </div>
                            <span className="text-xs font-medium text-[#262626] truncate w-20 text-center">ìƒˆ í”„ë¡œì íŠ¸</span>
                        </div>
                        {stores.map(s => (
                            <div key={s.name} onClick={() => onSelect(s)} className="flex flex-col items-center gap-2 cursor-pointer min-w-[72px]">
                                <div className="w-16 h-16 rounded-full border-[2px] border-[#0095f6] p-[2px] shadow-sm transition hover:scale-105">
                                    <div className="w-full h-full rounded-full bg-gray-100 flex items-center justify-center overflow-hidden bg-white">
                                        <Icon name="folder-fill" className="text-gray-400"/>
                                    </div>
                                </div>
                                <span className="text-xs font-medium text-[#262626] truncate w-20 text-center">{s.displayName}</span>
                            </div>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
                        {stores.map(s => (
                            <div key={s.name} className="bg-white border border-[#dbdbdb] rounded-xl overflow-hidden shadow-sm hover:shadow-md transition slide-up group flex flex-col min-w-0 relative">
                                <div className="p-4 flex items-center justify-between border-b border-[#efefef]">
                                    <div className="flex items-center gap-3 min-w-0">
                                        <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-yellow-400 to-red-500 p-[2px] flex-shrink-0">
                                            <div className="w-full h-full rounded-full bg-white flex items-center justify-center"><Icon name="folder-fill" className="text-gray-700" size={14}/></div>
                                        </div>
                                        <div className="flex flex-col min-w-0">
                                            <span className="font-semibold text-sm text-[#262626] truncate">{s.displayName}</span>
                                            <span className="text-[10px] text-[#737373]">Gemini Store</span>
                                        </div>
                                    </div>
                                    <div className="relative">
                                        <button onClick={(e)=>{e.stopPropagation(); setMenuOpenId(menuOpenId === s.name ? null : s.name);}} className="text-gray-400 hover:text-black p-2 rounded-full hover:bg-gray-100 flex-shrink-0 transition"><Icon name="three-dots"/></button>
                                        <ProjectMenu isOpen={menuOpenId === s.name} onClose={()=>setMenuOpenId(null)} onOpen={()=>onSelect(s)} onDelete={()=>onDelete(s.name)} />
                                    </div>
                                </div>
                                <div onClick={()=>onSelect(s)} className="bg-gray-50 h-40 flex flex-col items-center justify-center cursor-pointer relative">
                                    <Icon name="files" size={48} className="text-gray-300 group-hover:scale-110 transition-transform duration-300"/>
                                    <span className="text-xs text-gray-400 mt-2 font-medium">{s.description || 'ë¬¸ì„œ ë¶„ì„ í”„ë¡œì íŠ¸'}</span>
                                </div>
                                <div className="p-4 bg-[#fafafa] border-t border-[#efefef]">
                                     <div className="flex justify-between items-center text-xs text-gray-500 mb-2">
                                        <span>{new Date(s.createTime).toLocaleDateString()}</span>
                                     </div>
                                     <div className="flex gap-4 text-xs font-medium text-gray-500 items-center">
                                        <div className="flex items-center gap-1"><Icon name="file-text" size={14}/> <span className="mt-0.5">{fmtCount(s.activeDocumentsCount || 0)}</span></div>
                                        <div className="flex items-center gap-1"><Icon name="hdd" size={14}/> <span className="mt-0.5">{fmtSize(s.sizeBytes || 0)}</span></div>
                                     </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    {!stores.length && (
                        <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                            <div className="w-24 h-24 rounded-full border-2 border-gray-200 flex items-center justify-center mb-4"><Icon name="camera" size={40}/></div>
                            <p className="text-lg font-light">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <button onClick={()=>setIsModalOpen(true)} className="mt-4 text-[#0095f6] font-semibold text-sm hover:underline">ì²« í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</button>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const ChatView = ({ activeStore, messages, isLoading, onSend, onDocs, 
                        personas, activePersonaId, onPersonaChange, 
                        chats, activeChat, onSelectChat, onNewChat, onDeleteChat, onRenameChat, onShowSidebar }) => {
        
        const [input, setInput] = React.useState('');
        const [showPersonas, setShowPersonas] = React.useState(false);
        const bottomRef = React.useRef(null);
        
        React.useEffect(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages, isLoading]);
        
        const activePersona = personas.find(p => p.id === activePersonaId) || personas[0];
        const handleSend = () => { if(!input.trim()) return; onSend(input); setInput(''); };

        return (
            <div className="flex-1 flex flex-col h-full min-w-0">
                <div className="h-[60px] border-b border-[#dbdbdb] flex items-center justify-between px-4 bg-white/90 backdrop-blur z-10 flex-shrink-0">
                    <div className="flex items-center gap-3">
                        {/* Mobile: Toggle Sidebar */}
                        <button onClick={onShowSidebar} className="md:hidden"><Icon name="list" size={24}/></button> 
                        <div className="flex items-center gap-2">
                            <Avatar isModel={true} icon={activePersona.icon} />
                            <div>
                                <div className="font-bold text-sm truncate max-w-[150px]">{activeChat?.title || 'ìƒˆ ëŒ€í™”'}</div>
                                <div className="text-xs text-gray-500">{activePersona.name}</div>
                            </div>
                        </div>
                    </div>
                    <button onClick={onDocs}><Icon name="info-circle" size={24}/></button>
                </div>

                <div className="flex-1 overflow-y-auto p-4 bg-white no-scrollbar">
                    {!messages.length && (
                        <div className="h-full flex flex-col items-center justify-center text-gray-300 gap-2">
                            <div className="text-4xl">{activePersona.icon}</div>
                            <p className="text-sm font-medium text-gray-400">{activePersona.name}ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                        </div>
                    )}
                    {messages.map((m, i) => {
                        const isMe = m.role === 'user';
                        return (
                            <div key={i} className={`flex w-full mb-3 ${isMe ? 'justify-end' : 'justify-start'} slide-up`}>
                                <div className={`flex max-w-[85%] gap-2 ${isMe ? 'flex-row-reverse' : 'flex-row'}`}>
                                    {!isMe && <Avatar isModel={true} icon={activePersona.icon}/>}
                                    <div className="flex flex-col">
                                        <div className={`px-4 py-2.5 text-[15px] rounded-[20px] leading-relaxed shadow-sm ${isMe ? 'bg-[#3797f0] text-white rounded-tr-none' : 'bg-[#efefef] text-black rounded-tl-none'}`}>
                                            <div className="prose" dangerouslySetInnerHTML={{__html: marked.parse(m.text)}} />
                                        </div>
                                        {m.grounding?.groundingAttributions?.length > 0 && (
                                            <div className="mt-1 ml-1 text-[10px] text-gray-400 flex flex-wrap gap-1">
                                                {m.grounding.groundingAttributions.map((a,idx) => (
                                                    <span key={idx} className="bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200 truncate max-w-[150px]">Source: {a.file?.displayName || a.web?.title || 'Web'}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                    {isLoading && <div className="flex justify-start mb-3 pl-10"><div className="bg-[#efefef] px-4 py-3 rounded-[20px] rounded-tl-none"><div className="spinner w-4 h-4 border-gray-400 border-t-gray-600"/></div></div>}
                    <div ref={bottomRef} />
                </div>
                
                <div className="p-3 bg-white border-t border-[#dbdbdb] pb-safe relative flex-shrink-0">
                    {showPersonas && (
                        <div className="absolute bottom-full left-4 mb-2 bg-white border border-[#dbdbdb] rounded-xl shadow-xl p-2 w-64 slide-up z-20 max-h-64 overflow-y-auto">
                            <div className="text-xs font-bold text-gray-400 px-2 py-1 mb-1">í˜ë¥´ì†Œë‚˜ ë³€ê²½</div>
                            {personas.map(p => (
                                <button key={p.id} onClick={()=>{onPersonaChange(p.id); setShowPersonas(false);}} 
                                    className={`flex items-center gap-3 w-full p-2 rounded-lg hover:bg-gray-50 ${p.id===activePersonaId?'bg-blue-50 text-blue-600':''}`}>
                                    <div className="text-xl">{p.icon}</div>
                                    <div className="text-sm font-medium">{p.name}</div>
                                    {p.id===activePersonaId && <Icon name="check" size={16} className="ml-auto"/>}
                                </button>
                            ))}
                        </div>
                    )}
                    <div className="relative flex items-center gap-2">
                        <button onClick={()=>setShowPersonas(!showPersonas)} className="flex items-center gap-1 pl-2 pr-1 py-1.5 rounded-full bg-gray-100 text-xs font-bold text-gray-600 hover:bg-gray-200 transition flex-shrink-0">
                            <span>{activePersona.icon} {activePersona.name}</span>
                            <Icon name="chevron-up" size={10}/>
                        </button>
                        <input className="flex-1 bg-[#efefef] rounded-[22px] px-4 py-3 text-sm outline-none focus:ring-1 focus:ring-gray-300 transition-all" placeholder="ë©”ì‹œì§€ ë³´ë‚´ê¸°..." value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey && !e.nativeEvent.isComposing) handleSend(); }} />
                        <button onClick={handleSend} className="absolute right-3 text-[#0095f6] font-semibold text-sm hover:opacity-70">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        );
    };

    const DocsView = ({ api, activeStore, onBack, onChat, onSearchDoc, onUploadFiles, operations, onShowSidebar }) => {
        const [docs, setDocs] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        
        const loadDocs = React.useCallback(async () => { if(api) { setLoading(true); api.listDocuments(activeStore.name).then(setDocs).finally(()=>setLoading(false)); } }, [api, activeStore]);
        React.useEffect(() => { loadDocs(); }, [loadDocs]);
        
        // Reload when an operation related to this store finishes
        React.useEffect(() => {
            const completedOps = Object.values(operations).filter(op => op.status !== 'processing' && op.status !== 'indexing' && op.storeName === activeStore.name);
            if (completedOps.length > 0) {
                 loadDocs();
            }
        }, [operations, activeStore.name, loadDocs]);

        const upload = async (e) => { 
            if (e.target.files) onUploadFiles(activeStore.name, Array.from(e.target.files));
        };
        
        // Filter out documents that are currently being processed (optimistic UI)
        const activeOpNames = Object.values(operations).filter(op => op.storeName === activeStore.name && (op.status === 'processing' || op.status === 'indexing')).map(op => op.fileResourceName);
        const filteredDocs = docs.filter(d => !activeOpNames.includes(d.name));

        return (
            <div className="flex flex-col h-full bg-white">
                <div className="h-[60px] border-b border-[#dbdbdb] flex items-center justify-between px-4 bg-white flex-shrink-0">
                    <div className="flex items-center gap-3">
                         {/* Mobile: Toggle Sidebar */}
                        <button onClick={onShowSidebar} className="md:hidden"><Icon name="list" size={24}/></button> 
                        <div className="font-bold text-md truncate max-w-[200px]">{activeStore?.displayName} ë¬¸ì„œ</div>
                    </div>
                    
                    <label className="cursor-pointer text-[#0095f6] hover:text-[#00376b]"><Icon name="plus-lg" size={24}/><input type="file" multiple className="hidden" onChange={upload}/></label>
                </div>
                <div className="flex-1 overflow-y-auto p-4 no-scrollbar w-full">
                    {Object.values(operations).filter(op => op.storeName === activeStore.name && (op.status === 'processing' || op.status === 'indexing')).map(op => (
                        <div key={op.id} className="flex items-center justify-between p-4 border-b border-[#efefef] bg-blue-50/50">
                             <div className="flex items-center gap-3 overflow-hidden">
                                <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0 text-blue-500"><div className="spinner w-5 h-5 border-blue-300 border-t-blue-500"></div></div>
                                <div className="flex flex-col min-w-0"><span className="text-sm font-medium truncate text-[#262626]">{op.displayName || 'ì—…ë¡œë“œ íŒŒì¼'}</span><span className={`text-[10px] px-1.5 py-0.5 rounded w-fit bg-blue-100 text-blue-600`}>{op.status === 'processing' ? 'ì—…ë¡œë“œ ì¤‘...' : 'ìƒ‰ì¸ ì¤‘...'}</span></div>
                            </div>
                        </div>
                    ))}
                    
                    {filteredDocs.map(d => (
                        <div key={d.name} className="flex items-center justify-between p-4 border-b border-[#efefef] hover:bg-gray-50">
                            <div className="flex items-center gap-3 overflow-hidden">
                                <div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 text-gray-500"><Icon name="file-text" size={20}/></div>
                                <div className="flex flex-col min-w-0"><span className="text-sm font-medium truncate text-[#262626]">{d.displayName}</span><span className={`text-[10px] px-1.5 py-0.5 rounded w-fit ${d.state==='ACTIVE'?'bg-green-100 text-green-600':'bg-yellow-100 text-yellow-600'}`}>{d.state}</span></div>
                            </div>
                            <button onClick={() => onSearchDoc(d)} className="p-2 text-[#0095f6] bg-blue-50 rounded-full hover:bg-blue-100"><Icon name="search"/></button>
                        </div>
                    ))}
                    {loading && filteredDocs.length === 0 && <div className="p-6 text-center"><div className="spinner mx-auto"></div></div>}
                    {!loading && filteredDocs.length === 0 && Object.values(operations).filter(op => op.storeName === activeStore.name).length === 0 && (
                        <div className="p-10 text-center text-gray-400 text-sm">ë“±ë¡ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    )}
                </div>
                <div className="p-4 border-t border-[#dbdbdb] flex-shrink-0"><button onClick={onChat} className="w-full bg-[#0095f6] text-white py-3 rounded-lg font-semibold text-sm shadow">ì±„íŒ…ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button></div>
            </div>
        );
    };

    const DocSearchView = ({ api, activeDoc, onBack, onShowSidebar }) => {
        const [q, setQ] = React.useState(''); const [res, setRes] = React.useState([]); const [loading, setLoading] = React.useState(false);
        const search = async () => { if(!q.trim()) return; setLoading(true); try { const r = await api.queryDocument(activeDoc.name, q); setRes(r.relevantChunks||[]); } catch(e) { console.error(e.message); } finally { setLoading(false); } };
        return (
            <div className="flex flex-col h-full bg-white">
                <div className="h-[60px] border-b border-[#dbdbdb] flex items-center px-4 gap-3 bg-white flex-shrink-0">
                    {/* Mobile: Toggle Sidebar */}
                    <button onClick={onShowSidebar} className="md:hidden"><Icon name="list" size={24}/></button>
                    <div className="flex-1 bg-[#efefef] rounded-lg px-4 py-2 flex items-center gap-2"><Icon name="search" className="text-gray-500" size={16}/><input className="bg-transparent outline-none text-sm w-full" value={q} onChange={e=>setQ(e.target.value)} onKeyDown={e=>{if(e.key==='Enter') search()}} autoFocus placeholder="ë¬¸ì„œ ê²€ìƒ‰..."/></div>
                </div>
                <div className="flex-1 overflow-y-auto p-4 bg-[#fafafa] no-scrollbar">
                    <div className="max-w-6xl mx-auto w-full">
                        {res.map((r, i) => <ContextCard key={i} result={r}/>)}
                        {loading && <div className="p-10 text-center"><div className="spinner mx-auto"></div></div>}
                        {!loading && res.length === 0 && q.trim() && <div className="p-10 text-center text-gray-400 text-sm">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                    </div>
                </div>
            </div>
        );
    };

    /* --- APP --- */
    const App = () => {
        const [api, setApi] = React.useState(null);
        const [db] = React.useState(new StorageService());
        const [config, setConfig] = React.useState(JSON.parse(localStorage.getItem('gemini_kn_config')) || { key: '', model: 'gemini-2.5-flash', personas: DEFAULT_PERSONAS, activePersonaId: 'default' });
        
        const [view, setView] = React.useState('HOME');
        const [stores, setStores] = React.useState([]);
        const [allChats, setAllChats] = React.useState([]); // All chats for all stores
        const [activeStore, setActiveStore] = React.useState(null);
        const [activeChat, setActiveChat] = React.useState(null);
        const [activeDoc, setActiveDoc] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [hash, setHash] = React.useState(window.location.hash);
        
        // HomeView Loading and Error States
        const [isHomeLoading, setIsHomeLoading] = React.useState(false); 
        const [initError, setInitError] = React.useState(null); 
        
        // Project Sidebar State (Mobile Only)
        const [isSidebarOpen, setIsSidebarOpen] = React.useState(false); 

        const [pendingOperations, setPendingOperations] = React.useState({});
        const [isStatusOpen, setIsStatusOpen] = React.useState(false);
        const addOperation = (id, desc, storeName, fileResourceName) => setPendingOperations(p => ({...p, [id]: {id, description: desc, status: 'processing', storeName, fileResourceName, timestamp: Date.now()}}));
        const updateOperation = (id, status, error) => setPendingOperations(p => { if(!p[id]) return p; return {...p, [id]: {...p[id], status, error}}; });
        const removeOperation = (id) => setPendingOperations(p => { const n={...p}; delete n[id]; return n; });

        // --- Core Services and Data Fetching ---
        const loadStores = React.useCallback(async (service) => { 
            if (!service) return [];
            try { 
                const s = await service.listStores(); 
                setStores(s); 
                setInitError(null);
                return s; 
            } catch(e) { 
                console.error("Failed to load stores:", e); 
                setInitError(e.message); 
                return []; 
            } 
        }, []); 
        
        const loadAllChats = React.useCallback(async () => { 
            try { const c = await db.getChats(); setAllChats(c); return c; } catch(e) { console.error("Failed to load chats:", e); return []; } 
        }, [db]);
        
        React.useEffect(() => {
            const onHashChange = () => setHash(window.location.hash);
            window.addEventListener('hashchange', onHashChange);
            return () => window.removeEventListener('hashchange', onHashChange);
        }, []);

        React.useEffect(() => { 
            if (config.key) { 
                setIsHomeLoading(true); 
                setInitError(null); 
                
                const s = new GeminiService(config.key); 
                setApi(s); 
                
                loadStores(s).finally(() => setIsHomeLoading(false));
                loadAllChats();
            } else {
                 setInitError("API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                 setIsHomeLoading(false); 
            }
        }, [config.key, loadStores, loadAllChats]); 
        
        React.useEffect(() => { localStorage.setItem('gemini_kn_config', JSON.stringify(config)); }, [config]);

        // --- Polling Logic ---
        const pollOperation = React.useCallback(async (opName, uiOpId) => {
            try {
                const op = await api.request(opName, { method: 'GET' });
                if(op.done) {
                    if(op.error) throw new Error(op.error.message);
                    updateOperation(uiOpId, 'succeeded');
                    if (activeStore) loadStores(api); 
                    setTimeout(() => removeOperation(uiOpId), 5000);
                } else {
                    updateOperation(uiOpId, 'indexing');
                    setTimeout(() => pollOperation(opName, uiOpId), 3000);
                }
            } catch(e) {
                updateOperation(uiOpId, 'failed', e.message);
                setTimeout(() => removeOperation(uiOpId), 5000);
            }
        }, [api, activeStore, loadStores]);


        // --- Routing and Navigation ---
        const navigate = (path) => window.location.hash = path;

        React.useEffect(() => {
            const processHash = async () => {
                const route = hash.replace('#', '');
                if (!route || route === '/') { setView('HOME'); setActiveStore(null); setActiveChat(null); return; }
                if (route === '/settings') { setView('SETTINGS'); return; }

                if (route.startsWith('/project/')) {
                    const parts = route.split('/');
                    const storeNamePartial = parts[2]; 
                    const action = parts[3];
                    const targetStore = stores.find(s => s.name.includes(storeNamePartial));

                    if (targetStore) {
                        setActiveStore(targetStore);
                        const storeChats = allChats.filter(c => c.storeName === targetStore.name);
                        
                        if (action === 'docs') { setView('DOCS'); setActiveChat(null); }
                        else if (action === 'chat') {
                             const chatId = parts[4];
                             const chat = storeChats.find(c => c.id === chatId);
                             if (chat) { setActiveChat(chat); setView('CHAT'); }
                             else if (storeChats.length > 0) { navigate(`/project/${targetStore.name.split('/').pop()}/chat/${storeChats[0].id}`); }
                             else { handleNewChat(targetStore, true); } 
                        } else if (action === 'explore') {
                            const docName = decodeURIComponent(parts[4]);
                            setActiveDoc({ name: docName, displayName: 'Document' });
                            setView('EXPLORE');
                        }
                    } else if (stores.length > 0) {
                         setView('HOME'); 
                    }
                }
            };
            
            if (api) processHash();
        }, [hash, stores, allChats, api]);


        // --- Chat Management Functions ---
        const getChatsForActiveStore = () => allChats.filter(c => c.storeName === activeStore?.name).sort((a,b) => (b.updated||0) - (a.updated||0)); 

        const handleNewChat = (store, navigateTo=false) => {
            const newChat = { 
                id: crypto.randomUUID(), 
                storeName: store.name, 
                title: 'ìƒˆ ëŒ€í™”', 
                messages: [], 
                created: Date.now(),
                updated: Date.now()
            };
            db.saveChat(newChat).then(() => {
                setAllChats(p => [newChat, ...p.filter(c => c.storeName !== store.name || c.id !== newChat.id)].sort((a,b) => (b.updated||0) - (a.updated||0)));
                if (navigateTo) navigate(`/project/${store.name.split('/').pop()}/chat/${newChat.id}`);
            });
        };

        const handleSelectChat = (chat) => {
             navigate(`/project/${activeStore.name.split('/').pop()}/chat/${chat.id}`);
        };

        const handleDeleteChat = (chatId) => {
            db.deleteChat(chatId).then(() => {
                setAllChats(p => p.filter(c => c.id !== chatId));
                if (activeChat?.id === chatId) {
                    const remainingChats = getChatsForActiveStore().filter(c => c.id !== chatId);
                    if (remainingChats.length > 0) { handleSelectChat(remainingChats[0]); }
                    else { handleNewChat(activeStore, true); }
                }
            });
        };

        const handleRenameChat = (chatId, newTitle) => {
            const chat = allChats.find(c => c.id === chatId);
            if (chat) {
                const updatedChat = { ...chat, title: newTitle, updated: Date.now() };
                db.saveChat(updatedChat).then(() => {
                    setAllChats(p => p.map(c => c.id === chatId ? updatedChat : c).sort((a,b) => (b.updated||0) - (a.updated||0)));
                    if (activeChat?.id === chatId) setActiveChat(updatedChat);
                });
            }
        };

        const handleSend = async (txt) => {
            if(!txt.trim() || !api || !activeChat || !activeStore) return;
            const newMsgs = [...activeChat.messages, { role: 'user', text: txt }];
            
            const updatedChat = { ...activeChat, messages: newMsgs, title: activeChat.title === 'ìƒˆ ëŒ€í™”' ? txt.substring(0, 30) + '...' : activeChat.title };
            setActiveChat(updatedChat); 
            db.saveChat(updatedChat);
            setAllChats(p => p.map(c => c.id === activeChat.id ? updatedChat : c).sort((a,b) => (b.updated||0) - (a.updated||0)));

            setLoading(true);
            try {
                const p = (config.personas || DEFAULT_PERSONAS).find(p => p.id === config.activePersonaId) || DEFAULT_PERSONAS[0];
                const res = await api.generateContent(config.model, newMsgs, p.instr, activeStore.name);
                const botMsg = { role: 'model', text: res.candidates[0].content.parts[0].text, grounding: res.candidates[0].groundingMetadata };
                const finalMsgs = [...newMsgs, botMsg];
                
                const finalChat = { ...updatedChat, messages: finalMsgs };
                setActiveChat(finalChat);
                db.saveChat(finalChat);
                setAllChats(p => p.map(c => c.id === activeChat.id ? finalChat : c).sort((a,b) => (b.updated||0) - (a.updated||0)));

            } catch(e) { 
                const errorMsg = `âš ï¸ Error: ${e.message}`;
                const finalMsgs = [...newMsgs, { role: 'model', text: errorMsg }];
                setActiveChat({ ...updatedChat, messages: finalMsgs });
                db.saveChat({ ...updatedChat, messages: finalMsgs });
                console.error(errorMsg);
            } finally { setLoading(false); }
        };

        // --- File/Store Management Functions ---
        const handleCreateStore = async (name, desc) => { 
            const opId = crypto.randomUUID();
            addOperation(opId, `í”„ë¡œì íŠ¸ '${name}' ìƒì„± ì¤‘...`, null, null);
            try {
                const newStore = await api.createStore(name, desc);
                loadStores(api); 
                updateOperation(opId, 'succeeded');
                setTimeout(() => removeOperation(opId), 5000);
            } catch(e) {
                updateOperation(opId, 'failed', e.message);
                setTimeout(() => removeOperation(opId), 5000);
            }
        };

        const handleDeleteStore = async (name) => {
            if (!window.confirm('í”„ë¡œì íŠ¸ì™€ ëª¨ë“  ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            const opId = crypto.randomUUID();
            addOperation(opId, `í”„ë¡œì íŠ¸ ì‚­ì œ ì¤‘...`, null, null);
            try {
                await api.deleteStore(name);
                loadStores(api); 
                updateOperation(opId, 'succeeded');
                setTimeout(() => removeOperation(opId), 5000);
            } catch(e) {
                updateOperation(opId, 'failed', e.message);
                setTimeout(() => removeOperation(opId), 5000);
            }
        };
        
        const handleUploadFiles = async (storeName, files) => {
            for(const f of files) {
                const opId = crypto.randomUUID();
                addOperation(opId, `'${f.name}' ì—…ë¡œë“œ`, storeName, `${storeName}/documents/${f.name}`);
                try {
                    const op = await api.uploadFile(storeName, f);
                    updateOperation(opId, 'indexing');
                    // Start polling for the long-running operation
                    pollOperation(op.name, opId);
                } catch(e) {
                    updateOperation(opId, 'failed', e.message);
                    setTimeout(() => removeOperation(opId), 5000);
                }
            }
        };

        const isProjectView = ['CHAT', 'DOCS', 'EXPLORE'].includes(view);

        const renderContent = () => {
            if (!config.key) return <SettingsView config={config} setConfig={setConfig} />; 
            
            const activeStoreChats = activeStore ? getChatsForActiveStore() : [];
            const chatMessages = activeChat ? activeChat.messages : [];
            
            switch(view) {
                case 'HOME': 
                    return <HomeView 
                                stores={stores} 
                                onCreate={handleCreateStore} 
                                onSelect={(s)=>{
                                    const storeChats = allChats.filter(c => c.storeName === s.name);
                                    if(storeChats.length > 0) { navigate(`/project/${s.name.split('/').pop()}/chat/${storeChats[0].id}`); }
                                    else { handleNewChat(s, true); }
                                }} 
                                onDelete={handleDeleteStore} 
                                api={api}
                                isLoading={isHomeLoading}
                                error={initError}
                                navigate={navigate}
                            />;
                case 'CHAT': 
                    return <ChatView 
                                activeStore={activeStore} 
                                messages={chatMessages} 
                                isLoading={loading} 
                                onSend={handleSend} 
                                onDocs={()=>navigate(`/project/${activeStore.name.split('/').pop()}/docs`)} 
                                personas={config.personas || DEFAULT_PERSONAS} 
                                activePersonaId={config.activePersonaId} 
                                onPersonaChange={(id)=>setConfig({...config, activePersonaId:id})} 
                                chats={activeStoreChats}
                                activeChat={activeChat}
                                onSelectChat={handleSelectChat}
                                onNewChat={()=>handleNewChat(activeStore, true)}
                                onDeleteChat={handleDeleteChat}
                                onRenameChat={handleRenameChat}
                                onShowSidebar={()=>setIsSidebarOpen(true)}
                            />;
                case 'DOCS': 
                    return <DocsView 
                                api={api} 
                                activeStore={activeStore} 
                                onBack={()=>navigate('/')} 
                                onChat={()=>{
                                    const storeChats = allChats.filter(c => c.storeName === activeStore.name);
                                    if(storeChats.length > 0) { navigate(`/project/${activeStore.name.split('/').pop()}/chat/${storeChats[0].id}`); }
                                    else { handleNewChat(activeStore, true); }
                                }} 
                                onSearchDoc={(d)=>{navigate(`/project/${activeStore.name.split('/').pop()}/explore/${encodeURIComponent(d.name)}`);}} 
                                onUploadFiles={handleUploadFiles}
                                operations={pendingOperations}
                                onShowSidebar={()=>setIsSidebarOpen(true)}
                            />;
                case 'EXPLORE': 
                    return <DocSearchView 
                                api={api} 
                                activeDoc={activeDoc} 
                                onBack={()=>navigate(`/project/${activeStore?.name.split('/').pop()}/docs`)} 
                                onShowSidebar={()=>setIsSidebarOpen(true)}
                            />;
                case 'SETTINGS': 
                    return <SettingsView 
                                config={config} 
                                setConfig={setConfig} 
                            />;
                default: return <HomeView stores={stores} onCreate={handleCreateStore} onSelect={(s)=>{const cs=allChats.filter(c=>c.storeName===s.name); if(cs.length>0) navigate(`/project/${s.name.split('/').pop()}/chat/${cs[0].id}`); else handleNewChat(s, true);}} onDelete={handleDeleteStore} api={api} isLoading={isHomeLoading} error={initError} navigate={navigate}/>;
            }
        };

        return (
            <div className="w-full h-full flex flex-col md:flex-row bg-[#fafafa]">
                {/* 1. PROJECT SIDEBAR / NAVBAR SLOT - Renders either ProjectSidebar (static on desktop, mobile overlay is controlled by state) or NavBar */}
                {isProjectView && activeStore ? (
                    <ProjectSidebar 
                        isOpen={isSidebarOpen} // Controls mobile overlay visibility
                        onClose={()=>setIsSidebarOpen(false)}
                        store={activeStore}
                        chats={activeStore ? getChatsForActiveStore() : []}
                        activeChat={activeChat}
                        onSelectChat={handleSelectChat}
                        onNewChat={()=>handleNewChat(activeStore, true)}
                        onDeleteChat={handleDeleteChat}
                        onRenameChat={handleRenameChat}
                        onBackToHome={()=>navigate('/')}
                    />
                ) : (
                    <NavBar 
                        currentPath={hash.replace('#','')} 
                        onStatusClick={()=>setIsStatusOpen(true)} 
                        operationCount={Object.values(pendingOperations).filter(op => op.status !== 'succeeded' && op.status !== 'failed').length}
                    />
                )}
                
                {/* 2. MAIN CONTENT AREA */}
                <main className="flex-1 flex flex-col min-w-0 h-full relative bg-white md:border-l border-[#dbdbdb] w-full shadow-sm">
                    {renderContent()}
                </main>
                
                {/* 3. OPERATION STATUS DRAWER */}
                <OperationStatus 
                    isOpen={isStatusOpen} 
                    onClose={()=>setIsStatusOpen(false)} 
                    operations={pendingOperations}
                    removeOperation={removeOperation}
                />
            </div>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
