<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Architect V4.2 - Polished</title>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* --- Color Palette (Zinc & Emerald) --- */
            --bg-app: #09090b;       /* Zinc 950 */
            --bg-sidebar: #18181b;   /* Zinc 900 */
            --bg-card: #27272a;      /* Zinc 800 */
            --bg-input: #3f3f46;     /* Zinc 700 */
            --bg-hover: #52525b;     /* Zinc 600 */
            
            --text-primary: #f4f4f5; /* Zinc 100 */
            --text-secondary: #a1a1aa; /* Zinc 400 */
            --text-muted: #71717a;   /* Zinc 500 */

            --accent: #10b981;       /* Emerald 500 */
            --accent-hover: #059669; /* Emerald 600 */
            --accent-dim: rgba(16, 185, 129, 0.15);
            
            --border: #2e323b;
            --danger: #ef4444;
            
            --sidebar-width: 280px;
            --header-height: 64px;
        }

        /* --- Reset & Base --- */
        * { box-sizing: border-box; outline: none; }
        
        body, html { 
            margin: 0; padding: 0;
            background-color: var(--bg-app); 
            color: var(--text-primary);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100%; 
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        button {
            background: transparent; /* Global Reset for buttons */
            border: none;
            padding: 0;
            font-family: inherit;
            color: inherit;
        }

        /* --- Layout Utilities --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1; min-height: 0; }
        .flex-shrink-0 { flex-shrink: 0; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .gap-1 { gap: 0.25rem; } .gap-2 { gap: 0.5rem; } .gap-3 { gap: 0.75rem; } .gap-4 { gap: 1rem; } .gap-6 { gap: 1.5rem; }
        
        .w-full { width: 100%; } 
        .h-full { height: 100%; }
        
        /* Size Utilities */
        .w-8 { width: 2rem; } .h-8 { height: 2rem; }
        .w-4 { width: 1rem; } .h-4 { height: 1rem; }
        
        .max-w-xs { max-width: 20rem; }
        .max-w-3xl { max-width: 48rem; }
        .max-w-6xl { max-width: 72rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }

        /* Spacing Utilities */
        .p-0 { padding: 0; } .p-1 { padding: 0.25rem; } .p-2 { padding: 0.5rem; } .p-3 { padding: 0.75rem; } .p-4 { padding: 1rem; } .p-6 { padding: 1.5rem; } .p-8 { padding: 2rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; } .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; } .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; } .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .pl-4 { padding-left: 1rem; } .pr-14 { padding-right: 3.5rem; }
        
        .mb-1 { margin-bottom: 0.25rem; } .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; } .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; } .mt-2 { margin-top: 0.5rem; } .mt-3 { margin-top: 0.75rem; } .mt-4 { margin-top: 1rem; } .mt-auto { margin-top: auto; }
        .ml-auto { margin-left: auto; }

        /* Position Utilities */
        .relative { position: relative; } .absolute { position: absolute; } .fixed { position: fixed; } .sticky { position: sticky; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .top-0 { top: 0; } .right-2 { right: 0.5rem; } .bottom-2 { bottom: 0.5rem; }
        .z-10 { z-index: 10; } .z-20 { z-index: 20; } .z-50 { z-index: 50; }

        /* Visual Utilities */
        .bg-transparent { background-color: transparent; }
        .bg-bg-input { background-color: var(--bg-input); }
        .text-white { color: white; }
        
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }

        /* --- Scroll Handling --- */
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .scroll-smooth { scroll-behavior: smooth; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-input); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--bg-hover); }

        /* --- Component: Buttons --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500;
            transition: all 0.2s ease; cursor: pointer; border: 1px solid transparent;
            font-size: 0.875rem; line-height: 1.25rem; white-space: nowrap;
        }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        
        .btn-primary { background-color: var(--accent); color: #fff; border: none; }
        .btn-primary:hover { background-color: var(--accent-hover); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); }
        
        .btn-secondary { background-color: var(--bg-input); color: var(--text-primary); border-color: var(--border); }
        .btn-secondary:hover { background-color: var(--bg-hover); border-color: var(--text-muted); }

        .btn-ghost { background-color: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background-color: rgba(255,255,255,0.1); color: var(--text-primary); }
        
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        /* --- Component: Inputs --- */
        .input {
            width: 100%; background-color: var(--bg-input); color: var(--text-primary);
            border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.6rem 1rem;
            font-size: 0.9rem; transition: border-color 0.2s;
        }
        .input:focus { border-color: var(--accent); ring: 1px solid var(--accent); }
        .input::placeholder { color: var(--text-muted); }

        /* --- Component: Chat Input Box (Fixed) --- */
        .chat-input-box {
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            position: relative;
        }
        .chat-input-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent), 0 10px 30px -10px rgba(16, 185, 129, 0.2);
        }

        /* --- Component: Sidebar --- */
        .sidebar {
            width: var(--sidebar-width); background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            height: 100%;
        }
        .nav-item {
            padding: 0.6rem 0.8rem; margin: 0.2rem 0.5rem; border-radius: 0.5rem;
            cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; justify-content: space-between;
            transition: all 0.15s; font-size: 0.9rem;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.03); color: var(--text-primary); }
        .nav-item.active { background-color: var(--accent-dim); color: var(--accent); border: 1px solid rgba(16,185,129,0.1); }
        .nav-item input { background: transparent; border: none; border-bottom: 1px solid var(--accent); color: white; width: 100%; padding: 2px; }

        /* --- Component: Cards --- */
        .card {
            background-color: var(--bg-card); border: 1px solid var(--border);
            border-radius: 0.75rem; padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            height: 100%;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); border-color: var(--bg-hover); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }

        /* --- Component: Chat Bubbles --- */
        .bubble { padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; font-size: 0.95rem; max-width: 85%; word-break: break-word; position: relative; }
        .bubble.user { background-color: var(--bg-input); margin-left: auto; border-bottom-right-radius: 2px; color: var(--text-primary); }
        .bubble.model { background-color: transparent; margin-right: auto; padding-left: 0; color: #e4e4e7; }
        
        /* --- Markdown Styling --- */
        .prose p { margin-bottom: 0.5em; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose code { background-color: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Menlo', monospace; font-size: 0.85em; color: #e4e4e7; }
        .prose pre { background: #111113; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5em 0; border: 1px solid var(--border); }
        .prose pre code { background: transparent; padding: 0; color: inherit; }
        .prose ul { padding-left: 1.2em; list-style: disc; margin-bottom: 0.5em; color: var(--text-secondary); }
        .prose ol { padding-left: 1.2em; list-style: decimal; margin-bottom: 0.5em; color: var(--text-secondary); }
        .prose a { color: var(--accent); text-decoration: none; }
        .prose a:hover { text-decoration: underline; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 1rem; width: 90%; max-width: 480px; padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease-out;
        }

        /* --- Grid --- */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) { 
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } 
            .md\:flex-row { flex-direction: row; }
            .md\:w-auto { width: auto; }
        }
        @media (min-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }

        /* --- Typography --- */
        .text-2xl { font-size: 1.5rem; line-height: 2rem; font-weight: 700; color: #fff; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; color: #fff; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; font-weight: 600; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .font-bold { font-weight: 700; }
        .font-mono { font-family: monospace; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .text-accent { color: var(--accent); }
        .text-muted { color: var(--text-muted); }
        .text-danger { color: var(--danger); }

        /* --- Utilities --- */
        .hidden { display: none; }
        .block { display: block; }
        .cursor-pointer { cursor: pointer; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .backdrop-blur { backdrop-filter: blur(8px); }
        .bg-app-80 { background-color: rgba(9, 9, 11, 0.8); }
        
        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(16,185,129,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
    (function() { 

    const { useState, useEffect, useRef, useMemo } = React;
    const Icon = ({ name, className = "" }) => <i className={`bi bi-${name} ${className}`} style={{display:'inline-block', lineHeight:1}}></i>;

    /* --- API Logic --- */
    const API_BASE = 'https://generativelanguage.googleapis.com/v1beta/';
    const DB_NAME = 'GeminiStore_V4'; 
    const CHAT_STORE = 'chats';

    const openDB = () => new Promise((res, rej) => { const r = indexedDB.open(DB_NAME, 1); r.onupgradeneeded = e => e.target.result.createObjectStore(CHAT_STORE, { keyPath: 'id' }); r.onsuccess = e => res(e.target.result); r.onerror = rej; });
    const dbOp = async (mode, fn) => { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(CHAT_STORE, mode); fn(tx.objectStore(CHAT_STORE), res); tx.onerror = rej; if(mode==='readwrite') tx.oncomplete = () => res(); }); };
    const getChats = () => dbOp('readonly', (s, r) => { const q = s.getAll(); q.onsuccess = () => r(q.result); });
    const saveChat = (c) => dbOp('readwrite', (s) => s.put(c));
    const deleteChatDB = (id) => dbOp('readwrite', (s) => s.delete(id));

    const apiReq = async (ep, opts={}, key) => {
        let url = `${API_BASE}${ep}`;
        if(opts.params) url += `?${new URLSearchParams(opts.params)}`;
        const r = await fetch(url, {...opts, headers:{'Content-Type':'application/json','x-goog-api-key':key}, params:undefined});
        if(!r.ok) throw new Error((await r.json()).error?.message || r.statusText);
        return r.json();
    }
    const apiUpload = async (file, key) => {
        const url = `https://generativelanguage.googleapis.com/upload/v1beta/files?displayName=${encodeURIComponent(file.name)}`;
        const r = await fetch(url, {method:'POST', headers:{'x-goog-api-key':key}, body: new FormData().append('file',file)||new FormData()}); 
        const fd = new FormData(); fd.append('file', file);
        const r2 = await fetch(url, {method:'POST', headers:{'x-goog-api-key':key}, body: fd});
        if(!r2.ok) throw new Error(await r2.text());
        return r2.json();
    }
    const fmtBytes = (b) => { if(!b) return '0 B'; const i = Math.floor(Math.log(b)/Math.log(1024)); return `${(b/Math.pow(1024,i)).toFixed(1)} ${['B','KB','MB','GB'][i]}`; };

    /* --- Components --- */
    function Settings({ isOpen, close, config, setConfig }) {
        const [temp, setTemp] = useState(config);
        useEffect(() => { if(isOpen) setTemp(config); }, [isOpen]);
        const save = () => { setConfig(temp); localStorage.setItem('gemini_config_v4', JSON.stringify(temp)); close(); };

        if(!isOpen) return null;
        return (
            <div className="modal-overlay">
                <div className="modal-content">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl">ÌôòÍ≤Ω ÏÑ§Ï†ï</h2>
                        <button onClick={close} className="text-muted hover:text-primary btn-icon"><Icon name="x-lg" /></button>
                    </div>
                    <div className="flex flex-col gap-4">
                        <div>
                            <label className="block text-xs font-bold text-muted uppercase mb-2">API Key</label>
                            <input type="password" value={temp.key} onChange={e=>setTemp({...temp, key:e.target.value})} className="input" placeholder="Google AI Studio Key" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-muted uppercase mb-2">Model</label>
                            <select value={temp.model} onChange={e=>setTemp({...temp, model:e.target.value})} className="input cursor-pointer">
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (Fastest)</option>
                                <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash Preview (Experimental)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Powerful)</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-muted uppercase mb-2">System Persona</label>
                            <textarea rows="4" value={temp.instr} onChange={e=>setTemp({...temp, instr:e.target.value})} className="input resize-none" />
                        </div>
                    </div>
                    <div className="flex justify-end gap-2 mt-8">
                        <button onClick={close} className="btn btn-secondary">Ï∑®ÏÜå</button>
                        <button onClick={save} className="btn btn-primary px-6">Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>
        );
    }

    function Sidebar({ chats, curChat, setCurChat, newChat, delChat, renameChat, goHome, storeName }) {
        const [edit, setEdit] = useState({id:null, val:''});
        return (
            <div className="sidebar flex-shrink-0">
                <div className="p-4 h-[64px] flex items-center border-b border-border">
                    <button onClick={goHome} className="btn btn-ghost w-full justify-start gap-2 text-sm">
                        <Icon name="grid-fill" /> <span>ÎåÄÏãúÎ≥¥ÎìúÎ°ú Ïù¥Îèô</span>
                    </button>
                </div>
                <div className="p-4">
                    <div className="bg-card border border-border rounded-lg p-3 mb-4 shadow-sm">
                        <div className="text-xs text-accent font-bold uppercase mb-1 flex items-center gap-1"><Icon name="folder2-open" /> Current Project</div>
                        <div className="text-sm font-bold text-white truncate" title={storeName}>{storeName}</div>
                    </div>
                    <button onClick={newChat} className="btn btn-primary w-full gap-2 shadow-lg">
                        <Icon name="chat-left-text" /> ÏÉà Ï±ÑÌåÖ ÏãúÏûë
                    </button>
                </div>
                <div className="flex-1 overflow-y-auto px-2 pb-4">
                    <div className="px-3 py-2 text-xs font-bold text-muted uppercase tracking-wider">Chat History</div>
                    {chats.map(c => (
                        <div key={c.id} onClick={()=>setCurChat(c)} className={`nav-item group ${curChat?.id===c.id?'active':''}`}>
                            {edit.id === c.id ? (
                                <input autoFocus value={edit.val} onChange={e=>setEdit({...edit, val:e.target.value})} 
                                    onBlur={()=>{if(edit.val.trim()) renameChat(c, edit.val); setEdit({id:null, val:''})}}
                                    onKeyDown={e=>{if(e.key==='Enter') e.target.blur()}}
                                    onClick={e=>e.stopPropagation()} />
                            ) : (
                                <>
                                    <span className="truncate flex-1 mr-2">{c.title}</span>
                                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                        {/* Fixed: Added btn-ghost and btn-icon to prevent white box */}
                                        <button onClick={e=>{e.stopPropagation(); setEdit({id:c.id, val:c.title})}} className="btn btn-ghost p-1 w-6 h-6 rounded flex items-center justify-center"><Icon name="pencil" className="text-xs" /></button>
                                        <button onClick={e=>{e.stopPropagation(); delChat(c.id)}} className="btn btn-ghost p-1 w-6 h-6 rounded flex items-center justify-center hover:text-danger"><Icon name="trash" className="text-xs" /></button>
                                    </div>
                                </>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    function Dashboard({ stores, onCreate, onDelete, onOpen, isDel }) {
        const [name, setName] = useState('');
        return (
            <div className="w-full max-w-6xl mx-auto p-6 md:p-8 animate-fade-in">
                <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 pb-6 border-b border-border">
                    <div className="text-center md:text-left w-full md:w-auto">
                        <h1 className="text-2xl mb-1">ÌîÑÎ°úÏ†ùÌä∏ Î≥¥Í¥ÄÌï®</h1>
                        <p className="text-muted text-sm">Î∂ÑÏÑùÌï† Î¨∏ÏÑú ÏÑ∏Ìä∏Î•º Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                    </div>
                    <div className="flex gap-2 w-full md:w-auto">
                        <div className="relative flex-1 md:w-64">
                            <input value={name} onChange={e=>setName(e.target.value)} className="input pr-10" placeholder="ÏÉà ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ..." />
                        </div>
                        <button onClick={()=>{if(name.trim()){onCreate(name); setName('')}}} className="btn btn-primary flex-shrink-0 w-10 h-10 p-0 rounded-lg"><Icon name="plus-lg" className="text-lg" /></button>
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {stores.map(s => (
                        <div key={s.name} className="card group">
                            <div className="card-header">
                                <div className="bg-bg-input p-2.5 rounded-lg border border-border shadow-sm"><Icon name="folder-fill" className="text-accent text-lg" /></div>
                                <button onClick={()=>onDelete(s.name)} disabled={isDel===s.name} className="btn btn-ghost btn-icon text-muted hover:text-danger">
                                    {isDel===s.name ? <div className="spinner" /> : <Icon name="trash" />}
                                </button>
                            </div>
                            <div className="mb-4 flex-1">
                                <h3 className="text-lg text-white mb-1 truncate">{s.displayName}</h3>
                                <p className="text-xs text-muted font-mono truncate opacity-60">{s.name.split('/')[1]}</p>
                            </div>
                            <div className="flex gap-4 text-xs text-muted mb-6 bg-bg-app/50 p-2 rounded border border-border/50">
                                <span className="flex items-center gap-1.5"><Icon name="file-earmark-text" /> {s.activeDocumentsCount||0} Docs</span>
                                <span className="flex items-center gap-1.5"><Icon name="hdd" /> {fmtBytes(s.sizeBytes)}</span>
                            </div>
                            <div className="mt-auto pt-4 border-t border-border flex gap-2">
                                <button onClick={()=>onOpen(s, 'DOCS')} className="btn btn-secondary flex-1 text-xs gap-2"><Icon name="journals" /> Î¨∏ÏÑú</button>
                                <button onClick={()=>onOpen(s, 'CHAT')} className="btn btn-primary flex-1 text-xs gap-2"><Icon name="chat-fill" /> Ï±ÑÌåÖ</button>
                            </div>
                        </div>
                    ))}
                    {!stores.length && (
                        <div className="col-span-full py-24 text-center border-2 border-dashed border-border rounded-xl bg-card/20 flex flex-col items-center justify-center text-muted">
                            <Icon name="inbox" className="text-4xl mb-4 opacity-50" /><p>ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    function Docs({ store, back, apiKey }) {
        const [list, setList] = useState([]);
        const [up, setUp] = useState(false);
        const load = async () => { try { const r = await apiReq(`${store.name}/documents`, {}, apiKey); setList(r.documents||[]); } catch(e) { console.error(e); } };
        useEffect(() => { load(); }, []);
        const upload = async (e) => {
            const fs = Array.from(e.target.files); if(!fs.length) return; setUp(true);
            for(const f of fs) { try { await apiUpload(f, apiKey); } catch(e) { console.error(e); } }
            await load(); setUp(false);
        };
        const del = async (n) => { if(confirm('ÏÇ≠Ï†ú?')) { await apiReq(n, {method:'DELETE'}, apiKey); load(); } };

        return (
            <div className="w-full max-w-5xl mx-auto p-6 md:p-8 animate-fade-in">
                <div className="flex items-center gap-4 mb-8 pb-6 border-b border-border">
                    <button onClick={back} className="btn btn-secondary btn-icon"><Icon name="arrow-left" /></button>
                    <div><h2 className="text-2xl text-white">Î¨∏ÏÑú Í¥ÄÎ¶¨</h2><p className="text-sm text-accent flex items-center gap-2"><Icon name="folder2-open" /> {store.displayName}</p></div>
                </div>
                <label className={`flex flex-col items-center justify-center border-2 border-dashed border-border rounded-xl p-12 text-center mb-8 cursor-pointer transition hover:border-accent hover:bg-card/50 ${up?'opacity-50 pointer-events-none':''}`}>
                    <input type="file" multiple onChange={upload} className="hidden" />
                    <div className="w-16 h-16 rounded-full bg-bg-input flex items-center justify-center mb-4 shadow-lg"><Icon name="cloud-arrow-up" className="text-2xl text-accent" /></div>
                    <p className="text-white font-medium text-lg mb-1">ÌååÏùº ÏóÖÎ°úÎìú</p>
                    {up && <div className="mt-4 flex items-center gap-2 text-accent font-bold animate-pulse"><div className="spinner" /> Ï≤òÎ¶¨ Ï§ë...</div>}
                </label>
                <div className="bg-card border border-border rounded-xl overflow-hidden shadow-lg">
                    <table className="w-full text-left text-sm border-collapse min-w-[600px]">
                        <thead className="bg-bg-input text-muted uppercase text-xs font-bold"><tr><th className="p-4 border-b border-border">Name</th><th className="p-4 border-b border-border">Status</th><th className="p-4 border-b border-border text-right">Action</th></tr></thead>
                        <tbody className="divide-y divide-border">
                            {list.map(d => (
                                <tr key={d.name} className="hover:bg-white/5 transition group">
                                    <td className="p-4 text-white"><div className="flex items-center gap-3"><Icon name="file-earmark-text" className="text-accent"/> <span className="truncate max-w-[300px]">{d.displayName}</span></div></td>
                                    <td className="p-4"><span className={`inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold ${d.state==='ACTIVE'?'bg-emerald-500/10 text-emerald-500 border border-emerald-500/20':'bg-amber-500/10 text-amber-500 border border-amber-500/20'}`}>{d.state}</span></td>
                                    <td className="p-4 text-right"><button onClick={()=>del(d.name)} className="btn btn-ghost btn-icon text-muted hover:text-danger ml-auto"><Icon name="trash" /></button></td>
                                </tr>
                            ))}
                            {!list.length && <tr><td colSpan="3" className="p-12 text-center text-muted">Î¨∏ÏÑú ÏóÜÏùå</td></tr>}
                        </tbody>
                    </table>
                </div>
            </div>
        );
    }

    function Chat({ chat, apiKey, config, updateChat }) {
        const [msgs, setMsgs] = useState(chat.messages||[]);
        const [txt, setTxt] = useState('');
        const [loading, setLoading] = useState(false);
        const endRef = useRef(null);
        const taRef = useRef(null);
        
        useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [msgs, loading]);
        
        const send = async (e) => {
            e.preventDefault(); if(!txt.trim()||loading) return;
            const newMsgs = [...msgs, { role:'user', text:txt }];
            setMsgs(newMsgs); setTxt(''); setLoading(true);
            if(taRef.current) taRef.current.style.height = 'auto';
            try {
                const r = await apiReq(`models/${config.model}:generateContent`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: newMsgs.map(m=>({role:m.role, parts:[{text:m.text}]})),
                        systemInstruction: {parts:[{text:config.instr}]},
                        tools: [{fileSearch:{fileSearchStoreNames:[chat.storeName]}}]
                    })
                }, apiKey);
                const botMsg = { role:'model', text: r.candidates[0].content.parts[0].text, groundingMetadata: r.candidates[0].groundingMetadata };
                const final = [...newMsgs, botMsg];
                setMsgs(final); updateChat({...chat, messages:final});
            } catch(e) {
                setMsgs([...newMsgs, { role:'model', text:`üö® Error: ${e.message}` }]);
            } finally { setLoading(false); }
        };

        return (
            <div className="flex flex-col h-full bg-app relative">
                <div className="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                    {!msgs.length && (
                        <div className="h-full flex flex-col items-center justify-center text-muted opacity-60 pb-20">
                            <div className="w-20 h-20 bg-bg-card rounded-full flex items-center justify-center mb-6 border border-border"><Icon name="stars" className="text-4xl text-accent" /></div>
                            <p className="text-lg font-medium text-white">AI Î¨∏ÏÑú Î∂ÑÏÑù Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏</p>
                            <p className="text-sm mt-2">Î¨∏ÏÑú ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú ÏßàÎ¨∏ÌïòÍ≥† ÌÜµÏ∞∞Î†•ÏùÑ ÏñªÏúºÏÑ∏Ïöî.</p>
                        </div>
                    )}
                    <div className="max-w-3xl mx-auto space-y-6 pb-4">
                        {msgs.map((m, i) => (
                            <div key={i} className={`flex animate-fade-in gap-4 ${m.role==='user'?'justify-end':''}`}>
                                {m.role==='model' && <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center flex-shrink-0 shadow-md mt-1"><Icon name="gem" className="text-white text-sm" /></div>}
                                <div className={`bubble ${m.role} shadow-md`}>
                                    <div className="prose" dangerouslySetInnerHTML={{__html: marked.parse(m.text)}} />
                                    {m.groundingMetadata?.groundingAttributions?.length > 0 && (
                                        <div className="mt-4 pt-3 border-t border-white/10">
                                            <p className="text-xs text-accent font-bold mb-2 flex items-center gap-1"><Icon name="link-45deg"/> Ï∞∏Í≥† ÏûêÎ£å</p>
                                            <div className="flex flex-wrap gap-2">
                                                {m.groundingMetadata.groundingAttributions.map((a,idx) => (
                                                    <a key={idx} href={a.web?.uri} target="_blank" className="text-xs bg-black/30 hover:bg-black/50 text-muted hover:text-white px-2 py-1.5 rounded border border-border flex items-center gap-1 transition max-w-full">
                                                        <span className="truncate max-w-[180px]">{a.file?.displayName || a.web?.title || 'Source'}</span> <Icon name="box-arrow-up-right" className="text-[10px]" />
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="flex gap-4 max-w-3xl mx-auto animate-fade-in"><div className="w-8 h-8 rounded-lg bg-bg-card flex items-center justify-center flex-shrink-0 border border-border mt-1"><div className="spinner w-4 h-4 border-2"></div></div><div className="text-muted text-sm flex items-center pt-2">ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë...</div></div>}
                        <div ref={endRef} />
                    </div>
                </div>
                
                {/* Fixed: Input Area with dedicated class and button style */}
                <div className="p-4 border-t border-border bg-app-80 backdrop-blur z-10">
                    <div className="chat-input-box max-w-3xl mx-auto">
                        <textarea 
                            ref={taRef}
                            value={txt} 
                            onChange={e=>{setTxt(e.target.value); e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 150) + 'px';}}
                            onKeyDown={e=>{if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(e); }}}
                            className="w-full bg-transparent text-white pl-4 pr-14 py-3 resize-none outline-none text-sm max-h-[150px]" 
                            rows="1"
                            placeholder="Î¨∏ÏÑú ÎÇ¥Ïö©Ïóê ÎåÄÌï¥ ÏßàÎ¨∏ÌïòÏÑ∏Ïöî..." 
                            disabled={loading} 
                        />
                        <button 
                            onClick={send} 
                            disabled={!txt.trim()||loading} 
                            className="absolute right-2 bottom-2 w-8 h-8 btn btn-primary p-0 rounded-lg flex items-center justify-center transition disabled:opacity-0 disabled:scale-90"
                        >
                            <Icon name="arrow-up" className="text-lg font-bold" />
                        </button>
                    </div>
                    <div className="text-center mt-3 text-xs text-muted opacity-70">GeminiÎäî Î¨∏ÏÑúÎ•º Î∂ÑÏÑùÌïòÏó¨ ÎãµÎ≥ÄÌï©ÎãàÎã§. Ï§ëÏöîÌïú Ï†ïÎ≥¥Îäî ÌôïÏù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</div>
                </div>
            </div>
        );
    }

    function App() {
        const [config, setConfig] = useState(JSON.parse(localStorage.getItem('gemini_config_v4')) || { key: '', model: 'gemini-2.5-flash', instr: 'Ï†ÑÎ¨∏Ï†ÅÏù∏ Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ÏûÖÎãàÎã§.' });
        const [view, setView] = useState('STORES'); 
        const [stores, setStores] = useState([]);
        const [chats, setChats] = useState([]);
        const [curStore, setCurStore] = useState(null);
        const [curChat, setCurChat] = useState(null);
        const [modalOpen, setModalOpen] = useState(!config.key);

        useEffect(() => { if(config.key) { loadStores(); getChats().then(setChats); } }, [config.key]);
        const loadStores = async () => { try { const r = await apiReq('fileSearchStores', {}, config.key); setStores(r.fileSearchStores||[]); } catch(e) { console.error(e); } };
        const createStore = async (n) => { await apiReq('fileSearchStores', {method:'POST', body:JSON.stringify({displayName:n})}, config.key); loadStores(); };
        const deleteStore = async (n) => { if(!confirm('ÏÇ≠Ï†ú?')) return; try { await apiReq(n, {method:'DELETE', params:{force:true}}, config.key); await loadStores(); } catch(e){console.error(e);} };
        
        const openStore = (s, v) => {
            setCurStore(s);
            if(v === 'CHAT') { const exist = chats.find(c => c.storeName === s.name); if(exist) setCurChat(exist); else newChat(s); }
            setView(v);
        };
        const newChat = (s) => { const c = { id: crypto.randomUUID(), storeName: s.name, title: 'ÏÉà ÎåÄÌôî', messages: [], created: Date.now() }; saveChat(c).then(() => { setChats(p=>[c,...p]); setCurChat(c); setView('CHAT'); }); };
        const updateChat = (chat) => { saveChat(chat); setChats(prev => prev.map(c => c.id === chat.id ? chat : c)); setCurChat(chat); };
        const deleteChat = async (id) => { await deleteChatDB(id); setChats(prev => prev.filter(c => c.id !== id)); if(curChat?.id === id) setView('STORES'); };

        if(!config.key && !modalOpen) setModalOpen(true);

        return (
            <div className="flex h-full text-sm bg-app">
                <Settings isOpen={modalOpen} close={()=>setModalOpen(false)} config={config} setConfig={setConfig} />
                {view === 'CHAT' && <Sidebar chats={chats.filter(c => c.storeName === curStore.name)} curChat={curChat} setCurChat={setCurChat} newChat={()=>newChat(curStore)} delChat={deleteChat} renameChat={(c,t)=>{const u={...c,title:t}; saveChat(u); setChats(p=>p.map(x=>x.id===u.id?u:x));}} goHome={()=>setView('STORES')} storeName={curStore.displayName} />}
                <div className="flex-1 flex flex-col h-full relative min-w-0">
                    <header className="h-[64px] flex items-center justify-between px-6 border-b border-border bg-app-80 backdrop-blur z-20 sticky top-0 flex-shrink-0">
                        <div className="flex items-center gap-2.5 font-bold text-lg text-white tracking-tight"><div className="w-8 h-8 bg-accent/10 rounded-lg flex items-center justify-center border border-accent/20"><Icon name="gem" className="text-accent" /></div>Gemini Architect <span className="text-xs bg-bg-input px-2 py-0.5 rounded text-muted font-normal border border-border">v4.2</span></div>
                        <div className="flex gap-3 items-center"><div className="hidden md:flex px-3 py-1 rounded-full bg-bg-input text-xs text-muted border border-border items-center gap-2"><span className="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></span> {config.model.replace('gemini-2.5-', '')}</div><button onClick={()=>setModalOpen(true)} className="btn btn-icon btn-ghost hover:bg-bg-input transition"><Icon name="gear-fill" /></button></div>
                    </header>
                    <main className={`flex-1 relative flex flex-col min-h-0 ${view !== 'CHAT' ? 'overflow-y-auto scroll-smooth' : 'overflow-hidden'}`}>
                        {view === 'STORES' && <Dashboard stores={stores} onCreate={createStore} onDelete={deleteStore} onOpen={openStore} />}
                        {view === 'DOCS' && <Docs store={curStore} back={()=>setView('STORES')} apiKey={config.key} />}
                        {view === 'CHAT' && curChat && <Chat chat={curChat} apiKey={config.key} config={config} updateChat={updateChat} />}
                    </main>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    })(); 
    </script>
</body>
</html>
