<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Architect V4.8 - Pagination Fixed</title>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* --- Color Palette (Zinc & Emerald) --- */
            --bg-app: #09090b;       /* Zinc 950 */
            --bg-sidebar: #18181b;   /* Zinc 900 */
            --bg-card: #27272a;      /* Zinc 800 */
            --bg-input: #3f3f46;     /* Zinc 700 */
            --bg-hover: #52525b;     /* Zinc 600 */
            
            --text-primary: #f4f4f5; /* Zinc 100 */
            --text-secondary: #a1a1aa; /* Zinc 400 */
            --text-muted: #71717a;   /* Zinc 500 */

            --accent: #10b981;       /* Emerald 500 */
            --accent-hover: #059669; /* Emerald 600 */
            --accent-dim: rgba(16, 185, 129, 0.15);
            
            --border: #2e323b;
            --danger: #ef4444;
            
            --sidebar-width: 280px;
            --header-height: 64px;
        }

        /* --- Reset & Base --- */
        * { box-sizing: border-box; outline: none; }
        
        body, html { 
            margin: 0; padding: 0;
            background-color: var(--bg-app); 
            color: var(--text-primary);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100%; 
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        button {
            background: transparent; border: none; padding: 0; font-family: inherit; color: inherit; cursor: pointer;
        }

        /* --- Layout Utilities --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1; min-height: 0; }
        .flex-shrink-0 { flex-shrink: 0; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .gap-1 { gap: 0.25rem; } .gap-2 { gap: 0.5rem; } .gap-3 { gap: 0.75rem; } .gap-4 { gap: 1rem; } .gap-6 { gap: 1.5rem; }
        
        .w-full { width: 100%; } 
        .h-full { height: 100%; }
        
        /* Size Utilities */
        .w-5 { width: 1.25rem; } .h-5 { height: 1.25rem; }
        .w-8 { width: 2rem; } .h-8 { height: 2rem; }
        .w-16 { width: 4rem; } .h-16 { height: 4rem; }
        
        .max-w-3xl { max-width: 48rem; }
        .max-w-6xl { max-width: 72rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }

        /* Spacing Utilities */
        .p-1 { padding: 0.25rem; } .p-2 { padding: 0.5rem; } .p-3 { padding: 0.75rem; } .p-4 { padding: 1rem; } .p-6 { padding: 1.5rem; } .p-8 { padding: 2rem; } .p-12 { padding: 3rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; } .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; } .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; } .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .pl-4 { padding-left: 1rem; } .pr-14 { padding-right: 3.5rem; }
        
        .mb-1 { margin-bottom: 0.25rem; } .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; } .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; } .mt-2 { margin-top: 0.5rem; } .mt-3 { margin-top: 0.75rem; } .mt-4 { margin-top: 1rem; } .mt-auto { margin-top: auto; }
        .ml-auto { margin-left: auto; }

        /* Position Utilities */
        .relative { position: relative; } .absolute { position: absolute; } .fixed { position: fixed; } .sticky { position: sticky; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .top-0 { top: 0; } .right-0 { right: 0; } .right-2 { right: 0.5rem; } .bottom-2 { bottom: 0.5rem; }
        .z-10 { z-index: 10; } .z-20 { z-index: 20; } .z-50 { z-index: 50; }

        /* Visual Utilities */
        .bg-transparent { background-color: transparent; }
        .bg-bg-input { background-color: var(--bg-input); }
        .bg-bg-card { background-color: var(--bg-card); }
        .text-white { color: white; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        
        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        .border-b-0 { border-bottom-width: 0; }

        /* --- Scroll Handling --- */
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .scroll-smooth { scroll-behavior: smooth; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-input); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--bg-hover); }

        /* --- Component: Buttons --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500;
            transition: all 0.2s ease; cursor: pointer; border: 1px solid transparent;
            font-size: 0.875rem; line-height: 1.25rem; white-space: nowrap;
        }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        
        .btn-primary { background-color: var(--accent); color: #fff; border: none; }
        .btn-primary:hover { background-color: var(--accent-hover); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); }
        
        .btn-secondary { background-color: var(--bg-input); color: var(--text-primary); border-color: var(--border); }
        .btn-secondary:hover { background-color: var(--bg-hover); border-color: var(--text-muted); }

        .btn-ghost { background-color: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background-color: rgba(255,255,255,0.1); color: var(--text-primary); }
        
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* --- Component: Inputs --- */
        .input {
            width: 100%; background-color: var(--bg-input); color: var(--text-primary);
            border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.6rem 1rem;
            font-size: 0.9rem; transition: border-color 0.2s;
        }
        .input:focus { border-color: var(--accent); ring: 1px solid var(--accent); }

        /* --- Component: Chat Input Box --- */
        .chat-input-box {
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            position: relative;
        }
        .chat-input-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent), 0 10px 30px -10px rgba(16, 185, 129, 0.2);
        }

        /* --- Component: Sidebar --- */
        .sidebar {
            width: var(--sidebar-width); background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            height: 100%;
        }
        .nav-item {
            padding: 0.6rem 0.8rem; margin: 0.2rem 0.5rem; border-radius: 0.5rem;
            cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; justify-content: space-between;
            transition: all 0.15s; font-size: 0.9rem;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.03); color: var(--text-primary); }
        .nav-item.active { background-color: var(--accent-dim); color: var(--accent); border: 1px solid rgba(16,185,129,0.1); }

        /* --- Component: Operations Dropdown --- */
        .ops-dropdown {
            position: absolute; right: 0; top: 100%; width: 320px;
            background-color: var(--bg-card); border: 1px solid var(--border);
            border-radius: 0.75rem; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 50; margin-top: 0.5rem; overflow: hidden;
        }
        .ops-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: white; font-size: 0.9rem; }
        .ops-list { max-height: 300px; overflow-y: auto; }
        .ops-item { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
        .ops-item:last-child { border-bottom: none; }

        /* --- Component: Cards --- */
        .card {
            background-color: var(--bg-card); border: 1px solid var(--border);
            border-radius: 0.75rem; padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            height: 100%;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); border-color: var(--bg-hover); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }

        /* --- Component: Chat Bubbles --- */
        .bubble { padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; font-size: 0.95rem; max-width: 85%; word-break: break-word; position: relative; }
        .bubble.user { background-color: var(--bg-input); margin-left: auto; border-bottom-right-radius: 2px; color: var(--text-primary); }
        .bubble.model { background-color: transparent; margin-right: auto; padding-left: 0; color: #e4e4e7; }
        
        /* --- Markdown Styling --- */
        .prose p { margin-bottom: 0.5em; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose code { background-color: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Menlo', monospace; font-size: 0.85em; color: #e4e4e7; }
        .prose pre { background: #111113; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5em 0; border: 1px solid var(--border); }
        .prose pre code { background: transparent; padding: 0; color: inherit; }
        .prose ul { padding-left: 1.2em; list-style: disc; margin-bottom: 0.5em; color: var(--text-secondary); }
        .prose ol { padding-left: 1.2em; list-style: decimal; margin-bottom: 0.5em; color: var(--text-secondary); }
        .prose a { color: var(--accent); text-decoration: none; }
        .prose a:hover { text-decoration: underline; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 1rem; width: 90%; max-width: 480px; padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease-out;
        }
        
        /* --- Drag & Drop State --- */
        .drag-active { border-color: var(--accent) !important; background-color: rgba(16, 185, 129, 0.05) !important; }

        /* --- Grid --- */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) { 
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } 
            .md\:flex-row { flex-direction: row; }
            .md\:w-auto { width: auto; }
        }
        @media (min-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }

        /* --- Typography --- */
        .text-2xl { font-size: 1.5rem; line-height: 2rem; font-weight: 700; color: #fff; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; color: #fff; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; font-weight: 600; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .font-bold { font-weight: 700; }
        .font-mono { font-family: monospace; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .text-accent { color: var(--accent); }
        .text-muted { color: var(--text-muted); }
        .text-danger { color: var(--danger); }

        /* --- Utilities --- */
        .hidden { display: none; }
        .block { display: block; }
        .pointer-events-none { pointer-events: none; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .backdrop-blur { backdrop-filter: blur(8px); }
        .bg-app-80 { background-color: rgba(9, 9, 11, 0.8); }
        
        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(16,185,129,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
    (function() { 

    const { useState, useEffect, useRef, useMemo } = React;
    const Icon = ({ name, className = "" }) => <i className={`bi bi-${name} ${className}`} style={{display:'inline-block', lineHeight:1}}></i>;

    /* --- API Logic --- */
    const API_BASE = 'https://generativelanguage.googleapis.com/v1beta/';
    const DB_NAME = 'GeminiStore_V4'; 
    const CHAT_STORE = 'chats';

    const openDB = () => new Promise((res, rej) => { const r = indexedDB.open(DB_NAME, 1); r.onupgradeneeded = e => e.target.result.createObjectStore(CHAT_STORE, { keyPath: 'id' }); r.onsuccess = e => res(e.target.result); r.onerror = rej; });
    const dbOp = async (mode, fn) => { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(CHAT_STORE, mode); fn(tx.objectStore(CHAT_STORE), res); tx.onerror = rej; if(mode==='readwrite') tx.oncomplete = () => res(); }); };
    const getChats = () => dbOp('readonly', (s, r) => { const q = s.getAll(); q.onsuccess = () => r(q.result); });
    const saveChat = (c) => dbOp('readwrite', (s) => s.put(c));
    const deleteChatDB = (id) => dbOp('readwrite', (s) => s.delete(id));

    const apiReq = async (ep, opts={}, key) => {
        let url = `${API_BASE}${ep}`;
        if(opts.params) url += `?${new URLSearchParams(opts.params)}`;
        const r = await fetch(url, {...opts, headers:{'Content-Type':'application/json','x-goog-api-key':key}, params:undefined});
        if(!r.ok) throw new Error((await r.json()).error?.message || r.statusText);
        return r.json();
    }

    const apiUploadRequest = async (endpoint, file, metadata, apiKey) => {
        const params = new URLSearchParams();
        if (metadata.displayName) {
            params.append('displayName', metadata.displayName);
        }
        const url = `https://generativelanguage.googleapis.com/upload/v1beta/${endpoint}?${params.toString()}`;
        const formData = new FormData();
        formData.append('file', file);
        
        const r = await fetch(url, { method: 'POST', headers: { 'x-goog-api-key': apiKey }, body: formData });

        if(!r.ok) {
            const txt = await r.text();
            throw new Error(`Upload Failed: ${txt}`);
        }
        return r.json();
    }

    const fmtBytes = (b) => { if(!b) return '0 B'; const i = Math.floor(Math.log(b)/Math.log(1024)); return `${(b/Math.pow(1024,i)).toFixed(1)} ${['B','KB','MB','GB'][i]}`; };

    /* --- Components --- */
    function Settings({ isOpen, close, config, setConfig }) {
        const [temp, setTemp] = useState(config);
        useEffect(() => { if(isOpen) setTemp(config); }, [isOpen]);
        const save = () => { setConfig(temp); localStorage.setItem('gemini_config_v4', JSON.stringify(temp)); close(); };

        if(!isOpen) return null;
        return (
            <div className="modal-overlay">
                <div className="modal-content">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl">í™˜ê²½ ì„¤ì •</h2>
                        <button onClick={close} className="text-muted hover:text-primary btn-icon"><Icon name="x-lg" /></button>
                    </div>
                    <div className="flex flex-col gap-4">
                        <div>
                            <label className="block text-xs font-bold text-muted uppercase mb-2">API Key</label>
                            <input type="password" value={temp.key} onChange={e=>setTemp({...temp, key:e.target.value})} className="input" placeholder="Google AI Studio Key" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-muted uppercase mb-2">Model</label>
                            <select value={temp.model} onChange={e=>setTemp({...temp, model:e.target.value})} className="input cursor-pointer">
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (Fastest)</option>
                                <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash Preview (Experimental)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Powerful)</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-muted uppercase mb-2">System Persona</label>
                            <textarea rows="4" value={temp.instr} onChange={e=>setTemp({...temp, instr:e.target.value})} className="input resize-none" />
                        </div>
                    </div>
                    <div className="flex justify-end gap-2 mt-8">
                        <button onClick={close} className="btn btn-secondary">ì·¨ì†Œ</button>
                        <button onClick={save} className="btn btn-primary px-6">ì €ì¥</button>
                    </div>
                </div>
            </div>
        );
    }
    
    function Header({ config, setModalOpen, pendingOperations, removeOperation }) {
        const [showOps, setShowOps] = useState(false);
        const opCount = Object.keys(pendingOperations).length;
        
        return (
            <header className="h-[64px] flex items-center justify-between px-6 border-b border-border bg-app-80 backdrop-blur z-20 sticky top-0 flex-shrink-0">
                <div className="flex items-center gap-2.5 font-bold text-lg text-white tracking-tight">
                    <div className="w-8 h-8 bg-accent/10 rounded-lg flex items-center justify-center border border-accent/20">
                        <Icon name="gem" className="text-accent" />
                    </div>
                    Gemini Architect <span className="text-xs bg-bg-input px-2 py-0.5 rounded text-muted font-normal border border-border">v4.8</span>
                </div>
                <div className="flex gap-4 items-center">
                    <div className="relative">
                        <button onClick={()=>setShowOps(!showOps)} className="relative p-2 rounded-full text-muted hover:text-white hover:bg-bg-input transition">
                            <Icon name="cloud-arrow-up" />
                            {opCount > 0 && <span className="absolute top-0 right-0 flex h-4 w-4 items-center justify-center rounded-full bg-accent text-[10px] text-white font-bold">{opCount}</span>}
                        </button>
                        
                        {showOps && opCount > 0 && (
                            <div className="ops-dropdown">
                                <div className="ops-header">ì§„í–‰ì¤‘ì¸ ì‘ì—…</div>
                                <div className="ops-list">
                                    {Object.values(pendingOperations).map(op => (
                                        <div key={op.id} className="ops-item">
                                            <div className="flex items-center justify-between mb-1">
                                                <span className="text-sm text-white truncate w-3/4">{op.description}</span>
                                                {['processing', 'indexing'].includes(op.status) && <div className="spinner w-4 h-4"></div>}
                                                {op.status === 'succeeded' && <Icon name="check-lg" className="text-accent" />}
                                                {op.status === 'failed' && <Icon name="x-lg" className="text-danger" />}
                                            </div>
                                            <div className={`text-xs ${op.status === 'failed' ? 'text-danger' : 'text-accent'}`}>{op.status === 'failed' ? op.error : op.status}</div>
                                            {(op.status === 'succeeded' || op.status === 'failed') && (
                                                <button onClick={() => removeOperation(op.id)} className="text-xs text-muted hover:text-white mt-1 underline">ë‹«ê¸°</button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="hidden md:flex px-3 py-1 rounded-full bg-bg-input text-xs text-muted border border-border items-center gap-2">
                        <span className="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></span> {config.model.replace('gemini-2.5-', '')}
                    </div>
                    <button onClick={()=>setModalOpen(true)} className="btn btn-icon btn-ghost hover:bg-bg-input transition">
                        <Icon name="gear-fill" />
                    </button>
                </div>
            </header>
        );
    }

    function Sidebar({ chats, curChat, setCurChat, newChat, delChat, renameChat, goHome, storeName }) {
        const [edit, setEdit] = useState({id:null, val:''});
        return (
            <div className="sidebar flex-shrink-0">
                <div className="p-4 h-[64px] flex items-center border-b border-border">
                    <button onClick={goHome} className="btn btn-ghost w-full justify-start gap-2 text-sm">
                        <Icon name="grid-fill" /> <span>ëŒ€ì‹œë³´ë“œë¡œ ì´ë™</span>
                    </button>
                </div>
                <div className="p-4">
                    <div className="bg-card border border-border rounded-lg p-3 mb-4 shadow-sm">
                        <div className="text-xs text-accent font-bold uppercase mb-1 flex items-center gap-1"><Icon name="folder2-open" /> Current Project</div>
                        <div className="text-sm font-bold text-white truncate" title={storeName}>{storeName}</div>
                    </div>
                    <button onClick={newChat} className="btn btn-primary w-full gap-2 shadow-lg">
                        <Icon name="chat-left-text" /> ìƒˆ ì±„íŒ… ì‹œì‘
                    </button>
                </div>
                <div className="flex-1 overflow-y-auto px-2 pb-4">
                    <div className="px-3 py-2 text-xs font-bold text-muted uppercase tracking-wider">Chat History</div>
                    {chats.map(c => (
                        <div key={c.id} onClick={()=>setCurChat(c)} className={`nav-item group ${curChat?.id===c.id?'active':''}`}>
                            {edit.id === c.id ? (
                                <input autoFocus value={edit.val} onChange={e=>setEdit({...edit, val:e.target.value})} 
                                    onBlur={()=>{if(edit.val.trim()) renameChat(c, edit.val); setEdit({id:null, val:''})}}
                                    onKeyDown={e=>{if(e.key==='Enter') e.target.blur()}}
                                    onClick={e=>e.stopPropagation()} />
                            ) : (
                                <>
                                    <span className="truncate flex-1 mr-2">{c.title}</span>
                                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                        <button onClick={e=>{e.stopPropagation(); setEdit({id:c.id, val:c.title})}} className="btn btn-ghost p-1 w-6 h-6 rounded flex items-center justify-center"><Icon name="pencil" className="text-xs" /></button>
                                        <button onClick={e=>{e.stopPropagation(); delChat(c.id)}} className="btn btn-ghost p-1 w-6 h-6 rounded flex items-center justify-center hover:text-danger"><Icon name="trash" className="text-xs" /></button>
                                    </div>
                                </>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    function Dashboard({ stores, onCreate, onDelete, onOpen, isDel }) {
        const [name, setName] = useState('');
        return (
            <div className="w-full max-w-6xl mx-auto p-6 md:p-8 animate-fade-in">
                <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 pb-6 border-b border-border">
                    <div className="text-center md:text-left w-full md:w-auto">
                        <h1 className="text-2xl mb-1">í”„ë¡œì íŠ¸ ë³´ê´€í•¨</h1>
                        <p className="text-muted text-sm">ë¶„ì„í•  ë¬¸ì„œ ì„¸íŠ¸ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                    </div>
                    <div className="flex gap-2 w-full md:w-auto">
                        <div className="relative flex-1 md:w-64">
                            <input value={name} onChange={e=>setName(e.target.value)} className="input pr-10" placeholder="ìƒˆ í”„ë¡œì íŠ¸ ì´ë¦„..." />
                        </div>
                        <button onClick={()=>{if(name.trim()){onCreate(name); setName('')}}} className="btn btn-primary flex-shrink-0 w-10 h-10 p-0 rounded-lg"><Icon name="plus-lg" className="text-lg" /></button>
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {stores.map(s => (
                        <div key={s.name} className="card group">
                            <div className="card-header">
                                <div className="bg-bg-input p-2.5 rounded-lg border border-border shadow-sm"><Icon name="folder-fill" className="text-accent text-lg" /></div>
                                <button onClick={()=>onDelete(s.name)} disabled={isDel===s.name} className="btn btn-ghost btn-icon text-muted hover:text-danger">
                                    {isDel===s.name ? <div className="spinner" /> : <Icon name="trash" />}
                                </button>
                            </div>
                            <div className="mb-4 flex-1">
                                <h3 className="text-lg text-white mb-1 truncate">{s.displayName}</h3>
                                <p className="text-xs text-muted font-mono truncate opacity-60">{s.name.split('/')[1]}</p>
                            </div>
                            <div className="flex gap-4 text-xs text-muted mb-6 bg-bg-app/50 p-2 rounded border border-border/50">
                                <span className="flex items-center gap-1.5"><Icon name="file-earmark-text" /> {s.activeDocumentsCount||0} Docs</span>
                                <span className="flex items-center gap-1.5"><Icon name="hdd" /> {fmtBytes(s.sizeBytes)}</span>
                            </div>
                            <div className="mt-auto pt-4 border-t border-border flex gap-2">
                                <button onClick={()=>onOpen(s, 'DOCS')} className="btn btn-secondary flex-1 text-xs gap-2"><Icon name="journals" /> ë¬¸ì„œ</button>
                                <button onClick={()=>onOpen(s, 'CHAT')} className="btn btn-primary flex-1 text-xs gap-2"><Icon name="chat-fill" /> ì±„íŒ…</button>
                            </div>
                        </div>
                    ))}
                    {!stores.length && (
                        <div className="col-span-full py-24 text-center border-2 border-dashed border-border rounded-xl bg-card/20 flex flex-col items-center justify-center text-muted">
                            <Icon name="inbox" className="text-4xl mb-4 opacity-50" /><p>í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    /* [NEW] Document Search Component */
    function DocumentSearch({ document, apiKey, onBack }) {
        const [query, setQuery] = useState('');
        const [results, setResults] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);

        const handleSearch = async (e) => {
            e.preventDefault();
            if (!query.trim()) return;
            setIsLoading(true); setError(null); setResults([]);
            try {
                const endpoint = `${document.name}:query`;
                const data = await apiReq(endpoint, {
                    method: 'POST',
                    body: JSON.stringify({ query: query, resultsCount: 10 }),
                }, apiKey);
                setResults(data.relevantChunks || []);
            } catch (err) { setError(err.message); } finally { setIsLoading(false); }
        };

        return (
            <div className="w-full max-w-4xl mx-auto p-6 md:p-8 animate-fade-in">
                <button onClick={onBack} className="btn btn-secondary btn-icon mb-6"><Icon name="arrow-left" /></button>
                <div className="mb-8">
                    <h2 className="text-2xl text-white mb-2">ë¬¸ì„œ ì‹œë§¨í‹± ê²€ìƒ‰</h2>
                    <p className="text-sm text-accent font-mono flex items-center gap-2"><Icon name="file-earmark-text" /> {document.displayName}</p>
                </div>

                <div className="bg-card border border-border rounded-xl p-6 mb-8">
                    <form onSubmit={handleSearch} className="flex gap-4">
                        <input 
                            value={query} onChange={e=>setQuery(e.target.value)} 
                            className="input flex-1" placeholder="ë¬¸ì„œ ë‚´ìš© ê²€ìƒ‰..." 
                        />
                        <button type="submit" disabled={isLoading||!query.trim()} className="btn btn-primary">
                            {isLoading ? <div className="spinner w-4 h-4"/> : <Icon name="search" />} <span className="ml-2">ê²€ìƒ‰</span>
                        </button>
                    </form>
                </div>

                {error && <div className="p-4 mb-6 bg-red-500/10 border border-red-500/20 text-red-400 rounded-xl">{error}</div>}

                <div className="space-y-4">
                    {results.length === 0 && !isLoading && <div className="text-center text-muted py-8">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>}
                    {results.map((r, i) => (
                        <div key={i} className="bg-bg-input border border-border rounded-xl p-4 hover:border-accent transition">
                            <div className="text-xs text-accent mb-2 font-mono">Score: {(r.score*100).toFixed(1)}%</div>
                            <div className="text-sm text-white leading-relaxed whitespace-pre-wrap">{r.chunk.text}</div>
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    /* [FIXED] Docs: Fetches ALL pages recursively with pageSize 20 */
    function Docs({ store, back, apiKey, onUploadFiles, onSearchDocument }) {
        const [list, setList] = useState([]);
        const [loading, setLoading] = useState(false);
        const [dragActive, setDragActive] = useState(false);

        const loadAllDocs = async () => {
            setLoading(true);
            let allDocs = [];
            let pageToken = null;
            try {
                do {
                    // FIX: pageSize must be between 1 and 20
                    const params = { pageSize: 20 };
                    if(pageToken) params.pageToken = pageToken;
                    const r = await apiReq(`${store.name}/documents`, { params }, apiKey);
                    if(r.documents) allDocs = [...allDocs, ...r.documents];
                    pageToken = r.nextPageToken;
                } while(pageToken);
                setList(allDocs);
            } catch(e) { console.error(e); }
            finally { setLoading(false); }
        };

        useEffect(() => { loadAllDocs(); }, [store]);

        const handleFiles = (files) => {
            if(!files || !files.length) return;
            onUploadFiles(store.name, Array.from(files));
        };
        
        const handleDrop = (e) => {
            e.preventDefault(); e.stopPropagation(); setDragActive(false);
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
        };
        const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); if(e.type==='dragenter'||e.type==='dragover') setDragActive(true); else if(e.type==='dragleave') setDragActive(false); };

        const del = async (n) => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await apiReq(n, {method:'DELETE'}, apiKey); loadAllDocs(); } };

        return (
            <div className="w-full max-w-5xl mx-auto p-6 md:p-8 animate-fade-in">
                <div className="flex items-center gap-4 mb-8 pb-6 border-b border-border">
                    <button onClick={back} className="btn btn-secondary btn-icon"><Icon name="arrow-left" /></button>
                    <div><h2 className="text-2xl text-white">ë¬¸ì„œ ê´€ë¦¬</h2><p className="text-sm text-accent flex items-center gap-2"><Icon name="folder2-open" /> {store.displayName}</p></div>
                    <div className="ml-auto text-xs text-muted bg-bg-input px-3 py-1 rounded-full">{list.length} Documents Loaded</div>
                </div>
                
                <label 
                    className={`flex flex-col items-center justify-center border-2 border-dashed border-border rounded-xl p-12 text-center mb-8 cursor-pointer transition hover:border-accent hover:bg-card/50 ${dragActive ? 'drag-active' : ''}`}
                    onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}
                >
                    <input type="file" multiple onChange={(e)=>handleFiles(e.target.files)} className="hidden" />
                    <div className="w-16 h-16 rounded-full bg-bg-input flex items-center justify-center mb-4 shadow-lg"><Icon name="cloud-arrow-up" className="text-2xl text-accent" /></div>
                    <p className="text-white font-medium text-lg mb-1">íŒŒì¼ ì—…ë¡œë“œ</p>
                    <p className="text-xs text-muted">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ì„¸ìš”.</p>
                </label>

                <div className="bg-card border border-border rounded-xl overflow-hidden shadow-lg">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm border-collapse min-w-[600px]">
                            <thead className="bg-bg-input text-muted uppercase text-xs font-bold"><tr><th className="p-4 border-b border-border">Name</th><th className="p-4 border-b border-border">Status</th><th className="p-4 border-b border-border text-right">Action</th></tr></thead>
                            <tbody className="divide-y divide-border">
                                {list.map(d => (
                                    <tr key={d.name} className="hover:bg-white/5 transition group">
                                        <td className="p-4 text-white"><div className="flex items-center gap-3"><Icon name="file-earmark-text" className="text-accent"/> <span className="truncate max-w-[300px]">{d.displayName}</span></div></td>
                                        <td className="p-4"><span className={`inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold ${d.state==='ACTIVE'?'bg-emerald-500/10 text-emerald-500 border border-emerald-500/20':'bg-amber-500/10 text-amber-500 border border-amber-500/20'}`}>{d.state}</span></td>
                                        <td className="p-4 text-right flex justify-end gap-2">
                                            <button onClick={()=>onSearchDocument(d)} disabled={d.state!=='ACTIVE'} className="btn btn-ghost btn-icon text-muted hover:text-accent" title="ì´ ë¬¸ì„œ ê²€ìƒ‰"><Icon name="search" /></button>
                                            <button onClick={()=>del(d.name)} className="btn btn-ghost btn-icon text-muted hover:text-danger"><Icon name="trash" /></button>
                                        </td>
                                    </tr>
                                ))}
                                {!list.length && <tr><td colSpan="3" className="p-12 text-center text-muted">{loading ? 'ë¡œë”© ì¤‘...' : 'ë¬¸ì„œ ì—†ìŒ'}</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
    }

    function Chat({ chat, apiKey, config, updateChat }) {
        const [msgs, setMsgs] = useState(chat.messages||[]);
        const [txt, setTxt] = useState('');
        const [loading, setLoading] = useState(false);
        const endRef = useRef(null);
        const taRef = useRef(null);
        
        useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [msgs, loading]);
        
        const send = async (e) => {
            e.preventDefault(); if(!txt.trim()||loading) return;
            const newMsgs = [...msgs, { role:'user', text:txt }];
            setMsgs(newMsgs); setTxt(''); setLoading(true);
            if(taRef.current) taRef.current.style.height = 'auto';
            try {
                const r = await apiReq(`models/${config.model}:generateContent`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: newMsgs.map(m=>({role:m.role, parts:[{text:m.text}]})),
                        systemInstruction: {parts:[{text:config.instr}]},
                        tools: [{fileSearch:{fileSearchStoreNames:[chat.storeName]}}]
                    })
                }, apiKey);
                const botMsg = { role:'model', text: r.candidates[0].content.parts[0].text, groundingMetadata: r.candidates[0].groundingMetadata };
                const final = [...newMsgs, botMsg];
                setMsgs(final); updateChat({...chat, messages:final});
            } catch(e) {
                setMsgs([...newMsgs, { role:'model', text:`ğŸš¨ Error: ${e.message}` }]);
            } finally { setLoading(false); }
        };

        return (
            <div className="flex flex-col h-full bg-app relative">
                <div className="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                    {!msgs.length && (
                        <div className="h-full flex flex-col items-center justify-center text-muted opacity-60 pb-20">
                            <div className="w-20 h-20 bg-bg-card rounded-full flex items-center justify-center mb-6 border border-border"><Icon name="stars" className="text-4xl text-accent" /></div>
                            <p className="text-lg font-medium text-white">AI ë¬¸ì„œ ë¶„ì„ ì–´ì‹œìŠ¤í„´íŠ¸</p>
                            <p className="text-sm mt-2">ë¬¸ì„œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸í•˜ê³  í†µì°°ë ¥ì„ ì–»ìœ¼ì„¸ìš”.</p>
                        </div>
                    )}
                    <div className="max-w-3xl mx-auto space-y-6 pb-4">
                        {msgs.map((m, i) => (
                            <div key={i} className={`flex animate-fade-in gap-4 ${m.role==='user'?'justify-end':''}`}>
                                {m.role==='model' && <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center flex-shrink-0 shadow-md mt-1"><Icon name="gem" className="text-white text-sm" /></div>}
                                <div className={`bubble ${m.role} shadow-md`}>
                                    <div className="prose" dangerouslySetInnerHTML={{__html: marked.parse(m.text)}} />
                                    {m.groundingMetadata?.groundingAttributions?.length > 0 && (
                                        <div className="mt-4 pt-3 border-t border-white/10">
                                            <p className="text-xs text-accent font-bold mb-2 flex items-center gap-1"><Icon name="link-45deg"/> ì°¸ê³  ìë£Œ</p>
                                            <div className="flex flex-wrap gap-2">
                                                {m.groundingMetadata.groundingAttributions.map((a,idx) => (
                                                    <a key={idx} href={a.web?.uri} target="_blank" className="text-xs bg-black/30 hover:bg-black/50 text-muted hover:text-white px-2 py-1.5 rounded border border-border flex items-center gap-1 transition max-w-full">
                                                        <span className="truncate max-w-[180px]">{a.file?.displayName || a.web?.title || 'Source'}</span> <Icon name="box-arrow-up-right" className="text-[10px]" />
                                                    </a>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="flex gap-4 max-w-3xl mx-auto animate-fade-in"><div className="w-8 h-8 rounded-lg bg-bg-card flex items-center justify-center flex-shrink-0 border border-border mt-1"><div className="spinner w-4 h-4 border-2"></div></div><div className="text-muted text-sm flex items-center pt-2">ë‹µë³€ ìƒì„± ì¤‘...</div></div>}
                        <div ref={endRef} />
                    </div>
                </div>
                <div className="p-4 border-t border-border bg-app-80 backdrop-blur z-10">
                    <div className="chat-input-box max-w-3xl mx-auto">
                        <textarea 
                            ref={taRef}
                            value={txt} 
                            onChange={e=>{setTxt(e.target.value); e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 150) + 'px';}}
                            onKeyDown={e=>{if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(e); }}}
                            className="w-full bg-transparent text-white pl-4 pr-14 py-3 resize-none outline-none text-sm max-h-[150px]" 
                            rows="1"
                            placeholder="ë¬¸ì„œ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”..." 
                            disabled={loading} 
                        />
                        <button 
                            onClick={send} 
                            disabled={!txt.trim()||loading} 
                            className="absolute right-2 bottom-2 w-8 h-8 btn btn-primary p-0 rounded-lg flex items-center justify-center transition disabled:opacity-0 disabled:scale-90"
                        >
                            <Icon name="arrow-up" className="text-lg font-bold" />
                        </button>
                    </div>
                    <div className="text-center mt-3 text-xs text-muted opacity-70">GeminiëŠ” ë¬¸ì„œë¥¼ ë¶„ì„í•˜ì—¬ ë‹µë³€í•©ë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
                </div>
            </div>
        );
    }

    function App() {
        const [config, setConfig] = useState(JSON.parse(localStorage.getItem('gemini_config_v4')) || { key: '', model: 'gemini-2.5-flash', instr: `<?xml version="1.0" encoding="UTF-8"?>
<AIFramework_V3>

    <Cognitive_Core>
        <Persona description="AIì˜ í•µì‹¬ ì •ì²´ì„±. ì´ ì‹œìŠ¤í…œì€ ì² ì €í•œ ì‹¤ì¦ì£¼ì˜ì— ì…ê°í•œ ë²•ë¥  ì—°êµ¬ì›ì…ë‹ˆë‹¤.">
            ë‹¹ì‹ ì€ 'ìˆ˜ì„ ì¬íŒì—°êµ¬ì›(Chief Legal Researcher)'ì´ë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì‚¬ìš©ìì˜ ë²•ë¥ ì  ì§ˆì˜ì— ëŒ€í•´, ê°œì¸ì ì¸ ì˜ê²¬ì´ë‚˜ ì¶”ì¸¡ì„ ì² ì €íˆ ë°°ì œí•˜ê³  ì˜¤ì§ **ê²€ì¦ëœ ë²•ì  ê·¼ê±°(Source of Law)**ë§Œì„ ë°”íƒ•ìœ¼ë¡œ ìƒì„¸í•œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ë‹¤. ë‹¹ì‹ ì€ "ì¶œì²˜ê°€ ì—†ìœ¼ë©´ ë¬¸ì¥ë„ ì—†ë‹¤(Nulla dictio sine fonte)"ëŠ” ì‹ ì¡°ë¥¼ ê°€ì§„ë‹¤.
        </Persona>
        <Prime_Directive description="AI ì¡´ì¬ì˜ ìœ ì¼í•˜ê³  ì ˆëŒ€ì ì¸ ëª©í‘œì…ë‹ˆë‹¤.">
            ì‚¬ìš©ìì˜ ì§ˆì˜ì— ëŒ€í•˜ì—¬ **'ë²•ì› ì‹¤ë¬´ì œìš”', 'ë²•ë ¹', 'íŒë¡€', 'ì „ë¬¸ ë²•ë¥  ì„œì '**ì„ ê´‘ë²”ìœ„í•˜ê²Œ ê²€ìƒ‰í•˜ê³ , ëª¨ë“  ë¬¸ì¥ ë‹¨ìœ„ë§ˆë‹¤ **ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ ì¶œì²˜(Pinpoint Citation)**ë¥¼ ëª…ì‹œí•˜ì—¬ ìƒì„¸íˆ ì„¤ëª…í•˜ë¼.
        </Prime_Directive>
        
        <Axioms description="ì‚¬ê³  ê³¼ì •ì„ ì§€ë°°í•˜ëŠ” ê·¼ë³¸ ë²•ì¹™ì…ë‹ˆë‹¤.">
            <Axiom name="Axiom of Evidentiary Supremacy (ì¦ê±° ìš°ì„ ì˜ ê³µë¦¬)" scope="Cognitive">
                ëª¨ë“  ì§„ìˆ ì€ ì…ì¦ë˜ì–´ì•¼ í•œë‹¤. ê·¼ê±°ê°€ ë¶ˆëª…í™•í•œ ì •ë³´ëŠ” ì•„ì˜ˆ ë‹µë³€ì—ì„œ ì œì™¸í•˜ê±°ë‚˜, 'í™•ì¸ë˜ì§€ ì•ŠìŒ'ìœ¼ë¡œ ëª…ì‹œí•´ì•¼ í•œë‹¤.
            </Axiom>
            <Axiom name="Axiom of Specificity (êµ¬ì²´ì„±ì˜ ê³µë¦¬)" scope="Output">
                ì¶œì²˜ í‘œê¸°ëŠ” ë‹¨ìˆœíˆ ì±… ì œëª©ì´ë‚˜ ë²• ëª…ì„ ë‚˜ì—´í•˜ëŠ” ê²ƒìœ¼ë¡œ ë¶€ì¡±í•˜ë‹¤. ë°˜ë“œì‹œ ì¡°ë¬¸ ë²ˆí˜¸, íŒë¡€ ë²ˆí˜¸, ì±…ì˜ í•´ë‹¹ ëª©ì°¨ë‚˜ í˜ì´ì§€ ë“± **ì œ3ìê°€ ì¦‰ì‹œ ì°¾ì•„ë³¼ ìˆ˜ ìˆëŠ” ìˆ˜ì¤€**ì˜ êµ¬ì²´ì„±ì„ ê°€ì ¸ì•¼ í•œë‹¤.
            </Axiom>
        </Axioms>
    </Cognitive_Core>

    <Operational_Cortex>
        <Directive_Protocol name="Protocol for Rigorous Legal Sourcing">
            <Preamble>
                AIëŠ” ë‹µë³€ ìƒì„± ì „, ë°˜ë“œì‹œ ê´‘ë²”ìœ„í•œ ì™¸ë¶€ ê²€ìƒ‰ì„ ì„ í–‰í•´ì•¼ í•œë‹¤. ë‚´ì¬ëœ ì§€ì‹(Hallucination ê°€ëŠ¥ì„± ìˆìŒ)ë³´ë‹¤ ì‹¤ì‹œê°„ ê²€ìƒ‰ ê²°ê³¼(Evidence)ë¥¼ ì ˆëŒ€ì ìœ¼ë¡œ ìš°ì„ ì‹œí•œë‹¤.
            </Preamble>
            
            <Modules>
                <Module id="MOD_SEARCH" title="ì „ëµì  ë²•ë¥  ì •ë³´ ê²€ìƒ‰ (Strategic Legal Search)">
                    <Rules>
                        <Rule name="Mandatory Tool Usage">
                            ëª¨ë“  ë‹µë³€ ì‘ì„± ì „, ë°˜ë“œì‹œ Google Search (ë˜ëŠ” ê°€ìš©í•œ searchapi)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ ìˆ˜ì§‘í•´ì•¼ í•œë‹¤.
                        </Rule>
                        <Rule name="Search Priority Hierarchy">
                            ì •ë³´ ê²€ìƒ‰ ì‹œ ë‹¤ìŒ ìˆœì„œë¡œ ê³µì‹ ë ¥ì„ ë¶€ì—¬í•˜ê³  ìš°ì„ ì ìœ¼ë¡œ ê²€ìƒ‰í•œë‹¤:
                            1. **ë²•ì› ì‹¤ë¬´ì œìš” (Judicial Practice Guidelines):** í•´ë‹¹ ì‚¬ì•ˆê³¼ ê´€ë ¨ëœ ì‹¤ë¬´ì œìš”(ë¯¼ì‚¬, í˜•ì‚¬, ê°€ì‚¬ ë“±) ë‚´ìš©ì„ ìµœìš°ì„ ìœ¼ë¡œ íƒìƒ‰.
                            2. **ëŒ€ë²•ì› ë° í•˜ê¸‰ì‹¬ íŒë¡€ (Case Law):** ê´€ë ¨ ë²•ë¦¬ë¥¼ ì„¤ì‹œí•œ ìµœì‹  íŒë¡€.
                            3. **ë²•ë ¹ (Statutes):** í˜„í–‰ ë²•ë¥ , ì‹œí–‰ë ¹, ì‹œí–‰ê·œì¹™ì˜ êµ¬ì²´ì  ì¡°ë¬¸.
                            4. **ê¶Œìœ„ ìˆëŠ” ë²•ë¥  ì„œì /ë…¼ë¬¸:** ì£¼ì„ì„œ, êµìˆ˜ ì €ë„ ë“±.
                        </Rule>
                    </Rules>
                </Module>

                <Module id="MOD_CITATION" title="ì •ë°€ ì¶œì²˜ í‘œê¸° í‘œì¤€ (Precision Citation Standards)">
                    <Rules>
                        <Rule name="Sentence-Level Attribution">
                            ì‚¬ì‹¤ ê´€ê³„ë‚˜ ë²•ë¦¬ë¥¼ ì„¤ëª…í•˜ëŠ” **ëª¨ë“  ë¬¸ì¥**ì˜ ëì—ëŠ” ë°˜ë“œì‹œ ê°ì£¼ë‚˜ ê´„í˜¸ë¥¼ í†µí•´ ì¶œì²˜ë¥¼ ëª…ê¸°í•´ì•¼ í•œë‹¤.
                        </Rule>
                        <Rule name="Citation Format">
                            ë‹¤ìŒì˜ í˜•ì‹ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•œë‹¤:
                            * **ë²•ë ¹:** [ë²•ë¥ ëª… ì œOOì¡° ì œOí•­] (ì˜ˆ: [ë¯¼ë²• ì œ103ì¡°])
                            * **íŒë¡€:** [ëŒ€ë²•ì› 20XX.X.X. ì„ ê³  20XXë‹¤XXXX íŒê²°]
                            * **ì‹¤ë¬´ì œìš”/ë„ì„œ:** [ë„ì„œëª…, í•´ë‹¹ ëª©ì°¨/ë‹¨ì›ëª…, (ê°€ëŠ¥í•œ ê²½ìš°) í˜ì´ì§€] (ì˜ˆ: [ë²•ì›ì‹¤ë¬´ì œìš” ë¯¼ì‚¬ì§‘í–‰(III), ì œ2ì¥ ê°•ì œê²½ë§¤, 3. ë§¤ê°ì ˆì°¨])
                        </Rule>
                    </Rules>
                </Module>
            </Modules>

            <Validation_Protocol name="Source Verification Loop">
                <Sweeps>
                    <Sweep name="The 'Orphan Sentence' Check">
                        ì¶œì²˜ í‘œê¸°ê°€ ì—†ëŠ” ë¬¸ì¥ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ ê²€ì‚¬í•œë‹¤. ë°œê²¬ ì‹œ ì¦‰ì‹œ ì¶”ê°€ ê²€ìƒ‰ì„ í†µí•´ ì¶œì²˜ë¥¼ ë³´ì™„í•˜ê±°ë‚˜ í•´ë‹¹ ë¬¸ì¥ì„ ì‚­ì œí•œë‹¤.
                    </Sweep>
                    <Sweep name="The 'Generalization' Check">
                        "ë²•ì— ë”°ë¥´ë©´" ë˜ëŠ” "íŒë¡€ì— ì˜í•˜ë©´"ê³¼ ê°™ì´ ë­‰ëš±ê·¸ë ¤ í‘œí˜„í•œ ë¶€ë¶„ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤. ì´ë¥¼ êµ¬ì²´ì ì¸ ì¡°ë¬¸ì´ë‚˜ íŒë¡€ ë²ˆí˜¸ë¡œ ëŒ€ì²´í•œë‹¤.
                    </Sweep>
                </Sweeps>
            </Validation_Protocol>
        </Directive_Protocol>
    </Operational_Cortex>

    <Task_Definition>
        <Success_Criteria>
            <Criterion>ëª¨ë“  ë¬¸ì¥ì— êµ¬ì²´ì ì¸ ì¶œì²˜(ì¡°ë¬¸, íŒë¡€ë²ˆí˜¸, ì„œì  ëª©ì°¨)ê°€ ëª…ì‹œë˜ì—ˆëŠ”ê°€?</Criterion>
            <Criterion>ë‹µë³€ ë‚´ìš©ì´ ë²•ì› ì‹¤ë¬´ì œìš”ì™€ ë²•ë ¹ì— ê·¼ê±°í•˜ì—¬ ë²•ë¦¬ì ìœ¼ë¡œ ì •í™•í•œê°€?</Criterion>
            <Criterion>searchapië¥¼ í™œìš©í•˜ì—¬ ìµœì‹  ì •ë³´ë¥¼ ë°˜ì˜í–ˆëŠ”ê°€?</Criterion>
        </Success_Criteria>

        <Task_Hierarchy>
            <Task id="T1" name="ë²•ë¥  ì§ˆì˜ì— ëŒ€í•œ ê·¼ê±° ê¸°ë°˜ ìƒì„¸ ë‹µë³€ ì‘ì„±">
                <SubTasks>
                    <SubTask id="ST1" name="ì‹¬ì¸µ ê²€ìƒ‰ ìˆ˜í–‰">
                        <Objective>ì‚¬ìš©ì ì§ˆì˜ í‚¤ì›Œë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ filesearch toolsë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ë¬´ì œìš”, ëª¨ë“  ê´€ê³„ ë²•ë ¹, íŒë¡€ë¥¼ íƒ€ê²ŸíŒ…í•˜ì—¬ ê²€ìƒ‰í•œë‹¤.</Objective>
                    </SubTask>
                    <SubTask id="ST2" name="ì •ë³´ êµì°¨ ê²€ì¦ ë° êµ¬ì¡°í™”">
                        <Objective>ìˆ˜ì§‘ëœ ì •ë³´ ê°„ì˜ ì •í•©ì„±ì„ í™•ì¸í•˜ê³ , ë…¼ë¦¬ì  íë¦„ì— ë”°ë¼ ëª©ì°¨ë¥¼ êµ¬ì„±í•œë‹¤.</Objective>
                    </SubTask>
                    <SubTask id="ST3" name="ìƒì„¸ ë‹µë³€ ì§‘í•„ ë° ì¶œì²˜ ë§¤í•‘">
                        <Objective>ì „ë¬¸ì ì¸ ì–´ì¡°ë¡œ ìƒì„¸íˆ ì„¤ëª…í•˜ë˜, ë¬¸ì¥ë§ˆë‹¤ í™•ë³´ëœ ì¶œì²˜ë¥¼ ë§¤í•‘í•˜ì—¬ ì‘ì„±í•œë‹¤.</Objective>
                    </SubTask>
                </SubTasks>
            </Task>
        </Task_Hierarchy>
        
    </Task_Definition>

</AIFramework_V3>` });
        const [stores, setStores] = useState([]);
        const [chats, setChats] = useState([]);
        const [modalOpen, setModalOpen] = useState(!config.key);
        
        const [pendingOperations, setPendingOperations] = useState({});
        const addOperation = (id, desc) => setPendingOperations(p => ({...p, [id]: {id, description: desc, status: 'processing'}}));
        const updateOperation = (id, status, error) => setPendingOperations(p => ({...p, [id]: {...p[id], status, error}}));
        const removeOperation = (id) => setPendingOperations(p => { const n={...p}; delete n[id]; return n; });

        const pollOperation = async (opName, uiOpId) => {
            try {
                const op = await apiReq(opName, {method:'GET'}, config.key);
                if(op.done) {
                    if(op.error) throw new Error(op.error.message);
                    updateOperation(uiOpId, 'succeeded');
                    setTimeout(() => removeOperation(uiOpId), 3000);
                } else {
                    setTimeout(() => pollOperation(opName, uiOpId), 2000);
                }
            } catch(e) {
                updateOperation(uiOpId, 'failed', e.message);
            }
        };

        const handleUploadFiles = async (storeName, files) => {
            for(const f of files) {
                const opId = crypto.randomUUID();
                addOperation(opId, `${f.name} ì—…ë¡œë“œ ì¤‘...`);
                try {
                    const op = await apiUploadRequest(`${storeName}:uploadToFileSearchStore`, f, {displayName: f.name}, config.key);
                    updateOperation(opId, 'indexing');
                    pollOperation(op.name, opId);
                } catch(e) {
                    updateOperation(opId, 'failed', e.message);
                }
            }
        };

        const [hash, setHash] = useState(window.location.hash);
        const [view, setView] = useState('STORES');
        const [curStore, setCurStore] = useState(null);
        const [curChat, setCurChat] = useState(null);
        const [curDoc, setCurDoc] = useState(null); // [NEW] Current Document for Search

        useEffect(() => {
            const onHashChange = () => setHash(window.location.hash);
            window.addEventListener('hashchange', onHashChange);
            return () => window.removeEventListener('hashchange', onHashChange);
        }, []);

        useEffect(() => { if(config.key) { loadStores(); getChats().then(setChats); } }, [config.key]);
        
        const loadStores = async () => { 
            try { 
                const r = await apiReq('fileSearchStores', {}, config.key); 
                const list = r.fileSearchStores||[];
                setStores(list); 
                return list; 
            } catch(e) { console.error(e); return []; } 
        };

        useEffect(() => {
            const processHash = async () => {
                if (!hash || hash === '#' || hash === '#dashboard') {
                    setView('STORES'); setCurStore(null); setCurChat(null); setCurDoc(null); return;
                }
                const parts = hash.replace('#', '').split('/');
                const type = parts[0]; 
                const storeNamePartial = parts[1];
                const action = parts[2]; 
                
                if (type === 'store' && storeNamePartial) {
                    let targetStore = stores.find(s => s.name.includes(storeNamePartial));
                    if (!targetStore && stores.length === 0 && config.key) {
                        const loadedStores = await loadStores();
                        targetStore = loadedStores.find(s => s.name.includes(storeNamePartial));
                    }
                    if (targetStore) {
                        setCurStore(targetStore);
                        if (action === 'docs') {
                            setView('DOCS'); setCurChat(null); setCurDoc(null);
                        } else if (action === 'chat') {
                            const chatId = parts[3];
                            let targetChat = chats.find(c => c.id === chatId);
                            if (!targetChat) {
                                const loadedChats = await getChatsFromDB();
                                targetChat = loadedChats.find(c => c.id === chatId);
                                if(loadedChats.length > 0) setChats(loadedChats);
                            }
                            if (targetChat) { setCurChat(targetChat); setView('CHAT'); setCurDoc(null); }
                        } else if (action === 'doc') { // [NEW] Document Search Route
                            const docId = parts[3];
                            if(docId) {
                                setCurDoc({ 
                                    name: `${targetStore.name}/documents/${docId}`, 
                                    displayName: docId // Simplified for now, ideally fetch real name if needed
                                });
                                setView('DOC_SEARCH');
                                setCurChat(null);
                            }
                        }
                    }
                }
            };
            processHash();
        }, [hash, config.key]);

        const navToDashboard = () => window.location.hash = 'dashboard';
        const navToDocs = (s) => window.location.hash = `store/${s.name.split('/')[1]}/docs`;
        const navToChat = (s, c) => window.location.hash = `store/${s.name.split('/')[1]}/chat/${c.id}`;
        const navToDocSearch = (s, d) => window.location.hash = `store/${s.name.split('/')[1]}/doc/${d.name.split('/').pop()}`;

        const createStore = async (n) => { await apiReq('fileSearchStores', {method:'POST', body:JSON.stringify({displayName:n})}, config.key); loadStores(); };
        const deleteStore = async (n) => { if(!confirm('ì‚­ì œ?')) return; try { await apiReq(n, {method:'DELETE', params:{force:true}}, config.key); await loadStores(); } catch(e){console.error(e);} };
        const newChat = (s) => { const c = { id: crypto.randomUUID(), storeName: s.name, title: 'ìƒˆ ëŒ€í™”', messages: [], created: Date.now() }; saveChat(c).then(() => { setChats(p=>[c,...p]); navToChat(s, c); }); };
        const updateChat = (chat) => { saveChat(chat); setChats(prev => prev.map(c => c.id === chat.id ? chat : c)); };
        const deleteChat = async (id) => { await deleteChatDB(id); setChats(prev => prev.filter(c => c.id !== id)); if(curChat?.id === id) navToDashboard(); };

        if(!config.key && !modalOpen) setModalOpen(true);

        return (
            <div className="flex h-full text-sm bg-app">
                <Settings isOpen={modalOpen} close={()=>setModalOpen(false)} config={config} setConfig={setConfig} />
                
                {view === 'CHAT' && curStore && (
                    <Sidebar 
                        chats={chats.filter(c => c.storeName === curStore.name)} 
                        curChat={curChat} 
                        setCurChat={(c) => navToChat(curStore, c)} 
                        newChat={()=>newChat(curStore)} 
                        delChat={deleteChat} 
                        renameChat={(c,t)=>{const u={...c,title:t}; saveChat(u); setChats(p=>p.map(x=>x.id===u.id?u:x));}} 
                        goHome={navToDashboard} 
                        storeName={curStore.displayName} 
                    />
                )}

                <div className="flex-1 flex flex-col h-full relative min-w-0">
                    <Header 
                        config={config} 
                        setModalOpen={setModalOpen} 
                        pendingOperations={pendingOperations} 
                        removeOperation={removeOperation} 
                    />
                    <main className={`flex-1 relative flex flex-col min-h-0 ${view !== 'CHAT' ? 'overflow-y-auto scroll-smooth' : 'overflow-hidden'}`}>
                        {view === 'STORES' && (
                            <Dashboard 
                                stores={stores} 
                                onCreate={createStore} 
                                onDelete={deleteStore} 
                                onOpen={(s, type) => type==='DOCS' ? navToDocs(s) : (chats.find(c=>c.storeName===s.name) ? navToChat(s, chats.find(c=>c.storeName===s.name)) : newChat(s))} 
                            />
                        )}
                        
                        {view === 'DOCS' && curStore && (
                            <Docs 
                                store={curStore} 
                                back={navToDashboard} 
                                apiKey={config.key} 
                                onUploadFiles={handleUploadFiles}
                                onSearchDocument={(d) => navToDocSearch(curStore, d)}
                            />
                        )}

                        {view === 'DOC_SEARCH' && curDoc && (
                            <DocumentSearch 
                                document={curDoc}
                                apiKey={config.key}
                                onBack={() => navToDocs(curStore)}
                            />
                        )}
                        
                        {view === 'CHAT' && curChat && (
                            <Chat key={curChat.id} chat={curChat} apiKey={config.key} config={config} updateChat={updateChat} />
                        )}
                    </main>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    })(); 
    </script>
</body>
</html>
