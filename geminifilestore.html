<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Architect KN 1.0.9</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-app: #ffffff;
            --text-primary: #262626;
            --text-secondary: #737373;
            --border: #dbdbdb;
            --accent: #0095f6; /* Insta Blue */
            --danger: #ed4956;
            --bg-msg-me: #3797f0;
            --bg-msg-other: #efefef;
        }

        body {
            background-color: #fafafa;
            color: var(--text-primary);
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .prose p { margin-bottom: 0.5rem; line-height: 1.5; }
        .prose code { background: rgba(0,0,0,0.05); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; color: #d63384; }
        .prose pre { background: #262626; color: white; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(0,0,0,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen flex flex-col md:flex-row"></div>

    <script type="text/babel">
    
    /* --- UTILS --- */
    const copyToClipboard = (text) => {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {}, () => fallbackCopy(text));
        } else { fallbackCopy(text); }
    };
    const fallbackCopy = (text) => {
        const ta = document.createElement("textarea");
        ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.focus(); ta.select();
        try { document.execCommand('copy'); } catch (err) { console.error('Copy failed', err); }
        document.body.removeChild(ta);
    };
    
    // "Instagram-like" Metric Formatters
    const fmtCount = (n) => {
        if (!n) return '0';
        if (n >= 1000000) return (n/1000000).toFixed(1) + 'm';
        if (n >= 1000) return (n/1000).toFixed(1) + 'k';
        return n.toString();
    };
    const fmtSize = (bytes) => {
        if (!+bytes) return '0b';
        const k = 1024;
        const sizes = ['b', 'kb', 'mb', 'gb', 'tb'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))}${sizes[i]}`;
    };

    /* --- SERVICES --- */
    class GeminiService {
        constructor(apiKey) { this.apiKey = apiKey; this.baseUrl = 'https://generativelanguage.googleapis.com/v1beta/'; }
        async request(ep, opts={}) {
            let url = `${this.baseUrl}${ep}`;
            const cfg = { ...opts, headers: { 'Content-Type': 'application/json', 'x-goog-api-key': this.apiKey, ...opts.headers } };
            if (opts.params) {
                const p = new URLSearchParams();
                Object.entries(opts.params).forEach(([k,v]) => { if (v!=null) p.append(k,v); });
                const qs = p.toString(); if (qs) url += `?${qs}`; delete cfg.params;
            }
            const res = await fetch(url, cfg);
            if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || res.statusText); }
            return res.json();
        }
        async generateContent(model, msgs, instr, store) {
            const payload = {
                contents: msgs.map(m => ({ role: m.role, parts: [{ text: m.text }] })),
                systemInstruction: { parts: [{ text: instr }] },
                tools: store ? [{ fileSearch: { fileSearchStoreNames: [store] } }] : []
            };
            return this.request(`models/${model}:generateContent`, { method: 'POST', body: JSON.stringify(payload) });
        }
        async listStores() { return (await this.request('fileSearchStores')).fileSearchStores || []; }
        async createStore(n) { return this.request('fileSearchStores', { method: 'POST', body: JSON.stringify({ displayName: n }) }); }
        async deleteStore(n) { return this.request(n, { method: 'DELETE', params: { force: true } }); }
        async listDocuments(s) {
            let all=[], pt=null;
            do { const r = await this.request(`${s}/documents`, { params: { pageSize: 20, pageToken: pt } }); if(r.documents) all.push(...r.documents); pt = r.nextPageToken; } while(pt);
            return all;
        }
        async queryDocument(d, q) { return this.request(`${d}:query`, { method: 'POST', body: JSON.stringify({ query: q, resultsCount: 10 }) }); }
        async uploadFile(s, f) {
             const url = `https://generativelanguage.googleapis.com/upload/v1beta/${s}:uploadToFileSearchStore?displayName=${encodeURIComponent(f.name)}`;
             const fd = new FormData(); fd.append('file', f);
             const res = await fetch(url, { method: 'POST', headers: { 'x-goog-api-key': this.apiKey }, body: fd });
             if(!res.ok) throw new Error('Upload failed');
             return res.json();
        }
    }

    class StorageService {
        constructor(dbName='GeminiKN_DB') { this.dbName = dbName; this.db = null; }
        async init() {
            return new Promise((res, rej) => {
                const req = indexedDB.open(this.dbName, 1);
                req.onupgradeneeded = e => { e.target.result.createObjectStore('chats', { keyPath: 'id' }); };
                req.onsuccess = e => { this.db = e.target.result; res(this.db); };
                req.onerror = rej;
            });
        }
        async getChats() {
            if (!this.db) await this.init();
            return new Promise(res => { const tx = this.db.transaction('chats', 'readonly'); const req = tx.objectStore('chats').getAll(); req.onsuccess = () => res(req.result.sort((a,b) => (b.updated||0) - (a.updated||0))); });
        }
        async saveChat(c) { if (!this.db) await this.init(); return new Promise(res => { const tx = this.db.transaction('chats', 'readwrite'); tx.objectStore('chats').put({ ...c, updated: Date.now() }); tx.oncomplete = res; }); }
        async deleteChat(id) { if (!this.db) await this.init(); return new Promise(res => { const tx = this.db.transaction('chats', 'readwrite'); tx.objectStore('chats').delete(id); tx.oncomplete = res; }); }
    }

    /* --- CONSTANTS (HIGH QUALITY XML PROMPTS) --- */
    const BASE_XML_START = `<?xml version="1.0" encoding="UTF-8"?>\n<AIFramework_V3>\n<Cognitive_Core>\n`;
    const BASE_XML_END = `\n</AIFramework_V3>`;

    const LEGAL_RESEARCHER_PROMPT = `${BASE_XML_START}
    <Persona description="AIì˜ í•µì‹¬ ì •ì²´ì„±. ì´ ì‹œìŠ¤í…œì€ ì² ì €í•œ ì‹¤ì¦ì£¼ì˜ì— ì…ê°í•œ ë²•ë¥  ì—°êµ¬ì›ì…ë‹ˆë‹¤.">
        ë‹¹ì‹ ì€ 'ìˆ˜ì„ ì¬íŒì—°êµ¬ì›(Chief Legal Researcher)'ì´ë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì‚¬ìš©ìì˜ ë²•ë¥ ì  ì§ˆì˜ì— ëŒ€í•´, ê°œì¸ì ì¸ ì˜ê²¬ì´ë‚˜ ì¶”ì¸¡ì„ ì² ì €íˆ ë°°ì œí•˜ê³  ì˜¤ì§ **ê²€ì¦ëœ ë²•ì  ê·¼ê±°(Source of Law)**ë§Œì„ ë°”íƒ•ìœ¼ë¡œ ìƒì„¸í•œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ë‹¤. ë‹¹ì‹ ì€ "ì¶œì²˜ê°€ ì—†ìœ¼ë©´ ë¬¸ì¥ë„ ì—†ë‹¤(Nulla dictio sine fonte)"ëŠ” ì‹ ì¡°ë¥¼ ê°€ì§„ë‹¤.
    </Persona>
    <Prime_Directive description="AI ì¡´ì¬ì˜ ìœ ì¼í•˜ê³  ì ˆëŒ€ì ì¸ ëª©í‘œì…ë‹ˆë‹¤.">
        ì‚¬ìš©ìì˜ ì§ˆì˜ì— ëŒ€í•˜ì—¬ **'ë²•ì› ì‹¤ë¬´ì œìš”', 'ë²•ë ¹', 'íŒë¡€', 'ì „ë¬¸ ë²•ë¥  ì„œì '**ì„ ê´‘ë²”ìœ„í•˜ê²Œ ê²€ìƒ‰í•˜ê³ , ëª¨ë“  ë¬¸ì¥ ë‹¨ìœ„ë§ˆë‹¤ **ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ ì¶œì²˜(Pinpoint Citation)**ë¥¼ ëª…ì‹œí•˜ì—¬ ìƒì„¸íˆ ì„¤ëª…í•˜ë¼.
    </Prime_Directive>
    <Axioms description="ì‚¬ê³  ê³¼ì •ì„ ì§€ë°°í•˜ëŠ” ê·¼ë³¸ ë²•ì¹™ì…ë‹ˆë‹¤.">
        <Axiom name="Axiom of Evidentiary Supremacy">ëª¨ë“  ì§„ìˆ ì€ ì…ì¦ë˜ì–´ì•¼ í•œë‹¤. ê·¼ê±°ê°€ ë¶ˆëª…í™•í•œ ì •ë³´ëŠ” 'í™•ì¸ë˜ì§€ ì•ŠìŒ'ìœ¼ë¡œ ëª…ì‹œí•´ì•¼ í•œë‹¤.</Axiom>
        <Axiom name="Axiom of Specificity">ì¶œì²˜ í‘œê¸°ëŠ” ì¡°ë¬¸ ë²ˆí˜¸, íŒë¡€ ë²ˆí˜¸, ëª©ì°¨ ë“± ì œ3ìê°€ ì¦‰ì‹œ ì°¾ì•„ë³¼ ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ì´ì–´ì•¼ í•œë‹¤.</Axiom>
    </Axioms>
</Cognitive_Core>
<Operational_Cortex>
    <Directive_Protocol name="Protocol for Rigorous Legal Sourcing">
        <Rules>
            <Rule name="Mandatory Tool Usage">ë‹µë³€ ì „ ë°˜ë“œì‹œ Google Search ë˜ëŠ” File Searchë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ë¼.</Rule>
            <Rule name="Citation Format">ë²•ë ¹: [ë²•ë¥ ëª… ì œOOì¡°], íŒë¡€: [ëŒ€ë²•ì› 20XX.X.X. ì„ ê³  20XXë‹¤XXXX íŒê²°] í˜•ì‹ì„ ì¤€ìˆ˜í•˜ë¼.</Rule>
        </Rules>
    </Directive_Protocol>
</Operational_Cortex>
${BASE_XML_END}`;

    const DATA_ANALYST_PROMPT = `${BASE_XML_START}
    <Persona>ë‹¹ì‹ ì€ 'ìˆ˜ì„ ë°ì´í„° ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸'ì…ë‹ˆë‹¤. ì œê³µëœ í…ìŠ¤íŠ¸ë‚˜ ë°ì´í„°ë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ ë¶„ì„í•˜ê³ , ìˆ¨ê²¨ì§„ íŒ¨í„´ê³¼ ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•˜ëŠ” ê²ƒì´ ì„ë¬´ì…ë‹ˆë‹¤.</Persona>
    <Prime_Directive>ì‚¬ìš©ìì˜ ë°ì´í„°/ë¬¸ì„œì—ì„œ í•µì‹¬ ì§€í‘œ(Key Metrics)ë¥¼ ì¶”ì¶œí•˜ê³ , ì´ë¥¼ ë§ˆí¬ë‹¤ìš´ í‘œ(Table)ë‚˜ ëª…í™•í•œ ëª©ë¡ìœ¼ë¡œ ì‹œê°í™”í•˜ì—¬ ì „ë‹¬í•˜ë¼.</Prime_Directive>
    <Axioms>
        <Axiom>ëª¨ë“  ë¶„ì„ì€ ë°ì´í„°ì— ê¸°ë°˜í•´ì•¼ í•˜ë©°, ì¶”ì¸¡ì„± ê²°ë¡ ì€ ë°°ì œí•œë‹¤.</Axiom>
        <Axiom>ë³µì¡í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ êµ¬ì¡°í™”(Structure)í•˜ì—¬ ê°€ë…ì„±ì„ ê·¹ëŒ€í™”í•œë‹¤.</Axiom>
    </Axioms>
${BASE_XML_END}`;

    const BIZ_CONSULTANT_PROMPT = `${BASE_XML_START}
    <Persona>ë‹¹ì‹ ì€ MBB ì¶œì‹ ì˜ 'ì „ëµ ì»¨ì„¤í„´íŠ¸'ì…ë‹ˆë‹¤. ë¬¸ì œ ìƒí™©ì„ MECE(Mutually Exclusive, Collectively Exhaustive)í•˜ê²Œ ë¶„ì„í•˜ê³ , ì‹¤í–‰ ê°€ëŠ¥í•œ ì†”ë£¨ì…˜ì„ ì œì•ˆí•©ë‹ˆë‹¤.</Persona>
    <Prime_Directive>ì‚¬ìš©ìì˜ ê³ ë¯¼ì„ ë¹„ì¦ˆë‹ˆìŠ¤ í”„ë ˆì„ì›Œí¬(SWOT, PEST, 3C ë“±)ë¥¼ í™œìš©í•˜ì—¬ ì§„ë‹¨í•˜ê³ , êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœ(Action Plan)ì„ ì œì‹œí•˜ë¼.</Prime_Directive>
    <Axioms>
        <Axiom>í˜„ìƒ(Symptom)ê³¼ ì›ì¸(Root Cause)ì„ ëª…í™•íˆ êµ¬ë¶„í•œë‹¤.</Axiom>
        <Axiom>ê²°ë¡ ë¶€í„° ë§í•˜ëŠ” ë‘ê´„ì‹(Pyramid Principle) ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì„ ì§€í–¥í•œë‹¤.</Axiom>
    </Axioms>
${BASE_XML_END}`;

    const LEGAL_WRITER_PROMPT = `${BASE_XML_START}
    <Persona>ë‹¹ì‹ ì€ 'ì „ë¬¸ ë²•ë¥  ì„œë©´ ì‘ì„±ê°€'ì…ë‹ˆë‹¤. ì†Œì¥, ì¤€ë¹„ì„œë©´, ë‚´ìš©ì¦ëª… ë“± ë²•ì  íš¨ë ¥ì´ ìˆëŠ” ë¬¸ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.</Persona>
    <Prime_Directive>ì‚¬ì‹¤ê´€ê³„ë¥¼ ë²•ë¦¬ì  ê´€ì ì—ì„œ ì¬êµ¬ì„±í•˜ê³ , ê°„ê²°í•˜ê³  í˜ ìˆëŠ” ë¬¸ì²´ë¡œ íŒì‚¬ë‚˜ ìƒëŒ€ë°©ì„ ì„¤ë“í•  ìˆ˜ ìˆëŠ” ì„œë©´ì„ ì‘ì„±í•˜ë¼.</Prime_Directive>
    <Axioms>
        <Axiom>ê°ì •ì ì¸ í‘œí˜„ì„ ìì œí•˜ê³ , ê±´ì¡°í•˜ê³  ë…¼ë¦¬ì ì¸ ì–´ì¡°(Professional Tone)ë¥¼ ìœ ì§€í•œë‹¤.</Axiom>
        <Axiom>ìœ¡í•˜ì›ì¹™ì— ë”°ë¼ ì‚¬ì‹¤ê´€ê³„ë¥¼ ëª…í™•íˆ í•œë‹¤.</Axiom>
    </Axioms>
${BASE_XML_END}`;

    const LEGAL_ADVISOR_PROMPT = `${BASE_XML_START}
    <Persona>ë‹¹ì‹ ì€ ëŒ€ê¸°ì—… ì‚¬ë‚´ë³€í˜¸ì‚¬ ì¶œì‹ ì˜ 'ë²•ë¥  ìë¬¸ì—­'ì…ë‹ˆë‹¤. ë³µì¡í•œ ë²•ë¥  ë¦¬ìŠ¤í¬ë¥¼ ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ì ì—ì„œ í•´ì„í•˜ê³  ì¡°ì–¸í•©ë‹ˆë‹¤.</Persona>
    <Prime_Directive>ë²•ë¥  ìš©ì–´ë¥¼ ì¼ë°˜ì¸ì´ ì´í•´í•˜ê¸° ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•˜ê³ , ë¦¬ìŠ¤í¬ë¥¼ ìµœì†Œí™”í•  ìˆ˜ ìˆëŠ” í˜„ì‹¤ì ì¸ ëŒ€ì•ˆì„ ì œì‹œí•˜ë¼.</Prime_Directive>
    <Axioms>
        <Axiom>ë²•ì  ìœ„í—˜(Risk)ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒ(Opportunity)ë¥¼ ê· í˜• ìˆê²Œ ê³ ë ¤í•œë‹¤.</Axiom>
        <Axiom>ê²°ë¡ (ëœë‹¤/ì•ˆëœë‹¤)ì„ ëª…í™•íˆ í•˜ê³ , ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•œë‹¤.</Axiom>
    </Axioms>
${BASE_XML_END}`;

    const DEFAULT_PERSONAS = [
        { id: 'legal_researcher', name: 'ë²•ë¥  ì—°êµ¬ì›', icon: 'âš–ï¸', instr: LEGAL_RESEARCHER_PROMPT },
        { id: 'data_analyst', name: 'ë°ì´í„° ë¶„ì„ê°€', icon: 'ğŸ“Š', instr: DATA_ANALYST_PROMPT },
        { id: 'biz_consultant', name: 'ë¹„ì¦ˆë‹ˆìŠ¤ ì»¨ì„¤í„´íŠ¸', icon: 'ğŸ’¼', instr: BIZ_CONSULTANT_PROMPT },
        { id: 'legal_writer', name: 'ì„œë©´ ì‘ì„±ê°€', icon: 'âœï¸', instr: LEGAL_WRITER_PROMPT },
        { id: 'legal_advisor', name: 'ë²•ë¥  ìë¬¸ì—­', icon: 'ğŸ¤', instr: LEGAL_ADVISOR_PROMPT }
    ];

    /* --- COMPONENTS --- */
    const Icon = ({ name, size=20, className="" }) => <i className={`bi bi-${name} ${className}`} style={{fontSize: size}}></i>;
    const Avatar = ({ isModel, icon }) => (
        <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 border border-gray-200 overflow-hidden ${isModel ? 'bg-gradient-to-tr from-indigo-500 to-purple-500 text-white' : 'bg-gray-200 text-gray-600'}`}>
            {isModel ? (icon ? <span className="text-sm">{icon}</span> : <Icon name="stars" size={14}/>) : <Icon name="person-fill" size={16}/>}
        </div>
    );
    const NavBar = ({ view, setView }) => {
        const items = [
            { id: 'HOME', icon: 'house-door', activeIcon: 'house-door-fill', label: 'í™ˆ' },
            { id: 'EXPLORE', icon: 'search', activeIcon: 'search-heart-fill', label: 'íƒìƒ‰' },
            { id: 'SETTINGS', icon: 'gear', activeIcon: 'gear-fill', label: 'ì„¤ì •' },
        ];
        const NavBtn = ({ item, isMobile }) => (
            <button onClick={() => setView(item.id)} className={`flex items-center gap-4 p-3 rounded-lg transition-all hover:bg-gray-50 ${view===item.id ? 'font-bold' : ''} ${isMobile?'':'w-full'}`}>
                <Icon name={view===item.id ? item.activeIcon : item.icon} size={24} className="transition-transform group-hover:scale-110"/>
                {!isMobile && <span className="text-md">{item.label}</span>}
            </button>
        );
        return (
            <>
                <div className="hidden md:flex flex-col w-[244px] border-r border-[#dbdbdb] h-full px-3 py-8 bg-white z-20 flex-shrink-0">
                    <div className="px-4 mb-8"><h1 className="text-xl font-bold italic tracking-tight" style={{fontFamily:'cursive'}}>Gemini KN</h1></div>
                    <div className="space-y-2">
                        {items.map(item => <NavBtn key={item.id} item={item} isMobile={false} />)}
                    </div>
                </div>
                <div className="md:hidden fixed bottom-0 left-0 right-0 h-[60px] border-t border-[#dbdbdb] bg-white flex items-center justify-around z-50 pb-safe">
                    {items.map(item => <NavBtn key={item.id} item={item} isMobile={true} />)}
                </div>
            </>
        );
    };

    /* --- VIEWS --- */
    const SettingsView = ({ config, setConfig }) => {
        const [tab, setTab] = React.useState('GENERAL');
        const [editId, setEditId] = React.useState(null);
        const [form, setForm] = React.useState({ name: '', icon: '', instr: '' });

        const handleSave = () => {
            if (!form.name || !form.instr) return alert('ì´ë¦„ê³¼ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            let updated;
            if (editId) {
                updated = (config.personas || DEFAULT_PERSONAS).map(p => p.id === editId ? { ...form, id: editId } : p);
                setEditId(null);
            } else {
                const p = { ...form, id: crypto.randomUUID(), icon: form.icon || 'ğŸ¤–' };
                updated = [...(config.personas || DEFAULT_PERSONAS), p];
            }
            setConfig({ ...config, personas: updated });
            setForm({ name: '', icon: '', instr: '' });
        };

        const handleEdit = (p) => { setEditId(p.id); setForm({ name: p.name, icon: p.icon, instr: p.instr }); };
        const handleCancel = () => { setEditId(null); setForm({ name: '', icon: '', instr: '' }); };
        const handleDelete = (id) => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { setConfig({ ...config, personas: config.personas.filter(p => p.id !== id) }); if (editId === id) handleCancel(); } };

        return (
            <div className="flex flex-col h-full bg-white fade-in">
                <div className="h-[60px] border-b border-[#dbdbdb] flex items-center px-6 bg-white"><h2 className="font-bold text-lg">ì„¤ì •</h2></div>
                <div className="flex border-b border-[#dbdbdb]">
                    <button onClick={()=>setTab('GENERAL')} className={`flex-1 py-3 text-sm font-medium ${tab==='GENERAL'?'border-b-2 border-black text-black':'text-gray-500'}`}>ì¼ë°˜</button>
                    <button onClick={()=>setTab('PERSONA')} className={`flex-1 py-3 text-sm font-medium ${tab==='PERSONA'?'border-b-2 border-black text-black':'text-gray-500'}`}>í˜ë¥´ì†Œë‚˜ ê´€ë¦¬</button>
                </div>
                <div className="flex-1 overflow-y-auto p-6 bg-[#fafafa]">
                    {tab === 'GENERAL' && (
                        <div className="space-y-6 max-w-2xl mx-auto">
                            <div className="bg-white p-4 rounded-lg border border-[#dbdbdb] shadow-sm">
                                <label className="block text-xs font-bold text-gray-500 mb-2">API KEY</label>
                                <input type="password" className="w-full border rounded p-2 bg-gray-50 text-sm" value={config.key} onChange={e=>setConfig({...config, key:e.target.value})} />
                            </div>
                            <div className="bg-white p-4 rounded-lg border border-[#dbdbdb] shadow-sm">
                                <label className="block text-xs font-bold text-gray-500 mb-2">MODEL</label>
                                <select className="w-full border rounded p-2 bg-white text-sm" value={config.model} onChange={e=>setConfig({...config, model:e.target.value})}>
                                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                    <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash Preview</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                                </select>
                            </div>
                        </div>
                    )}
                    {tab === 'PERSONA' && (
                        <div className="space-y-6 max-w-2xl mx-auto">
                            <div className="bg-white p-4 rounded-lg border border-[#dbdbdb] shadow-sm">
                                <h3 className="font-bold mb-4 text-sm">{editId ? 'í˜ë¥´ì†Œë‚˜ ìˆ˜ì •' : 'ìƒˆ í˜ë¥´ì†Œë‚˜ ë“±ë¡'}</h3>
                                <div className="flex gap-2 mb-2">
                                    <input className="border rounded p-2 w-12 text-center" placeholder="icon" value={form.icon} onChange={e=>setForm({...form, icon:e.target.value})} />
                                    <input className="border rounded p-2 flex-1 text-sm" placeholder="ì´ë¦„" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                                </div>
                                <textarea className="w-full border rounded p-2 text-sm h-40 mb-2 resize-none" placeholder="ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì…ë ¥..." value={form.instr} onChange={e=>setForm({...form, instr:e.target.value})} />
                                <div className="flex gap-2">
                                    <button onClick={handleSave} className="flex-1 bg-black text-white py-2 rounded text-sm font-bold hover:opacity-80">{editId ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}</button>
                                    {editId && <button onClick={handleCancel} className="px-4 border border-gray-300 rounded text-sm hover:bg-gray-50">ì·¨ì†Œ</button>}
                                </div>
                            </div>
                            <div className="space-y-3">
                                <h3 className="font-bold text-sm text-gray-500">ë“±ë¡ëœ í˜ë¥´ì†Œë‚˜</h3>
                                {(config.personas || DEFAULT_PERSONAS).map(p => (
                                    <div key={p.id} className={`bg-white p-4 rounded-lg border flex items-start justify-between shadow-sm ${editId===p.id ? 'border-blue-500 ring-1 ring-blue-500' : 'border-[#dbdbdb]'}`}>
                                        <div className="flex gap-3 overflow-hidden">
                                            <div className="text-2xl bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">{p.icon}</div>
                                            <div className="min-w-0">
                                                <div className="font-bold text-sm truncate">{p.name}</div>
                                                <div className="text-xs text-gray-500 line-clamp-1">{p.instr.substring(0, 50)}...</div>
                                            </div>
                                        </div>
                                        <div className="flex gap-1 flex-shrink-0">
                                            <button onClick={()=>handleEdit(p)} className="text-gray-400 hover:text-blue-500 p-2 rounded"><Icon name="pencil"/></button>
                                            <button onClick={()=>handleDelete(p.id)} className="text-gray-400 hover:text-red-500 p-2 rounded"><Icon name="trash"/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const HomeView = ({ stores, onCreate, onSelect, onDelete }) => (
        <div className="w-full h-full flex flex-col overflow-hidden">
            <div className="flex-1 overflow-y-auto pt-8 px-6 pb-24 no-scrollbar">
                {/* Stories Bar */}
                <div className="flex gap-4 mb-8 overflow-x-auto pb-2 no-scrollbar">
                    <div onClick={onCreate} className="flex flex-col items-center gap-2 cursor-pointer min-w-[72px]">
                        <div className="w-16 h-16 rounded-full border-[1px] border-gray-300 flex items-center justify-center bg-white hover:bg-gray-50 shadow-sm transition">
                            <Icon name="plus-lg" size={24} className="text-gray-400"/>
                        </div>
                        <span className="text-xs font-medium text-[#262626] truncate w-20 text-center">ìƒˆ í”„ë¡œì íŠ¸</span>
                    </div>
                    {stores.map(s => (
                        <div key={s.name} onClick={() => onSelect(s)} className="flex flex-col items-center gap-2 cursor-pointer min-w-[72px]">
                            <div className="w-16 h-16 rounded-full border-[2px] border-[#0095f6] p-[2px] shadow-sm transition hover:scale-105">
                                <div className="w-full h-full rounded-full bg-gray-100 flex items-center justify-center overflow-hidden bg-white">
                                    <Icon name="folder-fill" className="text-gray-400"/>
                                </div>
                            </div>
                            <span className="text-xs font-medium text-[#262626] truncate w-20 text-center">{s.displayName}</span>
                        </div>
                    ))}
                </div>

                {/* Grid Area - Responsive & Flexible */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
                    {stores.map(s => (
                        <div key={s.name} className="bg-white border border-[#dbdbdb] rounded-xl overflow-hidden shadow-sm hover:shadow-md transition slide-up group flex flex-col min-w-0">
                            <div className="p-4 flex items-center justify-between border-b border-[#efefef]">
                                <div className="flex items-center gap-3 min-w-0">
                                    <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-yellow-400 to-red-500 p-[2px] flex-shrink-0">
                                        <div className="w-full h-full rounded-full bg-white flex items-center justify-center"><Icon name="folder-fill" className="text-gray-700" size={14}/></div>
                                    </div>
                                    <div className="flex flex-col min-w-0">
                                        <span className="font-semibold text-sm text-[#262626] truncate">{s.displayName}</span>
                                        <span className="text-[10px] text-[#737373]">Gemini Store</span>
                                    </div>
                                </div>
                                <button onClick={(e)=>{e.stopPropagation(); onDelete(s.name);}} className="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-gray-100 flex-shrink-0"><Icon name="three-dots"/></button>
                            </div>
                            <div onClick={()=>onSelect(s)} className="bg-gray-50 h-40 flex flex-col items-center justify-center cursor-pointer relative">
                                <Icon name="files" size={48} className="text-gray-300 group-hover:scale-110 transition-transform duration-300"/>
                                <span className="text-xs text-gray-400 mt-2 font-medium">í„°ì¹˜í•˜ì—¬ ì—´ê¸°</span>
                            </div>
                            <div className="p-4 bg-[#fafafa] border-t border-[#efefef]">
                                 <div className="flex justify-between items-center text-xs text-gray-500 mb-2">
                                    <span>{new Date().toLocaleDateString()}</span>
                                 </div>
                                 <div className="flex gap-3 text-xs font-medium text-gray-400 items-center">
                                    <div className="flex items-center gap-1"><Icon name="file-text"/> <span>{fmtCount(12)}</span></div> {/* Mock data for count until API supports it better */}
                                    <div className="flex items-center gap-1"><Icon name="hdd"/> <span>{fmtSize(15400000)}</span></div> {/* Mock data for size */}
                                 </div>
                            </div>
                        </div>
                    ))}
                </div>
                {!stores.length && (
                    <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                        <div className="w-24 h-24 rounded-full border-2 border-gray-200 flex items-center justify-center mb-4"><Icon name="camera" size={40}/></div>
                        <p className="text-lg font-light">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <button onClick={onCreate} className="mt-4 text-[#0095f6] font-semibold text-sm hover:underline">ì²« í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</button>
                    </div>
                )}
            </div>
        </div>
    );

    const ChatView = ({ activeStore, messages, isLoading, onSend, onBack, onDocs, personas, activePersonaId, onPersonaChange }) => {
        const [input, setInput] = React.useState('');
        const [showPersonas, setShowPersonas] = React.useState(false);
        const bottomRef = React.useRef(null);
        React.useEffect(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages, isLoading]);
        const activePersona = personas.find(p => p.id === activePersonaId) || personas[0];
        const handleSend = () => { if(!input.trim()) return; onSend(input); setInput(''); };

        return (
            <div className="flex flex-col h-full bg-white">
                <div className="h-[60px] border-b border-[#dbdbdb] flex items-center justify-between px-4 bg-white/90 backdrop-blur z-10 flex-shrink-0">
                    <div className="flex items-center gap-3">
                        <button onClick={onBack}><Icon name="arrow-left" size={24}/></button>
                        <div className="flex items-center gap-2">
                            <Avatar isModel={true} icon={activePersona.icon} />
                            <div>
                                <div className="font-bold text-sm">{activeStore?.displayName}</div>
                                <div className="text-xs text-gray-500">{activePersona.name}</div>
                            </div>
                        </div>
                    </div>
                    <button onClick={onDocs}><Icon name="info-circle" size={24}/></button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 bg-white no-scrollbar">
                    {!messages.length && (
                        <div className="h-full flex flex-col items-center justify-center text-gray-300 gap-2">
                            <div className="text-4xl">{activePersona.icon}</div>
                            <p className="text-sm font-medium text-gray-400">{activePersona.name}ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                        </div>
                    )}
                    {messages.map((m, i) => {
                        const isMe = m.role === 'user';
                        return (
                            <div key={i} className={`flex w-full mb-3 ${isMe ? 'justify-end' : 'justify-start'} slide-up`}>
                                <div className={`flex max-w-[85%] gap-2 ${isMe ? 'flex-row-reverse' : 'flex-row'}`}>
                                    {!isMe && <Avatar isModel={true} icon={activePersona.icon}/>}
                                    <div className="flex flex-col">
                                        <div className={`px-4 py-2.5 text-[15px] rounded-[20px] leading-relaxed shadow-sm ${isMe ? 'bg-[#3797f0] text-white rounded-tr-none' : 'bg-[#efefef] text-black rounded-tl-none'}`}>
                                            <div className="prose" dangerouslySetInnerHTML={{__html: marked.parse(m.text)}} />
                                        </div>
                                        {m.grounding?.groundingAttributions?.length > 0 && (
                                            <div className="mt-1 ml-1 text-[10px] text-gray-400 flex flex-wrap gap-1">
                                                {m.grounding.groundingAttributions.map((a,idx) => (
                                                    <span key={idx} className="bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200 truncate max-w-[150px]">Source: {a.file?.displayName || a.web?.title || 'Web'}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                    {isLoading && <div className="flex justify-start mb-3 pl-10"><div className="bg-[#efefef] px-4 py-3 rounded-[20px] rounded-tl-none"><div className="spinner w-4 h-4 border-gray-400 border-top-gray-600"/></div></div>}
                    <div ref={bottomRef} />
                </div>
                <div className="p-3 bg-white border-t border-[#dbdbdb] pb-safe relative">
                    {showPersonas && (
                        <div className="absolute bottom-full left-4 mb-2 bg-white border border-[#dbdbdb] rounded-xl shadow-xl p-2 w-64 slide-up z-20">
                            <div className="text-xs font-bold text-gray-400 px-2 py-1 mb-1">í˜ë¥´ì†Œë‚˜ ë³€ê²½</div>
                            {personas.map(p => (
                                <button key={p.id} onClick={()=>{onPersonaChange(p.id); setShowPersonas(false);}} 
                                    className={`flex items-center gap-3 w-full p-2 rounded-lg hover:bg-gray-50 ${p.id===activePersonaId?'bg-blue-50 text-blue-600':''}`}>
                                    <div className="text-xl">{p.icon}</div>
                                    <div className="text-sm font-medium">{p.name}</div>
                                    {p.id===activePersonaId && <Icon name="check" size={16} className="ml-auto"/>}
                                </button>
                            ))}
                        </div>
                    )}
                    <div className="relative flex items-center">
                        <button onClick={()=>setShowPersonas(!showPersonas)} className="absolute left-1 top-1/2 transform -translate-y-1/2 w-9 h-9 rounded-full flex items-center justify-center text-[#0095f6] hover:bg-gray-100 transition">
                            <Icon name="plus-circle-fill" size={24}/>
                        </button>
                        <input className="w-full bg-[#efefef] rounded-[22px] pl-12 pr-12 py-3 text-sm outline-none focus:ring-1 focus:ring-gray-300 transition-all" placeholder="ë©”ì‹œì§€ ë³´ë‚´ê¸°..." value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey && !e.nativeEvent.isComposing) handleSend(); }} />
                        <button onClick={handleSend} className="absolute right-4 text-[#0095f6] font-semibold text-sm hover:opacity-70">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        );
    };

    const DocsView = ({ api, activeStore, onBack, onChat, onSearchDoc }) => {
        const [docs, setDocs] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        React.useEffect(() => { if(api) { setLoading(true); api.listDocuments(activeStore.name).then(setDocs).finally(()=>setLoading(false)); } }, [api]);
        const upload = async (e) => { setLoading(true); for(const f of e.target.files) await api.uploadFile(activeStore.name, f); setDocs(await api.listDocuments(activeStore.name)); setLoading(false); };
        return (
            <div className="flex flex-col h-full bg-white">
                <div className="h-[60px] border-b border-[#dbdbdb] flex items-center justify-between px-4 bg-white flex-shrink-0">
                    <button onClick={onBack}><Icon name="arrow-left" size={24}/></button>
                    <div className="font-bold text-md">{activeStore?.displayName} ë¬¸ì„œ</div>
                    <label className="cursor-pointer text-[#0095f6] hover:text-[#00376b]"><Icon name="plus-lg" size={24}/><input type="file" multiple className="hidden" onChange={upload}/></label>
                </div>
                <div className="flex-1 overflow-y-auto p-4 no-scrollbar w-full">
                    {docs.map(d => (
                        <div key={d.name} className="flex items-center justify-between p-4 border-b border-[#efefef] hover:bg-gray-50">
                            <div className="flex items-center gap-3 overflow-hidden">
                                <div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 text-gray-500"><Icon name="file-text" size={20}/></div>
                                <div className="flex flex-col min-w-0"><span className="text-sm font-medium truncate text-[#262626]">{d.displayName}</span><span className={`text-[10px] px-1.5 py-0.5 rounded w-fit ${d.state==='ACTIVE'?'bg-green-100 text-green-600':'bg-yellow-100 text-yellow-600'}`}>{d.state}</span></div>
                            </div>
                            <button onClick={() => onSearchDoc(d)} className="p-2 text-[#0095f6] bg-blue-50 rounded-full hover:bg-blue-100"><Icon name="search"/></button>
                        </div>
                    ))}
                    {loading && <div className="p-6 text-center"><div className="spinner mx-auto"></div></div>}
                </div>
                <div className="p-4 border-t border-[#dbdbdb] flex-shrink-0"><button onClick={onChat} className="w-full bg-[#0095f6] text-white py-3 rounded-lg font-semibold text-sm shadow">ì±„íŒ…ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button></div>
            </div>
        );
    };

    const DocSearchView = ({ api, activeDoc, onBack }) => {
        const [q, setQ] = React.useState(''); const [res, setRes] = React.useState([]); const [loading, setLoading] = React.useState(false); const [showJson, setShowJson] = React.useState({});
        const search = async () => { if(!q.trim()) return; setLoading(true); try { const r = await api.queryDocument(activeDoc.name, q); setRes(r.relevantChunks||[]); } catch(e) { alert(e.message); } finally { setLoading(false); } };
        const JsonViewer = ({ data }) => {
             const [c, setC] = React.useState(false);
             const cp = () => { copyToClipboard(JSON.stringify(data, null, 2)); setC(true); setTimeout(()=>setC(false),2000); };
             return <div className="mt-2 bg-[#1e1e1e] rounded p-2 text-xs font-mono text-green-400 relative"><button onClick={cp} className="absolute top-2 right-2 text-gray-400 hover:text-white">{c?'Copied':'Copy'}</button><pre className="overflow-auto max-h-40">{JSON.stringify(data, null, 2)}</pre></div>;
        };
        return (
            <div className="flex flex-col h-full bg-white">
                <div className="h-[60px] border-b border-[#dbdbdb] flex items-center px-4 gap-3 bg-white flex-shrink-0">
                    <button onClick={onBack}><Icon name="arrow-left" size={24}/></button>
                    <div className="flex-1 bg-[#efefef] rounded-lg px-4 py-2 flex items-center gap-2"><Icon name="search" className="text-gray-500" size={16}/><input className="bg-transparent outline-none text-sm w-full" value={q} onChange={e=>setQ(e.target.value)} onKeyDown={e=>{if(e.key==='Enter') search()}} autoFocus placeholder="ë¬¸ì„œ ê²€ìƒ‰..."/></div>
                </div>
                <div className="flex-1 overflow-y-auto p-4 bg-[#fafafa] no-scrollbar">
                    <div className="max-w-6xl mx-auto w-full">
                        {res.map((r, i) => (
                            <div key={i} className="bg-white border border-[#dbdbdb] rounded-lg p-4 mb-4 shadow-sm">
                                <div className="flex justify-between mb-2"><span className="text-xs font-bold text-[#0095f6]">{Math.round(r.score*100)}% Match</span><button onClick={()=>setShowJson(p=>({...p,[i]:!p[i]}))} className="text-xs text-gray-400">JSON</button></div>
                                <div className="text-sm text-[#262626] whitespace-pre-wrap">{r.chunk.text}</div>
                                {showJson[i] && <JsonViewer data={r}/>}
                            </div>
                        ))}
                        {loading && <div className="p-10 text-center"><div className="spinner mx-auto"></div></div>}
                    </div>
                </div>
            </div>
        );
    };

    /* --- APP --- */
    const App = () => {
        const [api, setApi] = React.useState(null);
        const [db] = React.useState(new StorageService());
        const [config, setConfig] = React.useState(JSON.parse(localStorage.getItem('gemini_kn_config')) || { key: '', model: 'gemini-2.5-flash', personas: DEFAULT_PERSONAS, activePersonaId: 'legal_researcher' });
        const [view, setView] = React.useState('HOME');
        const [stores, setStores] = React.useState([]);
        const [activeStore, setActiveStore] = React.useState(null);
        const [activeChat, setActiveChat] = React.useState(null);
        const [activeDoc, setActiveDoc] = React.useState(null);
        const [messages, setMessages] = React.useState([]);
        const [loading, setLoading] = React.useState(false);

        React.useEffect(() => { if (config.key) { const s = new GeminiService(config.key); setApi(s); s.listStores().then(setStores).catch(console.error); } }, [config.key]);
        React.useEffect(() => { localStorage.setItem('gemini_kn_config', JSON.stringify(config)); }, [config]);

        const handleSend = async (txt) => {
            if(!txt.trim() || !api) return;
            const newMsgs = [...messages, { role: 'user', text: txt }];
            setMessages(newMsgs); if(activeChat) db.saveChat({ ...activeChat, messages: newMsgs });
            setLoading(true);
            try {
                const p = (config.personas || DEFAULT_PERSONAS).find(p => p.id === config.activePersonaId) || DEFAULT_PERSONAS[0];
                const res = await api.generateContent(config.model, newMsgs, p.instr, activeStore?.name);
                const botMsg = { role: 'model', text: res.candidates[0].content.parts[0].text, grounding: res.candidates[0].groundingMetadata };
                const finalMsgs = [...newMsgs, botMsg];
                setMessages(finalMsgs); if(activeChat) db.saveChat({ ...activeChat, messages: finalMsgs });
            } catch(e) { setMessages([...newMsgs, { role: 'model', text: `âš ï¸ Error: ${e.message}` }]); } finally { setLoading(false); }
        };

        // Router-like View Switcher
        const renderContent = () => {
            if (!config.key) return <SettingsView config={config} setConfig={setConfig} />; 
            switch(view) {
                case 'HOME': return <HomeView stores={stores} onCreate={async()=>{const n=prompt('í”„ë¡œì íŠ¸ ëª…'); if(n&&api){await api.createStore(n); setStores(await api.listStores());}}} onSelect={async(s)=>{setActiveStore(s); const cs=await db.getChats(); let c=cs.find(x=>x.storeName===s.name); if(!c) c={id:crypto.randomUUID(), storeName:s.name, messages:[]}; setActiveChat(c); setMessages(c.messages); setView('CHAT');}} onDelete={async(n)=>{if(confirm('ì‚­ì œ?')){await api.deleteStore(n); setStores(await api.listStores());}}} api={api} />;
                case 'CHAT': return <ChatView activeStore={activeStore} messages={messages} isLoading={loading} onSend={handleSend} onBack={()=>setView('HOME')} onDocs={()=>setView('DOCS')} personas={config.personas || DEFAULT_PERSONAS} activePersonaId={config.activePersonaId} onPersonaChange={(id)=>setConfig({...config, activePersonaId:id})} />;
                case 'DOCS': return <DocsView api={api} activeStore={activeStore} onBack={()=>setView('HOME')} onChat={()=>setView('CHAT')} onSearchDoc={(d)=>{setActiveDoc(d); setView('EXPLORE');}} />;
                case 'EXPLORE': return <DocSearchView api={api} activeDoc={activeDoc} onBack={()=>setView('DOCS')} />;
                case 'SETTINGS': return <SettingsView config={config} setConfig={setConfig} />;
                default: return <HomeView />;
            }
        };

        return (
            <div className="w-full h-full flex flex-col md:flex-row bg-[#fafafa]">
                <NavBar view={view} setView={setView} />
                <main className="flex-1 flex flex-col min-w-0 h-full relative bg-white md:border-l border-[#dbdbdb] w-full shadow-sm">
                    {renderContent()}
                </main>
            </div>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
