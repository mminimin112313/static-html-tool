<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini File Store 관리자 (Standalone)</title>
    
    <!-- 아이콘은 SVG로 대체하거나 필요한 경우 CDN 유지 (Bootstrap Icons는 보통 허용됨) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- [CORE] Reset & Base --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background-color: #030712; /* bg-gray-950 */
            color: #d1d5db; /* text-gray-300 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; overflow: hidden;
        }
        button, input, textarea, select { font-family: inherit; }

        /* --- [TAILWIND POLYFILL] Colors --- */
        :root {
            --gray-950: #030712;
            --neutral-900: #171717;
            --neutral-800: #262626;
            --neutral-700: #404040;
            --neutral-600: #525252;
            
            --green-500: #22c55e;
            --green-600: #16a34a;
            --green-700: #15803d;
            --green-800: #166534;
            --green-900: #14532d;
            
            --red-400: #f87171;
            --red-700: #b91c1c;
            --red-900: #7f1d1d;

            --blue-300: #93c5fd;
            --blue-900: #1e3a8a;
            
            --yellow-300: #fde047;
            --yellow-900: #713f12;

            --white: #ffffff;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
        }

        /* --- [TAILWIND POLYFILL] Utilities used in JSX --- */
        .bg-gray-950 { background-color: var(--gray-950); }
        .bg-neutral-900 { background-color: var(--neutral-900); }
        .bg-neutral-800 { background-color: var(--neutral-800); }
        .bg-neutral-700 { background-color: var(--neutral-700); }
        .bg-green-600 { background-color: var(--green-600); }
        .bg-green-800 { background-color: var(--green-800); }
        .bg-green-900 { background-color: var(--green-900); }
        .bg-red-900 { background-color: var(--red-900); }
        .bg-yellow-900 { background-color: var(--yellow-900); }
        .bg-black { background-color: #000; }
        .bg-blue-900 { background-color: var(--blue-900); }

        .bg-opacity-75 { background-color: rgba(0, 0, 0, 0.75); }
        .bg-opacity-30 { background-color: rgba(20, 83, 45, 0.3); } /* Green 900 opacity approx */
        .bg-opacity-50 { --tw-bg-opacity: 0.5; }

        .hover\:bg-neutral-800:hover { background-color: var(--neutral-800); }
        .hover\:bg-neutral-700:hover { background-color: var(--neutral-700); }
        .hover\:bg-neutral-600:hover { background-color: var(--neutral-600); }
        .hover\:bg-green-700:hover { background-color: var(--green-700); }
        .hover\:bg-green-800:hover { background-color: var(--green-800); }
        .hover\:bg-red-700:hover { background-color: var(--red-700); }
        .hover\:bg-blue-800:hover { background-color: #1e40af; }

        .text-white { color: var(--white); }
        .text-gray-300 { color: var(--gray-300); }
        .text-gray-400 { color: var(--gray-400); }
        .text-gray-500 { color: var(--gray-500); }
        .text-green-300 { color: #86efac; }
        .text-green-400 { color: #4ade80; }
        .text-red-200 { color: #fecaca; }
        .text-red-400 { color: var(--red-400); }
        .text-red-300 { color: #fca5a5; }
        .text-yellow-300 { color: var(--yellow-300); }
        .text-blue-300 { color: var(--blue-300); }
        
        .hover\:text-white:hover { color: var(--white); }
        .hover\:text-green-300:hover { color: #86efac; }
        .hover\:text-red-300:hover { color: #fca5a5; }
        .hover\:text-red-400:hover { color: var(--red-400); }

        .border { border-width: 1px; border-style: solid; }
        .border-b { border-bottom-width: 1px; border-bottom-style: solid; }
        .border-t { border-top-width: 1px; border-top-style: solid; }
        .border-neutral-800 { border-color: var(--neutral-800); }
        .border-neutral-700 { border-color: var(--neutral-700); }
        .border-red-700 { border-color: var(--red-700); }
        .border-green-800 { border-color: var(--green-800); }
        
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-row { flex-direction: row; }
        .flex-1 { flex: 1 1 0%; }
        .flex-shrink-0 { flex-shrink: 0; }
        .items-center { align-items: center; }
        .items-end { align-items: flex-end; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        
        .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; }
        .space-x-3 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.75rem; }
        .space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-left: 1rem; }
        .space-x-5 > :not([hidden]) ~ :not([hidden]) { margin-left: 1.25rem; }
        .space-y-1 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.25rem; }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .space-y-5 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.25rem; }

        .w-full { width: 100%; }
        .h-screen { height: 100vh; }
        .h-full { height: 100%; }
        .h-16 { height: 4rem; }
        .w-72 { width: 18rem; }
        .w-80 { width: 20rem; }
        .w-8 { width: 2rem; }
        .h-8 { height: 2rem; }
        .w-5 { width: 1.25rem; }
        .h-5 { height: 1.25rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-4xl { max-width: 56rem; }
        .max-w-7xl { max-width: 80rem; }
        .max-w-none { max-width: none; }
        .max-h-64 { max-height: 16rem; }
        
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-5 { padding: 1.25rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .p-10 { padding: 2.5rem; }
        
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-5 { padding-left: 1.25rem; padding-right: 1.25rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-7 { padding-top: 1.75rem; padding-bottom: 1.75rem; }
        .py-10 { padding-top: 2.5rem; padding-bottom: 2.5rem; }
        
        .m-0 { margin: 0; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-5 { margin-top: 1.25rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-10 { margin-bottom: 2.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .ml-2 { margin-left: 0.5rem; }
        .ml-3 { margin-left: 0.75rem; }
        
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .top-0 { top: 0; }
        .top-3 { top: 0.75rem; }
        .right-0 { right: 0; }
        .right-3 { right: 0.75rem; }
        .bottom-0 { bottom: 0; }
        .z-50 { z-index: 50; }
        
        .hidden { display: none; }
        .block { display: block; }
        .inline-flex { display: inline-flex; }
        
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .uppercase { text-transform: uppercase; }
        .tracking-wider { letter-spacing: 0.05em; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        
        .border-collapse { border-collapse: collapse; }
        .rounded-none { border-radius: 0; }
        .outline-none { outline: 2px solid transparent; outline-offset: 2px; }
        .resize-none { resize: none; }
        .cursor-pointer { cursor: pointer; }
        .cursor-not-allowed { cursor: not-allowed; }
        
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .opacity-0 { opacity: 0; }
        .opacity-50 { opacity: 0.5; }
        .group:hover .group-hover\:opacity-100 { opacity: 1; }
        .disabled\:opacity-50:disabled { opacity: 0.5; }
        .backdrop-blur-sm { backdrop-filter: blur(4px); }

        /* Grid */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .gap-8 { gap: 2rem; }
        @media (min-width: 640px) { .sm\:block { display: block; } .sm\:flex-row { flex-direction: row; } .sm\:space-y-0 > :not([hidden]) ~ :not([hidden]) { margin-top: 0; } .sm\:space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-left: 1rem; } }
        @media (min-width: 768px) { .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } .md\:px-8 { padding-left: 2rem; padding-right: 2rem; } .md\:p-10 { padding: 2.5rem; } }
        @media (min-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }

        /* --- Prose (Markdown) Styles --- */
        .prose p { margin-top: 0.75em; margin-bottom: 0.75em; }
        .prose ul, .prose ol { list-style-position: inside; padding-left: 1.5em; margin: 0.75em 0; }
        .prose li { margin: 0.3em 0; }
        .prose pre { background-color: var(--gray-950); padding: 1rem; border-radius: 0.75rem; overflow-x: auto; margin: 1em 0; font-family: monospace; border: 1px solid var(--neutral-800); }
        .prose code { background-color: var(--neutral-800); padding: 0.2em 0.4em; border-radius: 0.25rem; font-family: monospace; font-size: 0.9em; }
        .prose pre code { background-color: transparent; padding: 0; }
        .prose a { color: var(--green-500); text-decoration: underline; }
        .prose-invert { color: var(--gray-300); }
        .prose-invert strong { color: var(--white); }
        .prose-invert table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .prose-invert th { background-color: var(--neutral-700); border: 1px solid var(--neutral-600); padding: 0.75em 1em; font-weight: 600; color: var(--white); text-align: left; }
        .prose-invert td { border: 1px solid var(--neutral-600); padding: 0.75em 1em; color: var(--gray-300); }
        .prose-invert tr:nth-child(even) { background-color: var(--neutral-800); }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.1); width: 1.25rem; height: 1.25rem; border-radius: 50%; border-left-color: var(--green-500); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--gray-950); }
        ::-webkit-scrollbar-thumb { background: var(--neutral-800); border-radius: 4px; border: 2px solid var(--gray-950); }
        ::-webkit-scrollbar-thumb:hover { background: var(--neutral-700); }
        
        .drag-over { border-style: dashed !important; border-color: var(--green-600) !important; background-color: var(--neutral-900) !important; }
    </style>
</head>
<body>
    <noscript>이 앱을 실행하려면 JavaScript가 필요합니다.</noscript>
    <div id="root"></div>

    <script type="text/babel">
(function() { // IIFE START

const { useState, useEffect, useRef, useMemo, useCallback } = React;

/* --- Icons --- */
const IconFolder = () => <i className="bi bi-folder text-xl"></i>;
const IconChat = () => <i className="bi bi-chat-dots text-xl"></i>;
const IconTrash = () => <i className="bi bi-trash text-xl"></i>;
const IconFile = () => <i className="bi bi-file-earmark-text text-xl"></i>;
const IconCloudUpload = () => <i className="bi bi-cloud-arrow-up text-xl"></i>;
const IconPlus = () => <i className="bi bi-plus-lg text-xl"></i>;
const IconSpinner = () => <div className="spinner"></div>;
const IconArrowLeft = () => <i className="bi bi-arrow-left text-xl"></i>;
const IconSearch = () => <i className="bi bi-search text-xl"></i>;
const IconCopy = () => <i className="bi bi-clipboard"></i>;
const IconCheck = () => <i className="bi bi-check-lg"></i>;
const IconUser = () => <i className="bi bi-person text-xl"></i>;
const IconGemini = () => <i className="bi bi-gem text-xl"></i>;
const IconEdit = () => <i className="bi bi-pencil"></i>;
const IconCheckSmall = () => <i className="bi bi-check-lg text-base"></i>;
const IconUploadQueue = () => <i className="bi bi-cloud-arrow-up text-xl"></i>;
const IconSettings = () => <i className="bi bi-gear text-xl"></i>;
const IconXCircle = () => <i className="bi bi-x-circle text-xl"></i>;
const IconExternalLink = () => <i className="bi bi-box-arrow-up-right text-xs"></i>;
const IconDownload = () => <i className="bi bi-download text-xl"></i>;
const IconFileQueue = () => <i className="bi bi-file-earmark text-xl"></i>;
const IconXSmall = () => <i className="bi bi-x-lg text-base"></i>;

/* --- Helper Functions (Restored) --- */
const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/';
const UPLOAD_BASE_URL = 'https://generativelanguage.googleapis.com/upload/v1beta/';
const DB_NAME = 'GeminiFileStoreDB';
const CHAT_STORE = 'chats';

function openDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, 1); request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains(CHAT_STORE)) { db.createObjectStore(CHAT_STORE, { keyPath: 'id' }); } }; request.onsuccess = (event) => { resolve(event.target.result); }; request.onerror = (event) => { reject('IndexedDB error'); }; }); }
function dbRequest(storeName, mode, operation) { return new Promise(async (resolve, reject) => { try { const db = await openDB(); const tx = db.transaction(storeName, mode); const store = tx.objectStore(storeName); operation(store, resolve, reject); tx.oncomplete = () => { if (mode !== 'readonly') { resolve(); } }; tx.onerror = (event) => { reject(event.target.error); }; } catch (error) { reject(error); } }); }
function getChatsFromDB() { return dbRequest(CHAT_STORE, 'readonly', (store, resolve) => { const request = store.getAll(); request.onsuccess = () => resolve(request.result); }); }
function saveChatToDB(chat) { return dbRequest(CHAT_STORE, 'readwrite', (store) => { store.put(chat); }); }
function deleteChatFromDB(chatId) { return dbRequest(CHAT_STORE, 'readwrite', (store) => { store.delete(chatId); }); }

async function apiRequest(endpoint, options = {}, apiKey) {
  let url = `${API_BASE_URL}${endpoint}`;
  if (options.params) { const query = new URLSearchParams(options.params).toString(); if (query) url += `?${query}`; }
  const headers = { 'Content-Type': 'application/json', 'x-goog-api-key': apiKey, ...options.headers };
  try {
    const response = await fetch(url, { ...options, method: options.method || 'GET', headers, params: undefined }); 
    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error?.message || response.statusText); }
    return await response.json();
  } catch (error) { console.error(`API Request Failed:`, error); throw error; }
}

async function apiGeminiFilter(prompt, apiKey, modelName = 'gemini-2.5-flash') {
  const apiUrl = `${API_BASE_URL}models/${modelName}:generateContent?key=${apiKey}`;
  try {
      const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      if (!response.ok) return null;
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text || null;
  } catch (error) { return null; }
}

async function apiUploadRequest(endpoint, file, metadata, apiKey) {
  const params = new URLSearchParams(); if (metadata.displayName) params.append('displayName', metadata.displayName);
  const url = `${UPLOAD_BASE_URL}${endpoint}?${params.toString()}`;
  const formData = new FormData(); formData.append('file', file);
  const response = await fetch(url, { method: 'POST', headers: { 'x-goog-api-key': apiKey }, body: formData });
  if (!response.ok) throw new Error(await response.text());
  return await response.json();
}

function formatBytes(bytes, decimals = 2) { if (!bytes || bytes === 0) return 'N/A'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return `${parseFloat((bytes / Math.pow(k, i)).toFixed(decimals < 0 ? 0 : decimals))} ${sizes[i]}`; }
function useClipboard(timeout = 1500) { const [copied, setCopied] = useState(false); const copy = useCallback((text) => { navigator.clipboard.writeText(text).then(() => { setCopied(true); setTimeout(() => setCopied(false), timeout); }); }, [timeout]); return [copied, copy]; }
function useAutosizeTextarea(textareaRef, value) { useEffect(() => { if (textareaRef.current) { textareaRef.current.style.height = '0px'; textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`; } }, [textareaRef, value]); }


/* --- Components (User's JSX with Tailwind Polyfill) --- */

// 설정 모달
function SettingsModal({ isOpen, onClose, apiKey, setApiKey, systemInstruction, setSystemInstruction, selectedModel, setSelectedModel }) {
  const [localApiKey, setLocalApiKey] = useState(apiKey);
  const [localInstruction, setLocalInstruction] = useState(systemInstruction);
  const [localModel, setLocalModel] = useState(selectedModel); 
  useEffect(() => { setLocalApiKey(apiKey); }, [apiKey]);
  useEffect(() => { setLocalInstruction(systemInstruction); }, [systemInstruction]);
  useEffect(() => { setLocalModel(selectedModel); }, [selectedModel]); 
  if (!isOpen) return null;
  const handleSave = () => { setApiKey(localApiKey); setSystemInstruction(localInstruction); setSelectedModel(localModel); localStorage.setItem('gemini-api-key', localApiKey); localStorage.setItem('gemini-system-instruction', localInstruction); localStorage.setItem('gemini-selected-model', localModel); onClose(); };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 backdrop-blur-sm">
      <div className="bg-neutral-900 rounded-2xl shadow-2xl w-full max-w-2xl p-8 border border-neutral-800 animate-fade-in">
        <h2 className="text-2xl font-bold text-white mb-8">설정</h2>
        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-300 mb-2">Gemini API 키</label>
          <input type="password" value={localApiKey} onChange={(e) => setLocalApiKey(e.target.value)} className="w-full px-4 py-3 bg-neutral-800 text-white rounded-xl border border-neutral-700 outline-none focus:ring-2 focus:ring-green-500" placeholder="gme-..." />
        </div>
        <div className="mb-6">
          <label className="block text-sm font-medium text-gray-300 mb-2">Gemini 모델</label>
          <select value={localModel} onChange={(e) => setLocalModel(e.target.value)} className="w-full px-4 py-3 bg-neutral-800 text-white rounded-xl border border-neutral-700 outline-none focus:ring-2 focus:ring-green-500">
            <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
          </select>
        </div>
        <div className="mb-8">
          <label className="block text-sm font-medium text-gray-300 mb-2">시스템 프롬프트</label>
          <textarea rows="8" value={localInstruction} onChange={(e) => setLocalInstruction(e.target.value)} className="w-full px-4 py-3 bg-neutral-800 text-white rounded-xl border border-neutral-700 outline-none focus:ring-2 focus:ring-green-500" style={{resize:'none'}} />
        </div>
        <div className="flex justify-end space-x-4">
          <button onClick={onClose} className="bg-neutral-700 hover:bg-neutral-600 text-white font-semibold py-2 px-6 rounded-xl transition">취소</button>
          <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-xl transition">저장</button>
        </div>
      </div>
    </div>
  );
}

// 헤더
function Header({ apiKey, onLogout, pendingOperations, removeOperation, onOpenSettings }) {
  const [showOps, setShowOps] = useState(false);
  const opCount = Object.keys(pendingOperations).length;

  return (
    <header className="flex-shrink-0 bg-gray-950 border-b border-neutral-800 flex items-center justify-between p-4 h-16">
      <div className="flex items-center space-x-3"><IconGemini /><h1 className="text-xl font-bold text-white">File Store</h1></div>
      <div className="flex items-center space-x-4">
        <div className="relative">
          <button onClick={() => setShowOps(!showOps)} className="relative p-2 rounded-full text-gray-400 hover:text-white hover:bg-neutral-800">
            <IconUploadQueue />{opCount > 0 && <span className="absolute top-0 right-0 block h-5 w-5 rounded-full text-xs flex items-center justify-center bg-green-600 text-white ring-2 ring-gray-950">{opCount}</span>}
          </button>
          {showOps && opCount > 0 && (
            <div className="absolute right-0 mt-2 w-80 bg-neutral-900 border border-neutral-700 rounded-xl shadow-2xl z-50">
              <div className="p-4 border-b border-neutral-700"><h3 className="font-semibold text-white">진행중인 작업</h3></div>
              <ul className="max-h-64 overflow-y-auto">
                {Object.values(pendingOperations).map(op => (
                  <li key={op.id} className="p-4 border-b border-neutral-800 last:border-b-0">
                    <div className="flex items-center justify-between"><span className="text-sm text-gray-300 w-3/4 truncate">{op.description}</span><button onClick={() => removeOperation(op.id)} className="text-xs text-red-400">닫기</button></div>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
        <span className="text-sm text-gray-500 hidden sm:block">API: ...{apiKey.slice(-4)}</span>
        <button onClick={onOpenSettings} className="p-2 rounded-full text-gray-400 hover:text-white hover:bg-neutral-800"><IconSettings /></button>
        <button onClick={onLogout} className="bg-neutral-800 hover:bg-red-700 hover:text-white text-gray-300 text-sm font-semibold py-2 px-4 rounded-xl transition">로그아웃</button>
      </div>
    </header>
  );
}

// 사이드바
function ChatSidebar({ chats, selectedChat, onSelectChat, onCreateNewChat, onDeleteChat, onUpdateChat, onNavigateBack, currentStoreName }) {
  const [editingChatId, setEditingChatId] = useState(null);
  const [newTitle, setNewTitle] = useState('');
  const handleStartEdit = (chat) => { setEditingChatId(chat.id); setNewTitle(chat.title); };
  const handleSaveEdit = (chat) => { if (newTitle.trim()) { onUpdateChat({ ...chat, title: newTitle.trim() }); } setEditingChatId(null); };
  const filteredChats = chats.filter(c => c.storeName === selectedChat.storeName);

  return (
    <div className="w-72 flex-shrink-0 bg-gray-950 border-r border-neutral-800 flex flex-col">
      <div className="p-4 border-b border-neutral-800 h-16 flex flex-col justify-center">
        <button onClick={onNavigateBack} className="flex items-center space-x-2 text-sm text-gray-400 hover:text-white mb-2"><IconArrowLeft /> <span>모든 프로젝트</span></button>
        <h2 className="text-lg font-semibold text-white truncate" title={currentStoreName}>{currentStoreName}</h2>
      </div>
      <div className="p-4">
        <button onClick={onCreateNewChat} className="w-full flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl transition"><IconPlus /> <span>새 채팅 시작</span></button>
      </div>
      <nav className="flex-1 overflow-y-auto px-2 py-2 space-y-1">
        {filteredChats.map(chat => (
          <div key={chat.id} className={`group flex items-center justify-between p-3 rounded-xl cursor-pointer ${selectedChat?.id === chat.id ? 'bg-green-800 text-white' : 'text-gray-300 hover:bg-neutral-800'}`}>
            {editingChatId === chat.id ? (
              <input type="text" value={newTitle} onChange={(e) => setNewTitle(e.target.value)} onBlur={() => handleSaveEdit(chat)} onKeyDown={(e) => e.key === 'Enter' && handleSaveEdit(chat)} className="flex-1 bg-neutral-700 text-white p-1 rounded-lg outline-none" autoFocus />
            ) : (
              <span className="flex-1 truncate" onClick={() => onSelectChat(chat)}>{chat.title}</span>
            )}
            <div className="flex items-center opacity-0 group-hover:opacity-100 transition">
               {editingChatId !== chat.id && <button onClick={() => handleStartEdit(chat)} className="p-1 hover:text-white"><IconEdit /></button>}
               <button onClick={() => onDeleteChat(chat.id)} className="p-1 hover:text-red-400"><IconTrash /></button>
            </div>
          </div>
        ))}
      </nav>
    </div>
  );
}

// 스토어 목록
function FileSearchStoreList({ stores, onCreateStore, onDeleteStore, onSelectStoreForDocs, onSelectStoreForChat, deletingStoreName }) {
  const [newStoreName, setNewStoreName] = useState('');
  const handleSubmit = (e) => { e.preventDefault(); if (newStoreName.trim()) { onCreateStore(newStoreName.trim()); setNewStoreName(''); } };

  return (
    <div className="animate-fade-in">
      <div className="mb-10 p-8 bg-neutral-900 rounded-2xl shadow-xl border border-neutral-800">
        <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
          <input type="text" value={newStoreName} onChange={(e) => setNewStoreName(e.target.value)} className="flex-1 px-5 py-3 bg-neutral-800 text-white rounded-xl border border-neutral-700 outline-none focus:ring-2 focus:ring-green-500" placeholder="새 프로젝트 이름" />
          <button type="submit" className="flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition"><IconPlus /> <span>생성</span></button>
        </form>
      </div>
      <h2 className="text-3xl font-bold text-white mb-8">프로젝트 대시보드 ({stores.length})</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {stores.map(store => (
          <div key={store.name} className="bg-neutral-900 border border-neutral-800 rounded-2xl shadow-xl p-6 flex flex-col justify-between transition hover:border-neutral-700">
            <div>
              <h3 className="text-xl font-bold text-white mb-2 truncate">{store.displayName}</h3>
              <p className="text-sm text-gray-500 truncate mb-6">{store.name}</p>
              <div className="flex space-x-6 text-sm text-gray-400 mb-8">
                <span className="flex items-center space-x-2"><IconFile /> <span>{store.activeDocumentsCount || 0} Docs</span></span>
                <span className="flex items-center space-x-2"><IconFolder /> <span>{formatBytes(store.sizeBytes)}</span></span>
              </div>
            </div>
            <div className="flex justify-between items-center">
              <div className="flex items-center space-x-2">
                <button onClick={() => onSelectStoreForDocs(store)} className="bg-neutral-800 hover:bg-neutral-700 text-gray-400 hover:text-white p-2 rounded-xl transition"><IconFolder /></button>
                <button onClick={() => onSelectStoreForChat(store)} className="bg-neutral-800 hover:bg-neutral-700 text-gray-400 hover:text-white p-2 rounded-xl transition"><IconChat /></button>
              </div>
              <button onClick={() => onDeleteStore(store.name)} disabled={deletingStoreName === store.name} className="bg-neutral-800 hover:bg-red-700 text-gray-400 hover:text-white p-2 rounded-xl transition disabled:opacity-50">
                {deletingStoreName === store.name ? <IconSpinner /> : <IconTrash />}
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// 문서 목록
function DocumentList({ store, documents, onDeleteDocument, onUploadFiles, onSelectDocument, onBack, isLoading, onSelectStoreForSearch }) {
  const [uploadQueue, setUploadQueue] = useState([]); 
  const [isDragging, setIsDragging] = useState(false);
  const fileInputRef = useRef(null);
  const handleFilesChange = (files) => { if (files && files.length > 0) setUploadQueue(prev => [...prev, ...Array.from(files)]); };
  const handleUploadAll = () => { if(uploadQueue.length > 0) { onUploadFiles(store.name, uploadQueue); setUploadQueue([]); } };
  const handleDrop = (e) => { e.preventDefault(); setIsDragging(false); handleFilesChange(e.dataTransfer.files); };

  return (
    <div className={`animate-fade-in ${isDragging ? 'drag-over' : ''}`} onDragOver={(e) => {e.preventDefault(); setIsDragging(true)}} onDragLeave={() => setIsDragging(false)} onDrop={handleDrop}>
      <button onClick={onBack} className="flex items-center space-x-2 text-sm text-green-400 hover:text-green-300 mb-8"><IconArrowLeft /> <span>돌아가기</span></button>
      <div className="flex justify-between items-center mb-8">
        <h2 className="text-3xl font-bold text-white">문서: <span className="text-green-400">{store.displayName}</span></h2>
        <button onClick={() => onSelectStoreForSearch(store)} className="flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-5 rounded-xl transition text-sm" disabled={documents.length === 0 || isLoading}><IconSearch /> <span>전체 검색</span></button>
      </div>
      
      <div className={`mb-10 p-8 bg-neutral-900 rounded-2xl shadow-xl border border-neutral-800 transition`}>
        <input type="file" ref={fileInputRef} onChange={(e) => handleFilesChange(e.target.files)} multiple className="hidden" id="file-upload" />
        <label htmlFor="file-upload" className="cursor-pointer block text-center p-10 border-2 border-dashed border-neutral-700 rounded-xl">
          <i className="bi bi-cloud-arrow-up text-5xl text-gray-500 block mb-3"></i>
          <p className="text-lg text-green-400 font-semibold">파일 선택</p>
          <p className="text-sm text-gray-400 mt-1">또는 드래그 앤 드롭</p>
        </label>
        {uploadQueue.length > 0 && (
          <div className="mt-8">
            <h4 className="font-semibold text-white mb-3">대기열 ({uploadQueue.length})</h4>
            <ul className="max-h-64 overflow-y-auto space-y-2 bg-neutral-800 p-3 rounded-xl border border-neutral-700">
              {uploadQueue.map((f, i) => <li key={i} className="flex justify-between items-center text-sm text-gray-300 bg-neutral-700 p-3 rounded-lg"><span>{f.name}</span><button onClick={()=>{setUploadQueue(uploadQueue.filter((_,idx)=>idx!==i))}} className="text-red-400"><IconXCircle/></button></li>)}
            </ul>
            <button onClick={handleUploadAll} className="w-full mt-6 flex justify-center items-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition"><IconCloudUpload /> <span>모두 업로드</span></button>
          </div>
        )}
      </div>

      <div className="bg-neutral-900 rounded-2xl shadow-xl border border-neutral-800 overflow-hidden">
        <table className="w-full border-collapse">
          <thead className="bg-neutral-800 text-left text-xs text-gray-400 uppercase tracking-wider">
            <tr><th className="px-6 py-4 font-medium">이름</th><th className="px-6 py-4 font-medium">상태</th><th className="px-6 py-4 font-medium">크기</th><th className="px-6 py-4 text-right font-medium">작업</th></tr>
          </thead>
          <tbody className="divide-y divide-neutral-800">
            {isLoading && !documents.length ? <tr><td colSpan="4" className="text-center py-10 text-gray-400"><div className="flex justify-center"><IconSpinner /></div></td></tr> :
              documents.map(doc => (
                <tr key={doc.name} className="hover:bg-neutral-800 transition">
                  <td className="px-6 py-4 text-sm font-medium text-white">{doc.displayName}</td>
                  <td className="px-6 py-4"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${doc.state==='ACTIVE'?'bg-green-900 text-green-300':'bg-yellow-900 text-yellow-300'}`}>{doc.state}</span></td>
                  <td className="px-6 py-4 text-sm text-gray-300">{formatBytes(doc.sizeBytes)}</td>
                  <td className="px-6 py-4 text-right space-x-4">
                    <button onClick={() => onSelectDocument(doc)} className="text-green-400 hover:text-green-300 disabled:opacity-50" disabled={doc.state!=='ACTIVE'}><IconSearch /></button>
                    <button onClick={() => onDeleteDocument(doc.name)} className="text-red-400 hover:text-red-300"><IconTrash /></button>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  );
}

// 문서 검색
function DocumentSearch({ document, apiKey, onBack }) {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const handleSearch = async (e) => { e.preventDefault(); setIsLoading(true); try { const data = await apiRequest(`${document.name}:query`, { method: 'POST', body: JSON.stringify({ query, resultsCount: 10 }) }, apiKey); setResults(data.relevantChunks || []); } catch (err) { console.error(err); } finally { setIsLoading(false); } };

  return (
    <div className="animate-fade-in">
      <button onClick={onBack} className="flex items-center space-x-2 text-sm text-green-400 hover:text-green-300 mb-8"><IconArrowLeft /> <span>돌아가기</span></button>
      <h2 className="text-3xl font-bold text-white mb-2">검색: <span className="text-green-400">{document.displayName}</span></h2>
      <div className="mb-10 p-8 bg-neutral-900 rounded-2xl shadow-xl border border-neutral-800">
        <form onSubmit={handleSearch} className="flex space-x-4">
          <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} className="flex-1 px-5 py-3 bg-neutral-800 text-white rounded-xl border border-neutral-700 outline-none focus:ring-2 focus:ring-green-500" placeholder="검색어..." disabled={isLoading} />
          <button type="submit" className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition disabled:opacity-50" disabled={isLoading}>{isLoading ? <IconSpinner /> : <IconSearch />}</button>
        </form>
      </div>
      <div className="bg-neutral-900 rounded-2xl shadow-xl border border-neutral-800 p-8 space-y-5">
        {results.map((chunk, i) => (
          <div key={i} className="bg-neutral-800 border border-neutral-700 rounded-xl p-5">
            <p className="text-sm text-green-400 mb-2 font-mono">ID: ...{chunk.chunk.name.split('/').pop()}</p>
            <p className="text-gray-300 whitespace-pre-wrap">{chunk.chunk.text}</p>
          </div>
        ))}
      </div>
    </div>
  );
}

// 스토어 검색
function StoreSearch({ store, documents, apiKey, onBack, selectedModel }) { 
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]); 
  const [isLoading, setIsLoading] = useState(false);
  const [status, setStatus] = useState(''); 

  const handleSearch = async (e) => {
    e.preventDefault(); setIsLoading(true); setResults([]); setStatus('필터링 중...');
    try {
      const docNames = documents.map(d => d.displayName || d.name.split('/').pop());
      const prompt = `Query: "${query}"\nDocs: [${docNames.join(', ')}]\nReturn relevant doc names from list as comma-separated string. If none, return "None".`;
      const filterResp = await apiGeminiFilter(prompt, apiKey, selectedModel);
      
      if (!filterResp || filterResp.includes('None')) { setStatus('관련 문서 없음'); setIsLoading(false); return; }
      const targets = documents.filter(d => filterResp.includes(d.displayName));
      if(!targets.length) { setStatus('매칭 문서 없음'); setIsLoading(false); return; }

      setStatus(`${targets.length}개 문서 검색 중...`);
      const promises = targets.map(d => apiRequest(`${d.name}:query`, { method: 'POST', body: JSON.stringify({ query, resultsCount: 10 }) }, apiKey));
      const resps = await Promise.allSettled(promises);
      const hits = [];
      resps.forEach((r, i) => { if(r.status === 'fulfilled' && r.value.relevantChunks) hits.push(...r.value.relevantChunks.map(c => ({...c, doc: targets[i].displayName}))); });
      setResults(hits); setStatus(hits.length ? '완료' : '결과 없음');
    } catch (err) { setStatus('오류 발생'); } finally { setIsLoading(false); }
  };

  return (
    <div className="animate-fade-in">
      <button onClick={onBack} className="flex items-center space-x-2 text-sm text-green-400 hover:text-green-300 mb-8"><IconArrowLeft /> <span>돌아가기</span></button>
      <h2 className="text-3xl font-bold text-white mb-2">스토어 검색: <span className="text-green-400">{store.displayName}</span></h2>
      <div className="mb-10 p-8 bg-neutral-900 rounded-2xl shadow-xl border border-neutral-800">
        <form onSubmit={handleSearch} className="flex space-x-4">
          <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} className="flex-1 px-5 py-3 bg-neutral-800 text-white rounded-xl border border-neutral-700 outline-none focus:ring-2 focus:ring-green-500" placeholder="전체 검색..." disabled={isLoading} />
          <button type="submit" className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition disabled:opacity-50" disabled={isLoading}>{isLoading ? <IconSpinner /> : <IconSearch />}</button>
        </form>
      </div>
      <div className="bg-neutral-900 rounded-2xl shadow-xl border border-neutral-800 p-8 space-y-5">
        {status && <p className="text-gray-400 mb-4">{status}</p>}
        {results.map((item, i) => (
          <div key={i} className="bg-neutral-800 border border-neutral-700 rounded-xl p-5">
             <p className="text-sm text-green-400 mb-2 font-bold">[{item.doc}]</p>
             <p className="text-gray-300 whitespace-pre-wrap">{item.chunk.text}</p>
          </div>
        ))}
      </div>
    </div>
  );
}

// 채팅 인터페이스
function ChatInterface({ chat, apiKey, systemInstruction, onUpdateChat, selectedModel }) { 
  const [messages, setMessages] = useState(chat.messages || []);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const endRef = useRef(null);

  useEffect(() => { endRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isLoading]);

  const handleSubmit = async (e) => {
    e.preventDefault(); if (!input.trim() || isLoading) return;
    const newMsgs = [...messages, { role: 'user', text: input.trim() }];
    setMessages(newMsgs); setInput(''); setIsLoading(true);
    try {
      const payload = {
        systemInstruction: { parts: [{ text: systemInstruction }] },
        contents: [...newMsgs.map(m => ({ role: m.role, parts: [{ text: m.text }] }))],
        tools: [{ fileSearch: { fileSearchStoreNames: [chat.storeName] } }]
      };
      const data = await apiRequest(`models/${selectedModel}:generateContent`, { method: 'POST', body: JSON.stringify(payload) }, apiKey);
      const botMsg = { role: 'model', text: data.candidates[0].content.parts[0].text, groundingMetadata: data.candidates[0].groundingMetadata };
      const finalMsgs = [...newMsgs, botMsg];
      setMessages(finalMsgs); onUpdateChat({ ...chat, messages: finalMsgs });
    } catch (err) { console.error(err); } finally { setIsLoading(false); }
  };

  const ChatMsg = ({ msg }) => {
    const html = useMemo(() => window.marked ? window.marked.parse(msg.text) : msg.text, [msg.text]);
    return (
      <div className={`w-full ${msg.role==='user'?'bg-neutral-800':'bg-neutral-900'}`}>
        <div className="max-w-4xl mx-auto px-6 py-7 flex space-x-5">
          <div className="flex-shrink-0 w-8 h-8 rounded-full bg-neutral-700 flex items-center justify-center">{msg.role==='user'?<IconUser/>:<IconGemini/>}</div>
          <div className="flex-1 overflow-hidden">
            <div className="prose prose-invert max-w-none" dangerouslySetInnerHTML={{__html:html}}/>
            {msg.groundingMetadata?.groundingAttributions?.length > 0 && (
               <div className="mt-5 pt-4 border-t border-neutral-700 flex flex-wrap gap-2">
                 {msg.groundingMetadata.groundingAttributions.map((a,i) => (
                   <a key={i} href={a.web?.uri} target="_blank" className="flex items-center space-x-1 text-xs bg-green-900 bg-opacity-50 text-green-300 px-3 py-1 rounded-full hover:bg-green-800">
                     <span>{a.file?.displayName || '출처'}</span><IconExternalLink/>
                   </a>
                 ))}
               </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="flex flex-col h-full animate-fade-in bg-neutral-900">
      <div className="flex-1 overflow-y-auto">
        {messages.length === 0 && !isLoading && <div className="flex h-full items-center justify-center text-gray-500">무엇이든 물어보세요.</div>}
        {messages.map((m, i) => <ChatMsg key={i} msg={m} />)}
        {isLoading && <div className="w-full bg-neutral-900"><div className="max-w-4xl mx-auto px-6 py-7 flex space-x-5"><div className="w-8 h-8 rounded-full bg-neutral-700 flex justify-center items-center"><IconGemini/></div><div className="flex items-center text-gray-400"><IconSpinner/><span className="ml-3">생각 중...</span></div></div></div>}
        <div ref={endRef} />
      </div>
      <div className="flex-shrink-0 p-4 bg-neutral-900 border-t border-neutral-800">
        <form onSubmit={handleSubmit} className="max-w-4xl mx-auto flex items-end space-x-4">
          <textarea rows="1" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSubmit(e)}}} className="flex-1 px-4 py-3 bg-neutral-800 text-white rounded-xl border border-neutral-700 outline-none focus:ring-2 focus:ring-green-500 resize-none overflow-y-auto" style={{maxHeight:'200px'}} placeholder="질문 입력..." disabled={isLoading}/>
          <button type="submit" className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition disabled:opacity-50" disabled={isLoading||!input.trim()}>전송</button>
        </form>
      </div>
    </div>
  );
}

function App() {
  const [apiKey, setApiKey] = useState(localStorage.getItem('gemini-api-key') || '');
  const [systemInstruction, setSystemInstruction] = useState(localStorage.getItem('gemini-system-instruction') || '출처를 명시하세요.');
  const [selectedModel, setSelectedModel] = useState(localStorage.getItem('gemini-selected-model') || 'gemini-2.5-flash');
  const [apiKeyValid, setApiKeyValid] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [currentView, setCurrentView] = useState('STORES');
  const [selectedStore, setSelectedStore] = useState(null);
  const [selectedDoc, setSelectedDoc] = useState(null);
  const [selectedChat, setSelectedChat] = useState(null);
  const [stores, setStores] = useState([]);
  const [documents, setDocuments] = useState([]);
  const [chats, setChats] = useState([]);
  const [pendingOperations, setPendingOperations] = useState({});
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [deletingStoreName, setDeletingStoreName] = useState(null);

  const validateApiKey = async (key) => { 
    if (!key) { setIsLoading(false); return; }
    setIsLoading(true);
    try { await apiRequest('fileSearchStores', { method: 'GET' }, key); setApiKeyValid(true); } catch { setApiKeyValid(false); } finally { setIsLoading(false); }
  };
  useEffect(() => { validateApiKey(apiKey); }, [apiKey]);
  useEffect(() => { if (apiKeyValid) { listStores(); loadChats(); } }, [apiKeyValid]);

  const listStores = async () => { const data = await apiRequest('fileSearchStores', {}, apiKey); setStores(data.fileSearchStores || []); };
  const createStore = async (name) => { await apiRequest('fileSearchStores', { method: 'POST', body: JSON.stringify({ displayName: name }) }, apiKey); listStores(); };
  const deleteStore = async (name) => { setDeletingStoreName(name); try { await apiRequest(name, { method: 'DELETE', params: { force: true } }, apiKey); listStores(); } finally { setDeletingStoreName(null); } };
  const listDocuments = async (name) => { const data = await apiRequest(`${name}/documents`, {}, apiKey); setDocuments(data.documents || []); };
  const uploadFiles = async (storeName, files) => { for(const f of files) { const opId = Math.random(); setPendingOperations(p=>({...p, [opId]:{id:opId, description:`${f.name} 업로드`}})); await apiUploadRequest(`${storeName}:uploadToFileSearchStore`, f, {displayName:f.name}, apiKey); setPendingOperations(p=>{const n={...p}; delete n[opId]; return n;}); } listDocuments(storeName); };
  const deleteDocument = async (name) => { await apiRequest(name, { method: 'DELETE' }, apiKey); if(selectedStore) listDocuments(selectedStore.name); };
  const loadChats = async () => { setChats(await getChatsFromDB()); };
  const createNewChat = (store) => { const c = { id: crypto.randomUUID(), storeName: store.name, storeDisplayName: store.displayName, title: '새 채팅', messages: [] }; setChats([c, ...chats]); setSelectedChat(c); saveChatToDB(c); setCurrentView('CHAT'); };
  const updateChat = (c) => { setSelectedChat(c); saveChatToDB(c); setChats(chats.map(chat => chat.id === c.id ? c : chat)); };
  const deleteChat = (id) => { deleteChatFromDB(id); setChats(chats.filter(c => c.id !== id)); if(selectedChat?.id === id) setCurrentView('STORES'); };

  if (isLoading) return <div className="h-screen flex items-center justify-center text-white"><IconSpinner /></div>;
  if (!apiKey || !apiKeyValid) return (
    <div className="h-screen flex items-center justify-center bg-gray-950 p-4">
      <div className="w-full max-w-md p-10 bg-neutral-900 rounded-2xl shadow-2xl border border-neutral-800">
        <h1 className="text-3xl font-bold text-center text-white mb-8">Gemini File Store</h1>
        <input type="password" className="w-full px-4 py-3 bg-neutral-800 text-white rounded-xl border border-neutral-700 outline-none focus:ring-2 focus:ring-green-500" placeholder="API Key" onBlur={(e)=>setApiKey(e.target.value)} />
        <button className="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition" onClick={()=>validateApiKey(apiKey)}>시작하기</button>
      </div>
    </div>
  );

  return (
    <div className="flex h-screen bg-gray-950 text-gray-200">
      <SettingsModal isOpen={isSettingsOpen} onClose={()=>setIsSettingsOpen(false)} apiKey={apiKey} setApiKey={setApiKey} systemInstruction={systemInstruction} setSystemInstruction={setSystemInstruction} selectedModel={selectedModel} setSelectedModel={setSelectedModel} />
      {currentView === 'CHAT' && <ChatSidebar chats={chats} selectedChat={selectedChat} onSelectChat={(c)=>{setSelectedChat(c); setCurrentView('CHAT');}} onCreateNewChat={()=>createNewChat(selectedStore)} onDeleteChat={deleteChat} onUpdateChat={updateChat} onNavigateBack={()=>setCurrentView('STORES')} currentStoreName={selectedStore?.displayName} />}
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header apiKey={apiKey} onLogout={()=>{setApiKey(''); setApiKeyValid(false);}} pendingOperations={pendingOperations} removeOperation={(id)=>setPendingOperations(p=>{const n={...p};delete n[id];return n;})} onOpenSettings={()=>setIsSettingsOpen(true)} />
        <main className={`flex-1 w-full ${currentView !== 'CHAT' ? 'overflow-y-auto p-6 md:p-10' : 'overflow-hidden h-full'}`}>
           <div className={`h-full ${currentView !== 'CHAT' ? 'max-w-7xl mx-auto' : 'w-full'}`}>
            {currentView === 'STORES' && <FileSearchStoreList stores={stores} onCreateStore={createStore} onDeleteStore={deleteStore} onSelectStoreForDocs={(s)=>{setSelectedStore(s); listDocuments(s.name); setCurrentView('DOCS');}} onSelectStoreForChat={(s)=>{setSelectedStore(s); const exist=chats.find(c=>c.storeName===s.name); if(exist){setSelectedChat(exist); setCurrentView('CHAT');}else{createNewChat(s);}}} deletingStoreName={deletingStoreName} />}
            {currentView === 'DOCS' && <DocumentList store={selectedStore} documents={documents} onDeleteDocument={deleteDocument} onUploadFiles={uploadFiles} onSelectDocument={(d)=>{setSelectedDoc(d); setCurrentView('DOC_SEARCH');}} onBack={()=>setCurrentView('STORES')} onSelectStoreForSearch={(s)=>{setSelectedStore(s); setCurrentView('STORE_SEARCH');}} />}
            {currentView === 'DOC_SEARCH' && <DocumentSearch document={selectedDoc} apiKey={apiKey} onBack={()=>setCurrentView('DOCS')} />}
            {currentView === 'STORE_SEARCH' && <StoreSearch store={selectedStore} documents={documents} apiKey={apiKey} onBack={()=>setCurrentView('DOCS')} selectedModel={selectedModel} />}
            {currentView === 'CHAT' && <ChatInterface chat={selectedChat} apiKey={apiKey} systemInstruction={systemInstruction} onUpdateChat={updateChat} selectedModel={selectedModel} />}
          </div>
        </main>
      </div>
    </div>
  );
}

const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(<App />);

})(); // IIFE END
    </script>
</body>
</html>
