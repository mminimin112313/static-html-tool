<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logify Reborn v1.2.5 | Journal Save Fix</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Pretendard -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Day.js for date handling -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <!-- Quill Editor for rich text -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .ql-toolbar { border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; border-color: #d1d5db; background-color: #f9fafb; }
        .ql-container { border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem; border-color: #d1d5db; min-height: 150px; font-size: 1rem; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Dashboard Grid Styling */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: 100px;
            gap: 16px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-28 md:pb-24">

    <header id="main-header" class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 border-b border-slate-200/80">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="header-main-content" class="flex justify-between items-center w-full h-16">
                <div class="flex items-center gap-2">
                    <i data-lucide="notebook-pen" class="w-7 h-7 text-blue-600"></i>
                    <span class="logo text-2xl font-bold text-slate-900 tracking-tight">Logify</span>
                </div>
                <div class="controls flex items-center gap-2">
                    <input type="date" id="date-picker" class="bg-slate-100 border-transparent rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm">
                    <button class="icon-button w-10 h-10 flex items-center justify-center rounded-full transition-colors hover:bg-slate-200" id="search-btn" title="검색">
                        <i data-lucide="search" class="w-5 h-5 text-slate-600"></i>
                    </button>
                </div>
            </div>
    
            <div id="search-bar" class="hidden w-full items-center gap-4 h-16">
                <div class="relative w-full">
                    <i data-lucide="search" class="w-5 h-5 text-slate-400 absolute top-1/2 left-4 -translate-y-1/2"></i>
                    <input type="text" id="search-input" placeholder="타임라인에서 검색... (#태그명 으로 검색)" class="w-full h-11 pl-12 pr-4 bg-slate-100 rounded-xl border-transparent focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-white transition">
                </div>
                <button class="cancel-search-btn text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors flex-shrink-0">취소</button>
            </div>
        </div>
    </header>
    
    <div class="main-container max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex gap-6">
        <aside id="action-rail" class="flex-shrink-0 flex flex-col items-center gap-2 pt-2"></aside>
        <main id="main-content" class="flex-grow min-w-0"></main>
    </div>

    <footer id="command-bar-wrapper" class="fixed bottom-0 left-0 right-0 z-[1000]">
        <div class="max-w-3xl mx-auto p-2 sm:p-3">
            <div class="bg-white/80 backdrop-blur-xl rounded-xl shadow-2xl shadow-slate-400/20 ring-1 ring-slate-900/5 flex flex-col">
                <div id="suggestion-box"></div>
                <div id="dynamic-form-container" class="p-4 grid gap-4"></div>
                <input type="text" id="command-bar-input" placeholder="+ 지금 무엇을 기록할까요?" class="w-full h-14 px-5 text-base bg-transparent border-0 focus:ring-0 placeholder-slate-400">
            </div>
        </div>
    </footer>
    
    <div id="modal-container"></div>

    <script>
    // =================================================================================
    // STATE & CONFIGURATION 
    // =================================================================================
    // [수정] 기존 state 객체를 아래 내용으로 교체하십시오.
    const state = {
        definitions: [],
        currentDate: dayjs().format('YYYY-MM-DD'),
        currentView: 'timeline',
        activeDefinitionId: null, 
        lastLoadedDate: null, 
        loadedEntries: new Map(),
        visibleTimelineDates: [],
        isLoadingMore: false,
        workspace: {
            selectedDefId: null, searchQuery: '',
            expandedNodes: new Set(), viewMode: 'list',
        },
        dashboard: { widgets: [] },
        chartInstances: new Map(),
        calendar: {
            viewMonth: dayjs().format('YYYY-MM-DD'),
            selectionStart: null,
            selectionEnd: null,
        },
        // --- [추가된 Firebase 상태] ---
        user: null, // 현재 로그인된 사용자 정보
        firebaseConfig: null, // Firebase 설정 객체
        isFirebaseReady: false, // Firebase 초기화 완료 여부
        firestoreUnsubscribes: [], // 실시간 리스너 구독 해제 함수 배열
    };
    let db;
    let quill; 
    let fbApp;
    let fbAuth;
    let fbDb;

    const DB_NAME = 'LogifyRebornDB_v1_2_5', DB_VERSION = 1;

    const RAIL_CONFIG = [
        { id: 'timeline', tooltip: '타임라인', icon: 'list-ordered' },
        { id: 'dashboard', tooltip: '대시보드', icon: 'layout-dashboard' },
        { id: 'workspace', tooltip: '워크스페이스', icon: 'folder-kanban' },
        { id: 'calendar', tooltip: '캘린더', icon: 'calendar-days' }
    ];

    const $ = selector => document.querySelector(selector);
    const elements = {
        mainHeader: $('#main-header'), headerMainContent: $('#header-main-content'),
        searchBar: $('#search-bar'), searchInput: $('#search-input'), cancelSearchBtn: $('.cancel-search-btn'),
        datePicker: $('#date-picker'), mainContent: $('#main-content'),
        commandBarWrapper: $('#command-bar-wrapper'), commandBarInput: $('#command-bar-input'),
        suggestionBox: $('#suggestion-box'), dynamicFormContainer: $('#dynamic-form-container'),
        searchBtn: $('#search-btn'), actionRail: $('#action-rail'), modalContainer: $('#modal-container'),
        settingsBtn: $('#settings-btn'), logoutBtn: $('#logout-btn'),
        appOverlay: $('#app-overlay'), loginContainer: $('#login-container'), loginBtn: $('#login-btn'),
        loaderContainer: $('#loader-container'),
    };
    
    // =================================================================================
    // UTILITIES & DATABASE 
    // =================================================================================
    const configManager = {
        save: (config) => {
            try {
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                return true;
            } catch (e) {
                console.error("Error saving config to localStorage", e);
                return false;
            }
        },
        load: () => {
            try {
                const configStr = localStorage.getItem('firebaseConfig');
                return configStr ? JSON.parse(configStr) : null;
            } catch (e) {
                console.error("Error loading config from localStorage", e);
                return null;
            }
        },
        isValid: (config) => {
            const requiredKeys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            return config && requiredKeys.every(key => config[key] && typeof config[key] === 'string' && config[key].trim() !== '');
        }
    };

    const firebaseUtils = {
        init: (config) => {
            try {
                if (fbApp) return; // 이미 초기화되었다면 중복 실행 방지
                fbApp = firebase.initializeApp(config);
                fbAuth = firebase.getAuth(fbApp);
                fbDb = firebase.getFirestore(fbApp);
                state.isFirebaseReady = true;
                console.log("Firebase initialized successfully.");
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Firebase 설정이 올바르지 않습니다. 설정을 확인해주세요.");
                state.isFirebaseReady = false;
                ui.showSettingsModal();
            }
        },
        // 컬렉션 경로를 생성하는 헬퍼 함수
        _getCollectionPath: (store) => {
            if (!state.user) throw new Error("Authentication required.");
            return `users/${state.user.uid}/${store}`;
        },

        save: (store, data) => {
            const docRef = firebase.doc(fbDb, firebaseUtils._getCollectionPath(store), data.id.toString());
            return firebase.setDoc(docRef, data, { merge: true });
        },
        saveEntry: async (entry) => {
            const date = dayjs(entry.timestamp).format('YYYY-MM-DD');
            const docRef = firebase.doc(fbDb, firebaseUtils._getCollectionPath('entries'), date);
            // Firestore 트랜잭션을 사용하여 데이터 무결성 보장 (읽기-수정-쓰기)
            return firebase.runTransaction(fbDb, async (transaction) => {
                const docSnap = await transaction.get(docRef);
                if (!docSnap.exists()) {
                    transaction.set(docRef, { entries: [entry] });
                } else {
                    const existingEntries = docSnap.data().entries || [];
                    const entryIndex = existingEntries.findIndex(e => e.id === entry.id);
                    if (entryIndex > -1) {
                        // 수정
                        existingEntries[entryIndex] = entry;
                    } else {
                        // 추가
                        existingEntries.push(entry);
                    }
                    transaction.update(docRef, { entries: existingEntries });
                }
            });
        },
        get: (store, key) => {
            const docRef = firebase.doc(fbDb, firebaseUtils._getCollectionPath(store), key.toString());
            return firebase.getDoc(docRef).then(docSnap => docSnap.exists() ? docSnap.data() : null);
        },
        getAll: async (store) => {
            const collRef = firebase.collection(fbDb, firebaseUtils._getCollectionPath(store));
            const snapshot = await firebase.getDocs(collRef);
            return snapshot.docs.map(doc => doc.data());
        },
        delete: (store, key) => {
            const docRef = firebase.doc(fbDb, firebaseUtils._getCollectionPath(store), key.toString());
            return firebase.deleteDoc(docRef);
        },
        deleteEntry: async (id, timestamp) => {
            const date = dayjs(timestamp).format('YYYY-MM-DD');
            const docRef = firebase.doc(fbDb, firebaseUtils._getCollectionPath('entries'), date);
             return firebase.runTransaction(fbDb, async (transaction) => {
                const docSnap = await transaction.get(docRef);
                if (!docSnap.exists()) return;
                
                const existingEntries = docSnap.data().entries || [];
                const updatedEntries = existingEntries.filter(e => e.id !== id);
                
                if (updatedEntries.length === 0) {
                    transaction.delete(docRef); // 항목이 없으면 문서 자체를 삭제
                } else {
                    transaction.update(docRef, { entries: updatedEntries });
                }
            });
        }
    };

    // =================================================================================
    // UI RENDERING MODULE
    // =================================================================================
    const ui = {
        refreshIcons: () => {
            lucide.createIcons();
        },
        renderMainContent: () => {
            const viewId = state.currentView;
            elements.mainContent.className = 'flex-grow min-w-0';
            const renderMap = {
                'timeline': ui.renderTimeline, 'dashboard': ui.renderDashboard,
                'workspace': ui.renderWorkspace, 'calendar': ui.renderCalendar,
                'definition-dashboard': ui.renderDefinitionDashboard // [추가]
            };
            const renderFn = renderMap[viewId] || (() => elements.mainContent.innerHTML = `<h2 class="text-xl font-semibold p-8">뷰를 찾을 수 없습니다.</h2>`);
            renderFn(state.calendarDate);
            ui.updateActiveRailIcon();
        },
        renderTimeline: () => {
            elements.mainContent.innerHTML = '<div id="timeline-container" class="space-y-4"></div>';
            logic.loadDataForDate(state.currentDate);
        },
        renderMoreEntries: (daysData) => {
            const container = $('#timeline-container');
            if (!container) return;
            const fragment = document.createDocumentFragment();

            // [핵심 변경] 데이터를 항상 시간 역순으로(최신->과거) 렌더링합니다.
            daysData.forEach(day => {
                const dateHeader = document.createElement('div');
                dateHeader.className = 'timeline-date-header text-sm font-semibold text-slate-500 py-2 sticky top-[64px] bg-slate-50/80 backdrop-blur-sm z-10';
                dateHeader.textContent = dayjs(day.date).format('YYYY년 M월 D일');
                fragment.appendChild(dateHeader);
                
                // 각 날짜 안의 엔트리도 최신순으로 정렬
                const sortedEntries = [...day.entries].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                sortedEntries.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'timeline-item bg-white rounded-xl shadow-lg shadow-slate-200/50 p-4 relative group transition-all duration-300 hover:shadow-xl hover:shadow-slate-300/60';
                    item.innerHTML = ui.createTimelineItemHtml(entry);
                    fragment.appendChild(item);
                });
            });

            // 항상 타임라인의 맨 아래에 새로운(더 오래된) 데이터를 추가합니다.
            container.append(fragment);
            ui.refreshIcons();
        },
        renderSearchResults: (results) => {
            elements.mainContent.innerHTML = '<div class="bg-white p-6 rounded-xl shadow-lg"><h2 class="text-xl font-bold mb-6">전체 검색 결과</h2><div id="search-results-container" class="space-y-4"></div></div>';
            const container = $('#search-results-container');
            if (!results || results.length === 0) {
                container.innerHTML = '<p class="text-slate-500">일치하는 기록이 없습니다.</p>'; return;
            }
            const sorted = [...results].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            sorted.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'timeline-item bg-white rounded-xl shadow-lg shadow-slate-200/50 p-4 relative group transition-all duration-300 hover:shadow-xl hover:shadow-slate-300/60';
                item.innerHTML = ui.createTimelineItemHtml(entry);
                container.appendChild(item);
            });
            ui.refreshIcons();
        },
        createTimelineItemHtml: (entry) => {
            const def = entry.type === 'log' ? state.definitions.find(d => d.id === entry.definitionId) : null;
            const actionsHtml = `<div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <button class="icon-action-button w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 transition-colors" data-action="edit-entry" data-id="${entry.id}" title="수정"><i data-lucide="pencil" class="w-4 h-4 text-slate-600"></i></button>
                <button class="icon-action-button w-8 h-8 flex items-center justify-center rounded-full bg-red-50 hover:bg-red-100 transition-colors" data-action="delete-entry" data-id="${entry.id}" title="삭제"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
            </div>`;
            let contentHtml = '';
            if (entry.type === 'log' && def) {
                const body = Object.entries(entry.values).map(([k, v]) => {
                    let displayValue;
                    if (typeof v === 'string' && v.startsWith('data:image/')) {
                        displayValue = `<img src="${v}" alt="${k}" class="mt-2 rounded-lg max-w-full h-auto shadow-md">`;
                    } else if (v === null || v === undefined || v === '') {
                        displayValue = '<span class="text-slate-400">-</span>';
                    } else if (typeof v === 'boolean') {
                        displayValue = v ? '<span class="text-green-600 font-semibold">완료</span>' : '<span class="text-slate-500">미완료</span>';
                    } else {
                        displayValue = v;
                    }
                    return `<div class="flex flex-col"><strong class="font-medium text-slate-600">${k}</strong> <div class="text-slate-800">${displayValue}</div></div>`;
                }).join('');

                const tagsHtml = def.tags?.length > 0 ? `<div class="flex flex-wrap gap-2">${def.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-1 rounded-full">#${tag}</span>`).join('')}</div>` : '';
                
                const targetHtml = `<a href="#def/${def.id}" class="bg-slate-200 text-slate-800 text-xs font-bold px-2.5 py-1 rounded-full hover:bg-slate-300 transition-colors">${def.name}</a>`;

                contentHtml = `
                    <div class="flex gap-4">
                        <div class="w-14 flex-shrink-0 text-center text-sm font-semibold text-slate-500 pt-0.5">
                            ${dayjs(entry.timestamp).format('HH:mm')}
                        </div>
                        <div class="flex-grow min-w-0 border-l border-slate-200 pl-4">
                            <div class="log-body space-y-1.5 text-sm">${body}</div>
                            <div class="log-footer flex flex-wrap items-center gap-3 mt-3">
                                ${targetHtml}
                                ${tagsHtml}
                            </div>
                        </div>
                    </div>`;
            } else if (entry.type === 'journal') {
                contentHtml = `<div class="text-sm font-medium text-slate-400 mb-2">${dayjs(entry.timestamp).format('HH:mm A')}</div><div class="journal-entry prose prose-sm prose-slate max-w-none">${entry.content}</div>`;
            } else contentHtml = `<p class="text-red-500">데이터를 표시할 수 없습니다.</p>`;
            return actionsHtml + contentHtml;
        },
        initializeActionRail: () => {
            elements.actionRail.innerHTML = RAIL_CONFIG.map(config => `
                <a href="#${config.id}" class="rail-icon-button w-12 h-12 flex items-center justify-center rounded-xl transition-all duration-200 group" title="${config.tooltip}" data-view-id="${config.id}">
                    <i data-lucide="${config.icon}" class="w-6 h-6 text-slate-500 group-hover:text-blue-600 transition-colors"></i>
                </a>
            `).join('');
            ui.refreshIcons();
            ui.updateActiveRailIcon();
        },
        updateActiveRailIcon: () => {
            document.querySelectorAll('.rail-icon-button').forEach(btn => {
                const isActive = btn.dataset.viewId === state.currentView;
                btn.classList.toggle('bg-blue-100', isActive);
                btn.classList.toggle('hover:bg-slate-100', !isActive);
                const icon = btn.querySelector('svg'); 
                if (icon) {
                    icon.classList.toggle('text-blue-600', isActive);
                    icon.classList.toggle('text-slate-500', !isActive);
                }
            });
        },
        toggleSearchMode: (active) => {
            elements.headerMainContent.classList.toggle('hidden', active);
            elements.searchBar.classList.toggle('hidden', !active);
            elements.searchBar.classList.toggle('flex', active);
            if (active) elements.searchInput.focus();
            else { elements.searchInput.value = ''; state.currentView = 'timeline'; ui.renderMainContent(); }
        },
        renderWorkspace: () => {
            elements.mainContent.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-4 justify-between items-center mb-4 pb-4 border-b border-slate-200">
                     <div class="relative flex-grow w-full sm:w-auto">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 absolute top-1/2 left-4 -translate-y-1/2"></i>
                        <input type="search" id="workspace-search-input" placeholder="전체 검색... (tag:태그명 으로 필터링)" value="${state.workspace.searchQuery}" class="w-full h-11 pl-12 pr-4 bg-white rounded-xl border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm">
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <div class="flex items-center bg-slate-200 rounded-lg p-1">
                            <button data-action="set-workspace-view" data-view="list" class="workspace-view-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                            <button data-action="set-workspace-view" data-view="tree" class="workspace-view-btn px-3 py-1 text-sm font-semibold rounded-md transition-colors"><i data-lucide="list-tree" class="w-4 h-4"></i></button>
                        </div>
                        <button class="button flex-shrink-0 bg-blue-600 text-white font-semibold px-4 py-2.5 rounded-xl shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition flex items-center gap-2" data-action="add-def"><i data-lucide="plus" class="w-4 h-4"></i> 새 대상</button>
                    </div>
                </div>
                <div id="workspace-content"></div>`;
            ui.renderWorkspaceContent();
            ui.refreshIcons();
        },
        renderWorkspaceContent: () => {
            const container = $('#workspace-content');
            if (!container) return;
            document.querySelectorAll('.workspace-view-btn').forEach(btn => {
                const isActive = state.workspace.viewMode === btn.dataset.view;
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('text-blue-600', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('text-slate-600', !isActive);
            });
            if (state.workspace.viewMode === 'list') ui.renderWorkspaceList();
            else ui.renderWorkspaceTree();
            ui.refreshIcons();
        },
        renderWorkspaceList: () => {
            const container = $('#workspace-content');
            container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
            const query = state.workspace.searchQuery.toLowerCase();
            const filteredDefs = state.definitions.filter(def => def.name.toLowerCase().includes(query) || (def.tags && def.tags.some(t => t.toLowerCase().includes(query))));
            if (filteredDefs.length === 0) {
                 container.innerHTML = '<div class="text-slate-500 text-center py-16 col-span-full">일치하는 대상이 없습니다.</div>'; return;
            }
            container.innerHTML = filteredDefs.map(node => {
                const tagsHtml = node.tags?.length > 0 ? `<div class="mt-3 flex flex-wrap gap-2">${node.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">#${tag}</span>`).join('')}</div>` : '';
                const fieldsSummary = node.fields.map(f => `<span class="font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded">${f.fieldName}(${f.fieldType})</span>`).join(' ');
                const parent = node.parentId ? state.definitions.find(d => d.id === node.parentId) : null;
                const parentHtml = parent ? `<p class="text-xs text-slate-500 mt-2">부모: <span class="font-semibold">${parent.name}</span></p>` : '';
                return `
                    <div class="bg-white p-4 rounded-xl shadow-lg shadow-slate-200/50 flex flex-col">
                        <div class="flex-grow">
                            <strong class="text-slate-800 font-semibold cursor-pointer hover:text-blue-600 transition-colors" data-action="view-definition-dashboard" data-id="${node.id}">${node.name}</strong>
                            <div class="text-sm text-slate-600 mt-2 flex flex-wrap gap-2">${fieldsSummary}</div>
                            ${parentHtml} ${tagsHtml}
                        </div>
                        <div class="flex gap-2 mt-4 pt-3 border-t border-slate-100">
                            <button class="button w-full text-sm font-semibold bg-blue-50 text-blue-700 hover:bg-blue-100 px-3 py-2 rounded-lg transition" data-action="view-definition-dashboard" data-id="${node.id}">대시보드</button>
                            <button class="button w-full text-sm font-semibold bg-slate-100 text-slate-700 hover:bg-slate-200 px-3 py-2 rounded-lg transition" data-action="edit-def" data-id="${node.id}">수정</button>
                            <button class="button w-full text-sm font-semibold bg-red-50 text-red-700 hover:bg-red-100 px-3 py-2 rounded-lg transition" data-action="delete-def" data-id="${node.id}">삭제</button>
                        </div>
                    </div>`;
            }).join('');
        },
        renderDefinitionDashboard: async () => {
            const defId = state.activeDefinitionId;
            const definition = state.definitions.find(d => d.id === defId);
            if (!definition) {
                elements.mainContent.innerHTML = `<p>오류: 관찰 대상을 찾을 수 없습니다.</p>`;
                return;
            }

            // 1. 대시보드 레이아웃 렌더링
            elements.mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <div>
                        <button class="flex items-center gap-2 text-sm font-semibold text-slate-600 hover:text-blue-600" data-action="back-to-workspace">
                            <i data-lucide="arrow-left"></i> 워크스페이스로 돌아가기
                        </button>
                        <h1 class="text-2xl font-bold mt-1">${definition.name} 대시보드</h1>
                    </div>
                    <button class="button bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 flex items-center gap-2" data-action="add-widget">
                        <i data-lucide="plus" class="w-4 h-4"></i> 위젯 추가
                    </button>
                </div>
                <div id="dashboard-grid" class="dashboard-grid mb-6"></div>
                <div class="mt-6">
                    <h2 class="text-xl font-bold mb-4">기록 피드</h2>
                    <div class="relative mb-4">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 absolute top-1/2 left-4 -translate-y-1/2"></i>
                        <input type="text" id="feed-search-input" placeholder="피드에서 검색..." class="w-full h-11 pl-12 pr-4 bg-white rounded-xl border-slate-300 focus:ring-2 focus:ring-blue-500 transition shadow-sm">
                    </div>
                    <div id="feed-container" class="space-y-4"></div>
                </div>
            `;

            // 2. 이 대상에만 해당하는 위젯 데이터 로드 및 렌더링
            const dashboardConfig = await dbUtils.get('dashboard', defId) || { widgets: [] };
            state.dashboard.widgets = dashboardConfig.widgets; // 상태 업데이트
            const grid = $('#dashboard-grid');
            if (state.dashboard.widgets.length === 0) {
                grid.innerHTML = `<div class="col-span-12 text-center py-12 bg-white rounded-xl shadow-sm"><p class="text-slate-500">'위젯 추가' 버튼으로 이 대상의 대시보드를 만드세요.</p></div>`;
            } else {
                state.dashboard.widgets.forEach(widget => {
                    const widgetEl = document.createElement('div');
                    widgetEl.className = 'widget bg-white rounded-xl shadow-lg shadow-slate-200/50 p-4 flex flex-col';
                    widgetEl.style.gridColumn = `span ${widget.w}`;
                    widgetEl.style.gridRow = `span ${widget.h}`;
                    widgetEl.dataset.widgetId = widget.id;
                    widgetEl.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-slate-800">${widget.title}</h3>
                            <div class="flex gap-1">
                                <button class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-200" data-action="edit-widget" data-id="${widget.id}"><i data-lucide="settings-2" class="w-4 h-4 text-slate-500"></i></button>
                                <button class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-red-100" data-action="delete-widget" data-id="${widget.id}"><i data-lucide="x" class="w-4 h-4 text-red-500"></i></button>
                            </div>
                        </div>
                        <div class="widget-content flex-grow min-h-0"></div>`;
                    grid.appendChild(widgetEl);
                    logic.renderWidgetContent(widget, widgetEl.querySelector('.widget-content'));
                });
            }

            // 3. 피드 렌더링 로직
            const allDbEntries = await dbUtils.getAll('entries');
            const allLogs = allDbEntries.flatMap(day => day.entries)
                                     .filter(entry => entry.definitionId === defId)
                                     .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const renderFeed = (filterText = '') => {
                const container = $('#feed-container');
                const lowerFilter = filterText.toLowerCase();
                const filteredLogs = allLogs.filter(entry => {
                    if (!lowerFilter) return true;
                    // 값(value)들 중에서 검색
                    return Object.values(entry.values).some(val => String(val).toLowerCase().includes(lowerFilter));
                });

                if (filteredLogs.length === 0) {
                    container.innerHTML = '<div class="text-center py-12 bg-white rounded-xl shadow-sm"><p class="text-slate-500">일치하는 기록이 없습니다.</p></div>';
                    return;
                }
                container.innerHTML = filteredLogs.map(entry => `
                    <div class="timeline-item bg-white rounded-xl shadow-lg shadow-slate-200/50 p-4 relative group transition-all duration-300 hover:shadow-xl hover:shadow-slate-300/60">
                        ${ui.createTimelineItemHtml(entry)}
                    </div>
                `).join('');
                ui.refreshIcons();
            };

            $('#feed-search-input').addEventListener('input', (e) => renderFeed(e.target.value));
            renderFeed(); // 초기 렌더링
            ui.refreshIcons();
        },
        renderWorkspaceTree: () => {
            const container = $('#workspace-content');
            container.className = 'bg-white p-4 sm:p-5 rounded-2xl shadow-xl shadow-slate-200/60';
            const buildTree = (definitions) => {
                const tree = [], map = {};
                definitions.forEach(def => { map[def.id] = { ...def, children: [] }; });
                definitions.forEach(def => {
                    if (def.parentId && map[def.parentId]) map[def.parentId].children.push(map[def.id]); else tree.push(map[def.id]);
                });
                Object.values(map).forEach(node => node.children.sort((a, b) => a.name.localeCompare(b.name)));
                tree.sort((a, b) => a.name.localeCompare(b.name));
                return tree;
            };
            const renderNode = (node) => {
                const hasChildren = node.children.length > 0, isExpanded = state.workspace.expandedNodes.has(node.id);
                const childrenHtml = hasChildren && isExpanded ? `<ul class="pl-5 border-l-2 border-slate-200 ml-2">${node.children.map(renderNode).join('')}</ul>` : '';
                return `
                    <li class="py-1">
                        <div class="tree-item group p-2 rounded-lg hover:bg-slate-50 transition-colors flex justify-between items-center">
                             <div class="flex items-center gap-1.5">
                                <div class="w-5 h-5 flex items-center justify-center flex-shrink-0 cursor-pointer rounded-md hover:bg-slate-200" data-action="toggle-node" data-id="${node.id}">
                                    ${hasChildren ? `<i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform ${isExpanded ? '' : '-rotate-90'}"></i>` : '<div class="w-4 h-4"></div>'}
                                </div>
                                <span class="font-medium text-sm text-slate-800 cursor-pointer hover:text-blue-600 transition-colors" data-action="view-definition-dashboard" data-id="${node.id}">${node.name}</span>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="button text-xs font-semibold bg-white border border-slate-300 text-slate-700 hover:bg-slate-100 px-3 py-1.5 rounded-md shadow-sm" data-action="edit-def" data-id="${node.id}">수정</button>
                                <button class="button text-xs font-semibold bg-red-50 text-red-700 hover:bg-red-100 px-3 py-1.5 rounded-md" data-action="delete-def" data-id="${node.id}">삭제</button>
                            </div>
                        </div>
                        ${childrenHtml}
                    </li>`;
            };
            const query = state.workspace.searchQuery.toLowerCase().trim();
            const filteredDefs = query ? state.definitions.filter(def => def.name.toLowerCase().includes(query) || (def.tags?.some(t => t.toLowerCase().includes(query)))) : state.definitions;
            if(filteredDefs.length === 0) { container.innerHTML = '<p class="text-slate-500 text-center py-8">일치하는 대상이 없습니다.</p>'; return; }
            const treeHtml = query ? filteredDefs.map(node => renderNode({...node, children: []})).join('') : buildTree(state.definitions).map(renderNode).join('');
            container.innerHTML = `<ul class="space-y-0.5">${treeHtml}</ul>`;
        },
        showModal: (id, content) => {
            const modalWrapper = document.createElement('div');
            modalWrapper.id = id;
            modalWrapper.className = 'fixed inset-0 z-[2000] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300';
            modalWrapper.innerHTML = content;
            elements.modalContainer.appendChild(modalWrapper);
            setTimeout(() => modalWrapper.classList.add('opacity-100'), 10);
            ui.refreshIcons();
        },
        closeModal: (id) => {
            const modal = document.getElementById(id);
            if(modal) {
                modal.classList.remove('opacity-100');
                setTimeout(() => modal.remove(), 300);
            }
        },
        showSettingsModal: (config = {}) => {
            const modalContent = `<div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col scale-95 opacity-0 transition-all" id="settings-modal-content">
                    <div class="p-5 border-b flex justify-between items-center">
                        <h2 class="text-lg font-bold">Firebase 설정</h2>
                        <button class="button w-9 h-9 flex items-center justify-center rounded-full hover:bg-slate-200" data-action="close-modal" data-modal-id="settings-modal"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-5 space-y-4 overflow-y-auto">
                        <div class="text-sm p-3 bg-blue-50 text-blue-800 rounded-lg">
                            <p class="mb-2">Firebase 콘솔에서 복사한 <code>firebaseConfig</code> 객체 전체를 아래에 붙여넣으세요.</p>
                            <p class="font-mono text-xs bg-slate-200 p-2 rounded">
                                예시:<br>
                                const firebaseConfig = { <br>
                                &nbsp;&nbsp;apiKey: "...", <br>
                                &nbsp;&nbsp;... <br>
                                };
                            </p>
                        </div>
                        <textarea id="fb-config-textarea" class="w-full h-48 p-3 font-mono text-sm bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" placeholder="여기에 firebaseConfig 객체 코드를 붙여넣으세요..."></textarea>
                    </div>
                    <div class="p-4 border-t flex justify-end">
                        <button class="button font-semibold bg-blue-600 text-white px-5 py-2.5 rounded-lg" data-action="save-settings">저장 및 새로고침</button>
                    </div>
                </div>`;
            ui.showModal('settings-modal', modalContent);
            setTimeout(() => $('#settings-modal-content').classList.add('scale-100', 'opacity-100'), 10);
        },
        renderDefinitionForm: (definition) => {
            const isNew = definition === 'new';
            const defData = isNew ? { name: '', fields: [{fieldName: '', fieldType: 'Text'}], parentId: 0, tags: [] } : definition;
            let fieldsHtml = defData.fields.map((field) => `
                <div class="field-row flex gap-3 items-center">
                    <input type="text" class="field-name-input flex-grow h-11 px-4 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" value="${field.fieldName}" placeholder="필드 이름">
                    <select class="field-type-select h-11 px-3 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500">
                        <option value="Text" ${field.fieldType === 'Text' ? 'selected' : ''}>텍스트</option>
                        <option value="Number" ${field.fieldType === 'Number' ? 'selected' : ''}>숫자</option>
                        <option value="Date" ${field.fieldType === 'Date' ? 'selected' : ''}>날짜</option>
                        <option value="Checkbox" ${field.fieldType === 'Checkbox' ? 'selected' : ''}>체크박스</option>
                        <option value="Textarea" ${field.fieldType === 'Textarea' ? 'selected' : ''}>장문 텍스트</option>
                    </select>
                    <button class="button w-11 h-11 flex-shrink-0 flex items-center justify-center bg-slate-100 text-slate-500 rounded-lg hover:bg-red-100 hover:text-red-600" data-action="remove-field"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>`).join('');
            const parentOptions = state.definitions.filter(def => def.id !== defData.id).map(def => `<option value="${def.id}" ${def.id === defData.parentId ? 'selected' : ''}>${def.name}</option>`).join('');
            const modalContent = `<div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col scale-95 opacity-0 transition-all duration-300" id="definition-modal-content">
                    <div class="p-4 sm:p-5 border-b border-slate-200 flex justify-between items-center flex-shrink-0">
                        <h2 class="text-lg font-bold text-slate-800">${isNew ? '새 대상 정의' : '대상 수정'}</h2>
                         <button class="button w-9 h-9 flex items-center justify-center bg-slate-200 text-slate-500 rounded-full hover:bg-slate-300" data-action="close-modal" data-modal-id="definition-modal"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <div class="modal-content p-4 sm:p-5 space-y-5 overflow-y-auto">
                        <div class="form-group"><label class="text-sm font-medium text-slate-600 mb-1.5 block">대상 이름</label><input type="text" id="def-name-input" value="${defData.name}" class="w-full h-11 px-4 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" autofocus></div>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-slate-600 mb-1.5 block">부모 대상 (선택)</label><select id="def-parent-select" class="w-full h-11 px-3 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500"><option value="0">-- 없음 --</option>${parentOptions}</select></div>
                            <div><label class="text-sm font-medium text-slate-600 mb-1.5 block">태그 (쉼표로 구분)</label><input type="text" id="def-tags-input" value="${(defData.tags || []).join(', ')}" class="w-full h-11 px-4 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500"></div>
                        </div>
                        <div><label class="text-sm font-medium text-slate-600 mb-1.5 block">데이터 필드</label><div id="def-fields-container" class="space-y-2 p-3 bg-slate-100 rounded-xl">${fieldsHtml}</div></div>
                        <button class="button w-full justify-center flex items-center gap-2 bg-slate-200 text-slate-700 font-semibold py-2.5 rounded-lg hover:bg-slate-300" data-action="add-field"><i data-lucide="plus" class="w-4 h-4"></i> 필드 추가</button>
                    </div>
                    <div class="p-4 border-t border-slate-200 flex justify-end flex-shrink-0">
                        <button class="button font-semibold bg-blue-600 text-white hover:bg-blue-700 px-5 py-2.5 rounded-lg shadow-lg shadow-blue-500/20" data-action="save-def" data-id="${isNew ? '' : defData.id}">저장하기</button>
                    </div>
                </div>`;
            ui.showModal('definition-modal', modalContent);
            setTimeout(() => $('#definition-modal-content').classList.add('scale-100', 'opacity-100'), 10);
        },
        showSuggestions: (query) => {
            const lowerQuery = query.toLowerCase();
            const filtered = state.definitions.filter(def => def.name.toLowerCase().includes(lowerQuery));
            let html = `<button class="flex items-center gap-3 w-full text-left px-4 py-2.5 text-base hover:bg-slate-100 transition-colors" data-type="journal"><i data-lucide="book-pen" class="w-5 h-5 text-slate-500"></i><span class="font-medium">일기 쓰기</span></button>`;
            html += filtered.map(def => `<button class="flex items-center gap-3 w-full text-left px-4 py-2.5 text-base hover:bg-slate-100 transition-colors" data-type="log" data-id="${def.id}"><i data-lucide="pencil-ruler" class="w-5 h-5 text-slate-500"></i>${def.name}</button>`).join('');
            elements.suggestionBox.innerHTML = html;
            ui.refreshIcons();
        },
        clearSuggestions: () => { elements.suggestionBox.innerHTML = ''; },

        showDynamicForm: (type, id = null, existingEntry = null) => {
            ui.clearSuggestions();
            elements.commandBarInput.style.display = 'none';
            let formHtml = '';
        
            if (type === 'journal') {
   
                elements.dynamicFormContainer.className = 'p-4 flex flex-col gap-4';

                formHtml = `<div class="form-group flex-grow min-h-0 flex flex-col">
                                <label class="text-sm font-medium text-slate-600 mb-2 block flex-shrink-0">일기 내용</label>
                                <div id="journal-editor" class="h-full"></div>
                            </div>`;
            } else {
                // '로그' 타입의 폼은 기존 Grid 레이아웃을 그대로 유지합니다.
                elements.dynamicFormContainer.className = 'p-4 grid gap-4';

                const def = state.definitions.find(d => d.id === id);
                if (!def) { alert('정의를 찾을 수 없습니다.'); ui.resetCommandBar(); return; }
                formHtml += `<h2 class="text-lg font-bold text-slate-800 mb-4">${def.name} ${existingEntry ? '수정' : '기록'}</h2>`;
     
                def.fields.forEach((field, index) => {

                    const fieldId = `log-field-${def.id}-${index}`;
                    const value = existingEntry ? existingEntry.values[field.fieldName] : '';
                    let fieldInputHtml = '';
                    switch (field.fieldType) {
                        case 'Number': fieldInputHtml = `<input type="number" id="${fieldId}" value="${value || ''}" class="form-input">`; break;
                        case 'Date': fieldInputHtml = `<input type="date" id="${fieldId}" value="${value || ''}" class="form-input">`; break;
                        case 'Checkbox':
                            fieldInputHtml = `<div class="flex items-center gap-2 mt-2 h-11"><input type="checkbox" id="${fieldId}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${value ? 'checked' : ''}><label for="${fieldId}" class="text-sm font-medium text-slate-700">${field.fieldName}</label></div>`; break;
                        case 'Textarea': fieldInputHtml = `<textarea id="${fieldId}" rows="3" class="form-input">${value || ''}</textarea>`; break;
                        case 'Image': fieldInputHtml = `<input type="file" id="${fieldId}" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>`; break;
                        default: fieldInputHtml = `<input type="text" id="${fieldId}" value="${value || ''}" class="form-input">`; break;
                    }
                    if (field.fieldType === 'Checkbox') formHtml += `<div class="form-group">${fieldInputHtml}</div>`;
                    else formHtml += `<div class="form-group"><label class="text-sm font-medium text-slate-600 mb-1.5 block">${field.fieldName}</label>${fieldInputHtml}</div>`;
                });
            }
            const entryIdAttr = existingEntry ? `data-entry-id="${existingEntry.id}"` : '';
            // 버튼 컨테이너는 flex-shrink-0을 통해 높이가 줄어들지 않도록 방어합니다.
            const actionsHtml = `<div class="flex-shrink-0 flex gap-2 justify-end mt-4"><button type="button" class="button font-semibold bg-slate-100 text-slate-700 hover:bg-slate-200 px-4 py-2 rounded-lg" data-action="cancel-entry">취소</button><button type="button" class="button font-semibold bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded-lg shadow-sm" data-action="save-entry" data-type="${type}" data-id="${id}" ${entryIdAttr}>저장</button></div>`;
            const styledFormHtml = formHtml.replaceAll('class="form-input"', 'class="w-full p-2 h-11 px-4 bg-slate-100 rounded-lg border-transparent focus:ring-2 focus:ring-blue-500"');
            elements.dynamicFormContainer.innerHTML = styledFormHtml + actionsHtml;
            if (type === 'journal') {
                quill = new Quill('#journal-editor', { theme: 'snow', modules: { toolbar: [ [{ 'header': [1, 2, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean'] ] } });
                if (existingEntry?.content) quill.root.innerHTML = existingEntry.content;
            }
        },
        resetCommandBar: () => {
            elements.dynamicFormContainer.innerHTML = '';
            elements.commandBarInput.style.display = 'block';
            elements.commandBarInput.value = '';
            elements.commandBarInput.blur();
        },
        renderCalendar: async () => {
            const currentMonth = dayjs(state.calendar.viewMonth);
            const logCounts = await logic.getLogCountsForMonth(state.calendar.viewMonth);
            const startOfMonth = currentMonth.startOf('month');
            const endOfMonth = currentMonth.endOf('month');
            const startDay = startOfMonth.day();

            let calendarHtml = `
            <div class="calendar-view-container space-y-6">
                <div class="calendar-container bg-white p-4 sm:p-6 rounded-2xl shadow-xl shadow-slate-200/60">
                    <div class="flex justify-between items-center mb-4">
                        <button data-action="prev-month" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-slate-100"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <h3 class="text-lg font-bold">${currentMonth.format('YYYY년 M월')}</h3>
                        <button data-action="next-month" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-slate-100"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center">
            `;
            const dayNames = ['일','월','화','수','목','금','토'];
            calendarHtml += dayNames.map(d => `<div class="text-xs font-semibold text-slate-500 py-2">${d}</div>`).join('');
            
            for (let i = 0; i < startDay; i++) calendarHtml += `<div></div>`;

            for (let i = 1; i <= endOfMonth.date(); i++) {
                const dayDate = startOfMonth.date(i);
                const dateStr = dayDate.format('YYYY-MM-DD');
                const isToday = dayDate.isSame(dayjs(), 'day');
                
                const { selectionStart, selectionEnd } = state.calendar;
                const isStart = dateStr === selectionStart;
                const isEnd = dateStr === selectionEnd;
                const isInRange = selectionStart && selectionEnd && dayDate.isAfter(selectionStart) && dayDate.isBefore(selectionEnd);

                let classes = 'calendar-day h-9 flex items-center justify-center cursor-pointer relative transition-all duration-200 text-sm';
                let dayWrapperClasses = 'relative';

                if (isStart || isEnd || (selectionStart && !selectionEnd && isToday && dateStr === selectionStart)) {
                    classes += ' bg-blue-600 text-white font-bold rounded-full z-10';
                } else if (isInRange) {
                    classes += ' text-blue-700 font-semibold';
                    dayWrapperClasses += ' bg-blue-100';
                    if (dayDate.day() === 0) dayWrapperClasses += ' rounded-l-full'; // 범위의 시작 (일요일)
                    if (dayDate.day() === 6) dayWrapperClasses += ' rounded-r-full'; // 범위의 끝 (토요일)
                } else {
                    classes += ' rounded-full hover:bg-slate-100';
                    if (isToday) classes += ' text-blue-600 font-semibold ring-2 ring-blue-200';
                }

                const hasLogs = (logCounts[dateStr] || 0) > 0;
                const indicator = hasLogs ? `<div class="absolute bottom-1 w-1 h-1 rounded-full ${isStart || isEnd ? 'bg-white' : 'bg-blue-500'}"></div>` : '';
                calendarHtml += `<div class="${dayWrapperClasses}"><div class="${classes}" data-action="select-calendar-date" data-date="${dateStr}">${i}${indicator}</div></div>`;
            }
            calendarHtml += '</div></div><div id="calendar-timeline-container" class="space-y-4"></div></div>';
            elements.mainContent.innerHTML = calendarHtml;
            ui.refreshIcons();

            // 캘린더 뷰가 렌더링될 때, 선택된 기간이 있으면 해당 기간의 데이터를 바로 로드합니다.
            if (state.calendar.selectionStart && state.calendar.selectionEnd) {
                logic.loadDataForDateRange(state.calendar.selectionStart, state.calendar.selectionEnd);
            }
        },
        renderDashboard: async () => {
            elements.mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold">대시보드</h1>
                    <button class="button bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 flex items-center gap-2" data-action="add-widget">
                        <i data-lucide="plus" class="w-4 h-4"></i> 위젯 추가
                    </button>
                </div>
                <div id="dashboard-grid" class="dashboard-grid"></div>
            `;
            const grid = $('#dashboard-grid');
            if(state.dashboard.widgets.length === 0){
                grid.innerHTML = `<div class="col-span-12 text-center py-20 bg-white rounded-xl shadow-sm"><p class="text-slate-500">'위젯 추가' 버튼을 눌러 대시보드를 꾸며보세요.</p></div>`
            } else {
                state.dashboard.widgets.forEach(widget => {
                    const widgetEl = document.createElement('div');
                    widgetEl.className = 'widget bg-white rounded-xl shadow-lg shadow-slate-200/50 p-4 flex flex-col';
                    widgetEl.style.gridColumn = `span ${widget.w}`;
                    widgetEl.style.gridRow = `span ${widget.h}`;
                    widgetEl.dataset.widgetId = widget.id;
                    widgetEl.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-slate-800">${widget.title}</h3>
                            <div class="flex gap-1">
                                <button class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-200" data-action="edit-widget" data-id="${widget.id}"><i data-lucide="settings-2" class="w-4 h-4 text-slate-500"></i></button>
                                <button class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-red-100" data-action="delete-widget" data-id="${widget.id}"><i data-lucide="x" class="w-4 h-4 text-red-500"></i></button>
                            </div>
                        </div>
                        <div class="widget-content flex-grow min-h-0"></div>
                    `;
                    grid.appendChild(widgetEl);
                    logic.renderWidgetContent(widget, widgetEl.querySelector('.widget-content'));
                });
            }
            ui.refreshIcons();
        },
        renderWidgetForm: (widget = null) => {
            const isNew = widget === null;
            const w = widget || { id: Date.now(), title: '', chartType: '', defId: '', fieldName: '', w: 4, h: 3 };

            // 이 부분을 교체합니다.
            const chartTypes = ui.widgetManager.getAvailableWidgets();
            
            const modalContent = `<div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col scale-95 opacity-0 transition-all" id="widget-modal-content">
                <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                    <h2 class="text-lg font-bold">${isNew ? '새 위젯 추가' : '위젯 수정'}</h2>
                    <button class="button w-9 h-9 flex items-center justify-center rounded-full hover:bg-slate-200" data-action="close-modal" data-modal-id="widget-modal"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-5 space-y-4 overflow-y-auto">
                    <div><label class="text-sm font-medium mb-1.5 block">1. 위젯 제목</label><input type="text" id="widget-title" value="${w.title}" class="form-input" placeholder="예: 주간 운동 횟수"></div>
                    <div><label class="text-sm font-medium mb-1.5 block">2. 위젯 타입</label>
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-2">${chartTypes.map(ct => `
                            <button data-action="select-chart-type" data-type="${ct.id}" data-fields='${JSON.stringify(ct.fields)}' class="p-3 border rounded-lg flex flex-col items-center gap-2 ${w.chartType === ct.id ? 'bg-blue-100 border-blue-500' : 'bg-white hover:border-slate-400'}">
                                <i data-lucide="${ct.icon}" class="w-6 h-6 ${w.chartType === ct.id ? 'text-blue-600': ''}"></i><span class="text-xs font-semibold">${ct.name}</span></button>`).join('')}
                        </div>
                    </div>
                    <div id="widget-data-source" class="hidden"><label class="text-sm font-medium mb-1.5 block">3. 데이터 선택</label>
                        <div class="grid grid-cols-2 gap-4">
                            <select id="widget-def-select" class="form-input"></select>
                            <select id="widget-field-select" class="form-input"></select>
                        </div>
                    </div>
                     <div><label class="text-sm font-medium mb-1.5 block">4. 크기 (12컬럼 기준)</label>
                        <div class="grid grid-cols-2 gap-4">
                           <div><label class="text-xs">너비</label><input type="number" id="widget-w" value="${w.w}" min="2" max="12" class="form-input"></div>
                           <div><label class="text-xs">높이</label><input type="number" id="widget-h" value="${w.h}" min="2" max="6" class="form-input"></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end">
                    <button class="button bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg" data-action="save-widget" data-id="${w.id}">저장</button>
                </div>
            </div>`.replaceAll('class="form-input"', 'class="w-full h-11 px-4 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500"');
            
            ui.showModal('widget-modal', modalContent);
            setTimeout(() => {
                $('#widget-modal-content').classList.add('scale-100', 'opacity-100');
                if (w.chartType) {
                    const btn = $(`[data-action="select-chart-type"][data-type="${w.chartType}"]`);
                    if(btn) handlers.handleWidgetFormClicks({ target: btn });
                }
            }, 10);
        },
        widgetManager: {
            registry: {
                'bar': {
                    name: '막대 차트', icon: 'bar-chart-3', fields: ['Number'],
                    render: (widget, containerEl, entries, chartInstances) => {
                        const canvas = document.createElement('canvas');
                        containerEl.appendChild(canvas);
                        const labels = entries.slice(-30).map(e => dayjs(e.timestamp).format('MM/DD'));
                        const data = entries.slice(-30).map(e => parseFloat(e.values[widget.fieldName]) || 0);
                        const chart = new Chart(canvas.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels,
                                datasets: [{
                                    label: widget.fieldName, data,
                                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    borderWidth: 2,
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                        });
                        chartInstances.set(widget.id, chart);
                    }
                },
                'line': {
                    name: '선 차트', icon: 'line-chart', fields: ['Number'],
                    render: (widget, containerEl, entries, chartInstances) => {
                        const canvas = document.createElement('canvas');
                        containerEl.appendChild(canvas);
                        const labels = entries.slice(-30).map(e => dayjs(e.timestamp).format('MM/DD'));
                        const data = entries.slice(-30).map(e => parseFloat(e.values[widget.fieldName]) || 0);
                        const chart = new Chart(canvas.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels,
                                datasets: [{
                                    label: widget.fieldName, data,
                                    backgroundColor: 'transparent',
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    borderWidth: 2,
                                    tension: 0.2,
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                        });
                        chartInstances.set(widget.id, chart);
                    }
                },
                'radar': {
                    name: '레이더 차트', icon: 'radar', fields: ['Number'],
                    render: (widget, containerEl, entries, chartInstances) => {
                        const canvas = document.createElement('canvas');
                        containerEl.appendChild(canvas);
                        const labels = entries.slice(-30).map(e => dayjs(e.timestamp).format('MM/DD'));
                        const data = entries.slice(-30).map(e => parseFloat(e.values[widget.fieldName]) || 0);
                        const chart = new Chart(canvas.getContext('2d'), {
                            type: 'radar',
                            data: {
                                labels,
                                datasets: [{
                                    label: widget.fieldName, data,
                                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    borderWidth: 2,
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                        });
                        chartInstances.set(widget.id, chart);
                    }
                },
                'heatmap': {
                    name: '히트맵', icon: 'grid-3x3', fields: ['Checkbox'],
                    render: (widget, containerEl, entries) => {
                        // 1. 표시할 월 결정 (위젯 상태 또는 현재 날짜)
                        if (!widget.displayMonth) {
                            widget.displayMonth = dayjs().format('YYYY-MM-DD');
                        }
                        const displayMonth = dayjs(widget.displayMonth);

                        // 2. 데이터 집계
                        const dataByDay = entries.reduce((acc, e) => {
                            const date = dayjs(e.timestamp).format('YYYY-MM-DD');
                            if (e.values[widget.fieldName]) acc[date] = (acc[date] || 0) + 1;
                            return acc;
                        }, {});

                        // 3. 네비게이션 날짜 계산
                        const prevMonth = displayMonth.subtract(1, 'month').format('YYYY-MM-DD');
                        const nextMonth = displayMonth.add(1, 'month').format('YYYY-MM-DD');

                        // 4. 캘린더 그리드 계산
                        const startOfMonth = displayMonth.startOf('month');
                        const endOfMonth = displayMonth.endOf('month');
                        const startDay = startOfMonth.day(); // 0:일, 6:토
                        const daysInMonth = endOfMonth.date();
                        
                        let gridHtml = '';
                        // 앞쪽 빈 칸 채우기
                        for (let i = 0; i < startDay; i++) {
                            gridHtml += `<div></div>`;
                        }
                        // 날짜 채우기
                        for (let i = 1; i <= daysInMonth; i++) {
                            const date = startOfMonth.date(i);
                            const count = dataByDay[date.format('YYYY-MM-DD')] || 0;
                            let colorClass = 'bg-slate-100';
                            if (count > 0) colorClass = 'bg-blue-200';
                            if (count > 2) colorClass = 'bg-blue-400';
                            if (count > 5) colorClass = 'bg-blue-600';
                            gridHtml += `<div class="${colorClass} rounded-sm" title="${date.format('YYYY-MM-DD')}: ${count}"></div>`;
                        }

                        // 5. 최종 HTML 구조 생성
                        containerEl.innerHTML = `
                            <div class="flex flex-col h-full">
                                <div class="flex justify-between items-center mb-2 flex-shrink-0">
                                    <button class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-200" data-action="navigate-heatmap" data-widget-id="${widget.id}" data-date="${prevMonth}">
                                        <i data-lucide="chevron-left" class="w-4 h-4 text-slate-500"></i>
                                    </button>
                                    <span class="text-sm font-semibold text-slate-700">${displayMonth.format('YYYY년 M월')}</span>
                                    <button class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-200" data-action="navigate-heatmap" data-widget-id="${widget.id}" data-date="${nextMonth}">
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-500"></i>
                                    </button>
                                </div>
                                <div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-1 flex-shrink-0">
                                    ${['일', '월', '화', '수', '목', '금', '토'].map(d => `<div>${d}</div>`).join('')}
                                </div>
                                <div class="grid grid-cols-7 gap-1 flex-grow">
                                    ${gridHtml}
                                </div>
                            </div>
                        `;
                        // 6. 아이콘 렌더링
                        ui.refreshIcons();
                    }
                },
                'list': {
                    name: '텍스트 목록', icon: 'list', fields: ['Text', 'Textarea'],
                    render: (widget, containerEl, entries) => {
                        let listHtml = '<ul class="space-y-2 overflow-y-auto h-full text-sm pr-2">';
                        entries.slice(-10).reverse().forEach(e => {
                            listHtml += `<li class="p-2 bg-slate-50 rounded-md"><strong class="text-slate-500 font-normal">${dayjs(e.timestamp).format('MM/DD')}</strong>: ${e.values[widget.fieldName]}</li>`;
                        });
                        listHtml += '</ul>';
                        containerEl.innerHTML = listHtml;
                    }
                }
            },
            getAvailableWidgets: function() {
                return Object.entries(this.registry).map(([id, config]) => ({ id, ...config }));
            },
            render: function(widget, containerEl, entries, chartInstances) {
                const widgetType = this.registry[widget.chartType];
                if (widgetType && typeof widgetType.render === 'function') {
                    widgetType.render(widget, containerEl, entries, chartInstances);
                } else {
                    containerEl.innerHTML = `<div class="flex items-center justify-center h-full text-red-500 text-sm">오류: '${widget.chartType}' 위젯 타입을 렌더링할 수 없습니다.</div>`;
                }
            }
        },
    };


    // =================================================================================
    // LOGIC MODULE
    // =================================================================================
    const logic = {
        loadDataForDate: async (date) => {
            state.currentDate = date;
            elements.datePicker.value = date;

            // 기존 리스너 모두 구독 해제
            state.firestoreUnsubscribes.forEach(unsub => unsub());
            state.firestoreUnsubscribes = [];
            state.loadedEntries.clear();
            state.visibleTimelineDates = [];

            const container = $('#timeline-container');
            if (container) container.innerHTML = '<div id="timeline-loader" class="text-center p-8 text-slate-500">기록을 불러오는 중...</div>';
            
            // Firestore 실시간 리스너 설정 (비용과 실시간성 절충)
            // 최근 7일치 데이터에 대해서만 실시간 리스너를 설정
            const collRef = firebase.collection(fbDb, `users/${state.user.uid}/entries`);
            const q = firebase.query(collRef, firebase.where(firebase.documentId(), ">=", dayjs().subtract(7, 'day').format('YYYY-MM-DD')));
            
            const unsubscribe = firebase.onSnapshot(q, (querySnapshot) => {
                let changed = false;
                querySnapshot.docChanges().forEach((change) => {
                    changed = true;
                    const docData = change.doc.data();
                    if (change.type === "removed" || docData.entries.length === 0) {
                        state.loadedEntries.delete(change.doc.id);
                    } else {
                        state.loadedEntries.set(change.doc.id, docData.entries);
                    }
                });

                if (changed && state.currentView === 'timeline') {
                    // 변경사항이 있을 때만 타임라인 다시 렌더링
                    const allDaysData = Array.from(state.loadedEntries.entries()).map(([date, entries]) => ({date, entries}));
                    allDaysData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    if ($('#timeline-container')) {
                        $('#timeline-container').innerHTML = ''; // 컨테이너 비우기
                        ui.renderMoreEntries(allDaysData);
                    }
                }
                 if ($('#timeline-loader')) $('#timeline-loader').remove();

            }, (error) => {
                console.error("Firestore listener error:", error);
            });
            
            state.firestoreUnsubscribes.push(unsubscribe); // 구독 해제 함수 저장
            
            // 7일 이전의 데이터는 스크롤 시점에 수동으로 로드 (loadAndRenderDays에서 처리)
            await logic.loadAndRenderDays(dayjs(date).subtract(7, 'day'), 5);
        },
        handleRouteChange: () => {
            const hash = window.location.hash || '#timeline'; // 기본 뷰는 타임라인
            
            if (hash.startsWith('#def/')) {
                const id = parseInt(hash.substring(5));
                state.currentView = 'definition-dashboard';
                state.activeDefinitionId = id;
            } else {
                state.activeDefinitionId = null;
                switch (hash) {
                    case '#workspace':
                        state.currentView = 'workspace';
                        break;
                    case '#dashboard':
                        state.currentView = 'dashboard';
                        break;
                    case '#calendar':
                        state.currentView = 'calendar';
                        break;
                    default:
                        state.currentView = 'timeline';
                        break;
                }
            }
            ui.renderMainContent();
        },

        loadDataForDateRange: async (startDate, endDate) => {
            const container = $('#calendar-timeline-container');
            if (!container) return;
            container.innerHTML = '<p class="text-center p-8 text-slate-500">선택된 기간의 기록을 불러오는 중...</p>';
            
            const allDbEntries = await dbUtils.getAll('entries');
            const results = [];

            const start = dayjs(startDate);
            const end = dayjs(endDate);

            allDbEntries.forEach(dayData => {
                const currentDate = dayjs(dayData.date);
                if ((currentDate.isSame(start) || currentDate.isAfter(start)) && (currentDate.isSame(end) || currentDate.isBefore(end))) {
                    results.push(...dayData.entries);
                }
            });

            if (results.length === 0) {
                container.innerHTML = '<p class="text-center p-8 text-slate-500">선택된 기간에 기록이 없습니다.</p>';
                return;
            }

            results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = results.map(entry => `
                <div class="timeline-item bg-white rounded-xl shadow-lg shadow-slate-200/50 p-4 relative group transition-all duration-300 hover:shadow-xl hover:shadow-slate-300/60">
                    ${ui.createTimelineItemHtml(entry)}
                </div>
            `).join('');
            ui.refreshIcons();
        },

        saveEntry: async (type, definitionId, entryId = null) => {
            try {
                const isUpdate = entryId !== null;
                const newEntryData = {
                    id: isUpdate ? entryId : Date.now(),
                    type: type,
                    timestamp: new Date().toISOString(),
                };

                if (type === 'journal') {
                    if (!quill) throw new Error("Quill editor가 초기화되지 않았습니다.");
                    newEntryData.content = quill.root.innerHTML;
                    newEntryData.definitionId = null; 
                } else if (type === 'log') {
                    const def = state.definitions.find(d => d.id === definitionId);
                    if (!def) throw new Error(`ID ${definitionId}에 해당하는 대상을 찾을 수 없습니다.`);
                    
                    newEntryData.definitionId = definitionId;
                    newEntryData.values = {};
                    
                    const valuePromises = def.fields.map(async (field, index) => {
                        const input = $(`#log-field-${definitionId}-${index}`);
                        let value;
                        if (input) {
                            if (field.fieldType === 'Image' && input.files[0]) {
                                value = await logic.processAndEncodeImage(input.files[0]);
                            } else {
                                value = input.type === 'checkbox' ? input.checked : input.value;
                            }
                            return [field.fieldName, value];
                        }
                        return [field.fieldName, undefined];
                    });

                    const resolvedValues = await Promise.all(valuePromises);
                    resolvedValues.forEach(([fieldName, value]) => {
                        if (value !== undefined) newEntryData.values[fieldName] = value;
                    });
                }

                await firebaseUtils.saveEntry(newEntryData);
                
                state.loadedEntries.delete(dayjs(newEntryData.timestamp).format('YYYY-MM-DD'));
                ui.resetCommandBar();
                if(state.currentView === 'timeline') {
                    // 실시간 리스너가 업데이트하므로 수동 렌더링 최소화
                } else {
                    ui.renderMainContent();
                }

            } catch (error) {
                console.error("저장 실패:", error);
                alert(`저장에 실패했습니다: ${error.message}`);
            }
        },
        
        processAndEncodeImage: (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onerror = reject;
            reader.onload = () => {
                const img = new Image();
                img.src = reader.result;
                img.onerror = reject;
                img.onload = () => {
                    const { width, height } = img;
                    const minDimension = Math.min(width, height);

                    if (minDimension <= 700) {
                        return resolve(img.src); // 리사이징 불필요
                    }

                    let newWidth, newHeight;
                    const scaleFactor = 720 / minDimension;
                    newWidth = width * scaleFactor;
                    newHeight = height * scaleFactor;

                    const canvas = document.createElement('canvas');
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    resolve(canvas.toDataURL(file.type, 0.9)); // 퀄리티 90%로 압축
                };
            };
        }),
        loadAndRenderDays: async (startDate, targetCount) => {
            if (state.isLoadingMore) return; 
            state.isLoadingMore = true;

            const newDaysData = [];
            let currentDate = dayjs(startDate);
            let daysScanned = 0;

            // [핵심 변경] targetCount 만큼 '데이터가 있는 날'을 찾을 때까지 또는 최대 1년치 스캔
            while (newDaysData.length < targetCount && daysScanned < 365) {
                const dateStr = currentDate.format('YYYY-MM-DD');
                
                if (!state.loadedEntries.has(dateStr)) {
                    const data = await dbUtils.get('entries', dateStr);
                    const entries = data ? data.entries : [];
                    state.loadedEntries.set(dateStr, entries); // 스캔한 날은 다시 로드하지 않도록 저장
                    
                    if (entries.length > 0) {
                        newDaysData.push({ date: dateStr, entries });
                    }
                }
                
                currentDate = currentDate.subtract(1, 'day');
                daysScanned++;
            }

            state.lastLoadedDate = currentDate.format('YYYY-MM-DD'); // 다음 로딩 시작 지점 저장

            if (newDaysData.length > 0) {
                // 찾은 데이터를 날짜 내림차순(최신순)으로 정렬하여 렌더링
                newDaysData.sort((a, b) => new Date(b.date) - new Date(a.date));
                ui.renderMoreEntries(newDaysData);
                state.visibleTimelineDates.push(...newDaysData.map(d => d.date));
            } else {
                 if ($('#timeline-container').children.length === 0) {
                     $('#timeline-container').innerHTML = '<div class="text-center p-8 text-slate-500">표시할 기록이 없습니다.</div>';
                 }
            }

            state.isLoadingMore = false;
        },
        searchGlobal: async (query) => {
            const lowerQuery = query.toLowerCase().trim();
            if (!lowerQuery) {
                ui.renderMainContent();
                return;
            }

            const results = [];
            const isTagQuery = lowerQuery.startsWith('tag:');
            const pureQuery = isTagQuery ? lowerQuery.substring(4).trim() : lowerQuery;

            const allEntries = await dbUtils.getAll('entries');

            for (const dayData of allEntries) {
                for (const entry of dayData.entries) {
                    let isMatch = false;
                    const def = entry.type === 'log' ? state.definitions.find(d => d.id === entry.definitionId) : null;

                    if (isTagQuery) {
                        // 'tag:' 구문으로 검색 시
                        if (def && def.tags?.some(tag => tag.toLowerCase().includes(pureQuery))) {
                            isMatch = true;
                        }
                    } else {
                        // 일반 검색 시
                        if (entry.type === 'journal') {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = entry.content;
                            if (tempDiv.textContent.toLowerCase().includes(pureQuery)) {
                                isMatch = true;
                            }
                        } else if (entry.type === 'log' && def) {
                            // 1. 대상 이름 검색
                            if (def.name.toLowerCase().includes(pureQuery)) isMatch = true;
                            // 2. 태그 검색
                            else if (def.tags?.some(tag => tag.toLowerCase().includes(pureQuery))) isMatch = true;
                            // 3. 필드 이름(변수명) 검색 추가
                            else if (Object.keys(entry.values).some(key => key.toLowerCase().includes(pureQuery))) isMatch = true;
                            // 4. 값 검색
                            else if (Object.values(entry.values).some(val => String(val).toLowerCase().includes(pureQuery))) isMatch = true;
                        }
                    }

                    if (isMatch) {
                        results.push({ ...entry, date: dayData.date });
                    }
                }
            }
            ui.renderSearchResults(results);
        },
        saveDefinition: async (id) => {
            const name = $('#def-name-input').value.trim();
            if (!name) return alert('대상 이름은 필수입니다.');
            const parentId = parseInt($('#def-parent-select').value) || 0;
            const tags = $('#def-tags-input').value.split(',').map(tag => tag.trim()).filter(Boolean);
            const fields = [];
            document.querySelectorAll('#def-fields-container .field-row').forEach(row => {
                const fieldName = row.querySelector('.field-name-input').value.trim();
                const fieldType = row.querySelector('.field-type-select').value;
                if (fieldName) fields.push({ fieldName, fieldType });
            });
            const definitionData = { name, fields, parentId, tags };
            if (id) definitionData.id = parseInt(id);
            await dbUtils.save('definitions', definitionData);
            state.definitions = await dbUtils.getAll('definitions');
            ui.closeModal('definition-modal');
            if(state.currentView === 'workspace') ui.renderWorkspace();
        },
        deleteDefinition: async (id) => {
            if (confirm('정말로 이 대상을 삭제하시겠습니까?\n연결된 기록은 유지되지만, 이름 등은 표시되지 않을 수 있습니다.')) {
                await dbUtils.delete('definitions', id);
                const children = state.definitions.filter(d => d.parentId === id);
                for (const child of children) {
                    child.parentId = 0;
                    await dbUtils.save('definitions', child);
                }
                state.definitions = await dbUtils.getAll('definitions');
                if (state.currentView === 'workspace') ui.renderWorkspace();
            }
        },
        deleteEntry: async (id) => {
            if (!confirm('이 기록을 정말로 삭제하시겠습니까?')) return;
            
            // 삭제할 항목의 타임스탬프 찾기
            let entryTimestamp = null;
            for (const entries of state.loadedEntries.values()) {
                const found = entries.find(e => e.id === id);
                if (found) {
                    entryTimestamp = found.timestamp;
                    break;
                }
            }
            if (!entryTimestamp) { alert("오류: 삭제할 항목을 찾을 수 없습니다."); return; }

            await firebaseUtils.deleteEntry(id, entryTimestamp);
            // 실시간 리스너가 UI를 자동으로 업데이트합니다.
        },
        handleAuthStateChanged: async (user) => {
            if (user) {
                // 로그인 성공
                state.user = { uid: user.uid, displayName: user.displayName, email: user.email };
                elements.loginContainer.classList.add('hidden');
                elements.loaderContainer.classList.remove('hidden');
                elements.logoutBtn.classList.remove('hidden');

                // 데이터베이스에서 definitions 및 dashboard 로드
                state.definitions = await firebaseUtils.getAll('definitions') || [];
                const dashboardConfig = await firebaseUtils.get('dashboard', 'main');
                if (dashboardConfig) state.dashboard = dashboardConfig;

                // 기본 definition 데이터가 없으면 생성
                if (state.definitions.length === 0) {
                    const projDef = { id: 1, name: '개인 프로젝트', fields: [{ fieldName: '상태', fieldType: 'Text'}], tags: ['프로젝트'], parentId: 0 };
                    const logifyDef = { id: 2, name: 'Logify Reborn 개발', parentId: 1, fields: [{ fieldName: '진행률(%)', fieldType: 'Number'},{fieldName:'완료', fieldType:'Checkbox'}], tags: ['개발', '중요'] };
                    await firebaseUtils.save('definitions', projDef);
                    await firebaseUtils.save('definitions', logifyDef);
                    state.definitions = [projDef, logifyDef];
                }
                
                await logic.loadDataForDate(state.currentDate);
                elements.appOverlay.classList.add('opacity-0');
                setTimeout(() => elements.appOverlay.classList.add('hidden'), 300);
            } else {
                // 로그아웃 상태
                state.user = null;
                elements.loaderContainer.classList.add('hidden');
                elements.loginContainer.classList.remove('hidden');
                elements.appOverlay.classList.remove('hidden', 'opacity-0');
                elements.logoutBtn.classList.add('hidden');
                
                // 메모리 정리
                state.firestoreUnsubscribes.forEach(unsub => unsub());
                state.firestoreUnsubscribes = [];
                state.loadedEntries.clear();
            }
        },

        signInWithGoogle: () => {
            if (!state.isFirebaseReady) { alert("Firebase가 준비되지 않았습니다. 설정을 확인하세요."); return; }
            const provider = new firebase.GoogleAuthProvider();
            firebase.signInWithPopup(fbAuth, provider).catch(error => {
                console.error("Google 로그인 실패:", error);
                alert("로그인에 실패했습니다. 다시 시도해주세요.");
            });
        },

        signOut: () => {
            if (fbAuth) firebase.signOut(fbAuth);
        },
        getLogCountsForMonth: async (date) => {
            const monthStart = dayjs(date).startOf('month').format('YYYY-MM-DD');
            const monthEnd = dayjs(date).endOf('month').format('YYYY-MM-DD');
            const allData = await dbUtils.getAll('entries');
            const counts = {};
            allData.forEach(dayData => {
                if (dayData.date >= monthStart && dayData.date <= monthEnd && dayData.entries?.length > 0) {
                    counts[dayData.date] = dayData.entries.length;
                }
            });
            return counts;
        },
        saveWidget: async (id) => {
            const widget = {
                id: parseInt(id),
                title: $('#widget-title').value.trim(),
                chartType: document.querySelector('[data-action="select-chart-type"][class*="bg-blue-100"]')?.dataset.type,
                defId: parseInt($('#widget-def-select').value),
                fieldName: $('#widget-field-select').value,
                w: parseInt($('#widget-w').value),
                h: parseInt($('#widget-h').value),
            };
            if(!widget.title || !widget.chartType || !widget.defId || !widget.fieldName){
                return alert('모든 필드를 채워주세요.');
            }
            const widgetIndex = state.dashboard.widgets.findIndex(w => w.id === widget.id);
            if(widgetIndex > -1) state.dashboard.widgets[widgetIndex] = widget;
            else state.dashboard.widgets.push(widget);
            
            // [수정] 현재 활성화된 definition ID를 키로 사용하거나, 없으면 'main'을 사용
            const dbKey = state.activeDefinitionId || 'main';
            await dbUtils.save('dashboard', {id: dbKey, widgets: state.dashboard.widgets});

            ui.closeModal('widget-modal');
            ui.renderMainContent();
        },
        deleteWidget: async (id) => {
            if(confirm('이 위젯을 삭제하시겠습니까?')){
                state.dashboard.widgets = state.dashboard.widgets.filter(w => w.id !== id);
                const dbKey = state.activeDefinitionId || 'main';
                await dbUtils.save('dashboard', {id: dbKey, widgets: state.dashboard.widgets});

                ui.renderMainContent();
            }
        },
        renderWidgetContent: async (widget, containerEl) => {
            const entries = (await dbUtils.getAll('entries')).flatMap(d => d.entries)
                .filter(e => e.definitionId === widget.defId && widget.fieldName in e.values)
                .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

            if(state.chartInstances.has(widget.id)) state.chartInstances.get(widget.id).destroy();
            
            containerEl.innerHTML = '';
            if(entries.length === 0){
                containerEl.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400 text-sm">데이터가 없습니다.</div>';
                return;
            }

            ui.widgetManager.render(widget, containerEl, entries, state.chartInstances);
        }
    };

    // =================================================================================
    // EVENT HANDLERS & INITIALIZATION
    // =================================================================================
    const handlers = {
        handleDateChange: (e) => { state.currentDate = e.target.value; state.currentView = 'timeline'; ui.renderMainContent(); },
        handleModalClicks: (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;
            const id = target.dataset.id ? parseInt(target.dataset.id) : null;
            if (action === 'close-modal') ui.closeModal(target.dataset.modalId);
            else if (action === 'save-settings') {
                const rawText = $('#fb-config-textarea').value;
                try {
                    // "const firebaseConfig = " 같은 부분을 제거하고 순수 객체 부분만 추출
                    const objectStr = rawText.substring(rawText.indexOf('{'), rawText.lastIndexOf('}') + 1);
                    if (!objectStr) throw new Error("객체 형식을 찾을 수 없습니다.");
                    
                    // JSON5와 유사한 형식(마지막 쉼표 등)도 파싱하기 위해 Function 생성자 사용
                    const config = new Function(`return ${objectStr}`)();

                    // storageBucket 주소 자동 보정
                    if (config.storageBucket && config.storageBucket.includes('firebasestorage')) {
                        config.storageBucket = config.storageBucket.replace('.firebasestorage.app', '.appspot.com');
                    }
                    
                    if (configManager.isValid(config)) {
                        configManager.save(config);
                        alert("설정이 저장되었습니다. 페이지를 새로고침합니다.");
                        window.location.reload();
                    } else {
                        alert("입력된 설정 값이 유효하지 않습니다. 모든 필수 키가 포함되었는지 확인하세요.");
                    }
                } catch (error) {
                    console.error("Firebase config parsing error:", error);
                    alert("설정 값을 파싱하는 데 실패했습니다. 올바른 형식의 객체를 붙여넣었는지 확인하십시오.");
                }
            }
            else if (action === 'save-def') logic.saveDefinition(id);
            else if (action === 'add-field') {
                const container = $('#def-fields-container');
                const newField = document.createElement('div');
                newField.className = 'field-row flex gap-3 items-center';
                newField.innerHTML = `<input type="text" class="field-name-input flex-grow h-11 px-4 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500" placeholder="필드 이름">
<select class="field-type-select h-11 px-3 bg-white rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500">
    <option value="Text">텍스트</option>
    <option value="Number">숫자</option>
    <option value="Date">날짜</option>
    <option value="Checkbox">체크박스</option>
    <option value="Textarea">장문 텍스트</option>
    <option value="Image">이미지</option>
</select>
<button class="button w-11 h-11 flex-shrink-0 flex items-center justify-center bg-slate-100 text-slate-500 rounded-lg hover:bg-red-100 hover:text-red-600" data-action="remove-field"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                container.appendChild(newField);
                ui.refreshIcons();
            } else if (action === 'remove-field') target.closest('.field-row').remove();
            else if (action === 'save-widget') logic.saveWidget(id);
        },
        handleWidgetFormClicks: (e) => {
            const target = e.target.closest('[data-action="select-chart-type"]');
            if(target){
                document.querySelectorAll('[data-action="select-chart-type"]').forEach(btn => btn.classList.remove('bg-blue-100', 'border-blue-500'));
                target.classList.add('bg-blue-100', 'border-blue-500');
                const allowedFields = JSON.parse(target.dataset.fields);
                const sourceDiv = $('#widget-data-source');
                const defSelect = $('#widget-def-select');
                const fieldSelect = $('#widget-field-select');
                
                defSelect.innerHTML = '<option value="">관찰 대상 선택</option>' + state.definitions.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                fieldSelect.innerHTML = '<option value="">필드 선택</option>';
                sourceDiv.classList.remove('hidden');

                defSelect.onchange = () => {
                    const defId = parseInt(defSelect.value);
                    const def = state.definitions.find(d => d.id === defId);
                    if (def) {
                        fieldSelect.innerHTML = '<option value="">필드 선택</option>' + def.fields
                            .filter(f => allowedFields.includes(f.fieldType))
                            .map(f => `<option value="${f.fieldName}">${f.fieldName}</option>`).join('');
                    }
                };

                const widgetModal = target.closest('#widget-modal-content');
                if(widgetModal){
                    const currentWidgetId = widgetModal.querySelector('[data-action="save-widget"]').dataset.id;
                    const widget = state.dashboard.widgets.find(w => w.id == currentWidgetId);
                    if(widget && widget.defId) {
                        defSelect.value = widget.defId;
                        defSelect.onchange();
                        if(widget.fieldName) fieldSelect.value = widget.fieldName;
                    }
                }
            }
        },
        handleSettings: () => {
            const config = configManager.load();
            ui.showSettingsModal(config);
        },
        handleLogout: () => {
            if (confirm('로그아웃 하시겠습니까?')) {
                logic.signOut();
            }
        },
        handleScroll: () => {
            if (state.currentView !== 'timeline' || state.isLoadingMore) return;
            
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollHeight - scrollTop - clientHeight < 500) {
                if (state.lastLoadedDate) {
                    logic.loadAndRenderDays(dayjs(state.lastLoadedDate), 5); // 마지막으로 로드된 날짜부터 다시 5개의 '일'을 찾아 로드
                }
            }
        },
        handleCommandBarFocus: () => ui.showSuggestions(''),
        handleCommandBarInput: (e) => ui.showSuggestions(e.target.value),
        handleSuggestionClick: (e) => {
            const button = e.target.closest('button');
            if (button) ui.showDynamicForm(button.dataset.type, button.dataset.id ? parseInt(button.dataset.id) : null);
        },
        handleFormActionClick: async (e) => {
             const target = e.target.closest('[data-action]');
             if (!target) return;
             if (target.dataset.action === 'cancel-entry') {
                 ui.resetCommandBar();
             } else if (target.dataset.action === 'save-entry') {
                const entryId = target.dataset.entryId ? parseInt(target.dataset.entryId) : null;
                const type = target.dataset.type;
                
                let defId = null; // defId를 null로 초기화하여 'journal' 유형의 기본값으로 설정합니다.

                // 'log' 유형일 경우에만 ID 파싱 및 유효성 검사를 엄격하게 수행합니다.
                if (type === 'log') {
                    const defIdStr = target.dataset.id;
                    const parsedId = parseInt(defIdStr);
                    if (isNaN(parsedId)) {
                        alert("저장 오류: 유효하지 않은 대상 ID입니다. 로그 항목은 반드시 대상에 연결되어야 합니다.");
                        return; // ID가 유효하지 않으면 작업을 즉시 중단합니다.
                    }
                    defId = parsedId;
                }
                
                // 각 유형에 맞는 올바른 파라미터로 saveEntry 함수를 호출합니다.
                // Journal의 경우: ('journal', null, entryId)
                // Log의 경우: ('log', 123, entryId)
                await logic.saveEntry(type, defId, entryId);
             }
        },
        handleDocumentClick: (e) => {
            if (!elements.commandBarWrapper.contains(e.target) && e.target.id !== 'command-bar-input') ui.clearSuggestions();
        },
        handleActionRailClick: (e) => {
            const button = e.target.closest('button.rail-icon-button[data-view-id]');
            if (button) {
                window.location.hash = button.dataset.viewId;
            }
        },
        handleTimelineActions: async (action, target, id) => {
            if (!id) return;
            if (action === 'edit-entry') {
                let entryToEdit;
                const allEntries = await dbUtils.getAll('entries');
                for (const day of allEntries) {
                    const found = day.entries.find(e => e.id === id);
                    if (found) { entryToEdit = found; break; }
                }
                if (entryToEdit) ui.showDynamicForm(entryToEdit.type, entryToEdit.definitionId, entryToEdit);
                else console.error(`Error: Entry with id ${id} not found.`);
            } else if (action === 'delete-entry') {
                logic.deleteEntry(id);
            }
        },
        handleDashboardActions: (action, target, id) => {
            switch (action) {
                case 'add-widget':
                    ui.renderWidgetForm();
                    break;
                case 'edit-widget':
                    ui.renderWidgetForm(state.dashboard.widgets.find(w => w.id === id));
                    break;
                case 'delete-widget':
                    logic.deleteWidget(id);
                    break;
                case 'navigate-heatmap':
                    const widgetId = parseInt(target.closest('[data-widget-id]').dataset.widgetId);
                    const date = target.closest('[data-date]').dataset.date;
                    const widget = state.dashboard.widgets.find(w => w.id === widgetId);
                    if (widget) {
                        widget.displayMonth = date;
                        const widgetEl = target.closest('.widget');
                        if (widgetEl) {
                            const contentEl = widgetEl.querySelector('.widget-content');
                            if (contentEl) logic.renderWidgetContent(widget, contentEl);
                        }
                    }
                    break;
            }
        },
        handleWorkspaceActions: (action, target, id) => {
            switch (action) {
                case 'set-workspace-view':
                    state.workspace.viewMode = target.dataset.view;
                    ui.renderWorkspaceContent();
                    break;
                case 'add-def':
                    ui.renderDefinitionForm('new');
                    break;
                case 'edit-def':
                    ui.renderDefinitionForm(state.definitions.find(d => d.id === id));
                    break;
                case 'delete-def':
                    logic.deleteDefinition(id);
                    break;
                case 'toggle-node':
                    if (state.workspace.expandedNodes.has(id)) state.workspace.expandedNodes.delete(id);
                    else state.workspace.expandedNodes.add(id);
                    ui.renderWorkspaceTree();
                    ui.refreshIcons();
                    break;
            }
        },
        handleCalendarActions: (action, target) => {
            switch (action) {
                case 'prev-month':
                    state.calendar.viewMonth = dayjs(state.calendar.viewMonth).subtract(1, 'month').format('YYYY-MM-DD');
                    ui.renderCalendar();
                    break;
                case 'next-month':
                    state.calendar.viewMonth = dayjs(state.calendar.viewMonth).add(1, 'month').format('YYYY-MM-DD');
                    ui.renderCalendar();
                    break;
                case 'select-calendar-date':
                    const selectedDate = target.dataset.date;
                    const { selectionStart, selectionEnd } = state.calendar;

                    if (!selectionStart || (selectionStart && selectionEnd)) {
                        state.calendar.selectionStart = selectedDate;
                        state.calendar.selectionEnd = null;
                    } else {
                        if (dayjs(selectedDate).isBefore(selectionStart)) {
                            state.calendar.selectionStart = selectedDate;
                        } else {
                            state.calendar.selectionEnd = selectedDate;
                            logic.loadDataForDateRange(state.calendar.selectionStart, state.calendar.selectionEnd);
                        }
                    }
                    ui.renderCalendar();
                    break;
            }
        },
        handleMainContentClick: async (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const id = target.dataset.id ? parseInt(target.dataset.id) : null;

            // 1. 뷰 전환 액션 우선 처리
            const viewChangeActions = {
                'view-definition-dashboard': () => window.location.hash = `def/${id}`,
                'back-to-workspace': () => window.location.hash = 'workspace',
                'select-date': () => {
                    state.currentDate = target.dataset.date;
                    window.location.hash = 'timeline';
                }
            };

            if (viewChangeActions[action]) {
                viewChangeActions[action]();
                return; // 뷰 전환 후 추가 작업 방지
            }

            // 2. 현재 뷰에 맞는 전문 핸들러에게 이벤트 처리 위임
            const actionHandlers = {
                'timeline': () => handlers.handleTimelineActions(action, target, id),
                'dashboard': () => handlers.handleDashboardActions(action, target, id),
                'definition-dashboard': () => handlers.handleDashboardActions(action, target, id), // 대시보드 액션 재사용
                'workspace': () => handlers.handleWorkspaceActions(action, target, id),
                'calendar': () => handlers.handleCalendarActions(action, target)
            };

            const handler = actionHandlers[state.currentView];
            if (handler) {
                handler();
            }
        },
        handleMainContentInput: (e) => {
            if (state.currentView === 'workspace' && e.target.id === 'workspace-search-input') {
                state.workspace.searchQuery = e.target.value; ui.renderWorkspaceContent();
            }
        },
        init: async () => {
            const $ = selector => document.querySelector(selector);
            // [수정] DOM 로드 후 요소를 찾도록 elements 객체 정의를 이 위치로 이동
            const elements = {
                mainHeader: $('#main-header'), headerMainContent: $('#header-main-content'),
                searchBar: $('#search-bar'), searchInput: $('#search-input'), cancelSearchBtn: $('.cancel-search-btn'),
                datePicker: $('#date-picker'), mainContent: $('#main-content'),
                commandBarWrapper: $('#command-bar-wrapper'), commandBarInput: $('#command-bar-input'),
                suggestionBox: $('#suggestion-box'), dynamicFormContainer: $('#dynamic-form-container'),
                searchBtn: $('#search-btn'), actionRail: $('#action-rail'), modalContainer: $('#modal-container'),
                settingsBtn: $('#settings-btn'), logoutBtn: $('#logout-btn'),
                appOverlay: $('#app-overlay'), loginContainer: $('#login-container'), loginBtn: $('#login-btn'),
                loaderContainer: $('#loader-container'),
            };

            ui.refreshIcons(); // 초기 아이콘 렌더링
            
            // [수정] localStorage에서 설정을 불러오는 로직 복원
            const config = configManager.load();
            if (config && configManager.isValid(config)) {
                state.firebaseConfig = config;
                firebaseUtils.init(config);
            } else {
                ui.showSettingsModal();
                elements.loaderContainer.classList.add('hidden');
                elements.loginContainer.classList.add('hidden');
                elements.appOverlay.classList.remove('hidden', 'opacity-0');
            }

            if (state.isFirebaseReady) {
                firebase.onAuthStateChanged(fbAuth, (user) => logic.handleAuthStateChanged(user, elements));
            }

            ui.initializeActionRail();
            
            elements.datePicker.addEventListener('change', handlers.handleDateChange);
            elements.searchBtn.addEventListener('click', () => ui.toggleSearchMode(true, elements));
            elements.cancelSearchBtn.addEventListener('click', () => ui.toggleSearchMode(false, elements));
            elements.searchInput.addEventListener('input', (e) => logic.searchGlobal(e.target.value));
            elements.actionRail.addEventListener('click', handlers.handleActionRailClick);
            elements.mainContent.addEventListener('click', handlers.handleMainContentClick);
            elements.mainContent.addEventListener('input', handlers.handleMainContentInput);
            window.addEventListener('scroll', handlers.handleScroll);
            elements.modalContainer.addEventListener('click', (e) => handlers.handleModalClicks(e, elements));
            elements.modalContainer.addEventListener('click', handlers.handleWidgetFormClicks);
            elements.commandBarInput.addEventListener('focus', handlers.handleCommandBarFocus);
            elements.commandBarInput.addEventListener('input', handlers.handleCommandBarInput);
            elements.suggestionBox.addEventListener('click', handlers.handleSuggestionClick);
            elements.dynamicFormContainer.addEventListener('click', handlers.handleFormActionClick);
            document.addEventListener('click', (e) => handlers.handleDocumentClick(e, elements));
            window.addEventListener('hashchange', logic.handleRouteChange);
            
            elements.settingsBtn.addEventListener('click', handlers.handleSettings);
            elements.loginBtn.addEventListener('click', logic.signInWithGoogle);
            elements.logoutBtn.addEventListener('click', handlers.handleLogout);

            logic.handleRouteChange();
        }
    };
    
    document.addEventListener('DOMContentLoaded', handlers.init);
    </script>
</body>
</html>


