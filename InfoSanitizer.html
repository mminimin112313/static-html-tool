<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Text Anonymizer App Enhanced v4.1 (Clipboard Fix & Help)</title>
<style>
:root{
  --bg:#fafafa;--fg:#222;--accent:#2563eb;--border:#e5e7eb;--glass:rgba(255,255,255,.75);
}
html,body{height:100%}
body{margin:0;display:flex;flex-direction:column;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}

/* â”€â”€ ë²„íŠ¼ íŒ¨ë„ â”€â”€ */
#buttonPanel{
  position:fixed;top:0;left:0;right:0;z-index:1000;
  display:flex;gap:.4rem;justify-content:center;
  padding:.45rem .8rem;
  backdrop-filter:blur(12px);background:var(--glass);border-bottom:1px solid rgba(0,0,0,.08);
  flex-wrap: wrap;
}
#buttonPanel button, #buttonPanel .file-input-wrapper {
  flex:1 1 100px;
  padding:.45rem 0;font-size:.85rem;font-weight:600;background:var(--accent);color:#fff;
  border:none;border-radius:9999px;box-shadow:0 2px 6px rgba(0,0,0,.12);transition:transform .15s;
  cursor: pointer; text-align: center; line-height: 1.5;
  margin-bottom: .2rem;
}
#buttonPanel button:hover, #buttonPanel .file-input-wrapper:hover {transform:translateY(-2px)}
.file-input-wrapper input[type="file"] { display: none; }

/* â”€â”€ ë©”ì¸ â”€â”€ */
#mainContainer{
  flex:1;display:flex;gap:1rem;padding:calc(80px + 1rem) 1rem 1rem; /* ë²„íŠ¼ íŒ¨ë„ ë†’ì´ ë”°ë¼ ìœ ë™ì ìœ¼ë¡œ */
  overflow:hidden
}
@media(max-width:768px){
  #mainContainer{ padding-top: calc(120px + 1rem); /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ íŒ¨ë„ 2ì¤„ë  ê²½ìš° */}
}

#textDisplayArea{
  flex:3;min-height:0;padding:1rem;border:1px solid var(--border);border-radius:.75rem;background:#fff;
  overflow:auto;white-space:pre-wrap;line-height:1.6; user-select: text;
}
#navigatorArea{
  flex:1;min-width:260px;border:1px solid var(--border);border-radius:.75rem;background:#fff;overflow:auto;padding:.5rem;
  display: flex; flex-direction: column;
}
#directAddContainer {
  display: flex; gap: 0.5rem; padding: 0.3rem; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem;
}
#directAddInput {
  flex-grow: 1; padding: 0.4rem 0.6rem; border: 1px solid var(--border); border-radius: .4rem; font-size: 0.85rem;
}
#directAddButton {
  padding: 0.4rem 0.7rem; font-size: 0.9rem; background: var(--accent); color: #fff; border: none; border-radius: .4rem; cursor: pointer;
}
#directAddButton:hover { background: #1e4bb1; }

.nav-list { flex-grow: 1; overflow-y: auto; }
.nav-item{display:flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border-radius:.5rem;cursor:pointer;user-select:none}
.nav-item:hover{background:rgba(0 0 0/.05)}
.nav-txt{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap; font-size: 0.85rem;}
.nav-item button{background:none;border:none;font-size:.8rem;cursor:pointer;color:#ef4444; padding: 0.2rem 0.4rem;}

/* â”€â”€ ëª¨ë‹¬ & íŒì—… â”€â”€ */
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:.75rem;padding:1.2rem 1.5rem;z-index:999;box-shadow:0 4px 16px rgba(0 0 0/.18); width: 80vw; max-width: 600px;}
.modal h3 { margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; color: var(--accent);}
.modal textarea{width:100%;box-sizing:border-box;height:38vh;padding:.5rem;resize:vertical; border:1px solid var(--border); border-radius: .5rem; margin-bottom: 0.8rem;}
.modal input[type="text"]{width:100%;box-sizing:border-box;padding:.5rem; border:1px solid var(--border); border-radius: .5rem; margin-bottom: 0.8rem;}
.modal-actions { text-align:right; margin-top:.8rem; display: flex; gap: 0.5rem; justify-content: flex-end;}
.modal-actions button { padding: .5rem 1rem; font-size: .9rem; border-radius: .5rem; border: none; cursor: pointer; }
.modal-actions button.primary { background-color: var(--accent); color: white; }
.modal-actions button.secondary { background-color: #e5e7eb; color: var(--fg); }

.popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:.6rem; padding:.55rem .9rem; display:flex;gap:.8rem;}
.popup button{background:none;border:none;font-size:20px;line-height:1;cursor:pointer;user-select:none;opacity:.85}
.popup button:hover{opacity:1}
.hidden{display:none!important}
.dimmed::before{content:"";position:fixed;inset:0;background:rgba(0 0 0/.45);z-index:998}
mark[data-original]{padding:.1rem .15rem;border-radius:.25rem;color:#fff;cursor:pointer;}
mark[data-original]:hover { filter: brightness(1.1); }

#toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);padding:.65rem 1rem;background:#333;color:#fff;border-radius:.5rem;font-size:.875rem;opacity:0;pointer-events:none;transition:opacity .3s;z-index:1100}
#toast.show{opacity:.92}

/* ì¶”ì²œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
#suggestionModalContent { max-height: 60vh; overflow-y: auto; margin-bottom: 1rem; }
.suggestion-item { display: flex; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid #eee; }
.suggestion-item:last-child { border-bottom: none; }
.suggestion-item input[type="checkbox"] { margin-right: 0.8rem; transform: scale(1.1); }
.suggestion-item label { flex-grow: 1; font-size: 0.9rem; word-break: break-all; }
.suggestion-item .suggestion-type { font-size: 0.75rem; color: #777; margin-left: 0.5rem; background-color: #f0f0f0; padding: 0.1rem 0.3rem; border-radius: 0.2rem; white-space: nowrap;}

/* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ë‚´ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
#modal-delete-mark p { margin-bottom: 1rem; word-break: break-all; }
#modal-delete-mark strong { color: var(--accent); }

/* ë„ì›€ë§ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
#helpModalContent { max-height: 60vh; overflow-y: auto; font-size: 0.9rem; line-height: 1.7; }
#helpModalContent h4 { margin-top: 1.2rem; margin-bottom: 0.5rem; color: var(--accent); font-size: 1rem;}
#helpModalContent p { margin-bottom: 0.6rem; }
#helpModalContent ul { padding-left: 1.5rem; margin-bottom: 0.8rem;}
#helpModalContent li { margin-bottom: 0.3rem; }
#helpModalContent code { background-color: #f0f0f0; padding: 0.1rem 0.3rem; border-radius: 0.2rem; font-size: 0.85rem;}

/* í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes shake-animation-kf {
  10%, 90% { transform: translate3d(-1px, 0, 0); }
  20%, 80% { transform: translate3d(2px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
  40%, 60% { transform: translate3d(3px, 0, 0); }
}
.shake-animation {
  animation: shake-animation-kf 0.6s cubic-bezier(.36,.07,.19,.97) both;
}

/* â”€â”€ ëª¨ë°”ì¼ â”€â”€ */
@media(max-width:768px){
  body{font-size:15px}
  #buttonPanel button, #buttonPanel .file-input-wrapper { flex: 1 1 calc(50% - .4rem); font-size: .8rem; }
  #mainContainer{flex-direction:column;gap:.6rem;padding:calc(120px + .8rem) .6rem .6rem}
  #navigatorArea{position:fixed;left:0;right:0;bottom:0;height:40vh;border-radius:.75rem .75rem 0 0;box-shadow:0 -4px 12px rgba(0 0 0/.12);transform:translateY(100%);transition:transform .25s ease;pointer-events:none}
  #navigatorArea.open{transform:translateY(0);pointer-events:auto}
  #navToggle{display:block}
  .modal{width:90vw; max-width: 90vw;}
  .modal textarea{height:45vh}
  .popup button{font-size:24px}
}
#navToggle{
  display:none;
  position:fixed;right:1rem;bottom:1rem;
  width:50px;height:50px;border:none;border-radius:50%;
  background:var(--accent);color:#fff;font-size:1.3rem;
  box-shadow:0 3px 8px rgba(0 0 0/.18);cursor:pointer;z-index:900;
}
@media(max-width:768px){ #navToggle{ display:block; } }
</style>
</head>

<body>
<div id="buttonPanel">
  <button id="btn-input">í…ìŠ¤íŠ¸ ì…ë ¥</button>
  <button id="btn-suggest">ì¶”ì²œ ë°›ê¸°</button>
  <button id="btn-convert">ë³€í™˜ & ë³µì‚¬</button>
  <button id="btn-recover">ì›ë³¸ ë³µêµ¬</button>
  <button id="btn-reset">ì „ì²´ ì´ˆê¸°í™”</button>
  <label class="file-input-wrapper">
    ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    <input type="file" id="btn-load-list" accept=".json">
  </label>
  <button id="btn-save-list">ëª©ë¡ ì €ì¥</button>
  <button id="btn-help">ë„ì›€ë§</button>
</div>

<div id="mainContainer">
  <div id="textDisplayArea" tabindex="0"></div>
  <div id="navigatorArea">
    <div id="directAddContainer">
        <input type="text" id="directAddInput" placeholder="ì§ì ‘ ì¶”ê°€í•  ë‹¨ì–´ ì…ë ¥...">
        <button id="directAddButton" title="ëª©ë¡ì— ì§ì ‘ ì¶”ê°€">+</button>
    </div>
    <div class="nav-list"></div>
  </div>
</div>

<button id="navToggle" title="ëª©ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°">ğŸ“‹</button>

<div id="modal-input" class="modal hidden">
  <h3>í…ìŠ¤íŠ¸ ì…ë ¥</h3>
  <textarea id="ta-input" placeholder="ì—¬ê¸°ì— ìµëª…í™”í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
  <div class="modal-actions">
    <button id="submit-input" class="primary">ì œì¶œ</button>
    <button class="secondary modal-close-btn" data-modal-id="modal-input">ì·¨ì†Œ</button>
  </div>
</div>

<div id="modal-recover" class="modal hidden">
  <h3>ì›ë³¸ í…ìŠ¤íŠ¸ ë³µêµ¬</h3>
  <textarea id="ta-recover" placeholder="ìµëª…í™”ëœ í…ìŠ¤íŠ¸ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
  <div class="modal-actions">
    <button id="submit-recover" class="primary">ë³µêµ¬ & ë³µì‚¬</button>
    <button class="secondary modal-close-btn" data-modal-id="modal-recover">ì·¨ì†Œ</button>
  </div>
</div>

<div id="modal-edit" class="modal hidden">
  <h3>ì¹˜í™˜ìŒ í¸ì§‘</h3>
  <input id="edit-orig" style="width:100%;margin-bottom:.6rem" placeholder="ì›ë³¸ ë¬¸ìì—´" readonly>
  <input id="edit-repl" style="width:100%" placeholder="ì¹˜í™˜ë  ë¬¸ìì—´">
  <div class="modal-actions">
    <button id="save-edit" class="primary">ì €ì¥</button>
    <button class="secondary modal-close-btn" data-modal-id="modal-edit">ì·¨ì†Œ</button>
  </div>
</div>

<div id="modal-suggestions" class="modal hidden">
  <h3>ìµëª…í™” ì¶”ì²œ</h3>
  <div id="suggestionModalContent">
    <p>ë¶„ì„ ì¤‘...</p>
  </div>
  <div class="modal-actions">
    <button id="add-selected-suggestions" class="primary">ì„ íƒ í•­ëª© ì¶”ê°€</button>
    <button class="secondary modal-close-btn" data-modal-id="modal-suggestions">ë‹«ê¸°</button>
  </div>
</div>

<div id="modal-delete-mark" class="modal hidden">
  <h3>ìµëª…í™” í•­ëª© ì‚­ì œ</h3>
  <p>ì •ë§ë¡œ '<strong id="delete-mark-original-text"></strong>' (ìœ¼)ë¡œ ì¹˜í™˜ëœ í•­ëª© <strong id="delete-mark-replacement-text" style="color: var(--fg); font-weight:normal;"></strong> ì„(ë¥¼) ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
  <div class="modal-actions">
    <button id="confirm-delete-mark" class="primary" style="background-color: #ef4444;">ì‚­ì œ</button>
    <button class="secondary modal-close-btn" data-modal-id="modal-delete-mark">ì·¨ì†Œ</button>
  </div>
</div>

<div id="modal-help" class="modal hidden">
  <h3>ë„ì›€ë§</h3>
  <div id="helpModalContent">
    <h4>ê¸°ë³¸ ì‚¬ìš©ë²•</h4>
    <p>1. <strong>í…ìŠ¤íŠ¸ ì…ë ¥:</strong> ìƒë‹¨ì˜ 'í…ìŠ¤íŠ¸ ì…ë ¥' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìµëª…í™”í•  ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</p>
    <p>2. <strong>í•­ëª© ì¶”ê°€:</strong></p>
    <ul>
      <li><strong>í…ìŠ¤íŠ¸ ë“œë˜ê·¸ ì„ íƒ:</strong> ì…ë ¥ëœ í…ìŠ¤íŠ¸ ì˜ì—­ì—ì„œ ìµëª…í™”í•  ë‹¨ì–´ë‚˜ êµ¬ë¬¸ì„ ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•©ë‹ˆë‹¤. ë‚˜íƒ€ë‚˜ëŠ” íŒì—…ì—ì„œ âœ¨(ìë™ ìƒì„±) ë˜ëŠ” âœï¸(ì§ì ‘ ì…ë ¥)ì„ ì„ íƒí•˜ì—¬ ì¹˜í™˜ ê·œì¹™ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</li>
      <li><strong>ì¶”ì²œ ë°›ê¸°:</strong> 'ì¶”ì²œ ë°›ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ ê°œì¸ì •ë³´(ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, ì£¼ë¯¼ë²ˆí˜¸ ë“±)ë‚˜ ë°˜ë³µë˜ëŠ” ë‹¨ì–´ë¥¼ ì¶”ì²œí•´ì¤ë‹ˆë‹¤. ì›í•˜ëŠ” í•­ëª©ì„ ì„ íƒí•˜ì—¬ ëª©ë¡ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ì§ì ‘ ì¶”ê°€:</strong> ìš°ì¸¡ íŒ¨ë„ ìƒë‹¨ì˜ ì…ë ¥ì°½ì— ì§ì ‘ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ê³  '+' ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì¹˜í™˜ë  ê°’ì€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</li>
    </ul>
    <p>3. <strong>ë³€í™˜ & ë³µì‚¬:</strong> 'ë³€í™˜ & ë³µì‚¬' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë“±ë¡ëœ ì¹˜í™˜ ê·œì¹™ì— ë”°ë¼ í…ìŠ¤íŠ¸ê°€ ìµëª…í™”ë˜ì–´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë©ë‹ˆë‹¤.</p>

    <h4>ì¹˜í™˜ ëª©ë¡ ê´€ë¦¬ (ìš°ì¸¡ íŒ¨ë„)</h4>
    <ul>
      <li><strong>í•­ëª© í´ë¦­:</strong> ëª©ë¡ì˜ í•­ëª©ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í•­ëª©ì˜ <code>ì¹˜í™˜ë  ë¬¸ìì—´</code>ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë©ë‹ˆë‹¤.</li>
      <li><strong>í•­ëª© ê¸¸ê²Œ í´ë¦­ (í„°ì¹˜ ê¸¸ê²Œ ëˆ„ë¥´ê¸°):</strong> ëª©ë¡ì˜ í•­ëª©ì„ ê¸¸ê²Œ í´ë¦­(PC)í•˜ê±°ë‚˜ ê¸¸ê²Œ ëˆ„ë¥´ë©´(ëª¨ë°”ì¼) í•´ë‹¹ í•­ëª©ì˜ <code>ì¹˜í™˜ë  ë¬¸ìì—´</code>ì„ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” í¸ì§‘ì°½ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</li>
      <li><strong>í•­ëª© ì‚­ì œ (âœ–ï¸ ë²„íŠ¼):</strong> ê° í•­ëª© ì˜†ì˜ âœ–ï¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª©ë¡ì—ì„œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>í‘œì‹œëœ í…ìŠ¤íŠ¸ì˜ ë§ˆí¬ í´ë¦­:</strong> ì›ë³¸ í…ìŠ¤íŠ¸ ì˜ì—­ì—ì„œ ì´ë¯¸ ìµëª…í™” í‘œì‹œ(ìƒ‰ìƒ ë°°ê²½)ëœ ë¶€ë¶„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í•­ëª©ì„ ëª©ë¡ì—ì„œ ë°”ë¡œ ì‚­ì œí•  ìˆ˜ ìˆëŠ” í™•ì¸ì°½ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</li>
    </ul>

    <h4>ë¶€ê°€ ê¸°ëŠ¥</h4>
    <ul>
      <li><strong>ì›ë³¸ ë³µêµ¬:</strong> 'ì›ë³¸ ë³µêµ¬' ë²„íŠ¼ì„ í´ë¦­ í›„, ì´ì „ì— ìµëª…í™”í–ˆë˜ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ ì›ë˜ ë‚´ìš©ìœ¼ë¡œ ë³µêµ¬í•˜ì—¬ í´ë¦½ë³´ë“œì— ë³µì‚¬í•´ì¤ë‹ˆë‹¤. (ë‹¨, ë³µêµ¬ ì‹œì ì˜ ì¹˜í™˜ ëª©ë¡ì„ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.)</li>
      <li><strong>ì „ì²´ ì´ˆê¸°í™”:</strong> ëª¨ë“  ì›ë³¸ í…ìŠ¤íŠ¸ì™€ ì¹˜í™˜ ëª©ë¡ì„ ì‚­ì œí•©ë‹ˆë‹¤. (ì£¼ì˜: ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)</li>
      <li><strong>ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°/ì €ì¥:</strong> í˜„ì¬ ì¹˜í™˜ ëª©ë¡ì„ JSON íŒŒì¼ í˜•íƒœë¡œ ì €ì¥í•˜ê±°ë‚˜, ì €ì¥ëœ ëª©ë¡ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li><strong>ëª¨ë°”ì¼ ëª©ë¡ í† ê¸€:</strong> ëª¨ë°”ì¼ í™”ë©´ì—ì„œëŠ” ìš°ì¸¡ í•˜ë‹¨ì˜ ğŸ“‹ ë²„íŠ¼ìœ¼ë¡œ ì¹˜í™˜ ëª©ë¡ íŒ¨ë„ì„ ì—´ê³  ë‹«ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
    <h4>íŒ</h4>
    <ul>
        <li>ì¹˜í™˜ ê·œì¹™ì€ <strong>ê³µë°±ì„ ì œê±°í•œ ê¸€ì ìˆ˜ê°€ ì§§ì€ ìˆœ</strong>ìœ¼ë¡œ, ê¸€ì ìˆ˜ê°€ ê°™ë‹¤ë©´ <strong>ì›ë¬¸ ê¸¸ì´ê°€ ì§§ì€ ìˆœ</strong>ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ "í™ê¸¸ë™"ê³¼ "í™ê¸¸ë™ íŒ€ì¥"ì´ ëª¨ë‘ ëª©ë¡ì— ìˆë‹¤ë©´, "í™ê¸¸ë™"ì´ ë¨¼ì € ì²˜ë¦¬ëœ í›„ "í™ê¸¸ë™ íŒ€ì¥"ì˜ ë‚¨ì€ ë¶€ë¶„(ì˜ˆ: " íŒ€ì¥")ì´ ì²˜ë¦¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ê³ ë ¤í•˜ì—¬ í•­ëª©ì„ ë“±ë¡í•˜ì„¸ìš”.</li>
        <li>'ì¶”ì²œ ë°›ê¸°'ëŠ” ì™„ë²½í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ê°œì¸ì •ë³´ëŠ” ì§ì ‘ í™•ì¸í•˜ê³  ì¶”ê°€/ì‚­ì œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>
    </ul>
  </div>
  <div class="modal-actions">
    <button class="secondary modal-close-btn" data-modal-id="modal-help">ë‹«ê¸°</button>
  </div>
</div>


<div id="selectionPopup" class="popup hidden"><button id="btn-auto" title="ìë™ ìƒì„± (ëœë¤)">âœ¨</button><button id="btn-manual" title="ì§ì ‘ ì…ë ¥">âœï¸</button></div>
<div id="toast"></div>

<script>
(function(){
  'use strict';

  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  const DATA_KEY = 'anonymizerAppData_v4.1'; // Updated version key
  const PALETTE = ['#FF6B6B','#4D96FF','#FFD93D','#6BCB77','#845EC2','#FF9671','#00C9A7','#B0A8B9','#FFC75F','#0081CF',
    '#F9F871','#FF8066','#2A9D8F','#E76F51','#A56CC1','#00B8A9','#F64C72','#6C5B7B','#F9C74F','#118AB2',
    '#EF476F','#06D6A0','#FFD166','#073B4C','#8D99AE','#FFB627','#06AED5','#A4036F','#048BA8','#FF7C43',
    '#5F0F40','#9A031E','#FCDC4D','#23CE6B','#3A0CA3','#7209B7','#4361EE','#4CC9F0','#F72585','#B5179E',
    '#FC5185','#3FC1C9','#364F6B','#43AA8B','#90BE6D','#F9844A','#F94144','#577590','#277DA1','#4D908E',
    '#F3722C','#F8961E','#00B4D8','#0077B6','#023E8A','#03045E','#F48C06','#D00000','#6A040F','#370617',
    '#9D0208','#DC2F02','#E85D04','#FAA307','#FFBA08','#003049','#D62828','#F77F00','#FCBF49','#EAE2B7',
    '#70C1B3','#B2DBBF','#FDFFFC','#FFB6B9','#FAE3D9','#BBDED6','#8AC6D1','#CDB4DB','#FFC8DD','#FFAFCC',
    '#B5E48C','#99D98C','#76C893','#52B69A','#34A0A4','#00C49A','#FFCD56','#4E79A7','#A0CBE8','#F28E2B',
    '#E15759','#76B7B2','#59A14F','#EDC948','#B07AA1','#FF9DA7'];

  let state = loadState();
  let currentSelectionRange = null;
  let longPressTimer = null;
  let longPressTargetItem = null;
  let currentMarkToDelete = { original: null, element: null };

  // --- DOM Elements ---
  const textDisplayArea = $('#textDisplayArea');
  const navigatorUiList = $('#navigatorArea .nav-list');
  const selectionPopup = $('#selectionPopup');
  const navToggle = $('#navToggle');
  const directAddInput = $('#directAddInput');
  const toastElement = $('#toast');

  const inputModal = { element: $('#modal-input'), textarea: $('#ta-input'), submitButton: $('#submit-input') };
  const recoverModal = { element: $('#modal-recover'), textarea: $('#ta-recover'), submitButton: $('#submit-recover') };
  const editModal = { element: $('#modal-edit'), originalInput: $('#edit-orig'), replacementInput: $('#edit-repl'), saveButton: $('#save-edit') };
  const suggestionsModal = { element: $('#modal-suggestions'), contentArea: $('#suggestionModalContent'), addSelectedButton: $('#add-selected-suggestions') };
  const deleteMarkModal = {
    element: $('#modal-delete-mark'),
    originalTextSpan: $('#delete-mark-original-text'),
    replacementTextSpan: $('#delete-mark-replacement-text'),
    confirmButton: $('#confirm-delete-mark')
  };
  const helpModal = { element: $('#modal-help') };


  // --- State Management ---
  function getDefaultState() {
    return { originalText: '', mappings: {}, anonymizedText: '' };
  }

  function loadState() {
    try {
      const storedState = localStorage.getItem(DATA_KEY);
      if (storedState) {
        const parsed = JSON.parse(storedState);
        if (parsed && typeof parsed.mappings === 'object' && !Array.isArray(parsed.mappings)) {
          return { ...getDefaultState(), ...parsed };
        }
      }
    } catch (error) {
      console.error("Failed to load state:", error);
    }
    return getDefaultState();
  }

  function saveState() {
    try {
      localStorage.setItem(DATA_KEY, JSON.stringify(state));
    } catch (error) {
      console.error("Failed to save state:", error);
      showToast("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³µê°„ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
  }

  function resetState() {
    if (confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„° (ì…ë ¥ëœ í…ìŠ¤íŠ¸, ì¹˜í™˜ ëª©ë¡)ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
      state = getDefaultState();
      saveState();
      renderAll();
      showToast("ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  }

  // --- Utility Functions ---
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function generateRandomString(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  function showToast(msg, duration = 2800){ // Using user's default duration
    const t = toastElement; // Already cached as toastElement
    if (!t) return;
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), duration);
  }

  // --- Clipboard Functions (User Provided Logic Adapted) ---
  async function copyToClipboard(text, successMessage) {
    if (typeof text !== 'string') {
        console.error('copyToClipboard: text to copy must be a string. Received:', text);
        showToast('ë³µì‚¬í•  ë‚´ìš©ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    try {
      await navigator.clipboard.writeText(text);
      if (successMessage) showToast(successMessage);
    } catch (err) {
      console.warn('navigator.clipboard.writeText failed, trying fallback:', err);
      fallbackCopy(text, successMessage);
    }
  }

  function fallbackCopy(text, successMessage) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.top = '0';
    ta.style.left = '-9999px'; // Ensure it's off-screen
    document.body.appendChild(ta);
    ta.select();
    ta.focus(); // Ensure focus for execCommand

    try {
      const successful = document.execCommand('copy');
      if (successful) {
        if (successMessage) showToast(successMessage + ' (Fallback)');
      } else {
        showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Fallback)');
      }
    } catch (err) {
      console.error('Fallback copy exception:', err);
      showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. (Fallback)');
    }
    document.body.removeChild(ta);
  }

  function normalizeMappingKey(originalString) {
    if (typeof originalString !== 'string') return '';
    return originalString.replace(/\s+/g, ' ').trim();
  }

  // --- UI Rendering ---
  function renderAll() {
    renderTextDisplay();
    renderNavigator();
  }

  function createRegexForMatching(keyFromMappings) {
    const coreChars = keyFromMappings.replace(/\s+/g, "").split('');
    if (coreChars.length === 0) return new RegExp(escapeRegExp(keyFromMappings), 'g');

    if (keyFromMappings.indexOf(' ') === -1) {
        return new RegExp(escapeRegExp(keyFromMappings), 'g');
    }
    const refinedPatternString = coreChars.map(escapeRegExp).join('\\s*');
    return new RegExp(refinedPatternString, 'g');
  }

  function getSortedMappings(forReplacement = true) {
    return Object.entries(state.mappings).sort((a, b) => {
        const keyA = a[0];
        const keyB = b[0];

        if (forReplacement) {
            const coreLengthA = keyA.replace(/\s+/g, "").length;
            const coreLengthB = keyB.replace(/\s+/g, "").length;

            if (coreLengthA !== coreLengthB) {
                return coreLengthA - coreLengthB;
            }
            return keyA.length - keyB.length;
        } else {
            return b[1].replacement.length - a[1].replacement.length;
        }
    });
  }

  function renderTextDisplay() {
    if (!textDisplayArea) return;
    if (!state.originalText) {
      textDisplayArea.innerHTML = '<p style="color:#aaa; text-align:center; margin-top: 2rem;">ìµëª…í™”í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>';
      return;
    }

    let highlightedText = state.originalText;
    const sortedMappings = getSortedMappings(true);

    for (const [originalKey, { replacement, color }] of sortedMappings) {
      const regex = createRegexForMatching(originalKey);
      try {
        highlightedText = highlightedText.replace(regex, (match) => {
          return `<mark style="background:${color};color:#fff" data-original="${originalKey.replace(/"/g, '&quot;')}" data-repl="${replacement.replace(/"/g, '&quot;')}">${match}</mark>`;
        });
      } catch (e) {
        console.warn(`Error creating/using RegExp for highlighting: key="${originalKey}"`, e);
      }
    }
    textDisplayArea.innerHTML = highlightedText;
  }

  function renderNavigator() {
    if (!navigatorUiList) return;
    navigatorUiList.innerHTML = '';

    const displaySortedMappings = Object.entries(state.mappings)
        .sort((a,b) => a[0].localeCompare(b[0]));

    displaySortedMappings.forEach(([originalKey, { replacement, color }]) => {
        const item = document.createElement('div');
        item.className = 'nav-item';
        item.style.background = `${color}22`;
        item.dataset.key = originalKey;

        const textSpan = document.createElement('span');
        textSpan.className = 'nav-txt';
        textSpan.textContent = originalKey;
        textSpan.title = `${originalKey} â†’ ${replacement}`;

        const deleteButton = document.createElement('button');
        deleteButton.dataset.del = originalKey;
        deleteButton.title = 'ì‚­ì œ';
        deleteButton.textContent = 'âœ–';

        item.appendChild(textSpan);
        item.appendChild(deleteButton);
        navigatorUiList.appendChild(item);
      });
  }

  // --- Modal Handling ---
  function openModal(modal) {
    if (!modal || !modal.element) return;
    modal.element.classList.remove('hidden');
    document.body.classList.add('dimmed');

    if (modal === inputModal && state.originalText) {
      modal.textarea.value = state.originalText;
    }
    if (modal === recoverModal) {
        modal.textarea.value = '';
    }
  }

  function closeModal(modalOrSelector) {
    const modalElement = typeof modalOrSelector === 'string' ? $(modalOrSelector) : modalOrSelector.element;
    if (modalElement) {
      modalElement.classList.add('hidden');
    }
    const anyModalOpen = Array.from($$('.modal')).some(m => !m.classList.contains('hidden'));
    if (!anyModalOpen) {
      document.body.classList.remove('dimmed');
    }
  }

  // --- Core Functionality ---
  function generateUniqueReplacement(baseName = "í•­ëª©", length = 5) {
    let replacement;
    let attempts = 0;
    do {
      replacement = `[${baseName}_${generateRandomString(length + Math.floor(attempts / 5))}]`;
      attempts++;
    } while (Object.values(state.mappings).some(m => m.replacement === replacement) && attempts < 50);

    if (attempts >= 50) {
        replacement = `[${baseName}_${Date.now().toString().slice(-6)}]`;
    }
    return replacement;
  }

  function addNewMapping(originalString, replacement, color, type = "ì¼ë°˜") {
    if (!originalString || typeof originalString !== 'string' || !originalString.trim()) {
      showToast("ì›ë³¸ ë¬¸ìì—´ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return false;
    }
    const keyForStorage = originalString.trim();

    if (state.mappings[keyForStorage]) {
      showToast(`'${keyForStorage}'ì€(ëŠ”) ì´ë¯¸ ë“±ë¡ëœ í•­ëª©ì…ë‹ˆë‹¤.`);
      return false;
    }

    let finalReplacement = replacement;
    if (!finalReplacement || typeof finalReplacement !== 'string' || !finalReplacement.trim()) {
      let baseName = type === "ì¼ë°˜" ? "í•­ëª©" : type;
      if (type.includes("ì´ë¦„")) baseName = "ì´ë¦„";
      else if (type.includes("ì—°ë½ì²˜") || type.includes("ì „í™”")) baseName = "ì—°ë½ì²˜";
      else if (type.includes("ì£¼ë¯¼")) baseName = "ì£¼ë¯¼ë²ˆí˜¸";
      else if (type.includes("ì´ë©”ì¼")) baseName = "ì´ë©”ì¼";
      else if (type.includes("ë°˜ë³µ")) baseName = "ë°˜ë³µí•­ëª©";
      else if (type.includes("ì„ íƒ")) baseName = "ì„ íƒ";
      else if (type.includes("ì§ì ‘ì¶”ê°€")) baseName = "í•­ëª©";
      finalReplacement = generateUniqueReplacement(baseName, Math.max(3, Math.min(8, keyForStorage.replace(/\s+/g,"").length)));
    }

    state.mappings[keyForStorage] = {
      replacement: finalReplacement,
      color: color || PALETTE[Object.keys(state.mappings).length % PALETTE.length]
    };
    return true;
  }

  function handleSubmitInput() {
    const text = inputModal.textarea.value;
    if (!text.trim()) {
      showToast("ì…ë ¥ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    state.originalText = text;
    state.anonymizedText = '';
    saveState();
    renderAll();
    closeModal(inputModal);
    showToast("í…ìŠ¤íŠ¸ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function handleConvertAndCopy() {
    if (!state.originalText) {
      showToast('ë¨¼ì € í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (Object.keys(state.mappings).length === 0) {
        showToast('ë“±ë¡ëœ ì¹˜í™˜ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë³€í™˜í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
        if (confirm("ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            copyToClipboard(state.originalText, "ì›ë³¸ í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        return;
    }

    let outputText = state.originalText;
    const sortedMappings = getSortedMappings(true);

    for (const [originalKey, { replacement }] of sortedMappings) {
      const regex = createRegexForMatching(originalKey);
      try {
        outputText = outputText.replace(regex, replacement);
      } catch (e) {
        console.warn(`Error creating/using RegExp for replacement: key="${originalKey}"`, e);
      }
    }
    state.anonymizedText = outputText;
    saveState();
    copyToClipboard(outputText, "ë³€í™˜ëœ í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function handleSubmitRecover() {
    const anonymizedInput = recoverModal.textarea.value;
    if (!anonymizedInput.trim()) {
      showToast("ë³µêµ¬í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (Object.keys(state.mappings).length === 0) {
        showToast('ì¹˜í™˜ ëª©ë¡ì´ ë¹„ì–´ìˆì–´ ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }

    let recoveredText = anonymizedInput;
    const recoverySortedMappings = getSortedMappings(false);

    for (const [originalKey, { replacement }] of recoverySortedMappings) {
        const replacementRegex = new RegExp(escapeRegExp(replacement), 'g');
        recoveredText = recoveredText.replace(replacementRegex, originalKey);
    }

    state.originalText = recoveredText;
    saveState();
    renderAll();
    copyToClipboard(recoveredText, "ë³µêµ¬ëœ í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    closeModal(recoverModal);
  }

  function handleDirectAdd() {
    const textToAdd = directAddInput.value;
    if (!textToAdd.trim()) {
      showToast("ì¶”ê°€í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    const keyForStorage = textToAdd.trim();

    if (state.mappings[keyForStorage]) {
      showToast(`'${keyForStorage}'ì€(ëŠ”) ì´ë¯¸ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.`);
      return;
    }

    if (addNewMapping(textToAdd, null, null, "ì§ì ‘ì¶”ê°€")) {
      saveState();
      renderAll();
      showToast(`'${keyForStorage}' í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      directAddInput.value = '';
      directAddInput.focus();
    }
  }

  function handleSaveEditedMapping() {
    const originalKeyInEditor = editModal.originalInput.value;
    const newReplacement = editModal.replacementInput.value.trim();

    if (!newReplacement) {
      showToast("ì¹˜í™˜ë  ë¬¸ìì—´ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (state.mappings[originalKeyInEditor]) {
      state.mappings[originalKeyInEditor].replacement = newReplacement;
      saveState();
      renderAll();
      closeModal(editModal);
      showToast("ì¹˜í™˜ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
      showToast("ì˜¤ë¥˜: í¸ì§‘í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  }

  // --- Text Selection & Popup ---
  function handleTextSelectionOnDisplay(event) {
    const selection = window.getSelection();
    const selectedText = selection.toString();

    const clickedMark = event.target.closest('mark[data-original]');
    if (clickedMark) {
        selectionPopup.classList.add('hidden');
        currentSelectionRange = null;

        const original = clickedMark.dataset.original;
        // Ensure the key exists before trying to access its properties
        if (original && state.mappings[original]) {
            currentMarkToDelete = { original: original, element: clickedMark };
            deleteMarkModal.originalTextSpan.textContent = original;
            deleteMarkModal.replacementTextSpan.textContent = `(${state.mappings[original].replacement})`;

            clickedMark.classList.add('shake-animation');
            setTimeout(() => clickedMark.classList.remove('shake-animation'), 700);

            openModal(deleteMarkModal);
        } else if (original) {
             console.warn("Clicked mark's original key not found in mappings:", original);
             showToast("í•´ë‹¹ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
        return;
    }

    if (selectedText.trim().length > 0 && textDisplayArea.contains(selection.anchorNode)) {
      currentSelectionRange = selection.getRangeAt(0);
      const rect = currentSelectionRange.getBoundingClientRect();

      selectionPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
      selectionPopup.style.left = `${rect.left + window.scrollX + rect.width / 2 - selectionPopup.offsetWidth / 2}px`;
      selectionPopup.classList.remove('hidden');
    } else {
      if (!selectionPopup.contains(event.target)) {
          selectionPopup.classList.add('hidden');
          currentSelectionRange = null;
      }
    }
  }

  function registerSelection(mode) {
    if (!currentSelectionRange) return;
    const selectedText = currentSelectionRange.toString();
    if (!selectedText.trim()) {
      showToast("ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
      selectionPopup.classList.add('hidden');
      return;
    }
    const keyForStorage = selectedText.trim();

    if (state.mappings[keyForStorage]) {
      showToast(`'${keyForStorage}'ì€(ëŠ”) ì´ë¯¸ ë“±ë¡ëœ í•­ëª©ì…ë‹ˆë‹¤.`);
      selectionPopup.classList.add('hidden');
      return;
    }

    let replacementText;
    if (mode === 'auto') {
      replacementText = null;
    } else {
      const promptText = keyForStorage.replace(/\s+/g, "_").substring(0,10);
      replacementText = prompt(`'${selectedText}'ì„(ë¥¼) ì¹˜í™˜í•  ë¬¸ìì—´ì„ ì…ë ¥í•˜ì„¸ìš”:`, `[${promptText}_ì§ì ‘]`);
      if (replacementText === null) {
        selectionPopup.classList.add('hidden');
        currentSelectionRange = null;
        return;
      }
      if (replacementText.trim() === "") {
        showToast("ì¹˜í™˜ë  ë¬¸ìì—´ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        selectionPopup.classList.add('hidden');
        currentSelectionRange = null;
        return;
      }
    }

    if (addNewMapping(selectedText, replacementText, null, "ì„ íƒ")) {
      saveState();
      renderAll();
      showToast(`'${keyForStorage}' â†’ '${state.mappings[keyForStorage].replacement}' ì¶”ê°€ë¨`);
    }
    selectionPopup.classList.add('hidden');
    currentSelectionRange = null;
    if (window.getSelection()) window.getSelection().removeAllRanges();
  }

  // --- Suggestion Engine ---
  function cleanKoreanNameCandidate(text) {
    if (!text || typeof text !== 'string') return "";
    let cleaned = text.trim();

    const suffixesToRemove = [
        "ì”¨", "ë‹˜", "ë‹˜ì€", "ë‹˜ê»˜ì„œëŠ”", "ê¸°ì", "íŒ€ì¥", "ë¶€ì¥", "ê³¼ì¥", "ëŒ€ë¦¬", "ì‚¬ì›", "ì¸í„´",
        "ì—°êµ¬ì›", "êµìˆ˜", "í•™ìƒ", "ì„ ìƒ", "ëŒ€í‘œ", "ì´ì‚¬", "ì‹¤ì¥", "ì£¼ì„", "ë°˜ì¥", "ì‚¬ì¥", "íšŒì¥",
        "ì˜¹", "êµ°", "ì–‘",
        "ì€", "ëŠ”", "ì´", "ê°€", "ì„", "ë¥¼", "ì—ê²Œ", "ê»˜ì„œ", "ê»˜", "ì˜", "ê³¼", "ì™€",
        "ìœ¼ë¡œ", "ë¡œ", "ë¶€í„°", "ê¹Œì§€", "ë§Œ", "ë„"
    ];

    for (const suffix of suffixesToRemove) {
        if (cleaned.endsWith(suffix)) {
            const temp = cleaned.substring(0, cleaned.length - suffix.length).trim();
            if (temp.length >= (commonSurnames.includes(temp.charAt(0)) && temp.length === 1 ? 1 : 2) && temp.length > 0) {
                 cleaned = temp;
            }
        }
    }
    cleaned = cleaned.replace(/[.,!?]$/, "").trim();
    return cleaned;
  }

  const commonSurnames = ['ê¹€', 'ì´', 'ë°•', 'ìµœ', 'ì •', 'ê°•', 'ì¡°', 'ìœ¤', 'ì¥', 'ì„', 'í•œ', 'ì˜¤', 'ì„œ', 'ì‹ ', 'ê¶Œ', 'í™©', 'ì•ˆ', 'ì†¡', 'ë¥˜', 'ì „', 'í™', 'ê³ ', 'ë¬¸', 'ì–‘', 'ì†', 'ë°°', 'ë°±', 'í—ˆ', 'ìœ ', 'ë‚¨', 'ì‹¬', 'ë…¸', 'í•˜', 'ê³½', 'ì„±', 'ì°¨', 'ì£¼', 'ìš°', 'êµ¬', 'ë‚˜'];

  function generateSuggestions(text) {
    let suggestions = [];
    const existingNormalizedKeys = new Set(Object.keys(state.mappings).map(k => normalizeMappingKey(k)));
    const foundSuggestions = new Map();

    const patterns = [
      { regex: /\b(?:\d{2}(?:0[1-9]|1[0-2])(?:0[1-9]|[12]\d|3[01]))\s*-\s*[1-4]\d{6}\b/g, type: 'ì£¼ë¯¼ë²ˆí˜¸' },
      { regex: /\b01[016789](?:-|\s*-\s*)\d{3,4}(?:-|\s*-\s*)\d{4}\b/g, type: 'ì „í™”ë²ˆí˜¸' },
      { regex: /\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b/g, type: 'ì´ë©”ì¼' },
      { regex: /\b(?:[ê°€-í£]{1,2}\s)?[ê°€-í£]{2,4}\b/g, type: 'ì´ë¦„(ì¼ë°˜)', isName: true },
      { regex: new RegExp(`\\b(?:${commonSurnames.join('|')})[ê°€-í£]{1,2}\\b`, 'g'), type: 'ì´ë¦„(ì„±ì”¨ê¸°ë°˜)', isName: true },
      { regex: /[ê°€-í£]{2,4}\s*(?:ì”¨|ë‹˜|ë‹˜ì€|ë‹˜ê»˜ì„œëŠ”|ê¸°ì|íŒ€ì¥|ë¶€ì¥|ê³¼ì¥|ëŒ€ë¦¬|ì‚¬ì›|ì¸í„´|ì—°êµ¬ì›|êµìˆ˜|í•™ìƒ|ì„ ìƒ|ëŒ€í‘œ|ì´ì‚¬|ì‹¤ì¥|ì£¼ì„|ë°˜ì¥|ì‚¬ì¥|íšŒì¥|ì˜¹|êµ°|ì–‘)\b/g, type: 'ì´ë¦„(í˜¸ì¹­)', isName: true, trimSuffix: true},
    ];

    patterns.forEach(p => {
      let match;
      while ((match = p.regex.exec(text)) !== null) {
        let matchedText = match[0];
        let type = p.type;

        if (p.isName) {
            let cleanedName = matchedText;
            if (p.trimSuffix) {
                 cleanedName = cleanedName.replace(/\s*(?:ì”¨|ë‹˜|ë‹˜ì€|ë‹˜ê»˜ì„œëŠ”|ê¸°ì|íŒ€ì¥|ë¶€ì¥|ê³¼ì¥|ëŒ€ë¦¬|ì‚¬ì›|ì¸í„´|ì—°êµ¬ì›|êµìˆ˜|í•™ìƒ|ì„ ìƒ|ëŒ€í‘œ|ì´ì‚¬|ì‹¤ì¥|ì£¼ì„|ë°˜ì¥|ì‚¬ì¥|íšŒì¥|ì˜¹|êµ°|ì–‘)\b/g, '').trim();
            }
            cleanedName = cleanKoreanNameCandidate(cleanedName);

            if (cleanedName.length < 2 || (cleanedName.length === 2 && !commonSurnames.includes(cleanedName[0])) ) continue;
            if (cleanedName.length > 5) continue;
            if (!/^[ê°€-í£\s]+$/.test(cleanedName)) continue;

            matchedText = cleanedName;
        }

        const normalizedMatch = normalizeMappingKey(matchedText);
        if (!normalizedMatch || normalizedMatch.length < (p.type === 'ì´ë©”ì¼' ? 5 : 2)) continue;
        if (existingNormalizedKeys.has(normalizedMatch)) continue;

        if (foundSuggestions.has(normalizedMatch)) {
          foundSuggestions.get(normalizedMatch).count++;
        } else {
          foundSuggestions.set(normalizedMatch, { text: matchedText, type: type, count: 1 });
        }
      }
    });

    const hangulWordCounts = new Map();
    const hangulRegex = /[ê°€-í£]+/g;
    let hangulMatch;
    while((hangulMatch = hangulRegex.exec(text)) !== null) {
        const word = hangulMatch[0];
        if (word.length >= 2 && word.length <= 10 && /^[ê°€-í£]+$/.test(word)) {
            hangulWordCounts.set(word, (hangulWordCounts.get(word) || 0) + 1);
        }
    }

    hangulWordCounts.forEach((count, word) => {
        if (count >= 3) {
            const normalizedWord = normalizeMappingKey(word);
            if (!existingNormalizedKeys.has(normalizedWord) && !foundSuggestions.has(normalizedWord)) {
                if (word.length === 1 && "ì€ëŠ”ì´ê°€ì„ë¥¼ë„ë§Œê³¼ì™€ë¡œì˜".includes(word)) return;
                foundSuggestions.set(normalizedWord, { text: word, type: 'ë°˜ë³µ(í•œê¸€)', count: count });
            }
        }
    });

    suggestions = Array.from(foundSuggestions.values());

    suggestions.sort((a, b) => {
      const piiOrder = {'ì£¼ë¯¼ë²ˆí˜¸':1, 'ì „í™”ë²ˆí˜¸':2, 'ì´ë©”ì¼':3};
      const typeOrderA = piiOrder[a.type] || (a.type.startsWith('ì´ë¦„') ? 4 : (a.type.startsWith('ë°˜ë³µ') ? 5 : 6));
      const typeOrderB = piiOrder[b.type] || (b.type.startsWith('ì´ë¦„') ? 4 : (b.type.startsWith('ë°˜ë³µ') ? 5 : 6));

      if (typeOrderA !== typeOrderB) return typeOrderA - typeOrderB;
      if (b.count !== a.count) return b.count - a.count;
      return b.text.replace(/\s+/g,"").length - a.text.replace(/\s+/g,"").length;
    });

    return suggestions.slice(0, 70);
  }

  function openSuggestionModal() {
    if (!state.originalText) {
      showToast("ì¶”ì²œì„ ë°›ìœ¼ë ¤ë©´ ë¨¼ì € í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    openModal(suggestionsModal);
    suggestionsModal.contentArea.innerHTML = '<p>í…ìŠ¤íŠ¸ ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>';

    setTimeout(() => {
      const suggestions = generateSuggestions(state.originalText);
      if (suggestions.length === 0) {
        suggestionsModal.contentArea.innerHTML = '<p>ìë™ìœ¼ë¡œ ì¶”ì²œí•  ë§Œí•œ í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì¶”ê°€ ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.</p>';
        return;
      }
      suggestionsModal.contentArea.innerHTML = suggestions.map((s, index) => `
        <div class="suggestion-item">
          <input type="checkbox" id="suggestion-${index}" value="${s.text.replace(/"/g, '&quot;')}" data-type="${s.type}" checked>
          <label for="suggestion-${index}">${s.text}</label>
          <span class="suggestion-type">${s.type} (${s.count}íšŒ)</span>
        </div>
      `).join('');
    }, 100);
  }

  function handleAddSelectedSuggestions() {
    const checkboxes = $$('#suggestionModalContent input[type="checkbox"]:checked');
    let addedCount = 0;
    checkboxes.forEach(cb => {
      const textToAnonymize = cb.value;
      const type = cb.dataset.type;
      if (addNewMapping(textToAnonymize, null, null, type)) {
        addedCount++;
      }
    });

    if (addedCount > 0) {
      saveState();
      renderAll();
      showToast(`${addedCount}ê°œì˜ ì¶”ì²œ í•­ëª©ì´ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } else {
      showToast("ì„ íƒëœ í•­ëª©ì´ ì—†ê±°ë‚˜, ì´ë¯¸ ëª©ë¡ì— ì¡´ì¬í•˜ê±°ë‚˜, ì¶”ê°€í•  ìˆ˜ ì—†ëŠ” í•­ëª©ì…ë‹ˆë‹¤.");
    }
    closeModal(suggestionsModal);
  }

  // --- File Operations (Save/Load Mappings) ---
  function saveMappingsList() {
    if (Object.keys(state.mappings).length === 0) {
      showToast("ì €ì¥í•  ì¹˜í™˜ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    try {
      const mappingsJson = JSON.stringify(state.mappings, null, 2);
      const blob = new Blob([mappingsJson], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `anonymizer_mappings_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("ì¹˜í™˜ ëª©ë¡ì´ íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (error) {
      console.error("Error saving mappings list:", error);
      showToast("ëª©ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.");
    }
  }

  function loadMappingsList(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const loadedData = JSON.parse(e.target.result);
        if (typeof loadedData !== 'object' || loadedData === null || Array.isArray(loadedData)) {
          throw new Error("ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        }

        let mergedCount = 0, overwrittenCount = 0, invalidCount = 0;
        for (const [original, mapData] of Object.entries(loadedData)) {
          if (mapData && typeof mapData.replacement === 'string' && typeof mapData.color === 'string') {
            const keyForStorage = original.trim();
            if (!keyForStorage) {
                invalidCount++;
                continue;
            }
            if (state.mappings[keyForStorage]) overwrittenCount++;
            else mergedCount++;
            state.mappings[keyForStorage] = {
                replacement: mapData.replacement,
                color: mapData.color
            };
          } else {
            console.warn(`Skipping invalid mapping data for key: ${original}`);
            invalidCount++;
          }
        }
        saveState();
        renderAll();
        let message = `ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${mergedCount}ê°œ ì¶”ê°€, ${overwrittenCount}ê°œ ë®ì–´ì”€.`;
        if (invalidCount > 0) message += ` (${invalidCount}ê°œ í•­ëª©ì€ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ ê±´ë„ˆëœ€)`;
        showToast(message);
      } catch (error) {
        showToast(`íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ${error.message}`);
        console.error("Error loading mappings list:", error);
      } finally {
        event.target.value = null;
      }
    };
    reader.onerror = () => {
        showToast("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        event.target.value = null;
    };
    reader.readAsText(file);
  }

  // --- Event Listener Setup ---
  function setupEventListeners() {
    $('#btn-input').addEventListener('click', () => openModal(inputModal));
    $('#btn-suggest').addEventListener('click', openSuggestionModal);
    $('#btn-convert').addEventListener('click', handleConvertAndCopy);
    $('#btn-recover').addEventListener('click', () => openModal(recoverModal));
    $('#btn-reset').addEventListener('click', resetState);
    $('#btn-save-list').addEventListener('click', saveMappingsList);
    $('#btn-load-list').addEventListener('change', loadMappingsList);
    $('#btn-help').addEventListener('click', () => openModal(helpModal)); // ë„ì›€ë§ ë²„íŠ¼

    inputModal.submitButton.addEventListener('click', handleSubmitInput);
    recoverModal.submitButton.addEventListener('click', handleSubmitRecover);
    editModal.saveButton.addEventListener('click', handleSaveEditedMapping);
    suggestionsModal.addSelectedButton.addEventListener('click', handleAddSelectedSuggestions);

    deleteMarkModal.confirmButton.addEventListener('click', () => {
        if (currentMarkToDelete.original && state.mappings[currentMarkToDelete.original]) {
            delete state.mappings[currentMarkToDelete.original];
            saveState();
            renderAll();
            showToast(`'${currentMarkToDelete.original}' í•­ëª©ì´ ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeModal(deleteMarkModal);
            currentMarkToDelete = { original: null, element: null };
        } else {
            showToast("ì‚­ì œí•  í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            closeModal(deleteMarkModal);
        }
    });

    $$('.modal-close-btn').forEach(btn => {
      btn.addEventListener('click', () => closeModal(`#${btn.dataset.modalId}`));
    });

    $('#directAddButton').addEventListener('click', handleDirectAdd);
    directAddInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleDirectAdd();
    });

    $('#btn-auto').addEventListener('click', () => registerSelection('auto'));
    $('#btn-manual').addEventListener('click', () => registerSelection('manual'));

    textDisplayArea.addEventListener('click', handleTextSelectionOnDisplay);
    textDisplayArea.addEventListener('touchend', (e) => { // For mobile tap to trigger selection logic
        setTimeout(() => handleTextSelectionOnDisplay(e), 50);
    });


    navigatorUiList.addEventListener('click', (e) => {
      if (longPressTimer) { // Clear long press if a click happens
        clearTimeout(longPressTimer);
        longPressTimer = null;
        longPressTargetItem = null;
      }

      const deleteButton = e.target.closest('button[data-del]');
      if (deleteButton) {
        const keyToDelete = deleteButton.dataset.del;
        if (confirm(`'${keyToDelete}' í•­ëª©ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          if (state.mappings[keyToDelete]) {
            delete state.mappings[keyToDelete];
            saveState();
            renderAll();
            showToast(`'${keyToDelete}' í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          }
        }
        return; // Stop propagation to navItem click
      }

      const navItem = e.target.closest('.nav-item');
      if (navItem) {
        const key = navItem.dataset.key;
        if (state.mappings[key]) {
          copyToClipboard(state.mappings[key].replacement, `'${state.mappings[key].replacement}' ë³µì‚¬ ì™„ë£Œ`);
        }
      }
    });

    navigatorUiList.addEventListener('pointerdown', (e) => {
      const navItem = e.target.closest('.nav-item');
      if (!navItem || e.target.closest('button[data-del]')) return; // Don't trigger for delete button or non-item area

      longPressTargetItem = navItem;
      longPressTimer = setTimeout(() => {
        if (!longPressTargetItem) return; // Target might have changed or pointerup occurred

        const keyToEdit = longPressTargetItem.dataset.key;
        if (state.mappings[keyToEdit]) {
          editModal.originalInput.value = keyToEdit;
          editModal.replacementInput.value = state.mappings[keyToEdit].replacement;
          editModal.replacementInput.focus();
          openModal(editModal);
        } else {
          console.warn("Long press target key not found in state:", keyToEdit);
        }
        longPressTimer = null;
        longPressTargetItem = null;
      }, 700); // 700ms for long press
    });

    const clearLongPress = () => {
      if (longPressTimer) clearTimeout(longPressTimer);
      longPressTimer = null;
      longPressTargetItem = null;
    };
    navigatorUiList.addEventListener('pointerup', clearLongPress);
    navigatorUiList.addEventListener('pointerleave', clearLongPress); // Clear if pointer leaves the list area
    navigatorUiList.addEventListener('contextmenu', (e) => { // Prevent context menu on long press
        if(e.target.closest('.nav-item')) e.preventDefault();
    });

    document.addEventListener('click', (e) => {
      if (!selectionPopup.classList.contains('hidden') &&
          !selectionPopup.contains(e.target) &&
          !textDisplayArea.contains(e.target)) {
          if(window.getSelection().toString() === ''){ // Only hide if no text is actively selected
            selectionPopup.classList.add('hidden');
            currentSelectionRange = null;
          }
      }
    });

    document.addEventListener('selectionchange', () => {
        if (window.getSelection().toString().trim() === '' && !selectionPopup.classList.contains('hidden')) {
            // If an element within the popup is focused (like an input, if we add one later), don't hide
            if (!selectionPopup.contains(document.activeElement)) {
              selectionPopup.classList.add('hidden');
              currentSelectionRange = null;
            }
        }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        $$('.modal:not(.hidden)').forEach(m => closeModal({element: m}));
        if (!selectionPopup.classList.contains('hidden')) {
          selectionPopup.classList.add('hidden');
          currentSelectionRange = null;
        }
      }
    });

    if (navToggle) {
      navToggle.addEventListener('click', () => {
        $('#navigatorArea').classList.toggle('open');
        navToggle.textContent = $('#navigatorArea').classList.contains('open') ? 'âœ•' : 'ğŸ“‹';
      });
    }
  }

  // --- Initialization ---
  function initializeApp() {
    renderAll();
    setupEventListeners();
    showToast("ì•± V4.1 ë¡œë“œ ì™„ë£Œ! (í´ë¦½ë³´ë“œ ê°œì„ , ë„ì›€ë§ ì¶”ê°€)");
    console.log("Substitution order for overlapping strings: SHORTER core strings (no spaces) are processed first, then by original length.");
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }

})();
</script>
</body>
</html>
