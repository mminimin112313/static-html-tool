<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logify Ultimate v2 | Hierarchies & Tags</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <style>
        /*
            DESIGN SYSTEM DEFINITION (v2.5 - "Expanded")
            --------------------------------
            * Added hierarchical views and tags.
        */

        :root {
            --spacing-1: 4px; --spacing-2: 8px; --spacing-3: 16px; --spacing-4: 24px;
            --color-primary: #007AFF; --color-primary-dark: #0056b3; --color-primary-light: #e6f2ff;
            --color-background: #F7F7F9; --color-surface: #FFFFFF;
            --color-text-primary: #1C1C1E; --color-text-secondary: #8A8A8E;
            --color-border: #E5E5EA; --color-danger: #FF3B30;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 12px;
        }

        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'IBM Plex Sans KR', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            margin: 0;
            padding-bottom: 80px;
        }
        .container { max-width: 720px; margin: 0 auto; padding: var(--spacing-4); }

        /* === HEADER & SEARCH BAR === */
        #main-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-3) var(--spacing-4); background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--color-border); position: sticky; top: 0; z-index: 100; }
        #main-header .logo { font-size: 22px; font-weight: 600; }
        #main-header .controls, #main-header .icon-tray { display: flex; align-items: center; gap: var(--spacing-3); }
        #main-header .icon-button { background: none; border: none; cursor: pointer; padding: var(--spacing-2); border-radius: 50%; display: flex; }
        #main-header .icon-button:hover { background-color: var(--color-border); }
        #main-header .icon-button svg { width: 20px; height: 20px; stroke: var(--color-text-secondary); }
        #search-bar { display: none; width: 100%; align-items: center; gap: var(--spacing-3); }
        #search-input { width: 100%; border: none; background: transparent; font-size: 16px; outline: none; }
        .cancel-search-btn { font-size: 14px; color: var(--color-primary); cursor: pointer; white-space: nowrap; }
        
        /* === TIMELINE === */
        .timeline-date-header {
            font-size: 18px;
            font-weight: 600;
            padding: 16px 0 8px 8px;
            position: sticky;
            top: 60px; /* Adjust based on main-header height */
            background-color: var(--color-background);
            z-index: 10;
        }
        #timeline-container { position: relative; display: grid; gap: var(--spacing-4); }
        .timeline-item { display: grid; grid-template-columns: 50px 1fr; gap: var(--spacing-3); position: relative; }
        .timeline-timestamp { font-size: 12px; font-weight: 500; color: var(--color-text-secondary); text-align: right; padding-top: 4px; }
        .timeline-connector { position: absolute; top: 4px; left: 58px; bottom: -20px; width: 2px; background-color: var(--color-border); }
        .timeline-item:last-child .timeline-connector { display: none; }
        .timeline-content { background-color: var(--color-surface); border-radius: var(--border-radius); box-shadow: var(--shadow-md); padding: var(--spacing-3); }
        .def-item-tags { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
        .timeline-item-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
        .icon-action-button { background: none; border: none; padding: 4px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0.3; transition: opacity 0.2s, background-color 0.2s; }
        .icon-action-button:hover { opacity: 1; background-color: var(--color-border); }
        .icon-action-button svg { width: 16px; height: 16px; }
        .icon-action-button.edit svg { stroke: var(--color-text-secondary); }
        .icon-action-button.delete svg { stroke: var(--color-danger); }
        .log-header { font-size: 17px; font-weight: 600; margin-bottom: var(--spacing-2); }
        .log-body { font-size: 14px; color: var(--color-text-secondary); }
        .log-tags { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
        .log-tag { background-color: var(--color-primary-light); color: var(--color-primary-dark); padding: 2px 8px; font-size: 12px; font-weight: 500; border-radius: 12px; }
        .journal-entry p { margin: 0; white-space: pre-wrap; }

        /* === COMMAND BAR === */
        #command-bar-wrapper { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--color-surface); box-shadow: 0 -4px 15px rgba(0,0,0,0.08); z-index: 1000; }
        #suggestion-box button { display: block; width: 100%; padding: 12px var(--spacing-4); background: none; border: none; border-bottom: 1px solid var(--color-border); text-align: left; cursor: pointer; font-size: 16px; }
        #suggestion-box button:hover { background-color: #f0f0f0; }
        #command-bar-input { width: 100%; border: none; padding: var(--spacing-4); font-size: 16px; font-family: inherit; outline: none; }
        #dynamic-form-container { padding: 0 var(--spacing-4) var(--spacing-4); display: grid; gap: var(--spacing-3); }
        .form-actions { display: flex; gap: var(--spacing-2); justify-content: flex-end; }
        
        /* === PANEL & MODAL === */
        .backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.4); z-index: 1999; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .backdrop.visible { opacity: 1; visibility: visible; }
         body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-container {
            display: flex;
            flex-grow: 1;
            padding: var(--spacing-4);
            gap: var(--spacing-3);
            max-width: 1000px; /* 전체 너비 조정 */
            width: 100%;
            margin: 0 auto;
        }
        #main-content {
            flex-grow: 1;
            min-width: 0; /* flex 아이템이 줄어들 때 내용이 깨지는 것을 방지 */
            background-color: var(--color-surface);
            border-radius: var(--border-radius);
            padding: var(--spacing-4);
            box-shadow: var(--shadow-md);
        }

        /* === [수정] 액션 레일 (고정 네비게이션) === */
        #action-rail {
            flex-shrink: 0;
            width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-3);
            padding-top: var(--spacing-3);
        }
        .rail-icon-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--color-surface);
            border: 1px solid transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-md);
        }
        .rail-icon-button:hover {
            background-color: var(--color-primary-light);
            color: var(--color-primary);
        }
        .rail-icon-button.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary-dark);
        }
        .rail-icon-button svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }
        #settings-modal { position: fixed; inset: 0; z-index: 2000; background-color: var(--color-background); transform: translateY(100%); transition: transform 0.4s ease-in-out; overflow-y: auto; }
        #settings-modal.visible { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-3) var(--spacing-4); border-bottom: 1px solid var(--color-border); background-color: var(--color-surface); }
        .modal-content { padding: var(--spacing-4); }

        /* === GENERIC & FORM COMPONENTS === */
        h2 { font-size: 20px; margin: 0 0 var(--spacing-3) 0; }
        .button { padding: var(--spacing-2) var(--spacing-3); border-radius: 8px; border: none; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .button.primary { background-color: var(--color-primary); color: white; }
        .button.primary:hover { background-color: var(--color-primary-dark); }
        .button.secondary { background-color: var(--color-border); color: var(--color-text-primary); }
        .button.secondary:hover { background-color: #dcdce0; }
        .button.danger { background-color: var(--color-danger); color: white; }
        .form-group { margin-bottom: var(--spacing-3); }
        .form-group label { font-size: 14px; color: var(--color-text-secondary); margin-bottom: var(--spacing-2); display: block; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: var(--spacing-2) var(--spacing-3); border-radius: 8px; border: 1px solid var(--color-border); font-family: inherit; font-size: 16px; }
        .field-row { display: flex; gap: var(--spacing-2); align-items: center; margin-bottom: var(--spacing-2); }
        .def-item { background-color: var(--color-surface); padding: var(--spacing-3); border-radius: var(--border-radius); margin-bottom: var(--spacing-2); }
        .def-item-header { display: flex; justify-content: space-between; align-items: center; }
        .def-item-tags { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
        /* === Calendar === */
         .calendar-container { user-select: none; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-3); }
        .calendar-header h3 { margin: 0; font-size: 18px; }
        .calendar-nav button { background: none; border: none; cursor: pointer; padding: var(--spacing-1); border-radius: 50%; }
        .calendar-nav button:hover { background-color: var(--color-border); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day-name { font-size: 12px; font-weight: 500; color: var(--color-text-secondary); text-align: center; }
        .calendar-day { font-size: 14px; text-align: center; padding: var(--spacing-2) 0; border-radius: 50%; cursor: pointer; position: relative; }
        .calendar-day.is-other-month { color: var(--color-text-secondary); opacity: 0.5; }
        .calendar-day:not(.is-other-month):hover { background-color: var(--color-border); }
        .calendar-day.is-today { font-weight: bold; color: var(--color-primary); }
        .calendar-day.is-selected { background-color: var(--color-primary); color: white; }
        .log-indicator { position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background-color: var(--color-primary); border-radius: 50%; }
        .calendar-day.is-selected .log-indicator { background-color: white; }
    </style>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>
        <header id="main-header">
        <div id="header-main-content" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div class="logo">Logify</div>
            <div class="controls">
                <input type="date" id="date-picker">
                <div class="icon-tray">
                    <button class="icon-button" id="search-btn" title="검색"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg></button>
                    <button class="icon-button" id="settings-btn" title="관찰 대상 관리"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg></button>
                </div>
            </div>
        </div>
        <div id="search-bar">
            <input type="text" id="search-input" placeholder="타임라인에서 검색... (#태그명 으로 검색)">
            <button class="cancel-search-btn">취소</button>
        </div>
    </header>

    <div class="main-container">
        <main class="container" id="main-content">
            </main>
        <aside id="action-rail"></aside>
    </div>

    <footer id="command-bar-wrapper">
        <div id="suggestion-box"></div><div id="dynamic-form-container"></div>
        <input type="text" id="command-bar-input" placeholder="+ 지금 무엇을 기록할까요?">
    </footer>
    
    <section id="settings-modal"></section>

    <script>
    const state = {
        definitions: [],
        // DEPRECATED: currentDate will now represent the 'center' or initially loaded date.
        currentDate: dayjs().format('YYYY-MM-DD'),
        calendarDate: dayjs().format('YYYY-MM-DD'),
        currentView: 'timeline',

        // NEW: A map to cache loaded entries by date string ('YYYY-MM-DD') to prevent re-fetching.
        loadedEntries: new Map(),
        // NEW: An array to track the chronological sequence of dates currently rendered in the timeline.
        visibleTimelineDates: [],
        // NEW: A semaphore flag to prevent race conditions from multiple simultaneous scroll events.
        isLoadingMore: false
    };
    let db;
    const RAIL_CONFIG = [
        {
            id: 'timeline',
            tooltip: '타임라인',
            svg: `<svg>...</svg>`,
            // CORRECTED LOGIC: This function now defines the complete sequence 
            // for rendering the timeline view.
            renderView: () => {
                ui.renderTimeline(); 
                logic.loadDataForDate(state.currentDate);
            }
        },
        {
            id: 'insights',
            tooltip: '인사이트',
            svg: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></svg>`,
            renderView: () => ui.renderInsights()
        },
        {
            id: 'calendar',
            tooltip: '캘린더',
            svg: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M-4.5 12h22.5" /></svg>`,
            renderView: () => ui.renderCalendar(state.calendarDate)
        }
    ];
    let quill; 
    const DB_NAME = 'LogifyUltimateDB_v4_Hierarchical', DB_VERSION = 1;

    const $ = selector => document.querySelector(selector);
    const elements = {
        mainHeader: $('#main-header'), headerMainContent: $('#header-main-content'),
        searchBar: $('#search-bar'), searchInput: $('#search-input'), cancelSearchBtn: $('.cancel-search-btn'),
        datePicker: $('#date-picker'),
        mainContent: $('#main-content'), // 메인 콘텐츠 영역
        commandBarWrapper: $('#command-bar-wrapper'), commandBarInput: $('#command-bar-input'),
        suggestionBox: $('#suggestion-box'), dynamicFormContainer: $('#dynamic-form-container'),
        searchBtn: $('#search-btn'),
        actionRail: $('#action-rail'), // 액션 레일 (네비게이션)
        settingsBtn: $('#settings-btn'),
        settingsModal: $('#settings-modal'),
    };
    
    const sanitizeForId = (str) => str.replace(/[^a-zA-Z0-9-_]/g, '_');
    
    const dbUtils = {
        init: () => new Promise(resolve => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('definitions')) db.createObjectStore('definitions', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('entries')) db.createObjectStore('entries', { keyPath: 'date' });
            };
            req.onsuccess = e => { db = e.target.result; resolve(db); };
        }),
        save: (store, data) => new Promise(res => db.transaction(store, 'readwrite').objectStore(store).put(data).onsuccess = e => res(e.target.result)),
        getAll: (store) => new Promise(res => db.transaction(store, 'readonly').objectStore(store).getAll().onsuccess = e => res(e.target.result)),
        get: (store, key) => new Promise(res => db.transaction(store, 'readonly').objectStore(store).get(key).onsuccess = e => res(e.target.result)),
        delete: (store, key) => new Promise(res => db.transaction(store, 'readwrite').objectStore(store).delete(key).onsuccess = e => res(e.target.result)),
    };

    const ui = {
         renderMainContent: () => {
            const config = RAIL_CONFIG.find(c => c.id === state.currentView);
            if (config && typeof config.renderView === 'function') {
                config.renderView();
            } else {
                elements.mainContent.innerHTML = '<h2>뷰를 찾을 수 없습니다.</h2>';
            }
            ui.updateActiveRailIcon();
        },
        renderTimeline: () => {
            elements.mainContent.innerHTML = '<div id="timeline-container"></div>';
            // The actual loading is now triggered by logic.loadDataForDate
        },
        // REVISED: Completes the function using the new helper.
        renderMoreEntries: (daysData, direction) => {
            const container = $('#timeline-container');
            const fragment = document.createDocumentFragment();

            daysData.forEach(day => {
                const dateHeader = document.createElement('div');
                dateHeader.className = 'timeline-date-header';
                dateHeader.textContent = dayjs(day.date).format('YYYY년 M월 D일');
                fragment.appendChild(dateHeader);

                const sortedEntries = [...day.entries].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                sortedEntries.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    // Use the dedicated helper function for content generation.
                    item.innerHTML = ui.createTimelineItemHtml(entry);
                    fragment.appendChild(item);
                });
            });

            if (direction === 'past') {
                // Preserve scroll position when prepending.
                const oldScrollHeight = container.scrollHeight;
                container.prepend(fragment);
                container.scrollTop += container.scrollHeight - oldScrollHeight;
            } else {
                container.append(fragment);
            }
        },
        renderSearchResults: (results) => {
            elements.mainContent.innerHTML = '<h2>전체 검색 결과</h2><div id="timeline-container"></div>';
            const container = $('#timeline-container');
            if (!results || results.length === 0) {
                elements.timelineContainer.innerHTML += '<p>일치하는 기록이 없습니다.</p>';
                return;
            }
            const sorted = [...results].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            sorted.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                let contentHtml = '';
                const entryDate = dayjs(entry.date).format('YYYY-MM-DD');

                if (entry.type === 'log') {
                    const def = state.definitions.find(d => d.id === entry.definitionId);
                    const body = Object.entries(entry.values).map(([k, v]) => {
                        let displayValue = v;
                        if (typeof v === 'boolean') { displayValue = v ? '✔️' : '❌'; }
                        else if (v === null || v === undefined || v === '') { displayValue = '-'; }
                        return `<span><strong>${k}:</strong> ${displayValue}</span>`;
                    }).join(' / ');
                    const tagsHtml = def && def.tags && def.tags.length > 0
                        ? `<div class="log-tags">${def.tags.map(tag => `<span class="log-tag">${tag}</span>`).join('')}</div>`
                        : '';
                    contentHtml = `<div class="log-header">${def ? def.name : '알 수 없음'}</div><div class="log-body">${body}</div>${tagsHtml}`;
                } else {
                    contentHtml = `<div class="journal-entry"><p>${entry.content}</p></div>`;
                }
                item.innerHTML = `<div class="timeline-timestamp">${dayjs(entry.timestamp).format('HH:mm')}<br><span style="font-size: 10px; color: #999;">${entryDate}</span></div><div class="timeline-content">${contentHtml}</div><div class="timeline-connector"></div>`;
                elements.timelineContainer.appendChild(item);
            });
        },
        initializeActionRail: () => {
            elements.actionRail.innerHTML = '';
            RAIL_CONFIG.forEach(config => {
                const button = document.createElement('button');
                button.className = 'rail-icon-button';
                button.title = config.tooltip;
                button.dataset.viewId = config.id;
                button.innerHTML = config.svg;
                elements.actionRail.appendChild(button);
            });
            ui.updateActiveRailIcon();
        },

        updateActiveRailIcon: () => {
            document.querySelectorAll('.rail-icon-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.viewId === state.currentView);
            });
        },
        createTimelineItemHtml: (entry) => {
            const def = entry.type === 'log' ? state.definitions.find(d => d.id === entry.definitionId) : null;
            
            const actionsHtml = `
                <div class="timeline-item-actions">
                    <button class="icon-action-button edit" data-action="edit-entry" data-id="${entry.id}" title="수정">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"></path></svg>
                    </button>
                    <button class="icon-action-button delete" data-action="delete-entry" data-id="${entry.id}" title="삭제">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.124-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.077-2.09.921-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path></svg>
                    </button>
                </div>
            `;

            let contentHtml = '';
            if (entry.type === 'log' && def) {
                const body = Object.entries(entry.values).map(([k, v]) => {
                    let displayValue = (v === null || v === undefined || v === '') ? '-' : v;
                    if (typeof v === 'boolean') { displayValue = v ? '✔️' : '❌'; }
                    return `<span><strong>${k}:</strong> ${displayValue}</span>`;
                }).join(' / ');
                const tagsHtml = def.tags && def.tags.length > 0
                    ? `<div class="log-tags">${def.tags.map(tag => `<span class="log-tag">${tag}</span>`).join('')}</div>`
                    : '';
                contentHtml = `<div class="log-header">${def.name}</div><div class="log-body">${body}</div>${tagsHtml}`;
            } else if (entry.type === 'journal') {
                contentHtml = `<div class="journal-entry">${entry.content}</div>`;
            } else {
                contentHtml = `<p>데이터를 표시할 수 없습니다.</p>`;
            }
            
            return `
                <div class="timeline-timestamp">${dayjs(entry.timestamp).format('HH:mm')}</div>
                <div class="timeline-content">${actionsHtml}${contentHtml}</div>
                <div class="timeline-connector"></div>
            `;
        },
        toggleSearchMode: (active) => {
            elements.headerMainContent.style.display = active ? 'none' : 'flex';
            elements.searchBar.style.display = active ? 'flex' : 'none';
            if (active) {
                elements.searchInput.focus();
            } else {
                elements.searchInput.value = '';
                state.currentView = 'timeline'; // 검색 취소 시 타임라인으로 복귀
                ui.renderMainContent();
            }
        },

        renderInsights: () => {
            const logs = state.allEntries.filter(e => e.type === 'log');
            const total = logs.length;
            let mostFrequent = '없음';
            if (total > 0) {
                const counts = logs.reduce((acc, log) => {
                    const name = state.definitions.find(d => d.id === log.definitionId)?.name || 'N/A';
                    acc[name] = (acc[name] || 0) + 1;
                    return acc;
                }, {});
                if (Object.keys(counts).length > 0) {
                    mostFrequent = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                }
            }
            elements.mainContent.innerHTML = `<h2>${dayjs(state.currentDate).format('M월 D일')} 요약</h2><div class="summary-card"><div class="summary-item"><span>총 기록 수</span><strong>${total}개</strong></div><div class="summary-item"><span>가장 잦은 활동</span><strong>${mostFrequent}</strong></div></div>`;
        },
        toggleSettingsModal: (show, definitionToEdit = null) => {
            if (show) {
                if (definitionToEdit || definitionToEdit === 'new') {
                     ui.renderDefinitionForm(definitionToEdit);
                } else {
                    ui.renderSettingsList();
                }
            }
            elements.settingsModal.classList.toggle('visible', show);
        },
        toggleActionRail: (viewId) => { 
            const isAlreadyOpen = elements.actionRail.classList.contains('visible');
            const isSameView = state.activeRailView === viewId;
            const targetView = isAlreadyOpen && isSameView ? null : viewId;

            state.activeRailView = targetView; 

            if (targetView) {
                const config = RAIL_CONFIG.find(c => c.id === targetView);
                if (!config) return;

                const renderAndShow = async () => {
                    await Promise.resolve(config.renderView()); // 동기/비동기 렌더링 함수 모두 지원
                    elements.actionRail.classList.add('visible');
                    elements.railBackdrop.classList.add('visible');
                };
                renderAndShow();
            } else {
                elements.actionRail.classList.remove('visible');
                elements.railBackdrop.classList.remove('visible');
            }
        },
        renderCalendar: async (date) => {
            const currentMonth = dayjs(date);
            const logCounts = await logic.getLogCountsForMonth(date);
            
            const startOfMonth = currentMonth.startOf('month');
            const endOfMonth = currentMonth.endOf('month');
            const startDay = startOfMonth.day(); // 0 (Sun) - 6 (Sat)
            
            let html = `<div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav"><button data-action="prev-month">&lt;</button></div>
                    <h3>${currentMonth.format('YYYY년 M월')}</h3>
                    <div class="calendar-nav"><button data-action="next-month">&gt;</button></div>
                </div>
                <div class="calendar-grid">`;
            
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            html += dayNames.map(d => `<div class="calendar-day-name">${d}</div>`).join('');

            // 이전 달의 날짜 채우기
            for (let i = 0; i < startDay; i++) {
                html += `<div class="calendar-day is-other-month"></div>`;
            }

            // 현재 달의 날짜 채우기
            for (let i = 1; i <= endOfMonth.date(); i++) {
                const dayDate = startOfMonth.date(i);
                const dateStr = dayDate.format('YYYY-MM-DD');
                const isToday = dayDate.isSame(dayjs(), 'day');
                const isSelected = dayDate.isSame(dayjs(state.currentDate), 'day');
                
                let classes = 'calendar-day';
                if (isToday) classes += ' is-today';
                if (isSelected) classes += ' is-selected';
                
                const logCount = logCounts[dateStr] || 0;
                const indicator = logCount > 0 ? `<div class="log-indicator"></div>` : '';

                html += `<div class="${classes}" data-action="select-date" data-date="${dateStr}">${i}${indicator}</div>`;
            }
            html += '</div></div>';
            elements.mainContent.innerHTML = html;
        },
        renderSettingsList: () => {
            const buildTree = (definitions) => {
                const tree = [];
                const map = {};
                definitions.forEach(def => {
                    map[def.id] = { ...def, children: [] };
                });
                definitions.forEach(def => {
                    if (def.parentId && map[def.parentId]) {
                        map[def.parentId].children.push(map[def.id]);
                    } else {
                        tree.push(map[def.id]);
                    }
                });
                return tree;
            };

            const renderNode = (node, level) => {
                const tagsHtml = node.tags && node.tags.length > 0
                    ? `<div class="def-item-tags log-tags">${node.tags.map(tag => `<span class="log-tag">${tag}</span>`).join('')}</div>`
                    : '';
                const fieldsSummary = node.fields.map(f => `${f.fieldName}(${f.fieldType})`).join(', ');

                let html = `
                    <div class="def-item" style="margin-left: ${level * 20}px;">
                        <div class="def-item-header">
                            <strong>${node.name}</strong>
                            <div>
                                <button class="button secondary" data-action="edit-def" data-id="${node.id}">수정</button>
                                <button class="button danger" data-action="delete-def" data-id="${node.id}" style="margin-left: 8px;">삭제</button>
                            </div>
                        </div>
                        <p style="font-size: 14px; color: var(--color-text-secondary); margin-top: 8px; margin-bottom: 0;">${fieldsSummary}</p>
                        ${tagsHtml}
                    </div>
                `;
                if (node.children.length > 0) {
                    html += node.children.map(child => renderNode(child, level + 1)).join('');
                }
                return html;
            };

            const tree = buildTree(state.definitions);
            const listHtml = tree.map(node => renderNode(node, 0)).join('');
            
            elements.settingsModal.innerHTML = `<div class="modal-header"><h2>관찰 대상 관리</h2><button class="button" data-action="close-settings">닫기</button></div><div class="modal-content">${listHtml}<button class="button primary" data-action="add-def" style="margin-top: 16px;">+ 새 관찰 대상 추가</button></div>`;
        },
        renderDefinitionForm: (definition) => {
            const isNew = definition === 'new';
            const currentId = isNew ? null : definition.id;
            const name = isNew ? '' : definition.name;
            const fields = isNew ? [{fieldName: '', fieldType: 'Text'}] : definition.fields;
            const parentId = isNew ? 0 : (definition.parentId || 0);
            const tags = isNew ? [] : (definition.tags || []);

            let fieldsHtml = fields.map((field, index) => `
                <div class="field-row" data-index="${index}">
                    <input type="text" class="field-name-input" placeholder="필드 이름" value="${field.fieldName}" style="flex-grow: 1;">
                    <select class="field-type-select">
                        <option value="Text" ${field.fieldType === 'Text' ? 'selected' : ''}>텍스트</option>
                        <option value="Number" ${field.fieldType === 'Number' ? 'selected' : ''}>숫자</option>
                        <option value="Date" ${field.fieldType === 'Date' ? 'selected' : ''}>날짜</option>
                        <option value="Checkbox" ${field.fieldType === 'Checkbox' ? 'selected' : ''}>체크박스</option>
                        <option value="Textarea" ${field.fieldType === 'Textarea' ? 'selected' : ''}>장문 텍스트</option>
                    </select>
                    <button class="button danger" data-action="remove-field">X</button>
                </div>
            `).join('');
            
            const parentOptions = state.definitions
                .filter(def => def.id !== currentId) // Prevent self-parenting
                .map(def => `<option value="${def.id}" ${def.id === parentId ? 'selected' : ''}>${def.name}</option>`)
                .join('');

            elements.settingsModal.innerHTML = `
                <div class="modal-header"><h2>${isNew ? '새 대상 정의' : '대상 수정'}</h2></div>
                <div class="modal-content">
                    <div class="form-group"><label>대상 이름</label><input type="text" id="def-name-input" value="${name}"></div>
                    <div class="form-group"><label>부모 대상</label>
                        <select id="def-parent-select"><option value="0">-- 없음 --</option>${parentOptions}</select>
                    </div>
                    <div class="form-group"><label>태그</label>
                        <input type="text" id="def-tags-input" value="${tags.join(', ')}" placeholder="쉼표로 구분하여 입력">
                    </div>
                    <div class="form-group"><label>데이터 필드</label><div id="def-fields-container">${fieldsHtml}</div></div>
                    <button class="button secondary" data-action="add-field">+ 필드 추가</button>
                    <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--color-border);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="button secondary" data-action="back-to-list">← 목록으로</button>
                        <button class="button primary" data-action="save-def" data-id="${isNew ? '' : definition.id}">저장</button>
                    </div>
                </div>
            `;
        },
        showSuggestions: (query) => {
            const filtered = state.definitions.filter(def => def.name.toLowerCase().includes(query.toLowerCase()));
            let html = '<button data-type="journal">✍️ 일기 쓰기</button>';
            html += filtered.map(def => `<button data-type="log" data-id="${def.id}">📝 ${def.name}</button>`).join('');
            elements.suggestionBox.innerHTML = html;
        },
        clearSuggestions: () => { elements.suggestionBox.innerHTML = ''; },
        
        showDynamicForm: (type, id = null, existingEntry = null) => {
            ui.clearSuggestions();
            elements.commandBarInput.style.display = 'none';
            let formHtml = '';
            if (type === 'journal') {
                formHtml = `<div class="form-group"><label>일기 내용</label><div id="journal-editor" style="height: 150px;"></div></div>`;
            } else {
                const def = state.definitions.find(d => d.id === id);
                formHtml += `<h2>${def.name} ${existingEntry ? '수정' : '기록'}</h2>`;
                def.fields.forEach(field => {
                    const fieldId = sanitizeForId(field.fieldName);
                    const value = existingEntry ? existingEntry.values[field.fieldName] : '';
                    let fieldInputHtml = '';
                    switch (field.fieldType) {
                        case 'Number':
                            fieldInputHtml = `<input type="number" id="log-field-${fieldId}" value="${value || ''}">`;
                            break;
                        case 'Date':
                            fieldInputHtml = `<input type="date" id="log-field-${fieldId}" value="${value || ''}">`;
                            break;
                        case 'Checkbox':
                            const checked = value ? 'checked' : '';
                            fieldInputHtml = `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="log-field-${fieldId}" style="width: auto;" ${checked}><label for="log-field-${fieldId}" style="margin-bottom: 0;">${field.fieldName}</label></div>`;
                            break;
                        case 'Textarea':
                             fieldInputHtml = `<textarea id="log-field-${fieldId}" rows="3">${value || ''}</textarea>`;
                            break;
                        case 'Text':
                        default:
                            fieldInputHtml = `<input type="text" id="log-field-${fieldId}" value="${value || ''}">`;
                            break;
                    }
                
                    if (field.fieldType === 'Checkbox') {
                        formHtml += `<div class="form-group">${fieldInputHtml}</div>`;
                    } else {
                        formHtml += `<div class="form-group"><label>${field.fieldName}</label>${fieldInputHtml}</div>`;
                    }
                });
            }
            const entryIdAttr = existingEntry ? `data-entry-id="${existingEntry.id}"` : '';
            const actionsHtml = `<div class="form-actions"><button type="button" class="button secondary" data-action="cancel-entry">취소</button><button type="button" class="button primary" data-action="save-entry" data-type="${type}" data-id="${id}" ${entryIdAttr}>저장</button></div>`;
            elements.dynamicFormContainer.innerHTML = formHtml + actionsHtml;
            if (type === 'journal') {
                quill = new Quill('#journal-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, false] }],
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    }
                });
                if (existingEntry && existingEntry.content) {
                    quill.root.innerHTML = existingEntry.content;
                }
            }
        },
        resetCommandBar: () => {
            elements.dynamicFormContainer.innerHTML = '';
            elements.commandBarInput.style.display = 'block';
            elements.commandBarInput.value = '';
            elements.commandBarInput.blur();
        }
    };
    
    const logic = {
        loadDataForDate: async (date) => {
            state.currentDate = date;
            elements.datePicker.value = date;

            // Clear previous timeline state for a fresh view.
            state.loadedEntries.clear();
            state.visibleTimelineDates = [];
            $('#timeline-container').innerHTML = ''; // Ensure the container is empty.

            await logic.loadAndRenderDays(date, 'future', 1); // Load the initial day.
        },
       // REVISED: This function is fundamentally re-architected to work with the cache.
        saveEntry: async (type, definitionId, entryId = null) => {
            const values = {};
            const timestamp = entryId 
                ? state.loadedEntries.get(state.currentDate)?.find(e => e.id === entryId)?.timestamp 
                : new Date().toISOString();

            if (!timestamp) {
                console.error("Logic Error: Cannot find original entry to update.");
                return;
            }

            if (type === 'journal') {
                values.content = quill.root.innerHTML;
            } else {
                const def = state.definitions.find(d => d.id === definitionId);
                values.definitionId = definitionId;
                values.values = {};
                def.fields.forEach(field => {
                    const input = $(`#log-field-${sanitizeForId(field.fieldName)}`);
                    if (input) {
                        values.values[field.fieldName] = input.type === 'checkbox' ? input.checked : input.value;
                    }
                });
            }

            const entryDate = dayjs(timestamp).format('YYYY-MM-DD');
            let dayEntries = (await dbUtils.get('entries', entryDate))?.entries || [];

            if (entryId) {
                const entryIndex = dayEntries.findIndex(e => e.id === entryId);
                if (entryIndex > -1) {
                    // Preserve original properties like id and timestamp when updating
                    Object.assign(dayEntries[entryIndex], values);
                }
            } else {
                const newEntry = { id: Date.now(), type, timestamp, ...values };
                dayEntries.push(newEntry);
            }
            
            await dbUtils.save('entries', { date: entryDate, entries: dayEntries });

            // Invalidate the cache for this date and reload the entire view to ensure consistency.
            state.loadedEntries.delete(entryDate);
            await logic.loadDataForDate(state.currentDate); 
            
        },
        // NEW: A function to load a specified number of days in a given direction.
        loadAndRenderDays: async (startDate, direction, count = 2) => {
            if (state.isLoadingMore) return;
            state.isLoadingMore = true;

            const newDaysData = [];
            let currentDate = dayjs(startDate);

            for (let i = 0; i < count; i++) {
                const dateStr = currentDate.format('YYYY-MM-DD');

                // Efficiency Check: Do not re-fetch data already loaded.
                if (!state.loadedEntries.has(dateStr)) {
                    const data = await dbUtils.get('entries', dateStr);
                    const entries = data ? data.entries : [];
                    state.loadedEntries.set(dateStr, entries); // Cache the result (even if empty).
                    if (entries.length > 0) {
                        newDaysData.push({ date: dateStr, entries });
                    }
                }

                // Update the date for the next iteration.
                currentDate = direction === 'past' ? currentDate.subtract(1, 'day') : currentDate.add(1, 'day');
            }

            if (newDaysData.length > 0) {
                // Sort data chronologically before rendering.
                newDaysData.sort((a, b) => direction === 'past' ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date));
                ui.renderMoreEntries(newDaysData, direction);

                // Atomically update the visible dates state.
                const newDates = newDaysData.map(d => d.date);
                if (direction === 'past') {
                    state.visibleTimelineDates.unshift(...newDates.reverse());
                } else {
                    state.visibleTimelineDates.push(...newDates);
                }
            }

            state.isLoadingMore = false;
        },
        searchGlobal: async (query) => {
            const lowerQuery = query.toLowerCase().trim();
            if (!lowerQuery) {
                // 검색어가 없으면 현재 날짜의 타임라인을 다시 표시
                ui.renderTimeline(state.allEntries);
                return;
            }

            const results = [];
            const isTagQuery = lowerQuery.startsWith('#');
            const pureQuery = isTagQuery ? lowerQuery.substring(1) : lowerQuery;

            const searchPromise = new Promise(resolve => {
                const transaction = db.transaction('entries', 'readonly');
                const store = transaction.objectStore('entries');
                const request = store.openCursor();

                request.onsuccess = e => {
                    const cursor = e.target.result;
                    if (cursor) {
                        const dayData = cursor.value; // { date: 'YYYY-MM-DD', entries: [...] }
                        dayData.entries.forEach(entry => {
                            let isMatch = false;
                            if (entry.type === 'journal' && !isTagQuery) {
                                if (entry.content.toLowerCase().includes(pureQuery)) isMatch = true;
                            } else if (entry.type === 'log') {
                                const def = state.definitions.find(d => d.id === entry.definitionId);
                                if (def) {
                                    if (isTagQuery) {
                                        if (def.tags && def.tags.some(tag => tag.toLowerCase().includes(pureQuery))) isMatch = true;
                                    } else {
                                        const nameMatch = def.name.toLowerCase().includes(pureQuery);
                                        const valueMatch = Object.values(entry.values).some(val => String(val).toLowerCase().includes(pureQuery));
                                        if (nameMatch || valueMatch) isMatch = true;
                                    }
                                }
                            }
                            if (isMatch) {
                                results.push({ ...entry, date: dayData.date }); // 결과에 날짜 정보 주입
                            }
                        });
                        cursor.continue();
                    } else {
                        resolve(); // 커서 순회 완료
                    }
                };
                request.onerror = () => resolve(); // 에러 발생 시에도 Promise 종료
            });

            await searchPromise;
            ui.renderSearchResults(results);
        },
        saveDefinition: async (id) => {
            const name = $('#def-name-input').value.trim();
            if (!name) return alert('대상 이름은 필수입니다.');

            const parentId = parseInt($('#def-parent-select').value) || 0;
            const tags = $('#def-tags-input').value.split(',')
                .map(tag => tag.trim()).filter(tag => tag);

            const fields = [];
            document.querySelectorAll('#def-fields-container .field-row').forEach(row => {
                const fieldName = row.querySelector('.field-name-input').value.trim();
                const fieldType = row.querySelector('.field-type-select').value;
                if (fieldName) fields.push({ fieldName, fieldType });
            });
            const definitionData = { name, fields, parentId, tags };
            if (id) definitionData.id = parseInt(id);

            await dbUtils.save('definitions', definitionData);
            state.definitions = await dbUtils.getAll('definitions');
            ui.renderSettingsList();
        },
        deleteDefinition: async (id) => {
            if (confirm('정말로 이 대상을 삭제하시겠습니까? 관련된 모든 기록은 유지되지만, 연결은 끊어집니다.')) {
                await dbUtils.delete('definitions', id);
                // Also update children to have no parent
                const children = state.definitions.filter(d => d.parentId === id);
                for (const child of children) {
                    child.parentId = 0;
                    await dbUtils.save('definitions', child);
                }
                state.definitions = await dbUtils.getAll('definitions');
                ui.renderSettingsList();
            }
        },
        deleteEntry: async (id) => {
            if (!confirm('이 기록을 정말로 삭제하시겠습니까?')) return;

            let entryToDelete = null;
            let entryDate = null;

            // Find the entry and its date from the cache.
            for (const [date, entries] of state.loadedEntries.entries()) {
                const found = entries.find(e => e.id === id);
                if (found) {
                    entryToDelete = found;
                    entryDate = date;
                    break;
                }
            }

            if (!entryToDelete || !entryDate) {
                alert("오류: 삭제할 항목을 찾을 수 없습니다.");
                return;
            }
            
            let dayEntries = (await dbUtils.get('entries', entryDate))?.entries || [];
            dayEntries = dayEntries.filter(entry => entry.id !== id);
            
            await dbUtils.save('entries', { date: entryDate, entries: dayEntries });
            
            // Invalidate cache and reload view.
            state.loadedEntries.delete(entryDate);
            await logic.loadDataForDate(state.currentDate);
            state.currentView = 'timeline';
            ui.renderMainContent();
        },
        getLogCountsForMonth: async (date) => {
            const monthStart = dayjs(date).startOf('month').format('YYYY-MM-DD');
            const monthEnd = dayjs(date).endOf('month').format('YYYY-MM-DD');
            
            const allData = await dbUtils.getAll('entries');
            const counts = {};
            allData.forEach(dayData => {
                if (dayData.date >= monthStart && dayData.date <= monthEnd) {
                    if (dayData.entries && dayData.entries.length > 0) {
                        counts[dayData.date] = dayData.entries.length;
                    }
                }
            });
            return counts;
        },
    };

    const handlers = {
        handleDateChange: async (e) => {
            await logic.loadDataForDate(e.target.value);
        },
        handleSettingsModalClick: (e) => {
            const action = e.target.dataset.action;
            const id = e.target.dataset.id ? parseInt(e.target.dataset.id) : null;
            if (action === 'close-settings') ui.toggleSettingsModal(false);
            else if (action === 'back-to-list') ui.renderSettingsList();
            else if (action === 'add-def') ui.renderDefinitionForm('new');
            else if (action === 'edit-def') ui.renderDefinitionForm(state.definitions.find(d => d.id === id));
            else if (action === 'delete-def') logic.deleteDefinition(id);
            else if (action === 'save-def') logic.saveDefinition(id);
            else if (action === 'add-field') {
                const container = $('#def-fields-container');
                const newField = document.createElement('div');
                newField.className = 'field-row';
                newField.innerHTML = `<input type="text" class="field-name-input" placeholder="필드 이름" style="flex-grow: 1;"><select class="field-type-select"><option value="Text">텍스트</option><option value="Number">숫자</option></select><button class="button danger" data-action="remove-field">X</button>`;
                container.appendChild(newField);
            }
            else if (action === 'remove-field') e.target.closest('.field-row').remove();
        },
        handleScroll: (e) => {
            if (state.currentView !== 'timeline' || state.isLoadingMore) return;

            const { scrollTop, scrollHeight, clientHeight } = e.target;
            const scrollThreshold = 200; // Load when 200px from the edge.

            // Scrolled to the top
            if (scrollTop < scrollThreshold) {
                const firstDate = state.visibleTimelineDates[0];
                if (firstDate) {
                    const prevDate = dayjs(firstDate).subtract(1, 'day').format('YYYY-MM-DD');
                    logic.loadAndRenderDays(prevDate, 'past');
                }
            }

            // Scrolled to the bottom
            if (scrollHeight - scrollTop - clientHeight < scrollThreshold) {
                const lastDate = state.visibleTimelineDates[state.visibleTimelineDates.length - 1];
                if (lastDate) {
                    const nextDate = dayjs(lastDate).add(1, 'day').format('YYYY-MM-DD');
                    logic.loadAndRenderDays(nextDate, 'future');
                }
            }
        },
        handleCommandBarFocus: () => { ui.showSuggestions(''); },
        handleCommandBarInput: (e) => { ui.showSuggestions(e.target.value); },
        handleSuggestionClick: (e) => {
            const button = e.target.closest('button');
            if (button) ui.showDynamicForm(button.dataset.type, button.dataset.id ? parseInt(button.dataset.id) : null);
        },
        handleFormActionClick: async (e) => {
             const action = e.target.dataset.action;
             if (action === 'cancel-entry') {
                ui.resetCommandBar();
             }
             else if (action === 'save-entry') {
                const entryId = e.target.dataset.entryId ? parseInt(e.target.dataset.entryId) : null;
                await logic.saveEntry(
                    e.target.dataset.type, 
                    e.target.dataset.id ? parseInt(e.target.dataset.id) : null, 
                    entryId
                );
                
                ui.resetCommandBar();
             }
        },
        handleDocumentClick: (e) => {
            if (!elements.commandBarWrapper.contains(e.target) && e.target.id !== 'command-bar-input') {
                ui.clearSuggestions();
            }
        },
        handleTimelineClick: (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const id = parseInt(button.dataset.id);
            if (!id) return;

            let entryToEdit = null;
            // Find the entry from the cache
            for (const entries of state.loadedEntries.values()) {
                const found = entries.find(e => e.id === id);
                if (found) {
                    entryToEdit = found;
                    break;
                }
            }

            if (action === 'edit-entry' && entryToEdit) {
                ui.showDynamicForm(entryToEdit.type, entryToEdit.definitionId, entryToEdit);
            } else if (action === 'delete-entry') {
                logic.deleteEntry(id);
            }
        },
        handleActionRailClick: (e) => {
            const button = e.target.closest('button.rail-icon-button[data-view-id]');
            if (button) {
                const viewId = button.dataset.viewId;
                if (state.currentView !== viewId) {
                    state.currentView = viewId;
                    ui.renderMainContent();
                }
                return;
            }
        },
        handleMainContentClick: (e) => {
            // 캘린더 날짜/월 변경 로직
            const calButton = e.target.closest('button[data-action]');
            const day = e.target.closest('div[data-action="select-date"]');
            if (calButton && state.currentView === 'calendar') {
                const action = calButton.dataset.action;
                if (action === 'prev-month') {
                    state.calendarDate = dayjs(state.calendarDate).subtract(1, 'month').format('YYYY-MM-DD');
                    ui.renderCalendar(state.calendarDate);
                } else if (action === 'next-month') {
                    state.calendarDate = dayjs(state.calendarDate).add(1, 'month').format('YYYY-MM-DD');
                    ui.renderCalendar(state.calendarDate);
                }
            } else if (day && state.currentView === 'calendar') {
                const date = day.dataset.date;
                if (date) {
                    logic.loadDataForDate(date);
                    state.currentView = 'timeline'; // 날짜 선택 후 타임라인으로 자동 전환
                    ui.renderMainContent();
                }
            }

            // 타임라인 수정/삭제 로직
            const entryButton = e.target.closest('button[data-action]');
            if (entryButton && state.currentView === 'timeline') {
                const action = entryButton.dataset.action;
                const id = parseInt(entryButton.dataset.id);
                if (!id) return; // 유효하지 않은 ID는 무시

                if (action === 'edit-entry') {
                    let entryToEdit = null;
                    // CORRECT: Search for the entry across the new cache structure.
                    for (const entries of state.loadedEntries.values()) {
                        const found = entries.find(e => e.id === id);
                        if (found) {
                            entryToEdit = found;
                            break; // 항목을 찾으면 즉시 루프 종료
                        }
                    }
                    if (entryToEdit) {
                        ui.showDynamicForm(entryToEdit.type, entryToEdit.definitionId, entryToEdit);
                    } else {
                        console.error(`Logic Error: Entry with id ${id} not found in cache.`);
                    }
                } else if (action === 'delete-entry') {
                    logic.deleteEntry(id);
                }
            }
        },
        init: async () => {
            await dbUtils.init();
            state.definitions = await dbUtils.getAll('definitions');
            if (state.definitions.length === 0) {
                const projId = await dbUtils.save('definitions', { name: '개인 프로젝트', fields: [{ fieldName: '상태', fieldType: 'Text'}], tags: ['프로젝트'] });
                await dbUtils.save('definitions', { name: 'Logify v2 개발', parentId: projId, fields: [{ fieldName: '진행률(%)', fieldType: 'Number'}], tags: ['개발', '중요'] });
                state.definitions = await dbUtils.getAll('definitions');
            }
            ui.renderMainContent();
            ui.initializeActionRail();

            await logic.loadDataForDate(state.currentDate);

            // 초기 뷰 렌더링 및 액션 레일 초기화

            elements.datePicker.addEventListener('change', handlers.handleDateChange);
            elements.searchBtn.addEventListener('click', () => ui.toggleSearchMode(true));
            elements.cancelSearchBtn.addEventListener('click', () => ui.toggleSearchMode(false));
            elements.searchInput.addEventListener('input', (e) => logic.searchGlobal(e.target.value));

            // 이벤트 리스너 위임
            elements.actionRail.addEventListener('click', handlers.handleActionRailClick);
            elements.mainContent.addEventListener('click', handlers.handleMainContentClick);
            
            elements.settingsBtn.addEventListener('click', () => ui.toggleSettingsModal(true));
            elements.settingsModal.addEventListener('click', handlers.handleSettingsModalClick);
            elements.commandBarInput.addEventListener('focus', handlers.handleCommandBarFocus);
            elements.commandBarInput.addEventListener('input', handlers.handleCommandBarInput);
            elements.suggestionBox.addEventListener('click', handlers.handleSuggestionClick);
            elements.dynamicFormContainer.addEventListener('click', handlers.handleFormActionClick);
            elements.mainContent.addEventListener('scroll', handlers.handleScroll);
            document.addEventListener('click', handlers.handleDocumentClick);
        }
    };
    
    handlers.init();
    </script>
</body>
</html>
