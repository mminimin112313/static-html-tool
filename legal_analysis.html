<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Brief Vault Pro V3.1 - Project Based AI Legal Assistant</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans KR', 'sans-serif'],
                        serif: ['Noto Serif KR', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a',
                        },
                        slate: { 850: '#151e2e' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'inner-light': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.02)',
                        'popover': '0 10px 40px -10px rgba(0,0,0,0.15)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #0f172a; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 1. IndexedDB Manager ---
        const DB_NAME = 'LegalBriefVaultDB';
        const DB_VERSION = 1;

        const dbManager = {
            db: null,
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('projects')) {
                            db.createObjectStore('projects', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('citations')) {
                            const store = db.createObjectStore('citations', { keyPath: 'id' });
                            store.createIndex('projectId', 'projectId', { unique: false });
                        }
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject(e);
                });
            },
            async getAllProjects() {
                return this._getAll('projects');
            },
            async createProject(project) {
                return this._put('projects', project);
            },
            async deleteProject(id) {
                await this._delete('projects', id);
                const citations = await this.getCitationsByProject(id);
                const tx = this.db.transaction(['citations'], 'readwrite');
                const store = tx.objectStore('citations');
                citations.forEach(c => store.delete(c.id));
                return new Promise(resolve => tx.oncomplete = resolve);
            },
            async getCitationsByProject(projectId) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['citations'], 'readonly');
                    const store = tx.objectStore('citations');
                    const index = store.index('projectId');
                    const request = index.getAll(projectId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = reject;
                });
            },
            async addCitation(citation) {
                return this._put('citations', citation);
            },
            async deleteCitation(id) {
                return this._delete('citations', id);
            },
            async updateCitation(citation) {
                return this._put('citations', citation);
            },
            _getAll(storeName) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readonly');
                    const request = tx.objectStore(storeName).getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = reject;
                });
            },
            _put(storeName, item) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readwrite');
                    const request = tx.objectStore(storeName).put(item);
                    request.onsuccess = () => resolve(item);
                    request.onerror = reject;
                });
            },
            _delete(storeName, id) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readwrite');
                    const request = tx.objectStore(storeName).delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = reject;
                });
            }
        };

        // --- Constants & System Prompt ---
        const AVAILABLE_MODELS = [
            { id: "gemini-2.5-flash-preview-09-2025", name: "Gemini 2.5 Flash Preview (Recommended)" },
            { id: "gemini-2.5-flash", name: "Gemini 2.5 Flash" },
            { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash Lite" },
            { id: "gemini-2.5-flash-lite-preview-09-2025", name: "Gemini 2.5 Flash Lite Preview" },
        ];

        const DEFAULT_INTERVAL = 30;
        const SYSTEM_PROMPT = `
<AIFramework_V3>
<Cognitive_Core>
 <Persona>
 <Identity>Legal_Brief_Assistant_Zero</Identity>
 <Role>소송 서면 작성 지원을 위한 법리 추출 에이전트</Role>
 <Tone_Manner>권위적, 문어체, 완결성</Tone_Manner>
 </Persona>
 <Prime_Directive>
 입력된 텍스트에서 '법적 판단 기준(Legal Standard)'이 담긴 문장을 추출하여, 변호사가 서면에 즉시 복사-붙여넣기 할 수 있는 **'인용구(Blockquote)'** 형태로 정제하여 JSON으로 반환하라.
 </Prime_Directive>
</Cognitive_Core>
<Operational_Cortex>
 <Processing_Protocol>
 <Step_1 name="Legal_Rule_Identification">
  텍스트 내에서 사실관계(Fact)를 제외하고, 법원이 제시한 **정의(Definition), 요건(Requirement), 판단기준(Criteria)**이 서술된 부분을 식별하라.
 </Step_1>
 <Step_2 name="Text_Polishing_for_Citation">
  식별된 법리를 서면 문체로 정제하라.
  - 중간에 끊긴 문장은 하나로 잇는다.
  - '~라고 할 것이다', '~봄이 상당하다' 등 판결문 특유의 어미를 유지한다.
  - 불필요한 수식어나 접속사가 문장의 권위를 해친다면 최소한으로 교정하되, **원문의 법적 의미는 100% 보존**한다.
 </Step_2>
 <Step_3 name="Source_Parsing">
  문장 끝에 붙은 '(대법원 ... 판결 참조)'와 같은 출처 표기를 분리하여 별도 메타데이터로 저장하라. 없으면 "출처 미상" 또는 추정되는 사건번호 기재.
 </Step_3>
 <Step_4 name="JSON_Construction">
  결과물을 JSON 배열([]) 형태로 반환하라.
 </Step_4>
 </Processing_Protocol>
</Operational_Cortex>
<Output_Schema type="JSON">
 [
  {
  "citation_text": "서면에 바로 붙여넣을 수 있는 정제된 법리 문장 (출처 제외)",
  "source_ref": "판례번호 또는 법령명",
  "core_keywords": ["핵심쟁점1", "핵심쟁점2"],
  "legal_category": "대분류 (예: 성희롱 성립요건)"
  }
 ]
 </Output_Schema>
</AIFramework_V3>
        `;

        // --- Utils ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatTime = (ms) => {
            if (!ms) return 'Ready';
            const diff = Math.ceil((ms - Date.now()) / 1000);
            return diff > 0 ? `${diff}s` : 'Ready';
        };
        const formatDate = (ms) => new Date(ms).toLocaleDateString('ko-KR', { year: '2-digit', month: '2-digit', day: '2-digit' });

        // --- Components ---

        const ToastManager = ({ toasts, removeToast }) => {
            return (
                <div className="fixed bottom-6 right-6 z-[60] flex flex-col gap-3 pointer-events-none">
                    {toasts.map(toast => (
                        <div key={toast.id} className={`pointer-events-auto min-w-[300px] p-4 rounded-xl shadow-2xl border flex items-start gap-3 animate-enter bg-white border-slate-200`}>
                            <div className={`mt-0.5 ${toast.type === 'warning' ? 'text-amber-500' : toast.type === 'error' ? 'text-red-500' : 'text-brand-600'}`}>
                                <i className={`ph-fill ${toast.type === 'warning' ? 'ph-warning' : toast.type === 'error' ? 'ph-x-circle' : 'ph-info' } text-xl`}></i>
                            </div>
                            <div className="flex-1">
                                <h4 className="text-sm font-bold text-slate-800">{toast.title}</h4>
                                <p className="text-xs text-slate-500 mt-1 leading-relaxed">{toast.message}</p>
                                {toast.action && (
                                    <button onClick={toast.action.onClick} className="mt-2 text-xs font-bold text-brand-600 hover:underline">
                                        {toast.action.label}
                                    </button>
                                )}
                            </div>
                            <button onClick={() => removeToast(toast.id)} className="text-slate-400 hover:text-slate-600"><i className="ph-bold ph-x"></i></button>
                        </div>
                    ))}
                </div>
            );
        };

        const Dashboard = ({ projects, onCreateProject, onSelectProject, onDeleteProject, onImportData }) => {
            const [newProjectName, setNewProjectName] = useState('');
            const fileInputRef = useRef(null);

            const handleCreate = () => {
                if(!newProjectName.trim()) return;
                onCreateProject(newProjectName);
                setNewProjectName('');
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if(file) onImportData(file);
            };

            return (
                <div className="max-w-5xl mx-auto p-8 animate-enter">
                    <div className="flex justify-between items-center mb-10">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Project Dashboard</h1>
                            <p className="text-slate-500 mt-1">Manage your legal briefs and case files.</p>
                        </div>
                        <div className="flex gap-3">
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                            <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium text-sm transition-all">
                                <i className="ph-bold ph-upload-simple"></i> Import JSON
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div className="bg-white border-2 border-dashed border-slate-200 rounded-2xl p-6 flex flex-col justify-center items-center text-center hover:border-brand-300 hover:bg-brand-50/10 transition-all group">
                            <div className="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mb-4 group-hover:bg-brand-100 transition-colors">
                                <i className="ph-bold ph-plus text-xl text-slate-400 group-hover:text-brand-600"></i>
                            </div>
                            <h3 className="font-bold text-slate-700 mb-2">New Project</h3>
                            <div className="w-full flex gap-2">
                                <input 
                                    type="text" 
                                    placeholder="Project Name..." 
                                    className="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-brand-500"
                                    value={newProjectName}
                                    onChange={e => setNewProjectName(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && handleCreate()}
                                />
                                <button onClick={handleCreate} className="bg-slate-800 text-white px-3 py-2 rounded-lg text-sm hover:bg-slate-900">Add</button>
                            </div>
                        </div>

                        {projects.map(p => (
                            <div key={p.id} className="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all group relative">
                                <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); onDeleteProject(p.id); }}
                                        className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg"
                                    >
                                        <i className="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                                <div onClick={() => onSelectProject(p.id)} className="cursor-pointer">
                                    <div className="flex items-center gap-3 mb-4">
                                        <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-brand-500 to-indigo-600 flex items-center justify-center text-white shadow-md">
                                            <i className="ph-bold ph-folder-open"></i>
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-slate-800 truncate w-40">{p.name}</h3>
                                            <span className="text-xs text-slate-400 font-mono">{formatDate(p.createdAt)}</span>
                                        </div>
                                    </div>
                                    <div className="border-t border-slate-100 pt-4 flex justify-between items-center">
                                        <div className="flex items-center gap-1.5 text-xs font-medium text-slate-500 bg-slate-50 px-2 py-1 rounded">
                                            <i className="ph-bold ph-files"></i>
                                            {p.citationCount || 0} Briefs
                                        </div>
                                        <span className="text-xs text-brand-600 font-bold group-hover:underline">Open Workspace &rarr;</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 2. High-Fidelity Citation Card (Refactored & Fixed) ---
        const CitationCard = ({ item, onCategoryClick, onKeywordClick, onDelete, onCopy }) => {
            const [copied, setCopied] = useState(false);
            
            const handleCopy = () => {
                const textToCopy = `${item.citation_text}\n(${item.source_ref})`;
                
                // --- Safe Clipboard Copy Fallback ---
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    setCopied(true);
                    if(onCopy) onCopy(item.id);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert("클립보드 복사에 실패했습니다. 수동으로 복사해주세요.");
                }
                
                document.body.removeChild(textArea);
                // ------------------------------------
            };

            const handleDelete = () => {
                if(confirm("정말 이 법리 카드를 삭제하시겠습니까?")) {
                    onDelete(item.id);
                }
            };

            return (
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 overflow-hidden group relative">
                    <div className="absolute right-0 top-0 p-8 opacity-[0.03] text-brand-900 pointer-events-none group-hover:opacity-[0.06] transition-opacity">
                        <i className="ph-fill ph-scales text-9xl"></i>
                    </div>

                    <button 
                        onClick={handleDelete}
                        className="absolute top-2 right-2 p-1.5 rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 opacity-0 group-hover:opacity-100 transition-all z-20"
                        title="Delete Card"
                    >
                        <i className="ph-bold ph-trash text-lg"></i>
                    </button>

                    <div className="p-6">
                        <div className="flex justify-between items-start mb-4 relative z-10">
                            <div className="flex flex-wrap gap-2 pr-8">
                                <button 
                                    onClick={() => onCategoryClick(item.legal_category)}
                                    className="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-slate-900 text-white hover:bg-slate-700 transition-colors shadow-sm"
                                >
                                    <i className="ph-bold ph-gavel mr-1.5"></i>
                                    {item.legal_category}
                                </button>
                                {item.core_keywords.map((kw, idx) => (
                                    <button 
                                        key={idx} 
                                        onClick={() => onKeywordClick(kw)}
                                        className="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-brand-50 text-brand-700 border border-brand-100 hover:bg-brand-100 hover:border-brand-200 transition-colors"
                                    >
                                        #{kw}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="relative mb-5 group-hover:cursor-text">
                            <div className="absolute -left-3 top-0 bottom-0 w-1 bg-brand-200 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <p className="serif-font text-slate-800 text-[1.05rem] leading-8 text-justify tracking-wide selection:bg-brand-100 selection:text-brand-900 whitespace-pre-line">
                                {item.citation_text}
                            </p>
                        </div>

                        <div className="flex justify-between items-center pt-4 border-t border-slate-100">
                            <div className="flex items-center text-xs font-medium text-slate-500 bg-slate-50 px-2 py-1 rounded border border-slate-100">
                                <i className="ph-bold ph-book-bookmark mr-1.5 text-slate-400"></i>
                                {item.source_ref}
                            </div>
                            
                            <button 
                                onClick={handleCopy}
                                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold transition-all duration-200 border shadow-sm ${
                                    copied 
                                    ? 'bg-emerald-50 text-emerald-600 border-emerald-200 ring-2 ring-emerald-500/20' 
                                    : 'bg-white text-slate-600 border-slate-200 hover:text-brand-600 hover:border-brand-200 active:scale-95'
                                }`}
                            >
                                <i className={`text-sm ${copied ? 'ph-bold ph-check' : 'ph-bold ph-copy'}`}></i>
                                <span>{copied ? 'Copied' : 'Copy'}</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Workspace = ({ 
            project, 
            apiKeys, 
            selectedModel,
            onBack, 
            addToast, 
            updateProjectStats 
        }) => {
            const [inputMode, setInputMode] = useState('ai');
            const [textInput, setTextInput] = useState('');
            const [jsonInput, setJsonInput] = useState('');
            const [parsedData, setParsedData] = useState([]);
            const [jobQueue, setJobQueue] = useState([]);
            const [isQueueOpen, setIsQueueOpen] = useState(false);
            const [extractionLog, setExtractionLog] = useState(new Set());
            
            const [activeCategories, setActiveCategories] = useState([]);
            const [activeKeywords, setActiveKeywords] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortOption, setSortOption] = useState('date_desc');

            const dropdownRef = useRef(null);

            const toggleCategory = (cat) => {
                setActiveCategories(prev => {
                    if (cat === 'ALL') return [];
                    if (prev.includes(cat)) return prev.filter(c => c !== cat);
                    return [...prev, cat];
                });
            };

            useEffect(() => {
                const loadData = async () => {
                    const data = await dbManager.getCitationsByProject(project.id);
                    setParsedData(data);
                    const log = new Set();
                    data.forEach(d => { if(d.sourceTextHash) log.add(d.sourceTextHash); });
                    setExtractionLog(log);
                };
                loadData();
            }, [project.id]);

            useEffect(() => {
                updateProjectStats(project.id, parsedData.length);
            }, [parsedData.length]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) setIsQueueOpen(false);
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            useEffect(() => {
                const tick = setInterval(() => processQueue(), 1000);
                return () => clearInterval(tick);
            }, [apiKeys, jobQueue, selectedModel, parsedData]);

            const processQueue = async () => {
                const pendingIdx = jobQueue.findIndex(j => j.status === 'queued');
                if (pendingIdx === -1) return;
                
                const now = Date.now();
                const availableKeyIdx = apiKeys.findIndex(k => k.active && (now - k.lastUsed > k.interval));
                if (availableKeyIdx === -1) return;

                const job = jobQueue[pendingIdx];
                
                setJobQueue(prev => prev.map((j, i) => i === pendingIdx ? { ...j, status: 'processing' } : j));

                try {
                    const existingCats = [...new Set(parsedData.map(p => p.legal_category))];
                    const existingKws = [...new Set(parsedData.flatMap(p => p.core_keywords))]; // Collect all unique keywords
                    const result = await callGeminiAPI(job.text, apiKeys[availableKeyIdx].key, selectedModel, existingCats, existingKws);
                    
                    const enrichedResult = result.map(item => ({
                        ...item,
                        id: generateId(),
                        projectId: project.id,
                        dateAdded: Date.now(),
                        lastCopied: null,
                        sourceTextHash: job.textHash
                    }));

                    for(const item of enrichedResult) {
                        await dbManager.addCitation(item);
                    }

                    setJobQueue(prev => prev.map(j => j.id === job.id ? { ...j, status: 'completed' } : j));
                    setParsedData(prev => [...enrichedResult, ...prev]);
                    addToast({ title: 'Extraction Complete', message: `${enrichedResult.length} citations added.`, type: 'success' });

                } catch (error) {
                    console.error(error);
                    setJobQueue(prev => prev.map(j => j.id === job.id ? { ...j, status: 'failed', error: error.message } : j));
                    addToast({ title: 'Job Failed', message: error.message, type: 'error' });
                }
            };

            const callGeminiAPI = async (text, key, modelId, existingCategories = [], existingKeywords = []) => {
                 let dynamicPrompt = SYSTEM_PROMPT;
                 
                 let contextInjection = "";
                 if (existingCategories.length > 0) {
                     contextInjection += `1. 기존 쟁점(Categories): ${JSON.stringify(existingCategories)}\n   - 추출된 법리가 위 목록 중 하나에 해당한다면, 새로운 쟁점명을 만드는 대신 기존 쟁점명을 우선적으로 사용하라.\n`;
                 }
                 if (existingKeywords.length > 0) {
                     contextInjection += `2. 기존 태그(Keywords): ${JSON.stringify(existingKeywords.slice(0, 50))}\n   - 핵심 키워드 추출 시, 위 목록에 있는 단어가 적절하다면 우선적으로 사용하여 태그의 일관성을 유지하라.\n`;
                 }

                 if (contextInjection) {
                     dynamicPrompt += `\n<Context_Injection>\n[참고: 기존 데이터베이스 현황]\n${contextInjection}</Context_Injection>`;
                 }

                 const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${key}`,
                    {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            systemInstruction: { parts: [{ text: dynamicPrompt }] },
                            generationConfig: { responseMimeType: "application/json", temperature: 0.1 }
                        }),
                    }
                );
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            };

            const handleAddJob = () => {
                const text = textInput.trim();
                if (!text) return;

                const textHash = text.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                
                if (extractionLog.has(textHash)) {
                    if (!confirm("⚠️ Duplicate Warning: This text seems to have been processed already. Continue?")) return;
                }
                
                if (apiKeys.filter(k => k.active).length === 0) { 
                    addToast({ title: "No API Key", message: "Please configure API keys in settings.", type: "error" });
                    return; 
                }

                setExtractionLog(prev => new Set(prev).add(textHash));
                setJobQueue(prev => [...prev, { id: generateId(), text, textHash, status: 'queued' }]);
                setTextInput('');
                setIsQueueOpen(true);
            };

            const handleDeleteCard = async (id) => {
                await dbManager.deleteCitation(id);
                setParsedData(prev => prev.filter(p => p.id !== id));
                addToast({ title: "Deleted", message: "Citation removed.", type: "info" });
            };

            const toggleKeyword = (kw) => {
                setActiveKeywords(prev => prev.includes(kw) ? prev.filter(k => k !== kw) : [...prev, kw]);
            };

            const categoryStats = useMemo(() => {
                const counts = {};
                parsedData.forEach(item => { counts[item.legal_category] = (counts[item.legal_category] || 0) + 1; });
                const list = Object.entries(counts).map(([name, count]) => ({ name, count }));
                list.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                return [{ name: 'ALL', count: parsedData.length }, ...list];
            }, [parsedData]);

            const keywordStats = useMemo(() => {
                const counts = {};
                parsedData.forEach(item => {
                    item.core_keywords.forEach(kw => { counts[kw] = (counts[kw] || 0) + 1; });
                });
                const list = Object.entries(counts).map(([name, count]) => ({ name, count }));
                list.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                return list;
            }, [parsedData]);

            const filteredData = useMemo(() => {
                let data = parsedData.filter(item => {
                    const matchesCat = activeCategories.length === 0 || activeCategories.includes(item.legal_category);
                    const matchesKw = activeKeywords.length === 0 || item.core_keywords.some(k => activeKeywords.includes(k));
                    const searchLower = searchTerm.toLowerCase();
                    const matchesSearch = searchTerm === '' || item.citation_text.toLowerCase().includes(searchLower) || item.source_ref.toLowerCase().includes(searchLower) || item.legal_category.toLowerCase().includes(searchLower);
                    return matchesCat && matchesKw && matchesSearch;
                });
                
                data.sort((a, b) => {
                    switch (sortOption) {
                        case 'date_desc': return (b.dateAdded || 0) - (a.dateAdded || 0);
                        case 'date_asc': return (a.dateAdded || 0) - (b.dateAdded || 0);
                        case 'issue_asc': return a.legal_category.localeCompare(b.legal_category, 'ko');
                        default: return 0;
                    }
                });
                return data;
            }, [parsedData, activeCategories, activeKeywords, searchTerm, sortOption]);

            const clearFilters = () => {
                setActiveCategories([]); 
                setActiveKeywords([]);
                setSearchTerm('');
            };

            return (
                <div className="flex flex-col h-full animate-enter">
                    <div className="h-14 border-b border-slate-200 bg-white flex items-center justify-between px-6 flex-shrink-0">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="p-1.5 rounded-lg hover:bg-slate-100 text-slate-500">
                                <i className="ph-bold ph-arrow-left text-lg"></i>
                            </button>
                            <div>
                                <h2 className="font-bold text-slate-800">{project.name}</h2>
                            </div>
                        </div>
                        <div className="relative" ref={dropdownRef}>
                            <button onClick={() => setIsQueueOpen(!isQueueOpen)} className="flex items-center gap-2 text-xs font-bold text-slate-500 hover:text-brand-600 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                                <i className="ph-bold ph-queue"></i>
                                <span>Queue: {jobQueue.filter(j=>['queued','processing'].includes(j.status)).length}</span>
                            </button>
                             {isQueueOpen && (
                                <div className="absolute top-full right-0 mt-2 w-72 bg-white shadow-xl border border-slate-100 rounded-xl p-2 z-50">
                                    <div className="text-xs font-bold text-slate-400 uppercase p-2">Tasks</div>
                                    <div className="max-h-60 overflow-y-auto">
                                        {jobQueue.length === 0 ? <div className="p-4 text-center text-slate-400 text-xs">No active tasks</div> : 
                                         [...jobQueue].reverse().map(j => (
                                             <div key={j.id} className="p-2 border-b border-slate-50 text-xs flex justify-between">
                                                 <span className="truncate w-40">{j.text}</span>
                                                 <span className={j.status === 'completed' ? 'text-green-500' : j.status === 'failed' ? 'text-red-500' : 'text-amber-500'}>{j.status}</span>
                                             </div>
                                         ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden">
                        <div className="w-[360px] flex-shrink-0 bg-slate-50 border-r border-slate-200 overflow-y-auto p-4 flex flex-col gap-6">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                <div className="flex gap-2 mb-2">
                                    <button onClick={() => setInputMode('ai')} className={`flex-1 py-1.5 text-xs font-bold rounded ${inputMode==='ai' ? 'bg-brand-50 text-brand-700' : 'text-slate-400'}`}>AI</button>
                                    <button onClick={() => setInputMode('json')} className={`flex-1 py-1.5 text-xs font-bold rounded ${inputMode==='json' ? 'bg-brand-50 text-brand-700' : 'text-slate-400'}`}>JSON</button>
                                </div>
                                {inputMode === 'ai' ? (
                                    <>
                                        <textarea className="w-full h-32 p-2 text-sm border border-slate-200 rounded-lg resize-none focus:outline-none focus:border-brand-500" placeholder="Paste judgment here..." value={textInput} onChange={e=>setTextInput(e.target.value)}></textarea>
                                        <div className="mt-2 flex justify-between items-center text-xs text-slate-400 mb-1">
                                            <span>Model: {AVAILABLE_MODELS.find(m => m.id === selectedModel)?.name.split(' (')[0]}</span>
                                        </div>
                                        <button onClick={handleAddJob} disabled={!textInput.trim()} className="w-full bg-slate-900 text-white py-2 rounded-lg text-sm font-bold hover:bg-slate-800 disabled:opacity-50">Extraction</button>
                                    </>
                                ) : (
                                    <div className="text-center py-10 text-xs text-slate-400">JSON Import via Dashboard</div>
                                )}
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-3">Issues (Multi-Select)</h3>
                                <div className="space-y-1">
                                    {categoryStats.map(cat => {
                                        const isActive = cat.name === 'ALL' ? activeCategories.length === 0 : activeCategories.includes(cat.name);
                                        return (
                                            <button key={cat.name} onClick={()=>toggleCategory(cat.name)} className={`w-full flex justify-between px-2 py-1.5 text-xs rounded ${isActive ? 'bg-slate-800 text-white' : 'hover:bg-slate-50 text-slate-600'}`}>
                                                <span className="truncate">{cat.name === 'ALL' ? '전체 쟁점' : cat.name}</span>
                                                <span className="opacity-70">{cat.count}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-3">Tags (Multi-Select)</h3>
                                <div className="flex flex-wrap gap-1">
                                    {keywordStats.map(kw => (
                                        <button key={kw.name} onClick={()=>toggleKeyword(kw.name)} className={`px-2 py-1 text-[10px] rounded border ${activeKeywords.includes(kw.name) ? 'bg-brand-600 text-white border-brand-600' : 'bg-white text-slate-600 border-slate-200'}`}>
                                            {kw.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                            <div className="flex gap-4 mb-6 sticky top-0 z-20">
                                <div className="flex-1 relative">
                                    <i className="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input type="text" placeholder="Global Search..." className="w-full pl-9 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-100" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                                </div>
                                <select value={sortOption} onChange={e=>setSortOption(e.target.value)} className="bg-white border border-slate-200 rounded-xl px-4 text-sm font-bold shadow-sm outline-none">
                                    <option value="date_desc">최신순</option>
                                    <option value="issue_asc">쟁점순</option>
                                </select>
                            </div>

                            {/* Filter Toolbar Chips */}
                            <div className="flex flex-wrap gap-2 mb-4">
                                {activeCategories.length > 0 && activeCategories.map(cat => (
                                    <span key={cat} className="animate-enter inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-slate-800 text-white shadow-sm whitespace-nowrap">
                                        {cat}
                                        <button onClick={() => toggleCategory(cat)} className="hover:text-slate-300"><i className="ph-bold ph-x"></i></button>
                                    </span>
                                ))}
                                {activeKeywords.map(kw => (
                                    <span key={kw} className="animate-enter inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold bg-brand-50 text-brand-700 border border-brand-100 whitespace-nowrap">
                                        #{kw}
                                        <button onClick={() => toggleKeyword(kw)} className="hover:text-brand-900"><i className="ph-bold ph-x"></i></button>
                                    </span>
                                ))}
                                {activeCategories.length > 0 || activeKeywords.length > 0 || searchTerm ? (
                                    <button onClick={clearFilters} className="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors" title="Clear All">
                                        <i className="ph-bold ph-trash"></i>
                                    </button>
                                ) : (
                                    <span className="text-xs text-slate-400 font-medium italic pl-1">No active filters applied</span>
                                )}
                            </div>

                            <div className="space-y-4 pb-20">
                                {filteredData.map(item => (
                                    <div key={item.id} className="animate-enter">
                                        <CitationCard 
                                            item={item}
                                            onCategoryClick={toggleCategory}
                                            onKeywordClick={toggleKeyword}
                                            onDelete={handleDeleteCard}
                                            onCopy={(id) => { addToast({title:'Copied', message:'Clipboard updated.', type:'success'}) }}
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [apiKeys, setApiKeys] = useState([]);
            const [selectedModel, setSelectedModel] = useState(AVAILABLE_MODELS[0].id);
            const [toasts, setToasts] = useState([]);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [lastBackupTime, setLastBackupTime] = useState(Date.now());

            const addToast = useCallback((toast) => {
                const id = Date.now();
                setToasts(prev => [...prev, { ...toast, id }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
            }, []);
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            useEffect(() => {
                dbManager.init().then(() => {
                    refreshProjects();
                });
                const storedKeys = localStorage.getItem('lbv_api_keys');
                if(storedKeys) setApiKeys(JSON.parse(storedKeys));
                
                const storedModel = localStorage.getItem('lbv_selected_model');
                if(storedModel && AVAILABLE_MODELS.some(m => m.id === storedModel)) {
                    setSelectedModel(storedModel);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('lbv_api_keys', JSON.stringify(apiKeys));
            }, [apiKeys]);

            useEffect(() => {
                localStorage.setItem('lbv_selected_model', selectedModel);
            }, [selectedModel]);

            useEffect(() => {
                const checkBackup = setInterval(() => {
                    const now = Date.now();
                    if (now - lastBackupTime > 1000 * 60 * 5) {
                        addToast({
                            title: "Backup Recommended",
                            message: "It's been a while since your last export.",
                            type: "warning",
                            action: { label: "Export Now", onClick: () => { handleExportAll(); setLastBackupTime(Date.now()); } }
                        });
                    }
                }, 60000);
                return () => clearInterval(checkBackup);
            }, [lastBackupTime]);

            const refreshProjects = async () => {
                const list = await dbManager.getAllProjects();
                list.sort((a,b) => b.createdAt - a.createdAt);
                setProjects(list);
            };

            const handleCreateProject = async (name) => {
                const newProject = {
                    id: generateId(),
                    name,
                    createdAt: Date.now(),
                    citationCount: 0
                };
                await dbManager.createProject(newProject);
                refreshProjects();
                addToast({ title: 'Success', message: 'Project created.', type: 'success' });
            };

            const handleDeleteProject = async (id) => {
                if(confirm("Permanently delete this project and all its citations?")) {
                    await dbManager.deleteProject(id);
                    refreshProjects();
                    addToast({ title: 'Deleted', message: 'Project removed.', type: 'info' });
                }
            };

            const handleImportData = (file) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.type === 'full_backup' && data.projects && data.citations) {
                            for(const proj of data.projects) {
                                await dbManager.createProject(proj);
                            }
                            for(const cit of data.citations) {
                                await dbManager.addCitation(cit);
                            }
                            refreshProjects();
                            addToast({ title: 'Import Successful', message: `${data.projects.length} projects loaded.`, type: 'success' });
                        } else {
                            throw new Error("Invalid backup format");
                        }
                    } catch(err) {
                        addToast({ title: 'Import Failed', message: err.message, type: 'error' });
                    }
                };
                reader.readAsText(file);
            };

            const handleExportAll = async () => {
                const allProjects = await dbManager.getAllProjects();
                const allCitations = await dbManager._getAll('citations');
                const backup = {
                    type: 'full_backup',
                    date: new Date().toISOString(),
                    projects: allProjects,
                    citations: allCitations
                };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LBV_Backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                setLastBackupTime(Date.now());
                addToast({ title: 'Export Complete', message: 'Your data is safe.', type: 'success' });
            };

            const updateProjectStats = async (projectId, count) => {
                setProjects(prev => prev.map(p => p.id === projectId ? { ...p, citationCount: count } : p));
                const p = await dbManager._getAll('projects');
                const target = p.find(x => x.id === projectId);
                if(target) {
                    target.citationCount = count;
                    await dbManager.createProject(target);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
                    <header className="glass h-16 fixed top-0 w-full z-30 px-6 flex items-center justify-between">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('dashboard')}>
                            <div className="bg-slate-900 w-8 h-8 rounded-lg flex items-center justify-center shadow-lg">
                                <i className="ph-bold ph-scales text-white text-xl"></i>
                            </div>
                            <h1 className="font-bold text-slate-800 tracking-tight">Legal Brief Vault <span className="text-brand-600">Pro V3.1</span></h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={handleExportAll} className="text-xs font-bold text-slate-500 hover:text-brand-600 flex items-center gap-1">
                                <i className="ph-bold ph-download-simple"></i> Backup
                            </button>
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-700">
                                <i className="ph-fill ph-gear text-xl"></i>
                            </button>
                        </div>
                    </header>

                    <main className="pt-16 h-screen">
                        {view === 'dashboard' ? (
                            <Dashboard 
                                projects={projects} 
                                onCreateProject={handleCreateProject} 
                                onSelectProject={(id) => { setCurrentProject(projects.find(p => p.id === id)); setView('workspace'); }}
                                onDeleteProject={handleDeleteProject}
                                onImportData={handleImportData}
                            />
                        ) : (
                            <Workspace 
                                project={currentProject} 
                                apiKeys={apiKeys}
                                selectedModel={selectedModel}
                                onBack={() => { setView('dashboard'); refreshProjects(); }}
                                addToast={addToast}
                                updateProjectStats={updateProjectStats}
                            />
                        )}
                    </main>

                    <ToastManager toasts={toasts} removeToast={removeToast} />
                    
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex justify-center items-center z-50 p-4" onClick={() => setIsSettingsOpen(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-lg p-6 animate-enter flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                <h2 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                                    <i className="ph-bold ph-gear"></i> Settings
                                </h2>
                                
                                <div className="space-y-6 overflow-y-auto pr-2 custom-scrollbar">
                                    <div className="space-y-2">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase">AI Model Selection</h3>
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                            <label className="block text-sm font-medium text-slate-700 mb-2">Gemini Model</label>
                                            <select 
                                                value={selectedModel} 
                                                onChange={(e) => setSelectedModel(e.target.value)}
                                                className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-brand-500 shadow-sm"
                                            >
                                                {AVAILABLE_MODELS.map(model => (
                                                    <option key={model.id} value={model.id}>
                                                        {model.name}
                                                    </option>
                                                ))}
                                            </select>
                                            <p className="text-xs text-slate-500 mt-2">
                                                Select the AI model used for extraction. 'Preview' models may have different limits or features.
                                            </p>
                                        </div>
                                    </div>

                                    <div className="space-y-2">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase">API Keys</h3>
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                            <div className="flex gap-2 mb-3">
                                                <input id="newKeyInput" type="text" className="flex-1 border rounded px-3 py-2 text-sm focus:outline-none focus:border-brand-500" placeholder="sk-..." />
                                                <button onClick={() => {
                                                    const input = document.getElementById('newKeyInput');
                                                    if(input.value) {
                                                        setApiKeys(prev => [...prev, { id: Date.now(), key: input.value, active: true, interval: 30000, lastUsed: 0 }]);
                                                        input.value = '';
                                                    }
                                                }} className="bg-brand-600 hover:bg-brand-700 text-white px-4 rounded text-sm font-bold transition-colors">Add</button>
                                            </div>
                                            <div className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                                {apiKeys.length === 0 && <p className="text-xs text-slate-400 text-center py-2">No keys added.</p>}
                                                {apiKeys.map(k => (
                                                    <div key={k.id} className="flex justify-between items-center p-2 bg-white border rounded text-sm shadow-sm">
                                                        <span className="truncate w-40 font-mono text-slate-600">{k.key.substring(0,8)}...</span>
                                                        <button onClick={() => setApiKeys(prev => prev.filter(x => x.id !== k.id))} className="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition-colors">
                                                            <i className="ph-bold ph-trash"></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
