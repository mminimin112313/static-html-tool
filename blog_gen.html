<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Content Master Pro v2.5</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(255, 255, 255, 0.05)",
                        glassBorder: "rgba(255, 255, 255, 0.1)",
                        glassHover: "rgba(255, 255, 255, 0.1)",
                    },
                    backdropBlur: {
                        xs: '2px',
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (Standalone) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel { 
            background: rgba(17, 25, 40, 0.75); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.125); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-button {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }
        .glass-button:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.1) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.2);
        }

        .gradient-text {
            background: linear-gradient(to right, #818cf8, #c084fc, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .gradient-border-bottom {
            position: relative;
        }
        .gradient-border-bottom::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
        }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 overflow-hidden relative">
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-indigo-900/30 blur-[120px] animate-pulse-slow"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-purple-900/30 blur-[120px] animate-pulse-slow" style="animation-delay: 2s;"></div>
    </div>

    <div id="root" class="relative z-10 w-full h-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, updateDoc, doc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const { useState, useEffect, useRef, useCallback } = React;

        // --- GLOBAL FIREBASE INIT LOGIC ---
        const LS_KEY = 'firebase_app_config_v2';
        let firebaseApp = null, auth = null, db = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let configData = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        if (!configData) {
            const saved = localStorage.getItem(LS_KEY);
            if (saved) {
                try { configData = JSON.parse(saved); } catch (e) { console.error("Invalid cached config", e); }
            }
        }

        if (configData && configData.apiKey) {
            try {
                firebaseApp = initializeApp(configData);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
            } catch (e) {
                console.error("Firebase Init Failed:", e);
            }
        }

        // --- Constants ---
        const DB_NAME = 'AIContentMasterDB';
        const DB_VERSION = 1;
        const STORES = { MEDIA: 'media' };
        
        const JOB_STATUS = { PENDING: 'pending', PROCESSING: 'processing', COMPLETED: 'completed', FAILED: 'failed' };
        const KEY_STATUS = { READY: 'ready', BUSY: 'busy', COOLDOWN: 'cooldown', DEAD: 'dead' };
        const AVAILABLE_MODELS = [
            { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash' },
            { id: 'gemini-2.5-flash-preview-09-2025', name: 'Gemini 2.5 Flash Preview' },
            { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro' },
            { id: 'gemini-2.0-flash-exp', name: 'Gemini 2.0 Flash Exp' },
            { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro' },
            { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash' },
        ];

        // --- Cover Themes (Ported from User File) ---
        // --- Cover Themes (Hardcoded Styles for Stability) ---
        const COVER_THEMES = [
        {
            id: 2, name: "Statute Insight", desc: "ë²•ë ¹ ìŠ¤íƒ€ì¼, ê¹”ë”í•œ ë¼ì¸",
            render: (data) => `
            <div class="w-full h-full bg-white flex flex-col relative border-[20px] border-slate-100" style="font-family: 'Pretendard', sans-serif;">
                <div class="h-2 w-full bg-[#0F172A]"></div>
                <div class="flex-1 p-16 flex flex-col justify-center relative overflow-hidden">
                <div class="absolute right-[-50px] top-[-50px] text-[15rem] text-slate-50 opacity-80"><i class="bi bi-paragraph"></i></div>
                <div class="w-14 h-14 bg-[#0F172A] flex items-center justify-center text-white text-2xl mb-10 shadow-sm rounded-sm"><i class="bi ${data.icon}"></i></div>
                <div class="relative z-10">
                    <span class="text-[#B45309] text-sm uppercase block mb-6 font-bold" style="letter-spacing: 0.3em;">${data.category}</span>
                    <h1 class="text-slate-900 text-[4.8rem] font-bold leading-[1.15] mb-10 break-keep" style="letter-spacing: -2px;">${data.title.replace(/\n/g, '<br/>')}</h1>
                    <p class="text-slate-500 text-2xl leading-relaxed border-l-4 border-slate-200 pl-6 max-w-2xl" style="font-family: 'Noto Serif KR', serif; letter-spacing: -0.5px;">${data.subtitle}</p>
                </div>
                </div>
                <div class="h-[120px] bg-[#0F172A] flex items-center justify-between px-16">
                <div class="text-white/80 text-lg font-light" style="letter-spacing: 0.05em;">${data.author}</div>
                <div class="bg-[#B45309] text-white px-6 py-2 text-lg font-bold">ìì„¸íˆ ë³´ê¸° <i class="bi bi-arrow-right ml-2"></i></div>
                </div>
            </div>`
        },
        {
            id: 3, name: "Expert Column", desc: "ì¹¼ëŸ¼ ìŠ¤íƒ€ì¼, í…ìŠ¤íŠ¸ ì¤‘ì‹¬",
            render: (data) => `
            <div class="w-full h-full bg-[#0F172A] flex flex-col items-center justify-center p-20 text-center relative overflow-hidden" style="font-family: 'Pretendard', sans-serif;">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] border border-white/5 rounded-full"></div>
                <div class="relative z-10">
                <div class="inline-flex items-center gap-3 mb-10 border border-white/20 px-5 py-2 rounded-full">
                    <span class="w-2 h-2 rounded-full bg-[#B45309]"></span>
                    <span class="text-slate-300 text-sm uppercase font-bold" style="letter-spacing: 0.15em;">${data.category}</span>
                </div>
                <h1 class="text-white text-[5rem] font-bold leading-[1.2] mb-12" style="font-family: 'Noto Serif KR', serif; letter-spacing: -2px;">${data.title.replace(/\n/g, '<br/>')}</h1>
                <p class="text-slate-400 text-2xl font-light max-w-2xl mx-auto leading-relaxed" style="letter-spacing: -0.5px;">${data.subtitle}</p>
                </div>
                <div class="absolute bottom-12 text-[#B45309] opacity-50 text-sm uppercase" style="letter-spacing: 0.5em;">${data.author}</div>
            </div>`
        },
        {
            id: 4, name: "Case Study", desc: "ì¹´ë“œí˜• ë””ìì¸",
            render: (data) => `
            <div class="w-full h-full bg-slate-100 flex items-center justify-center p-14" style="font-family: 'Pretendard', sans-serif;">
                <div class="bg-white w-full h-full shadow-xl flex flex-col border-t-8 border-[#0F172A]">
                <div class="flex-[1] border-b border-slate-100 relative p-10 flex items-start justify-between">
                    <div class="bg-white px-4 py-2 shadow-sm border border-slate-100"><span class="text-slate-400 text-xs font-bold uppercase" style="letter-spacing: 0.05em;">Case No. 2025</span></div>
                    <i class="bi ${data.icon} text-5xl text-slate-200"></i>
                </div>
                <div class="flex-[2] p-12 flex flex-col justify-center">
                    <span class="text-[#B45309] font-bold uppercase text-sm mb-4 block" style="letter-spacing: 0.15em;">${data.category}</span>
                    <h1 class="text-slate-800 text-[4.5rem] font-bold leading-[1.15] mb-8 break-keep" style="letter-spacing: -2px;">${data.title.replace(/\n/g, ' ')}</h1>
                    <p class="text-slate-500 text-2xl leading-relaxed" style="letter-spacing: -0.5px;">${data.subtitle}</p>
                </div>
                <div class="px-12 py-8 bg-slate-50 border-t border-slate-100 flex items-center justify-between">
                    <span class="text-slate-400 font-bold text-sm">${data.author}</span>
                    <div class="text-[#0F172A] font-bold text-lg flex items-center gap-2">Read Case <i class="bi bi-chevron-right text-xs"></i></div>
                </div>
                </div>
            </div>`
        },
        {
            id: 5, name: "Core Message", desc: "ê°•ì¡°í˜• ë””ìì¸",
            render: (data) => `
            <div class="w-full h-full bg-[#FDFBF7] flex flex-col items-center justify-center p-16 text-center border-[24px] border-white shadow-inner" style="font-family: 'Pretendard', sans-serif;">
                <i class="bi bi-quote text-6xl text-[#B45309]/30 mb-8"></i>
                <h1 class="text-slate-900 text-[4.2rem] font-black leading-[1.25] mb-12 max-w-4xl break-keep" style="font-family: 'Noto Serif KR', serif; letter-spacing: -2px;">${data.title.replace(/\n/g, '<br/>')}</h1>
                <div class="w-16 h-1 bg-[#0F172A] mb-10"></div>
                <p class="text-slate-600 text-2xl font-medium max-w-2xl leading-relaxed mb-12" style="letter-spacing: -0.5px;">${data.subtitle}</p>
                <div class="inline-block border border-slate-300 px-6 py-2 rounded-full">
                <span class="text-slate-400 text-sm font-bold uppercase" style="letter-spacing: 0.1em;">${data.author}</span>
                </div>
            </div>`
        },
        {
            id: 6, name: "Daily Brief", desc: "ë‰´ìŠ¤ë ˆí„° ìŠ¤íƒ€ì¼",
            render: (data) => `
            <div class="w-full h-full bg-[#1E293B] text-white flex flex-col p-16 justify-between relative overflow-hidden" style="font-family: 'Pretendard', sans-serif;">
                <div class="absolute left-0 top-0 bottom-0 w-3 bg-[#B45309]"></div>
                <div class="flex justify-between items-start pl-8 border-b border-slate-700 pb-8 z-10">
                <div class="bg-[#B45309] text-white px-4 py-1 font-bold uppercase text-sm" style="letter-spacing: 0.1em;">${data.category}</div>
                <span class="text-slate-500 italic text-lg" style="font-family: 'Noto Serif KR', serif;">Legal Report</span>
                </div>
                <div class="flex-1 flex flex-col justify-center pl-8 z-10">
                <h1 class="text-[5rem] font-bold leading-[1.1] mb-10 text-white/95" style="letter-spacing: -2px;">${data.title.replace(/\n/g, '<br/>')}</h1>
                <p class="text-slate-400 text-2xl max-w-2xl leading-relaxed" style="letter-spacing: -0.5px;">${data.subtitle}</p>
                </div>
                <div class="pl-8 pt-8 flex items-center gap-4 border-t border-slate-700">
                <div class="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center text-slate-300"><i class="bi ${data.icon} text-2xl"></i></div>
                <div><div class="text-sm font-bold text-slate-300 uppercase">Writer</div><div class="text-white font-medium">${data.author}</div></div>
                </div>
            </div>`
        }
        ];
            

        // --- IndexedDB & Utils ---
        const idb = {
            open: () => new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORES.MEDIA)) db.createObjectStore(STORES.MEDIA, { keyPath: 'id' });
                };
            }),
            put: async (storeName, data) => {
                const db = await idb.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readwrite');
                    tx.objectStore(storeName).put(data);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            get: async (storeName, id) => {
                const db = await idb.open();
                return new Promise((resolve, reject) => {
                    const req = db.transaction(storeName, 'readonly').objectStore(storeName).get(id);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }
        };

        const processImage = async (file) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = Math.min(1, 1200 / img.width);
                    canvas.width = img.width * scale; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 20; ctx.strokeRect(0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        const noise = (Math.random() - 0.5) * 30;
                        data[i] = Math.min(255, Math.max(0, data[i] + noise));
                        data[i+1] = Math.min(255, Math.max(0, data[i+1] + noise));
                        data[i+2] = Math.min(255, Math.max(0, data[i+2] + noise));
                    }
                    ctx.putImageData(imageData, 0, 0);
                    canvas.toBlob((blob) => resolve(blob), 'image/webp', 0.85);
                };
                img.src = URL.createObjectURL(file);
            });
        };

        const cleanText = (text) => {
            if (!text) return "";
            let cleaned = text;

            // 1. HTML íƒœê·¸ ë° ì—”í‹°í‹° ì²˜ë¦¬
            cleaned = cleaned.replace(/<br\s*\/?>/gi, '\n');
            const entities = { 'amp': '&', 'gt': '>', 'lt': '<', 'quot': '"', 'apos': "'", 'nbsp': ' ' };
            cleaned = cleaned.replace(/&([a-z\d]+);/gi, (match, entity) => entities[entity.toLowerCase()] || match);
            cleaned = cleaned.replace(/&#(\d+);/g, (match, dec) => String.fromCharCode(dec));
            cleaned = cleaned.replace(/<[^>]*>/g, '');

            // 2. [ìˆ«ì] í˜•íƒœ ì£¼ì„ ë° ë§ˆí¬ë‹¤ìš´ ì œê±°
            cleaned = cleaned.replace(/\[\d+\]/g, '');
            cleaned = cleaned.replace(/!\[[^\]]*\]\((?:[^)]+)\)/g, ''); // ì´ë¯¸ì§€ ì œê±°
            cleaned = cleaned.replace(/\[([^\]]+)\]\((?:[^)]+)\)/g, '$1'); // ë§í¬ í…ìŠ¤íŠ¸ ìœ ì§€
            cleaned = cleaned.replace(/(\*\*|__)(.*?)\1/g, '$2');
            cleaned = cleaned.replace(/(\*|_)(.*?)\1/g, '$2');
            cleaned = cleaned.replace(/`([^`]+)`/g, '$1');
            cleaned = cleaned.replace(/^(?:[#]{1,6}|[*\-+]|[>\s]+|[0-9]+\.)\s*/gm, '');
            cleaned = cleaned.replace(/^---*|^===*|^___*/gm, '');

            // 3. ìƒìš©êµ¬ íŒ¨í„´ ì œê±° (í™•ì¥ë¨)
            const boilerplatePatterns = [
                /^ëŒ€í‘œì‚¬ì§„ ì‚­ì œë§í¬AI í™œìš© ì„¤ì •/,
                /^ì‚¬ì§„ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”/,
                /^ì´ë¯¸ì§€ ì¸ë„¤ì¼ ì‚­ì œ/,
                /^ì¶œì²˜ ì…ë ¥/,
                /^ê¹€ë¬´ê´€ë²•ë¬´ì‚¬ì‚¬ë¬´ì†Œ/,
                /^ê²½ê¸°ë„ ìˆ˜ì›ì‹œ ì˜í†µêµ¬.*$/,
                /^\s*#.*/,
                /^ëŒ€í‘œì‚¬ì§„ ì‚­ì œ/, /^ì‚¬ì§„ ì„¤ëª…/
            ];
            boilerplatePatterns.forEach(pattern => {
                cleaned = cleaned.replace(new RegExp(pattern, 'gm'), '');
            });

            // 4. ê°€ì§œ ê³µë°±(Unicode Fake Space) ì œê±°
            const fakeSpaceRegex = /[\u00A0\u1680\u180E\u2000-\u200A\u202F\u205F\u3000\u200B\u200C\u200D\uFEFF]/g;
            cleaned = cleaned.replace(fakeSpaceRegex, ' ');

            // 5. ìµœì¢… í¬ë§·íŒ… (ë¹ˆ ì¤„ ì œê±° ë° ê°œí–‰ ê·œì¹™ ì ìš©)
            return cleaned.split('\n')
                .map(l => l.trim())
                .filter(l => l.length > 0)
                .map(l => l.endsWith('?') ? '\n' + l + '\n\n' : l + '\n\n')
                .join('').trim();
        };

        // --- COMPONENTS ---

        function ConfigWizard() {
            const [jsonInput, setJsonInput] = useState('');
            const [error, setError] = useState(null);

            const handleSave = () => {
                try {
                    const parsed = JSON.parse(jsonInput);
                    if (!parsed.apiKey || !parsed.projectId) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ Firebase Config JSONì…ë‹ˆë‹¤.");
                    localStorage.setItem(LS_KEY, JSON.stringify(parsed));
                    window.location.reload();
                } catch (e) {
                    setError(e.message);
                }
            };

            return (
                <div className="flex h-screen items-center justify-center relative z-20">
                    <div className="glass-panel p-10 rounded-3xl w-full max-w-lg shadow-2xl border border-white/10">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg"><i className="bi bi-gear-wide-connected text-3xl text-white"></i></div>
                            <h1 className="text-3xl font-bold text-white mb-2">ì‹œìŠ¤í…œ ì„¤ì •</h1>
                            <p className="text-slate-400">Firebase ì—°ê²° ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        </div>
                        
                        <div className="space-y-4">
                            <div className="bg-indigo-900/30 border border-indigo-500/30 p-4 rounded-xl text-sm text-indigo-200 leading-relaxed">
                                <i className="bi bi-info-circle-fill mr-2"></i>
                                Firebase Console &gt; í”„ë¡œì íŠ¸ ì„¤ì • &gt; ë‚´ ì•± &gt; SDK ì„¤ì • ë° êµ¬ì„±ì—ì„œ <code>const firebaseConfig = {'{...}'}</code> ë‚´ë¶€ì˜ JSON ê°ì²´ë¥¼ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
                            </div>
                            <textarea 
                                className="w-full h-40 bg-black/30 border border-white/10 rounded-xl p-4 text-slate-300 font-mono text-xs focus:border-indigo-500 outline-none resize-none"
                                placeholder='{ "apiKey": "...", "authDomain": "...", ... }'
                                value={jsonInput}
                                onChange={e => setJsonInput(e.target.value)}
                            />
                            {error && <p className="text-red-400 text-sm flex items-center gap-2"><i className="bi bi-exclamation-triangle"></i> {error}</p>}
                            <button onClick={handleSave} className="w-full py-4 bg-gradient-to-r from-indigo-600 to-violet-600 rounded-xl font-bold text-white shadow-lg hover:shadow-indigo-500/30 transition-all transform hover:-translate-y-1">
                                ì„¤ì • ì €ì¥ ë° ì‹œì‘
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function AuthScreen({ onLogin, onAnon }) {
            return (
                <div className="flex h-screen items-center justify-center relative z-20">
                    <div className="glass-panel p-10 rounded-3xl w-full max-w-md text-center shadow-2xl border border-white/10 relative overflow-hidden group">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        <div className="w-24 h-24 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-3xl mx-auto mb-8 flex items-center justify-center shadow-lg shadow-indigo-500/30 group-hover:scale-105 transition-transform duration-500">
                            <i className="bi bi-stars text-4xl text-white"></i>
                        </div>
                        <h1 className="text-4xl font-bold mb-3 gradient-text">AI Content Master</h1>
                        <p className="text-slate-400 mb-10 font-light text-lg">Next-Gen Creative Automation</p>
                        <div className="space-y-4">
                            <button onClick={onLogin} className="w-full py-4 px-6 bg-white hover:bg-slate-50 text-slate-900 font-bold rounded-2xl transition flex items-center justify-center gap-3 shadow-xl hover:shadow-2xl transform hover:-translate-y-1">
                                <i className="bi bi-google text-xl text-red-500"></i> Google Login
                            </button>
                            <button onClick={onAnon} className="w-full py-4 px-6 glass-button rounded-2xl font-medium text-slate-200 flex items-center justify-center gap-3">
                                <i className="bi bi-incognito text-xl"></i> Guest Access
                            </button>
                        </div>
                        <div className="mt-8 pt-4 border-t border-white/5">
                            <button onClick={() => { localStorage.removeItem(LS_KEY); window.location.reload(); }} className="text-xs text-slate-600 hover:text-slate-400">ì„¤ì • ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </div>
            );
        }

        function Sidebar({ activeTab, setActiveTab }) {
            const menu = [
                { id: 'dashboard', icon: 'bi-grid-1x2-fill', label: 'ëŒ€ì‹œë³´ë“œ' },
                { id: 'references', icon: 'bi-collection-play-fill', label: 'ìë£Œ ì„¼í„°' },
                { id: 'generator', icon: 'bi-magic', label: 'ì½˜í…ì¸  ìƒì„±' },
                { id: 'jobs', icon: 'bi-list-check', label: 'ì‘ì—… ê´€ë¦¬' },
                { id: 'settings', icon: 'bi-gear-fill', label: 'ì‹œìŠ¤í…œ ì„¤ì •' }
            ];
            return (
                <aside className="w-20 lg:w-72 glass-panel border-r border-white/5 flex flex-col justify-between z-20 h-full">
                    <div className="p-4 lg:p-6">
                        <div className="h-16 flex items-center justify-center lg:justify-start lg:px-2 mb-8">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl flex items-center justify-center mr-0 lg:mr-3 shadow-lg shadow-indigo-500/20">
                                <i className="bi bi-cpu-fill text-white text-lg"></i>
                            </div>
                            <span className="hidden lg:block font-bold text-xl tracking-tight text-white">AI Master <span className="text-xs font-normal text-indigo-400 ml-1">Pro</span></span>
                        </div>
                        <nav className="space-y-2">
                            {menu.map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} 
                                    className={`w-full flex items-center p-4 rounded-2xl transition-all duration-300 group relative overflow-hidden ${activeTab === item.id ? 'bg-gradient-to-r from-indigo-600/90 to-violet-600/90 text-white shadow-lg shadow-indigo-500/20' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>
                                    <i className={`bi ${item.icon} text-xl ${activeTab === item.id ? 'animate-pulse' : 'group-hover:scale-110 transition-transform'}`}></i>
                                    <span className="hidden lg:block ml-4 font-medium tracking-wide">{item.label}</span>
                                    {activeTab === item.id && <div className="absolute right-0 top-1/2 transform -translate-y-1/2 w-1 h-8 bg-white/50 rounded-l-full"></div>}
                                </button>
                            ))}
                        </nav>
                    </div>
                    <div className="p-6">
                        <button onClick={() => auth.signOut()} className="w-full flex items-center p-4 rounded-2xl text-slate-400 hover:bg-red-500/10 hover:text-red-400 transition-all border border-transparent hover:border-red-500/20 group">
                            <i className="bi bi-box-arrow-left text-xl group-hover:-translate-x-1 transition-transform"></i>
                            <span className="hidden lg:block ml-4 font-medium">ë¡œê·¸ì•„ì›ƒ</span>
                        </button>
                    </div>
                </aside>
            );
        }

        function Dashboard({ jobs, queueStatus }) {
            return (
                <div className="space-y-8 animate-fade-in-up">
                    <div className="flex items-center justify-between gradient-border-bottom pb-6">
                        <div><h2 className="text-3xl font-bold text-white mb-2">ëŒ€ì‹œë³´ë“œ</h2><p className="text-slate-400">ì‘ì—… í˜„í™© ë° í†µê³„ ìš”ì•½</p></div>
                        <div className="flex items-center gap-2 px-4 py-2 rounded-full glass-panel text-sm text-indigo-300"><span className="relative flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span></span>System Online</div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="glass-panel p-8 rounded-3xl relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i className="bi bi-check-circle-fill text-8xl text-emerald-400"></i></div>
                            <p className="text-emerald-400 text-sm font-bold uppercase tracking-wider mb-2">Completed</p><h3 className="text-5xl font-bold text-white mb-1">{queueStatus.completed}</h3>
                        </div>
                        <div className="glass-panel p-8 rounded-3xl relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i className="bi bi-hourglass-split text-8xl text-amber-400"></i></div>
                            <p className="text-amber-400 text-sm font-bold uppercase tracking-wider mb-2">Pending</p><h3 className="text-5xl font-bold text-white mb-1">{queueStatus.pending}</h3>
                        </div>
                        <div className="glass-panel p-8 rounded-3xl relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i className="bi bi-layers-fill text-8xl text-indigo-400"></i></div>
                            <p className="text-indigo-400 text-sm font-bold uppercase tracking-wider mb-2">Total Jobs</p><h3 className="text-5xl font-bold text-white mb-1">{jobs.length}</h3>
                        </div>
                    </div>
                </div>
            );
        }

        function ReferenceManager({ user, references, showToast }) {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');
            const [isDragging, setIsDragging] = useState(false);
            const addReference = async () => {
                if (!title.trim() || !content.trim()) return showToast('ì œëª©/ë‚´ìš© í•„ìˆ˜', 'error');
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'references'), { title, content, createdAt: Date.now() });
                setTitle(''); setContent(''); showToast('ìë£Œê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            };
            const deleteRef = async (id) => { if(confirm('ì´ ìë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'references', id)); };
            const handleDrop = async (e) => {
                e.preventDefault(); setIsDragging(false); const file = e.dataTransfer.files[0];
                if(file && file.type.startsWith('text/')) { setTitle(file.name.replace('.txt','')); setContent(await file.text()); showToast('íŒŒì¼ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
            };
            return (
                <div className="h-full flex flex-col space-y-6 animate-fade-in-up">
                    <div className="flex items-center justify-between gradient-border-bottom pb-6"><div><h2 className="text-3xl font-bold text-white mb-2">ìë£Œ ê´€ë¦¬ ì„¼í„°</h2><p className="text-slate-400">í”„ë¡¬í”„íŠ¸ ì»¨í…ìŠ¤íŠ¸ ìì› ê´€ë¦¬</p></div></div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8 flex-1 min-h-0">
                        <div className="md:col-span-1 flex flex-col gap-6">
                            <div onDragOver={e=>{e.preventDefault();setIsDragging(true)}} onDragLeave={()=>setIsDragging(false)} onDrop={handleDrop} className={`flex-1 glass-panel p-6 rounded-3xl flex flex-col gap-5 transition-all duration-300 ${isDragging ? 'border-indigo-500 bg-indigo-500/10 scale-[1.02]' : 'hover:border-white/20'}`}>
                                <div className="flex justify-between items-center"><h3 className="font-bold text-xl text-white flex items-center gap-2"><i className="bi bi-file-earmark-text-fill text-indigo-400"></i> ìƒˆ ìë£Œ ë“±ë¡</h3><span className="text-xs bg-white/10 px-2 py-1 rounded text-slate-400">Drag & Drop .txt</span></div>
                                <input className="bg-black/20 border border-white/10 rounded-xl p-4 text-white placeholder-slate-500 focus:border-indigo-500 focus:bg-indigo-900/10 outline-none transition-colors" placeholder="ìë£Œ ì œëª© (ì˜ˆ: 2024 íŠ¸ë Œë“œ ë³´ê³ ì„œ)" value={title} onChange={e=>setTitle(e.target.value)} />
                                <textarea className="flex-1 bg-black/20 border border-white/10 rounded-xl p-4 text-white placeholder-slate-500 focus:border-indigo-500 focus:bg-indigo-900/10 outline-none resize-none transition-colors leading-relaxed font-mono text-sm" placeholder="ë‚´ìš©ì„ ë¶™ì—¬ë„£ê±°ë‚˜ í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ì„¸ìš”." value={content} onChange={e=>setContent(e.target.value)} />
                                <button onClick={addReference} className="py-4 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-2"><i className="bi bi-cloud-arrow-up-fill text-lg"></i> ì €ì¥í•˜ê¸°</button>
                            </div>
                        </div>
                        <div className="md:col-span-2 glass-panel rounded-3xl overflow-hidden flex flex-col">
                            <div className="p-6 border-b border-white/5 bg-black/20 flex justify-between items-center"><h3 className="font-bold text-lg text-white">ë³´ê´€ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬</h3><span className="bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-full text-xs font-bold">{references.length} Items</span></div>
                            <div className="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-hide">
                                {references.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-slate-600 gap-4"><i className="bi bi-inbox-fill text-6xl opacity-20"></i><p>ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div> : references.map(r=>(
                                    <div key={r.id} className="bg-white/5 hover:bg-white/10 p-5 rounded-2xl border border-white/5 hover:border-indigo-500/30 transition-all group relative">
                                        <div className="flex justify-between items-start mb-3"><span className="font-bold text-indigo-100 flex items-center gap-2"><i className="bi bi-bookmark-fill text-indigo-500"></i> {r.title}</span><button onClick={()=>deleteRef(r.id)} className="text-slate-500 hover:text-red-400 transition-colors p-2 hover:bg-white/5 rounded-full"><i className="bi bi-trash3-fill"></i></button></div>
                                        <p className="text-sm text-slate-400 line-clamp-2 font-mono leading-relaxed pl-6 border-l-2 border-white/5">{r.content}</p>
                                        <div className="mt-3 pl-6 text-xs text-slate-600">{new Date(r.createdAt).toLocaleDateString()}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Generator({ user, apiKeys, references, showToast, genState, setGenState, savedPrompts, modelConfig, setModelConfig }) {
            const [selectedRefIds, setSelectedRefIds] = useState([]);
            const [refSearch, setRefSearch] = useState('');

            const applyTemplateDirect = (template) => {
                    if (confirm('í˜„ì¬ ì‘ì„± ì¤‘ì¸ í”„ë¡¬í”„íŠ¸ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setGenState(p => ({ ...p, basePrompt: template.content }));
                    showToast(`'${template.title}' í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
                    }
                };

                const savePromptTemplate = async () => {
                if (!genState.basePrompt.trim()) return showToast('ì €ì¥í•  í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                const title = prompt('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë¸”ë¡œê·¸ ì‘ì„±ìš©):');
                if (!title) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'prompts'), { title, content: genState.basePrompt, createdAt: Date.now() });
                showToast('í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            };
            
            const loadPromptTemplate = (e) => {
                const targetId = e.target.value;
                if (!targetId) return;
                const template = savedPrompts.find(p => p.id === targetId);
                if (template) {
                if (confirm('í˜„ì¬ ì‘ì„± ì¤‘ì¸ í”„ë¡¬í”„íŠ¸ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setGenState(p => ({ ...p, basePrompt: template.content }));
                    showToast(`'${template.title}' í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
                }
                }
                e.target.value = ""; // Reset selection
            };

            const deleteTemplate = async (id, title) => {
                if(confirm(`'${title}' í…œí”Œë¦¿ì„ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'prompts', id));
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            };

            const handleBulkGenerate = async () => {
                if(apiKeys.length===0) return showToast('API í‚¤ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.', 'error');
                const list = genState.topics.split('\n').filter(t=>t.trim());
                if(list.length===0) return showToast('ì£¼ì œë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                const refs = selectedRefIds.map(id => references.find(r=>r.id===id)?.content).join('\n\n');
                
                const batch = list.map(topic => addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'jobs'), {
                    topic: topic.trim(),
                    prompt: genState.basePrompt.replace('{{ì£¼ì œ}}', topic).replace('{{ìë£Œ}}', refs || 'ì—†ìŒ'),
                    modelConfig: modelConfig, // Save all model settings
                    status: JOB_STATUS.PENDING,
                    createdAt: Date.now(),
                    images: []
                }));
                await Promise.all(batch);
                showToast(`${list.length}ê°œì˜ ì‘ì—…ì´ ëŒ€ê¸°ì—´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                setGenState(p => ({...p, topics: ''}));
            };

            return (
                <div className="h-full flex flex-col space-y-6 animate-fade-in-up">
                    <div className="flex items-center justify-between gradient-border-bottom pb-6">
                        <div><h2 className="text-3xl font-bold text-white mb-2">í¬ë¦¬ì—ì´í‹°ë¸Œ ìŠ¤íŠœë””ì˜¤</h2><p className="text-slate-400">ëŒ€ëŸ‰ ì½˜í…ì¸  ìƒì„± ë° í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§</p></div>
                    </div>
                    
                    {/* Model & Theme Configuration Panel */}
                    <div className="glass-panel p-4 rounded-2xl border border-white/10 flex flex-wrap gap-4 items-center justify-between bg-white/[0.02]">
                         <div className="flex gap-4 flex-wrap">
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">âœï¸ ê¸€ ì‘ì„± ëª¨ë¸</label>
                                <select className="bg-black/30 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white outline-none" value={modelConfig.text} onChange={e=>setModelConfig(p=>({...p,text:e.target.value}))}>
                                    {AVAILABLE_MODELS.map(m=><option key={m.id} value={m.id} className="bg-slate-900">{m.name}</option>)}
                                </select>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">ğŸ“Š ë„í‘œ ëª¨ë¸</label>
                                <select className="bg-black/30 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white outline-none" value={modelConfig.chart} onChange={e=>setModelConfig(p=>({...p,chart:e.target.value}))}>
                                    {AVAILABLE_MODELS.map(m=><option key={m.id} value={m.id} className="bg-slate-900">{m.name}</option>)}
                                </select>
                            </div>
                            <div className="flex flex-col gap-1">
                                <label className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">ğŸ¨ í‘œì§€ ëª¨ë¸</label>
                                <select className="bg-black/30 border border-white/10 rounded-lg px-2 py-1.5 text-xs text-white outline-none" value={modelConfig.cover} onChange={e=>setModelConfig(p=>({...p,cover:e.target.value}))}>
                                    {AVAILABLE_MODELS.map(m=><option key={m.id} value={m.id} className="bg-slate-900">{m.name}</option>)}
                                </select>
                            </div>
                         </div>
                         <div className="flex flex-col gap-1 w-full md:w-auto">
                            <label className="text-[10px] text-indigo-400 font-bold uppercase tracking-wider">ğŸ–¼ï¸ í‘œì§€ ë””ìì¸ í…Œë§ˆ</label>
                            <select className="bg-indigo-900/30 border border-indigo-500/30 rounded-lg px-3 py-1.5 text-xs text-white outline-none font-bold" value={modelConfig.themeId} onChange={e=>setModelConfig(p=>({...p,themeId:Number(e.target.value)}))}>
                                {COVER_THEMES.map(t=><option key={t.id} value={t.id} className="bg-slate-900">{t.id}. {t.name}</option>)}
                            </select>
                         </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 flex-1 min-h-0">
                        <div className="flex flex-col gap-6 h-full min-h-0">
                            {/* ì£¼ì œ ëª©ë¡: ë†’ì´ ì¶•ì†Œ (flex-1 -> h-48) */}
                            <div className="glass-panel p-6 rounded-3xl h-48 flex-shrink-0 flex flex-col border border-white/10 hover:border-indigo-500/30 transition-colors">
                                <label className="mb-4 font-bold text-white flex items-center gap-2"><i className="bi bi-list-task text-indigo-400"></i> ì£¼ì œ ëª©ë¡ (Bulk Input)</label>
                                <textarea className="flex-1 bg-black/20 border border-white/10 rounded-xl p-5 text-white placeholder-slate-600 focus:border-indigo-500 outline-none resize-none leading-relaxed text-sm" placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”..." value={genState.topics} onChange={e=>setGenState(p=>({...p, topics:e.target.value}))}/>
                            </div>
                            {/* ì°¸ê³  ìë£Œ: ë†’ì´ í™•ëŒ€ (h-72 -> flex-1) */}
                            <div className="glass-panel p-6 rounded-3xl flex-1 flex flex-col border border-white/10 hover:border-indigo-500/30 transition-colors min-h-0 overflow-hidden">
                                <label className="mb-2 font-bold text-white flex items-center gap-2"><i className="bi bi-link-45deg text-indigo-400"></i> ì°¸ê³  ìë£Œ ì—°ê²°</label>
                                <div className="mb-3"><input className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-xs text-white placeholder-slate-500 focus:border-indigo-500 outline-none transition-colors" placeholder="ìë£Œ ê²€ìƒ‰..." value={refSearch} onChange={e=>setRefSearch(e.target.value)} /></div>
                                <div className="flex-1 overflow-y-auto space-y-2 scrollbar-hide pr-2">
                                {references.length === 0 ? <p className="text-center text-slate-600 py-10">ìë£Œ ì—†ìŒ</p> : references.filter(r=>r.title.toLowerCase().includes(refSearch.toLowerCase())).map(r=>(
                                    <label key={r.id} className={`flex items-center gap-4 p-4 rounded-xl border cursor-pointer transition-all ${selectedRefIds.includes(r.id)?'bg-indigo-600/20 border-indigo-500':'border-white/5 hover:bg-white/5'}`}><input type="checkbox" className="w-4 h-4 rounded border-slate-500 text-indigo-500 focus:ring-indigo-500 bg-transparent" checked={selectedRefIds.includes(r.id)} onChange={()=>setSelectedRefIds(p=>p.includes(r.id)?p.filter(x=>x!==r.id):[...p,r.id])}/><span className="text-sm font-medium text-slate-200 truncate flex-1">{r.title}</span></label>
                                ))}
                                </div>
                            </div>
                        </div>
                        <div className="glass-panel p-6 rounded-3xl flex flex-col border border-white/10 hover:border-indigo-500/30 transition-colors relative">
                            <div className="flex justify-between items-center mb-4">
                                <label className="font-bold text-white flex items-center gap-2"><i className="bi bi-code-slash text-indigo-400"></i> í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§</label>
                                <div className="flex items-center gap-2">
                                <select onChange={loadPromptTemplate} className="bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-slate-300 outline-none hover:bg-white/10">
                                    <option value="">ğŸ“‚ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°...</option>
                                    {savedPrompts && savedPrompts.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                                </select>
                                <button onClick={savePromptTemplate} className="px-3 py-1.5 bg-indigo-600/30 hover:bg-indigo-600/50 text-indigo-200 rounded-lg text-xs border border-indigo-500/30 transition-colors"><i className="bi bi-save"></i> ì €ì¥</button>
                                </div>
                            </div>
                            <div className="relative flex-1">
                                <textarea className="w-full h-full bg-black/20 border border-white/10 rounded-xl p-5 text-slate-300 focus:border-indigo-500 outline-none resize-none font-mono text-sm leading-relaxed pb-12" value={genState.basePrompt} onChange={e=>setGenState(p=>({...p, basePrompt:e.target.value}))}/>
                                <div className="absolute bottom-4 right-4 flex gap-2 text-xs text-slate-500">
                                    <span className="px-2 py-1 bg-black/40 rounded border border-white/5 text-indigo-300">{'{{ì£¼ì œ}}'}</span>
                                    <span className="px-2 py-1 bg-black/40 rounded border border-white/5 text-indigo-300">{'{{ìë£Œ}}'}</span>
                                </div>
                            </div>
                            {/* Template List Mini View */}
                            {savedPrompts && savedPrompts.length > 0 && (
                                <div className="mt-4 pt-4 border-t border-white/5 overflow-x-auto flex gap-2 scrollbar-hide">
                                {savedPrompts.map(p => (
                                <div key={p.id} onClick={() => applyTemplateDirect(p)} className="cursor-pointer flex-shrink-0 px-3 py-1.5 bg-white/5 hover:bg-indigo-600/20 hover:text-indigo-200 hover:border-indigo-500/30 rounded-lg border border-white/5 flex items-center gap-2 text-xs text-slate-400 transition-all">
                                    <span className="truncate max-w-[100px]">{p.title}</span>
                                    <button onClick={(e) => { e.stopPropagation(); deleteTemplate(p.id, p.title); }} className="hover:text-red-400 p-0.5 rounded hover:bg-white/10"><i className="bi bi-x"></i></button>
                                </div>
                                ))}
                                </div>
                            )}
                            </div>
                    </div>
                    <button onClick={handleBulkGenerate} className="w-full py-5 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 rounded-2xl font-bold text-lg text-white shadow-xl hover:shadow-indigo-500/20 transition-all transform active:scale-[0.99] flex items-center justify-center gap-3 border border-white/10"><i className="bi bi-stars"></i> ì‘ì—… íì— ë“±ë¡í•˜ê¸°</button>
                </div>
            );
        }

        function BatchCoverModal({ isOpen, onClose, onConfirm, count, models }) {
            const [selectedModel, setSelectedModel] = useState('gemini-2.5-flash-lite');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in-up">
                    <div className="bg-[#0f172a] border border-white/10 p-8 rounded-3xl max-w-md w-full shadow-2xl relative">
                        <h3 className="text-2xl font-bold text-white mb-2">ë¯¸ì™„ì„± ì‘ì—… ì¼ê´„ ì²˜ë¦¬</h3>
                        <p className="text-slate-400 mb-6">í‘œì§€ê°€ ì—†ëŠ” <span className="text-indigo-400 font-bold">{count}</span>ê°œì˜ ì‘ì—…ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.<br/>ì¼ê´„ ìƒì„±ì— ì‚¬ìš©í•  ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs text-slate-500 font-bold uppercase mb-2">Select AI Model</label>
                                <select className="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 transition-colors" value={selectedModel} onChange={e=>setSelectedModel(e.target.value)}>
                                    {models.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                </select>
                            </div>
                            <div className="flex gap-3 pt-4">
                                <button onClick={onClose} className="flex-1 py-3 rounded-xl border border-white/10 text-slate-400 hover:bg-white/5 transition-colors">ì·¨ì†Œ</button>
                                <button onClick={() => onConfirm(selectedModel)} className="flex-1 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold shadow-lg shadow-indigo-500/20 transition-all">ì‘ì—… ì‹œì‘</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function JobBoard({ jobs, user, showToast, onSelectJob, onOpenBatch }) {
            const [filter, setFilter] = useState('all');
            const filtered = jobs.filter(j => filter==='all' || j.status===filter);
            const missingCoverCount = jobs.filter(j => j.status === 'completed' && !j.coverJson).length;
            const copy = (txt) => { if(!txt) return showToast('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error'); navigator.clipboard.writeText(cleanText(txt)); showToast('í…ìŠ¤íŠ¸ê°€ ì •ì œë˜ì–´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); };
            const copyCode = (code) => { if(!code) return; navigator.clipboard.writeText(code); showToast('ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); };
            return (
                <div className="space-y-8 animate-fade-in-up">
                    <div className="flex justify-between items-center gradient-border-bottom pb-6">
                        <div><h2 className="text-3xl font-bold text-white mb-2">ì‘ì—… ê´€ë¦¬ ì„¼í„°</h2><p className="text-slate-400">ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§ ë° ê²°ê³¼ í™•ì¸</p></div>
                        <div className="flex gap-3">
                            {missingCoverCount > 0 && (
                                <button onClick={onOpenBatch} className="px-4 py-2 bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 border border-indigo-500/30 rounded-xl text-sm font-bold transition-all flex items-center gap-2 animate-pulse">
                                    <i className="bi bi-magic"></i> ë¯¸ì™„ì„± í•´ê²° ({missingCoverCount})
                                </button>
                            )}
                            <div className="flex bg-black/30 rounded-xl p-1.5 border border-white/10 backdrop-blur-md">{['all','completed','pending','failed'].map(f=><button key={f} onClick={()=>setFilter(f)} className={`px-4 py-2 rounded-lg capitalize text-sm font-medium transition-all ${filter===f ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>{f}</button>)}</div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {filtered.map(j => (
                            <div key={j.id} className="glass-panel rounded-3xl flex flex-col h-80 group hover:border-indigo-500/50 hover:bg-white/[0.02] transition-all duration-300 relative overflow-hidden">
                                <div className="absolute top-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div className="p-5 border-b border-white/5 flex justify-between items-center bg-white/[0.02]"><div className="flex items-center gap-2.5"><div className={`w-2.5 h-2.5 rounded-full ${j.status==='completed'?'bg-emerald-400 shadow-[0_0_10px_#34d399]':j.status==='failed'?'bg-red-500':'bg-amber-400 animate-pulse'}`}></div><span className="text-xs font-bold uppercase tracking-wider text-slate-400">{j.status}</span></div><button onClick={()=>onSelectJob(j)} className="text-slate-400 hover:text-white transition-colors p-1"><i className="bi bi-three-dots-vertical"></i></button></div>
                                <div onClick={()=>onSelectJob(j)} className="p-6 flex-1 relative overflow-hidden cursor-pointer group-inner"><h3 className="font-bold text-lg mb-3 line-clamp-2 text-white group-hover:text-indigo-300 transition-colors">{j.topic}</h3><p className="text-sm text-slate-400 line-clamp-3 leading-relaxed font-light">{j.result || 'ëŒ€ê¸°ì—´ì—ì„œ ì²˜ë¦¬ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...'}</p><div className="absolute inset-0 bg-gradient-to-t from-[#111928] via-transparent opacity-90"></div></div>
                                <div className="p-4 border-t border-white/5 flex justify-between items-center bg-black/20 backdrop-blur-sm"><div className="flex gap-2"><button onClick={()=>copy(j.result)} className="flex items-center gap-2 px-3 py-1.5 bg-white/5 hover:bg-indigo-600/20 hover:text-indigo-300 text-slate-400 rounded-lg text-xs font-medium border border-white/5 transition-all"><i className="bi bi-clipboard-check"></i> í…ìŠ¤íŠ¸</button><button disabled={!j.chartCode} onClick={()=>copyCode(j.chartCode)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium border border-white/5 transition-all ${j.chartCode?'bg-white/5 hover:bg-purple-600/20 hover:text-purple-300 text-slate-400':'opacity-30 cursor-not-allowed'}`}><i className="bi bi-pie-chart-fill"></i> ë„í‘œ</button></div><button onClick={async(e)=>{e.stopPropagation(); if(confirm('ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await deleteDoc(doc(db,'artifacts',appId,'users',user.uid,'jobs',j.id))}} className="text-slate-600 hover:text-red-400 p-2 transition-colors"><i className="bi bi-trash3-fill"></i></button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function CoverEditor({ job, user, showToast, appId }) {
            const [coverData, setCoverData] = useState(null);
            const [themeId, setThemeId] = useState(2);
            const previewRef = useRef(null);
            
            useEffect(() => {
                if (job.coverJson) {
                    try {
                        const parsed = typeof job.coverJson === 'string' ? JSON.parse(job.coverJson) : job.coverJson;
                        setCoverData(parsed);
                    } catch(e) { console.error(e); }
                }
                if (job.modelConfig?.themeId) setThemeId(job.modelConfig.themeId);
            }, [job]);

            const downloadImage = async () => {
                    if (!previewRef.current) return;
                    try {
                    // ì—…ë¡œë“œí•´ì£¼ì‹  íŒŒì¼ì˜ ë¡œì§ ì ìš©: ë Œë”ë§ ì•ˆì •í™”ë¥¼ ìœ„í•´ 0.1ì´ˆ ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const canvas = await html2canvas(previewRef.current, {
                        scale: 2,           // ê³ í•´ìƒë„ (ì—…ë¡œë“œ íŒŒì¼ ì„¤ì • ìœ ì§€)
                        useCORS: true,      // ì™¸ë¶€ ì´ë¯¸ì§€ í—ˆìš© (ì—…ë¡œë“œ íŒŒì¼ ì„¤ì • ìœ ì§€)
                        logging: false,
                        backgroundColor: '#ffffff',
                        // React ì•±ì—ì„œëŠ” ë¯¸ë¦¬ë³´ê¸°ê°€ ì¶•ì†Œ(scale-0.6)ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, 
                        // ì €ì¥í•  ë•Œë§Œ ê°•ì œë¡œ 100% í¬ê¸°ë¡œ ë³µêµ¬í•´ì•¼ ê¹¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        onclone: (clonedDoc) => {
                        const el = clonedDoc.getElementById('cover-capture-target');
                        
                        }
                    });

                    const link = document.createElement('a');
                    link.download = `cover_${job.id}.png`;
                    link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast('í‘œì§€ ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    } catch(e) { showToast('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: '+e.message, 'error'); }
                };

            const saveChanges = async () => {
                try {
                    await updateDoc(doc(db,'artifacts',appId,'users',user.uid,'jobs',job.id), { 
                        coverJson: JSON.stringify(coverData),
                        'modelConfig.themeId': themeId 
                    });
                    showToast('í‘œì§€ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch(e) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
            };

            if (!coverData) return <div className="flex items-center justify-center h-full text-slate-500">í‘œì§€ ë°ì´í„°ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>;

            return (
                <div className="flex flex-col xl:flex-row gap-8 h-full">
                    {/* Controls */}
                    <div className="w-full xl:w-1/3 space-y-6">
                        <div className="glass-panel p-6 rounded-2xl border border-white/10">
                            <h3 className="font-bold text-white mb-4 flex items-center gap-2"><i className="bi bi-palette text-indigo-400"></i> ë””ìì¸ ì„¤ì •</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">í…Œë§ˆ ì„ íƒ</label>
                                    <select className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm text-white outline-none" value={themeId} onChange={e=>setThemeId(Number(e.target.value))}>
                                        {COVER_THEMES.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">ì œëª© (Title)</label>
                                    <textarea className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm text-white outline-none resize-none" rows="2" value={coverData.title} onChange={e=>setCoverData({...coverData, title:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">ë¶€ì œ (Subtitle)</label>
                                    <input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm text-white outline-none" value={coverData.subtitle} onChange={e=>setCoverData({...coverData, subtitle:e.target.value})}/>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div><label className="text-xs text-slate-400 block mb-1">ì¹´í…Œê³ ë¦¬</label><input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm text-white outline-none" value={coverData.category} onChange={e=>setCoverData({...coverData, category:e.target.value})}/></div>
                                    <div><label className="text-xs text-slate-400 block mb-1">ì‘ì„±ì</label><input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm text-white outline-none" value={coverData.author} onChange={e=>setCoverData({...coverData, author:e.target.value})}/></div>
                                </div>
                                <div><label className="text-xs text-slate-400 block mb-1">ì•„ì´ì½˜ (Bootstrap)</label><input className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-sm text-white outline-none" value={coverData.icon} onChange={e=>setCoverData({...coverData, icon:e.target.value})}/></div>
                            </div>
                            <div className="flex gap-2 mt-6">
                                <button onClick={saveChanges} className="flex-1 py-2 bg-indigo-600/30 hover:bg-indigo-600/50 text-indigo-200 rounded-lg text-sm border border-indigo-500/30 transition-colors">ì €ì¥</button>
                                <button onClick={downloadImage} className="flex-1 py-2 bg-emerald-600/30 hover:bg-emerald-600/50 text-emerald-200 rounded-lg text-sm border border-emerald-500/30 transition-colors"><i className="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ</button>
                            </div>
                        </div>
                    </div>
                    {/* Preview */}
                    <div className="flex-1 flex items-center justify-center bg-slate-900/50 rounded-3xl border border-white/5 overflow-hidden relative min-h-[500px]">
                        <div className="scale-[0.6] sm:scale-[0.8] origin-center shadow-2xl">
                             {/* ìº¡ì²˜ ëŒ€ìƒ ì‹ë³„ì„ ìœ„í•œ ID ì¶”ê°€ */}
                             <div id="cover-capture-target" ref={previewRef} className="w-[800px] h-[800px] bg-white text-slate-900 overflow-hidden" dangerouslySetInnerHTML={{__html: (COVER_THEMES.find(t=>t.id===themeId) || COVER_THEMES[0])?.render(coverData) || ''}}></div>
                        </div>
                    </div>
                </div>
            );
        }

        function JobModal({ job, onClose, user, showToast }) {
            const [tab, setTab] = useState('text');
            const [imgs, setImgs] = useState([]);
            const [vidUrl, setVidUrl] = useState(null);
            const [genVid, setGenVid] = useState(false);
            const [isDragging, setIsDragging] = useState(false);

            useEffect(() => {
                const load = async () => {
                    if(job.images?.length) {
                        const blobs = await Promise.all(job.images.map(async id => { const d = await idb.get(STORES.MEDIA, id); return d ? URL.createObjectURL(d.blob) : null; }));
                        setImgs(blobs.filter(Boolean));
                    }
                    if(job.video) { const d = await idb.get(STORES.MEDIA, job.video); if(d) setVidUrl(URL.createObjectURL(d.blob)); }
                    }; load();
        }, [job]);

        const processFiles = async (files) => {
            const newIds = [];
            const processSingle = async (blob) => {
            const processed = await processImage(blob);
            const id = `${job.id}_img_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;
            await idb.put(STORES.MEDIA, { id, blob: processed });
            newIds.push(id);
            };
            for(const f of files) {
            if(f.name.toLowerCase().endsWith('.zip') && window.JSZip) {
                try {
                const zip = new JSZip();
                const loaded = await zip.loadAsync(f);
                for(const filename of Object.keys(loaded.files)) {
                    const fileData = loaded.files[filename];
                    if(!fileData.dir && filename.match(/\.(jpg|jpeg|png|webp)$/i)) {
                    await processSingle(await fileData.async('blob'));
                    }
                }
                showToast('ZIP íŒŒì¼ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch(e) { showToast('ZIP ì²˜ë¦¬ ì˜¤ë¥˜: ' + e.message, 'error'); }
            } else if(f.type.startsWith('image/')) {
                await processSingle(f);
            }
            }
            if(newIds.length) {
            await updateDoc(doc(db,'artifacts',appId,'users',user.uid,'jobs',job.id), { images: [...(job.images||[]), ...newIds] });
            const urls = await Promise.all(newIds.map(async id => URL.createObjectURL((await idb.get(STORES.MEDIA, id)).blob)));
            setImgs(p => [...p, ...urls]);
            }
        };

        const handleUpload = (e) => processFiles(Array.from(e.target.files));
        const handleDrop = async (e) => { e.preventDefault(); setIsDragging(false); if(e.dataTransfer.files?.length) await processFiles(Array.from(e.dataTransfer.files)); };

        const makeVideo = async () => {
                if(imgs.length===0) return showToast('ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                setGenVid(true);
                try {
                    const cvs = document.createElement('canvas'); cvs.width=640; cvs.height=360;
                    const ctx = cvs.getContext('2d');
                    const stream = cvs.captureStream(30);
                    const rec = new MediaRecorder(stream, { mimeType: 'video/webm' });
                    const chunks = [];
                    rec.ondataavailable = e => chunks.push(e.data);
                    rec.onstop = async () => {
                        const blob = new Blob(chunks, {type:'video/webm'});
                        const vidId = `${job.id}_vid_${Date.now()}`;
                        await idb.put(STORES.MEDIA, { id: vidId, blob });
                        await updateDoc(doc(db,'artifacts',appId,'users',user.uid,'jobs',job.id), { video: vidId });
                        setVidUrl(URL.createObjectURL(blob)); setGenVid(false);
                    };
                    rec.start();
                    const imgsEl = await Promise.all(imgs.map(src => new Promise(r => {const i=new Image(); i.onload=()=>r(i); i.src=src})));
                    const dur = 2000; const fade = 500; const total = imgs.length * dur;
                    let start = null;
                    const anim = (t) => {
                        if(!start) start=t; const el=t-start; if(el> total){rec.stop();return;}
                        const i=Math.floor(el/dur)%imgs.length; const next=(i+1)%imgs.length; const p=el%dur;
                        ctx.fillStyle='#000'; ctx.fillRect(0,0,640,360);
                        const draw=(img,a)=>{ctx.globalAlpha=a; const s=Math.min(640/img.width,360/img.height); ctx.drawImage(img,(640-img.width*s)/2,(360-img.height*s)/2,img.width*s,img.height*s)};
                        draw(imgsEl[i],1); if(p>dur-fade) draw(imgsEl[next],(p-(dur-fade))/fade);
                        requestAnimationFrame(anim);
                    };
                    requestAnimationFrame(anim);
                } catch(e) { setGenVid(false); showToast('ìƒì„± ì‹¤íŒ¨: ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ í™•ì¸í•˜ì„¸ìš”.', 'error'); }
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-50 p-4 animate-fade-in-up">
                    <div className="bg-[#0f172a] w-full max-w-6xl h-[90vh] rounded-3xl flex flex-col border border-white/10 shadow-2xl overflow-hidden relative">
                        <div className="p-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                            <h3 className="font-bold text-2xl text-white flex items-center gap-3"><i className="bi bi-stars text-yellow-400"></i> {job.topic}</h3>
                            <button onClick={onClose} className="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition-colors"><i className="bi bi-x-lg"></i></button>
                        </div>
                        <div className="flex-1 flex overflow-hidden">
                            <div className="flex-1 flex flex-col min-w-0">
                                <div className="px-8 py-4 border-b border-white/5 bg-[#0f172a] flex gap-4 sticky top-0 z-10">
                                    {[
                                        {id:'text', label:'ì›ë¬¸ ë³´ê¸°', icon:'bi-file-text'},
                                        {id:'media', label:`ë¯¸ë””ì–´ (${imgs.length})`, icon:'bi-images'},
                                        {id:'chart', label:'ë°ì´í„° ì‹œê°í™”', icon:'bi-graph-up'},
                                        {id:'cover', label:'ìŠ¤ë§ˆíŠ¸ í‘œì§€', icon:'bi-card-image'}
                                    ].map(t=>(
                                        <button key={t.id} onClick={()=>setTab(t.id)} className={`px-5 py-2.5 rounded-xl text-sm font-medium transition-all flex items-center gap-2 ${tab===t.id?'bg-indigo-600 text-white shadow-lg shadow-indigo-500/25':'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                                            <i className={`bi ${t.icon}`}></i> {t.label}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 scrollbar-hide bg-[#0f172a]">
                                {tab==='cover' && <CoverEditor job={job} user={user} showToast={showToast} appId={appId} />}
                                {tab==='text' && <div className="prose prose-invert max-w-none whitespace-pre-wrap leading-8 text-slate-300 font-light text-lg">{job.result}</div>}
                                {tab==='media' && <div 
                                    className={`space-y-8 rounded-2xl transition-all relative ${isDragging ? 'bg-indigo-500/20 ring-2 ring-indigo-500 ring-offset-2 ring-offset-[#0f172a] p-4 min-h-[400px]' : ''}`}
                                    onDragOver={e => { e.preventDefault(); setIsDragging(true); }}
                                    onDragLeave={() => setIsDragging(false)}
                                    onDrop={handleDrop}
                                >
                                    {isDragging && (
                                    <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm rounded-2xl pointer-events-none">
                                        <i className="bi bi-cloud-arrow-up-fill text-6xl text-indigo-400 mb-4 animate-bounce"></i>
                                        <h3 className="text-2xl font-bold text-white">íŒŒì¼ì„ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”</h3>
                                        <p className="text-slate-300">ì´ë¯¸ì§€ ë˜ëŠ” ZIP íŒŒì¼ ì§€ì›</p>
                                    </div>
                                    )}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                    {imgs.map((s,i)=><div key={i} className="aspect-square bg-slate-900 rounded-2xl overflow-hidden border border-white/10 shadow-lg group relative hover:scale-[1.02] transition-transform duration-300"><img src={s} className="w-full h-full object-cover"/></div>)}
                                            <label className="aspect-square border-2 border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-500/5 transition-all group">
                                                <i className="bi bi-plus-lg text-3xl text-slate-600 group-hover:text-indigo-400 mb-2 transition-colors"></i>
                                                <span className="text-sm text-slate-500 group-hover:text-indigo-300 transition-colors">ì´ë¯¸ì§€ ì¶”ê°€</span>
                                                <input type="file" multiple accept="image/*" className="hidden" onChange={handleUpload}/>
                                            </label>
                                        </div>
                                        <div className="glass-panel p-8 rounded-3xl text-center border border-white/10">
                                            <h4 className="font-bold text-white mb-6 text-xl">ë¹„ë””ì˜¤ ìƒì„± ìŠ¤íŠœë””ì˜¤</h4>
                                            {vidUrl ? (
                                                <div className="max-w-2xl mx-auto">
                                                    <video src={vidUrl} controls className="w-full rounded-2xl shadow-2xl mb-4 border border-white/10"/>
                                                    <a href={vidUrl} download={`video_${job.id}.webm`} className="inline-flex items-center gap-2 px-6 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-white font-medium transition-colors"><i className="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ</a>
                                                </div>
                                            ) : (
                                                <button onClick={makeVideo} className="px-8 py-4 bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 rounded-2xl font-bold text-white shadow-xl hover:shadow-pink-500/25 transition-all transform active:scale-95 flex items-center justify-center gap-3 mx-auto">
                                                    {genVid ? <><span className="animate-spin"><i className="bi bi-arrow-repeat"></i></span> ë Œë”ë§ ì¤‘...</> : <><i className="bi bi-film"></i> ì‡¼ì¸  ì˜ìƒ ë§Œë“¤ê¸°</>}
                                                </button>
                                            )}
                                        </div>
                                    </div>}
                                    {tab==='chart' && (
                                        <div className="glass-panel p-6 rounded-2xl border border-white/10 h-full">
                                            <textarea readOnly className="w-full h-full bg-transparent outline-none font-mono text-sm text-indigo-200 leading-relaxed resize-none" value={job.chartCode||'ìƒì„±ëœ ì°¨íŠ¸ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.'}/>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function SettingsPage({ user, apiKeys, settings, setSettings, showToast }) {
            const [key, setKey] = useState('');
            const add = async () => { if(key.trim()) { await addDoc(collection(db,'artifacts',appId,'users',user.uid,'apikeys'), {key:key.trim(), status:'ready'}); setKey(''); } };
            
            const saveGlobalSettings = async () => {
                try {
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'general'), settings);
                showToast('ì „ì—­ ì„¤ì •ì´ í´ë¼ìš°ë“œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch(e) { showToast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error'); }
            };

            return (
                <div className="max-w-3xl mx-auto space-y-8 animate-fade-in-up">
                <div className="flex items-center justify-between gradient-border-bottom pb-6"><div><h2 className="text-3xl font-bold text-white mb-2">í™˜ê²½ ì„¤ì •</h2><p className="text-slate-400">API í‚¤ ë° ì‹œìŠ¤í…œ ì „ì—­ ë³€ìˆ˜ ê´€ë¦¬</p></div></div>
                <div className="glass-panel p-8 rounded-3xl border border-white/10">
                    <h3 className="font-bold text-xl text-white mb-6 flex items-center gap-2"><i className="bi bi-key-fill text-indigo-400"></i> API í‚¤ ê´€ë¦¬</h3>
                    <div className="flex gap-3 mb-6"><input className="flex-1 bg-black/20 border border-white/10 rounded-xl px-5 py-3 outline-none text-white placeholder-slate-500 focus:border-indigo-500 transition-colors" value={key} onChange={e=>setKey(e.target.value)} placeholder="Gemini API Key ì…ë ¥"/><button onClick={add} className="px-8 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold text-white transition-colors shadow-lg">ì¶”ê°€</button></div>
                    <div className="space-y-3">{apiKeys.map(k=>(<div key={k.id} className="flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/5 hover:border-white/10 transition-colors"><div className="flex items-center gap-3"><div className={`w-2 h-2 rounded-full ${k.status==='ready'?'bg-emerald-500 shadow-[0_0_8px_#10b981]':k.status==='busy'?'bg-red-500':'bg-amber-500'}`}></div><span className="font-mono text-slate-300 text-sm tracking-wide">{k.key.substr(0,8)}... <span className="text-slate-600">â€¢â€¢â€¢â€¢</span></span></div><button onClick={()=>deleteDoc(doc(db,'artifacts',appId,'users',user.uid,'apikeys',k.id))} className="text-slate-500 hover:text-red-400 transition-colors p-2"><i className="bi bi-trash3"></i></button></div>))}</div>
                </div>
                <div className="glass-panel p-8 rounded-3xl border border-white/10">
                    <div className="flex justify-between items-center mb-6">
                    <h3 className="font-bold text-xl text-white flex items-center gap-2"><i className="bi bi-code-square text-indigo-400"></i> ë„í‘œ ìƒì„± í…œí”Œë¦¿</h3>
                    <button onClick={saveGlobalSettings} className="px-4 py-2 bg-indigo-600/30 hover:bg-indigo-600/50 text-indigo-200 rounded-lg text-sm border border-indigo-500/30 transition-colors flex items-center gap-2"><i className="bi bi-cloud-upload"></i> ì„¤ì • ì €ì¥</button>
                    </div>
                    <textarea className="w-full h-48 bg-black/20 border border-white/10 rounded-xl p-5 outline-none font-mono text-sm text-slate-300 focus:border-indigo-500 transition-colors leading-relaxed" value={settings.chartPrompt} onChange={e=>setSettings(p=>({...p,chartPrompt:e.target.value}))}/>
                    <p className="mt-2 text-xs text-slate-500">* ìœ„ í”„ë¡¬í”„íŠ¸ëŠ” <code>SettingsPage</code>ë¥¼ ë²—ì–´ë‚˜ë”ë¼ë„ ìœ ì§€ë˜ì§€ë§Œ, ë¸Œë¼ìš°ì € ì¢…ë£Œ í›„ì—ë„ ìœ ì§€í•˜ë ¤ë©´ [ì„¤ì • ì €ì¥]ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                </div>

                <div className="glass-panel p-8 rounded-3xl border border-white/10">
                    <h3 className="font-bold text-xl text-white mb-6 flex items-center gap-2"><i className="bi bi-card-image text-indigo-400"></i> í‘œì§€ ìƒì„± í”„ë¡¬í”„íŠ¸</h3>
                    <textarea className="w-full h-48 bg-black/20 border border-white/10 rounded-xl p-5 outline-none font-mono text-sm text-slate-300 focus:border-indigo-500 transition-colors leading-relaxed" value={settings.coverPrompt} onChange={e=>setSettings(p=>({...p,coverPrompt:e.target.value}))}/>
                    <div className="mt-2 flex gap-2 text-xs text-slate-500">
                         <span className="bg-white/5 px-2 py-1 rounded">{'{{ê¸€}}'} : ìƒì„±ëœ ë³¸ë¬¸</span>
                         <span className="bg-white/5 px-2 py-1 rounded">{'{{í…Œë§ˆ}}'} : ì„ íƒí•œ í…Œë§ˆ ì´ë¦„</span>
                    </div>
                </div>

                </div>
            );
            }

        function Footer({ queueStatus, apiKeyStatus }) {
            return (
                <footer className="h-14 bg-[#0f172a]/80 backdrop-blur-md border-t border-white/5 flex items-center justify-between px-8 text-xs text-slate-500 font-medium z-20">
                    <div className="flex gap-8">
                        <span className="flex items-center gap-2"><i className="bi bi-activity text-indigo-400"></i> Active Jobs: <span className="text-white">{queueStatus.active}</span></span>
                        <span className="flex items-center gap-2"><i className="bi bi-check2-circle text-emerald-400"></i> Ready Keys: <span className="text-white">{apiKeyStatus.filter(k=>k.status==='ready').length}</span></span>
                    </div>
                    <span className="opacity-40 font-light tracking-wider">AI CONTENT MASTER PRO v2.4</span>
                </footer>
            );
        }

        // --- MAIN APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [toast, setToast] = useState(null);
            const [queueStatus, setQueueStatus] = useState({ active: 0, pending: 0, completed: 0 });
            const [selectedJob, setSelectedJob] = useState(null); 
            const [showBatchModal, setShowBatchModal] = useState(false);
            
            const [jobs, setJobs] = useState([]);
            
            // Shared State for Persistence
            const [modelConfig, setModelConfig] = useState({
                text: 'gemini-2.5-flash-preview-09-2025',
                chart: 'gemini-2.5-flash',
                cover: 'gemini-2.5-flash-lite',
                themeId: 2 // Default changed to 2 (Statute Insight)
            });

            const [apiKeys, setApiKeys] = useState([]);
            const [references, setReferences] = useState([]);
            const [savedPrompts, setSavedPrompts] = useState([]);
            
            const [genState, setGenState] = useState({
                topics: '',
                basePrompt: 'ë‹¤ìŒ ì£¼ì œì— ëŒ€í•´ ì „ë¬¸ì ì´ê³  í¥ë¯¸ë¡œìš´ ë¸”ë¡œê·¸ ê¸€ì„ ì‘ì„±í•´ì¤˜:\nì£¼ì œ: {{ì£¼ì œ}}\n\n[ì°¸ê³  ìë£Œ]\n{{ìë£Œ}}\n\nì¡°ê±´:\n- ë…ìê°€ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…\n- SEOë¥¼ ê³ ë ¤í•œ í‚¤ì›Œë“œ í¬í•¨\n- ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©'
            });
            const [settings, setSettings] = useState({
                chartPrompt: 'ìœ„ í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ Recharts ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ ì‹œê°í™”í•  ìˆ˜ ìˆëŠ” React ì»´í¬ë„ŒíŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ì¤˜. ë°ì´í„°ëŠ” JSON í˜•íƒœë¡œ í¬í•¨ì‹œì¼œì•¼ í•´. ì˜¤ì§ ì½”ë“œë§Œ ì¶œë ¥í•´.\n\n[ê¸°ë°˜ í…ìŠ¤íŠ¸]\n{{ê¸€}}',
                coverPrompt: 'ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ ë¸”ë¡œê·¸ í‘œì§€ ë””ìì¸ì— ë“¤ì–´ê°ˆ ë‚´ìš©ì„ JSON í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•´ì¤˜.\n\n[ë””ìì¸ í…Œë§ˆ]\n{{í…Œë§ˆ}}\n\n[ë³¸ë¬¸ ë‚´ìš©]\n{{ê¸€}}\n\n[í•„ìˆ˜ JSON í˜•ì‹]\n{\n  "title": "í‘œì§€ ì œëª© (í•œê¸€ 15ì ì´ë‚´, 2ì¤„ ê¶Œì¥, ì¤„ë°”ê¿ˆì€ \\n)",\n  "subtitle": "ë¶€ì œ ë˜ëŠ” í•µì‹¬ ìš”ì•½",\n  "category": "ì¹´í…Œê³ ë¦¬ (ì˜ˆ: ìƒí™œë²•ë¥ )",\n  "author": "ì‘ì„±ì (ê¸°ë³¸ê°’: AI Master)",\n  "icon": "bi-bootstrap-icon-name (bi- ì ‘ë‘ì‚¬ ì œì™¸, ì˜ˆ: house-check)"\n}',
                defaultImageId: null
            });

            // Load Environment Config
            useEffect(() => {
                if (!user) return;
                getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'env')).then(snap => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if (data.basePrompt) setGenState(p => ({ ...p, basePrompt: data.basePrompt }));
                        if (data.modelConfig) setModelConfig(p => ({ ...p, ...data.modelConfig }));
                    }
                });
            }, [user]);

            // Auto-save Environment Config (Debounced)
            useEffect(() => {
                if (!user) return;
                const timer = setTimeout(() => {
                    setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'env'), {
                        basePrompt: genState.basePrompt,
                        modelConfig
                    }, { merge: true });
                }, 2000);
                return () => clearTimeout(timer);
            }, [user, genState.basePrompt, modelConfig]);

            // JobManager Refs
            const keyUsageTimestamps = useRef(new Map());
            const activelyProcessingJobs = useRef(new Set());
            const KEY_FAILURE_COOLDOWN_MS = 60000;
            const MAX_FAILURE_COUNT = 5;

            // Auth
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            // Data Listeners
            useEffect(() => {
                if (!user) return;
                const qJobs = query(collection(db, 'artifacts', appId, 'users', user.uid, 'jobs'), orderBy('createdAt', 'desc'));
                const unsubJobs = onSnapshot(qJobs, (snapshot) => {
                    const jobList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setJobs(jobList);
                    setQueueStatus({
                        active: jobList.filter(j => j.status === JOB_STATUS.PROCESSING).length,
                        pending: jobList.filter(j => j.status === JOB_STATUS.PENDING).length,
                        completed: jobList.filter(j => j.status === JOB_STATUS.COMPLETED).length
                    });
                });
                
                const unsubKeys = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'apikeys'), (snap) => {
                    setApiKeys(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                
                const unsubRefs = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'references'), orderBy('createdAt', 'desc')), (snap) => {
                    setReferences(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    });

                    const unsubPrompts = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'prompts'), orderBy('createdAt', 'desc')), (snap) => {
                    setSavedPrompts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    });

                    const unsubSettings = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'general'), (doc) => {
                    if (doc.exists()) {
                        setSettings(prev => ({ ...prev, ...doc.data() }));
                    }
                    });

                    return () => { unsubJobs(); unsubKeys(); unsubRefs(); unsubPrompts(); unsubSettings(); };
                }, [user]);

            const showToast = useCallback((message, type = 'info') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            }, []);

            // --- JobManager Logic ---
            const updateApiKeyStatus = async (keyId, status, extraData = {}) => {
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'apikeys', keyId), { status, lastUsed: Date.now(), ...extraData });
            };

            const recoverKeys = async (keysToRecover) => {
                if(keysToRecover.length === 0) return;
                const uniqueKeys = [...new Map(keysToRecover.map(k => [k.id, k])).values()];
                uniqueKeys.forEach(k => updateApiKeyStatus(k.id, 'ready'));
            };

            const getAvailableKeys = useCallback(() => {
                const now = Date.now();
                const TIME_THRESHOLD = 30000;
                
                const potentiallyReadyKeys = [];
                const keysToRecover = [];

                for (const key of apiKeys) {
                    if (key.status === KEY_STATUS.READY) {
                        if (now - (key.lastUsed || 0) > TIME_THRESHOLD) potentiallyReadyKeys.push(key);
                        continue;
                    }
                    if (key.status === KEY_STATUS.COOLDOWN || key.status === KEY_STATUS.BUSY) {
                        const lastUsed = key.lastUsed || 0;
                        if (lastUsed === 0 || (now - lastUsed > KEY_FAILURE_COOLDOWN_MS)) {
                            keysToRecover.push(key);
                            potentiallyReadyKeys.push({ ...key, status: 'ready' }); 
                        }
                    }
                }
                if (keysToRecover.length > 0) recoverKeys(keysToRecover);

                return potentiallyReadyKeys.filter(key => {
                    const timestamps = keyUsageTimestamps.current.get(key.id) || [];
                    const validTimestamps = timestamps.filter(t => (now - t) < 60000);
                    keyUsageTimestamps.current.set(key.id, validTimestamps);
                    return validTimestamps.length < 2;
                });
            }, [apiKeys]);

            const fetchWithBackoff = async (url, options, retries = 3, delay = 1000) => {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) return response;
                    if (response.status >= 500 && retries > 0) throw new Error(`Server error ${response.status}`);
                    return response;
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw error;
                }
            };

            const callGeminiAPI = async (prompt, apiKey, modelId) => {
                const targetModel = modelId || 'gemini-2.5-flash-preview-09-2025';
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${targetModel}:generateContent?key=${apiKey}`;
                try {
                    const response = await fetchWithBackoff(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (response.status === 429) return { success: false, error: 'Rate Limit Exceeded (429)' };
                    if (!response.ok) {
                        const errText = await response.text();
                        return { success: false, error: `API Error ${response.status}` };
                    }
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) return { success: false, error: 'No content' };
                    return { success: true, text };
                } catch (e) {
                    return { success: false, error: e.message };
                }
            };

            const processBatchCovers = async (modelId) => {
                setShowBatchModal(false);
                const targets = jobs.filter(j => j.status === JOB_STATUS.COMPLETED && !j.coverJson);
                if (targets.length === 0) return showToast('ì²˜ë¦¬í•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                
                showToast(`${targets.length}ê°œì˜ í‘œì§€ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...`, 'info');
                
                for (const job of targets) {
                    const keys = getAvailableKeys();
                    if (keys.length === 0) {
                        showToast('ì‚¬ìš© ê°€ëŠ¥í•œ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.', 'error');
                        await new Promise(r => setTimeout(r, 5000));
                        continue;
                    }
                    const key = keys[0]; // Simple selection strategy
                    
                    try {
                        await updateApiKeyStatus(key.id, 'busy');
                        const themeName = COVER_THEMES.find(t => t.id === (job.modelConfig?.themeId || 2))?.name || 'Statute Insight';
                        const coverPrompt = settings.coverPrompt.replace('{{ê¸€}}', job.result.substring(0, 3000)).replace('{{í…Œë§ˆ}}', themeName);
                        
                        const res = await callGeminiAPI(coverPrompt, key.key, modelId);
                        
                        if (res.success) {
                            const jsonMatch = res.text.match(/\{[\s\S]*\}/);
                            const coverJson = jsonMatch ? jsonMatch[0] : null;
                            if (coverJson) {
                                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'jobs', job.id), { coverJson });
                            }
                        }
                        await updateApiKeyStatus(key.id, 'ready');
                    } catch (e) {
                        console.error(e);
                        await updateApiKeyStatus(key.id, 'cooldown');
                    }
                    await new Promise(r => setTimeout(r, 2000)); // Rate limit buffer
                }
                showToast('ì¼ê´„ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            };

            const executeJob = async (job, key) => {
                const now = Date.now();
                await updateApiKeyStatus(key.id, 'busy');
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'jobs', job.id), { status: JOB_STATUS.PROCESSING, startedAt: now });

                // 1. Text Generation
                const textModel = job.modelConfig?.text || job.model || 'gemini-2.5-flash-preview-09-2025';
                const result = await callGeminiAPI(job.prompt, key.key, textModel);

                if (result.success) {
                    let chartCode = null;
                    let coverJson = null;

                    // 2. Chart Generation
                    if (settings.chartPrompt) {
                        await new Promise(r => setTimeout(r, 1500));
                        const chartModel = job.modelConfig?.chart || textModel;
                        const chartRes = await callGeminiAPI(settings.chartPrompt.replace('{{ê¸€}}', result.text), key.key, chartModel);
                        if (chartRes.success) chartCode = chartRes.text;
                    }

                    // 3. Cover Generation
                    if (settings.coverPrompt) {
                        await new Promise(r => setTimeout(r, 1500));
                        const coverModel = job.modelConfig?.cover || textModel;
                        const themeName = COVER_THEMES.find(t => t.id === (job.modelConfig?.themeId || 1))?.name || 'Standard';
                        const coverPrompt = settings.coverPrompt.replace('{{ê¸€}}', result.text.substring(0, 3000)).replace('{{í…Œë§ˆ}}', themeName);
                        
                        const coverRes = await callGeminiAPI(coverPrompt, key.key, coverModel);
                        if (coverRes.success) {
                             // Clean JSON
                             const jsonMatch = coverRes.text.match(/\{[\s\S]*\}/);
                             coverJson = jsonMatch ? jsonMatch[0] : null;
                        }
                    }

                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'jobs', job.id), {
                        status: JOB_STATUS.COMPLETED,
                        result: result.text,
                        chartCode: chartCode,
                        coverJson: coverJson,
                        completedAt: Date.now()
                    });
                    await updateApiKeyStatus(key.id, 'ready');
                    showToast(`'${job.topic}' ì™„ë£Œ!`, 'success');
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'jobs', job.id), {
                        status: result.error.includes('429') ? JOB_STATUS.PENDING : JOB_STATUS.FAILED,
                        error: result.error
                    });
                    await updateApiKeyStatus(key.id, 'cooldown', { failureCount: (key.failureCount || 0) + 1 });
                }
                activelyProcessingJobs.current.delete(job.id);
            };

            useEffect(() => {
                if (!user) return;
                const interval = setInterval(() => {
                    const pendingJobs = jobs.filter(j => j.status === JOB_STATUS.PENDING);
                    if (pendingJobs.length === 0) return;
                    const availableKeys = getAvailableKeys();
                    if (availableKeys.length === 0) return;

                    const jobsToDispatch = Math.min(pendingJobs.length, availableKeys.length);
                    for (let i = 0; i < jobsToDispatch; i++) {
                        const job = pendingJobs[i];
                        if (activelyProcessingJobs.current.has(job.id)) continue;
                        activelyProcessingJobs.current.add(job.id);
                        executeJob(job, availableKeys[i]);
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, [jobs, apiKeys, user, getAvailableKeys]);

            if (!user) return <AuthScreen onLogin={() => signInWithPopup(auth, new GoogleAuthProvider())} onAnon={() => signInAnonymously(auth)} />;

            return (
                <div className="flex h-screen w-full">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <div className="flex-1 flex flex-col min-w-0 h-full relative z-10">
                        <main className="flex-1 overflow-y-auto p-8 scrollbar-hide">
                            <div className="max-w-7xl mx-auto h-full flex flex-col">
                                {activeTab === 'dashboard' && <Dashboard jobs={jobs} queueStatus={queueStatus} />}
                                {activeTab === 'references' && <ReferenceManager user={user} references={references} showToast={showToast} />}
                                {activeTab === 'generator' && <Generator user={user} apiKeys={apiKeys} references={references} showToast={showToast} genState={genState} setGenState={setGenState} savedPrompts={savedPrompts} modelConfig={modelConfig} setModelConfig={setModelConfig} />}
                                {activeTab === 'jobs' && <JobBoard jobs={jobs} user={user} showToast={showToast} onSelectJob={setSelectedJob} onOpenBatch={()=>setShowBatchModal(true)} />}
                                {activeTab === 'settings' && <SettingsPage user={user} apiKeys={apiKeys} settings={settings} setSettings={setSettings} showToast={showToast} />}
                            </div>
                        </main>
                        <Footer queueStatus={queueStatus} apiKeyStatus={apiKeys} />
                    </div>
                    <BatchCoverModal isOpen={showBatchModal} onClose={()=>setShowBatchModal(false)} onConfirm={processBatchCovers} count={jobs.filter(j => j.status === JOB_STATUS.COMPLETED && !j.coverJson).length} models={AVAILABLE_MODELS} />
                    {selectedJob && <JobModal job={selectedJob} onClose={()=>setSelectedJob(null)} user={user} showToast={showToast} />}
                    {toast && (
                        <div className={`fixed bottom-8 right-8 px-6 py-4 rounded-xl shadow-2xl z-50 animate-fade-in-up flex items-center gap-3 backdrop-blur-xl border ${toast.type === 'error' ? 'bg-red-500/20 border-red-500/50 text-red-200' : 'bg-emerald-500/20 border-emerald-500/50 text-emerald-200'}`}>
                            <i className={`bi ${toast.type === 'error' ? 'bi-x-circle-fill' : 'bi-check-circle-fill'} text-xl`}></i>
                            <span className="font-medium tracking-wide">{toast.message}</span>
                        </div>
                    )}
                </div>
            );
        }

        // --- ROOT RENDER ---
        function Root() {
            // Check if app is initialized (valid config)
            if (!firebaseApp) return <ConfigWizard />;
            return <App />;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
