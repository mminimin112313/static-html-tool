<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 장문 글쓰기 도우미</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .outline-item { cursor: pointer; transition: all 0.2s ease-in-out; }
        .outline-item:hover { background-color: #f1f5f9; }
        .outline-item.active { background-color: #eef2ff; font-weight: 600; border-left: 4px solid #4f46e5; }
        .outline-item.completed .completion-icon { visibility: visible; }

        #sidebar { transition: transform 0.3s ease-in-out; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; font-size: 1.2em; color: #4f46e5;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4f46e5;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p id="loading-message">처리 중...</p>
    </div>

    <div class="relative min-h-screen md:flex">
        <div class="md:hidden flex justify-between items-center p-4 bg-white border-b border-slate-200 sticky top-0 z-20">
            <button id="menu-open-btn" class="text-slate-600 hover:text-slate-900 mr-2"><i class="fas fa-bars fa-lg"></i></button>
            <h1 class="text-lg font-bold text-slate-900 flex-grow text-center">AI 글쓰기 도우미</h1>
        </div>

        <aside id="sidebar" class="bg-white w-80 max-w-[85vw] fixed inset-y-0 left-0 z-40 transform -translate-x-full md:relative md:translate-x-0 md:w-1/3 lg:w-1/4 flex flex-col md:h-screen md:sticky md:top-0 border-r border-slate-200">
            <div class="p-4 flex justify-between items-center border-b border-slate-200 flex-shrink-0">
                <h1 class="text-xl font-bold text-slate-900">프로젝트</h1>
                <div>
                    <button id="project-manage-btn" class="text-slate-500 hover:text-indigo-600 transition-colors duration-200 mr-2" title="프로젝트 관리"><i class="fas fa-folder-open fa-lg"></i></button>
                    <button id="settings-btn" class="text-slate-500 hover:text-indigo-600 transition-colors duration-200 mr-2" title="프롬프트 템플릿 설정"><i class="fas fa-cog fa-lg"></i></button>
                    <button id="menu-close-btn" class="md:hidden text-slate-500 hover:text-slate-800"><i class="fas fa-times fa-lg"></i></button>
                </div>
            </div>
            <div class="p-4 border-b border-slate-200 flex-shrink-0">
                <p class="text-sm text-slate-600">현재 프로젝트: <span id="current-project-display" class="font-semibold text-indigo-700">선택되지 않음</span></p>
            </div>
            
            <div class="flex-grow flex flex-col min-h-0">
                <div class="p-4 flex-shrink-0">
                    <label for="json-input" class="text-sm font-semibold mb-2 block text-slate-700">목차 JSON 붙여넣기:</label>
                    <textarea id="json-input" class="w-full h-32 p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" placeholder='{"title": "책 제목", "children": [{"title": "1장", "level": 1, "children": [...]}]}'></textarea>
                    <button id="render-btn" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-sm">목차 생성/업데이트</button>
                </div>
                <hr class="my-0 border-slate-200 flex-shrink-0">
                <div class="p-4 flex flex-col flex-grow min-h-0">
                    <h2 class="text-lg font-semibold mb-3 text-slate-800 flex-shrink-0">전체 구조</h2>
                    <div id="outline-container" class="pr-2 flex-grow overflow-y-auto">
                        <p class="text-slate-400 text-sm">목차를 생성하면 여기에 표시됩니다.</p>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 flex-shrink-0">
                <button id="export-btn" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-semibold hover:bg-emerald-700 disabled:bg-slate-400" disabled><i class="fas fa-download mr-2"></i> 원고 전체 다운로드 (MD)</button>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-6 lg:p-8">
            <div id="main-content-area" class="h-full">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center text-slate-500">
                    <i class="fas fa-feather-alt text-6xl text-slate-300 mb-4"></i>
                    <h2 class="text-2xl font-bold text-slate-700">창작을 시작하세요</h2>
                    <p class="mt-2">왼쪽 사이드바에서 프로젝트를 선택하거나, 새 프로젝트를 만들고 목차를 생성해주세요.</p>
                </div>
                <div id="chapter-display-container" class="hidden space-y-6">
                    </div>
            </div>
        </main>
    </div>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-3xl flex flex-col transform scale-95">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-slate-900">프롬프트 템플릿 설정</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800"><i class="fas fa-times fa-2x"></i></button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <textarea id="prompt-template-input" class="w-full h-80 p-4 border border-slate-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500"></textarea>
                <div class="mt-4 p-4 bg-slate-100 rounded-lg">
                    <h4 class="font-semibold text-slate-700 mb-2">사용 가능한 변수:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm text-slate-600">
                        <p><code>&lt;&lt;책제목&gt;&gt;</code></p>
                        <p><code>&lt;&lt;파트&gt;&gt;</code></p>
                        <p><code>&lt;&lt;파트설명&gt;&gt;</code></p>
                        <p><code>&lt;&lt;챕터&gt;&gt;</code></p>
                        <p><code>&lt;&lt;챕터설명&gt;&gt;</code></p>
                        <p><code>&lt;&lt;전체목차&gt;&gt;</code></p>
                        <p><code>&lt;&lt;현재파트목차&gt;&gt;</code></p>
                        <p><code>&lt;&lt;참고자료&gt;&gt;</code></p>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t border-slate-200 flex justify-between items-center">
                <button id="reset-template-btn" class="text-sm text-slate-500 hover:text-red-600">기본값으로 초기화</button>
                <div>
                    <span id="template-save-status" class="text-sm mr-4"></span>
                    <button id="save-template-btn" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-indigo-700">저장</button>
                </div>
            </div>
        </div>
    </div>

    <div id="project-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-xl flex flex-col transform scale-95">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-slate-900">프로젝트 관리</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800"><i class="fas fa-times fa-2x"></i></button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3 text-slate-700">새 프로젝트 생성</h4>
                    <div class="flex gap-2">
                        <input type="text" id="new-project-name" class="flex-grow p-3 border border-slate-300 rounded-lg text-base focus:ring-2 focus:ring-indigo-500" placeholder="새 프로젝트 이름">
                        <button id="create-project-btn" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm">생성</button>
                    </div>
                    <p id="new-project-status" class="mt-2 text-sm text-red-500"></p>
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3 text-slate-700">프로젝트 참고자료</h4>
                    <textarea id="project-materials-input" class="w-full h-32 p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" placeholder="이 프로젝트의 모든 글 생성 시 참조될 자료를 입력하세요. (예: 핵심 컨셉, 등장인물, 전문 용어집 등)"></textarea>
                    <button id="save-project-materials-btn" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-sm">참고자료 저장</button>
                    <p id="project-materials-status" class="mt-2 text-sm text-slate-600"></p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-3 text-slate-700">내 프로젝트</h4>
                    <div id="project-list" class="space-y-2"></div>
                </div>
            </div>
            <div class="p-5 border-t border-slate-200 flex justify-end">
                <button class="close-modal-btn bg-slate-200 text-slate-800 px-6 py-2 rounded-lg font-semibold hover:bg-slate-300">닫기</button>
            </div>
        </div>
    </div>

    <div id="writer-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col transform scale-95">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 id="writer-modal-title" class="text-2xl font-bold text-slate-900">글쓰기: </h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-800"><i class="fas fa-times fa-2x"></i></button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto flex flex-col md:flex-row gap-6">
                <div class="md:w-1/2 flex flex-col gap-4">
                    <div class="flex flex-col flex-grow">
                        <h4 class="text-base font-semibold mb-2 text-slate-700 flex items-center"><i class="fas fa-magic-sparkles mr-2 text-indigo-500"></i>AI 생성용 프롬프트</h4>
                        <div class="relative flex-grow">
                             <textarea id="modal-prompt-textarea" readonly class="w-full h-full p-3 border bg-slate-50 border-slate-300 rounded-lg text-sm resize-y"></textarea>
                             <div class="absolute top-3 right-3 flex space-x-2">
                                 <button id="modal-copy-prompt-icon-btn" class="bg-slate-600 text-white p-2 rounded-md text-xs font-semibold hover:bg-slate-700 transition shadow-sm z-10" title="프롬프트 복사"><i class="fas fa-copy"></i></button>
                                 </div>
                        </div>
                        <p id="copy-status-message" class="text-sm mt-1 text-green-600"></p>
                    </div>
                    <div class="flex flex-col flex-grow">
                        <h4 class="text-base font-semibold mb-2 text-slate-700 flex items-center"><i class="fas fa-lightbulb mr-2 text-amber-500"></i>메모 / 아이디어</h4>
                        <textarea id="modal-notes-textarea" class="w-full h-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 resize-y" placeholder="이 챕터에 대한 아이디어나 개요를 자유롭게 작성하세요..."></textarea>
                    </div>
                </div>
                <div class="md:w-1/2 flex flex-col">
                    <h4 class="text-base font-semibold mb-2 text-slate-700 flex items-center"><i class="fas fa-pencil-alt mr-2 text-emerald-500"></i>최종 원고</h4>
                    <textarea id="modal-result-textarea" class="w-full flex-grow p-4 border border-slate-300 rounded-lg text-base focus:ring-2 focus:ring-indigo-500 resize-y" placeholder="AI가 생성한 글을 여기에 붙여넣고 편집하세요..."></textarea>
                </div>
            </div>
            <div class="p-5 border-t border-slate-200 flex justify-end items-center">
                <span id="modal-save-status" class="text-sm mr-4"></span>
                <button id="modal-save-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-sm"><i class="fas fa-save mr-2"></i> 저장하고 닫기</button>
            </div>
        </div>
    </div>
    
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm flex flex-col transform scale-95">
            <div class="p-5"><h3 id="message-modal-title" class="text-xl font-bold text-slate-900">알림</h3></div>
            <div class="p-6 pt-0"><p id="message-modal-content" class="text-slate-700"></p></div>
            <div class="p-5 border-t border-slate-200 flex justify-end">
                <button class="close-modal-btn bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700">확인</button>
            </div>
        </div>
    </div>
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm flex flex-col transform scale-95">
            <div class="p-5"><h3 id="confirmation-modal-title" class="text-xl font-bold text-slate-900">확인</h3></div>
            <div class="p-6 pt-0"><p id="confirmation-modal-content" class="text-slate-700"></p></div>
            <div class="p-5 border-t border-slate-200 flex justify-end gap-3">
                <button id="confirm-cancel-btn" class="bg-slate-200 text-slate-800 px-6 py-2 rounded-lg font-semibold hover:bg-slate-300">취소</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700">확인</button>
            </div>
        </div>
    </div>

    <script>
    // --- 1. IndexedDB Wrapper ---
    const idb = {
        db: null,
        init(dbName, version, stores) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, version);
                request.onerror = (event) => reject(`IndexedDB error: ${event.target.errorCode}`);
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve(this.db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    stores.forEach(storeName => {
                        if (!db.objectStoreNames.contains(storeName)) {
                            db.createObjectStore(storeName, { keyPath: 'id' });
                        }
                    });
                };
            });
        },
        get(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("DB not initialized");
                const transaction = this.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`Get error: ${event.target.errorCode}`);
            });
        },
        getAll(storeName) {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("DB not initialized");
                const transaction = this.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`GetAll error: ${event.target.errorCode}`);
            });
        },
        put(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("DB not initialized");
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`Put error: ${event.target.errorCode}`);
            });
        },
        delete(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("DB not initialized");
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(`Delete error: ${event.target.errorCode}`);
            });
        }
    };

    // --- 2. Application Setup ---
    const DB_CONFIG = {
        NAME: 'AIWriterDB',
        VERSION: 1,
        STORES: ['projects', 'contents', 'settings']
    };
    const APP_ID = 'ai-longform-writer-v1';
    const SETTINGS_KEYS = {
        PROMPT_TEMPLATE: `${APP_ID}-prompt-template`,
        CURRENT_PROJECT: `${APP_ID}-current-project-id`
    };

    const DEFAULT_PROMPT_TEMPLATE = `
# Role: Master Author & Storyteller

## Persona:
You are a world-renowned author, celebrated for your ability to craft compelling narratives, build immersive worlds, and develop profound characters. You have a masterful command of language, structure, and pacing. Your task is to write a single, specific chapter or section of a larger work, based on the provided context.

## Core Task:
Write the content for the specified chapter, "<<챕터>>". Your writing must be engaging, coherent, and perfectly aligned with the overall tone and structure of the book, "<<책제목>>".

## Context Analysis:
1.  **Book Title:** <<책제목>>
2.  **Current Part:** <<파트>> - <<파트설명>>
3.  **Current Chapter:** <<챕터>> - <<챕터설명>>
4.  **Overall Table of Contents (Your location is marked with ▶):**
<<전체목차>>
5.  **Table of Contents for the Current Part:**
<<현재파트목차>>
6.  **Reference Materials (Glossary, Characters, etc.):**
<<참고자료>>

## Instructions & Constraints:
1.  **Focus:** Write ONLY the content for the chapter "<<챕터>>". Do not write introductions, summaries, or content for other chapters.
2.  **Continuity:** Ensure the tone, style, and narrative seamlessly connect with the surrounding chapters as implied by the table of contents.
3.  **Content Generation:** Based on the chapter title and description, generate high-quality, original content. If the chapter is about a technical subject, be accurate. If it's a story, be creative and emotionally resonant.
4.  **Format:** Produce only the raw text for the chapter. Do not include titles, headings, or markdown formatting unless it is part of the narrative itself (e.g., a letter within a story).
5.  **Self-Correction:** Before outputting, review your work. Does it fulfill the specific request for this chapter? Is it consistent with the provided context? Is the quality high enough for a bestselling book? Output only the final, polished chapter text.
`;

    // --- 3. State Management ---
    const appState = {
        currentProjectId: null,
        projects: [],  
        currentProjectData: null,
        promptTemplate: DEFAULT_PROMPT_TEMPLATE,
        activeChapterPath: null,
    };

    // --- 4. DOM Elements ---
    const dom = {
        sidebar: document.getElementById('sidebar'),
        menuOpenBtn: document.getElementById('menu-open-btn'),
        menuCloseBtn: document.getElementById('menu-close-btn'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        loadingOverlay: document.getElementById('loading-overlay'),
        loadingMessage: document.getElementById('loading-message'),
        currentProjectDisplay: document.getElementById('current-project-display'),
        jsonInput: document.getElementById('json-input'),
        renderBtn: document.getElementById('render-btn'),
        outlineContainer: document.getElementById('outline-container'),
        exportBtn: document.getElementById('export-btn'),
        welcomeScreen: document.getElementById('welcome-screen'),
        chapterDisplayContainer: document.getElementById('chapter-display-container'),
        settingsBtn: document.getElementById('settings-btn'),
        settingsModal: document.getElementById('settings-modal'),
        promptTemplateInput: document.getElementById('prompt-template-input'),
        saveTemplateBtn: document.getElementById('save-template-btn'),
        resetTemplateBtn: document.getElementById('reset-template-btn'),
        templateSaveStatus: document.getElementById('template-save-status'),
        projectManageBtn: document.getElementById('project-manage-btn'),
        projectModal: document.getElementById('project-modal'),
        newProjectNameInput: document.getElementById('new-project-name'),
        createProjectBtn: document.getElementById('create-project-btn'),
        newProjectStatus: document.getElementById('new-project-status'),
        projectListContainer: document.getElementById('project-list'),
        projectMaterialsInput: document.getElementById('project-materials-input'),
        saveProjectMaterialsBtn: document.getElementById('save-project-materials-btn'),
        projectMaterialsStatus: document.getElementById('project-materials-status'),
        writerModal: document.getElementById('writer-modal'),
        writerModalTitle: document.getElementById('writer-modal-title'),
        modalPromptTextarea: document.getElementById('modal-prompt-textarea'),
        // modalCopyPromptBtn: document.getElementById('modal-copy-prompt-btn'), // Original button, uncomment if needed
        modalCopyPromptIconBtn: document.getElementById('modal-copy-prompt-icon-btn'), // New icon-only button
        copyStatusMessage: document.getElementById('copy-status-message'),
        modalNotesTextarea: document.getElementById('modal-notes-textarea'),
        modalResultTextarea: document.getElementById('modal-result-textarea'),
        modalSaveBtn: document.getElementById('modal-save-btn'),
        modalSaveStatus: document.getElementById('modal-save-status'),
        messageModal: document.getElementById('message-modal'),
        messageModalTitle: document.getElementById('message-modal-title'),
        messageModalContent: document.getElementById('message-modal-content'),
        confirmationModal: document.getElementById('confirmation-modal'),
        confirmationModalTitle: document.getElementById('confirmation-modal-title'),
        confirmationModalContent: document.getElementById('confirmation-modal-content'),
        confirmOkBtn: document.getElementById('confirm-ok-btn'),
        confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
    };

    // --- 5. UI & Utility Functions ---
    const showLoading = (message = "처리 중...") => {
        dom.loadingMessage.textContent = message;
        dom.loadingOverlay.classList.remove('hidden');
    };
    const hideLoading = () => dom.loadingOverlay.classList.add('hidden');

    const openModal = (modal) => {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }, 10);
    };

    const closeModal = (modal) => {
        modal.classList.add('opacity-0');
        modal.querySelector('.modal-content').classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
    };

    const showMessageModal = (title, message) => {
        dom.messageModalTitle.textContent = title;
        dom.messageModalContent.textContent = message;
        openModal(dom.messageModal);
    };

    const showConfirmationModal = (title, message) => {
        return new Promise(resolve => {
            dom.confirmationModalTitle.textContent = title;
            dom.confirmationModalContent.textContent = message;
            openModal(dom.confirmationModal);
            const cleanup = (result) => {
                closeModal(dom.confirmationModal);
                dom.confirmOkBtn.onclick = null;
                dom.confirmCancelBtn.onclick = null;
                resolve(result);
            };
            dom.confirmOkBtn.onclick = () => cleanup(true);
            dom.confirmCancelBtn.onclick = () => cleanup(false);
        });
    };

    const openSidebar = () => { dom.sidebar.classList.remove('-translate-x-full'); dom.sidebarOverlay.classList.remove('hidden'); };
    const closeSidebar = () => { dom.sidebar.classList.add('-translate-x-full'); dom.sidebarOverlay.classList.add('hidden'); };

    /**
     * Copies text to the clipboard with a fallback mechanism.
     * @param {string} text - The text to copy.
     * @returns {Promise<void>} A promise that resolves on success and rejects on failure.
     */
    const copyToClipboard = (text) => {
        return new Promise((resolve, reject) => {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(resolve)
                    .catch(() => fallbackCopy(text).then(resolve).catch(reject));
            } else {
                fallbackCopy(text).then(resolve).catch(reject);
            }
        });
    };

    /**
     * Fallback method for copying text using document.execCommand.
     * @param {string} text - The text to copy.
     * @returns {Promise<void>}
     */
    const fallbackCopy = (text) => {
        return new Promise((resolve, reject) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    resolve();
                } else {
                    reject(new Error('Fallback: Unable to copy'));
                }
            } catch (err) {
                reject(err);
            }
            document.body.removeChild(textArea);
        });
    };


    // --- 6. Core Application Logic ---

    const getNodeByPath = (path) => {
        if (!appState.currentProjectData || !path) return null;
        let node = { children: appState.currentProjectData.children };
        const parts = path.split('.').map(Number);
        for (const index of parts) {
            if (!node.children?.[index]) return null;
            node = node.children[index];
        }
        return node;
    };

    const renderOutlineRecursive = async (nodes, parentEl, pathPrefix = '') => {
        const ul = document.createElement('ul');
        ul.className = 'space-y-1';
        parentEl.appendChild(ul);

        for (let i = 0; i < nodes.length; i++) {
            const child = nodes[i];
            const path = pathPrefix ? `${pathPrefix}.${i}` : `${i}`;
            const li = document.createElement('li');
            li.className = 'outline-item-wrapper';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'outline-item p-2 rounded-md text-sm flex items-center justify-between';
            contentDiv.dataset.path = path;
            
            const content = await idb.get('contents', `${appState.currentProjectId}_${path}`);
            const isCompleted = content && content.resultText && content.resultText.trim() !== '';

            contentDiv.innerHTML = `
                <div class="flex-grow flex items-center overflow-hidden">
                    <span class="indent-wrapper flex-shrink-0" style="width: ${(child.level || 1) * 1.0}rem;"></span>
                    <span class="font-medium text-slate-700 truncate">${child.title}</span>
                </div>
                <i class="completion-icon fas fa-check-circle text-emerald-500 ml-2 mr-2 invisible flex-shrink-0"></i>
            `;
            if (isCompleted) contentDiv.querySelector('.completion-icon').classList.remove('invisible');

            contentDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.outline-item.active').forEach(el => el.classList.remove('active'));
                contentDiv.classList.add('active');
                openWriterModal(path);
                if (window.innerWidth < 768) closeSidebar();
            });

            li.appendChild(contentDiv);
            ul.appendChild(li);

            if (child.children?.length > 0) {
                await renderOutlineRecursive(child.children, li, path);
            }
        }
    };
    
    const renderOutline = async () => {
        dom.outlineContainer.innerHTML = '';
        if (!appState.currentProjectData || !appState.currentProjectData.children) {
            dom.outlineContainer.innerHTML = '<p class="text-slate-400 text-sm p-2">목차가 비어있습니다.</p>';
            return;
        }
        await renderOutlineRecursive(appState.currentProjectData.children, dom.outlineContainer);
    };

    const renderMainContent = () => {
        dom.welcomeScreen.classList.add('hidden');
        dom.chapterDisplayContainer.classList.remove('hidden');
        dom.chapterDisplayContainer.innerHTML = '';

        if (!appState.currentProjectData || !appState.currentProjectData.children) return;

        const renderNode = (node, parentEl, path) => {
            const div = document.createElement('div');
            const isPart = (node.level === 1);
            
            if (isPart) {
                div.className = 'part-container pt-4';
                div.innerHTML = `<h2 class="text-3xl font-bold text-slate-800 border-b-2 border-indigo-500 pb-3 mb-6">${node.title}</h2>`;
            } else {
                div.className = 'chapter-item bg-white p-5 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center gap-4';
                div.style.marginLeft = `${((node.level || 2) - 2) * 1.5}rem`;
                div.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-slate-800">${node.title}</h3>
                        <p class="text-sm text-slate-500 mt-1">${node.description || '세부 설명이 없습니다.'}</p>
                    </div>
                    <button class="edit-chapter-btn bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-50 border border-indigo-200 transition flex-shrink-0">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                div.querySelector('.edit-chapter-btn').onclick = () => openWriterModal(path);
            }
            parentEl.appendChild(div);

            if (node.children?.length > 0) {
                const container = isPart ? div : document.createElement('div');
                if (!isPart) {
                    container.className = 'mt-4 space-y-4';
                    parentEl.appendChild(container);
                }
                node.children.forEach((child, i) => {
                    renderNode(child, container, `${path}.${i}`);
                });
            }
        };

        appState.currentProjectData.children.forEach((node, i) => {
            renderNode(node, dom.chapterDisplayContainer, `${i}`);
        });
    };

    const openWriterModal = async (path) => {
        appState.activeChapterPath = path;
        const node = getNodeByPath(path);
        if (!node) {
            showMessageModal('오류', '챕터 정보를 찾을 수 없습니다.');
            return;
        }

        const content = await idb.get('contents', `${appState.currentProjectId}_${path}`) || {};

        dom.writerModalTitle.textContent = `글쓰기: ${node.title}`;
        dom.modalPromptTextarea.value = generatePromptForNode(path);
        dom.modalNotesTextarea.value = content.notes || '';
        dom.modalResultTextarea.value = content.resultText || '';
        dom.modalSaveStatus.textContent = '';
        dom.copyStatusMessage.textContent = '';
        
        openModal(dom.writerModal);
    };

    const generatePromptForNode = (path) => {
        const node = getNodeByPath(path);
        if (!node) return "오류: 노드를 찾을 수 없습니다.";

        const pathParts = path.split('.').map(Number);
        const partNode = pathParts.length > 0 ? getNodeByPath(pathParts[0].toString()) : null;
        
        const project = appState.projects.find(p => p.id === appState.currentProjectId);
        const projectMaterials = project ? project.materials : '';

        const generateOutlineText = (data, currentPath, partOnly = false) => {
            let text = '';
            const traverse = (nodes, prefix, level) => {
                (nodes || []).forEach((node, i) => {
                    const nodePath = prefix ? `${prefix}.${i}` : `${i}`;
                    text += `${'  '.repeat(level)}${nodePath === currentPath ? '▶' : '-'} ${node.title}\n`;
                    if (node.children) traverse(node.children, nodePath, level + 1);
                });
            };
            if (partOnly && partNode) {
                 traverse(partNode.children, pathParts[0].toString(), 1);
            } else {
                 traverse(data.children, '', 0);
            }
            return text;
        };

        const replacements = {
            '<<책제목>>': appState.currentProjectData.title,
            '<<파트>>': partNode ? partNode.title : 'N/A',
            '<<파트설명>>': partNode ? partNode.description : '',
            '<<챕터>>': node.title,
            '<<챕터설명>>': node.description,
            '<<전체목차>>': generateOutlineText(appState.currentProjectData, path),
            '<<현재파트목차>>': partNode ? generateOutlineText(appState.currentProjectData, path, true) : '',
            '<<참고자료>>': projectMaterials
        };

        let template = appState.promptTemplate;
        for (const [key, value] of Object.entries(replacements)) {
            const regex = new RegExp(key, 'g');
            template = template.replace(regex, value || '');
        }
        return template;
    };


    const updateChapterCompletionStatus = (path, isCompleted) => {
        const outlineItem = dom.outlineContainer.querySelector(`.outline-item[data-path="${path}"]`);
        if (outlineItem) {
            const icon = outlineItem.querySelector('.completion-icon');
            if (isCompleted) {
                icon.classList.remove('invisible');
            } else {
                icon.classList.add('invisible');
            }
        }
    };
    
    const renderProjectList = () => {
        dom.projectListContainer.innerHTML = '';
        if (appState.projects.length === 0) {
            dom.projectListContainer.innerHTML = '<p class="text-slate-400 text-sm">저장된 프로젝트가 없습니다.</p>';
            return;
        }
        appState.projects.forEach(proj => {
            const item = document.createElement('div');
            item.className = `project-item flex justify-between items-center p-3 rounded-lg cursor-pointer hover:bg-slate-100 ${appState.currentProjectId === proj.id ? 'bg-indigo-100 font-semibold' : 'bg-slate-50'}`;
            item.innerHTML = `
                <span class="flex-grow truncate pr-4">${proj.id}</span>
                <button data-project-id="${proj.id}" class="delete-project-btn text-red-500 hover:text-red-700 px-2 opacity-70 hover:opacity-100 flex-shrink-0"><i class="fas fa-trash-alt"></i></button>
            `;
            item.querySelector('span').onclick = () => switchProject(proj.id);
            item.querySelector('.delete-project-btn').onclick = (e) => {
                e.stopPropagation();
                deleteProject(proj.id);
            };
            dom.projectListContainer.appendChild(item);
        });
    };

    const switchProject = async (projectId) => {
        showLoading("프로젝트 로드 중...");
        try {
            const project = await idb.get('projects', projectId);
            if (project) {
                appState.currentProjectId = projectId;
                appState.currentProjectData = project.data;
                localStorage.setItem(SETTINGS_KEYS.CURRENT_PROJECT, projectId);
                
                dom.jsonInput.value = project.data ? JSON.stringify(project.data, null, 2) : '';
                dom.currentProjectDisplay.textContent = projectId;
                
                await renderOutline();
                renderMainContent();
                dom.exportBtn.disabled = !appState.currentProjectData;
                closeModal(dom.projectModal);
            } else {
                showMessageModal('오류', '프로젝트를 찾을 수 없습니다.');
            }
        } catch (err) {
            console.error("Failed to switch project:", err);
            showMessageModal('오류', '프로젝트 전환에 실패했습니다.');
        } finally {
            hideLoading();
        }
    };
    
    const deleteProject = async (projectId) => {
        const confirmed = await showConfirmationModal('프로젝트 삭제', `'${projectId}' 프로젝트를 정말 삭제하시겠습니까? 관련된 모든 원고 내용이 영구적으로 삭제됩니다.`);
        if (!confirmed) return;

        showLoading("프로젝트 삭제 중...");
        try {
            const allContents = await idb.getAll('contents');
            const contentsToDelete = allContents.filter(c => c.id.startsWith(`${projectId}_`));
            for (const content of contentsToDelete) {
                await idb.delete('contents', content.id);
            }
            
            await idb.delete('projects', projectId);

            appState.projects = appState.projects.filter(p => p.id !== projectId);
            if (appState.currentProjectId === projectId) {
                appState.currentProjectId = null;
                appState.currentProjectData = null;
                localStorage.removeItem(SETTINGS_KEYS.CURRENT_PROJECT);
                
                dom.currentProjectDisplay.textContent = '선택되지 않음';
                dom.jsonInput.value = '';
                dom.outlineContainer.innerHTML = '<p class="text-slate-400 text-sm p-2">목차를 생성하면 여기에 표시됩니다.</p>';
                dom.welcomeScreen.classList.remove('hidden');
                dom.chapterDisplayContainer.classList.add('hidden');
                dom.exportBtn.disabled = true;
            }
            renderProjectList();
            showMessageModal('성공', '프로젝트가 삭제되었습니다.');

        } catch (err) {
            console.error("Failed to delete project:", err);
            showMessageModal('오류', '프로젝트 삭제에 실패했습니다.');
        } finally {
            hideLoading();
        }
    };

    // --- 7. Event Handlers ---
    const setupEventListeners = () => {
        dom.menuOpenBtn.addEventListener('click', openSidebar);
        dom.menuCloseBtn.addEventListener('click', closeSidebar);
        dom.sidebarOverlay.addEventListener('click', closeSidebar);

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                const target = e.target;
                if (target.classList.contains('close-modal-btn') || target.closest('.close-modal-btn') || target.id === modal.id) {
                    closeModal(modal);
                }
            });
        });

        dom.settingsBtn.onclick = async () => {
            const settings = await idb.get('settings', SETTINGS_KEYS.PROMPT_TEMPLATE) || {};
            appState.promptTemplate = settings.value || DEFAULT_PROMPT_TEMPLATE;
            dom.promptTemplateInput.value = appState.promptTemplate;
            dom.templateSaveStatus.textContent = '';
            openModal(dom.settingsModal);
        };
        dom.saveTemplateBtn.onclick = async () => {
            appState.promptTemplate = dom.promptTemplateInput.value;
            await idb.put('settings', { id: SETTINGS_KEYS.PROMPT_TEMPLATE, value: appState.promptTemplate });
            dom.templateSaveStatus.textContent = '✅ 저장되었습니다!';
            setTimeout(() => dom.templateSaveStatus.textContent = '', 2000);
        };
        dom.resetTemplateBtn.onclick = async () => {
            if (await showConfirmationModal('템플릿 초기화', '정말 기본값으로 되돌리시겠습니까?')) {
                appState.promptTemplate = DEFAULT_PROMPT_TEMPLATE;
                dom.promptTemplateInput.value = DEFAULT_PROMPT_TEMPLATE;
                await idb.put('settings', { id: SETTINGS_KEYS.PROMPT_TEMPLATE, value: appState.promptTemplate });
            }
        };

        dom.projectManageBtn.onclick = async () => {
            appState.projects = await idb.getAll('projects');
            renderProjectList();
            const project = appState.projects.find(p => p.id === appState.currentProjectId);
            dom.projectMaterialsInput.value = project ? project.materials || '' : '';
            dom.projectMaterialsStatus.textContent = '';
            openModal(dom.projectModal);
        };
        dom.createProjectBtn.onclick = async () => {
            const newName = dom.newProjectNameInput.value.trim();
            if (!newName) {
                dom.newProjectStatus.textContent = '프로젝트 이름을 입력해주세요.'; return;
            }
            const exists = await idb.get('projects', newName);
            if (exists) {
                dom.newProjectStatus.textContent = '이미 존재하는 프로젝트 이름입니다.'; return;
            }
            const newProject = { id: newName, data: null, materials: '' };
            await idb.put('projects', newProject);
            appState.projects.push(newProject);
            dom.newProjectNameInput.value = '';
            dom.newProjectStatus.textContent = '';
            await switchProject(newName);
            renderProjectList();
        };
        dom.saveProjectMaterialsBtn.onclick = async () => {
            if (!appState.currentProjectId) {
                showMessageModal('오류', '먼저 프로젝트를 선택해주세요.'); return;
            }
            const project = await idb.get('projects', appState.currentProjectId);
            if (project) {
                project.materials = dom.projectMaterialsInput.value;
                await idb.put('projects', project);
                dom.projectMaterialsStatus.textContent = '✅ 참고자료가 저장되었습니다.';
                setTimeout(() => dom.projectMaterialsStatus.textContent = '', 2000);
            }
        };
        
        dom.renderBtn.onclick = async () => {
            if (!appState.currentProjectId) {
                showMessageModal('프로젝트 필요', '먼저 프로젝트를 선택하거나 새로 생성해주세요.'); return;
            }
            try {
                const jsonData = JSON.parse(dom.jsonInput.value);
                if (!jsonData.title || !jsonData.children) {
                    throw new Error("JSON은 'title'과 'children' 속성을 포함해야 합니다.");
                }
                
                const project = await idb.get('projects', appState.currentProjectId);
                project.data = jsonData;
                await idb.put('projects', project);
                appState.currentProjectData = jsonData;

                await renderOutline();
                renderMainContent();
                dom.exportBtn.disabled = false;
                showMessageModal('성공', '목차가 성공적으로 적용되었습니다.');

            } catch (err) {
                console.error("JSON parsing error:", err);
                showMessageModal('JSON 오류', `유효한 JSON 형식이 아닙니다. ${err.message}`);
            }
        };

        // Modified existing copy prompt button click handler to listen for the new icon button
        dom.modalCopyPromptIconBtn.onclick = () => {
            copyToClipboard(dom.modalPromptTextarea.value)
                .then(() => {
                    dom.copyStatusMessage.textContent = '✅ 프롬프트가 복사되었습니다!';
                    setTimeout(() => dom.copyStatusMessage.textContent = '', 2000);
                })
                .catch(err => {
                    console.error('Copy failed:', err);
                    dom.copyStatusMessage.textContent = '❌ 복사에 실패했습니다.';
                });
        };

        dom.modalSaveBtn.onclick = async () => {
            if (!appState.activeChapterPath) return;
            const contentId = `${appState.currentProjectId}_${appState.activeChapterPath}`;
            const existingContent = await idb.get('contents', contentId) || { id: contentId };
            
            existingContent.notes = dom.modalNotesTextarea.value;
            existingContent.resultText = dom.modalResultTextarea.value;

            await idb.put('contents', existingContent);
            
            const isCompleted = existingContent.resultText && existingContent.resultText.trim() !== '';
            updateChapterCompletionStatus(appState.activeChapterPath, isCompleted);
            
            dom.modalSaveStatus.textContent = '✅ 저장 완료!';
            setTimeout(() => {
                dom.modalSaveStatus.textContent = '';
                closeModal(dom.writerModal);
            }, 1000);
        };
        
        dom.exportBtn.onclick = async () => {
            if (!appState.currentProjectData) return;
            showLoading("원고 생성 중...");
            let fullText = `# ${appState.currentProjectData.title}\n\n`;
            
            const processNode = async (nodes, pathPrefix = '') => {
                for (let i = 0; i < nodes.length; i++) {
                    const node = nodes[i];
                    const path = pathPrefix ? `${pathPrefix}.${i}` : `${i}`;
                    const headingLevel = '#'.repeat(node.level + 1);
                    fullText += `${headingLevel} ${node.title}\n\n`;
                    if (node.description) fullText += `> ${node.description}\n\n`;

                    const content = await idb.get('contents', `${appState.currentProjectId}_${path}`);
                    if (content && content.resultText) {
                        fullText += `${content.resultText}\n\n`;
                    }

                    if (node.children) {
                        await processNode(node.children, path);
                    }
                }
            };

            await processNode(appState.currentProjectData.children);
            
            const blob = new Blob([fullText], { type: 'text/markdown;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${appState.currentProjectId}.md`;
            a.click();
            URL.revokeObjectURL(a.href);
            hideLoading();
        };
    };

    // --- 8. Initialization ---
    const initializeApp = async () => {
        showLoading("애플리케이션 초기화 중...");
        try {
            await idb.init(DB_CONFIG.NAME, DB_CONFIG.VERSION, DB_CONFIG.STORES);
            
            const settings = await idb.get('settings', SETTINGS_KEYS.PROMPT_TEMPLATE);
            appState.promptTemplate = settings?.value || DEFAULT_PROMPT_TEMPLATE;
            
            appState.projects = await idb.getAll('projects');
            
            const lastProjectId = localStorage.getItem(SETTINGS_KEYS.CURRENT_PROJECT);
            if (lastProjectId && appState.projects.some(p => p.id === lastProjectId)) {
                await switchProject(lastProjectId);
            } else {
                dom.welcomeScreen.classList.remove('hidden');
                dom.chapterDisplayContainer.classList.add('hidden');
            }
            
            setupEventListeners();
        } catch (err) {
            console.error("Initialization failed:", err);
            showMessageModal('초기화 오류', '애플리케이션을 시작할 수 없습니다. 브라우저가 IndexedDB를 지원하는지 확인해주세요.');
        } finally {
            hideLoading();
        }
    };

    document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
