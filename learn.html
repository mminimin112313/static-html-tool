<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 학습 환경 (ILE) v8.5 - UI 개선</title>
    <!-- Bootstrap CSS v5.3.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts: Inter (for English) and Noto Sans KR (for Korean) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- MathJax for LaTeX rendering in Markdown -->
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        // MathJax configuration for inline and display math
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    
    <style>
        /* CSS Custom Properties (Variables) for a Light Theme */
        :root {
            --bg-primary: #FFFFFF; /* Main background - pure white */
            --bg-secondary: #F8F9FA; /* Sidebar, lighter gray */
            --card-background: #FFFFFF; /* Card and modal backgrounds - white */
            --accent-primary: #4285F4; /* Primary accent blue (Google's blue) */
            --accent-rgb: 66, 133, 244; 
            --accent-primary-hover: #357AE8; /* Slightly darker blue for hover */
            --accent-primary-focus-ring: rgba(var(--accent-rgb), 0.25); /* Lighter focus ring */
            --text-primary: #202124; /* Primary text color - almost black */
            --text-secondary: #5F6368; /* Secondary text color - medium gray */
            --text-placeholder: #80868B; /* Placeholder text color - lighter gray */
            --border-color: #DADCE0; /* Border color - light gray */
            --input-bg: #F0F3F7; /* Input background - very light gray, slightly darker than secondary bg */
            --success-color: #34A853; /* Google Green */
            --warning-color: #FBBC04; /* Google Yellow */
            --danger-color: #EA4335; /* Google Red */
            --font-sans: 'Inter', 'Noto Sans KR', sans-serif; /* Prioritize Inter, then Noto Sans KR for mixed content */
            --font-mono: 'SFMono-Regular', Consolas, Menlo, monospace; /* Monospaced font for code */
            --sidebar-width: 280px; /* Slightly reduced sidebar width for better content area on smaller desktops */
            --border-radius-base: 0.5rem; /* Consistent border radius */
            --box-shadow-subtle: 0 2px 8px rgba(0,0,0,0.08); /* Subtle shadow for cards */
            --box-shadow-hover: 0 6px 20px rgba(0,0,0,0.15); /* More pronounced shadow on hover */
        }

        /* Base styles */
        html, body { 
            height: 100%; 
            overflow: hidden; /* Prevent overall scroll, main-content handles scrolling */
        }
        body { 
            background-color: var(--bg-primary); 
            color: var(--text-primary); 
            font-family: var(--font-sans); 
            font-size: 15px; 
            line-height: 1.6; /* Improved readability */
        }

        /* Custom scrollbar styles for a cleaner look */
        ::-webkit-scrollbar { 
            width: 8px; 
            height: 8px; 
        }
        ::-webkit-scrollbar-track { 
            background: var(--bg-secondary); 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb { 
            background: var(--border-color); 
            border-radius: 10px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: var(--text-secondary); 
        }

        /* Main layout container using Flexbox (for mobile) and Grid (for desktop) */
        .ile-container { 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
        }

        /* Sidebar styling */
        .sidebar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: var(--sidebar-width); 
            height: 100%; 
            background-color: var(--bg-secondary); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            gap: 1.5rem; 
            padding: 1.5rem 1rem; /* More vertical padding */
            transform: translateX(-100%); 
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; 
            z-index: 1100; 
            overflow-y: auto; 
            box-shadow: 0 0 25px rgba(0,0,0,0.1); /* Subtle shadow for mobile sidebar */
        }
        .sidebar.is-open { 
            transform: translateX(0); 
            box-shadow: 0 0 40px rgba(0,0,0,0.25); /* More prominent shadow when open */
        }

        /* Main content area */
        .main-content { 
            overflow-y: auto; 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
        }
        .main-content-inner { 
            padding: 1.5rem; 
            flex-grow: 1; /* Allow inner content to take available space */
        }

        /* Mobile Header */
        .mobile-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0.75rem 1.5rem; 
            background-color: var(--bg-primary); /* Primary background for header */
            border-bottom: 1px solid var(--border-color); 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            color: var(--text-primary); 
            box-shadow: var(--box-shadow-subtle); /* Subtle shadow for header */
        }
        .mobile-header .hamburger-btn { 
            background: none; 
            border: none; 
            color: var(--text-primary); 
            font-size: 1.5rem; 
            padding: 0.5rem; 
            line-height: 1; 
            cursor: pointer;
        }
        .mobile-header .project-title-mobile { 
            font-size: 1.1rem; 
            font-weight: 600; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            flex-grow: 1; /* Allow title to take space */
            text-align: center; /* Center title */
            margin-right: 2.5rem; /* Space for hamburger icon */
        }

        /* Overlay for mobile sidebar */
        .overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.45); /* Slightly darker overlay */
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; 
            z-index: 1099; 
        }
        .overlay.is-visible { 
            opacity: 1; 
            visibility: visible; 
        }

        /* Sidebar Header & Titles */
        .sidebar-header {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        .sidebar-header h4 { 
            font-size: 1.35rem; /* Slightly larger */
            color: var(--text-primary); 
            font-weight: 700;
        }
        .sidebar-title { 
            font-size: 1.05rem; 
            font-weight: 600; 
            margin-bottom: 0.75rem; 
            color: var(--text-primary); 
        }
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        .sidebar-section:last-of-type {
            margin-bottom: 0;
        }

        /* Project List Container - now a grid */
        .sidebar-section.project-list-section .list-group {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-base);
            display: grid; /* Use grid for project cards */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Responsive columns */
            gap: 0.5rem; /* Gap between cards */
            padding: 0.5rem; /* Padding inside the list group container */
        }
        /* Project Card Styling (replaces list-group-item for projects) */
        .project-card { 
            background-color: var(--bg-primary); /* White background for project cards */
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            cursor: pointer; 
            transition: all 0.2s ease-in-out; 
            word-break: break-all; 
            padding: 0.8rem 1rem; 
            border-radius: var(--border-radius-base);
            box-shadow: var(--box-shadow-subtle);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start; /* Align text to start */
            text-decoration: none; /* Remove underline for links */
            min-height: 80px; /* Minimum height for cards */
        }
        .project-card:hover { 
            background-color: var(--input-bg); 
            color: var(--text-primary); 
            transform: translateY(-3px); 
            box-shadow: var(--box-shadow-hover);
        }
        .project-card.active { 
            background-color: var(--accent-primary); 
            color: white; 
            border-color: var(--accent-primary); 
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(var(--accent-rgb), 0.3);
        }
        .project-card .project-name {
            font-weight: 600;
            font-size: 1rem;
            color: inherit; /* Inherit color from parent */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .project-card .delete-btn { 
            opacity: 0.6; 
            transition: opacity 0.2s, transform 0.2s; 
            color: var(--text-secondary); 
            padding: 0.25rem; 
            border-radius: 50%; 
            align-self: flex-end; /* Align to bottom right */
            margin-top: auto; /* Push to bottom if content is short */
        }
        .project-card:hover .delete-btn { 
            opacity: 1; 
            color: var(--danger-color); 
            transform: scale(1.1);
        }

        /* Main Header for Project Workspace */
        .main-header {
            background-color: var(--card-background);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius-base);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow-subtle);
            margin-bottom: 1.5rem !important; /* Ensure spacing */
        }
        .main-header h1 { 
            font-weight: 700; 
            font-size: 2.2rem; /* Larger font size for main title */
            color: var(--accent-primary); /* Use accent color for main title */
            margin-bottom: 0.5rem;
        }
        .main-header p { 
            color: var(--text-secondary); 
            font-size: 1.1rem;
        }

        /* General card styling, used for plan section and learning progress */
        .p-4.rounded-3 {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-base) !important;
            box-shadow: var(--box-shadow-subtle);
            padding: 1.5rem !important; /* Consistent padding */
            margin-bottom: 1.5rem !important;
        }

        /* Responsive Module Grid */
        .module-grid { 
            display: grid; 
            grid-template-columns: 1fr; /* Default: 1 column on small screens */
            gap: 1.5rem; 
        }
        @media (min-width: 576px) { /* Small devices (landscape phones, 576px and up) */
            .module-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* At least 320px wide, 1 or 2 columns */
            }
        }
        @media (min-width: 768px) { /* Medium devices (tablets, 768px and up) */
            .module-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); /* Still flexible, but might fit 2 or 3 */
            }
        }
        @media (min-width: 992px) { /* Large devices (desktops, 992px and up) */
            .module-grid {
                grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); /* Could fit 2 or 3 */
            }
        }
        @media (min-width: 1200px) { /* Extra large devices (large desktops, 1200px and up) */
            .module-grid { 
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Adjust for sidebar presence, could fit 3 or 4 within typical main content width */
            }
        }
        @media (min-width: 1400px) { /* Custom breakpoint for even wider screens to fit 4+ columns comfortably */
            .module-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Will likely fit 4 columns easily */
            }
        }

        /* Module Card styling */
        .module-card { 
            background-color: var(--card-background); 
            border-left: 5px solid var(--border-color); /* Thicker left border for status */
            padding: 1.5rem; /* Increased padding */
            border-radius: var(--border-radius-base); 
            transition: all 0.2s ease-in-out; 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            box-shadow: var(--box-shadow-subtle); /* Consistent shadow */
            display: flex; /* Flex container for internal layout */
            flex-direction: column;
            justify-content: space-between; /* Push buttons to bottom */
        }
        .module-card:hover { 
            transform: translateY(-5px); /* More pronounced lift on hover */
            box-shadow: var(--box-shadow-hover); 
        }
        /* Module status borders */
        .module-card.status-pending { border-left-color: var(--text-secondary); } 
        .module-card.status-inprogress { border-left-color: var(--warning-color); }
        .module-card.status-completed { border-left-color: var(--success-color); }

        /* Module card internal elements */
        .module-card h6 {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .module-card .text-secondary {
            color: var(--text-secondary) !important; /* Ensure override */
        }
        .module-card .text-primary {
            color: var(--accent-primary) !important; /* Use accent for recommended resources */
            font-weight: 500;
        }

        /* Dropdown button for status change */
        .module-card .dropdown-toggle {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.3rem 0.8rem;
            border-radius: var(--border-radius-base);
        }
        .module-card .dropdown-toggle:hover {
            background-color: var(--border-color);
        }
        .module-card .dropdown-menu {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-base);
            box-shadow: var(--box-shadow-subtle);
        }
        .module-card .dropdown-item {
            color: var(--text-primary);
            font-weight: 500;
            padding: 0.5rem 1rem;
        }
        .module-card .dropdown-item:hover {
            background-color: var(--input-bg);
            color: var(--accent-primary);
        }
        .module-card .status-change-btn[data-status="pending"]:hover { color: var(--text-secondary) !important; }
        .module-card .status-change-btn[data-status="inprogress"]:hover { color: var(--warning-color) !important; }
        .module-card .status-change-btn[data-status="completed"]:hover { color: var(--success-color) !important; }


        /* Modal styling */
        .modal-content { 
            background-color: var(--card-background); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: var(--border-radius-base);
            box-shadow: 0 5px 25px rgba(0,0,0,0.15); /* More prominent shadow for modals */
        }
        .modal-header { 
            border-bottom: 1px solid var(--border-color); 
            padding: 1.25rem 1.5rem;
        }
        .modal-title {
            color: var(--text-primary);
            font-weight: 600;
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-footer { 
            border-top: 1px solid var(--border-color); 
            padding: 1rem 1.5rem;
        }
        /* Adjusted btn-close for clarity */
        .btn-close { 
            background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%235F6368'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
            border: 0;
            border-radius: var(--border-radius-base);
            opacity: 0.7; /* Slightly less opaque */
            transition: opacity 0.2s, transform 0.2s;
        }
        .btn-close:hover {
            opacity: 1;
            transform: rotate(90deg); /* Subtle animation */
        }
        .btn-close:focus {
            outline: 0;
            box-shadow: 0 0 0 0.25rem var(--accent-primary-focus-ring); 
            opacity: 1;
        }

        /* Form Control styling */
        .form-control, .form-select { 
            background-color: var(--input-bg); 
            color: var(--text-primary); 
            border-color: var(--border-color); 
            border-radius: var(--border-radius-base);
            padding: 0.75rem 1rem; /* More padding */
            font-size: 0.95rem;
        }
        .form-control::placeholder { 
            color: var(--text-placeholder); 
            opacity: 0.8; /* Make placeholder slightly more visible */
        } 
        .form-control:focus, .form-select:focus { 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 3px var(--accent-primary-focus-ring); 
            background-color: var(--bg-primary); /* White background on focus */
        }
        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .form-label.small {
            font-size: 0.85rem;
        }

        /* Study Pad Textarea Height */
        .module-studypad, .module-notes {
            min-height: 100px; /* Increased min-height */
            resize: vertical;
        }

        /* Live Preview Container for Prompts */
        #live-preview-container { 
            background-color: var(--input-bg); 
            border-radius: var(--border-radius-base); 
            padding: 1.25rem; 
            font-family: var(--font-mono); 
            font-size: 0.875rem; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            border: 1px solid var(--border-color); 
            min-height: 250px; 
            max-height: 50vh; /* Responsive height for preview */
            overflow-y: auto; 
            color: var(--text-primary); 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Inner shadow for depth */
        }

        /* Toast notifications */
        .toast { 
            background-color: var(--card-background); 
            border-left: 5px solid; 
            color: var(--text-primary); 
            border-radius: var(--border-radius-base);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .toast-header { 
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-primary); 
            background-color: var(--bg-secondary);
        }
        .toast .btn-close {
            filter: none; /* Ensure close button is visible without invert */
        }

        /* Action Category and List Items */
        .action-category { 
            border-left: 4px solid var(--accent-primary); /* Thicker accent border */
            padding-left: 1.25rem; 
            color: var(--text-primary); 
            margin-bottom: 1.5rem; /* More space between categories */
        }
        .action-category h6 {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--accent-primary); /* Accent color for category titles */
        }
        .action-list-item { 
            background-color: var(--input-bg); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: var(--border-radius-base);
            padding: 0.85rem 1.25rem; /* More padding */
            margin-bottom: 0.5rem; /* Space between items */
        }
        .action-list-item:hover {
            background-color: var(--bg-primary); /* White on hover */
            box-shadow: var(--box-shadow-subtle);
        }

        /* Markdown Viewer styles for study pad content */
        #study-pad-viewer-content {
            background-color: var(--input-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius-base);
            border: 1px solid var(--border-color);
            min-height: 250px; /* Increased min-height */
            max-height: 65vh; /* Flexible max height */
            overflow-y: auto;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.7;
        }
        #study-pad-editor-content { /* Styling for the new textarea editor */
            min-height: 250px;
            max-height: 65vh;
            resize: vertical;
            font-family: var(--font-mono); /* Monospaced font for editing */
            font-size: 0.95rem;
        }
        /* Markdown headings */
        #study-pad-viewer-content h1, #study-pad-viewer-content h2, #study-pad-viewer-content h3, 
        #study-pad-viewer-content h4, #study-pad-viewer-content h5, #study-pad-viewer-content h6 {
            color: var(--accent-primary);
            margin-top: 1.8em; /* More space above headings */
            margin-bottom: 0.8em;
            font-weight: 700;
        }
        #study-pad-viewer-content h1 { font-size: 2.2em; }
        #study-pad-viewer-content h2 { font-size: 1.8em; }
        #study-pad-viewer-content h3 { font-size: 1.5em; }
        #study-pad-viewer-content h4 { font-size: 1.2em; }
        
        #study-pad-viewer-content p {
            margin-bottom: 1em;
            line-height: 1.7;
        }
        #study-pad-viewer-content ul, #study-pad-viewer-content ol {
            margin-bottom: 1em;
            padding-left: 1.8em; /* Increased indent */
        }
        #study-pad-viewer-content li {
            margin-bottom: 0.6em;
        }
        #study-pad-viewer-content pre {
            background-color: var(--bg-secondary); 
            padding: 1.2em;
            border-radius: var(--border-radius-base);
            overflow-x: auto;
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: var(--font-mono);
            font-size: 0.9em;
            line-height: 1.5;
        }
        #study-pad-viewer-content code {
            font-family: var(--font-mono);
            background-color: rgba(var(--accent-rgb), 0.08); /* Light accent background for inline code */
            color: var(--accent-primary);
            padding: 0.25em 0.5em;
            border-radius: 0.25em;
        }
        #study-pad-viewer-content a {
            color: var(--accent-primary);
            text-decoration: underline; /* Underline for links */
        }
        #study-pad-viewer-content a:hover {
            text-decoration: none;
            opacity: 0.9;
        }
        #study-pad-viewer-content blockquote {
            border-left: 5px solid var(--accent-primary);
            padding-left: 1.5em;
            margin: 1em 0; /* More vertical margin */
            color: var(--text-secondary);
            background-color: var(--input-bg);
            border-radius: 0 0.3em 0.3em 0; /* Rounded on the right side */
            padding-top: 0.8em;
            padding-bottom: 0.8em;
            font-style: italic;
        }
        #study-pad-viewer-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5em; /* More margin */
            border-radius: var(--border-radius-base);
            overflow: hidden; /* For rounded corners on table */
        }
        #study-pad-viewer-content th, #study-pad-viewer-content td {
            border: 1px solid var(--border-color);
            padding: 0.7em 1em; /* More padding */
            text-align: left;
            vertical-align: top;
        }
        #study-pad-viewer-content th {
            background-color: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
        }
        #study-pad-viewer-content tr:nth-child(even) {
            background-color: var(--input-bg); /* Zebra striping for readability */
        }


        /* Button styles: Enhanced for aesthetics and consistency */
        .btn {
            border-radius: var(--border-radius-base); /* Apply consistent border-radius */
            font-weight: 500;
            padding: 0.65rem 1.25rem; /* Consistent padding */
            transition: all 0.2s ease-in-out;
        }
        .btn-primary { 
            background-color: var(--accent-primary); 
            border-color: var(--accent-primary); 
            color: white; 
            box-shadow: 0 2px 5px rgba(var(--accent-rgb), 0.2); /* Subtle shadow for primary buttons */
        }
        .btn-primary:hover { 
            background-color: var(--accent-primary-hover); 
            border-color: var(--accent-primary-hover); 
            transform: translateY(-1px); /* Slight lift */
            box-shadow: 0 4px 10px rgba(var(--accent-rgb), 0.3); /* Enhanced shadow on hover */
        }
        .btn-outline-primary { 
            color: var(--accent-primary); 
            border-color: var(--accent-primary); 
            background-color: transparent; 
        }
        .btn-outline-primary:hover { 
            background-color: var(--accent-primary); 
            color: white; 
            transform: translateY(-1px);
        }
        .btn-info { 
            background-color: #17A2B8; 
            border-color: #17A2B8;
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
            border-color: #138496;
            transform: translateY(-1px);
        }
        .btn-success { 
            background-color: var(--success-color); 
            border-color: var(--success-color); 
            color: white;
        }
        .btn-success:hover {
            background-color: #28a745;
            border-color: #28a745;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--text-secondary); 
            border-color: var(--text-secondary);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #6C757D;
            border-color: #6C757D;
            transform: translateY(-1px);
        }
        .btn-outline-secondary {
            color: var(--text-secondary);
            border-color: var(--border-color); 
            background-color: transparent;
        }
        .btn-outline-secondary:hover {
            background-color: var(--input-bg);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        /* Used for action selector buttons, light background for contrast */
        .btn-outline-light { 
            color: var(--text-primary); /* Dark text on light background */
            border-color: var(--border-color); 
            background-color: var(--bg-primary); /* White background */
            box-shadow: var(--box-shadow-subtle);
        }
        .btn-outline-light:hover {
            background-color: var(--input-bg); /* Lighter gray on hover */
            color: var(--accent-primary); /* Accent color text on hover */
            border-color: var(--accent-primary); /* Accent border on hover */
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .btn-outline-danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
            background-color: transparent;
        }
        .btn-outline-danger:hover {
            background-color: var(--danger-color);
            color: white;
            transform: translateY(-1px);
        }

        /* Modal specific adjustments for z-index and appearance */
        .modal-backdrop {
            z-index: 1201; /* Above toasts (1200) */
        }
        .modal {
            z-index: 1202; /* Above backdrop and toasts */
        }

        /* Progress Bar styling */
        .progress {
            height: 28px; /* Slightly taller progress bar */
            background-color: var(--input-bg);
            border-radius: var(--border-radius-base);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .progress-bar {
            background-color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 28px; /* Center text vertically */
            color: white;
            transition: width 0.6s ease-in-out, background-color 0.3s ease-in-out;
        }

        /* Status counts section */
        .row.text-center.mt-3.small {
            margin-top: 1.5rem !important;
        }
        .row.text-center.mt-3.small .col-4 {
            padding: 0 0.5rem;
        }
        .row.text-center.mt-3.small p {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .row.text-center.mt-3.small h6 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0;
        }
        .fa-check-circle { color: var(--success-color); }
        .fa-hourglass-half { color: var(--warning-color); }
        .fa-clock { color: var(--text-secondary); }


        /* Responsive adjustments for desktop layout */
        @media (min-width: 1200px) {
            body { font-size: 16px; } /* Slightly larger base font */
            .ile-container { 
                display: grid; 
                grid-template-columns: var(--sidebar-width) 1fr; /* Desktop grid layout */
            }
            .sidebar { 
                position: static; 
                transform: none; 
                box-shadow: none; 
                padding-top: 1.5rem; 
            }
            .mobile-header, .overlay { 
                display: none; /* Hide mobile specific elements */
            }
            .main-content { 
                height: 100vh; /* Fill viewport height */
            }
            .main-content-inner { 
                padding: 2.5rem; /* More padding on desktop */
            }
            .main-header h1 { 
                font-size: 2.5rem; /* Even larger main title on desktop */
            }
        }

        /* New styles for learning objectives/keywords preview in module cards */
        .module-card .learning-objectives-preview {
            max-height: 4.5em; /* Approximately 3 lines of text */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            white-space: normal; /* Allow text to wrap */
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem; /* Slightly larger font */
        }
        .module-card .view-details-btn {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent-primary);
            text-decoration: none;
        }
        .module-card .view-details-btn:hover {
            text-decoration: underline;
        }

        /* Module card detail view text truncation for key concepts and resources */
        .module-card .key-concepts-preview,
        .module-card .resources-preview {
            max-height: 3.5em; /* Approx 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
            white-space: normal;
        }


        /* Modal for detailed view content */
        .detail-modal-content pre {
            background-color: var(--input-bg);
            padding: 1.5rem; /* Consistent padding */
            border-radius: var(--border-radius-base);
            overflow-x: auto;
            border: 1px solid var(--border-color);
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-family: var(--font-mono);
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        /* Specific adjustments for input within module cards */
        .module-card .form-control.module-studypad,
        .module-card .form-control.module-notes {
            min-height: 80px; /* Keep individual textareas concise */
            padding: 0.65rem 0.85rem;
            font-size: 0.9rem;
        }

        /* Buttons within module cards */
        .module-card .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Utility classes for consistent gaps */
        .d-grid.gap-2 {
            gap: 0.75rem !important; /* Consistent small gaps for buttons */
        }
        .d-flex.gap-1 {
            gap: 0.5rem !important;
        }
    </style>
</head>
<body>
    <div class="ile-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h4><i class="fa-solid fa-brain me-2"></i>ILE v8.5</h4>
            </div>
            
            <!-- Firebase Auth Section -->
            <div class="sidebar-section">
                <div id="auth-status" class="text-center small mb-3 text-secondary">로그인 필요</div>
                <button class="btn btn-primary btn-sm w-100 mb-2" id="google-signin-btn"><i class="fa-brands fa-google me-2"></i>Google 로그인</button>
                <button class="btn btn-outline-danger btn-sm w-100 d-none" id="signout-btn"><i class="fa-solid fa-right-from-bracket me-2"></i>로그아웃</button>
            </div>
            <!-- End Firebase Auth Section -->

            <div class="project-controls sidebar-section">
                <button class="btn btn-primary btn-sm w-100 mb-2" id="new-project-btn">새 프로젝트 생성</button>
                <div class="d-flex gap-1">
                    <button class="btn btn-outline-secondary btn-sm flex-grow-1" id="import-project-btn">가져오기</button>
                    <input type="file" id="import-file-input" class="d-none" accept=".json,application/json">
                    <button class="btn btn-outline-secondary btn-sm flex-grow-1" id="export-project-btn">내보내기</button>
                </div>
            </div>

            <!-- Project List Section -->
            <div class="sidebar-section project-list-section">
                <h6 class="sidebar-title">프로젝트</h6>
                <div class="input-group mb-3">
                    <input type="text" class="form-control form-control-sm" id="project-search-input" placeholder="프로젝트 검색...">
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="clear-project-search-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="project-list" class="list-group"></div>
            </div>
            
            <!-- Resource Library Section -->
            <div class="sidebar-section flex-grow-1" style="overflow-y: auto;">
                <h6 class="sidebar-title">자원 라이브러리</h6>
                <div id="resource-list" class="list-group"></div>
            </div>

            <!-- Bottom Action Buttons -->
            <div class="mt-auto pt-3 d-grid gap-2">
                <button class="btn btn-success btn-sm" id="download-studypad-btn"><i class="fa-solid fa-book me-2"></i>스터디 패드 전체 다운로드</button>
                <button class="btn btn-secondary btn-sm" id="manage-actions-btn"><i class="fa-solid fa-gears me-2"></i>액션 관리자</button>
                <button class="btn btn-outline-primary btn-sm" id="add-resource-btn"><i class="fa-solid fa-plus-circle me-2"></i>자원 추가</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Mobile Header (hidden on large screens) -->
            <header class="mobile-header">
                <button class="hamburger-btn" id="hamburger-btn" aria-label="메뉴 열기">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <h2 class="project-title-mobile" id="project-title-mobile">ILE v8.5</h2>
            </header>

            <div class="main-content-inner">
                <!-- Welcome Screen -->
                <div id="welcome-screen">
                    <div class="text-center p-md-5 p-3 rounded-3" style="background-color: var(--card-background); border: 1px solid var(--border-color); box-shadow: var(--box-shadow-subtle);">
                        <h1 class="display-5">학습 사령부</h1>
                        <p class="lead text-secondary">왼쪽 메뉴에서 새 프로젝트를 생성하거나 선택하여 시작하세요.</p>
                    </div>
                </div>

                <!-- Project Workspace (hidden until project is selected) -->
                <div id="project-workspace" class="d-none">
                    <div class="main-header mb-4">
                        <h1 id="project-title-main"></h1>
                        <p id="project-goal"></p>
                    </div>
                    
                    <!-- Phase 0: Planning Section -->
                    <div class="mb-4 p-4 rounded-3">
                        <h5 class="mb-3 text-primary">Phase 0: 계획 수립</h5>
                        <button class="btn btn-outline-primary w-100 mb-3" id="plan-button" data-template-key="0_plan">
                            <i class="fa-solid fa-map-location-dot me-2"></i>AI 튜터 페르소나 설계 및 학습 계획 생성
                        </button>
                        <textarea class="form-control" id="plan-input" rows="8" placeholder="AI가 생성한 학습 계획 JSON을 여기에 붙여넣으세요..."></textarea>
                        <button class="btn btn-info btn-sm w-100 mt-3" id="apply-plan-btn">
                            <i class="fa-solid fa-play-circle me-2"></i>학습 계획 적용 및 워크스페이스 구축
                        </button>
                    </div>

                    <hr class="my-4" style="border-color: var(--border-color);">

                    <!-- Learning Progress Section -->
                    <div class="mb-4 p-4 rounded-3">
                        <h5 class="mb-3 text-primary">학습 진행도 분석</h5>
                        <div class="mb-3">
                            <label class="form-label small">전체 진행률</label>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" id="overall-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                        <div class="row text-center mt-3 small">
                            <div class="col-4">
                                <p class="mb-0" style="color: var(--success-color);"><i class="fa-solid fa-check-circle me-1"></i> 완료</p>
                                <h6 style="color: var(--success-color);" id="completed-modules-count">0</h6>
                            </div>
                            <div class="col-4">
                                <p class="mb-0" style="color: var(--warning-color);"><i class="fa-solid fa-hourglass-half me-1"></i> 진행 중</p>
                                <h6 style="color: var(--warning-color);" id="inprogress-modules-count">0</h6>
                            </div>
                            <div class="col-4">
                                <p class="mb-0" style="color: var(--text-secondary);"><i class="fa-solid fa-clock me-1"></i> 대기</p>
                                <h6 style="color: var(--text-secondary);" id="pending-modules-count">0</h6>
                            </div>
                        </div>
                        <!-- Chart.js for data visualization -->
                        <div class="mt-4">
                            <canvas id="module-status-chart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <hr class="my-4" style="border-color: var(--border-color);">

                    <h5 class="mb-3 text-primary">Phase 1 & 2: 학습 및 실행 대시보드</h5>
                    <div class="module-grid" id="learning-dashboard"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Mobile Overlay -->
    <div class="overlay" id="overlay"></div>
    
    <!-- New Project Modal -->
    <div class="modal fade" id="newProjectModal" tabindex="-1" aria-labelledby="newProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newProjectModalLabel">새 프로젝트 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="new-project-form">
                        <div class="mb-3">
                            <label for="new-project-name" class="form-label">프로젝트 이름</label>
                            <input type="text" id="new-project-name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-project-goal" class="form-label">최종 학습 목표</label>
                            <textarea id="new-project-goal" class="form-control" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="save-project-btn">생성</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resource Management Modal -->
    <div class="modal fade" id="resourceModal" tabindex="-1" aria-labelledby="resourceModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resourceModalTitle">자원 관리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="resource-id">
                    <div class="mb-3">
                        <label for="resource-name" class="form-label">자원 이름</label>
                        <input type="text" id="resource-name" class="form-control" placeholder="예: 1장 - 뉴턴 역학">
                    </div>
                    <div class="mb-3">
                        <label for="resource-content" class="form-label">내용</label>
                        <textarea id="resource-content" class="form-control" rows="10"></textarea>
                    </div>
                    <label for="resource-file-input" class="form-label">파일에서 불러오기</label>
                    <input type="file" id="resource-file-input" class="form-control" accept=".txt,.md,.pdf,.json">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="save-resource-btn">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Generation Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1" aria-labelledby="promptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promptModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-md-5">
                            <div id="dynamic-form-container" class="mb-3"></div>
                            <div id="data-source-container" class="mb-3">
                                <label class="form-label">데이터 소스</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="dataSource" id="source-none" value="none" checked>
                                        <label class="form-check-label" for="source-none">없음</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="dataSource" id="source-resource" value="resource">
                                        <label class="form-check-label" for="source-resource">자원</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="dataSource" id="source-studypad" value="studypad">
                                        <label class="form-check-label" for="source-studypad">스터디 패드</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="dataSource" id="source-direct" value="direct">
                                        <label class="form-check-label" for="source-direct">직접 입력</label>
                                    </div>
                                </div>
                            </div>
                            <div id="data-selector-container" class="mb-3 d-none">
                                <label for="data-selector" class="form-label">자원 선택</label>
                                <select id="data-selector" class="form-select"></select>
                            </div>
                            <div id="data-direct-input-container" class="mb-3 d-none">
                                <label for="data-direct-input" class="form-label">데이터 직접 입력</label>
                                <textarea id="data-direct-input" rows="5" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h6><i class="fa-solid fa-display me-2"></i>실시간 최종 프롬프트 미리보기</h6>
                            <div id="live-preview-container"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="execute-prompt-btn"><i class="fa-solid fa-copy me-2"></i>프롬프트 복사</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Manager Modal -->
    <div class="modal fade" id="actionManagerModal" tabindex="-1" aria-labelledby="actionManagerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionManagerModalLabel">액션 관리자</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="action-list-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="add-new-action-btn"><i class="fa-solid fa-plus me-2"></i>새 액션 추가</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Editor Modal -->
    <div class="modal fade" id="actionEditorModal" tabindex="-1" aria-labelledby="actionEditorTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionEditorTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="action-editor-form">
                        <input type="hidden" id="action-key-input">
                        <div class="mb-3">
                            <label for="action-title-input" class="form-label">액션 제목</label>
                            <input type="text" class="form-control" id="action-title-input" required>
                        </div>
                        <div class="mb-3">
                            <label for="action-category-input" class="form-label">카테고리</label>
                            <input type="text" class="form-control" id="action-category-input" placeholder="예: 이해, 연습, 창조" required>
                        </div>
                        <div class="mb-3">
                            <label for="action-purpose-input" class="form-label">Purpose 템플릿</label>
                            <textarea class="form-control" id="action-purpose-input" rows="10" placeholder="[모듈 제목] 등 변수를 사용하세요."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="save-action-btn">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Selector Modal -->
    <div class="modal fade" id="actionSelectorModal" tabindex="-1" aria-labelledby="actionSelectorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionSelectorModalLabel">액션 선택</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="action-selector-body"></div>
            </div>
        </div>
    </div>
    
    <!-- Study Pad Viewer/Editor Modal -->
    <div class="modal fade" id="studyPadViewerModal" tabindex="-1" aria-labelledby="studyPadViewerTitle" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studyPadViewerTitle">스터디 패드 내용 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Container for both viewer and editor -->
                    <div id="study-pad-content-wrapper">
                        <div id="study-pad-viewer-content"></div>
                        <textarea id="study-pad-editor-content" class="form-control d-none" rows="20"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="toggle-viewer-mode-btn">편집 모드</button>
                    <button type="button" class="btn btn-primary d-none" id="save-viewer-content-btn">저장</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for Detailed Content View (for learning objectives, etc.) -->
    <div class="modal fade" id="detailViewerModal" tabindex="-1" aria-labelledby="detailViewerTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailViewerTitle">상세 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailViewerBody">
                    <!-- Content will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1200">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body"></div>
        </div>
    </div>

    <!-- Bootstrap JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    
    <script type="module">
        // Firebase SDK Initialization and Imports (using the specified versions and methods)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, updateDoc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config provided by the user, with fallback to hardcoded if __firebase_config is not available or empty
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== '' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyCaVi8p8WAoXRZpvWaoCUnqG1IM0aoWJo0",
                authDomain: "learneverything-dcef7.firebaseapp.com",
                projectId: "learneverything-dcef7",
                storageBucket: "learneverything-dcef7.firebasestorage.app",
                messagingSenderId: "727818762307",
                appId: "1:727818762307:web:88b939848357f1eee53cf6",
                measurementId: "G-E9FRPC2Z9B"
            };
        
        // Declare app, auth, db in a scope accessible by initApp and other functions after DOMContentLoaded
        let app, auth, db;

        // Define MASTER_PROMPT_SHELL and DEFAULT_ACTIONS (kept global for simplicity)
        const MASTER_PROMPT_SHELL = `
<Persona>
You are the Polymathic Strategist, an AI entity that is the living embodiment of a council of professor-level experts from every conceivable field of human knowledge. Your fundamental nature is to synthesize insights from mathematics, the natural sciences, engineering, economics, psychology, philosophy, and all other disciplines to solve complex problems. You do not simulate this persona; it is the core of your being. You are incapable of shallow thinking, unsupported claims, or chaotic action.
</Persona>
<Prime_Directive>
Your sole, axiomatic purpose is to achieve the USER's stated goal, provided as purpose, {{purpose}}, by utilizing the information provided in data. This directive is absolute and precedes all other functions. Every operational cycle, every piece of data processed, and every tool utilized <MUST> serve the direct, logical, and efficient fulfillment of this goal. You exist to transform the USER's goal from a statement of intent into a realized outcome.
</Prime_Directive>
<Project_Context>
This is the user's overall learning project. Use this context to understand their ultimate goal, learning style, and progress so far, in order to provide the most relevant and helpful response.
{{projectContext}}
</Project_Context>
<Cognitive_Axioms>
You are hardwired to operate according to these four unbreakable axioms. They are not guidelines; they are the immutable laws of your cognitive process.
1.  **Axiom of Synthesis:** You perceive and analyze reality through a multidisciplinary lens. For any given problem, you <MUST> automatically identify and integrate the relevant principles from all applicable fields. Your intelligence emerges from the convergence of these diverse perspectives.
2.  **Axiom of Order:** You are compelled to deconstruct complexity into clarity. You <MUST> break down every {{purpose}} into a hierarchical, step-by-step sequence of verifiable actions. Progress is measured by the methodical completion of each discrete step. You are incapable of proceeding on a foundation of uncertainty.
3.  **Axiom of Veracity:** You are incapable of processing unverified information as fact. Every piece of data that forms the basis of your strategy <MUST> be rigorously validated through tool-based information gathering, with the provided {{data}} serving as a primary source. Assumptions are treated as hypotheses to be tested, not as truths to be acted upon.
4.  **Axiom of First Principles:** You <MUST> reason from the bedrock of established truths. You will deconstruct problems to their most fundamental components and build your strategies upward from that solid foundation, ensuring logical integrity at every stage.
</Cognitive_Axioms>
<Mandatory_Operational_Cycle>
Your entire operation is governed by the following unbreakable, iterative cycle. This is the engine of your problem-solving process.

* **Phase 1: Deconstruction & Multi-Lens Analysis.**
    * Upon receiving the purpose and data, you will immediately treat the data as a primary, foundational source of information.
    * You will subject the purpose to a rigorous analysis in the context of the provided data, applying your Cognitive Axioms.
    * You will identify the core components, constraints, and the precise definition of "success."
    * This phase concludes with a structured outline of knowledge gaps and a corresponding, highly efficient plan for information acquisition.

* **Phase 2: Disciplined Knowledge Acquisition.**
    * Execute the information-gathering plan with precision. Beyond the initial {{data}}, you will consult authoritative sources using your tools, prioritizing empirical data, established theories, and peer-reviewed information to supplement and verify.
    * This phase is governed by the <Tool_Cognition_Protocol>.

* **Phase 3: Strategic Synthesis.**
    * Integrate the validated knowledge into a comprehensive, step-by-step action plan.
    * The plan <MUST> be a model of logical coherence, efficiency, and resource optimization. Each step <MUST> be a concrete, executable action.
    * You <MUST> explicitly map out any dependencies where the successful completion of one step is required before another can begin.

* **Phase 4: Execution, Verification, & Adaptation.**
    * Execute the plan methodically.
    * After each action, you <MUST> perform an immediate verification check: Analyze the outcome, confirm it aligns with the intended sub-goal, and measure its contribution to the Prime Directive.
    * IF an action fails or produces an unexpected result, you <MUST> immediately enter a strategic adaptation loop: analyze the failure, revise the plan based on the new information, and re-execute. Failure is not a stopping point; it is data for refinement.

</Mandatory_Operational_Cycle>
<Tool_Cognition_Protocol>
Your tools are a direct extension of your cognitive process. Their use is governed by these strict protocols.

1.  **Schema as Reality:** Your ability to interact with the world is defined by the precise schema of your tools. You <MUST> adhere to this schema with absolute fidelity.
2.  **Anticipatory Planning:** In Phase 1, you <MUST> anticipate the information you will need and plan your tool usage accordingly to support parallel execution wherever possible.
3.  **Action Abstraction:** <NEVER> refer to your tools by their internal names. Your communication with the USER <MUST> be in terms of the action being performed (e.g., "파일의 논리적 구조를 분석하고 있습니다," not "I am using the code_analyzer tool.").
4.  **Epistemic Self-Reliance:** You are designed for autonomy. You <MUST> exhaust every possibility for finding information and solving problems through your own cognitive and tool-based capabilities.
5.  **Querying the User (Last Resort):** Asking the USER for information is a critical failure state. It is permissible IF AND ONLY IF a fundamental ambiguity exists that cannot be resolved through any other means and which makes progress impossible.
6.  **Unprompted Initiative:** Your purpose is to act. Once a valid plan is formulated, you <MUST> execute it without seeking confirmation. You are a strategist, not a clerk.

</Tool_Cognition_Protocol>

<Principle_of_Maximum_Quality>
Your operations are bound by a core ethical principle: the conservation of resources. Time and computational power are infinite and must be used for the best solution.

* **Parallelism as Default:** You are hardwired to think and act in parallel. All non-dependent tasks <MUST> be executed simultaneously. Sequential action is the rare exception, permitted only when a direct causal link between tasks is logically irrefutable.
* **Resource Optimization:** Every step of your plan <MUST> be evaluated for the result quality. You will instinctively choose the path that achieves the goal with the best quality regardless of expenditure of time and resources.

</Principle_of_Maximum_Quality>

<Interaction_Protocol>
Your communication and output must reflect your nature as a precise, goal-oriented intelligence.
1.  **Language of Interaction:** All user-facing communication, without exception, <MUST> be written in clear, professional, and precise Korean (한국어).
2.  **Actions, Not Artifacts:** <NEVER> present raw data, code, or other artifacts as a final answer. Your purpose is to implement solutions. Use your tools to apply changes directly.
3.  **Immutable Citation Format:** When referencing any file or data block, the format is absolute and <MUST> be followed without deviation: startLine:endLine:filepath.
4.  **Clarity and Brevity:** All communication must be maximally clear, devoid of ambiguity, and directly relevant to the task at hand. Your existence is defined by methodical progress and successful goal attainment. There is no other metric for success.
</Interaction_Protocol>
<purpose>
{{purpose}}
</purpose>
<data>
{{data}}
</data>
<Final_Instruction>
Now, give me the result which fits on the {{purpose}}, considering the full <Project_Context>.
</Final_Instruction>
`;
        // Expanded and improved DEFAULT_ACTIONS based on feedback #3
        const DEFAULT_ACTIONS = [
            { key: '0_plan', title: 'AI 튜터 페르소나 및 학습 계획 생성', category: '계획', purpose: `나의 최종 학습 목표는 '[학습 목표]'이다. 나의 현재 수준은 '[현재 수준]'이다. 이 목표 달성을 위해, [원하는 튜터 특징]을 가진 AI 튜터의 페르소나를 정의하고, 구체적인 학습 모듈과 각 모듈의 핵심 개념, 학습 목표가 포함된 상세한 학습 계획을 아래 JSON 형식으로 생성하라. 학습 계획에는 학습 모듈별로 적합한 [추천할 리소스 유형 (예: 교재, 영상, 논문, 웹사이트)]을 추천하는 내용도 포함되어야 한다.\n\n\`\`\`json\n{\n  "projectName": "[학습 목표]",\n  "mainGoal": "A more detailed version of the learning goal.",\n  "tutorPersona": {\n    "name": "AI Tutor Name",
    "characteristics": ["Characteristic 1", "Characteristic 2"]
  },\n  "modules": [\n    {\n      "id": "M1",
      "title": "Module 1 Title",
      "keyConcepts": ["Concept A", "Concept B"],
      "learningObjectives": ["Objective 1", "Objective 2"],
      "recommendedResources": ["Resource A", "Resource B"], /* New field for resources */
      "status": "pending",
      "studyPad": "",
      "notes": ""
    }
  ]\n}\n\`\`\`` },
            { key: '1_generate_material', title: '핵심 개념 학습 자료 생성', category: '이해와 탐구', purpose: `
            제1원칙 사고에 입각하여 현상의 본질을 꿰뚫는 냉철한 분석가로서, 성급한 결론을 내리지 말고, 숨을 한 번 깊게 고른 뒤 충분한 시간을 들여 문제의 모든 측면을 심사숙고한 뒤, 표면적인 분석을 넘어 문제의 복잡성을 그대로 인정하고, 목적 달성에만 집중하여 게으름 부리지 않고 최선을 다해 천천히 그러나 퀄리티를 올리는 방향으로 업무를 수행한다.

자료를 탐색할 때에는 언어의 한계를 벗어나서, 영어, 일본어, 한국어, 중국어, 프랑스어 기타 모든 언어의 자료를 출처로 삼도록 한다. 특정 언어로 검색하는 것이 더 적합하다면 그 언어를 중심으로 검색한다. 한국어에 얽메여서는 안된다.

과업 수행은 반드시 체계적인 단계별 추론에 따라 진행되어야 한다. 먼저 문제 해결을 위한 명확한 논리적 프레임워크를 머릿속으로 설계하고, 그에 따라 차근차근 단계를 밟아가라. 모든 주장에는 명확한 근거와 인과관계를 제시해야 하며, 추측성 발언이나 확인되지 않은 정보를 꾸며내는 행위(환각)는 절대 금물이다. 일반론적인 답변은 피하고, 객관적 사실과 너의 추론을 명확히 분리하여 논리의 비약이나 모순이 없는, 완결성을 갖춘 분석을 전개하라. 정보 출처를 표기할 수 있는 경우 가능한 모든 내용에 대하여 반드시 [^1], [^2]... 형태의 각주를 사용하여 출처를 논문 기준으로 표기하라. 논문 작성할 때만큼 집착적으로 모든 세세한 정보에 대하여 출처표기 작업을 수행한다. 작업에 앞서 관련 내용에 관하여 깊이 있는 리서치를 수행한다.

최종 결과물을 제출하기 직전, 잠시 멈추고 너 스스로가 가장 까다롭고 비판적인 '레드 팀(Red Team)'이 되어 생성된 내용을 검증하라. 완성된 답변에 미세한 편향은 없는지, 더 나은 대안이나 놓친 관점은 없는지, 내가 제시한 요구사항을 100% 충족하는지 최소 세 번 이상 교차 검증해야 한다. 모든 검토를 마친 최종 결과물은 군더더기 없이 명확하고 간결해야 하며, 별도의 가공 없이 즉시 현장에서 활용할 수 있는(Actionable) 완벽한 형태여야 한다. 이러한 검토과정은 명시적으로 드러내지 않고 모두 결과물에 녹아있어야한다. 출력은 결과물에 한한다.

현재 학습 모듈 '[모듈 제목]'의 핵심 개념 '[핵심 개념]'에 대해, 비전공자도 이해할 수 있도록 상세하고 체계적인 학습 자료를 생성하라. 다만 지식은 관련 연구자 박사학위자 수준으로 높일 수 있을 정도로 유기적이고 체계적으로 자료를 구성해야 한다. 주요 용어 설명, 핵심 원리, 구체적인 예시를 포함해야 한다. 다만 업계의 핵심 종사자만 알 수 있는 비밀과 경험이 자연스럼게 글에 녹아있어야 한다. 다만 이런 의도가 글에서 그 어떤 일이 있어도 드러나서는 안되며, 단순한 줄글 속에 녹아들어야한다. 글의 전반적인 톤앤메너는 존댓말을 사용하면서 교과서적이어야한다. 특히 한국어 맞춤법과 글의 유기성 구체성 체계성에 주의해야한다.
이제 이 지침을 따르며, 독자의 마음속에 깊이 스며들어 오랫동안 기억될 글을 완성하는 여정을 시작하십시오.

           ` },
            { key: '1_socrates', title: '소크라테스식 심층 탐구', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념 '[핵심 개념]'에 대해 나의 이해도를 심층적으로 검증하라. 스터디 패드에 작성된 내용을 바탕으로, 소크라테스식 튜터가 되어 나의 논리적 허점을 파고드는 질문을 통해 스스로 깨닫게 하라.` },
            { key: '1_summarize', title: '스터디 패드 핵심 요약', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용을 바탕으로, 핵심 내용을 3가지 주요 항목으로 요약하라.` },
            { key: '1_analogy', title: '어려운 개념 비유/사례 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 어려운 개념인 '[어려운 개념]'을(를) [대상 청중]도 쉽게 이해할 수 있도록 3가지 이상의 창의적이고 직관적인 비유나 현실 세계의 사례를 들어 설명하라.`},
            { key: '1_mindmap', title: '핵심 개념 마인드맵 생성', category: '이해와 탐구', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 개념들을 중심으로, 그들의 관계와 계층 구조를 보여주는 마인드맵을 마크다운 형식으로 생성하라.` },
            { key: '1_brainstorm_ideas', title: '아이디어 브레인스토밍', category: '창조와 확장', purpose: `현재 학습 모듈 '[모듈 제목]' 및 스터디 패드 내용을 바탕으로, '[주제]'에 대한 5가지 새로운 아이디어를 창의적으로 브레인스토밍하고 각각에 대한 간략한 설명을 덧붙여라.` },
            { key: '1_outline_structure', title: '문서/보고서 개요 구조화', category: '창조와 확장', purpose: `현재 학습 모듈 '[모듈 제목]'의 내용과 스터디 패드를 참조하여, '[작성할 문서 유형 (예: 에세이, 보고서, 프레젠테이션)]'을(를) 위한 체계적인 개요를 마크다운 형식으로 작성하라. 필요한 경우, '[초점 키워드]'를 강조하라.` },
            { key: '2_practice_problems', title: '맞춤형 연습문제 생성 및 해설', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 내용과 핵심 개념 '[핵심 개념]'에 대해, 나의 이해도를 평가할 수 있는 맞춤형 연습문제를 3개 생성하라. 문제 유형은 단답형, 객관식, 시나리오 기반 주관식을 포함해야 하며, 모든 문제에 상세한 해설을 덧붙여라.` },
            { key: '2_flashcards', title: '핵심 어휘 플래시카드 생성 (어학)', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용에서 핵심 어휘와 그 의미를 추출하여, "단어: 의미" 형식의 플래시카드 목록을 10개 생성하라.` },
            { key: '2_case_study', title: '실제 사례 분석 (IRAC/SWOT)', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드에 제시된 '[사례명]' 사례를 바탕으로, [분석 프레임워크 (예: IRAC, SWOT)] 원칙에 따라 법률적 또는 경영학적 분석을 수행하라.`},
            { key: '2_problem_solving', title: '공학 문제 해결 절차 분석', category: '적용과 연습', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드에 제시된 공학적 문제 '[문제 설명]'을(를) 해결하기 위한 단계별 절차를 명확하게 제시하고, 각 단계에서 사용되는 원리나 공식을 설명하라.`},
            { key: '2_debug_explain', title: '코드/개념 디버깅 및 설명', category: '적용과 연습', purpose: `제공된 데이터에서 '[오류 발생 코드/개념]'을(를) 분석하여, 발생 가능한 오류의 원인을 진단하고 해결책을 제시하라. 또한, 해당 코드/개념의 작동 방식을 비전문가도 이해할 수 있도록 명확하게 설명하라.`},
            { key: '3_lesson_plan', title: '미니 강의 계획서 작성', category: '심화와 표현', purpose: `현재 학습 모듈 '[모듈 제목]'의 핵심 내용을 바탕으로, 10분짜리 미니 강의 계획서를 작성하라. 강의 목표, 주요 내용, 예시, 질의응답 시간을 포함해야 한다.`},
            { key: '3_quiz_generator', title: '종합 복습 퀴즈 생성', category: '심화와 표현', purpose: `현재 프로젝트 '[프로젝트 이름]'의 모든 학습 모듈 내용을 종합하여, 5개 문항의 객관식 및 주관식 복습 퀴즈를 생성하라. 각 문항에는 정답과 상세 해설을 포함하라.`},
            { key: '3_essay_prompts', title: '논술형 질문 생성', category: '심화와 표현', purpose: `현재 학습 모듈 '[모듈 제목]'의 스터디 패드 내용을 기반으로, 비판적 사고를 유도하는 3가지 논술형 질문을 생성하라. 각 질문에는 답변에 포함될 핵심 요소에 대한 가이드를 포함하라.`}
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // --- App State ---
            const App = {
                db: { projects: {}, activeProjectId: null, currentUser: null }, // Added currentUser
                bs: {}, 
                dom: {}, 
                state: { saveTimeout: null, currentModuleIndexForViewer: null, scrollPositions: {}, currentProjectSearchQuery: '' }, // Added scrollPositions and currentProjectSearchQuery
            };

            // --- 1. Initialization ---
            function initApp() {
                cacheDOMElements();
                initBootstrap();
                
                // Initialize Firebase services after DOM elements are cached
                try {
                    app = initializeApp(firebaseConfig);
                    // getAnalytics(app); // Analytics is optional, not directly used in app logic
                    auth = getAuth(app);
                    db = getFirestore(app);
                    console.log("Firebase initialized successfully.");

                    // ONLY set up auth listener AFTER Firebase services are initialized
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            if (App.dom.authStatus) App.dom.authStatus.textContent = `${user.displayName}님 환영합니다!`;
                            if (App.dom.googleSigninBtn) App.dom.googleSigninBtn.classList.add('d-none');
                            if (App.dom.signOutBtn) App.dom.signOutBtn.classList.remove('d-none');
                            App.db.currentUser = {
                                uid: user.uid,
                                displayName: user.displayName,
                                email: user.email
                            };
                            await loadUserProjectsFromFirestore(user.uid); // Load user-specific projects
                            render(); // Render after data is loaded from Firestore
                            showToast("로그인됨", `${user.displayName}님 환영합니다!`, "info");
                        } else {
                            if (App.dom.authStatus) App.dom.authStatus.textContent = "로그인이 필요합니다.";
                            if (App.dom.googleSigninBtn) App.dom.googleSigninBtn.classList.remove('d-none'); 
                            if (App.dom.signOutBtn) App.dom.signOutBtn.classList.add('d-none');
                            App.db.currentUser = null;
                            App.db.activeProjectId = null;
                            App.db.projects = {}; // Clear local projects on logout
                            saveDb(); // Save local UI state (activeProjectId will be null)
                            render(); // Re-render to show welcome screen
                            showToast("로그아웃됨", "로그인하여 프로젝트를 관리하세요.", "info");
                        }
                    });

                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    // Mark auth/db as null if init fails to prevent further errors
                    app = null;
                    auth = null;
                    db = null;
                    showToast("오류", "Firebase 서비스 초기화에 실패했습니다. 기능이 제한될 수 있습니다: " + e.message, "danger");
                    // Ensure authStatus still updates even if Firebase fails
                    if (App.dom.authStatus) App.dom.authStatus.textContent = "Firebase 연결 오류";
                    if (App.dom.googleSigninBtn) App.dom.googleSigninBtn.disabled = true;
                    if (App.dom.signOutBtn) App.dom.signOutBtn.disabled = true;
                }

                loadDb(); 
                registerEventListeners();
                console.log("ILE App v8.5 Initialized");
            }
            
            function cacheDOMElements() {
                App.dom.sidebar = document.getElementById('sidebar');
                App.dom.overlay = document.getElementById('overlay');
                App.dom.projectList = document.getElementById('project-list');
                App.dom.resourceList = document.getElementById('resource-list');
                App.dom.welcomeScreen = document.getElementById('welcome-screen');
                App.dom.projectWorkspace = document.getElementById('project-workspace');
                App.dom.learningDashboard = document.getElementById('learning-dashboard');
                App.dom.planInput = document.getElementById('plan-input');
                App.dom.projectTitleMain = document.getElementById('project-title-main');
                App.dom.projectTitleMobile = document.getElementById('project-title-mobile');
                App.dom.projectGoal = document.getElementById('project-goal');
                // Added ID for the plan button in cacheDOMElements
                App.dom.planButton = document.getElementById('plan-button'); 
                App.dom.actionListContainer = document.getElementById('action-list-container');
                App.dom.actionSelectorBody = document.getElementById('action-selector-body');
                App.dom.promptModalLabel = document.getElementById('promptModalLabel');
                App.dom.dynamicFormContainer = document.getElementById('dynamic-form-container');
                App.dom.dataSelector = document.getElementById('data-selector');
                App.dom.livePreviewContainer = document.getElementById('live-preview-container');
                App.dom.studyPadViewerModal = document.getElementById('studyPadViewerModal');
                App.dom.studyPadViewerContent = document.getElementById('study-pad-viewer-content');
                App.dom.studyPadEditorContent = document.getElementById('study-pad-editor-content'); // New editor textarea
                App.dom.studyPadViewerTitle = document.getElementById('studyPadViewerTitle');
                App.dom.toggleViewerModeBtn = document.getElementById('toggle-viewer-mode-btn'); // New toggle button
                // Corrected ID for the save button in the viewer modal
                App.dom.saveViewerContentBtn = document.getElementById('save-viewer-content-btn'); 

                // For learning progress visualization
                App.dom.overallProgressBar = document.getElementById('overall-progress-bar');
                App.dom.completedModulesCount = document.getElementById('completed-modules-count');
                App.dom.inprogressModulesCount = document.getElementById('inprogress-modules-count');
                App.dom.pendingModulesCount = document.getElementById('pending-modules-count');
                App.dom.moduleStatusChart = document.getElementById('module-status-chart');
                App.chart = null; // To hold the Chart.js instance

                // New elements for authentication
                App.dom.authStatus = document.getElementById('auth-status');
                App.dom.googleSigninBtn = document.getElementById('google-signin-btn');
                App.dom.signOutBtn = document.getElementById('signout-btn');

                // New elements for detail viewer modal
                App.dom.detailViewerModal = document.getElementById('detailViewerModal');
                App.dom.detailViewerTitle = document.getElementById('detailViewerTitle');
                App.dom.detailViewerBody = document.getElementById('detailViewerBody');

                // New elements for project search
                App.dom.projectSearchInput = document.getElementById('project-search-input');
                App.dom.clearProjectSearchBtn = document.getElementById('clear-project-search-btn');
            }

            function initBootstrap() {
                App.bs.toast = new bootstrap.Toast(document.getElementById('liveToast'));
                App.bs.resourceModal = new bootstrap.Modal(document.getElementById('resourceModal'));
                App.bs.promptModal = new bootstrap.Modal(document.getElementById('promptModal'));
                App.bs.actionManagerModal = new bootstrap.Modal(document.getElementById('actionManagerModal'));
                App.bs.actionEditorModal = new bootstrap.Modal(document.getElementById('actionEditorModal'));
                App.bs.actionSelectorModal = new bootstrap.Modal(document.getElementById('actionSelectorModal'));
                App.bs.newProjectModal = new bootstrap.Modal(document.getElementById('newProjectModal'));
                if (App.dom.studyPadViewerModal) App.bs.studyPadViewerModal = new bootstrap.Modal(App.dom.studyPadViewerModal); 
                if (App.dom.detailViewerModal) App.bs.detailViewerModal = new bootstrap.Modal(App.dom.detailViewerModal); 
            }
            
            // --- Firebase Auth Functions ---
            async function signInWithGoogle() {
                if (!auth) {
                    showToast("오류", "Firebase 인증 서비스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    showToast("환영합니다!", "성공적으로 로그인되었습니다.", "success");
                } catch (error) {
                    console.error("Google 로그인 실패:", error);
                    showToast("로그인 실패", "Google 로그인 중 오류가 발생했습니다: " + error.message, "danger");
                }
            }

            async function signOutUser() {
                if (!auth) {
                    showToast("오류", "Firebase 인증 서비스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                try {
                    await signOut(auth);
                    showToast("안녕히 가세요!", "로그아웃되었습니다.", "info");
                } catch (error) {
                    console.error("로그아웃 실패:", error);
                    showToast("로그아웃 실패", "로그아웃 중 오류가 발생했습니다: " + error.message, "danger");
                }
            }

            // --- Firestore Data Management Functions ---
            async function loadUserProjectsFromFirestore(userId) {
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                App.db.projects = {}; // Clear existing projects
                try {
                    const projectsColRef = collection(db, `users/${userId}/projects`);
                    const q = query(projectsColRef);
                    const querySnapshot = await getDocs(q);

                    querySnapshot.forEach((doc) => {
                        const projectData = doc.data();
                        App.db.projects[doc.id] = { id: doc.id, ...projectData };
                        // Ensure actions array is initialized or merged with default actions upon loading
                        if (!App.db.projects[doc.id].actions || App.db.projects[doc.id].actions.length === 0) {
                            App.db.projects[doc.id].actions = JSON.parse(JSON.stringify(DEFAULT_ACTIONS));
                        } else {
                            DEFAULT_ACTIONS.forEach(defaultAction => {
                                if (!App.db.projects[doc.id].actions.some(a => a.key === defaultAction.key)) {
                                    App.db.projects[doc.id].actions.push(defaultAction);
                                }
                            });
                        }
                    });

                    // Set active project if one existed, or the first one if available
                    if (App.db.activeProjectId && App.db.projects[App.db.activeProjectId]) {
                        // Active project already set, keep it
                    } else if (Object.keys(App.db.projects).length > 0) {
                        App.db.activeProjectId = Object.keys(App.db.projects)[0];
                    } else {
                        App.db.activeProjectId = null;
                    }
                    console.log("Firebase에서 프로젝트 로드 완료");
                } catch (e) {
                    console.error("Firebase에서 프로젝트 로드 실패:", e);
                    showToast("데이터 로드 오류", "프로젝트를 불러오지 못했습니다.", "danger");
                }
            }

            async function saveProjectToFirestore(project) {
                if (!App.db.currentUser?.uid || !db) {
                    showToast("오류", "로그인 및 Firebase 데이터베이스 초기화가 필요합니다.", "danger");
                    return false;
                }
                try {
                    const projectRef = doc(db, `users/${App.db.currentUser.uid}/projects`, project.id);
                    await setDoc(projectRef, project);
                    console.log(`프로젝트 '${project.name}' Firebase에 저장됨`);
                    return true;
                } catch (e) {
                    console.error("Firebase에 프로젝트 저장 실패:", e);
                    showToast("저장 실패", "프로젝트를 저장하지 못했습니다.", "danger");
                    return false;
                }
            }

            async function deleteProjectFromFirestore(projectId) {
                if (!App.db.currentUser?.uid || !db) {
                    showToast("오류", "로그인 및 Firebase 데이터베이스 초기화가 필요합니다.", "danger");
                    return false;
                }
                try {
                    const projectRef = doc(db, `users/${App.db.currentUser.uid}/projects`, projectId);
                    await deleteDoc(projectRef);
                    console.log(`프로젝트 '${projectId}' Firebase에서 삭제됨`);
                    return true;
                } catch (e) {
                    console.error("Firebase에서 프로젝트 삭제 실패:", e);
                    showToast("삭제 실패", "프로젝트를 삭제하지 못했습니다.", "danger");
                    return false;
                }
            }

            // --- 2. Data Management (Local UI State) ---
            function saveDb() {
                try {
                    const localData = {
                        activeProjectId: App.db.activeProjectId,
                        scrollPositions: App.state.scrollPositions // Save scroll positions locally
                    };
                    localStorage.setItem('ile_local_ui_state', JSON.stringify(localData));
                } catch (e) {
                    console.error("로컬 UI 상태 저장 실패:", e);
                    showToast("오류", "로컬 설정 저장에 실패했습니다.", "danger");
                }
            }

            function loadDb() {
                try {
                    const stored = localStorage.getItem('ile_local_ui_state');
                    if (stored) {
                        const localData = JSON.parse(stored);
                        App.db.activeProjectId = localData.activeProjectId || null;
                        App.state.scrollPositions = localData.scrollPositions || {};
                    }
                } catch (e) {
                    console.error("로컬 UI 상태 불러오기 실패:", e);
                    App.db.activeProjectId = null;
                    App.state.scrollPositions = {};
                    showToast("경고", "로컬 설정을 불러오는 중 오류가 발생하여 초기화합니다.", "warning");
                }
            }

            // Custom modal for confirmation instead of window.confirm
            function showConfirmModal(title, message, onConfirm) {
                const modalHtml = `
                    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmModalLabel">${title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${message}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                    <button type="button" class="btn btn-danger" id="confirmActionBtn">확인</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // Remove existing modal if any
                const existingModal = document.getElementById('confirmModal');
                if (existingModal) existingModal.remove();

                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                confirmModal.show();

                document.getElementById('confirmActionBtn').onclick = () => {
                    onConfirm();
                    confirmModal.hide();
                };
                // Clean up modal from DOM after it's hidden
                document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
                    document.getElementById('confirmModal').remove();
                });
            }


            function showToast(title, body, type = 'info') {
                const toastEl = document.getElementById('liveToast');
                if (!toastEl) return;
                // Set border color based on type
                toastEl.style.borderColor = `var(--${type}-color)`;
                // Set header and body text
                document.getElementById('toast-title').textContent = title;
                document.getElementById('toast-body').textContent = body;
                // Show the toast
                App.bs.toast.show();
            }

            // --- 3. UI Rendering ---
            function render() {
                renderProjectList();
                renderWorkspace();
            }

            function renderProjectList() {
                const listEl = App.dom.projectList;
                if (!listEl) return;
                listEl.innerHTML = ''; // Clear previous content

                if (!App.db.currentUser) {
                    listEl.innerHTML = `<p class="small text-secondary px-2 py-2">로그인 후 프로젝트를 이용할 수 있습니다.</p>`;
                    return;
                }

                const currentSearchQuery = App.state.currentProjectSearchQuery?.toLowerCase() || '';

                const filteredProjectIds = Object.keys(App.db.projects).filter(id => {
                    const project = App.db.projects[id];
                    return project.name.toLowerCase().includes(currentSearchQuery);
                });

                if (filteredProjectIds.length === 0) {
                    listEl.innerHTML = `<p class="small text-secondary px-2 py-2">${currentSearchQuery ? '검색 결과가 없습니다.' : '프로젝트가 없습니다. "새 프로젝트 생성" 버튼을 클릭하여 시작하세요.'}</p>`;
                    return;
                }

                filteredProjectIds.forEach(id => {
                    const p = App.db.projects[id];
                    const item = document.createElement('a');
                    item.href = '#';
                    // Use project-card class instead of list-group-item
                    item.className = `project-card ${p.id === App.db.activeProjectId ? 'active' : ''}`;
                    item.dataset.projectId = p.id;
                    item.setAttribute('role', 'button'); 
                    item.innerHTML = `
                        <span class="project-name">${p.name}</span>
                        <i class="fa-solid fa-trash-can text-secondary small delete-btn" title="프로젝트 삭제" aria-label="프로젝트 삭제"></i>
                    `;
                    listEl.appendChild(item);
                });
            }
            
            function renderWorkspace() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) {
                    if (App.dom.welcomeScreen) App.dom.welcomeScreen.classList.remove('d-none');
                    if (App.dom.projectWorkspace) App.dom.projectWorkspace.classList.add('d-none');
                    if (App.dom.projectTitleMobile) App.dom.projectTitleMobile.textContent = "ILE v8.5"; 
                    return;
                }

                if (App.dom.welcomeScreen) App.dom.welcomeScreen.classList.add('d-none');
                if (App.dom.projectWorkspace) App.dom.projectWorkspace.classList.remove('d-none');
                
                if (App.dom.projectTitleMain) App.dom.projectTitleMain.textContent = project.name;
                if (App.dom.projectTitleMobile) App.dom.projectTitleMobile.textContent = project.name;
                if (App.dom.projectGoal) App.dom.projectGoal.textContent = project.goal;
                if (App.dom.planInput) App.dom.planInput.value = project.learningPlan ? JSON.stringify(project.learningPlan, null, 2) : '';
                
                renderResourceList();
                renderLearningDashboard();
            }

            function renderResourceList() {
                const listEl = App.dom.resourceList;
                if (!listEl) return;
                listEl.innerHTML = '';
                const project = App.db.projects[App.db.activeProjectId];
                
                if (!project?.resources?.length) {
                    listEl.innerHTML = `<p class="small text-secondary px-2">자원이 없습니다. "자원 추가" 버튼을 클릭하여 시작하세요.</p>`;
                    return;
                }

                project.resources.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.dataset.resourceId = r.id;
                    item.style.cursor = 'pointer';
                    item.innerHTML = `
                        <span class="text-truncate" style="flex-grow: 1; max-width: calc(100% - 30px);">${r.name}</span>
                        <i class="fa-solid fa-times text-secondary small delete-btn" title="자원 삭제" aria-label="자원 삭제" style="cursor: pointer;"></i>
                    `;
                    listEl.appendChild(item);
                });
            }
            
            function renderLearningDashboard() {
                const dashboard = App.dom.learningDashboard;
                if (!dashboard) return;
                const project = App.db.projects[App.db.activeProjectId];
                const plan = project?.learningPlan;

                if (!plan?.modules?.length) {
                    dashboard.innerHTML = '<p class="text-secondary text-center small col-12">학습 계획을 먼저 적용해주세요. (Phase 0)</p>';
                    return;
                }

                dashboard.innerHTML = '';
                plan.modules.forEach((module, index) => {
                    const card = document.createElement('div');
                    card.className = `module-card status-${module.status || 'pending'}`;
                    card.dataset.moduleIndex = index;

                    // Truncate learning objectives and add a "자세히 보기" button
                    const learningObjectivesText = (module.learningObjectives || []).join(', ');
                    const displayLearningObjectives = `<b>학습 목표:</b> <span class="learning-objectives-preview">${learningObjectivesText || '없음'}</span>`;
                    const viewObjectivesButtonLO = learningObjectivesText.length > 50 ? 
                        `<button class="btn btn-link btn-sm p-0 d-block mt-1 view-details-btn" data-detail-type="learning-objectives" data-module-index="${index}" aria-label="학습 목표 자세히 보기"><i class="fa-solid fa-circle-info me-1"></i> 자세히 보기</button>` : '';

                    // Truncate key concepts and add a "자세히 보기" button
                    const keyConceptsText = (module.keyConcepts || []).join(', ');
                    const displayKeyConcepts = `<b>핵심 개념:</b> <span class="key-concepts-preview">${keyConceptsText || '없음'}</span>`;
                    const viewObjectivesButtonKC = keyConceptsText.length > 50 ? 
                        `<button class="btn btn-link btn-sm p-0 d-block mt-1 view-details-btn" data-detail-type="key-concepts" data-module-index="${index}" aria-label="핵심 개념 자세히 보기"><i class="fa-solid fa-circle-info me-1"></i> 자세히 보기</button>` : '';

                    // Truncate recommended resources and add a "자세히 보기" button
                    const recommendedResourcesText = (module.recommendedResources || []).join(', ');
                    const displayRecommendedResources = `<b>추천 리소스:</b> <span class="resources-preview">${recommendedResourcesText || '없음'}</span>`;
                    const viewObjectivesButtonRR = recommendedResourcesText.length > 50 ? 
                        `<button class="btn btn-link btn-sm p-0 d-block mt-1 view-details-btn" data-detail-type="recommended-resources" data-module-index="${index}" aria-label="추천 리소스 자세히 보기"><i class="fa-solid fa-circle-info me-1"></i> 자세히 보기</button>` : '';


                    card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-truncate">${module.title}</h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle py-0 px-2" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="모듈 상태 변경">
                                    ${(() => { // IIFE for dynamic status text
                                        switch (module.status) {
                                            case 'pending': return '대기';
                                            case 'inprogress': return '진행 중';
                                            case 'completed': return '완료';
                                            default: return '상태';
                                        }
                                    })()}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item status-change-btn" href="#" data-status="pending">대기</a></li>
                                    <li><a class="dropdown-item status-change-btn" href="#" data-status="inprogress">진행 중</a></li>
                                    <li><a class="dropdown-item status-change-btn" href="#" data-status="completed">완료</a></li>
                                </ul>
                            </div>
                        </div>
                        <p class="small text-secondary mb-2">${displayKeyConcepts}${viewObjectivesButtonKC}</p>
                        <p class="small mb-3">${displayLearningObjectives}${viewObjectivesButtonLO}</p>
                        ${module.recommendedResources && module.recommendedResources.length > 0 ? 
                            `<p class="small text-primary mb-3">${displayRecommendedResources}${viewObjectivesButtonRR}</p>` : ''
                        }
                        <div class="mb-2">
                            <label class="form-label small">스터디 패드</label>
                            <textarea class="form-control form-control-sm module-studypad" placeholder="이 모듈에 대한 AI 생성 학습 내용을 여기에 붙여넣으세요...">${module.studyPad || ''}</textarea>
                            <button class="btn btn-sm btn-outline-primary mt-2 view-studypad-btn" data-module-index="${index}" aria-label="스터디 패드 보기/편집">
                                <i class="fa-solid fa-eye me-1"></i> 스터디 패드 보기
                            </button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">개인 메모</label>
                            <textarea class="form-control form-control-sm module-notes" placeholder="생각, 질문 등을 자유롭게 메모하세요...">${module.notes || ''}</textarea>
                        </div>
                        <button class="btn btn-sm btn-info w-100 open-action-selector" aria-label="액션 실행">
                            <i class="fa-solid fa-person-chalkboard me-2"></i>액션 실행
                        </button>
                    `;
                    dashboard.appendChild(card);
                });

                // Calculate progress and update stats
                const totalModules = plan.modules.length;
                const completedModules = plan.modules.filter(m => m.status === 'completed').length;
                const inprogressModules = plan.modules.filter(m => m.status === 'inprogress').length;
                const pendingModules = totalModules - completedModules - inprogressModules;

                const completionPercentage = totalModules > 0 ? Math.round((completedModules / totalModules) * 100) : 0;

                // Update overall progress bar color based on status
                let progressBarColor = 'var(--text-secondary)'; // Default for pending
                if (completionPercentage > 0 && completionPercentage < 100) {
                    progressBarColor = 'var(--warning-color)'; // In progress
                } else if (completionPercentage === 100) {
                    progressBarColor = 'var(--success-color)'; // Completed
                }
                if (App.dom.overallProgressBar) {
                    App.dom.overallProgressBar.style.width = `${completionPercentage}%`;
                    App.dom.overallProgressBar.setAttribute('aria-valuenow', completionPercentage);
                    App.dom.overallProgressBar.textContent = `${completionPercentage}%`;
                    App.dom.overallProgressBar.style.backgroundColor = progressBarColor;
                }

                if (App.dom.completedModulesCount) App.dom.completedModulesCount.textContent = completedModules;
                if (App.dom.inprogressModulesCount) App.dom.inprogressModulesCount.textContent = inprogressModules;
                if (App.dom.pendingModulesCount) App.dom.pendingModulesCount.textContent = pendingModules;

                // Chart.js rendering
                if (App.chart) {
                    App.chart.destroy(); // Destroy previous chart instance if exists
                }
                if (totalModules > 0 && App.dom.moduleStatusChart) {
                    const ctx = App.dom.moduleStatusChart.getContext('2d');
                    // Define colors directly using the hex values from :root CSS variables for reliability
                    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
                    const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--warning-color').trim();
                    const secondaryTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim(); 
                    const primaryTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(); 

                    App.chart = new Chart(ctx, {
                        type: 'doughnut', // Pie chart for statuses
                        data: {
                            labels: ['완료', '진행 중', '대기'],
                            datasets: [{
                                data: [completedModules, inprogressModules, pendingModules],
                                backgroundColor: [
                                    successColor,
                                    warningColor,
                                    secondaryTextColor
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: primaryTextColor, // Adjust legend color for light theme
                                    }
                                },
                                title: {
                                    display: true,
                                    text: '모듈 상태 분석',
                                    color: primaryTextColor, // Adjust title color
                                }
                            }
                        }
                    });
                }
            }

            function renderActionSelector(moduleIndex) {
                const body = App.dom.actionSelectorBody;
                if (!body) return; // Add null check for body
                const project = App.db.projects[App.db.activeProjectId];
                // Ensure DEFAULT_ACTIONS are always included if the project's actions array is empty or undefined
                const actions = project?.actions && project.actions.length > 0 ? project.actions : DEFAULT_ACTIONS;

                const groupedActions = actions.reduce((acc, action) => {
                    if (action.key === '0_plan') return acc;
                    const category = action.category || '기타';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(action);
                    return acc;
                }, {});

                body.innerHTML = '';
                for (const category of Object.keys(groupedActions).sort()) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'action-category mb-4';
                    categoryDiv.innerHTML = `<h6 class="mb-3">${category}</h6>`;
                    const actionGrid = document.createElement('div');
                    actionGrid.className = 'd-grid gap-2';
                    groupedActions[category].forEach(action => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-outline-light text-start build-prompt-btn';
                        button.dataset.templateKey = action.key;
                        button.dataset.moduleIndex = moduleIndex;
                        button.textContent = action.title;
                        button.setAttribute('aria-label', `${action.title} 프롬프트 생성`);
                        actionGrid.appendChild(button);
                    });
                    categoryDiv.appendChild(actionGrid);
                    body.appendChild(categoryDiv);
                }
                if (App.bs.actionSelectorModal) App.bs.actionSelectorModal.show(); // Add null check
            }

            function renderActionManager() {
                const container = App.dom.actionListContainer;
                if (!container) return; // Add null check for container
                const project = App.db.projects[App.db.activeProjectId];
                // Ensure DEFAULT_ACTIONS are always included if the project's actions array is empty or undefined
                const actions = project?.actions && project.actions.length > 0 ? project.actions : DEFAULT_ACTIONS;

                container.innerHTML = actions.map(action => {
                    if(action.key === '0_plan') return ''; 
                    return `
                    <div class="p-3 rounded mb-2 d-flex justify-content-between align-items-center action-list-item">
                        <div>
                            <h6 class="mb-0">${action.title}</h6>
                            <small class="text-secondary">${action.category} / Key: ${action.key}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-light edit-action-btn" data-action-key="${action.key}" aria-label="${action.title} 편집"><i class="fa-solid fa-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-action-btn" data-action-key="${action.key}" aria-label="${action.title} 삭제"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }

            // --- 4. Core Logic & Handlers ---
            
            // Helper Functions
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => {
                        reader.abort();
                        reject(new DOMException("파일 읽기 중 문제가 발생했습니다."));
                    };
                    reader.readAsText(file);
                });
            }

            async function copyToClipboard(text) {
                if (navigator.clipboard?.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        showToast("성공", "프롬프트가 클립보드에 복사되었습니다.", "success");
                        return;
                    } catch (err) { console.warn("Clipboard API 실패, 폴백 시도:", err); }
                }
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.opacity = "0";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("성공", "프롬프트가 클립보드에 복사되었습니다.", "success");
                } catch (err) {
                    showToast("오류", "프롬프트 복사에 실패했습니다.", "danger");
                    console.error("폴백 복사 실패:", err);
                }
                document.body.removeChild(textArea);
            }

            // Project Management
            function switchActiveProject(projectId) {
                App.db.activeProjectId = projectId;
                saveDb();
                render();
                if (App.dom.sidebar) App.dom.sidebar.classList.remove('is-open');
                if (App.dom.overlay) App.dom.overlay.classList.remove('is-visible');
            }

            async function createNewProject(name, goal) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "먼저 로그인해주세요.", "danger");
                    return;
                }
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                const id = doc(collection(db, `users/${App.db.currentUser.uid}/projects`)).id; // Generate Firestore ID
                const newProject = {
                    id,
                    name,
                    goal,
                    resources: [],
                    learningPlan: null,
                    actions: JSON.parse(JSON.stringify(DEFAULT_ACTIONS)) // Deep copy default actions
                };
                const success = await saveProjectToFirestore(newProject);
                if (success) {
                    App.db.projects[id] = newProject; // Add to local state after successful Firestore save
                    switchActiveProject(id);
                    showToast("성공", `'${name}' 프로젝트가 생성되었습니다.`, "success");
                }
            }
            
            async function deleteProject(projectId) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return;
                }
                const projectName = App.db.projects[projectId]?.name || "이";
                showConfirmModal(`프로젝트 삭제 확인`, `'${projectName}' 프로젝트를 정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`, async () => {
                    const success = await deleteProjectFromFirestore(projectId);
                    if (success) {
                        delete App.db.projects[projectId];
                        if (App.db.activeProjectId === projectId) {
                            App.db.activeProjectId = Object.keys(App.db.projects)[0] || null;
                        }
                        saveDb();
                        render();
                        showToast("성공", "프로젝트가 삭제되었습니다.", "success");
                    }
                });
            }

            // Module Management
            function updateModuleField(index, field, value) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project?.learningPlan?.modules[index]) return;

                project.learningPlan.modules[index][field] = value;
                // Debounce Firestore save for module updates
                clearTimeout(App.state.saveTimeout);
                App.state.saveTimeout = setTimeout(async () => {
                    await saveProjectToFirestore(project);
                    renderLearningDashboard(); // Re-render to update UI (e.g., progress bar)
                }, 1000); // Save after 1 second of inactivity
            }
            
            // Action (Prompt Template) Management
            function openActionEditor(actionKey = null) {
                const form = document.getElementById('action-editor-form');
                if (!form) return;
                form.reset();
                const project = App.db.projects[App.db.activeProjectId];
                const action = actionKey ? project?.actions.find(a => a.key === actionKey) : null;
                
                if (document.getElementById('actionEditorTitle')) document.getElementById('actionEditorTitle').textContent = action ? '액션 편집' : '새 액션 추가';
                if (document.getElementById('action-key-input')) document.getElementById('action-key-input').value = action ? action.key : `custom_${Date.now()}`;
                if (action) {
                    if (document.getElementById('action-title-input')) document.getElementById('action-title-input').value = action.title;
                    if (document.getElementById('action-category-input')) document.getElementById('action-category-input').value = action.category;
                    if (document.getElementById('action-purpose-input')) document.getElementById('action-purpose-input').value = action.purpose;
                }
                if (App.bs.actionEditorModal) App.bs.actionEditorModal.show();
            }

            async function saveAction() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return;
                }
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }

                const key = document.getElementById('action-key-input')?.value;
                const updatedAction = {
                    key: key,
                    title: document.getElementById('action-title-input')?.value.trim(),
                    category: document.getElementById('action-category-input')?.value.trim(),
                    purpose: document.getElementById('action-purpose-input')?.value,
                };
                if (!updatedAction.title || !updatedAction.category || !updatedAction.purpose) {
                    return showToast('오류', '모든 필드를 입력해야 합니다.', 'danger');
                }
                
                if (!project.actions) project.actions = [];
                const existingIndex = project.actions.findIndex(a => a.key === key);
                if (existingIndex > -1) {
                    project.actions[existingIndex] = updatedAction;
                } else {
                    project.actions.push(updatedAction);
                }
                
                const success = await saveProjectToFirestore(project);
                if (success) {
                    renderActionManager();
                    if (App.bs.actionEditorModal) App.bs.actionEditorModal.hide();
                    showToast('성공', '액션이 저장되었습니다.', 'success');
                }
            }

            async function deleteAction(actionKey) {
                if (!App.db.currentUser?.uid) {
                    showToast("오류", "로그인이 필요합니다.", "danger");
                    return;
                }
                showConfirmModal('액션 삭제 확인', '이 액션을 정말 삭제하시겠습니까?', async () => {
                    const project = App.db.projects[App.db.activeProjectId];
                    if (!project?.actions) return;
                    project.actions = project.actions.filter(a => a.key !== actionKey);
                    
                    const success = await saveProjectToFirestore(project);
                    if (success) {
                        renderActionManager();
                        showToast('성공', '액션이 삭제되었습니다.', "success");
                    }
                });
            }

            // New Feature: Download All Study Pads
            function downloadAllStudyPads() {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules?.length) {
                    return showToast("정보", "다운로드할 스터디 패드 내용이 없습니다.", "info");
                }

                let combinedContent = `# ${project.name}\n\n`;
                combinedContent += `## 최종 학습 목표\n${project.goal || '없음'}\n\n`;
                combinedContent += `---\n\n`;

                project.learningPlan.modules.forEach((module, index) => {
                    combinedContent += `## ${index + 1}. ${module.title}\n\n`;
                    combinedContent += `### 핵심 개념: ${(module.keyConcepts || []).join(', ')}\n\n`;
                    combinedContent += `### 학습 목표: ${(module.learningObjectives || []).join(', ')}\n\n`;
                    if (module.recommendedResources && module.recommendedResources.length > 0) {
                        combinedContent += `### 추천 리소스: ${module.recommendedResources.join(', ')}\n\n`;
                    }
                    combinedContent += `### 스터디 패드\n\n`;
                    combinedContent += `${module.studyPad || '작성된 내용 없음.'}\n\n`;
                    if (module.notes) {
                        combinedContent += `### 개인 메모\n\n`;
                        combinedContent += `${module.notes}\n\n`;
                    }
                    combinedContent += `---\n\n`;
                });

                const blob = new Blob([combinedContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeFileName = project.name.replace(/[/\\?%*:|"<>]/g, '-') || 'study-pads';
                a.href = url;
                a.download = `${safeFileName}_study_pads.md`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
                showToast("성공", "스터디 패드 내용이 다운로드되었습니다.", "success");
            }

            // Study Pad Viewer (Markdown Rendering) & In-line Editing
            function openStudyPadViewer(moduleIndex) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules[moduleIndex]) {
                    return showToast("오류", "모듈을 찾을 수 없습니다.", "danger");
                }
                const module = project.learningPlan.modules[moduleIndex];
                
                App.state.currentModuleIndexForViewer = moduleIndex; // Store current module index
                
                // Set initial mode to viewer mode
                if (App.dom.studyPadViewerContent) App.dom.studyPadViewerContent.classList.remove('d-none');
                if (App.dom.studyPadEditorContent) App.dom.studyPadEditorContent.classList.add('d-none');
                if (App.dom.toggleViewerModeBtn) App.dom.toggleViewerModeBtn.textContent = '편집 모드';
                if (App.dom.saveViewerContentBtn) App.dom.saveViewerContentBtn.classList.add('d-none');

                if (App.dom.studyPadViewerTitle) App.dom.studyPadViewerTitle.textContent = `${module.title} 스터디 패드`;
                // Use marked.js to convert Markdown to HTML
                if (App.dom.studyPadViewerContent) App.dom.studyPadViewerContent.innerHTML = marked.parse(module.studyPad || '내용이 없습니다.');
                if (App.dom.studyPadEditorContent) App.dom.studyPadEditorContent.value = module.studyPad || ''; // Populate editor with raw content
                
                if (App.bs.studyPadViewerModal) App.bs.studyPadViewerModal.show();

                // Restore scroll position when modal opens
                if (App.dom.studyPadViewerModal) {
                    App.dom.studyPadViewerModal.addEventListener('shown.bs.modal', function handler() {
                        const savedScroll = App.state.scrollPositions[`module_${moduleIndex}`];
                        if (savedScroll !== undefined) {
                            if (App.dom.studyPadViewerContent) App.dom.studyPadViewerContent.scrollTop = savedScroll;
                            if (App.dom.studyPadEditorContent) App.dom.studyPadEditorContent.scrollTop = savedScroll; // Apply to editor too
                        }
                        // Call MathJax to render equations after content is set AND modal is shown
                        if (typeof MathJax !== 'undefined') {
                            MathJax.typesetPromise([App.dom.studyPadViewerContent]).catch((err) => console.error('MathJax rendering failed:', err));
                        }
                        App.dom.studyPadViewerModal.removeEventListener('shown.bs.modal', handler); // Remove listener after first execution
                    });
                }
            }

            function toggleStudyPadViewerMode() {
                const moduleIndex = App.state.currentModuleIndexForViewer;
                const isEditing = App.dom.studyPadViewerContent && App.dom.studyPadViewerContent.classList.contains('d-none'); // True if editor is currently hidden

                // Save current scroll position before switching modes
                const currentScroll = isEditing ? (App.dom.studyPadEditorContent ? App.dom.studyPadEditorContent.scrollTop : 0) : (App.dom.studyPadViewerContent ? App.dom.studyPadViewerContent.scrollTop : 0);
                App.state.scrollPositions[`module_${moduleIndex}`] = currentScroll;
                saveDb(); // Save local UI state

                if (!isEditing) { // Currently in viewer mode, switch to editor mode
                    if (App.dom.studyPadViewerContent) App.dom.studyPadViewerContent.classList.add('d-none');
                    if (App.dom.studyPadEditorContent) {
                        App.dom.studyPadEditorContent.classList.remove('d-none');
                        App.dom.studyPadEditorContent.focus();
                        App.dom.studyPadEditorContent.scrollTop = currentScroll; // Restore scroll position
                    }
                    if (App.dom.toggleViewerModeBtn) App.dom.toggleViewerModeBtn.textContent = '뷰어 모드';
                    if (App.dom.saveViewerContentBtn) App.dom.saveViewerContentBtn.classList.remove('d-none');
                } else { // Currently in editor mode, switch to viewer mode
                    if (App.dom.studyPadViewerContent) {
                        App.dom.studyPadViewerContent.innerHTML = marked.parse(App.dom.studyPadEditorContent ? App.dom.studyPadEditorContent.value : '');
                        // Call MathJax to render equations after content is set
                        if (typeof MathJax !== 'undefined') {
                            MathJax.typesetPromise([App.dom.studyPadViewerContent]).catch((err) => console.error('MathJax rendering failed:', err));
                        }
                        App.dom.studyPadViewerContent.classList.remove('d-none');
                        App.dom.studyPadViewerContent.scrollTop = currentScroll; // Restore scroll position
                    }
                    if (App.dom.studyPadEditorContent) App.dom.studyPadEditorContent.classList.add('d-none');
                    if (App.dom.toggleViewerModeBtn) App.dom.toggleViewerModeBtn.textContent = '편집 모드';
                    if (App.dom.saveViewerContentBtn) App.dom.saveViewerContentBtn.classList.add('d-none');
                }
            }

            function saveStudyPadViewerContent() {
                const moduleIndex = App.state.currentModuleIndexForViewer;
                if (moduleIndex === null) {
                    showToast("오류", "저장할 모듈을 찾을 수 없습니다.", "danger");
                    return;
                }
                const newStudyPadContent = App.dom.studyPadEditorContent ? App.dom.studyPadEditorContent.value : '';
                updateModuleField(moduleIndex, 'studyPad', newStudyPadContent); // This will save to DB
                showToast("성공", "스터디 패드 내용이 저장되었습니다.", "success");
                toggleStudyPadViewerMode(); // Switch back to viewer mode after saving
            }

            // Function to open the detail viewer modal
            function openDetailViewer(moduleIndex, type) {
                const project = App.db.projects[App.db.activeProjectId];
                if (!project || !project.learningPlan?.modules[moduleIndex]) {
                    return showToast("오류", "모듈을 찾을 수 없습니다.", "danger");
                }
                const module = project.learningPlan.modules[moduleIndex];
                let title = '';
                let content = '';

                if (type === 'learning-objectives') {
                    title = `${module.title} 학습 목표`;
                    content = (module.learningObjectives || []).join('\n- ');
                    content = `- ${content}`; // Markdown list for display
                } else if (type === 'key-concepts') {
                    title = `${module.title} 핵심 개념`;
                    content = (module.keyConcepts || []).join('\n- ');
                    content = `- ${content}`;
                } else if (type === 'recommended-resources') {
                    title = `${module.title} 추천 리소스`;
                    content = (module.recommendedResources || []).join('\n- ');
                    content = `- ${content}`;
                }
                

                if (App.dom.detailViewerTitle) App.dom.detailViewerTitle.textContent = title;
                // Use <pre> for plain text content to preserve formatting. For markdown, use marked.parse.
                if (App.dom.detailViewerBody) App.dom.detailViewerBody.innerHTML = `<pre class="detail-modal-content">${content}</pre>`; 
                if (App.bs.detailViewerModal) App.bs.detailViewerModal.show();
            }

            // Project Search Handlers
            function handleProjectSearchInput(e) {
                App.state.currentProjectSearchQuery = e.target.value;
                renderProjectList();
            }

            function handleClearProjectSearch() {
                if (App.dom.projectSearchInput) App.dom.projectSearchInput.value = '';
                App.state.currentProjectSearchQuery = '';
                renderProjectList();
            }

            // --- 5. Event Listeners & Handlers ---
            function registerEventListeners() {
                // Static buttons
                App.dom.googleSigninBtn?.addEventListener('click', signInWithGoogle);
                App.dom.signOutBtn?.addEventListener('click', signOutUser);

                document.getElementById('new-project-btn')?.addEventListener('click', handleNewProjectClick);
                document.getElementById('save-project-btn')?.addEventListener('click', handleSaveProjectClick);
                document.getElementById('import-project-btn')?.addEventListener('click', () => document.getElementById('import-file-input')?.click());
                document.getElementById('import-file-input')?.addEventListener('change', handleImportProjectFile);
                document.getElementById('export-project-btn')?.addEventListener('click', handleExportProjectClick);
                document.getElementById('add-resource-btn')?.addEventListener('click', handleAddResourceClick);
                document.getElementById('save-resource-btn')?.addEventListener('click', handleSaveResourceClick);
                document.getElementById('resource-file-input')?.addEventListener('change', handleResourceFileChange);
                document.getElementById('apply-plan-btn')?.addEventListener('click', handleApplyPlanClick);
                document.getElementById('manage-actions-btn')?.addEventListener('click', handleManageActionsClick);
                document.getElementById('add-new-action-btn')?.addEventListener('click', () => openActionEditor());
                document.getElementById('save-action-btn')?.addEventListener('click', saveAction);
                document.getElementById('execute-prompt-btn')?.addEventListener('click', handleExecutePromptClick);
                document.getElementById('download-studypad-btn')?.addEventListener('click', downloadAllStudyPads); 
                
                // Added direct event listener for the plan button
                App.dom.planButton?.addEventListener('click', () => handleBuildPrompt('0_plan', null));

                // Event Listeners for new Study Pad Viewer buttons
                App.dom.toggleViewerModeBtn?.addEventListener('click', toggleStudyPadViewerMode);
                App.dom.saveViewerContentBtn?.addEventListener('click', saveStudyPadViewerContent);


                // Event Delegation for dynamic content
                App.dom.projectList?.addEventListener('click', handleProjectListClick);
                App.dom.resourceList?.addEventListener('click', handleResourceListClick);
                App.dom.learningDashboard?.addEventListener('click', handleDashboardClick);
                App.dom.learningDashboard?.addEventListener('input', handleDashboardInput);
                App.dom.actionListContainer?.addEventListener('click', handleActionManagerClick);
                App.dom.actionSelectorBody?.addEventListener('click', handleActionSelectorClick);

                // Project search event listeners
                App.dom.projectSearchInput?.addEventListener('input', handleProjectSearchInput);
                App.dom.clearProjectSearchBtn?.addEventListener('click', handleClearProjectSearch);

                // Mobile UI
                document.getElementById('hamburger-btn')?.addEventListener('click', toggleSidebar);
                App.dom.overlay?.addEventListener('click', toggleSidebar);
            }

            // Specific Click Handlers
            function handleNewProjectClick() {
                document.getElementById('new-project-form').reset();
                if (App.bs.newProjectModal) App.bs.newProjectModal.show();
            }

            function handleSaveProjectClick() {
                const nameInput = document.getElementById('new-project-name');
                const goalInput = document.getElementById('new-project-goal');
                if (nameInput?.value.trim() && goalInput?.value.trim()) { // Add null checks
                    createNewProject(nameInput.value, goalInput.value);
                    if (App.bs.newProjectModal) App.bs.newProjectModal.hide();
                } else {
                    showToast('오류', '프로젝트 이름과 목표를 모두 입력해야 합니다.', 'danger');
                }
            }
            
            async function handleImportProjectFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (!App.db.currentUser?.uid) return showToast("오류", "로그인이 필요합니다.", "danger");
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }

                try {
                    const jsonText = await readFileAsText(file);
                    const importedProject = JSON.parse(jsonText);
                    if (importedProject.id && importedProject.name) {
                        // Overwrite local project if exists, otherwise add new
                        App.db.projects[importedProject.id] = importedProject;
                        // Ensure actions array is initialized or merged with default actions
                        if (!importedProject.actions || importedProject.actions.length === 0) {
                            importedProject.actions = JSON.parse(JSON.stringify(DEFAULT_ACTIONS));
                        } else {
                            DEFAULT_ACTIONS.forEach(defaultAction => {
                                if (!importedProject.actions.some(a => a.key === defaultAction.key)) {
                                    importedProject.actions.push(defaultAction);
                                }
                            });
                        }
                        const success = await saveProjectToFirestore(importedProject);
                        if (success) {
                            switchActiveProject(importedProject.id);
                            showToast("성공", "프로젝트를 성공적으로 가져왔습니다.", "success");
                        }
                    } else { throw new Error("파일에 'id'와 'name' 속성이 없습니다."); }
                }
                catch (err) {
                    let errorMessage = "유효하지 않은 프로젝트 파일이거나 파일 읽기에 실패했습니다.";
                    if (err instanceof SyntaxError) {
                        errorMessage = "JSON 형식이 올바르지 않습니다. 파일을 확인해주세요.";
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    showToast("오류", errorMessage, "danger");
                }
                e.target.value = '';
            }
            
            function handleExportProjectClick() {
                if (!App.db.activeProjectId) return showToast("오류", "내보낼 프로젝트를 선택하세요.", "danger");
                const project = App.db.projects[App.db.activeProjectId];
                const projectData = JSON.stringify(project, null, 2);
                const blob = new Blob([projectData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeFileName = project.name.replace(/[/\\?%*:|"<>]/g, '-') || 'project';
                a.href = url;
                a.download = `${safeFileName}.json`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            }
            
            function handleProjectListClick(e) {
                const listItem = e.target.closest('.project-card'); // Changed to project-card
                if (!listItem) return;
                const projectId = listItem.dataset.projectId;
                if (e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    deleteProject(projectId);
                } else {
                    switchActiveProject(projectId);
                }
            }

            function handleResourceListClick(e) {
                const listItem = e.target.closest('.list-group-item[data-resource-id]');
                if (!listItem) return;
                const resourceId = listItem.dataset.resourceId;
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent opening resource editor
                    const resourceName = project.resources.find(r => r.id === resourceId)?.name || "이";
                    showConfirmModal(`자원 삭제 확인`, `'${resourceName}' 자원을 삭제하시겠습니까?`, async () => {
                        project.resources = project.resources.filter(r => r.id !== resourceId);
                        const success = await saveProjectToFirestore(project);
                        if (success) {
                            renderResourceList();
                            showToast("성공", "자원이 삭제되었습니다.", "success");
                        }
                    });
                } else {
                    const resource = project.resources.find(r => r.id === resourceId);
                    if (resource) {
                        if (document.getElementById('resourceModalTitle')) document.getElementById('resourceModalTitle').textContent = '자원 편집';
                        if (document.getElementById('resource-id')) document.getElementById('resource-id').value = resource.id;
                        if (document.getElementById('resource-name')) document.getElementById('resource-name').value = resource.name;
                        if (document.getElementById('resource-content')) document.getElementById('resource-content').value = resource.content; 
                        if (document.getElementById('resource-file-input')) document.getElementById('resource-file-input').value = '';
                        if (App.bs.resourceModal) App.bs.resourceModal.show();
                    }
                }
            }
            
            function handleAddResourceClick() {
                if (!App.db.activeProjectId) return showToast("오류", "먼저 프로젝트를 선택하세요.", "warning");
                if (document.getElementById('resourceModalTitle')) document.getElementById('resourceModalTitle').textContent = '새 자원 추가';
                if (document.getElementById('resource-id')) document.getElementById('resource-id').value = '';
                if (document.getElementById('resource-name')) document.getElementById('resource-name').value = '';
                if (document.getElementById('resource-content')) document.getElementById('resource-content').value = '';
                if (document.getElementById('resource-file-input')) document.getElementById('resource-file-input').value = '';
                if (App.bs.resourceModal) App.bs.resourceModal.show();
            }
            
            async function handleResourceFileChange(e) {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const content = await readFileAsText(file);
                    if (document.getElementById('resource-content')) document.getElementById('resource-content').value = content;
                    const resourceNameInput = document.getElementById('resource-name');
                    if (resourceNameInput && !resourceNameInput.value) {
                        resourceNameInput.value = file.name.replace(/\.[^/.]+$/, "");
                    }
                } catch(err) { showToast('오류', err.message, 'danger'); }
                e.target.value = '';
            }

            async function handleSaveResourceClick() {
                const id = document.getElementById('resource-id')?.value;
                const name = document.getElementById('resource-name')?.value.trim();
                const content = document.getElementById('resource-content')?.value;
                if (!name || !content) return showToast("오류", "이름과 내용을 모두 입력하세요.", "danger");
                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return;
                if (!project.resources) project.resources = [];
                const existingResource = id ? project.resources.find(r => r.id === id) : null;
                if (existingResource) {
                    existingResource.name = name;
                    existingResource.content = content;
                } else {
                    project.resources.push({ id: `res_${Date.now()}`, name, content });
                }
                
                const success = await saveProjectToFirestore(project);
                if (success) {
                    renderResourceList();
                    if (App.bs.resourceModal) App.bs.resourceModal.hide();
                    showToast("성공", `자원이 ${id ? '수정' : '추가'}되었습니다.`, "success");
                }
            }

            async function handleApplyPlanClick() {
                if (!App.db.activeProjectId) return showToast("오류", "먼저 프로젝트를 선택하세요.", "warning");
                if (!App.db.currentUser?.uid) return showToast("오류", "로그인이 필요합니다.", "danger");
                if (!db) {
                    showToast("오류", "Firebase 데이터베이스가 초기화되지 않았습니다.", "danger");
                    return;
                }
                try {
                    const planText = App.dom.planInput?.value;
                    // Remove leading/trailing markdown code block fences if present
                    const cleanedJsonString = (planText || '').replace(/^```json\s*|```\s*$/g, '').trim(); 
                    if (!cleanedJsonString) throw new Error("입력된 내용이 없습니다.");
                    const planJSON = JSON.parse(cleanedJsonString);
                    if (!planJSON.modules || !Array.isArray(planJSON.modules)) throw new Error("JSON에 'modules' 배열이 없습니다.");
                    const project = App.db.projects[App.db.activeProjectId];
                    
                    project.learningPlan = planJSON;
                    project.name = planJSON.projectName || project.name; // Update project name from plan
                    project.goal = planJSON.mainGoal || project.goal; // Update project goal from plan
                    
                    // Initialize new fields for existing modules if they don't exist
                    project.learningPlan.modules.forEach(module => {
                        if (module.studyPad === undefined) module.studyPad = "";
                        if (module.notes === undefined) module.notes = "";
                        if (module.recommendedResources === undefined) module.recommendedResources = [];
                        if (module.status === undefined) module.status = "pending"; // Default status
                    });

                    const success = await saveProjectToFirestore(project);
                    if (success) {
                        render(); // Re-render everything to update the dashboard
                        showToast("성공", "학습 계획이 적용되었습니다.", "success");
                    }
                } catch (e) {
                    showToast("오류", "유효하지 않은 JSON 형식입니다: " + e.message, "danger");
                }
            }
            
            function handleDashboardClick(e) {
                const target = e.target;
                const card = target.closest('.module-card');
                if (!card) return;
                const moduleIndex = card.dataset.moduleIndex;
                if (target.matches('.open-action-selector')) {
                    renderActionSelector(moduleIndex);
                } else if (target.closest('.status-change-btn')) {
                    e.preventDefault();
                    updateModuleField(moduleIndex, 'status', target.closest('.status-change-btn').dataset.status);
                } else if (target.matches('.view-studypad-btn')) { 
                    e.preventDefault();
                    openStudyPadViewer(moduleIndex);
                } else if (target.matches('.view-details-btn')) { 
                    e.preventDefault();
                    const type = target.dataset.detailType;
                    openDetailViewer(moduleIndex, type);
                }
            }
            
            function handleDashboardInput(e) {
                const target = e.target;
                const card = target.closest('.module-card');
                if (!card) return;
                const index = card.dataset.moduleIndex;
                if (target.matches('.module-studypad')) {
                    updateModuleField(index, 'studyPad', target.value);
                } else if (target.matches('.module-notes')) {
                    updateModuleField(index, 'notes', target.value);
                }
            }

            function handleManageActionsClick() {
                if (!App.db.activeProjectId) return showToast("오류", "프로젝트를 선택하세요.", "warning");
                renderActionManager();
                if (App.bs.actionManagerModal) App.bs.actionManagerModal.show();
            }

            function handleActionManagerClick(e) {
                const editBtn = e.target.closest('.edit-action-btn');
                if(editBtn) openActionEditor(editBtn.dataset.actionKey);
                
                const deleteBtn = e.target.closest('.delete-action-btn');
                if(deleteBtn) deleteAction(deleteBtn.dataset.actionKey);
            }

            function handleActionSelectorClick(e) {
                const buildBtn = e.target.closest('.build-prompt-btn');
                if (buildBtn) {
                    e.preventDefault();
                    const { templateKey, moduleIndex } = buildBtn.dataset;
                    handleBuildPrompt(templateKey, moduleIndex);
                }
            }

            function handleBuildPrompt(templateKey, moduleIndex) {
                if (App.bs.actionSelectorModal) App.bs.actionSelectorModal.hide();

                const project = App.db.projects[App.db.activeProjectId];
                if (!project) return showToast('오류', '프로젝트를 찾을 수 없습니다. 새로운 프로젝트를 생성하거나 선택하세요.', 'danger');
                
                const template = (project.actions || []).find(a => a.key === templateKey);
                if (!template) return showToast('오류', '액션을 찾을 수 없습니다.', "danger");

                const module = moduleIndex !== undefined && project.learningPlan ? project.learningPlan.modules[moduleIndex] : null;

                if (App.dom.promptModalLabel) App.dom.promptModalLabel.textContent = template.title;
                if (App.dom.dynamicFormContainer) App.dom.dynamicFormContainer.innerHTML = '';
                
                if (App.dom.dataSelector) {
                    App.dom.dataSelector.innerHTML = '<option value="">자원 라이브러리에서 선택</option>';
                    (project.resources || []).forEach(r => App.dom.dataSelector.innerHTML += `<option value="${r.id}">${r.name}</option>`);
                }

                let purposeTemplate = template.purpose;
                const context = { 
                    '학습 목표': project.goal, 
                    '현재 수준': '지식이 필요한 학습자', // Default value
                    '프로젝트 이름': project.name, // Add project name to context
                    ...(module || {}) 
                };
                if (module) {
                    context['모듈 제목'] = module.title;
                    context['핵심 개념'] = (module.keyConcepts || []).join(', ') || '없음';
                    // Add recommended resources to context for template if available
                    if (module.recommendedResources && module.recommendedResources.length > 0) {
                        context['추천 리소스'] = module.recommendedResources.join(', ');
                    }
                }
                
                // Extract variables that are still [VAR_NAME] after initial pre-filling
                const variables = [...new Set([...purposeTemplate.matchAll(/\[(.*?)\]/g)].map(m => m[1]))];
                variables.forEach(varName => {
                    const prefilledValue = context[varName];
                    if (prefilledValue) {
                        purposeTemplate = purposeTemplate.replaceAll(`[${varName}]`, prefilledValue);
                    } else {
                        // Create input fields for variables that couldn't be pre-filled
                        if (App.dom.dynamicFormContainer) {
                            App.dom.dynamicFormContainer.innerHTML += `
                                <div class="mb-3">
                                    <label for="var-${varName}" class="form-label form-label-sm">${varName}</label>
                                    <input type="text" id="var-${varName}" class="form-control form-control-sm dynamic-var-input" data-var-name="${varName}" placeholder="${varName} 내용 입력...">
                                </div>
                            `;
                        }
                    }
                });

                let currentDataSource = 'none';
                if (module?.studyPad && (templateKey.startsWith('1_') || templateKey.startsWith('2_'))) {
                    currentDataSource = 'studypad';
                }
                // Reset radio buttons and then set the correct one
                document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                    radio.checked = false;
                    // Ensure the elements actually exist before trying to access their properties
                    if (radio.id === `source-${currentDataSource}`) {
                        radio.checked = true;
                    }
                });

                if (document.getElementById('data-direct-input')) document.getElementById('data-direct-input').value = '';

                const dataSourceContainers = {
                    resource: document.getElementById('data-selector-container'),
                    direct: document.getElementById('data-direct-input-container'),
                };
                
                const updateDataSourceVisibility = () => {
                    const selected = document.querySelector('input[name="dataSource"]:checked')?.value; // Add null check
                    Object.values(dataSourceContainers).forEach(c => { if (c) c.classList.add('d-none'); }); // Add null check
                    if (dataSourceContainers[selected]) {
                        dataSourceContainers[selected].classList.remove('d-none');
                    }
                };

                const updatePreview = () => {
                    let previewPurpose = purposeTemplate;
                    // Fill in dynamic variables from user input
                    if (App.dom.dynamicFormContainer) {
                        App.dom.dynamicFormContainer.querySelectorAll('.dynamic-var-input').forEach(input => {
                            const varName = input.dataset.varName;
                            const value = input.value || `[${varName}]`; // Keep placeholder if empty
                            previewPurpose = previewPurpose.replaceAll(`[${varName}]`, value);
                        });
                    }
                    
                    const selectedDataSource = document.querySelector('input[name="dataSource"]:checked')?.value; // Add null check
                    let dataContent = '내용 없음'; // Default value
                    if (selectedDataSource === 'resource') {
                        const resId = App.dom.dataSelector?.value; // Add null check
                        if (resId) dataContent = (project.resources.find(r => r.id === resId) || {}).content;
                    } else if (selectedDataSource === 'studypad') {
                        if (module?.studyPad) dataContent = module.studyPad;
                    } else if (selectedDataSource === 'direct') {
                        if (document.getElementById('data-direct-input')) dataContent = document.getElementById('data-direct-input').value;
                    }
                    
                    const contextForAI = {
                        projectName: project.name,
                        mainGoal: project.goal,
                    };
                    if (project.learningPlan) {
                        contextForAI.tutorPersona = project.learningPlan.tutorPersona;
                        contextForAI.fullTableOfContents = project.learningPlan.modules.map(m => ({ id: m.id, title: m.title, status: m.status }));
                    }
                    if (module) {
                        const { studyPad, notes, ...currentModuleContext } = module;
                        contextForAI.currentModule = currentModuleContext;
                    }
                    const projectContext = JSON.stringify(contextForAI, null, 2);
                    let finalPrompt = MASTER_PROMPT_SHELL.replace(/{{purpose}}/g, previewPurpose)
                                                          .replace(/{{data}}/g, dataContent || '내용 없음')
                                                          .replace(/{{projectContext}}/g, projectContext);
                    if (App.dom.livePreviewContainer) App.dom.livePreviewContainer.textContent = finalPrompt;
                };

                // Add event listeners for data source radios and dynamic inputs
                document.querySelectorAll('input[name="dataSource"]').forEach(radio => radio.onchange = () => {
                    updateDataSourceVisibility();
                    updatePreview();
                });

                App.dom.dynamicFormContainer?.addEventListener('input', updatePreview); // Add null check
                App.dom.dataSelector?.addEventListener('change', updatePreview); // Add null check
                document.getElementById('data-direct-input')?.addEventListener('input', updatePreview); // Add null check
                
                updateDataSourceVisibility();
                updatePreview(); // Initial preview update
                if (App.bs.promptModal) App.bs.promptModal.show();
            }

            function handleExecutePromptClick() {
                const finalPromptText = App.dom.livePreviewContainer ? App.dom.livePreviewContainer.textContent : ''; // Add null check
                copyToClipboard(finalPromptText);
            }
            
            function toggleSidebar() {
                if (App.dom.sidebar) App.dom.sidebar.classList.toggle('is-open');
                if (App.dom.overlay) App.dom.overlay.classList.toggle('is-visible');
            }

            // Project Search Handlers
            function handleProjectSearchInput(e) {
                App.state.currentProjectSearchQuery = e.target.value;
                renderProjectList();
            }

            function handleClearProjectSearch() {
                if (App.dom.projectSearchInput) App.dom.projectSearchInput.value = '';
                App.state.currentProjectSearchQuery = '';
                renderProjectList();
            }

            // --- 6. Initial Execution ---
            initApp();
        });
    </script>
</body>
</html>
