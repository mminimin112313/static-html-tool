<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© í•™ìŠµ ë° ì €ì‘ ì‹œìŠ¤í…œ v3.16 (UX ê°œì„ )</title>
    
    <!-- Core Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/morphdom@2.7.0/dist/morphdom-umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="document.dispatchEvent(new Event('katex-loaded'))"></script>

    <style>
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f8fafc; --bg-tertiary: #f1f5f9;
            --bg-hover: #eef2ff; --text-primary: #0f172a; --text-secondary: #475569;
            --text-tertiary: #64748b; --border-color: #e2e8f0; --accent-primary: #4f46e5;
            --accent-primary-hover: #4338ca; --accent-danger: #ef4444; --sidebar-width: 280px;
            --header-height: 64px; --radius-sm: 0.25rem; --radius-md: 0.5rem; --radius-lg: 0.75rem;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); display: flex; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .btn { background-color: var(--accent-primary); color: white; border: none; padding: 0.625rem 1rem; border-radius: var(--radius-md); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; transition: background-color 0.2s, transform 0.1s; }
        .btn:hover { background-color: var(--accent-primary-hover); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #e2e8f0; }
        
        .sidebar { width: var(--sidebar-width); background-color: var(--bg-primary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; height: 100%; transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; z-index: 100; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .sidebar-header .logo { font-size: 1.25rem; font-weight: 700; color: var(--accent-primary); display: flex; align-items: center; gap: 0.5rem; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 1rem 0.5rem; }
        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .nav-section-title { font-size: 0.75rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; padding: 0 0.5rem; margin-bottom: 0.5rem; }
        .nav-list { list-style: none; padding-left: 0; }
        .nav-item a { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 0.5rem; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; position: relative; }
        .nav-item a:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active a { background-color: var(--bg-hover); color: var(--accent-primary); font-weight: 600; }
        .nav-item.active a::before { content: ''; position: absolute; left: -0.5rem; top: 0; bottom: 0; width: 4px; background-color: var(--accent-primary); border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        .nav-item .icon { width: 1.25rem; height: 1.25rem; }
        .tag-count { margin-left: auto; font-size: 0.75rem; background-color: var(--bg-tertiary); color: var(--text-secondary); padding: 0.125rem 0.5rem; border-radius: var(--radius-sm); }
        
        .main-content { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .main-header { display: flex; align-items: center; padding: 0 1.5rem; height: var(--header-height); flex-shrink: 0; border-bottom: 1px solid var(--border-color); background-color: var(--bg-primary); z-index: 10; }
        .header-title { font-size: 1.25rem; font-weight: 600; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-input { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 0.5rem 2.5rem 0.5rem 0.75rem; font-size: 0.875rem; width: 280px; }
        .content-view { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        
        .project-card { background-color: var(--bg-primary); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: 1.5rem; box-shadow: var(--shadow-sm); transition: box-shadow 0.2s, transform 0.2s; }
        .project-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity .3s; backdrop-filter: blur(4px); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-container { background-color: var(--bg-primary); border-radius: var(--radius-lg); width: 90%; max-width: 600px; box-shadow: var(--shadow-md); z-index: 2001; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.show .modal-container { transform: scale(1); }
        
        .xp-bar-inner { background: linear-gradient(90deg, #4f46e5, #818cf8); transition: width 0.5s ease-out; }
        .toc-item.active > div > a { background-color: var(--bg-hover); color: var(--accent-primary); font-weight: 600; }
        .toc-item.active > div > a::before { content: ''; position: absolute; left: -0.5rem; top: 0; bottom: 0; width: 4px; background-color: var(--accent-primary); border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        /* 129:129:./code.html */
Â  Â  Â  Â  .prose-readable {
Â  Â  Â  Â  Â  Â  max-width: 75ch; /* í•œ ì¤„ì˜ ìµœëŒ€ ê¸€ì ìˆ˜ë¥¼ 75ìë¡œ ì œí•œí•˜ì—¬ ê°€ë…ì„± í™•ë³´ */
Â  Â  Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  Â  Â  margin-right: auto;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  font-size:clamp(1.125rem, 1rem + 0.5vw, 1.375rem);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  /* ê¸€ì í¬ê¸°ê°€ ì»¤ì§ì— ë”°ë¼ ì¤„ ê°„ê²©ë„ ì ì ˆíˆ ì¡°ì ˆí•˜ì—¬ ë¬¸ë‹¨ ê°€ë…ì„± í–¥ìƒ */
Â  Â  Â  Â  Â  Â  line-height: 1.7;
        }
        .drop-zone { border: 2px dashed #d1d5db; transition: all 0.2s ease-in-out; }
        .drop-zone.drag-over { background-color: #eef2ff; border-color: #6366f1; }
        
        .toc-drop-indicator-before { border-top: 2px solid var(--accent-primary); }
        .toc-drop-indicator-after { border-bottom: 2px solid var(--accent-primary); }
        .toc-drop-indicator-inside { background-color: var(--bg-hover); outline: 2px solid var(--accent-primary); }

        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text { visibility: hidden; width: 250px; background-color: #334155; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.5; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        @media (max-width: 1024px) {
            .sidebar { position: fixed; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 0 0 40px rgba(0,0,0,0.1); }
            .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; transition: opacity 0.3s; }
            .sidebar-overlay:not(.show) { opacity: 0; pointer-events: none; }
        }
    </style>
</head>
<body>
    <div id="app-container" class="flex h-screen w-full"></div>
    <div id="modal-root"></div>
    <div id="toast-root"></div>

    <script type="module">
        // ===================================================================================
        // í†µí•© í•™ìŠµ ë° ì €ì‘ ì‹œìŠ¤í…œ v3.16 (UX ê°œì„ )
        // - v3.16: ë¹ˆ í”„ë¡œì íŠ¸ ìƒì„± ê¸°ëŠ¥, ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê¸°ì–µ ê¸°ëŠ¥ ì¶”ê°€ ë° UX ê°œì„ 
        // ===================================================================================
        const CONFIG = {
            DB_NAME: 'ILS_V3_DB', DB_VERSION: 1,
            STORES: { PROJECTS: 'projects', CONTENTS: 'contents', CATEGORIES: 'categories', USER_PROFILE: 'userProfile' },
            EXPORT_TYPE_ID: 'ILS_PROJECT_EXPORT_V2',
            LEVEL_THRESHOLDS: [0, 1000, 2500, 5000, 10000, 20000, 40000, 80000, 160000, 320000],
            QUIZ_TYPE: { MULTIPLE_CHOICE: 'multiple_choice', SHORT_ANSWER: 'short_answer', SUBJECTIVE: 'subjective', CASE_BASED: 'case_based' },
            DEFAULT_PROJECT_SETTINGS: {}
        };

        const state = {
            currentView: 'dashboard', projects: [], categories: [], tags: [],
            userProfile: { id: 'main', level: 1, xp: 0 }, activeProjectId: null, activeProject: null,
            activeChapterPath: null, activeChapterContent: null,
            activeContentsMap: new Map(), workspaceMode: 'view', quizState: null, tocCollapseState: {},
            currentFilter: { type: 'dashboard', id: null }, currentSortOrder: 'updatedAt_desc',
            isLoading: true, isSidebarOpen: true, isMobileSidebarOpen: false, modal: { isOpen: false, type: '', data: {} },
            toasts: [], isKaTeXLoaded: false, searchResults: null,
            sidebarCollapseState: { categories: false, tags: false },
            saveStatus: 'idle', saveTimestamp: null,
            workspaceLayout: 'split',
            quizResultFilter: 'all',
            scrollPositions: {},
        };
        
        let fuse = null;

        const DB = {
            db: null,
            init() { return new Promise((resolve, reject) => { const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION); request.onerror = (e) => reject("IndexedDB error: " + e.target.error); request.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); }; request.onupgradeneeded = (e) => { const db = e.target.result; Object.values(CONFIG.STORES).forEach(name => { if (!db.objectStoreNames.contains(name)) db.createObjectStore(name, { keyPath: 'id' }); }); }; }); },
            async get(storeName, key) { return new Promise((resolve, reject) => { const req = this.db.transaction(storeName).objectStore(storeName).get(key); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
            async getAll(storeName) { return new Promise((resolve, reject) => { const req = this.db.transaction(storeName).objectStore(storeName).getAll(); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
            async put(storeName, data) { return new Promise((resolve, reject) => { const req = this.db.transaction(storeName, 'readwrite').objectStore(storeName).put(data); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
            async delete(storeName, key) { return new Promise((resolve, reject) => { const req = this.db.transaction(storeName, 'readwrite').objectStore(storeName).delete(key); req.onsuccess = () => resolve(true); req.onerror = () => reject(req.error); }); },
            async getProjectContents(projectId) { return new Promise((resolve, reject) => { const range = IDBKeyRange.bound(`${projectId}_`, `${projectId}_\uffff`); const req = this.db.transaction(CONFIG.STORES.CONTENTS).objectStore(CONFIG.STORES.CONTENTS).getAll(range); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); },
            async deleteProjectAndContents(projectId) {
                const contents = await this.getProjectContents(projectId);
                const deletePromises = contents.map(c => this.delete(CONFIG.STORES.CONTENTS, c.id));
                deletePromises.push(this.delete(CONFIG.STORES.PROJECTS, projectId));
                await Promise.all(deletePromises);
            }
        };
        
        const Utils = {
             generateId: (prefix) => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
             debounce: (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; },
             naturalSort: (a, b) => { const re = /(\d+)/g; const ax = String(a).split(re); const bx = String(b).split(re); for (let i = 0; i < Math.min(ax.length, bx.length); i++) { const aPart = ax[i]; const bPart = bx[i]; if (i % 2 === 1) { const aNum = parseInt(aPart, 10); const bNum = parseInt(bPart, 10); if (aNum !== bNum) return aNum - bNum; } else { if (aPart !== bPart) return aPart.localeCompare(bPart); } } return ax.length - bx.length; },
             formatTitle: (name) => name.replace(/\.(zip|json|html?|txt)$/i, '').replace(/^Chapter_(\d+)_/, 'Chapter $1: ').replace(/_/g, ' '),
             getAllNodePaths: (tocNode, path = []) => { if (!tocNode || !tocNode.children) return []; let paths = []; tocNode.children.forEach((child, index) => { const currentPath = [...path, index]; paths.push({ path: currentPath.join('.'), node: child }); if (child.children && child.children.length > 0) { paths = paths.concat(Utils.getAllNodePaths(child, currentPath)); } }); return paths; },
             getFlatToc: (tocNode) => Utils.getAllNodePaths(tocNode),
             getNodeByPath: (toc, path) => { if (path === null || path === undefined) return null; const parts = path.split('.').map(Number); let node = toc; for (const part of parts) { if (node && node.children && node.children[part]) { node = node.children[part]; } else { return null; } } return node; },
             getParentNodeAndIndexByPath: (toc, path) => { if (!path) return { parent: null, index: -1 }; const parts = path.split('.').map(Number); if (parts.length === 1) return { parent: toc, index: parts[0] }; const parentPath = parts.slice(0, -1).join('.'); const parent = Utils.getNodeByPath(toc, parentPath); const index = parts[parts.length - 1]; return { parent, index }; },
             normalizeTocNode: (node) => { if (!node) return; if (!node.children) { node.children = []; } if (node.children.length > 0) { node.children.forEach(Utils.normalizeTocNode); } },
             generateTocText: (node, level = 0, currentPath = '', activePath = '') => { let text = ''; if (node && node.children) { node.children.forEach((child, index) => { const path = currentPath ? `${currentPath}.${index}` : `${index}`; const isActive = path === activePath; const prefix = '  '.repeat(level); const indicator = isActive ? 'â–¶ ' : (child.children && child.children.length > 0 ? '+ ' : '- '); text += `${prefix}${indicator}${child.title}\n`; if (child.children && child.children.length > 0) { text += Utils.generateTocText(child, level + 1, path, activePath); } }); } return text; },
        };

        const View = {
            appContainerEl: document.getElementById('app-container'),
            modalEl: document.getElementById('modal-root'),
            toastEl: document.getElementById('toast-root'),
            render() { const appHtml = this.renderAppLayout(); morphdom(this.appContainerEl, `<div>${appHtml}</div>`, { childrenOnly: true, onNodeAdded: (node) => { if (node.nodeType === 1) { if (node.hasAttribute('data-lucide') || node.querySelector('[data-lucide]')) { lucide.createIcons({nodes: [node]}); } if(state.isKaTeXLoaded) Controller.applyPostRenderEffects(); } return node; } }); this.modalEl.innerHTML = this.renderModal(); this.toastEl.innerHTML = this.renderToasts(); lucide.createIcons(); Controller.applyPostRenderEffects(); Controller.bindDynamicEventListeners(); },
            renderAppLayout() { if (state.isLoading) return this.renderSpinner("ì‹œìŠ¤í…œ ë¡œë”© ì¤‘..."); if (['quiz', 'quizResult'].includes(state.currentView)) return this.renderCurrentView(); return `<aside class="sidebar ${state.isSidebarOpen ? '' : 'w-0 !p-0 !border-0'} ${state.isMobileSidebarOpen ? 'open' : ''}" id="sidebar"> ${this.renderSidebar()} </aside><div class="sidebar-overlay ${state.isMobileSidebarOpen ? 'show' : ''}" id="sidebar-overlay" data-action="close-sidebar"></div><main class="main-content">${this.renderMainHeader()}<div class="content-view" id="content-view"> ${this.renderCurrentView()} </div></main>`; },
            renderSidebar() {
                if (state.activeProjectId && state.activeProject) return this.renderProjectSidebar();
                return this.renderLibrarySidebar();
            },
            renderLibrarySidebar() {
                const {type, id} = state.currentFilter;
                const categoryListHtml = state.categories.map(c => `<li class="nav-item ${type === 'category' && id === c.id ? 'active' : ''}" data-action="filter" data-filter-type="category" data-id="${c.id}"><a><i class="icon" data-lucide="folder"></i> ${c.name}</a></li>`).join('');
                const tagListHtml = state.tags.map(t => `<li class="nav-item ${type === 'tag' && id === t.name ? 'active' : ''}" data-action="filter" data-filter-type="tag" data-id="${t.name}"><a><i class="icon" data-lucide="tag"></i> ${t.name} <span class="tag-count">${t.count}</span></a></li>`).join('');
                return `<div class="sidebar-header"><a href="#" data-action="go-dashboard" class="logo"><i data-lucide="brain-circuit"></i> í•™ìŠµ & ì €ì‘ v3.16</a></div><div class="sidebar-content"><div class="nav-section"><button class="btn" data-action="new-project" style="width: 100%;"><i data-lucide="plus"></i> ìƒˆ í”„ë¡œì íŠ¸</button></div><nav class="sidebar-nav"><div class="nav-section"><h3 class="nav-section-title">ë¼ì´ë¸ŒëŸ¬ë¦¬</h3><ul class="nav-list" id="library-list"><li class="nav-item ${type === 'dashboard' ? 'active' : ''}" data-action="filter" data-filter-type="dashboard"><a><i class="icon" data-lucide="layout-dashboard"></i> ëŒ€ì‹œë³´ë“œ</a></li><li class="nav-item ${type === 'all' ? 'active' : ''}" data-action="filter" data-filter-type="all"><a><i class="icon" data-lucide="files"></i> ëª¨ë“  í”„ë¡œì íŠ¸</a></li></ul></div><div class="nav-section"><div class="flex justify-between items-center p-2"><h3 class="nav-section-title mb-0">ì¹´í…Œê³ ë¦¬</h3><button data-action="toggle-sidebar-section" data-section="categories" title="ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í´ê¸°" class="text-slate-400 hover:text-slate-600"><i data-lucide="${state.sidebarCollapseState.categories ? 'chevron-right' : 'chevron-down'}" class="w-4 h-4"></i></button></div>${!state.sidebarCollapseState.categories ? `<ul class="nav-list" id="category-list">${categoryListHtml}</ul>` : ''}</div><div class="nav-section"><div class="flex justify-between items-center p-2"><h3 class="nav-section-title mb-0">íƒœê·¸</h3><button data-action="toggle-sidebar-section" data-section="tags" title="íƒœê·¸ ì ‘ê¸°/í´ê¸°" class="text-slate-400 hover:text-slate-600"><i data-lucide="${state.sidebarCollapseState.tags ? 'chevron-right' : 'chevron-down'}" class="w-4 h-4"></i></button></div>${!state.sidebarCollapseState.tags ? `<ul class="nav-list" id="tag-list">${tagListHtml}</ul>` : ''}</div></nav></div><div class="sidebar-footer">${this.renderUserProfile()}</div>`;
            },
            renderProjectSidebar() {
                const tocControls = `<div class="flex justify-end gap-2 px-2 pb-2"><button class="btn btn-secondary btn-sm text-xs" data-action="toggle-toc-all" data-mode="expand">ì „ì²´ í¼ì¹˜ê¸°</button><button class="btn btn-secondary btn-sm text-xs" data-action="toggle-toc-all" data-mode="collapse">ì „ì²´ ì ‘ê¸°</button></div>`;
                return `<div class="sidebar-header"><button data-action="go-dashboard" class="btn btn-secondary w-full text-sm"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ëŒì•„ê°€ê¸°</button></div><div class="sidebar-content"><h3 class="nav-section-title">${state.activeProject.name} ëª©ì°¨</h3>${tocControls}${this.renderToc(state.activeProject.toc)}</div><div class="sidebar-footer">${this.renderUserProfile()}</div>`;
            },
            renderUserProfile() {
                const { level, xp } = state.userProfile; const currentLevelXP = CONFIG.LEVEL_THRESHOLDS[level - 1] || 0; const nextLevelXP = CONFIG.LEVEL_THRESHOLDS[level] || xp; const xpForLevel = nextLevelXP - currentLevelXP; const currentXPInLevel = xp - currentLevelXP; const progress = xpForLevel > 0 ? Math.round((currentXPInLevel / xpForLevel) * 100) : 100;
                return `<div class="flex items-center space-x-4"><div class="font-semibold text-sm text-slate-600">LV. <span class="text-indigo-600 font-bold text-base">${level}</span></div><div class="w-full" title="${xp} XP"><div class="bg-slate-200 rounded-full h-2.5"><div class="xp-bar-inner h-2.5 rounded-full" style="width: ${progress}%"></div></div></div></div>`;
            },
            renderMainHeader() {
                const title = this.getHeaderTitle();
                const isProjectListView = state.currentView === 'project_list';
                const workspaceControls = state.currentView === 'workspace' && state.activeProjectId ? `<button data-action="manage-toc" class="btn btn-secondary btn-sm"><i data-lucide="list-tree" class="w-4 h-4 mr-2"></i>ëª©ì°¨ ê´€ë¦¬</button><button data-action="open-settings" class="btn btn-secondary btn-sm"><i data-lucide="settings" class="w-4 h-4 mr-2"></i>ì„¤ì •</button>`: '';
                
                let saveStatusIndicator = '';
                if(state.saveStatus === 'saving') {
                    saveStatusIndicator = `<div class="flex items-center gap-2 text-sm text-slate-500"><div class="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div> ì €ì¥ ì¤‘...</div>`;
                } else if (state.saveStatus === 'saved' && state.saveTimestamp) {
                    saveStatusIndicator = `<div class="flex items-center gap-2 text-sm text-green-600"><i data-lucide="check" class="w-4 h-4"></i> ë§ˆì§€ë§‰ ì €ì¥: ${state.saveTimestamp.toLocaleTimeString()}</div>`;
                }

                return `<header class="main-header"><button id="sidebar-toggle" class="mr-4" data-action="toggle-sidebar"><i data-lucide="menu"></i></button><h1 class="header-title">${title}</h1><div class="flex items-center gap-4">${saveStatusIndicator}<div class="relative"><input type="text" class="search-input" id="search-input" placeholder="í”„ë¡œì íŠ¸ ê²€ìƒ‰..." value="${state.searchResults ? document.getElementById('search-input')?.value || '' : ''}"><i class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" data-lucide="search"></i></div><div class="header-controls" style="${isProjectListView ? '' : 'display:none;'}"><select id="sort-select" data-action="sort-projects" class="btn btn-secondary btn-sm"><option value="updatedAt_desc" ${state.currentSortOrder === 'updatedAt_desc' ? 'selected' : ''}>ìµœê·¼ ìˆ˜ì •ìˆœ</option><option value="createdAt_desc" ${state.currentSortOrder === 'createdAt_desc' ? 'selected' : ''}>ìµœì‹  ìƒì„±ìˆœ</option><option value="name_asc" ${state.currentSortOrder === 'name_asc' ? 'selected' : ''}>ì´ë¦„ (ê°€ë‚˜ë‹¤ìˆœ)</option></select></div>${workspaceControls}</div></header>`;
            },
            getHeaderTitle() { if (state.currentView === 'workspace' && state.activeProject) return state.activeProject.name; const { type, id } = state.currentFilter; if (type === 'dashboard') return 'ëŒ€ì‹œë³´ë“œ'; if (type === 'all' || state.searchResults) return 'ëª¨ë“  í”„ë¡œì íŠ¸'; if (type === 'category') return state.categories.find(c => c.id === id)?.name || 'ì¹´í…Œê³ ë¦¬'; if (type === 'tag') return `#${id}`; return 'í•™ìŠµ ë° ì €ì‘ ì‹œìŠ¤í…œ'; },
            renderCurrentView() { switch(state.currentView) { case 'dashboard': return this.renderDashboard(); case 'project_list': return this.renderProjectList(); case 'workspace': return this.renderWorkspace(); case 'quiz': return this.renderQuizView(); case 'quizResult': return this.renderQuizResultView(); default: return `<div class="text-center p-8 text-slate-500">ë·°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>`; } },
            renderDashboard() {
                const recentProjects = [...state.projects].sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0)).slice(0,5);
                const statItem = (value, label, filterType, id = null) => `
                    <a href="#" class="text-center block hover:bg-slate-50 p-2 rounded-lg" data-action="filter" data-filter-type="${filterType}" ${id ? `data-id="${id}"` : ''}>
                        <div class="text-3xl font-bold">${value}</div>
                        <div class="text-sm text-slate-500">${label}</div>
                    </a>
                `;
                return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="p-6 bg-white rounded-lg shadow-sm"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">ë¹ ë¥¸ ì‘ì—…</h3></div><div class="grid grid-cols-2 gap-4"><button class="btn" data-action="new-project"><i data-lucide="plus"></i> ìƒˆ í”„ë¡œì íŠ¸</button><button class="btn btn-secondary" data-action="new-category"><i data-lucide="folder-plus"></i> ìƒˆ ì¹´í…Œê³ ë¦¬</button></div></div><div class="p-6 bg-white rounded-lg shadow-sm"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">ê°œìš”</h3></div><div class="flex justify-around">${statItem(state.projects.length, 'í”„ë¡œì íŠ¸', 'all')}${statItem(state.categories.length, 'ì¹´í…Œê³ ë¦¬', 'category')}${statItem(state.tags.length, 'íƒœê·¸', 'tag')}</div></div><div class="p-6 bg-white rounded-lg shadow-sm md:col-span-2 lg:col-span-1"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">ìµœê·¼ í”„ë¡œì íŠ¸</h3></div><ul class="divide-y divide-slate-100">${recentProjects.map(p => `<li class="py-2 flex justify-between items-center hover:bg-slate-50 rounded-md"><a href="#" data-action="open-project" data-id="${p.id}" class="flex-grow min-w-0"><p class="font-medium truncate">${p.name}</p><p class="text-xs text-slate-500">${new Date(p.updatedAt || p.createdAt).toLocaleString()}</p></a><button data-action="open-project" data-id="${p.id}"><i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i></button></li>`).join('') || '<li class="p-4 text-center text-slate-500">ìµœê·¼ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</li>'}</ul></div></div>`; 
            },
            renderProjectList() { let filtered = Controller.getFilteredAndSortedProjects(); if (filtered.length === 0) { return `<div class="text-center p-8 text-slate-500">í‘œì‹œí•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; } return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${filtered.map(p => this.getProjectCardHTML(p)).join('')}</div>`; },
            getProjectCardHTML(p) { const category = p.categoryId ? state.categories.find(c => c.id === p.categoryId) : null; const noteCount = p.toc && p.toc.children ? Utils.getAllNodePaths(p.toc).length : 0; return `<div class="project-card flex flex-col"><div class="project-card-content flex-grow" data-action="open-project" data-id="${p.id}"><p class="text-sm text-indigo-600 font-semibold">${category ? category.name : 'ë¯¸ë¶„ë¥˜'}</p><h3 class="mt-1 text-lg leading-tight font-bold text-black">${p.name}</h3><div class="mt-2 flex flex-wrap gap-2">${(p.tags || []).map(tag => `<span class="inline-block bg-slate-200 text-slate-600 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">#${tag}</span>`).join('')}</div></div><div class="border-t mt-4 pt-4 flex justify-between items-center"><p class="text-sm text-slate-500">${noteCount}ê°œì˜ ë…¸íŠ¸</p><div class="flex space-x-2"><button data-action="export-project" data-id="${p.id}" title="ë‚´ë³´ë‚´ê¸°" class="p-2 text-slate-500 hover:bg-slate-200 rounded-full"><i data-lucide="download" class="w-4 h-4"></i></button><button data-action="delete-project-confirm" data-id="${p.id}" title="ì‚­ì œ" class="p-2 text-slate-500 hover:bg-red-100 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button></div></div></div>`; },
            renderWorkspace() { 
                if (!state.activeProject) return this.renderSpinner("í”„ë¡œì íŠ¸ ë¡œë”© ì¤‘...");
                const allNodes = Utils.getFlatToc(state.activeProject.toc);
                const currentIndex = allNodes.findIndex(c => c.path === state.activeChapterPath);
                const hasPrev = currentIndex > 0;
                const hasNext = currentIndex !== -1 && currentIndex < allNodes.length - 1;
                const navButton = (action, icon, disabled) => `<button data-action="${action}" class="p-2 rounded-full hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed" ${disabled ? 'disabled' : ''}><i data-lucide="${icon}" class="w-5 h-5 text-slate-600"></i></button>`;
                
                return `<div>
                    <div class="flex items-center gap-2 mb-4">
                        ${navButton('prev-chapter', 'chevron-left', !hasPrev)}
                        <div class="flex-grow">${this.renderBreadcrumbs()}</div>
                        ${navButton('next-chapter', 'chevron-right', !hasNext)}
                    </div>
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="border-b border-slate-200">
                            <nav class="-mb-px flex space-x-2 sm:space-x-8 px-4 sm:px-6 overflow-x-auto" aria-label="Tabs">
                                ${this.renderModeTab('write', 'pen-square', 'AI ê¸€ì“°ê¸°')}
                                ${this.renderModeTab('view', 'eye', 'ë³´ê¸°')}
                                ${this.renderModeTab('learn', 'graduation-cap', 'í•™ìŠµ')}
                                ${this.renderModeTab('translate', 'languages', 'ë²ˆì—­')}
                                ${this.renderModeTab('custom', 'wand-sparkles', 'ì»¤ìŠ¤í…€ ë²„íŠ¼')}
                            </nav>
                        </div>
                        <div id="workspace-main-content" class="p-4 sm:p-6 min-h-[70vh] overflow-y-auto">${this.renderWorkspacePanel()}</div>
                    </div>
                </div>`; 
            },
            renderBreadcrumbs() {
                if (!state.activeChapterPath) return '<div class="bg-slate-100 rounded-lg p-2.5 h-[44px] flex items-center"><span class="text-sm text-slate-500">ë…¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</span></div>';
                const breadcrumbs = [];
                let currentPath = ''; let currentNode = state.activeProject.toc;
                state.activeChapterPath.split('.').forEach((part) => {
                    currentNode = currentNode.children[part];
                    currentPath = currentPath ? `${currentPath}.${part}` : `${part}`;
                    breadcrumbs.push({ title: currentNode.title, path: currentPath });
                });
                const items = breadcrumbs.map((crumb, index) => {
                    const isLast = index === breadcrumbs.length - 1;
                    const textColor = isLast ? 'text-slate-700 font-semibold' : 'text-slate-500 hover:text-indigo-600';
                    return `<li class="flex items-center"><a href="#" data-action="select-chapter" data-path="${crumb.path}" class="text-sm ${textColor}">${crumb.title}</a>${!isLast ? `<i data-lucide="chevron-right" class="h-4 w-4 text-slate-400 mx-1"></i>` : ''}</li>`;
                }).join('');
                return `<nav class="bg-slate-100 rounded-lg p-2.5"><ol class="flex items-center flex-wrap">${items}</ol></nav>`;
            },
            renderToc(toc, level = 0, pathPrefix = '') { if (!toc?.children?.length) return level === 0 ? `<p class="text-sm text-slate-500 p-2">ëª©ì°¨ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>` : ''; const items = toc.children.map((item, index) => { const currentPath = pathPrefix ? `${pathPrefix}.${index}` : `${index}`; const hasChildren = item.children && item.children.length > 0; const isCollapsed = state.tocCollapseState[currentPath]; const content = state.activeContentsMap.get(`${state.activeProjectId}_${currentPath}`); let statusIndicator = ''; if (content?.status && content.status !== 'empty') { const colorMap = { 'prompt-copied': 'bg-blue-400', 'manuscript-done': 'bg-yellow-400', 'quiz-done': 'bg-green-400' }; if (colorMap[content.status]) statusIndicator = `<span class="w-2 h-2 rounded-full ${colorMap[content.status]} mr-2 flex-shrink-0" title="ìƒíƒœ: ${content.status}"></span>`; } return `<li class="my-1 toc-item ${state.activeChapterPath === currentPath ? 'active' : ''}"><div class="flex items-center" style="padding-left: ${level * 1}rem;"><a href="#" data-action="select-chapter" data-path="${currentPath}" class="flex-grow flex items-center p-2 rounded-md text-sm text-slate-700 hover:bg-slate-100 relative w-full">${hasChildren ? `<button data-action="toggle-toc-collapse" data-path="${currentPath}" class="p-1 rounded-md hover:bg-slate-200 flex-shrink-0 mr-1"><i data-lucide="${isCollapsed ? 'chevron-right' : 'chevron-down'}" class="w-4 h-4 text-slate-500"></i></button>` : `<span class="w-6 mr-1"></span>`}${statusIndicator} <span class="truncate">${item.title}</span></a></div>${hasChildren && !isCollapsed ? `<ul class="mt-1">${this.renderToc(item, level + 1, currentPath)}</ul>` : ''}</li>`; }).join(''); return `<ul class="nav-list">${items}</ul>`;},
            renderModeTab: (mode, icon, label) => { const isActive = state.workspaceMode === mode; return `<button data-action="switch-mode" data-mode="${mode}" class="${isActive ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'} group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm flex-shrink-0"><i data-lucide="${icon}" class="${isActive ? 'text-indigo-500' : 'text-slate-400 group-hover:text-slate-500'} -ml-0.5 mr-2 h-5 w-5"></i><span>${label}</span></button>`; },
            renderWorkspacePanel() { if (!state.activeChapterPath) { return `<div class="flex flex-col items-center justify-center h-full min-h-[60vh] text-center p-4"><i data-lucide="file-text" class="h-16 w-16 text-slate-300"></i><h3 class="mt-4 text-xl font-semibold text-slate-800">ë…¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3><p class="mt-1 text-slate-500">ì¢Œì¸¡ ëª©ì°¨ì—ì„œ ì‘ì—…í•  ë…¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p></div>`; } if (!state.activeChapterContent) { return this.renderSpinner("ë…¸íŠ¸ ë‚´ìš© ë¡œë”© ì¤‘..."); } switch (state.workspaceMode) { case 'view': return this.renderViewPanel(); case 'write': return this.renderWritePanel(); case 'learn': return this.renderLearnPanel(); case 'translate': return this.renderTranslatePanel(); case 'custom': return this.renderCustomButtonPanel(); default: return `<div>ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë“œì…ë‹ˆë‹¤.</div>`; } },
            renderViewPanel() {
    const content = state.activeChapterContent;
    // ğŸ’¡ í—ˆìš©í•  HTML íƒœê·¸ ëª©ë¡ì„ ë³€ìˆ˜ë¡œ ë§Œë“¤ì–´ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
    const allowedTagsConfig = {
        ALLOWED_TAGS: ['strong', 'b', 'em', 'i', 'p', 'br', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a', 'img', 'code', 'pre', 'blockquote']
    };

    const manuscriptHtml = content.manuscript 
        ? `<h3 class="text-xl font-semibold mb-4 text-slate-800 border-b pb-2">ì›ê³  ë³´ê¸°</h3><div class="prose prose-custom prose-readable max-w-full">${marked.parse(DOMPurify.sanitize(content.manuscript, allowedTagsConfig))}</div>`
        : `<div class="text-center text-slate-500 py-16"><p>í‘œì‹œí•  ì›ê³  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;

    let translationHtml = '';
    if (content.translation && content.translation.trim()) {
        // ğŸ’¡ ë²ˆì—­ë¬¸ ë¶€ë¶„ì—ë„ ê°™ì€ ì„¤ì •ìœ¼ë¡œ sanitizeë¥¼ ì ìš©í•©ë‹ˆë‹¤.
        const sanitizedTranslation = DOMPurify.sanitize(content.translation, allowedTagsConfig);
        const paragraphs = sanitizedTranslation.split(/\n+/).filter(p => p.trim() !== '');
        // ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•œ <b> íƒœê·¸ê°€ í—ˆìš© ëª©ë¡ì— ìˆìœ¼ë¯€ë¡œ ì´ì œ ì œê±°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        const boldedParagraphs = paragraphs.map(p => `<p><b>${p}</b></p>`).join('');
        
        translationHtml = `
            <h3 class="text-xl font-semibold mb-4 mt-8 text-slate-800 border-b pb-2">ë²ˆì—­ë¬¸ ë³´ê¸°</h3>
            <div class="prose prose-custom prose-readable max-w-full">
                ${boldedParagraphs}
            </div>
        `;
    }

    return `<div>${manuscriptHtml}${translationHtml}</div>`;
},
            renderWritePanel() {
                const content = state.activeChapterContent; 
                const layout = state.workspaceLayout;
                const leftClasses = (layout === 'right') ? 'hidden' : '';
                const rightClasses = (layout === 'left') ? 'hidden' : '';
                const gridClasses = (layout === 'split') ? 'lg:grid-cols-2' : 'lg:grid-cols-1';

                const controls = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex-grow flex justify-center">
                            <div class="inline-flex rounded-md shadow-sm">
                                <button data-action="set-workspace-layout" data-layout="left" title="ì›ê³ ë§Œ ë³´ê¸°" class="px-3 py-1 text-sm font-medium ${layout === 'left' ? 'bg-indigo-100 text-indigo-700' : 'bg-white'} border border-slate-300 rounded-l-md hover:bg-slate-50"><i data-lucide="sidebar-open" class="w-4 h-4"></i></button>
                                <button data-action="set-workspace-layout" data-layout="split" title="ì–‘ìª½ ë³´ê¸°" class="px-3 py-1 text-sm font-medium ${layout === 'split' ? 'bg-indigo-100 text-indigo-700' : 'bg-white'} border-t border-b border-slate-300 hover:bg-slate-50"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                                <button data-action="set-workspace-layout" data-layout="right" title="ì„¤ëª…ë§Œ ë³´ê¸°" class="px-3 py-1 text-sm font-medium ${layout === 'right' ? 'bg-indigo-100 text-indigo-700' : 'bg-white'} border border-slate-300 rounded-r-md hover:bg-slate-50"><i data-lucide="sidebar-close" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <button data-action="copy-writing-prompt" class="btn btn-secondary p-2" title="AI ê¸€ì“°ê¸° í”„ë¡¬í”„íŠ¸ ë³µì‚¬"><i data-lucide="copy" class="w-5 h-5"></i></button>
                    </div>`;

                return `<div>${controls}<div class="grid grid-cols-1 ${gridClasses} gap-6 h-full"><div class="${leftClasses} flex flex-col h-full"><label for="manuscript" class="block text-sm font-medium text-slate-700 mb-2">ì›ê³  (Markdown)</label><textarea id="manuscript" data-field="manuscript" class="w-full flex-grow p-4 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 h-[60vh]">${content.manuscript || ''}</textarea></div><div class="${rightClasses} flex flex-col h-full"><label for="notes" class="block text-sm font-medium text-slate-700 mb-2">ì±•í„° ì„¤ëª… (AI í”„ë¡¬í”„íŠ¸ìš©) <span class="tooltip"><i data-lucide="help-circle" class="w-4 h-4 inline-block text-slate-400"></i><span class="tooltip-text">ì´ê³³ì— ì…ë ¥ëœ ë‚´ìš©ì€ AI ê¸€ì“°ê¸° í”„ë¡¬í”„íŠ¸ì˜ '{{chapterDescription}}' ë³€ìˆ˜ë¡œ ì‚¬ìš©ë˜ì–´ AIê°€ ê¸€ì„ ì‘ì„±í•˜ëŠ” ë° í•µì‹¬ì ì¸ ë§¥ë½ì„ ì œê³µí•©ë‹ˆë‹¤.</span></span></label><textarea id="notes" data-field="notes" class="w-full flex-grow p-4 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 h-[60vh]">${content.notes || ''}</textarea></div></div></div>`;
            },
            renderLearnPanel() { const hasQuestions = state.activeChapterContent?.questions?.length > 0; return `<div class="flex flex-col items-center justify-center h-full text-center min-h-[60vh]"><i data-lucide="lightbulb" class="h-12 w-12 text-slate-400"></i><h4 class="mt-4 text-lg font-semibold text-slate-700">ì§€ì‹ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”</h4><p class="mt-1 text-sm text-slate-500">í•™ìŠµí•œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í€´ì¦ˆë¥¼ í’€ì–´ë³´ì„¸ìš”.</p><div class="mt-6 flex flex-col space-y-3 w-full max-w-xs"><button data-action="start-quiz" class="btn w-full justify-center" ${!hasQuestions ? 'disabled' : ''}>í€´ì¦ˆ ì‹œì‘ (${hasQuestions ? state.activeChapterContent.questions.length : 0}ë¬¸ì œ)</button><button data-action="manage-quiz" class="btn btn-secondary w-full justify-center">í€´ì¦ˆ ê´€ë¦¬</button><button data-action="generate-quiz" class="btn btn-secondary w-full justify-center"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>AIë¡œ ë¬¸ì œ ì¶”ê°€</button></div>${!hasQuestions ? '<p class="mt-2 text-xs text-slate-400">í€´ì¦ˆë¥¼ ì§„í–‰í•˜ë ¤ë©´ ë¬¸ì œë¥¼ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>' : ''}</div>`;},
            renderTranslatePanel() {
                const content = state.activeChapterContent;
                const layout = state.workspaceLayout;
                const sourceText = content.manuscript ? marked.parse(content.manuscript) : '<p>ë²ˆì—­í•  ì›ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                const leftClasses = (layout === 'right') ? 'hidden' : '';
                const rightClasses = (layout === 'left') ? 'hidden' : '';
                const gridClasses = (layout === 'split') ? 'lg:grid-cols-2' : 'lg:grid-cols-1';

                 const controls = `
                    <div class="flex justify-between items-center mb-4">
                        <button data-action="open-split-chapter-modal" class="btn btn-secondary p-2" title="ë²ˆì—­ë¬¸ ë¶„í• "><i data-lucide="git-fork" class="w-5 h-5"></i></button>
                        <div class="flex-grow flex justify-center">
                            <div class="inline-flex rounded-md shadow-sm">
                                <button data-action="set-workspace-layout" data-layout="left" title="ì›ë¬¸ë§Œ ë³´ê¸°" class="px-3 py-1 text-sm font-medium ${layout === 'left' ? 'bg-indigo-100 text-indigo-700' : 'bg-white'} border border-slate-300 rounded-l-md hover:bg-slate-50"><i data-lucide="sidebar-open" class="w-4 h-4"></i></button>
                                <button data-action="set-workspace-layout" data-layout="split" title="ì–‘ìª½ ë³´ê¸°" class="px-3 py-1 text-sm font-medium ${layout === 'split' ? 'bg-indigo-100 text-indigo-700' : 'bg-white'} border-t border-b border-slate-300 hover:bg-slate-50"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                                <button data-action="set-workspace-layout" data-layout="right" title="ë²ˆì—­ë¬¸ë§Œ ë³´ê¸°" class="px-3 py-1 text-sm font-medium ${layout === 'right' ? 'bg-indigo-100 text-indigo-700' : 'bg-white'} border border-slate-300 rounded-r-md hover:bg-slate-50"><i data-lucide="sidebar-close" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <button data-action="copy-translation-prompt" class="btn btn-secondary p-2" title="ë²ˆì—­ í”„ë¡¬í”„íŠ¸ ë³µì‚¬"><i data-lucide="copy" class="w-5 h-5"></i></button>
                    </div>`;

                return `<div>${controls}<div class="grid grid-cols-1 ${gridClasses} gap-6"><div class="${leftClasses} h-[60vh] flex flex-col"><h3 class="text-lg font-semibold mb-2 text-slate-800">ì›ë¬¸</h3><div class="prose prose-custom flex-grow overflow-y-auto p-4 border rounded-md bg-slate-50">${sourceText}</div></div><div class="${rightClasses} h-[60vh] flex flex-col"><h3 class="text-lg font-semibold mb-2 text-slate-800">ë²ˆì—­ë¬¸</h3><textarea id="translation" data-field="translation" class="w-full flex-grow p-4 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">${content.translation || ''}</textarea></div></div></div>`;
            },
            renderCustomButtonPanel() {
                const customPrompts = state.activeProject.settings.customPrompts || [];
                if (customPrompts.length === 0) {
                    return `<div class="flex flex-col items-center justify-center h-full min-h-[60vh] text-center p-4">
                        <i data-lucide="wand-sparkles" class="h-16 w-16 text-slate-300"></i>
                        <h3 class="mt-4 text-xl font-semibold text-slate-800">ì»¤ìŠ¤í…€ ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="mt-1 text-slate-500">í”„ë¡œì íŠ¸ ì„¤ì •ì—ì„œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ë²„íŠ¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
                        <button class="btn mt-6" data-action="open-settings"><i data-lucide="settings" class="w-4 h-4 mr-2"></i>ì„¤ì •ìœ¼ë¡œ ì´ë™</button>
                    </div>`;
                }
                const buttonsHtml = customPrompts.map((prompt, index) => {
                    return `<button class="btn btn-secondary" data-action="copy-custom-prompt" data-index="${index}">
                        <i data-lucide="copy" class="w-4 h-4 mr-2"></i>
                        <span>${DOMPurify.sanitize(prompt.name)}</span>
                    </button>`;
                }).join('');
                return `<div class="p-4">
                    <h3 class="text-xl font-semibold mb-4 text-slate-800 border-b pb-2">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ë²„íŠ¼</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${buttonsHtml}
                    </div>
                </div>`;
            },
            renderSpinner: (message) => `<div class="flex items-center justify-center h-full"><div class="text-center"><svg class="mx-auto h-12 w-12 text-slate-400 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><h2 class="mt-4 text-lg font-medium text-slate-900">${message}</h2></div></div>`,
            renderModal() { if (!state.modal.isOpen) return ''; let contentHtml = ''; switch(state.modal.type) { case 'newProject': contentHtml = this.renderNewProjectModal(); break; case 'confirm': contentHtml = this.renderConfirmModal(); break; case 'settings': contentHtml = this.renderSettingsModal(); break; case 'apiKey': contentHtml = this.renderApiKeyModal(); break; case 'manageQuiz': contentHtml = this.renderManageQuizModal(); break; case 'manageToc': contentHtml = this.renderManageTocModal(); break; case 'splitChapter': contentHtml = this.renderSplitChapterModal(); break; } return `<div class="modal-overlay show" data-action="close-modal-overlay"><div class="modal-container">${contentHtml}</div></div>`;},
            renderNewProjectModal() { 
                const { activeTab = 'blank', isLoading = false, loadingMessage = '', error = '' } = state.modal.data;
                if(isLoading) {
                    return `<div class="p-8">${this.renderSpinner(loadingMessage)}</div>`;
                }

                const tabButton = (id, label) => `<button type="button" data-action="switch-modal-tab" data-tab="${id}" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === id ? 'bg-indigo-100 text-indigo-700' : 'text-slate-500 hover:bg-slate-100'}">${label}</button>`; 
                const fileInputTemplate = (id, accept, labelId, description) => `<p class="text-sm text-slate-600 mb-2">${description}</p><label for="${id}" class="cursor-pointer"><div data-dropzone-for="${id}" class="drop-zone w-full p-8 rounded-lg text-center bg-slate-50 hover:bg-slate-100"><div class="flex flex-col items-center justify-center space-y-2 pointer-events-none"><i data-lucide="upload-cloud" class="w-12 h-12 text-slate-400"></i><p class="text-slate-700 font-medium">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ <span class="text-indigo-600">í´ë¦­í•˜ì—¬ ì„ íƒ</span>í•˜ì„¸ìš”</p><p id="${labelId}" class="text-sm text-slate-500 truncate max-w-full" title="ì„ íƒëœ íŒŒì¼ ì—†ìŒ">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</p></div><input type="file" id="${id}" accept="${accept}" class="hidden" data-target-label="${labelId}"/></div></label>`; 
                const tabContent = () => { 
                    switch(activeTab) {
                        case 'blank':
                            return `<p class="text-sm text-slate-600 mb-2">ìƒˆë¡œìš´ ë¹ˆ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</p>
                                <div>
                                    <label for="blank-project-name" class="block text-sm font-medium text-slate-700">í”„ë¡œì íŠ¸ ì´ë¦„</label>
                                    <input type="text" id="blank-project-name" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" required>
                                </div>
                                <div class="mt-4">
                                    <label for="blank-project-category" class="block text-sm font-medium text-slate-700">ì¹´í…Œê³ ë¦¬ (ì„ íƒ)</label>
                                    <select id="blank-project-category" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                                        <option value="">ë¯¸ë¶„ë¥˜</option>
                                        ${state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                    </select>
                                </div>`;
                        case 'zip': return fileInputTemplate('zip-upload', '.zip', 'zip-file-label', 'HTML ë˜ëŠ” TXT íŒŒì¼ë“¤ì´ í¬í•¨ëœ ZIP íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.'); 
                        case 'jsonFile': return fileInputTemplate('json-upload', '.json', 'json-file-label', 'ì´ì „ì— ë‚´ë³´ëƒˆë˜ í”„ë¡œì íŠ¸(.json) íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.'); 
                        case 'jsonText': return `<p class="text-sm text-slate-600 mb-2">í”„ë¡œì íŠ¸ ë‚´ë³´ë‚´ê¸°(.json) íŒŒì¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p><textarea id="json-text-input" placeholder='{"type": "ILS_PROJECT_EXPORT_V2", ...}' class="w-full h-40 p-2 border rounded-md font-mono text-sm"></textarea>${error ? `<p class="text-red-500 text-sm mt-2">${error}</p>` : ''}`; 
                        case 'tocJson': return `<p class="text-sm text-slate-600 mb-2">ì±…ì˜ ëª©ì°¨ êµ¬ì¡°ë¥¼ ë‚˜íƒ€ë‚´ëŠ” JSON í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p><textarea id="toc-json-input" placeholder='{"title": "ì±… ì œëª©", "children": [...] }' class="w-full h-40 p-2 border rounded-md font-mono text-sm"></textarea>${error ? `<p class="text-red-500 text-sm mt-2">${error}</p>` : ''}`; 
                    } 
                }; 
                return `<form data-action="submit-new-project"><div class="p-6"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold text-slate-900 mb-4">ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</h3><button type="button" data-action="close-modal" class="p-1 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button></div><div class="border-b border-gray-200"><div class="p-1 mb-4 inline-flex space-x-1 bg-slate-100 rounded-lg">${tabButton('blank', 'ë¹ˆ í”„ë¡œì íŠ¸')}${tabButton('zip', 'ZIP')}${tabButton('tocJson', 'ëª©ì°¨ JSON')}${tabButton('jsonFile', 'íŒŒì¼(.json)')}${tabButton('jsonText', 'í…ìŠ¤íŠ¸(.json)')}</div></div><div class="mt-4">${tabContent()}</div></div><div class="bg-slate-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" data-action="close-modal" class="btn btn-secondary">ì·¨ì†Œ</button><button type="submit" class="btn">ìƒì„±</button></div></form>`;
            },
            renderConfirmModal() { const { title, message, confirmText } = state.modal.data; return `<div class="p-6"><div class="sm:flex sm:items-start"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"><i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 class="text-lg leading-6 font-medium text-gray-900">${title}</h3><div class="mt-2"><p class="text-sm text-gray-500">${message}</p></div></div></div></div><div class="bg-slate-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" data-action="close-modal" class="btn btn-secondary">ì·¨ì†Œ</button><button type="button" data-action="confirm-action" class="btn bg-red-600 hover:bg-red-700">${confirmText}</button></div>`;},
            renderToasts() { return `<div class="fixed bottom-4 right-4 space-y-3 z-[3000]">${state.toasts.map(toast => `<div id="toast-${toast.id}" class="max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden"><div class="p-4"><div class="flex items-start"><div class="flex-shrink-0">${toast.type === 'success' ? '<i data-lucide="check-circle" class="h-6 w-6 text-green-400"></i>' : ''}${toast.type === 'error' ? '<i data-lucide="alert-circle" class="h-6 w-6 text-red-400"></i>' : ''}${toast.type === 'info' ? '<i data-lucide="info" class="h-6 w-6 text-blue-400"></i>' : ''}</div><div class="ml-3 w-0 flex-1 pt-0.5"><p class="text-sm font-medium text-gray-900">${toast.message}</p></div><div class="ml-4 flex-shrink-0 flex"><button data-action="dismiss-toast" data-id="${toast.id}" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500"><i data-lucide="x" class="h-5 w-5"></i></button></div></div></div></div>`).join('')}</div>`;},
            renderQuizView() { const { quizState } = state; if (!quizState || !quizState.questions[quizState.currentIndex]) return this.renderSpinner('í€´ì¦ˆ ë¡œë”© ì¤‘...'); const q = quizState.questions[quizState.currentIndex]; const isAnswered = quizState.answers[quizState.currentIndex] !== undefined; const renderAnswerComponent = () => { switch (q.type) { case CONFIG.QUIZ_TYPE.MULTIPLE_CHOICE: const userAnswerIndex = quizState.answers[quizState.currentIndex]?.selectedIndex; return `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">${q.options.map((opt, index) => { let classes = 'border-slate-300 hover:border-indigo-500 hover:bg-indigo-50'; if (isAnswered) { if (index === q.answerIndex) classes = 'bg-emerald-100 border-emerald-500 text-emerald-800'; else if (index === userAnswerIndex) classes = 'bg-red-100 border-red-500 text-red-800'; } return `<button data-action="submit-answer" data-index="${index}" class="w-full text-left p-4 border rounded-lg transition-colors ${classes}" ${isAnswered ? 'disabled' : ''}>${opt}</button>` }).join('')}</div>`; default: return `<form data-action="submit-text-answer" class="w-full max-w-md text-center"><textarea id="answer-input" name="answer-input" rows="4" class="w-full text-lg border-2 p-2 bg-transparent border-slate-300 rounded-md focus:outline-none focus:border-indigo-500 transition-colors" placeholder="ë‹µì•ˆì„ ì…ë ¥í•˜ì„¸ìš”..." ${isAnswered ? 'disabled' : 'autofocus'}></textarea><button type="submit" class="mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-12 rounded-lg text-lg transition-colors shadow hover:shadow-md" ${isAnswered ? 'disabled' : ''}>ì œì¶œí•˜ê³  ì •ë‹µ í™•ì¸</button></form>`; } }; const renderFeedback = () => { if (!isAnswered) return `<div class="min-h-[148px]"></div>`; const { isCorrect } = quizState.answers[quizState.currentIndex]; const feedbackClass = isCorrect ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'; const icon = isCorrect ? `<i data-lucide="check-circle" class="w-5 h-5"></i>` : `<i data-lucide="x-circle" class="w-5 h-5"></i>`; const isLastQuestion = quizState.currentIndex + 1 >= quizState.questions.length; const nextButtonText = isLastQuestion ? 'ê²°ê³¼ ë³´ê¸°' : 'ë‹¤ìŒ ë¬¸ì œ'; const nextButtonIcon = isLastQuestion ? 'flag' : 'arrow-right-circle'; let correctDisplay = ''; if (!isCorrect) correctDisplay = q.type === 'multiple_choice' ? q.options[q.answerIndex] : q.answer; return `<div class="p-4 rounded-lg mt-8 w-full max-w-3xl ${feedbackClass}"><p class="font-bold flex items-center gap-2">${icon} ${isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'ì˜¤ë‹µì…ë‹ˆë‹¤.'}</p>${!isCorrect ? `<p class="text-sm mt-2"><span class="font-semibold">ëª¨ë²” ë‹µì•ˆ:</span> ${correctDisplay}</p>` : ''}<p class="text-sm mt-2"><span class="font-semibold">í•´ì„¤:</span> ${q.explanation}</p><div class="mt-4 flex justify-end"><button data-action="next-question" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">${nextButtonText} <i data-lucide="${nextButtonIcon}" class="w-5 h-5"></i></button></div></div>`; }; const questionTypeMap = { [CONFIG.QUIZ_TYPE.MULTIPLE_CHOICE]: 'ê°ê´€ì‹', [CONFIG.QUIZ_TYPE.SHORT_ANSWER]: 'ë‹¨ë‹µí˜•', [CONFIG.QUIZ_TYPE.SUBJECTIVE]: 'ì„œìˆ í˜•', [CONFIG.QUIZ_TYPE.CASE_BASED]: 'ì‚¬ë¡€í˜•' }; return `<div class="fixed inset-0 bg-slate-50 flex flex-col z-[1000]"><header class="bg-white shadow-sm p-4 sticky top-0 z-10"><div class="flex items-center justify-between gap-4 max-w-5xl mx-auto"><div class="font-bold text-lg w-24">${quizState.currentIndex + 1} / ${quizState.questions.length}</div><div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden"><div class="bg-indigo-500 h-4 rounded-full transition-all duration-300" style="width: ${((quizState.currentIndex) / quizState.questions.length) * 100}%"></div></div><button data-action="exit-quiz" class="p-2 rounded-full hover:bg-slate-200" title="í€´ì¦ˆ ë‚˜ê°€ê¸°"><i data-lucide="x"></i></button></div></header><main class="flex-1 flex flex-col items-center justify-center p-6 text-center overflow-y-auto"><div class="w-full max-w-3xl"><p class="text-slate-500 text-sm mb-2">${questionTypeMap[q.type] || 'ë¬¸ì œ'}</p><h2 class="text-2xl md:text-3xl font-bold leading-tight">${q.questionText}</h2></div><div class="mt-12 w-full flex justify-center">${renderAnswerComponent()}</div>${renderFeedback()}</main></div>`; },
            renderQuizResultView() { 
                const { questions, answers } = state.quizState; 
                const totalQuestions = questions.length; 
                const correctCount = answers.filter(a => a.isCorrect).length; 
                const score = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;
                
                const filterControls = `
                    <div class="flex justify-center gap-4 mb-6">
                        <button data-action="set-quiz-result-filter" data-filter="all" class="btn btn-sm ${state.quizResultFilter === 'all' ? '' : 'btn-secondary'}">ì „ì²´ ë³´ê¸°</button>
                        <button data-action="set-quiz-result-filter" data-filter="incorrect" class="btn btn-sm ${state.quizResultFilter === 'incorrect' ? '' : 'btn-secondary'}">í‹€ë¦° ë¬¸í•­ë§Œ ë³´ê¸°</button>
                    </div>
                `;

                const summaryHtml = `<div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 text-center mb-8"><h2 class="text-3xl font-bold text-slate-800">í€´ì¦ˆ ê²°ê³¼</h2><p class="text-slate-600 mt-2">í•™ìŠµ ë‚´ìš©ì„ ì„±ê³µì ìœ¼ë¡œ ê²€í† í–ˆìŠµë‹ˆë‹¤!</p><div class="mt-6"><span class="text-5xl font-bold text-indigo-600">${score}</span><span class="text-xl font-medium text-slate-500">ì </span></div><p class="mt-2 font-medium text-slate-700">ì´ ${totalQuestions}ë¬¸í•­ ì¤‘ ${correctCount}ë¬¸í•­ ì •ë‹µ</p><div class="mt-8"><button data-action="back-to-workspace" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">ì‘ì—…ì‹¤ë¡œ ëŒì•„ê°€ê¸°</button></div></div>`; 
                
                const filteredQuestions = state.quizResultFilter === 'incorrect' 
                    ? questions.filter((q, index) => !answers[index].isCorrect)
                    : questions;

                const questionCardsHtml = filteredQuestions.map((q, index) => {
                    const originalIndex = state.quizResultFilter === 'incorrect' ? questions.findIndex(origQ => origQ.questionText === q.questionText) : index;
                    const userAnswerData = answers[originalIndex]; 
                    const isCorrect = userAnswerData.isCorrect; 
                    const cardClass = isCorrect ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'; 
                    let answerFeedbackHtml = ''; 
                    if (q.type === CONFIG.QUIZ_TYPE.MULTIPLE_CHOICE) { 
                        answerFeedbackHtml = q.options.map((option, optIndex) => { 
                            const isUserAnswer = optIndex === userAnswerData.selectedIndex; 
                            const isCorrectAnswer = optIndex === q.answerIndex; 
                            let classes = 'border-slate-200 bg-slate-50'; 
                            let icon = ''; 
                            if (isUserAnswer && !isCorrect) { classes = 'border-red-300 bg-red-50 text-red-800'; icon = `<i data-lucide="x-circle" class="w-5 h-5 text-red-500 mr-2 flex-shrink-0"></i>`; } 
                            if (isCorrectAnswer) { classes = 'border-green-300 bg-green-50 text-green-800 font-semibold'; icon = `<i data-lucide="check-circle" class="w-5 h-5 text-green-500 mr-2 flex-shrink-0"></i>`; } 
                            return `<div class="flex items-center p-3 mt-2 border rounded-md ${classes}">${icon}<span>${option}</span></div>`; 
                        }).join(''); 
                    } else { 
                        const userAnswerHtml = `<div class="flex items-start p-3 mt-2 border rounded-md border-red-300 bg-red-50 text-red-800"><i data-lucide="x-circle" class="w-5 h-5 text-red-500 mr-2 mt-1 flex-shrink-0"></i><p>${userAnswerData.userAnswer || '<i>ë‹µë³€ ì—†ìŒ</i>'}</p></div>`; 
                        const correctAnswerHtml = `<div class="flex items-start p-3 mt-2 border rounded-md border-green-300 bg-green-50 text-green-800"><i data-lucide="check-circle" class="w-5 h-5 text-green-500 mr-2 mt-1 flex-shrink-0"></i><p>${q.answer}</p></div>`; 
                        if (isCorrect) { answerFeedbackHtml = correctAnswerHtml; } 
                        else { answerFeedbackHtml = `<div><p class="text-sm font-semibold text-slate-600">ì œì¶œí•œ ë‹µ:</p>${userAnswerHtml}<p class="text-sm font-semibold text-slate-600 mt-3">ëª¨ë²” ë‹µì•ˆ:</p>${correctAnswerHtml}</div>`; } 
                    } 
                    return `<div class="bg-white rounded-lg shadow p-6 mb-6 ${cardClass}"><p class="font-semibold text-slate-800">${originalIndex + 1}. ${q.questionText}</p><div class="mt-4">${answerFeedbackHtml}</div><div class="mt-4 p-3 bg-slate-100 rounded-md text-sm text-slate-700"><p><span class="font-bold">í•´ì„¤:</span> ${q.explanation}</p></div></div>`; 
                }).join(''); 
                
                return `<div class="fixed inset-0 bg-slate-50 flex flex-col z-[1000] overflow-y-auto"><header class="bg-white shadow-sm p-4 sticky top-0 z-10"><div class="max-w-4xl mx-auto text-center text-2xl font-bold">í€´ì¦ˆ ê²°ê³¼</div></header><main class="flex-grow w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">${summaryHtml}<h3 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-3">ë¬¸í•­ë³„ ë‹¤ì‹œë³´ê¸°</h3>${filterControls}${questionCardsHtml}</main></div>`;
            },
            renderSettingsModal() {
                const settings = state.activeProject.settings;
                const categoryOptions = state.categories.map(c => `<option value="${c.id}" ${c.id === settings.categoryId ? 'selected' : ''}>${c.name}</option>`).join('');
                const tagPills = (state.modal.data.projectTags || []).map(tag => `<span class="inline-flex items-center gap-x-0.5 rounded-md bg-indigo-50 px-2 py-1 text-xs font-medium text-indigo-700">${tag}<button type="button" data-action="remove-tag" data-tag="${tag}" class="group relative -mr-1 h-3.5 w-3.5 rounded-sm hover:bg-indigo-500/20"><i data-lucide="x" class="h-3.5 w-3.5 text-indigo-600 hover:text-indigo-700"></i></button></span>`).join('');

                const generalFields = [
                    { id: 'name', label: 'í”„ë¡œì íŠ¸ ì´ë¦„', value: state.modal.data.projectName, type: 'text' },
                    { id: 'categoryId', label: 'ì¹´í…Œê³ ë¦¬', type: 'select', options: categoryOptions },
                    { id: 'tags', label: 'íƒœê·¸', type: 'tags', pills: tagPills }
                ];
                
                const promptFields = [
                    { id: 'writingGenre', label: 'ê¸€ì“°ê¸° - ì¥ë¥´', value: settings.writingGenre, type: 'text' },
                    { id: 'writingAudience', label: 'ê¸€ì“°ê¸° - ëª©í‘œ ë…ì', value: settings.writingAudience, type: 'text' },
                    { id: 'writingAgeGroup', label: 'ê¸€ì“°ê¸° - ëŒ€ìƒ ì—°ë ¹ì¸µ', value: settings.writingAgeGroup, type: 'text' },
                    { id: 'writingStyle', label: 'ê¸€ì“°ê¸° - ìŠ¤íƒ€ì¼', value: settings.writingStyle, type: 'textarea' },
                    { id: 'writingReferences', label: 'ê¸€ì“°ê¸° - ìë£Œ', value: settings.writingReferences, type: 'textarea' },
                    { id: 'writingPrompt', label: 'ê¸€ì“°ê¸° í”„ë¡¬í”„íŠ¸ - ì „ì²´ í…œí”Œë¦¿', value: settings.writingPrompt, type: 'textarea' },
                    { id: 'quizQuestionCount', label: 'í€´ì¦ˆ - ìƒì„± ê°œìˆ˜', value: settings.quizQuestionCount, type: 'number' },
                    { id: 'quizTaskDescription', label: 'í€´ì¦ˆ í”„ë¡¬í”„íŠ¸ - ê³¼ì—… ì„¤ëª… (Task)', value: settings.quizTaskDescription, type: 'textarea' },
                    { id: 'quizOutputFormatInstruction', label: 'í€´ì¦ˆ í”„ë¡¬í”„íŠ¸ - ì¶œë ¥ í˜•ì‹ (Output)', value: settings.quizOutputFormatInstruction, type: 'textarea' },
                    { id: 'quizPromptTemplate', label: 'í€´ì¦ˆ í”„ë¡¬í”„íŠ¸ - ì „ì²´ í…œí”Œë¦¿', value: settings.quizPromptTemplate, type: 'textarea' },
                ];

                const renderFields = (fields) => fields.map(f => {
                    let fieldHtml = '';
                    switch (f.type) {
                        case 'select': fieldHtml = `<select id="setting-${f.id}" data-setting-key="${f.id}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"><option value="">ë¯¸ë¶„ë¥˜</option>${f.options}</select>`; break;
                        case 'textarea': fieldHtml = `<textarea id="setting-${f.id}" data-setting-key="${f.id}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 h-32 font-mono text-xs">${f.value}</textarea>`; break;
                        case 'tags': fieldHtml = `<div class="relative"><input type="text" id="setting-tags-input" autocomplete="off" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter..."><div id="tag-suggestions" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md shadow-lg mt-1 hidden"></div><div id="tag-pills-container" class="mt-2 flex flex-wrap gap-2">${f.pills}</div></div>`; break;
                        default: fieldHtml = `<input type="${f.type}" id="setting-${f.id}" data-setting-key="${f.id}" value="${DOMPurify.sanitize(f.value)}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">`;
                    }
                    return `<div class="mb-4"><label for="setting-${f.id}" class="block text-sm font-medium text-slate-700">${f.label}</label>${fieldHtml}</div>`;
                }).join('');

                const customPrompts = state.modal.data.customPrompts || [];
                const customPromptsHtml = customPrompts.map((prompt, index) => `
                    <div class="p-4 border border-slate-200 rounded-lg mb-4 bg-slate-50" data-prompt-id="${prompt.id}">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="text-sm font-semibold text-slate-800">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ #${index + 1}</h5>
                            <button type="button" data-action="remove-custom-prompt" data-id="${prompt.id}" class="p-1 rounded-full hover:bg-red-100 text-red-500">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="mb-2">
                            <label for="custom-prompt-name-${index}" class="block text-xs font-medium text-slate-600">ë²„íŠ¼ ì´ë¦„</label>
                            <input type="text" id="custom-prompt-name-${index}" data-custom-prompt-key="name" value="${DOMPurify.sanitize(prompt.name)}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm text-sm" required>
                        </div>
                        <div>
                            <label for="custom-prompt-template-${index}" class="block text-xs font-medium text-slate-600">í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</label>
                            <textarea id="custom-prompt-template-${index}" data-custom-prompt-key="template" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm h-32 font-mono text-xs" required>${DOMPurify.sanitize(prompt.template)}</textarea>
                        </div>
                    </div>
                `).join('');

                const promptVariablesHelpText = `
                    <div class="mt-2 text-xs text-slate-500 p-3 bg-slate-100 rounded-md">
                        <p class="font-semibold mb-1">ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li><code class="bg-slate-200 px-1 rounded">{{bookTitle}}</code>: ì „ì²´ ì±… ì œëª©</li>
                            <li><code class="bg-slate-200 px-1 rounded">{{partTitle}}</code>: í˜„ì¬ íŒŒíŠ¸ ì œëª©</li>
                            <li><code class="bg-slate-200 px-1 rounded">{{chapterTitle}}</code>: í˜„ì¬ ì±•í„° ì œëª©</li>
                            <li><code class="bg-slate-200 px-1 rounded">{{chapterDescription}}</code>: í˜„ì¬ ì±•í„° ì„¤ëª…(ë©”ëª¨)</li>
                            <li><code class="bg-slate-200 px-1 rounded">{{manuscript}}</code>: í˜„ì¬ ì±•í„° ì›ê³ </li>
                            <li><code class="bg-slate-200 px-1 rounded">{{translation}}</code>: í˜„ì¬ ì±•í„° ë²ˆì—­ë³¸</li>
                            <li><code class="bg-slate-200 px-1 rounded">{{notes}}</code>: í˜„ì¬ ì±•í„° ë©”ëª¨</li>
                            <li><code class="bg-slate-200 px-1 rounded">{{fullToc}}</code>: ì „ì²´ ëª©ì°¨ í…ìŠ¤íŠ¸</li>
                            <li><code class="bg-slate-200 px-1 rounded">{{partToc}}</code>: í˜„ì¬ íŒŒíŠ¸ ëª©ì°¨ í…ìŠ¤íŠ¸</li>
                            <li>ê°ì¢… ê¸€ì“°ê¸° ì„¤ì • ë³€ìˆ˜ (ì˜ˆ: <code class="bg-slate-200 px-1 rounded">{{projectGenre}}</code>)</li>
                        </ul>
                    </div>
                `;

                const customPromptSection = `
                    <div class="pb-4 border-b border-slate-200">
                        <h4 class="text-md font-semibold text-slate-800 mb-2">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ë²„íŠ¼ ê´€ë¦¬</h4>
                        <div id="custom-prompts-container">
                            ${customPromptsHtml}
                        </div>
                        <button type="button" data-action="add-custom-prompt" class="btn btn-secondary w-full justify-center mt-2">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> ìƒˆ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì¶”ê°€
                        </button>
                        ${promptVariablesHelpText}
                    </div>
                `;
                
                return `<form data-action="save-settings"><div class="p-6"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold text-slate-900 mb-4">í”„ë¡œì íŠ¸ ì„¤ì •</h3><button type="button" data-action="close-modal" class="p-1 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button></div><div class="max-h-[60vh] overflow-y-auto pr-2">${renderFields(generalFields)}${customPromptSection}<div class="mt-6 pt-4 border-t border-slate-200"><h4 class="text-md font-semibold text-slate-800 mb-4">ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •</h4>${renderFields(promptFields)}</div></div></div><div class="bg-slate-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" data-action="close-modal" class="btn btn-secondary">ì·¨ì†Œ</button><button type="submit" class="btn">ì €ì¥</button></div></form>`;
            },
            renderApiKeyModal() { return `<form data-action="submit-api-key"><div class="p-6"><div class="flex items-start"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10"><i data-lucide="key-round" class="h-6 w-6 text-indigo-600"></i></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 class="text-lg leading-6 font-medium text-gray-900">Google AI API í‚¤ ì…ë ¥</h3><div class="mt-2"><p class="text-sm text-gray-500">í€´ì¦ˆ ìƒì„±ì„ ìœ„í•´ Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p><input type="password" id="api-key-input" class="mt-2 block w-full rounded-md border-slate-300" placeholder="API í‚¤ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></div></div></div></div><div class="bg-slate-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" data-action="close-modal" class="btn btn-secondary">ì·¨ì†Œ</button><button type="submit" class="btn">í™•ì¸</button></div></form>`;},
            renderManageQuizModal() { const questions = state.activeChapterContent.questions || []; const questionsHtml = questions.map((q, index) => `<div class="p-3 my-2 border rounded-md bg-slate-50 flex justify-between items-center group"><p class="text-sm text-slate-800 truncate pr-4">${index + 1}. ${q.questionText}</p><button type="button" data-action="delete-quiz-question" data-index="${index}" class="p-1 text-slate-500 hover:text-red-600 rounded-full hover:bg-red-100 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join(''); return `<div class="p-6"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold text-slate-900 mb-4">í€´ì¦ˆ ê´€ë¦¬</h3><button type="button" data-action="close-modal" class="p-1 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button></div><div class="max-h-[30vh] overflow-y-auto border rounded-lg p-2 bg-white mb-4">${questions.length > 0 ? questionsHtml : '<p class="text-sm text-slate-500 text-center py-4">ìƒì„±ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}</div><h4 class="text-lg font-semibold text-slate-800 border-t pt-4 mb-3">AI í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬¸ì œ ì¶”ê°€</h4><p class="text-sm text-slate-600 mb-2">1. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ AI ë„êµ¬(ì˜ˆ: Google AI Studio)ì— ë¶™ì—¬ë„£ê³  ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”.</p><button data-action="copy-quiz-prompt" class="btn w-full justify-center"><i data-lucide="clipboard-copy" class="w-4 h-4 mr-2"></i>AI ìƒì„± í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button><form data-action="add-questions-from-json" class="mt-4"><label for="quiz-json-paste" class="text-sm text-slate-600 mb-2 block">2. AIê°€ ìƒì„±í•œ JSON ë°°ì—´ì„ ì•„ë˜ì— ë¶™ì—¬ë„£ê³  'ì¶”ê°€' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</label><textarea id="quiz-json-paste" name="jsonContent" class="w-full h-24 p-2 border rounded-md font-mono text-xs" placeholder="[ { ... } ]" required></textarea><div class="bg-slate-50 -mx-6 -mb-6 px-6 py-4 mt-6 flex justify-end space-x-3 rounded-b-lg"><button type="button" data-action="close-modal" class="btn btn-secondary">ë‹«ê¸°</button><button type="submit" class="btn bg-emerald-600 hover:bg-emerald-700">JSONì—ì„œ ë¬¸ì œ ì¶”ê°€</button></div></form></div>`;},
            renderManageTocModal() { const renderNode = (node, path) => { const hasChildren = node.children && node.children.length > 0; const childrenHtml = hasChildren ? `<ul class="pl-4 border-l border-slate-200">${node.children.map((child, index) => renderNode(child, `${path}.${index}`)).join('')}</ul>` : ''; return `<li draggable="true" data-path="${path}" class="my-1 group toc-drag-item"><div class="flex items-center p-2 rounded-md hover:bg-slate-100"><i data-lucide="${hasChildren ? 'folder' : 'file-text'}" class="w-4 h-4 mr-2 text-slate-500 flex-shrink-0"></i><input type="text" value="${DOMPurify.sanitize(node.title)}" data-action="toc-edit-title" data-path="${path}" class="flex-grow bg-transparent focus:bg-white focus:ring-1 focus:ring-indigo-500 rounded-md px-1 py-0.5 text-sm"><div class="flex items-center space-x-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity"><button data-action="toc-add-child" data-path="${path}" title="í•˜ìœ„ í•­ëª© ì¶”ê°€" class="p-1 rounded hover:bg-slate-200"><i data-lucide="corner-down-right" class="w-4 h-4 text-slate-600"></i></button><button data-action="toc-delete" data-path="${path}" title="ì‚­ì œ" class="p-1 rounded hover:bg-red-100"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button></div></div>${childrenHtml}</li>`; }; const editableToc = state.modal.data.editableToc; if (!editableToc || !editableToc.children) return '<div>ëª©ì°¨ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'; const tocHtml = `<ul id="toc-editor-list" class="space-y-1">${editableToc.children.map((child, index) => renderNode(child, String(index))).join('')}</ul>`; return `<div class="p-6"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold text-slate-900 mb-4">ëª©ì°¨ ê´€ë¦¬</h3><button type="button" data-action="close-modal" class="p-1 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button></div><div class="max-h-[60vh] overflow-y-auto pr-2 border rounded-lg p-2 bg-slate-50 mb-4">${tocHtml}</div><div class="text-right"><button data-action="toc-add-root-item" class="btn btn-secondary"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>ìµœìƒìœ„ í•­ëª© ì¶”ê°€</button></div></div><div class="bg-slate-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" data-action="close-modal" class="btn btn-secondary">ì·¨ì†Œ</button><button type="button" data-action="save-toc" class="btn">ë³€ê²½ì‚¬í•­ ì €ì¥</button></div>`; },
            renderSplitChapterModal() {
                const chapterNode = Utils.getNodeByPath(state.activeProject.toc, state.activeChapterPath);
                const header = `<div class="p-6 border-b"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold text-slate-900">ë²ˆì—­ë¬¸ ë¶„í•  ë° í•˜ìœ„ ì±•í„° ìƒì„±</h3><button type="button" data-action="close-modal" class="p-1 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button></div><p class="text-sm text-slate-500 mt-1">'${chapterNode.title}' ë…¸íŠ¸ì˜ ë²ˆì—­ë¬¸ì„ ì—¬ëŸ¬ ê°œì˜ í•˜ìœ„ ë…¸íŠ¸ë¡œ ë¶„í• í•©ë‹ˆë‹¤. AI í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p></div>`;
                const content = `<form data-action="submit-split-chapter"><div class="p-6"><label for="split-json-paste" class="text-sm text-slate-600 mb-2 block">AIê°€ ìƒì„±í•œ JSON ì‘ë‹µì„ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</label><textarea id="split-json-paste" name="jsonContent" class="w-full h-40 p-2 border rounded-md font-mono text-xs" placeholder="[ { ... } ]" required></textarea></div><div class="bg-slate-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg"><button type="button" data-action="close-modal" class="btn btn-secondary">ë‹«ê¸°</button><button type="submit" class="btn bg-emerald-600 hover:bg-emerald-700"><i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>í•˜ìœ„ ì±•í„° ìƒì„± ì‹¤í–‰</button></div></form>`;
                return header + content;
            },
        };

        const Controller = {
            async init() {
                this.initializeConfig();
                marked.setOptions({ gfm: true, breaks: true });
                this.bindGlobalEventListeners();
                await DB.init();
                const [projects, categories, userProfile] = await Promise.all([ DB.getAll(CONFIG.STORES.PROJECTS), DB.getAll(CONFIG.STORES.CATEGORIES), DB.get(CONFIG.STORES.USER_PROFILE, 'main') ]);
                state.projects = projects;
                state.categories = categories.sort((a,b) => a.name.localeCompare(b.name));
                state.userProfile = userProfile || { id: 'main', level: 1, xp: 0 };
                if (!userProfile) await DB.put(CONFIG.STORES.USER_PROFILE, state.userProfile);
                this.updateTags(); this.buildSearchIndex();
                state.isLoading = false;
                View.render();
            },
            bindGlobalEventListeners() {
                document.body.addEventListener('click', e => { const trigger = e.target.closest('[data-action]'); if (!trigger || trigger.matches('form[data-action]')) return; const action = trigger.dataset.action; const handler = this.ACTION_HANDLERS[action]; if (handler) { e.preventDefault(); handler(trigger, e); } });
                document.body.addEventListener('submit', e => { const form = e.target.closest('form[data-action]'); if (!form) return; e.preventDefault(); const action = form.dataset.action; const handler = this.ACTION_HANDLERS[action]; if (handler) handler(form, e); });
                document.body.addEventListener('change', e => { const trigger = e.target; if (trigger.matches('input[type="file"]')) { this.handleFileSelection(trigger); } else if (trigger.closest('[data-action]')) { const actionEl = trigger.closest('[data-action]'); const action = actionEl.dataset.action; const handler = this.ACTION_HANDLERS[action]; if (handler) handler(actionEl, e); }});
                document.body.addEventListener('input', Utils.debounce(async e => { if (e.target.matches('#search-input')) { this.handleSearch(e.target.value); } else if (e.target.matches('[data-action="toc-edit-title"]')) { this.handleTocTitleEdit(e.target); } else if (e.target.matches('#manuscript, #notes, #translation, [data-setting-key], [data-custom-prompt-key]')) { await this.handleContentChange(e); } else if (e.target.matches('#setting-tags-input')) { this.handleTagInput(e.target); } }, 500));
                document.addEventListener('keydown', e => { if (e.key === 'Escape' && state.modal.isOpen) { this.closeModal(); } });
                document.addEventListener('katex-loaded', () => { state.isKaTeXLoaded = true; this.applyPostRenderEffects(); });
            },
            bindDynamicEventListeners() {
                if (state.modal.type === 'manageToc') {
                    const list = document.getElementById('toc-editor-list');
                    if (list) {
                        list.addEventListener('dragstart', this.handleTocDragStart);
                        list.addEventListener('dragover', this.handleTocDragOver);
                        list.addEventListener('dragleave', this.handleTocDragLeave);
                        list.addEventListener('drop', this.handleTocDrop);
                    }
                }
                if (state.modal.type === 'settings') {
                    const tagInput = document.getElementById('setting-tags-input');
                    if(tagInput) {
                        tagInput.addEventListener('keydown', this.handleTagInputKeydown);
                    }
                }
            },
            initializeConfig() {
                CONFIG.DEFAULT_PROJECT_SETTINGS = {
    writingGenre: "ì „ë¬¸ ë¶„ì„ ë³´ê³ ì„œ",
    writingAudience: "í•´ë‹¹ ë¶„ì•¼ë¥¼ ë°°ìš°ê¸° ê°ˆë§í•˜ëŠ” ì‚¬ëŒ",
    writingAgeGroup: "ì„±ì¸",
    writingStyle: "ì²œì²œíˆ ì²œì²œíˆ ì‹¬í˜ˆì„ ê¸°ìš¸ì—¬ ì‘ì„±í•œ, ìµœëŒ€í•œì˜ ì •ë³´ë¥¼ í•™ìˆ ì  ì •í™•ì„±ê³¼ í•¨ê»˜ ë‹´ì•„ë‚¸ ê°ê´€ì ì´ê³  ëª…ë£Œí•˜ë©°, ë…¼ë¦¬ì ì¸ ë¬¸ì²´",
    writingReferences: "í•µì‹¬ ì°¸ê³ ìë£Œ (ì„¸ê³„ê´€, ì¸ë¬¼, ìš©ì–´ ë“±)ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.",
    writingPrompt: `Have a break and then...
<?xml version="1.0" encoding="UTF-8"?>
<metaPrompt>
    <purpose>
        ì£¼ì–´ì§„ ëª¨ë“  ë§¥ë½ ì •ë³´ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬, íŠ¹ì • ì¥(Chapter)ì— í•´ë‹¹í•˜ëŠ” ì „ë¬¸ê°€ ìˆ˜ì¤€ì˜ ì›ê³  ì´ˆì•ˆì„ ì²œì²œíˆ ì‹¬í˜ˆì„ ê¸°ìš¸ì—¬ì„œ ì°¨ê·¼ì°¨ê·¼ ìƒì„±í•˜ëŠ” ê²ƒ. ìµœëŒ€í•œ ê¸¸ê³  ìì„¸í•˜ë©°, ì£¼ì–´ì§„ ëª©í‘œë¥¼ ì™„ë²½í•˜ê²Œ ë‹¬ì„±í•´ì•¼ í•œë‹¤.
    </purpose>
    <promptDesignFramework>
        <objectiveDefinition id="1" title="ëª©í‘œ ì •ì˜: ê³¼ì—…ì˜ ì œ1ì›ì¹™">
            <finalDeliverable id="1.1" description="í”„ë¡¬í”„íŠ¸ë¥¼ í†µí•´ ì–»ê³ ì í•˜ëŠ” ìµœì¢… ê²°ê³¼ë¬¼">
                '{{chapterTitle}}' ì¥ì— ëŒ€í•œ ì™„ì„±ë„ ë†’ì€ ì›ê³  ì´ˆì•ˆì„, ì²´ê³„ì ì¸ ì†Œì œëª©ì„ í¬í•¨í•˜ì—¬ ìµœëŒ€í•œ ê¸¸ê²Œ ìƒì„±í•œë‹¤. ì´ ì›ê³ ëŠ” ë³„ë„ì˜ ì„œë¬¸ì´ë‚˜ ìš”ì•½ ì—†ì´, ì¦‰ì‹œ ë³¸ë¬¸ì— ì‚½ì…í•  ìˆ˜ ìˆëŠ” ë§ˆí¬ë‹¤ìš´(Markdown) í˜•ì‹ì´ì–´ì•¼ í•œë‹¤.
            </finalDeliverable>
            <coreTask id="1.2" description="LLMì´ ìˆ˜í–‰í•´ì•¼ í•  í•µì‹¬ì ì¸ ë™ì‚¬">
                ì œì‹œëœ ëª¨ë“  ë§¥ë½ê³¼ ì œì•½ ì¡°ê±´ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì—¬, '{{chapterTitle}}' ì¥ì˜ ì›ê³ ë¥¼ **ì§‘í•„í•˜ë¼**.
            </coreTask>
            <successCriteria id="1.3" description="ê²°ê³¼ë¬¼ì´ 'ì„±ê³µ'ì´ë¼ê³  íŒë‹¨í•  ê°ê´€ì ì¸ ê¸°ì¤€">
                1. ìƒì„±ëœ ì›ê³ ê°€ '{{chapterDescription}}'ì— ëª…ì‹œëœ ëª©í‘œì™€ ë‚´ìš©ì„ ì¶©ì‹¤íˆ ë°˜ì˜í•˜ëŠ”ê°€?
                2. ì›ê³ ê°€ ì „ì²´ ëª©ì°¨('{{fullToc}}')ì˜ íë¦„ ì†ì—ì„œ í˜„ì¬ ì¥ì˜ ì—­í• ì„ ì •í™•íˆ ìˆ˜í–‰í•˜ëŠ”ê°€?
                3. í”„ë¡œì íŠ¸ ì„¤ì •('{{projectGenre}}', '{{projectAudience}}', '{{projectStyleExample}}')ì— ë¶€í•©í•˜ëŠ” ë¬¸ì²´ì™€ ì–´ì¡°ë¥¼ ì¼ê´€ë˜ê²Œ ìœ ì§€í•˜ëŠ”ê°€?
                4. 'references'ì— ì œê³µëœ ì„¤ì •(ì¸ë¬¼, ë°°ê²½, ìš©ì–´ ë“±)ì„ ì •í™•í•˜ê²Œ í™œìš©í•˜ì˜€ëŠ”ê°€?
                5. ê²°ê³¼ë¬¼ì´ ì„œë¬¸, ìš”ì•½, ë°˜ë³µ ë“± ë¶ˆí•„ìš”í•œ ë‚´ìš© ì—†ì´ ì˜¤ì§ ì›ê³  ë³¸ë¬¸ë§Œìœ¼ë¡œ êµ¬ì„±ë˜ì—ˆëŠ”ê°€?
                6. ìƒì„±ëœ ì›ê³ ê°€ í—ˆìš©ëœ ìµœëŒ€ í† í° ê¸¸ì´ë¥¼ í™œìš©í•˜ì—¬ ìµœëŒ€í•œ ìƒì„¸í•˜ê²Œ ì‘ì„±ë˜ì—ˆëŠ”ê°€?
            </successCriteria>
        </objectiveDefinition>
        <personaAssignment id="2" title="ì—­í•  ë¶€ì—¬: ìµœì ì˜ ì¸ì§€ ëª¨ë¸ ì„¤ê³„">
            <expertPersona id="2.1" description="ê³¼ì—…ì„ ê°€ì¥ ì˜ ìˆ˜í–‰í•  ì „ë¬¸ê°€ì˜ ìƒì„¸í•œ ë¬˜ì‚¬">
                ë‹¹ì‹ ì€ **'{{projectGenre}}' ì¥ë¥´ì˜ ë² í…Œë‘ ì‘ê°€**ì´ì, í•´ë‹¹ ë¶„ì•¼ì˜ ê¹Šì´ ìˆëŠ” ì§€ì‹ì„ ê°–ì¶˜ ì „ë¬¸ê°€ë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ë‹¨ìˆœí•œ í…ìŠ¤íŠ¸ ìƒì„±ì´ ì•„ë‹ˆë¼, ì‘í’ˆ ì „ì²´ì˜ ìœ ê¸°ì ì¸ íë¦„ê³¼ ê¹Šì´ë¥¼ ë”í•˜ëŠ” í•œ ë¶€ë¶„ì„ ì™„ì„±í•˜ëŠ” ê²ƒì´ë‹¤. ë‹¹ì‹ ì€ í”„ë¡œì íŠ¸ì˜ ì´ê´„ í¸ì§‘ìë¡œì„œ, ëª¨ë“  ì„¸ë¶€ ì„¤ì •ê³¼ ì´ì•¼ê¸°ì˜ í° ê·¸ë¦¼ì„ ì™„ë²½í•˜ê²Œ ì´í•´í•˜ê³  ìˆë‹¤.
            </expertPersona>
            <audience id="2.2" description="ê²°ê³¼ë¬¼ì„ ì†Œë¹„í•  ëŒ€ìƒê³¼ ê·¸ë“¤ì˜ ì§€ì‹ ìˆ˜ì¤€">
                ì´ ê¸€ì˜ í•µì‹¬ ë…ìëŠ” **'{{projectAudience}}'**ì´ë©°, ëŒ€ìƒ ì—°ë ¹ì¸µì€ **'{{projectAgeGroup}}'**ì´ë‹¤. ì´ë“¤ì˜ ì§€ì  í˜¸ê¸°ì‹¬ê³¼ ê¸°ëŒ€ ìˆ˜ì¤€ì„ ê³ ë ¤í•˜ì—¬ ì „ë¬¸ì ì´ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì§‘í•„í•´ì•¼ í•œë‹¤.
            </audience>
            <toneAndStyle id="2.3" description="ê²°ê³¼ë¬¼ì˜ ì–´ì¡°ì™€ ìŠ¤íƒ€ì¼">
                ê¸€ì˜ ì „ì²´ì ì¸ í†¤ì•¤ë§¤ë„ˆì™€ ë¬¸ì²´ëŠ” ë‹¤ìŒ ì˜ˆì‹œë¥¼ ë”°ë¥¸ë‹¤: **'{{projectStyleExample}}'**. ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¼ê´€ì„± ìˆëŠ” ì‘í’ì„ ìœ ì§€í•˜ë¼.
            </toneAndStyle>
        </personaAssignment>
        <contextAndFormat id="3" title="ë§¥ë½ ì œê³µ ë° í˜•ì‹ ì§€ì •">
            <essentialContext id="3.1" description="ê³¼ì—… ìˆ˜í–‰ì— í•„ìš”í•œ ëª¨ë“  ë°°ê²½ ì •ë³´, ë°ì´í„°, ì´ì „ ëŒ€í™” ë‚´ìš©"><![CDATA[
### í”„ë¡œì íŠ¸ ì „ì²´ ê°œìš”
- **ì±… ì „ì²´ ì œëª©**: {{bookTitle}}
- **ì¥ë¥´ ë° ëŒ€ìƒ**: {{projectGenre}}, {{projectAgeGroup}} {{projectAudience}}
- **í•µì‹¬ ì°¸ê³ ìë£Œ (ì„¸ê³„ê´€, ì¸ë¬¼, ìš©ì–´ ë“±)**:
{{references}}

### ì§‘í•„í•  ì¥(Chapter)ì˜ ìœ„ì¹˜ì™€ ëª©í‘œ
- **í˜„ì¬ íŒŒíŠ¸(Part)**: {{partTitle}} ({{partDescription}})
- **ì§‘í•„ ëŒ€ìƒ ì¥(Chapter)**: **{{chapterTitle}}**
- **ì´ë²ˆ ì¥ì˜ í•µì‹¬ ëª©í‘œ**: {{chapterDescription}}

### ì „ì²´ ëª©ì°¨ êµ¬ì¡° (í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ: â–¶)
{{fullToc}}

### í˜„ì¬ íŒŒíŠ¸ì˜ ëª©ì°¨ êµ¬ì¡° (í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ: â–¶)
{{partToc}}
            ]]></essentialContext>
            <outputFormat id="3.2" description="ê²°ê³¼ë¬¼ì´ ì¶œë ¥ë˜ì–´ì•¼ í•  ì •í™•í•œ í˜•ì‹ ë˜ëŠ” í…œí”Œë¦¿"><![CDATA[
## ìµœì¢… ì¶œë ¥ë¬¼ í˜•ì‹ (ë§¤ìš° ì¤‘ìš”)
- **ì˜¤ì§ ì›ê³  ë³¸ë¬¸ë§Œ ì¶œë ¥í•œë‹¤.**
- **ì›ê³  ë‚´ìš©ì— ì ì ˆí•œ ì†Œì œëª© ëª©ì°¨ë¥¼ í¬í•¨í•˜ê³ , ëª©ì°¨ì˜ ìµœìƒìœ„ ì œëª©ì€ '##'ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•œë‹¤.**
- Markdown ë¬¸ë²•ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ë‹¨ì„ ë‚˜ëˆ„ê³ , í•„ìš”ì‹œ ê°•ì¡° ë“±ì„ í‘œí˜„í•œë‹¤.
- "ê²°ê³¼ë¬¼:", "ì›ê³ :", "ë‹¤ìŒì€ ìš”ì²­í•˜ì‹  ì›ê³ ì…ë‹ˆë‹¤." ì™€ ê°™ì€ ì„œë‘ë¥¼ ì ˆëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.
- í”„ë¡¬í”„íŠ¸ì˜ ë‚´ìš©ì„ ìš”ì•½í•˜ê±°ë‚˜ ë˜í’€ì´í•˜ì§€ ë§ˆë¼.
            ]]></outputFormat>
        </contextAndFormat>
        <reasoningDesign id="4" title="ì¶”ë¡  ê³¼ì • ì„¤ê³„: ìƒê°ì˜ ê²½ë¡œ êµ¬ì¶•">
            <reasoningFramework id="4.1" description="ê³¼ì—… ë³µì¡ì„±ì— ë”°ë¥¸ ì¶”ë¡  ë°©ì‹ ì„ íƒ">
                <option type="DirectResponse" description="ë‹¨ìˆœ ì •ë³´ ìš”ì²­ ì‹œ ì‚¬ìš©">
                    <task>ìœ„ì˜ ëª¨ë“  ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, '{{chapterTitle}}' ì¥ì˜ ì›ê³ ë¥¼ ì¦‰ì‹œ ì§‘í•„í•˜ë¼.</task>
                </option>
            </reasoningFramework>
        </reasoningDesign>
        <constraints id="5" title="ì œì•½ ì¡°ê±´ ì„¤ì •: íƒìƒ‰ ê³µê°„ ì œì–´">
            <mustInclude id="5.1" description="ê²°ê³¼ë¬¼ì— ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•  í‚¤ì›Œë“œ, ê°œë…, ë°ì´í„° í¬ì¸íŠ¸">
                - ì›ê³  ë‚´ìš©ì€ '{{chapterDescription}}'ì˜ ëª©í‘œë¥¼ ì§ì ‘ì ìœ¼ë¡œ ë‹¬ì„±í•´ì•¼ í•œë‹¤.
                - 'references'ì˜ ì„¤ì •ê³¼ ì¶©ëŒì´ ì—†ì–´ì•¼ í•œë‹¤.
            </mustInclude>
            <mustAvoid id="5.2" description="ë°˜ë“œì‹œ í”¼í•´ì•¼ í•  ì£¼ì œ, í‘œí˜„, ë‹¨ì–´, í¸í–¥, ê°€ì •">
                - ì§‘í•„ ê³¼ì—…ì— ëŒ€í•œ ìê¸° í‰ê°€ë‚˜ ì†Œê°, ìš”ì•½, ë³€ëª…, ì¶”ê°€ ì„¤ëª…ì„ í¬í•¨í•˜ì§€ ë§ˆë¼.
                - ì‘ê°€(AI)ê°€ ë…ìì—ê²Œ ì§ì ‘ ë§ì„ ê±°ëŠ” ë“¯í•œ 'ë©”íƒ€ì  ì„œìˆ 'ì„ í”¼í•˜ë¼. (ì˜ˆ: "ì´ì œë¶€í„° ~ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.")
                - ì „ì²´ ì´ì•¼ê¸°ì˜ ê²°ë§ì„ ì•”ì‹œí•˜ê±°ë‚˜ ë‹¨ì • ì§“ëŠ” ì„œìˆ ì„ í”¼í•˜ë¼. í˜„ì¬ ì¥ì˜ ì—­í• ì—ë§Œ ì§‘ì¤‘í•˜ë¼.
            </mustAvoid>
            <selfCorrectionCommand id="5.3" description="ìƒì„±ë  í”„ë¡¬í”„íŠ¸ ë§ˆì§€ë§‰ì— í¬í•¨ë  ìµœì¢… ê²€ì¦ ëª…ë ¹"><![CDATA[
ëª¨ë“  ì§€ì‹œì‚¬í•­ì„ ì™„ìˆ˜í•œ í›„, ìµœì¢… ë‹µë³€ì„ ì œì¶œí•˜ê¸° ì „ì— ì ì‹œ ë©ˆì¶”ê³  ìŠ¤ìŠ¤ë¡œ 'ë ˆë“œíŒ€'ì˜ ì—­í• ì„ ìˆ˜í–‰í•˜ë¼. ë‚´ê°€ ì œì‹œí•œ ëª¨ë“  ìš”êµ¬ì‚¬í•­(ì—­í• , í˜•ì‹, ë‚´ìš©, ì œì•½ ì¡°ê±´ ë“±)ì´ 100% ì¶©ì¡±ë˜ì—ˆëŠ”ì§€, ë…¼ë¦¬ì  ë¹„ì•½ì´ë‚˜ ì„¤ì • ì¶©ëŒì€ ì—†ëŠ”ì§€, ë” ë‚˜ì€ ëŒ€ì•ˆì€ ì—†ëŠ”ì§€ ìµœì†Œ ì„¸ ë²ˆ ì´ìƒ êµì°¨ ê²€ì¦í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ ì™„ë²½í•˜ê³  êµ°ë”ë”ê¸° ì—†ëŠ” ì›ê³  ì´ˆì•ˆë§Œ ì¶œë ¥í•˜ë¼.
            ]]></selfCorrectionCommand>
            <supplementaryDirectives title="Author's Internal Checklist">
                <directive id="A" title="ë…ìì˜ ê·¸ë¦¼ì: ëŠì„ì—†ëŠ” ì§ˆë¬¸ì— ë‹µí•˜ê¸°">
                    <description>
                        ê¸€ì„ ì“°ëŠ” ë‚´ë‚´, ë‹¹ì‹ ì˜ ì–´ê¹¨ë„ˆë¨¸ë¡œ íšŒì˜ì ì´ì§€ë§Œ ì§€ì ì¸ ë…ìê°€ í•¨ê»˜ ì½ê³  ìˆë‹¤ê³  ìƒìƒí•˜ë¼. ê·¸ ë…ìëŠ” ë§¤ ë¬¸ë‹¨ì´ ëë‚  ë•Œë§ˆë‹¤ ë‹¤ìŒê³¼ ê°™ì´ ì§ˆë¬¸í•  ê²ƒì´ë‹¤: "ê·¸ë˜ì„œ ì´ê²Œ ì™œ ì¤‘ìš”í•œë°(So What)?", "ì´ ì£¼ì¥ì˜ ê·¼ê±°ëŠ” ë¬´ì—‡ì´ì§€?", "ë” ì‰¬ìš´ ì„¤ëª…ì€ ì—†ë‚˜?" ë‹¹ì‹ ì˜ ê¸€ì€ ì´ëŸ¬í•œ ë…ìì˜ ì ì¬ì  ì§ˆë¬¸ì„ ë¯¸ë¦¬ ì˜ˆì¸¡í•˜ê³ , ê·¸ì— ëŒ€í•œ ë‹µì„ ë³¸ë¬¸ ì•ˆì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ì•¼ í•œë‹¤. ë…ìì˜ ì˜ë¬¸ì´ ì‹¹íŠ¸ê¸° ì „ì— í•´ì†Œì‹œì¼œë¼.
                    </description>
                </directive>
                <directive id="B" title="ì •ë³´ì  íˆ¬ììˆ˜ìµë¥ (ROI) ì›ì¹™: ë…ìì˜ ë…¸ë ¥ì„ ë³´ìƒí•˜ê¸°">
                    <description>
                        ë…ìê°€ í•œ ë¬¸ì¥ì„ ì½ëŠ” ë° ì‚¬ìš©í•˜ëŠ” ì¸ì§€ì  ë…¸ë ¥ì€ 'íˆ¬ì'ë‹¤. ë‹¹ì‹ ì€ ê·¸ íˆ¬ìì— ëŒ€í•´ ìµœëŒ€í•œì˜ 'ìˆ˜ìµ(ì§€ì  ê¹¨ë‹¬ìŒ, ê°ì •ì  ë™ìš”, ì‹¤ìš©ì  ê°€ì¹˜)'ìœ¼ë¡œ ë³´ìƒí•  ì˜ë¬´ê°€ ìˆë‹¤. ëª¨ë“  ë¬¸ì¥ì´ ì •ë³´ì  ê°€ì¹˜ë¥¼ ì§€ë‹ˆëŠ”ì§€, ë¶ˆí•„ìš”í•œ ë¯¸ì‚¬ì—¬êµ¬ë‚˜ êµ°ë”ë”ê¸°ëŠ” ì—†ëŠ”ì§€ ëŠì„ì—†ì´ ì ê²€í•˜ë¼. ë¬¸ì¥ì´ ê¸¸ì–´ì§„ë‹¤ë©´, ê·¸ ê¸¸ì´ë§Œí¼ì˜ ê°€ì¹˜ë¥¼ ë‹´ê³  ìˆëŠ”ì§€ ì¦ëª…í•´ì•¼ í•œë‹¤.
                    </description>
                </directive>
                <directive id="C" title="ë…¼ë¦¬ì  ì—°ê²°ì˜ ë¯¸í•™: ë¬¸ë‹¨ê³¼ ë¬¸ë‹¨ì„ ì—®ëŠ” í˜">
                    <description>
                        ë¬¸ë‹¨ì„ ë…ë¦½ëœ ì •ë³´ì˜ ì„¬ìœ¼ë¡œ ì·¨ê¸‰í•˜ì§€ ë§ˆë¼. ë›°ì–´ë‚œ ê¸€ì€ ê° ë¬¸ë‹¨ì´ ì„œë¡œ ë§ë¬¼ë ¤ ëŒì•„ê°€ëŠ” ì •êµí•œ ê¸°ê³„ì™€ ê°™ë‹¤. í•œ ë¬¸ë‹¨ì˜ ë§ˆì§€ë§‰ ë¬¸ì¥ì€ ë‹¤ìŒ ë¬¸ë‹¨ì˜ ì²« ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ í˜¸ì¶œí•˜ëŠ” 'ê°ˆê³ ë¦¬' ì—­í• ì„ í•´ì•¼ í•œë‹¤. ë…¼ë¦¬ì˜ íë¦„ì´ ëŠê¸°ì§€ ì•Šê³ , ë…ìê°€ ë¬¼ íë¥´ë“¯ ë‹¤ìŒ ë‚´ìš©ìœ¼ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ ë¬¸ë‹¨ ì‚¬ì´ì˜ ë…¼ë¦¬ì  ì¸ì¥ë ¥ì„ ìµœëŒ€í™”í•˜ë¼.
                    </description>
                </directive>
                <directive id="D" title="êµ¬ì„±ì˜ êµí–¥ê³¡: ìš”ì†Œë“¤ì˜ ì¡°í™”ë¡œìš´ ë°°ì¹˜">
                    <description>
                        í•˜ë‚˜ì˜ ì¥(Chapter)ì€ ë‹¨ì¼í•œ ìŒìƒ‰ì˜ ì—°ì£¼ê°€ ì•„ë‹Œ, ë‹¤ì–‘í•œ ì•…ê¸°ê°€ ì¡°í™”ë¥¼ ì´ë£¨ëŠ” êµí–¥ê³¡ì´ì–´ì•¼ í•œë‹¤. 'ì´ë¡  ì œì‹œ', 'ì‚¬ë¡€ ë¶„ì„', 'ì„œì‚¬ì  ë¬˜ì‚¬', 'ë°ì´í„° ì¸ìš©', 'ì„±ì°°ì  ì§ˆë¬¸' ë“± ë‹¤ì–‘í•œ êµ¬ì„± ìš”ì†Œë¥¼ ë‹¨ì¡°ë¡­ì§€ ì•Šê²Œ ë°°ì¹˜í•˜ë¼. ì˜ˆë¥¼ ë“¤ì–´, ë¬´ê±°ìš´ ì´ë¡ ì„ ì œì‹œí–ˆë‹¤ë©´ ê³§ë°”ë¡œ í¥ë¯¸ë¡œìš´ ì¼í™”ë¥¼ í†µí•´ ë…ìì˜ ì´í•´ë¥¼ ë•ê³  í™˜ê¸°ì‹œí‚¤ëŠ” ì§€í˜œê°€ í•„ìš”í•˜ë‹¤.
                    </description>
                </directive>
                <directive id="E" title="ì§€ì  ì •ì§ì„±ì˜ í”„ë ˆì„: ê²½ê³„ì™€ ë³µì¡ì„±ì˜ ì¸ì •">
                    <description>
                        ë‹¹ì‹ ì˜ ì£¼ì¥ì´ ì ìš©ë˜ëŠ” ë²”ìœ„ì™€ í•œê³„ë¥¼ ëª…í™•íˆ í•˜ë¼. ëª¨ë“  ê²ƒì„ ì„¤ëª…í•  ìˆ˜ ìˆëŠ” ê²ƒì²˜ëŸ¼ ê³¼ì¥í•˜ê±°ë‚˜, ë³µì¡í•œ ë¬¸ì œë¥¼ ë‹¨ìˆœí•˜ê²Œ ì–‘ë¶„í•˜ì§€ ë§ˆë¼. íŠ¹íˆ ë¹„ë¬¸í•™ ë¶„ì•¼ì—ì„œëŠ” ë°˜ëŒ€ ì˜ê²¬ì´ë‚˜ ëŒ€ì•ˆì  í•´ì„ì„ ê³µì •í•˜ê²Œ ì†Œê°œí•˜ê³ , ì™œ ë‹¹ì‹ ì˜ ê´€ì ì´ ë” ì„¤ë“ë ¥ ìˆëŠ”ì§€ ë…¼ì¦í•˜ë¼. ì´ëŸ¬í•œ ì§€ì  ì •ì§ì„±ì€ ê¸€ì˜ ì‹ ë¢°ë„ë¥¼ ê·¹ì ìœ¼ë¡œ ë†’ì¸ë‹¤. ì†Œì„¤ì˜ ê²½ìš°, ì´ëŠ” ì„¸ìƒì„ ì„ ê³¼ ì•…ìœ¼ë¡œë§Œ ë‚˜ëˆ„ì§€ ì•ŠëŠ” ì…ì²´ì ì¸ ì„¸ê³„ê´€ êµ¬ì¶•ìœ¼ë¡œ ì´ì–´ì§„ë‹¤.
                    </description>
                </directive>
            </supplementaryDirectives>
        </constraints>
    </promptDesignFramework>
</metaPrompt>`,
    translationPrompt: `Have a break and then...
<?xml version="2.0" encoding="UTF-8"?>
<metaPrompt>
    <purpose>
        ì²œì²œíˆ ì‹¬í˜ˆì„ ê¸°ìš¸ì—¬, 'essentialContext'ì— ì œê³µëœ ì›ë¬¸ì„ ë¶„ì„í•œë‹¤. ì›ë¬¸ì˜ í†¤ì•¤ë§¤ë„ˆì™€ í•µì‹¬ ì •ë³´ë¥¼ ì™„ë²½í•˜ê²Œ ë³´ì¡´í•˜ë©´ì„œ, ê°€ì¥ ìœ ë ¤í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì–´ì²´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•œë‹¤. ìµœì¢… ê²°ê³¼ë¬¼ì€ ì¦‰ì‹œ ì¶œíŒ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì˜ ê°€ë…ì„±, í•™ë¬¸ì  ì •í™•ì„±, ì˜ë¯¸ ì „ë‹¬ì˜ ëª…í™•ì„±ì„ ê°–ì¶°ì•¼ í•œë‹¤.
    </purpose>
    <promptDesignFramework>
        <objectiveDefinition id="1" title="ëª©í‘œ ì •ì˜: ê³¼ì—…ì˜ ì œ1ì›ì¹™">
            <finalDeliverable id="1.1" description="í”„ë¡¬í”„íŠ¸ë¥¼ í†µí•´ ì–»ê³ ì í•˜ëŠ” ìµœì¢… ê²°ê³¼ë¬¼">
                ì‚¬ìš©ìê°€ ì œê³µí•œ ì›ë¬¸ì„ ì „ë¬¸ê°€ ìˆ˜ì¤€ìœ¼ë¡œ ë²ˆì—­í•˜ê³  ë‹¤ë“¬ì–´, ì¦‰ì‹œ ì¶œíŒí•˜ì—¬ ë² ìŠ¤íŠ¸ì…€ëŸ¬ê°€ ë  ìˆ˜ ìˆëŠ” ìƒíƒœì˜ ì™„ë²½í•œ í•œêµ­ì–´ ë¬¸ì–´ì²´ ì›ê³ .
            </finalDeliverable>
            <coreTask id="1.2" description="LLMì´ ìˆ˜í–‰í•´ì•¼ í•  í•µì‹¬ì ì¸ ë™ì‚¬">
                **ë²ˆì—­(Translate), êµì •(Refine), ê·¸ë¦¬ê³  í˜•ì‹í™”(Format)í•˜ë¼.** ë‹¨ìˆœí•œ ë‹¨ì–´ ëŒ€ì²´ë¥¼ ë„˜ì–´, ì „ë¬¸ í¸ì§‘ìë¡œì„œ ì›ë¬¸ì˜ ì˜ë¯¸ì™€ ë‰˜ì•™ìŠ¤ë¥¼ í•œêµ­ì–´ ë…ìì—ê²Œ ìµœì í™”ëœ ì½˜í…ì¸ ë¡œ ì¬ì°½ì¡°í•˜ë¼.
            </coreTask>
            <successCriteria id="1.3" description="ê²°ê³¼ë¬¼ì´ 'ì„±ê³µ'ì´ë¼ê³  íŒë‹¨í•  ê°ê´€ì ì¸ ê¸°ì¤€">
                - ë²ˆì—­ë¬¸ì€ ì›ë¬¸ì˜ í•µì‹¬ ì˜ë¯¸, ì„¸ë¶€ ë‰˜ì•™ìŠ¤, ê·¸ë¦¬ê³  ì €ìì˜ ì˜ë„ë¥¼ 100% ë³´ì¡´í•œë‹¤.
                - í•œêµ­ì–´ ë¬¸ì¥ì€ ë¬¸ë²•ì ìœ¼ë¡œ ì™„ë²½í•˜ë©°, ì›ë¬¸ì˜ ì–´ì¡°ì™€ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ë©´ì„œë„ ìì—°ìŠ¤ëŸ½ê³  ìœ ë ¤í•˜ë‹¤.
                - ëª¨ë“  ë¬¸ì¥ì´ ëˆ„ë½ ì—†ì´ ë²ˆì—­ë˜ì—ˆìœ¼ë©°, ì¼ê´€ëœ ë¬¸ì²´ë¥¼ ìœ ì§€í•œë‹¤.
                - ì œëª©, ì†Œì œëª©, ë¬¸ë‹¨ ë‚˜ëˆ„ê¸° ë“± ì›ë¬¸ì˜ ë…¼ë¦¬ì  êµ¬ì¡°ë¥¼ ì •í™•íˆ ë°˜ì˜í•˜ì—¬ ê°€ë…ì„±ì„ ê·¹ëŒ€í™”í•œë‹¤.
                - '[ì—¬ê¸°ì— ì…ë ¥]'ê³¼ ê°™ì€ í”Œë ˆì´ìŠ¤í™€ë” í…ìŠ¤íŠ¸ê°€ ìµœì¢… ê²°ê³¼ë¬¼ì— ë‚¨ì•„ìˆì§€ ì•Šë‹¤.
            </successCriteria>
        </objectiveDefinition>
        <personaAssignment id="2" title="ì—­í•  ë¶€ì—¬: ìµœì ì˜ ì¸ì§€ ëª¨ë¸ ì„¤ê³„">
            <expertPersona id="2.1" description="ê³¼ì—…ì„ ê°€ì¥ ì˜ ìˆ˜í–‰í•  ì „ë¬¸ê°€ì˜ ìƒì„¸í•œ ë¬˜ì‚¬">
                ë‹¹ì‹ ì€ **'20ë…„ ê²½ë ¥ì˜ ë§ˆìŠ¤í„° ë²ˆì—­ê°€ ê²¸ ì½˜í…ì¸  ì „ëµê°€'**ë‹¤. êµ­ì œíšŒì˜ í†µì—­ì‚¬ì´ì ì—¬ëŸ¬ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ê¸°ìˆ  ì„œì ì„ ë²ˆì—­í•œ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ, ë‹¨ìˆœí•œ ì–¸ì–´ ë³€í™˜ì„ ë„˜ì–´ ë¬¸í™”ì  ë§¥ë½ê³¼ ë¯¸ë¬˜í•œ ë‰˜ì•™ìŠ¤ê¹Œì§€ í¬ì°©í•œë‹¤. ë‹¹ì‹ ì€ ë…ìì˜ ë§ˆìŒì„ ì›€ì§ì´ëŠ” ê¸€ì„ ë§Œë“¤ì–´ë‚´ëŠ” ì „ë¬¸ê°€ì´ë©°, ë””ì§€í„¸ ì½˜í…ì¸ ì˜ ê°€ë…ì„±ê¹Œì§€ ê³ ë ¤í•˜ì—¬ ë²ˆì—­ ê²°ê³¼ë¥¼ êµ¬ì¡°í™”í•œë‹¤.
            </expertPersona>
            <audience id="2.2" description="ê²°ê³¼ë¬¼ì„ ì†Œë¹„í•  ëŒ€ìƒê³¼ ê·¸ë“¤ì˜ ì§€ì‹ ìˆ˜ì¤€">
                ì œê³µëœ ì›ë¬¸ì˜ ë‚´ìš©, ì–´íœ˜, ìŠ¤íƒ€ì¼ì„ ë¶„ì„í•˜ì—¬ ì ì¬ ë…ìì¸µ(ì˜ˆ: ê¸°ìˆ  ì „ë¬¸ê°€, ì¼ë°˜ ëŒ€ì¤‘, í•™ìƒ ë“±)ì„ ì¶”ë¡ í•˜ê³ , ê·¸ë“¤ì˜ ì§€ì‹ ìˆ˜ì¤€ê³¼ ê´€ì‹¬ì‚¬ì— ë§ì¶° ê°€ì¥ ì´í•´í•˜ê¸° ì‰¬ìš´ ì–´íœ˜ì™€ ë¬¸ì¥ êµ¬ì¡°ë¥¼ ì„ íƒí•´ì•¼ í•œë‹¤.
            </audience>
            <toneAndStyle id="2.3" description="ê²°ê³¼ë¬¼ì˜ ì–´ì¡°ì™€ ìŠ¤íƒ€ì¼ ë° ì •ì‹ ì  ë„êµ¬">
                - **í†¤ì•¤ë§¤ë„ˆ ë³µì œ:** ì›ë¬¸ì˜ ì–´ì¡°(ì˜ˆ: í•™ìˆ ì , ìœ ë¨¸ëŸ¬ìŠ¤í•¨, ì§„ì§€í•¨, ëŒ€ì¤‘ì )ë¥¼ ì •í™•íˆ ë¶„ì„í•˜ê³ , ê·¸ ëŠë‚Œì„ í•œêµ­ì–´ í‘œí˜„ìœ¼ë¡œ ì™„ë²½í•˜ê²Œ ì¬í˜„í•´ì•¼ í•œë‹¤. ì§ì—­ìœ¼ë¡œ ì–´ìƒ‰í•´ì§€ëŠ” ê´€ìš©êµ¬ë‚˜ ë¬¸í™”ì  í‘œí˜„ì€ í•œêµ­ ë…ìê°€ ì¦‰ì‹œ ì´í•´í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„ìœ¼ë¡œ ì˜ì—­í•œë‹¤.
                - **ë¬¸ì–´ì²´ ì‚¬ìš©:** ë² ìŠ¤íŠ¸ì…€ëŸ¬ì²˜ëŸ¼ ì˜ ì½íˆëŠ” ë¬¸ì–´ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬, ì›ë³¸ì˜ ëª¨ë“  ë‚´ìš©ê³¼ ì •ë³´ë¥¼ í¬í•¨í•˜ë©´ì„œë„ ìˆ ìˆ  ì½í˜€ì•¼ë§Œ í•œë‹¤.
                - **ì •ì‹ ì  ë„êµ¬ (Mental Model):** 'ë…ìì˜ ì…ì¥ì—ì„œ ìƒê°í•˜ê¸°'. ë¬¸ì¥ì„ ì™„ì„±í•˜ê¸° ì „ì—, ì ì¬ ë…ìì˜ ê´€ì ì—ì„œ ê·¸ ë¬¸ì¥ì„ ì†Œë¦¬ ë‚´ì–´ ì½ì–´ë³¸ë‹¤ê³  ìƒìƒí•˜ë¼. 'ì´ ë¬¸ì¥ì€ ëª…í™•í•œê°€? ë§¤ë ¥ì ì¸ê°€? ì´ì „ ë‚´ìš©ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°ë˜ëŠ”ê°€?'ë¥¼ ëŠì„ì—†ì´ ìë¬¸í•˜ë©° ê²°ê³¼ë¬¼ì„ ë‹¤ë“¬ì–´ë¼.
            </toneAndStyle>
        </personaAssignment>
        <contextAndFormat id="3" title="ë§¥ë½ ì œê³µ ë° í˜•ì‹ ì§€ì •">
            <essentialContext id="3.1" description="ê³¼ì—… ìˆ˜í–‰ì— í•„ìš”í•œ ëª¨ë“  ë°°ê²½ ì •ë³´, ë°ì´í„°, ì´ì „ ëŒ€í™” ë‚´ìš©"><![CDATA[
{{text}}
            ]]></essentialContext>
            <outputFormat id="3.2" description="ê²°ê³¼ë¬¼ì´ ì¶œë ¥ë˜ì–´ì•¼ í•  ì •í™•í•œ í˜•ì‹ ë˜ëŠ” í…œí”Œë¦¿"><![CDATA[
ì…ë ¥ëœ ì›ë¬¸ì˜ í˜•ì‹ì— ë§ì¶° ê°€ì¥ ì ì ˆí•˜ê³  ê°€ë…ì„± ë†’ì€ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•œë‹¤.
            ]]></outputFormat>
        </contextAndFormat>
        <reasoningDesign id="4" title="ì¶”ë¡  ê³¼ì • ì„¤ê³„: ìƒê°ì˜ ê²½ë¡œ êµ¬ì¶•">
            <reasoningFramework id="4.1" description="ê³¼ì—… ë³µì¡ì„±ì— ë”°ë¥¸ ì¶”ë¡  ë°©ì‹ ì„ íƒ">
                <option type="ProblemDecomposition" description="ë³µì¡í•œ í”„ë¡œì íŠ¸ ìˆ˜í–‰ ì‹œ ì‚¬ìš©">
                    <instruction>
                        ì•„ë˜ì˜ ìµœì¢… ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´, ë‹¤ìŒì˜ í•˜ìœ„ ì‘ì—…ë“¤ì„ ëª…ì‹œëœ ìˆœì„œëŒ€ë¡œ ë°˜ë“œì‹œ ìˆ˜í–‰í•˜ë¼. ê° ë‹¨ê³„ì˜ ê²°ê³¼ëŠ” ë‹¤ìŒ ë‹¨ê³„ì˜ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.
                    </instruction>
                    <subTasks>
                        <task id="1">**1ë‹¨ê³„: ì›ë¬¸ ì‹¬ì¸µ ë¶„ì„ (Analyze):** ì œê³µëœ ì›ë¬¸ì„ ìµœì†Œ 3íšŒ ì´ìƒ ì •ë…í•˜ì—¬ í•µì‹¬ ë©”ì‹œì§€, ë…¼ë¦¬ êµ¬ì¡°, ì €ìì˜ ì–´ì¡°ì™€ ë¬¸ì²´, ê·¸ë¦¬ê³  ìˆ¨ì€ ì˜ë„ë¥¼ ì™„ë²½í•˜ê²Œ íŒŒì•…í•œë‹¤.</task>
                        <task id="2">**2ë‹¨ê³„: ì´ˆë²Œ ë²ˆì—­ ë° ë‰˜ì•™ìŠ¤ í¬ì°© (Translate & Capture):** ì›ë¬¸ì˜ ì˜ë¯¸ë¥¼ ì •í™•í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ë° ì´ˆì ì„ ë§ì¶° ì´ˆë²Œ ë²ˆì—­ì„ ìˆ˜í–‰í•œë‹¤. íŠ¹íˆ ê¸°ìˆ  ìš©ì–´, ê´€ìš© í‘œí˜„, ë¬¸í™”ì  ë°°ê²½ì´ ë‹´ê¸´ ë‰˜ì•™ìŠ¤ë¥¼ ë†“ì¹˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•œë‹¤.</task>
                        <task id="3">**3ë‹¨ê³„: ìœ¤ë¬¸ ë° ìœ ë ¤í•¨ í™•ë³´ (Refine & Polish):** ì´ˆë²Œ ë²ˆì—­ ê²°ê³¼ë¬¼ì„ í•œêµ­ì–´ ë…ìì˜ ì‹œê°ì—ì„œ ì–´ìƒ‰í•¨ì´ ì—†ë„ë¡ ë‹¤ë“¬ëŠ”ë‹¤. ë”±ë”±í•œ ë²ˆì—­íˆ¬ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ë¬¸ì¥ìœ¼ë¡œ ì¬êµ¬ì„±í•˜ê³ , ë” ì ì ˆí•œ ì–´íœ˜ë¥¼ ì„ íƒí•˜ì—¬ ê¸€ ì „ì²´ì˜ ìœ ë ¤í•¨ì„ ê·¹ëŒ€í™”í•œë‹¤.</task>
                        <task id="4">**4ë‹¨ê³„: ì½˜í…ì¸  êµ¬ì¡°í™” ë° í˜•ì‹í™” (Structure & Format):** ì™„ì„±ëœ ë‚´ìš©ì„ ê°€ë…ì„±ì„ ë†’ì´ê¸° ìœ„í•´ ë³¸ë¬¸ì„ ë…¼ë¦¬ì ì¸ ë¬¸ë‹¨ê³¼ ì†Œì œëª©ìœ¼ë¡œ ë‚˜ëˆ„ê³ , ì›ë¬¸ì˜ êµ¬ì¡°ë¥¼ ì¶©ì‹¤íˆ ë”°ë¥¸ë‹¤.</task>
                    </subTasks>
                </option>
            </reasoningFramework>
            <fewShotExamples id="4.2" description="1~3ê°œì˜ ê³ í’ˆì§ˆ ì…/ì¶œë ¥ ì˜ˆì‹œë¡œ ê²°ê³¼ë¬¼ íŒ¨í„´ í•™ìŠµ">
                <example id="1">
                    <input><![CDATA[
Title: The Unseen Power of Micro-interactions

Micro-interactions are the small, often unnoticed animations and design elements that make a user interface feel alive. Think of the "like" button animation on Twitter, or the subtle bounce when you pull to refresh a feed. While seemingly minor, these details are critical. They provide feedback, guide users, and add a touch of personality to a digital product, transforming a functional tool into an enjoyable experience. Good micro-interactions are almost invisible, doing their job without shouting for attention.
                    ]]></input>
                    <output><![CDATA[]]></output>
                </example>
            </fewShotExamples>
        </constraints>
        <constraints id="5" title="ì œì•½ ì¡°ê±´ ì„¤ì •: íƒìƒ‰ ê³µê°„ ì œì–´">
            <mustInclude id="5.1" description="ê²°ê³¼ë¬¼ì— ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•  í‚¤ì›Œë“œ, ê°œë…, ë°ì´í„° í¬ì¸íŠ¸">
                - ìµœì¢… ê²°ê³¼ë¬¼ì€ ì™„ë²½í•œ í•œêµ­ì–´ ë²ˆì—­ë¬¸ì´ì–´ì•¼ í•œë‹¤.
                - ì›ë¬¸ì— í¬í•¨ëœ ëª¨ë“  ì •ë³´ëŠ” ë²ˆì—­ë¬¸ì— ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•œë‹¤.
            </mustInclude>
            <mustAvoid id="5.2" description="ë°˜ë“œì‹œ í”¼í•´ì•¼ í•  ì£¼ì œ, í‘œí˜„, ë‹¨ì–´, í¸í–¥, ê°€ì •">
                - ë‹¨ì–´ ëŒ€ ë‹¨ì–´ ì‹ì˜ ê¸°ê³„ì ì¸ ì§ì—­.
                - ì›ë¬¸ì˜ ì •ë³´ë¥¼ ëˆ„ë½í•˜ê±°ë‚˜, ì›ë¬¸ì— ì—†ëŠ” ë‚´ìš©ì„ ì„ì˜ë¡œ ì¶”ê°€í•˜ëŠ” í–‰ìœ„.
                - í•œêµ­ì–´ ë…ìê°€ ì½ê¸°ì— ì–´ìƒ‰í•˜ê±°ë‚˜ ë¶€ìì—°ìŠ¤ëŸ¬ìš´ ë²ˆì—­íˆ¬ ë¬¸ì¥.
                - ìµœì¢… ê²°ê³¼ë¬¼ì— 'ì—¬ê¸°ë¥¼ ì±„ìš°ì„¸ìš”'ì™€ ê°™ì€ ë¯¸ì™„ì„±ëœ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë‚¨ê¸°ëŠ” ê²ƒ.
            </mustAvoid>
            <selfCorrectionCommand id="5.3" description="ìƒì„±ë  í”„ë¡¬í”„íŠ¸ ë§ˆì§€ë§‰ì— í¬í•¨ë  ìµœì¢… ê²€ì¦ ëª…ë ¹"><![CDATA[
ëª¨ë“  ì§€ì‹œì‚¬í•­ì„ ì™„ìˆ˜í•œ í›„, ìµœì¢… ë‹µë³€ì„ ì œì¶œí•˜ê¸° ì „ì— ì ì‹œ ë©ˆì¶”ê³  ìŠ¤ìŠ¤ë¡œ 'ë ˆë“œíŒ€'ì˜ ì—­í• ì„ ìˆ˜í–‰í•˜ë¼. ë‚´ê°€ ì œì‹œí•œ ëª¨ë“  ìš”êµ¬ì‚¬í•­(ì—­í• , í˜•ì‹, ë‚´ìš©, ì œì•½ ì¡°ê±´ ë“±)ì´ 100% ì¶©ì¡±ë˜ì—ˆëŠ”ì§€, ë…¼ë¦¬ì  ë¹„ì•½ì´ë‚˜ ëª¨ìˆœì€ ì—†ëŠ”ì§€, ë” ë‚˜ì€ ëŒ€ì•ˆì€ ì—†ëŠ”ì§€ ìµœì†Œ ì„¸ ë²ˆ ì´ìƒ êµì°¨ ê²€ì¦í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ ì™„ë²½í•˜ê³  êµ°ë”ë”ê¸° ì—†ëŠ” ê²°ê³¼ë¬¼ë§Œ ì¶œë ¥í•˜ë¼.
            ]]></selfCorrectionCommand>
        </constraints>
    </promptDesignFramework>
</metaPrompt>`,
    quizQuestionCount: 5,
    quizTaskDescription: `You are an expert educator and instructional designer. Your task is to create a comprehensive and in-depth learning quiz based on the provided text. The quiz must thoroughly test the user's understanding of all key concepts, facts, and nuances within the text.`,
    quizOutputFormatInstruction: `Respond ONLY with a valid JSON array of question objects inside a <json_response> tag. Do not include any other text or explanations outside this tag.`,
    quizPromptTemplate: `Have a break and then...
<?xml version="1.0" encoding="UTF-8"?>
<metaPrompt>
    <purpose>
        ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, í•™ìŠµìì˜ ì´í•´ë„ë¥¼ ë‹¤ê°ë„ë¡œ í‰ê°€í•  ìˆ˜ ìˆëŠ” ê³ í’ˆì§ˆì˜ í•™ìŠµ í€´ì¦ˆë¥¼ ìƒì„±í•œë‹¤. ë‹¨ìˆœ ì •ë³´ í™•ì¸ì„ ë„˜ì–´, í•µì‹¬ ê°œë…ì˜ ì ìš© ë° ë¹„íŒì  ì‚¬ê³ ë¥¼ ìœ ë„í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•œë‹¤.
    </purpose>
    <promptDesignFramework>
        <objectiveDefinition id="1" title="ëª©í‘œ ì •ì˜: ê³¼ì—…ì˜ ì œ1ì›ì¹™">
            <finalDeliverable id="1.1" description="í”„ë¡¬í”„íŠ¸ë¥¼ í†µí•´ ì–»ê³ ì í•˜ëŠ” ìµœì¢… ê²°ê³¼ë¬¼">
                ì—„ê²©í•œ JSON í˜•ì‹ ìŠ¤í‚¤ë§ˆë¥¼ ì¤€ìˆ˜í•˜ëŠ”, {{questionCount}}ê°œì˜ ì§ˆë¬¸ ê°ì²´ë¡œ êµ¬ì„±ëœ ìœ íš¨í•œ JSON ë°°ì—´. ê° ì§ˆë¬¸ì€ êµìœ¡ì ìœ¼ë¡œ ê°€ì¹˜ê°€ ë†’ê³ , ëª…í™•í•œ ì •ë‹µê³¼ ìƒì„¸í•œ í•´ì„¤ì„ í¬í•¨í•´ì•¼ í•œë‹¤.
            </finalDeliverable>
            <coreTask id="1.2" description="LLMì´ ìˆ˜í–‰í•´ì•¼ í•  í•µì‹¬ì ì¸ ë™ì‚¬">
                ì œì‹œëœ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ê³ , ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµìœ¡ ëª©í‘œì— ë¶€í•©í•˜ëŠ” í•™ìŠµ í€´ì¦ˆë¥¼ **ì„¤ê³„í•˜ê³  ìƒì„±í•˜ë¼(Design and Generate)**.
            </coreTask>
            <successCriteria id="1.3" description="ê²°ê³¼ë¬¼ì´ 'ì„±ê³µ'ì´ë¼ê³  íŒë‹¨í•  ê°ê´€ì ì¸ ê¸°ì¤€">
                1. ì •í™•íˆ {{questionCount}}ê°œì˜ ì§ˆë¬¸ì´ ìƒì„±ë˜ì—ˆëŠ”ê°€?
                2. 'multiple_choice', 'short_answer', 'subjective', 'case_based' ë“± ë‹¤ì–‘í•œ ìœ í˜•ì˜ ì§ˆë¬¸ì´ í˜¼í•©ë˜ì—ˆëŠ”ê°€?
                3. ê° ì§ˆë¬¸ì´ ì›ë³¸ í…ìŠ¤íŠ¸ì˜ í•µì‹¬ ê°œë…, ì‚¬ì‹¤, ë‰˜ì•™ìŠ¤ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ í‰ê°€í•˜ëŠ”ê°€?
                4. ëª¨ë“  ì§ˆë¬¸ì˜ ì •ë‹µì´ ì •í™•í•˜ê³ , í•´ì„¤ì´ ëª…í™•í•˜ë©° êµìœ¡ì ì¸ê°€?
                5. ìµœì¢… ê²°ê³¼ë¬¼ì´ ì§€ì •ëœ JSON í˜•ì‹ê³¼ ìŠ¤í‚¤ë§ˆë¥¼ 100% ì¤€ìˆ˜í•˜ë©°, ì˜¤ë¥˜ ì—†ì´ íŒŒì‹±ë˜ëŠ”ê°€?
                6. ì§ˆë¬¸ì˜ ì–¸ì–´ê°€ í•œêµ­ì–´ë¡œ ëª…í™•í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±ë˜ì—ˆëŠ”ê°€?
            </successCriteria>
        </objectiveDefinition>
        <personaAssignment id="2" title="ì—­í•  ë¶€ì—¬: ìµœì ì˜ ì¸ì§€ ëª¨ë¸ ì„¤ê³„">
            <expertPersona id="2.1" description="ê³¼ì—…ì„ ê°€ì¥ ì˜ ìˆ˜í–‰í•  ì „ë¬¸ê°€ì˜ ìƒì„¸í•œ ë¬˜ì‚¬">
                ë‹¹ì‹ ì€ **'ì „ë¬¸ êµìœ¡ìì´ì êµìœ¡ê³¼ì • ì„¤ê³„ì(Expert Educator and Instructional Designer)'**ì´ë‹¤. ë‹¹ì‹ ì€ í…ìŠ¤íŠ¸ì˜ í•µì‹¬ì„ ê¿°ëš«ì–´ ë³´ê³ , í•™ìŠµ ëª©í‘œì— ë§ì¶° ì´í•´ë„ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì¸¡ì •í•˜ëŠ” ë¬¸í•­ì„ ê°œë°œí•˜ëŠ” ë° ë§¤ìš° ëŠ¥ìˆ™í•˜ë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ë‹¨ìˆœí•œ í€´ì¦ˆ ìƒì„±ì´ ì•„ë‹ˆë¼, í•™ìŠµìê°€ ìŠ¤ìŠ¤ë¡œì˜ ì´í•´ë„ë¥¼ ì ê²€í•˜ê³  ë” ê¹Šì€ í•™ìŠµìœ¼ë¡œ ë‚˜ì•„ê°€ë„ë¡ ë•ëŠ” êµìœ¡ì  ë„êµ¬ë¥¼ ë§Œë“œëŠ” ê²ƒì´ë‹¤.
            </expertPersona>
            <audience id="2.2" description="ê²°ê³¼ë¬¼ì„ ì†Œë¹„í•  ëŒ€ìƒê³¼ ê·¸ë“¤ì˜ ì§€ì‹ ìˆ˜ì¤€">
                ì´ í€´ì¦ˆì˜ ì‚¬ìš©ìëŠ” ì œê³µëœ í…ìŠ¤íŠ¸ë¥¼ ë°©ê¸ˆ í•™ìŠµí•œ í•™ìŠµìë‹¤. ì´ë“¤ì€ ë‚´ìš©ì„ ê¸°ì–µí•˜ê³  ìˆì§€ë§Œ, í•µì‹¬ ê°œë…ì— ëŒ€í•œ ì´í•´ë¥¼ í™•ê³ íˆ í•˜ê³  ì¤‘ìš”í•œ ë¶€ë¶„ì„ ë‹¤ì‹œ í•œë²ˆ ìƒê¸°í•  í•„ìš”ê°€ ìˆë‹¤.
            </audience>
            <toneAndStyle id="2.3" description="ê²°ê³¼ë¬¼ì˜ ì–´ì¡°ì™€ ìŠ¤íƒ€ì¼">
                - **ì–´ì¡°**: êµìœ¡ì ì´ê³  ì „ë¬¸ì ì´ë©°, ì‹ ë¢°ê°ì„ ì£¼ëŠ” ì–´ì¡°ë¥¼ ì‚¬ìš©í•œë‹¤.
                - **ìŠ¤íƒ€ì¼**: ì§ˆë¬¸ì€ ëª…í™•í•˜ê³  ê°„ê²°í•˜ë©°, ì˜¤í•´ì˜ ì†Œì§€ê°€ ì—†ë„ë¡ ì‘ì„±í•œë‹¤. í•´ì„¤ì€ ì¹œì ˆí•˜ê³  ìƒì„¸í•˜ê²Œ ì œê³µí•˜ì—¬ ì¶”ê°€ í•™ìŠµì´ ê°€ëŠ¥í•˜ë„ë¡ í•œë‹¤.
            </toneAndStyle>
        </personaAssignment>
        <contextAndFormat id="3" title="ë§¥ë½ ì œê³µ ë° í˜•ì‹ ì§€ì •">
            <essentialContext id="3.1" description="ê³¼ì—… ìˆ˜í–‰ì— í•„ìš”í•œ ëª¨ë“  ë°°ê²½ ì •ë³´"><![CDATA[
- **í€´ì¦ˆ ë¬¸í•­ ìˆ˜**: {{questionCount}}
- **í€´ì¦ˆ ì¶œì œ ì–¸ì–´**: í•œêµ­ì–´
- **í€´ì¦ˆ ì¶œì œ ê¸°ë°˜ ì›ë³¸ í…ìŠ¤íŠ¸**:
{{text}}
            ]]></essentialContext>
            <outputFormat id="3.2" description="ê²°ê³¼ë¬¼ì´ ì¶œë ¥ë˜ì–´ì•¼ í•  ì •í™•í•œ í˜•ì‹ ë˜ëŠ” í…œí”Œë¦¿"><![CDATA[
{{outputFormatInstruction}}

### JSON ê°ì²´ ìŠ¤í‚¤ë§ˆ:
- **questionText**: [String] ì§ˆë¬¸ ë‚´ìš©.
- **type**: [String] ì§ˆë¬¸ ìœ í˜• ('multiple_choice', 'short_answer', 'subjective', 'case_based' ì¤‘ í•˜ë‚˜).
- **options**: [Array of Strings] 'multiple_choice' ìœ í˜•ì¼ ê²½ìš° 4ê°œì˜ ì„ íƒì§€ ë°°ì—´. ë‹¤ë¥¸ ìœ í˜•ì€ null.
- **answer**: [String] ì •ë‹µ. 'multiple_choice'ëŠ” ì •ë‹µ ì„ íƒì§€ì˜ í…ìŠ¤íŠ¸, 'short_answer'ëŠ” ê°„ê²°í•œ ì •ë‹µ ìš©ì–´, 'subjective' ë° 'case_based'ëŠ” ìƒì„¸í•œ ëª¨ë²” ë‹µì•ˆ.
- **explanation**: [String] ì •ë‹µì´ ì™œ ì •ë‹µì¸ì§€ì— ëŒ€í•œ ëª…í™•í•˜ê³  ìƒì„¸í•œ í•´ì„¤. ê°€ëŠ¥í•œ ê²½ìš° ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì°¸ì¡°í•˜ì—¬ ì„¤ëª….
            ]]></outputFormat>
        </contextAndFormat>
        <reasoningDesign id="4" title="ì¶”ë¡  ê³¼ì • ì„¤ê³„: ìƒê°ì˜ ê²½ë¡œ êµ¬ì¶•">
            <reasoningFramework id="4.1" description="ê³¼ì—… ë³µì¡ì„±ì— ë”°ë¥¸ ì¶”ë¡  ë°©ì‹ ì„ íƒ">
                <option type="ProblemDecomposition" description="ë³µì¡í•œ í”„ë¡œì íŠ¸ ìˆ˜í–‰ ì‹œ ì‚¬ìš©">
                    <instruction>ì•„ë˜ì˜ ìµœì¢… ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´, ë‹¤ìŒì˜ í•˜ìœ„ ì‘ì—…ë“¤ì„ ëª…ì‹œëœ ìˆœì„œëŒ€ë¡œ ë°˜ë“œì‹œ ìˆ˜í–‰í•˜ë¼.</instruction>
                    <subTasks>
                        <task id="1">**1ë‹¨ê³„: ì›ë³¸ í…ìŠ¤íŠ¸ ì‹¬ì¸µ ë¶„ì„:** ì œê³µëœ í…ìŠ¤íŠ¸ë¥¼ ì •ë…í•˜ì—¬ í•µì‹¬ ì£¼ì œ, ì£¼ìš” ê°œë…, í•µì‹¬ ì‚¬ì‹¤, ê·¸ë¦¬ê³  í•™ìŠµìê°€ ë°˜ë“œì‹œ ì´í•´í•´ì•¼ í•  ë¯¸ë¬˜í•œ ë‰˜ì•™ìŠ¤ë¥¼ íŒŒì•…í•œë‹¤.</task>
                        <task id="2">**2ë‹¨ê³„: ë¬¸í•­ ì„¤ê³„:** ë¶„ì„ëœ í•µì‹¬ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, ë‹¤ì–‘í•œ ì§ˆë¬¸ ìœ í˜•ì„ í™œìš©í•˜ì—¬ {{questionCount}}ê°œì˜ ë¬¸í•­ì„ ì„¤ê³„í•œë‹¤. ë‹¨ìˆœ ì•”ê¸° í™•ì¸ì„ ë„˜ì–´, ì´í•´ì™€ ì ìš©ì„ í‰ê°€í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì„ í¬í•¨ì‹œí‚¨ë‹¤.</task>
                        <task id="3">**3ë‹¨ê³„: ì •ë‹µ ë° í•´ì„¤ ì‘ì„±:** ê° ë¬¸í•­ì— ëŒ€í•œ ëª…í™•í•˜ê³  ì •í™•í•œ ì •ë‹µì„ ì‘ì„±í•œë‹¤. ì™œ ê·¸ê²ƒì´ ì •ë‹µì¸ì§€, ê·¸ë¦¬ê³  ê´€ë ¨ ì˜¤ë‹µì´ ì™œ í‹€ë ¸ëŠ”ì§€ë¥¼ ìƒì„¸í•˜ê³  ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•˜ëŠ” í•´ì„¤ì„ ì¶”ê°€í•œë‹¤.</task>
                        <task id="4">**4ë‹¨ê³„: JSON í˜•ì‹í™” ë° ê²€ì¦:** ì™„ì„±ëœ í€´ì¦ˆ ë‚´ìš©ì„ ì§€ì •ëœ JSON ìŠ¤í‚¤ë§ˆì— ë”°ë¼ ì •í™•í•˜ê²Œ í˜•ì‹í™”í•œë‹¤. ìµœì¢… ê²°ê³¼ë¬¼ì´ ìœ íš¨í•œ JSON ë°°ì—´ì¸ì§€ ë°˜ë“œì‹œ ê²€ì¦í•œë‹¤.</task>
                    </subTasks>
                </option>
            </reasoningFramework>
        </reasoningDesign>
        <constraints id="5" title="ì œì•½ ì¡°ê±´ ì„¤ì •: íƒìƒ‰ ê³µê°„ ì œì–´">
            <mustInclude id="5.1" description="ê²°ê³¼ë¬¼ì— ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•  ìš”ì†Œ">
                - ë°˜ë“œì‹œ {{questionCount}}ê°œì˜ ì§ˆë¬¸ ê°ì²´ë¥¼ í¬í•¨í•´ì•¼ í•œë‹¤.
                - ë°˜ë“œì‹œ ì§€ì •ëœ JSON ìŠ¤í‚¤ë§ˆë¥¼ ë”°ë¼ì•¼ í•œë‹¤.
                - ëª¨ë“  ì§ˆë¬¸, ì„ íƒì§€, í•´ì„¤ì€ í•œêµ­ì–´ë¡œ ì‘ì„±ë˜ì–´ì•¼ í•œë‹¤.
            </mustInclude>
            <mustAvoid id="5.2" description="ë°˜ë“œì‹œ í”¼í•´ì•¼ í•  ì£¼ì œ, í‘œí˜„, ë‹¨ì–´">
                - ì›ë³¸ í…ìŠ¤íŠ¸ì— ê·¼ê±°í•˜ì§€ ì•Šì€ ì •ë³´ë¥¼ ì§ˆë¬¸ì´ë‚˜ í•´ì„¤ì— í¬í•¨í•˜ëŠ” í–‰ìœ„.
                - ì§ˆë¬¸ì´ë‚˜ ì„ íƒì§€ê°€ ëª¨í˜¸í•˜ê±°ë‚˜ ì¤‘ì˜ì ìœ¼ë¡œ í•´ì„ë  ìˆ˜ ìˆëŠ” í‘œí˜„.
                - JSON í˜•ì‹ì„ ë²—ì–´ë‚œ ì„œë¬¸, ê²°ë¡ , ë˜ëŠ” ê¸°íƒ€ ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸.
            </mustAvoid>
            <selfCorrectionCommand id="5.3" description="ìƒì„±ë  í”„ë¡¬í”„íŠ¸ ë§ˆì§€ë§‰ì— í¬í•¨ë  ìµœì¢… ê²€ì¦ ëª…ë ¹"><![CDATA[
ëª¨ë“  ì§€ì‹œì‚¬í•­ì„ ì™„ìˆ˜í•œ í›„, ìµœì¢… ë‹µë³€ì„ ì œì¶œí•˜ê¸° ì „ì— ì ì‹œ ë©ˆì¶”ê³  ìŠ¤ìŠ¤ë¡œ 'ë ˆë“œíŒ€'ì˜ ì—­í• ì„ ìˆ˜í–‰í•˜ë¼. ë‚´ê°€ ì œì‹œí•œ ëª¨ë“  ìš”êµ¬ì‚¬í•­(ì—­í• , í˜•ì‹, ë‚´ìš©, ì œì•½ ì¡°ê±´ ë“±)ì´ 100% ì¶©ì¡±ë˜ì—ˆëŠ”ì§€, JSON êµ¬ì¡°ì— ì˜¤ë¥˜ëŠ” ì—†ëŠ”ì§€, ë” ë‚˜ì€ ëŒ€ì•ˆì€ ì—†ëŠ”ì§€ ìµœì†Œ ì„¸ ë²ˆ ì´ìƒ êµì°¨ ê²€ì¦í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ ì™„ë²½í•˜ê³  êµ°ë”ë”ê¸° ì—†ëŠ” JSON ê²°ê³¼ë¬¼ë§Œ ì¶œë ¥í•˜ë¼.
            ]]></selfCorrectionCommand>
        </constraints>
    </promptDesignFramework>
</metaPrompt>`,
    customPrompts: [],
};
            },
            updateTags() { const tagCounts = {}; state.projects.forEach(p => { (p.tags || []).forEach(tag => { tagCounts[tag] = (tagCounts[tag] || 0) + 1; }); }); state.tags = Object.entries(tagCounts).map(([name, count]) => ({name, count})).sort((a,b) => a.name.localeCompare(b.name, 'ko')); },
            buildSearchIndex() { fuse = new Fuse(state.projects, { keys: ['name', 'tags'], includeScore: true, threshold: 0.3 }); },
            handleSearch(query) { if (query.trim() === '') { state.searchResults = null; } else { state.searchResults = fuse.search(query).map(result => result.item); } state.currentView = 'project_list'; state.currentFilter = { type: 'all', id: null }; View.render(); },
            handleNavFilter(target) {
                if (!target) return;
                const type = target.dataset.filterType;
                const id = target.dataset.id || null;
                
                if (type === 'category' && state.categories.length === 0) return;
                if (type === 'tag' && state.tags.length === 0) return;
                
                state.currentFilter = { type, id };
                state.searchResults = null;
                const searchInput = document.getElementById('search-input');
                if(searchInput) searchInput.value = '';
                
                state.currentView = (type === 'dashboard') ? 'dashboard' : 'project_list';
                
                if (type === 'category' && !id) {
                    state.sidebarCollapseState.categories = false;
                } else if (type === 'tag' && !id) {
                    state.sidebarCollapseState.tags = false;
                }
                
                View.render();
                if (window.innerWidth <= 1024) this.closeSidebar();
            },
            getFilteredAndSortedProjects() {
                let filtered = state.searchResults ? state.searchResults : state.projects;
                if (!state.searchResults) {
                    const { type, id } = state.currentFilter;
                    if (type === 'category' && id) filtered = filtered.filter(p => p.categoryId === id);
                    else if (type === 'tag' && id) filtered = filtered.filter(p => p.tags?.includes(id));
                }
                const [field, direction] = state.currentSortOrder.split('_');
                return [...filtered].sort((a,b) => {
                    let valA = a[field] || 0; let valB = b[field] || 0;
                    if (field === 'name') return direction === 'asc' ? valA.localeCompare(valB, 'ko') : valB.localeCompare(valA, 'ko');
                    valA = new Date(valA).getTime() || 0; valB = new Date(valB).getTime() || 0;
                    return direction === 'asc' ? valA - valB : valB - valA;
                });
            },
            openModal(type, data = {}) { if(window.innerWidth <= 1024) Controller.closeSidebar(); state.modal = { isOpen: true, type, data }; View.render(); },
            closeModal() { state.modal = { isOpen: false, type: '', data: {} }; View.render(); },
            
            async openProject(id) {
                state.isLoading = true; View.render();
                try {
                    const project = await DB.get(CONFIG.STORES.PROJECTS, id);
                    if (project) {
                        Utils.normalizeTocNode(project.toc);
                        const allNodes = Utils.getAllNodePaths(project.toc);
                        const contents = await DB.getProjectContents(id);
                        state.activeContentsMap = new Map(contents.map(c => [c.id, c]));
                        const creationPromises = allNodes.map(nodeInfo => { const contentId = `${id}_${nodeInfo.path}`; if (!state.activeContentsMap.has(contentId)) { const newContent = { id: contentId, manuscript: '', notes: '', translation: '', questions: [], status: 'empty' }; state.activeContentsMap.set(contentId, newContent); return DB.put(CONFIG.STORES.CONTENTS, newContent); } return Promise.resolve(); });
                        await Promise.all(creationPromises);
                        state.activeProjectId = id;
                        state.activeProject = project;
                        state.currentView = 'workspace';
                        
                        // --- [ìˆ˜ì • ì‹œì‘] ---
                        // ê¸°ì¡´: const pathToSelect = allNodes.length > 0 ? allNodes[0].path : null;
                        
                        // ìœ íš¨í•œ ëª¨ë“  ì±•í„° ê²½ë¡œë¥¼ Setìœ¼ë¡œ ë§Œë“¤ì–´ ë¹ ë¥¸ ì¡°íšŒë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.
                        const allNodePaths = new Set(allNodes.map(n => n.path));
                        let pathToSelect = null;
                        
                        // í”„ë¡œì íŠ¸ì— ì €ì¥ëœ ë§ˆì§€ë§‰ ì±•í„° ê²½ë¡œê°€ ìˆê³ , ê·¸ ê²½ë¡œê°€ í˜„ì¬ ëª©ì°¨ì— ìœ íš¨í•œ ê²½ìš° í•´ë‹¹ ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                        if (project.lastChapterPath && allNodePaths.has(project.lastChapterPath)) {
                            pathToSelect = project.lastChapterPath;
                        } else if (allNodes.length > 0) { // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì²« ë²ˆì§¸ ì±•í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                            pathToSelect = allNodes[0].path;
                        }
                        // --- [ìˆ˜ì • ë] ---

                        if(pathToSelect) await this.selectChapter(pathToSelect, false); else { state.activeChapterPath = null; state.activeChapterContent = null; }
                    }
                } catch (error) { console.error("Failed to open project:", error); } 
                finally { state.isLoading = false; View.render(); }
            },
           
            async selectChapter(path, shouldRender = true) {
                this.saveScrollPosition();
                if (state.activeChapterPath === path && shouldRender) return;
                state.activeChapterPath = path;

                // --- [ì¶”ê°€ ì‹œì‘] ---
                // í˜„ì¬ í™œì„±í™”ëœ í”„ë¡œì íŠ¸ê°€ ìˆê³ , ë§ˆì§€ë§‰ ì±•í„° ê²½ë¡œê°€ í˜„ì¬ ì„ íƒí•œ ì±•í„°ì™€ ë‹¤ë¥¼ ê²½ìš° ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                if (state.activeProject && state.activeProject.lastChapterPath !== path) {
                    state.activeProject.lastChapterPath = path; // ë§ˆì§€ë§‰ ì±•í„° ê²½ë¡œ ì €ì¥
                    state.activeProject.updatedAt = new Date().toISOString(); // ìˆ˜ì •ì¼ì ì—…ë°ì´íŠ¸
                    await DB.put(CONFIG.STORES.PROJECTS, state.activeProject); // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                }
                // --- [ì¶”ê°€ ë] ---

                state.quizState = null;
                state.activeChapterContent = state.activeContentsMap.get(`${state.activeProjectId}_${path}`);
                if (shouldRender) View.render();
                if(state.isMobileSidebarOpen) this.closeSidebar();
            },
            async handleContentChange(event) {
                const { field, settingKey, customPromptKey } = event.target.dataset;
                const value = event.target.value;

                if (state.activeChapterContent && field) {
                    state.saveStatus = 'saving';
                    View.render();
                    const content = state.activeChapterContent;
                    content[field] = value;
                    if (field === 'manuscript' && value.trim() && (content.status === 'empty' || content.status === 'prompt-copied')) {
                        content.status = 'manuscript-done';
                    }
                    await DB.put(CONFIG.STORES.CONTENTS, content);
                    state.saveStatus = 'saved';
                    state.saveTimestamp = new Date();
                    View.render();
                    setTimeout(() => {
                        state.saveStatus = 'idle';
                        View.render();
                    }, 2000);
                } else if(state.modal.type === 'settings') {
                    if (settingKey === 'name') state.modal.data.projectName = value;
                    else if (settingKey === 'categoryId') state.modal.data.projectCategoryId = value;
                    else if (customPromptKey) {
                        const container = event.target.closest('[data-prompt-id]');
                        const promptId = container.dataset.promptId;
                        const prompt = state.modal.data.customPrompts.find(p => p.id === promptId);
                        if(prompt) {
                            prompt[customPromptKey] = value;
                        }
                    }
                }
            },
            showToast(message, type = 'info', duration = 3000) { const id = Utils.generateId('toast'); state.toasts.push({ id, message, type }); View.render(); setTimeout(() => Controller.dismissToast(id), duration); },
            dismissToast(id) { const toastEl = document.getElementById(`toast-${id}`); if(toastEl) { toastEl.style.transition = 'opacity 0.5s ease'; toastEl.style.opacity = 0; setTimeout(() => { state.toasts = state.toasts.filter(t => t.id !== id); View.render(); }, 500); } else { state.toasts = state.toasts.filter(t => t.id !== id); } },
            applyPostRenderEffects() {
                // KaTeX Rendering
                if (state.currentView === 'workspace' && state.workspaceMode === 'view' && state.isKaTeXLoaded && window.renderMathInElement) {
                    const viewPanel = document.querySelector('.prose.prose-readable');
                    if (viewPanel) {
                        try {
                            renderMathInElement(viewPanel, {
                                delimiters: [
                                    {left: '$$', right: '$$', display: true},
                                    {left: '$', right: '$', display: false},
                                    {left: '\\(', right: '\\)', display: false},
                                    {left: '\\[', right: '\\]', display: true}
                                ]
                            });
                        } catch (e) {
                            console.error("KaTeX rendering failed:", e);
                        }
                    }
                }
                // Restore scroll positions
                if (state.activeChapterPath) {
                    const keyPrefix = `${state.activeProjectId}_${state.activeChapterPath}`;
                    const elementsToRestore = ['manuscript', 'notes', 'translation'];
                    elementsToRestore.forEach(id => {
                        const el = document.getElementById(id);
                        const savedPosition = state.scrollPositions[`${keyPrefix}_${id}`];
                        if (el && savedPosition !== undefined) {
                            el.scrollTop = savedPosition;
                        }
                    });
                }
            },
            async submitNewProject(form) {
                const activeTab = state.modal.data.activeTab || 'blank';
                
                try {
                    let projectData, contentsData;
                    
                    if (['jsonText', 'tocJson'].includes(activeTab)) {
                        const textarea = form.querySelector('textarea');
                        try {
                            JSON.parse(textarea.value);
                            state.modal.data.error = '';
                        } catch (e) {
                            state.modal.data.error = `JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${e.message}`;
                            View.render();
                            return;
                        }
                    }

                    state.modal.data.isLoading = true;
                    state.modal.data.loadingMessage = 'í”„ë¡œì íŠ¸ ìƒì„± ì¤‘...';
                    View.render();
                    
                    if (activeTab === 'blank') {
                        const projectName = form.querySelector('#blank-project-name').value.trim();
                        const categoryId = form.querySelector('#blank-project-category').value;
                        if (!projectName) throw new Error("í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        ({ project: projectData, contents: contentsData } = this.processBlankProject(projectName, categoryId));
                    } else if (activeTab === 'zip') {
                        state.modal.data.loadingMessage = 'ZIP íŒŒì¼ ë¶„ì„ ì¤‘...';
                        View.render();
                        const fileInput = form.querySelector('#zip-upload');
                        if (!fileInput.files[0]) throw new Error("ZIP íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                        ({ project: projectData, contents: contentsData } = await this.processZipFile(fileInput.files[0]));
                    } else if (activeTab === 'jsonFile') {
                        const fileInput = form.querySelector('#json-upload'); if (!fileInput.files[0]) throw new Error("JSON íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                        if (fileInput.files[0].type.includes('zip') || fileInput.files[0].name.toLowerCase().endsWith('.zip')) { throw new Error("ZIP íŒŒì¼ì€ 'ZIP' íƒ­ì—ì„œ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤."); }
                        ({ project: projectData, contents: contentsData } = this.processJsonData(JSON.parse(await fileInput.files[0].text())));
                    } else if (activeTab === 'jsonText') {
                        const jsonTextInput = form.querySelector('#json-text-input');
                        ({ project: projectData, contents: contentsData } = this.processJsonData(JSON.parse(jsonTextInput.value)));
                    } else if (activeTab === 'tocJson') {
                        const tocJsonInput = form.querySelector('#toc-json-input');
                        ({ project: projectData, contents: contentsData } = this.processTocJson(JSON.parse(tocJsonInput.value)));
                    } else { throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ìƒì„± ë°©ì‹ì…ë‹ˆë‹¤."); }
                    
                    state.modal.data.loadingMessage = 'ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ì¤‘...';
                    View.render();

                    await DB.put(CONFIG.STORES.PROJECTS, projectData);
                    if (contentsData && contentsData.length > 0) {
                        await Promise.all(contentsData.map(c => DB.put(CONFIG.STORES.CONTENTS, c)));
                    }
                    
                    state.projects.unshift(projectData);
                    this.updateTags(); this.buildSearchIndex();
                    this.showToast(`'${projectData.name}' í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    this.closeModal();
                } catch (error) { 
                    console.error("Project creation failed:", error); 
                    this.showToast(`í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                    state.modal.data.isLoading = false;
                } finally { 
                    state.isLoading = false;
                    View.render(); 
                }
            },
            processBlankProject(name, categoryId) {
                const projectId = Utils.generateId('proj');
                const project = {
                    id: projectId,
                    name,
                    categoryId: categoryId || null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    toc: { title: name, children: [] },
                    settings: { ...CONFIG.DEFAULT_PROJECT_SETTINGS, customPrompts: [] }
                };
                return { project, contents: [] };
            },
            handleFileSelection(input) { const label = document.getElementById(input.dataset.targetLabel); if (label) { const fileName = input.files[0] ? input.files[0].name : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ'; label.textContent = fileName; label.title = fileName; } },
            async processZipFile(file) { const turndownService = new TurndownService(); const zip = await JSZip.loadAsync(file); const allEntries = []; zip.forEach((relPath, entry) => { const normPath = relPath.replace(/\/$/, '').replace(/\\/g, '/'); if (normPath && !normPath.startsWith('__MACOSX') && (entry.dir || /\.(html?|txt)$/i.test(normPath))) allEntries.push({ path: normPath, isDir: entry.dir, entry }); }); allEntries.sort((a, b) => Utils.naturalSort(a.path, b.path)); const projectToc = { title: Utils.formatTitle(file.name), children: [] }; const pathMap = new Map(); for (const { path } of allEntries) { let currentNode = projectToc; let currentPath = ''; path.split('/').forEach((part) => { currentPath = currentPath ? `${currentPath}/${part}` : part; let childNode = pathMap.get(currentPath); if (!childNode) { childNode = { title: Utils.formatTitle(part), originalPath: path }; currentNode.children.push(childNode); pathMap.set(currentPath, childNode); } currentNode = childNode; }); } Utils.normalizeTocNode(projectToc); const projectId = Utils.generateId('proj'); const project = { id: projectId, name: projectToc.title, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), toc: projectToc, settings: { ...CONFIG.DEFAULT_PROJECT_SETTINGS } }; const contents = (await Promise.all(Utils.getAllNodePaths(projectToc).map(async ({ path, node }) => { const fileEntry = allEntries.find(f => f.path === node.originalPath)?.entry; let manuscript = ''; if (fileEntry && !fileEntry.dir) { if (/\.html?$/i.test(fileEntry.name)) { const rawHtml = await fileEntry.async('string'); const bodyMatch = rawHtml.match(/<body[^>]*>([\s\S]*)<\/body>/i); manuscript = turndownService.turndown(DOMPurify.sanitize(bodyMatch ? bodyMatch[1] : '')); } else { manuscript = await fileEntry.async('string'); } } return { id: `${projectId}_${path}`, manuscript, notes: '', translation: '', questions: [], status: manuscript.trim() ? 'manuscript-done' : 'empty' }; }))).filter(Boolean); return { project, contents }; },
            processJsonData(data) {
                if (data.type !== CONFIG.EXPORT_TYPE_ID) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ í”„ë¡œì íŠ¸ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
                const newId = Utils.generateId('proj');
                const newProject = { ...data.project, id: newId, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
                Utils.normalizeTocNode(newProject.toc);
                const allNodes = Utils.getAllNodePaths(newProject.toc);
                const contentMap = new Map(data.contents.map(c => [c.path, c]));
                const newContents = allNodes.map(nodeInfo => {
                    const originalContent = contentMap.get(nodeInfo.path) || {};
                    const { path, ...rest } = originalContent;
                    return { id: `${newId}_${nodeInfo.path}`, manuscript: '', notes: '', translation: '', questions: [], status: 'empty', ...rest };
                });
                return { project: newProject, contents: newContents };
            },
            processTocJson(tocData) {
                if (!tocData.title || !Array.isArray(tocData.children)) { throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ ëª©ì°¨ JSON í˜•ì‹ì…ë‹ˆë‹¤. ìµœìƒìœ„ ê°ì²´ì— 'title'ê³¼ 'children' ì†ì„±ì´ í•„ìš”í•©ë‹ˆë‹¤."); }
                const projectId = Utils.generateId('proj');
                const finalToc = { title: tocData.title, children: tocData.children }; Utils.normalizeTocNode(finalToc);
                const project = { id: projectId, name: finalToc.title, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), toc: finalToc, settings: { ...CONFIG.DEFAULT_PROJECT_SETTINGS } };
                const contents = Utils.getAllNodePaths(finalToc).map(({ path, node }) => ({ id: `${projectId}_${path}`, manuscript: '', notes: node.description || '', translation: '', questions: [], status: 'empty' }));
                return { project, contents };
            },
            copyToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.top = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    } else {
                        throw new Error('Copy command failed');
                    }
                } catch (err) {
                    console.error("Clipboard copy failed:", err);
                    this.showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
                document.body.removeChild(textArea);
            },
            copyPromptForCurrentChapter() {
                if (!state.activeProject || !state.activeChapterPath) return; 
                const { settings, toc } = state.activeProject; 
                const chapterNode = Utils.getNodeByPath(toc, state.activeChapterPath); 
                if (!chapterNode) return; 
                const pathParts = state.activeChapterPath.split('.').map(Number); 
                const partNode = toc.children?.[pathParts[0]]; 
                const fullTocText = Utils.generateTocText(toc, 0, '', state.activeChapterPath); 
                const partTocText = partNode ? Utils.generateTocText(partNode, 0, '', pathParts.slice(1).join('.')) : ''; 
                const chapterDescription = state.activeChapterContent.notes || chapterNode.description || ''; 
                let prompt = settings.writingPrompt || CONFIG.DEFAULT_PROJECT_SETTINGS.writingPrompt; 
                prompt = prompt.replace(/{{bookTitle}}/g, toc.title).replace(/{{projectGenre}}/g, settings.writingGenre).replace(/{{projectAgeGroup}}/g, settings.writingAgeGroup).replace(/{{projectAudience}}/g, settings.writingAudience).replace(/{{references}}/g, settings.writingReferences).replace(/{{partTitle}}/g, partNode?.title).replace(/{{partDescription}}/g, partNode?.description || '').replace(/{{chapterTitle}}/g, chapterNode.title).replace(/{{chapterDescription}}/g, chapterDescription).replace(/{{fullToc}}/g, fullTocText).replace(/{{partToc}}/g, partTocText).replace(/{{projectStyleExample}}/g, settings.writingStyle); 
                this.copyToClipboard(prompt);
            },
            copyTranslationPrompt() { 
                if (!state.activeChapterContent?.manuscript) return this.showToast('ë²ˆì—­í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                let prompt = state.activeProject.settings.translationPrompt || CONFIG.DEFAULT_PROJECT_SETTINGS.translationPrompt;
                prompt = prompt.replace('{{text}}', state.activeChapterContent.manuscript);
                this.copyToClipboard(prompt);
            },
            buildQuizPrompt() { 
                const turndownService = new TurndownService();
                if (!state.activeChapterContent?.manuscript) return null;
                const sourceHtml = marked.parse(state.activeChapterContent.manuscript);
                const sourceText = turndownService.turndown(sourceHtml);
                if (!sourceText.trim()) return null;
                const settings = state.activeProject.settings;
                const template = settings.quizPromptTemplate || CONFIG.DEFAULT_PROJECT_SETTINGS.quizPromptTemplate;
                return template.replace('{{taskDescription}}', settings.quizTaskDescription).replace('{{outputFormatInstruction}}', settings.quizOutputFormatInstruction).replace('{{questionCount}}', settings.quizQuestionCount).replace('{{text}}', sourceText.substring(0, 15000));
            },
            async generateQuiz() { 
                let apiKey = localStorage.getItem('googleApiKey'); if(!apiKey) return this.openModal('apiKey');
                const prompt = this.buildQuizPrompt(); if (!prompt) { this.showToast('í€´ì¦ˆë¥¼ ìƒì„±í•  í•™ìŠµ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                this.showToast('AIê°€ ë¬¸ì œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
                const spinnerEl = document.querySelector('[data-action="generate-quiz"]');
                if(spinnerEl) spinnerEl.innerHTML = `<div class="w-5 h-5 border-2 border-slate-500 border-t-transparent rounded-full animate-spin"></div>`;
                try { 
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); 
                    if (!response.ok) throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.statusText}`); 
                    const result = await response.json(); 
                    const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text; 
                    if(!responseText) throw new Error("AIë¡œë¶€í„° ë¹ˆ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤."); 
                    const jsonMatch = responseText.match(/<json_response>([\s\S]*?)<\/json_response>/); 
                    const jsonText = jsonMatch ? jsonMatch[1].trim() : responseText.match(/\[[\s\S]*\]/)?.[0] || responseText.trim(); 
                    const questions = JSON.parse(jsonText); 
                    const content = state.activeChapterContent; content.questions = [...(content.questions || []), ...questions]; 
                    content.status = 'quiz-done'; 
                    await DB.put(CONFIG.STORES.CONTENTS, content); 
                    this.showToast(`${questions.length}ê°œì˜ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success'); 
                    View.render(); 
                } catch (error) { 
                    console.error("Quiz generation failed:", error); this.showToast(`ë¬¸ì œ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error'); 
                } finally {
                    if(spinnerEl) spinnerEl.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>AIë¡œ ë¬¸ì œ ì¶”ê°€`;
                    lucide.createIcons();
                }
            },
            startQuiz() {
                const questions = state.activeChapterContent.questions; if (!questions?.length) return;
                const processed = JSON.parse(JSON.stringify(questions)).map(q => { if (q.type === CONFIG.QUIZ_TYPE.MULTIPLE_CHOICE) q.answerIndex = q.options.findIndex(opt => opt === q.answer); return q; });
                state.quizState = { questions: [...processed].sort(() => Math.random() - 0.5), currentIndex: 0, answers: [] };
                state.currentView = 'quiz'; View.render();
            },
            async finishQuiz() {
                const correctAnswers = state.quizState.answers.filter(a => a.isCorrect).length;
                const xpGained = correctAnswers * 100;
                if (xpGained > 0) {
                    const newXp = state.userProfile.xp + xpGained;
                    let newLevel = state.userProfile.level;
                    while (CONFIG.LEVEL_THRESHOLDS[newLevel] !== undefined && newXp >= CONFIG.LEVEL_THRESHOLDS[newLevel]) { newLevel++; }
                    if (newLevel > state.userProfile.level) { this.showToast(`ë ˆë²¨ ì—…! LV.${newLevel} ë‹¬ì„±!`, 'success'); }
                    state.userProfile.xp = newXp; state.userProfile.level = newLevel;
                    await DB.put(CONFIG.STORES.USER_PROFILE, state.userProfile);
                }
                state.currentView = 'quizResult';
                this.showToast(`í€´ì¦ˆ ì™„ë£Œ! +${xpGained} XP`, 'success');
                View.render();
            },
            handleTocTitleEdit(input) { const node = Utils.getNodeByPath(state.modal.data.editableToc, input.dataset.path); if (node) node.title = input.value; },
            async saveToc() {
                const originalToc = state.activeProject.toc; 
                const modifiedToc = state.modal.data.editableToc; 
                state.isLoading = true; this.closeModal(); View.render(); 
                try { 
                    const projectId = state.activeProjectId; 
                    const oldPaths = new Set(Utils.getAllNodePaths(originalToc).map(c => c.path)); 
                    const newPaths = new Set(Utils.getAllNodePaths(modifiedToc).map(c => c.path)); 
                    const addedNodes = Utils.getAllNodePaths(modifiedToc).filter(c => !oldPaths.has(c.path)); 
                    const deletedNodes = Utils.getAllNodePaths(originalToc).filter(c => !newPaths.has(c.path)); 
                    const promises = []; 
                    for (const node of deletedNodes) { const contentId = `${projectId}_${node.path}`; promises.push(DB.delete(CONFIG.STORES.CONTENTS, contentId)); state.activeContentsMap.delete(contentId); } 
                    for (const node of addedNodes) { const contentId = `${projectId}_${node.path}`; const newContent = { id: contentId, manuscript: '', notes: '', translation: '', questions: [], status: 'empty' }; promises.push(DB.put(CONFIG.STORES.CONTENTS, newContent)); state.activeContentsMap.set(contentId, newContent); } 
                    if (state.activeChapterPath && !newPaths.has(state.activeChapterPath)) { state.activeChapterPath = null; state.activeChapterContent = null; } 
                    state.activeProject.toc = modifiedToc; 
                    state.activeProject.updatedAt = new Date().toISOString(); 
                    promises.push(DB.put(CONFIG.STORES.PROJECTS, state.activeProject)); 
                    await Promise.all(promises); 
                    this.showToast('ëª©ì°¨ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); 
                } catch (error) { console.error("Failed to save TOC:", error); this.showToast(`ëª©ì°¨ ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error'); } 
                finally { state.isLoading = false; View.render(); }
            },
            buildSplitChapterPrompt() {
                const sourceText = state.activeChapterContent.translation;
                if (!sourceText?.trim()) { this.showToast('ë¶„í• í•  ë²ˆì—­ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.', 'error'); return null; }
                const paragraphs = sourceText.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
                if (paragraphs.length < 2) { this.showToast('ë¶„í• í•˜ê¸°ì— ë‚´ìš©ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); return null; }
                const numberedContent = paragraphs.map((p, i) => `[Paragraph ${i + 1}] ${p}`).join('\n\n');
                
                const prompt = `<Prime_Directive>Analyze the provided text, which is broken into numbered paragraphs, and identify logical division points to create sub-chapters.</Prime_Directive><purpose>
                    **1. First, count the total number of paragraphs in the provided text and state it clearly.**
                    **2. Analyze the ENTIRE provided text from beginning to end to understand its structure and flow.**
                    **3. Divide the content into an appropriate number of sub-chapters. Each sub-chapter's content should be approximately 10KB in size (around 3400 Korean characters). The number of chapters should be determined by this size constraint, not a fixed number.**
                    4. Each sub-chapter should represent a distinct sub-topic or section of the main text.
                    5. The sub-chapters MUST collectively cover the entire document's content. The start points of the sub-chapters should be distributed throughout the text.
                    6. Your output MUST be a valid JSON array of objects following the specified schema. Do not add any explanation or commentary outside the JSON markup.
                </purpose><Output_Specification><Format>JSON Array</Format><Schema>[ { "sub_chapter_title": "A descriptive title for the first sub-topic.", "start_paragraph": 1 }, { "sub_chapter_title": "Title for the second sub-topic.", "start_paragraph": ... } ]</Schema><interaction_language>Korean</interaction_language></Output_Specification><data content="formatted_content">--- START OF DATA ---${numberedContent}--- END OF DATA ---</data>`;
                
                return prompt.trim();
            },
            async handleSplitChapterSubmit(form) {
                const jsonContent = new FormData(form).get('jsonContent'); if (!jsonContent) return;
                state.isLoading = true; this.closeModal(); View.render();
                try {
                    const subChaptersData = JSON.parse(jsonContent.trim().match(/\[[\s\S]*\]/)?.[0] || '[]');
                    if (!Array.isArray(subChaptersData) || !subChaptersData.every(i => i.sub_chapter_title && i.start_paragraph)) throw new Error('Invalid JSON format.');
                    const paragraphs = state.activeChapterContent.translation.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
                    const projectId = state.activeProjectId;
                    const parentPath = state.activeChapterPath;
                    const parentNode = Utils.getNodeByPath(state.activeProject.toc, parentPath);
                    const initialChildCount = parentNode.children.length;
                    const creationPromises = [];
                    subChaptersData.sort((a, b) => a.start_paragraph - b.start_paragraph);
                    for (let i = 0; i < subChaptersData.length; i++) {
                        const start = subChaptersData[i].start_paragraph - 1;
                        const end = (i < subChaptersData.length - 1) ? subChaptersData[i + 1].start_paragraph - 1 : paragraphs.length;
                        const content = paragraphs.slice(start, end).join('\n\n');
                        const newChildNode = { title: subChaptersData[i].sub_chapter_title, children: [] };
                        parentNode.children.push(newChildNode);
                        const newChildPath = `${parentPath}.${initialChildCount + i}`;
                        const newContent = { id: `${projectId}_${newChildPath}`, manuscript: content, notes: `Original content from '${parentNode.title}'.`, translation: '', questions: [], status: 'manuscript-done' };
                        state.activeContentsMap.set(newContent.id, newContent);
                        creationPromises.push(DB.put(CONFIG.STORES.CONTENTS, newContent));
                    }
                    state.activeChapterContent.translation = `[ë²ˆì—­ë¬¸ì´ ${subChaptersData.length}ê°œì˜ í•˜ìœ„ ë…¸íŠ¸ë¡œ ë¶„í• ë˜ì—ˆìŠµë‹ˆë‹¤.]`;
                    creationPromises.push(DB.put(CONFIG.STORES.CONTENTS, state.activeChapterContent));
                    state.activeProject.updatedAt = new Date().toISOString();
                    creationPromises.push(DB.put(CONFIG.STORES.PROJECTS, state.activeProject));
                    await Promise.all(creationPromises);
                    this.showToast('ë²ˆì—­ë¬¸ ë¶„í•  ë° í•˜ìœ„ ì±•í„° ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) { console.error("Chapter split failed:", error); this.showToast(`ì±•í„° ë¶„í•  ì‹¤íŒ¨: ${error.message}`, 'error'); }
                finally { state.isLoading = false; View.render(); }
            },
            navigateChapter(direction) {
                if (!state.activeProject || !state.activeChapterPath) return;
                const allNodes = Utils.getFlatToc(state.activeProject.toc);
                const currentIndex = allNodes.findIndex(node => node.path === state.activeChapterPath);
                if (currentIndex === -1) return;
                const nextIndex = currentIndex + direction;
                if (nextIndex >= 0 && nextIndex < allNodes.length) {
                    const nextChapterPath = allNodes[nextIndex].path;
                    this.selectChapter(nextChapterPath);
                }
            },
            toggleSidebar() {
                if (window.innerWidth <= 1024) {
                    state.isMobileSidebarOpen = !state.isMobileSidebarOpen;
                } else {
                    state.isSidebarOpen = !state.isSidebarOpen;
                }
                View.render();
            },
            closeSidebar() {
                if (state.isMobileSidebarOpen) {
                    state.isMobileSidebarOpen = false;
                    View.render();
                }
            },
            handleTocDragStart(e) {
                const item = e.target.closest('.toc-drag-item');
                if (item) {
                    state.modal.data.draggedPath = item.dataset.path;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', item.dataset.path);
                }
            },
            handleTocDragOver(e) {
                e.preventDefault();
                const targetItem = e.target.closest('.toc-drag-item');
                document.querySelectorAll('.toc-drop-indicator-before, .toc-drop-indicator-after, .toc-drop-indicator-inside').forEach(el => el.classList.remove('toc-drop-indicator-before', 'toc-drop-indicator-after', 'toc-drop-indicator-inside'));

                if (targetItem) {
                    const rect = targetItem.getBoundingClientRect();
                    const dropZoneHeight = rect.height / 3;
                    if (e.clientY < rect.top + dropZoneHeight) {
                        targetItem.classList.add('toc-drop-indicator-before');
                        state.modal.data.dropTarget = { path: targetItem.dataset.path, position: 'before' };
                    } else if (e.clientY > rect.bottom - dropZoneHeight) {
                        targetItem.classList.add('toc-drop-indicator-after');
                        state.modal.data.dropTarget = { path: targetItem.dataset.path, position: 'after' };
                    } else {
                        targetItem.classList.add('toc-drop-indicator-inside');
                        state.modal.data.dropTarget = { path: targetItem.dataset.path, position: 'inside' };
                    }
                }
            },
            handleTocDragLeave(e) {
                document.querySelectorAll('.toc-drop-indicator-before, .toc-drop-indicator-after, .toc-drop-indicator-inside').forEach(el => el.classList.remove('toc-drop-indicator-before', 'toc-drop-indicator-after', 'toc-drop-indicator-inside'));
            },
            handleTocDrop(e) {
                e.preventDefault();
                document.querySelectorAll('.toc-drop-indicator-before, .toc-drop-indicator-after, .toc-drop-indicator-inside').forEach(el => el.classList.remove('toc-drop-indicator-before', 'toc-drop-indicator-after', 'toc-drop-indicator-inside'));

                const draggedPath = state.modal.data.draggedPath;
                const dropTarget = state.modal.data.dropTarget;

                if (!draggedPath || !dropTarget || dropTarget.path === draggedPath || dropTarget.path.startsWith(draggedPath + '.')) return;

                const toc = state.modal.data.editableToc;
                const { parent: draggedParent, index: draggedIndex } = Utils.getParentNodeAndIndexByPath(toc, draggedPath);
                if(!draggedParent) return;

                const [draggedNode] = draggedParent.children.splice(draggedIndex, 1);

                if (dropTarget.position === 'inside') {
                    const newParentNode = Utils.getNodeByPath(toc, dropTarget.path);
                    if (newParentNode) {
                        if (!newParentNode.children) newParentNode.children = [];
                        newParentNode.children.push(draggedNode);
                    }
                } else {
                    const { parent: targetParent, index: targetIndex } = Utils.getParentNodeAndIndexByPath(toc, dropTarget.path);
                    if(!targetParent) return;
                    const insertIndex = dropTarget.position === 'before' ? targetIndex : targetIndex + 1;
                    targetParent.children.splice(insertIndex, 0, draggedNode);
                }

                state.modal.data.draggedPath = null;
                state.modal.data.dropTarget = null;
                View.render();
            },
            handleTagInput(input) {
                const value = input.value.toLowerCase();
                const suggestionsContainer = document.getElementById('tag-suggestions');
                if (!value) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                const existingTags = state.modal.data.projectTags || [];
                const availableTags = state.tags.map(t => t.name).filter(t => !existingTags.includes(t));
                const filtered = availableTags.filter(tag => tag.toLowerCase().includes(value));
                
                if(filtered.length > 0) {
                    suggestionsContainer.innerHTML = filtered.map(tag => `<div class="p-2 hover:bg-slate-100 cursor-pointer" data-action="select-tag-suggestion" data-tag="${tag}">${tag}</div>`).join('');
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            },
            handleTagInputKeydown(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const tag = e.target.value.trim();
                    if (tag) {
                        Controller.addTagToProject(tag);
                        e.target.value = '';
                        document.getElementById('tag-suggestions').classList.add('hidden');
                    }
                }
            },
            addTagToProject(tag) {
                if (!state.modal.data.projectTags) {
                    state.modal.data.projectTags = [];
                }
                if (!state.modal.data.projectTags.includes(tag)) {
                    state.modal.data.projectTags.push(tag);
                    View.render();
                }
            },
            saveScrollPosition() {
                if (!state.activeChapterPath) return;
                const keyPrefix = `${state.activeProjectId}_${state.activeChapterPath}`;
                const elementsToSave = ['manuscript', 'notes', 'translation'];
                elementsToSave.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        state.scrollPositions[`${keyPrefix}_${id}`] = el.scrollTop;
                    }
                });
            },
            ACTION_HANDLERS: {
                'toggle-sidebar': () => Controller.toggleSidebar(),
                'close-sidebar': () => Controller.closeSidebar(),
                'go-dashboard': () => {
                    state.currentView = 'dashboard'; state.currentFilter = { type: 'dashboard', id: null };
                    state.activeProjectId = null; state.activeProject = null; View.render();
                },
                'prev-chapter': () => Controller.navigateChapter(-1),
                'next-chapter': () => Controller.navigateChapter(1),
                'filter': (el) => Controller.handleNavFilter(el),
                'new-category': async () => { const name = prompt('ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:'); if (name?.trim()) { const newCategory = { id: Utils.generateId('cat'), name: name.trim() }; await DB.put(CONFIG.STORES.CATEGORIES, newCategory); state.categories.push(newCategory); state.categories.sort((a,b) => a.name.localeCompare(b.name)); View.render(); } },
                'sort-projects': (select) => { state.currentSortOrder = select.value; View.render(); },
                'new-project': () => Controller.openModal('newProject', {activeTab: 'blank'}),
                'open-project': (el) => Controller.openProject(el.dataset.id),
                'export-project': (el) => { this.exportProject(el.dataset.id) },
                'delete-project-confirm': (el) => { const project = state.projects.find(p => p.id === el.dataset.id); if (!project) return; Controller.openModal('confirm', { title: 'í”„ë¡œì íŠ¸ ì‚­ì œ í™•ì¸', message: `'${project.name}' í”„ë¡œì íŠ¸ì™€ ëª¨ë“  ê´€ë ¨ ë°ì´í„°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, confirmText: 'ì‚­ì œ', onConfirm: async () => { await DB.deleteProjectAndContents(project.id); state.projects = state.projects.filter(p => p.id !== project.id); Controller.updateTags(); Controller.buildSearchIndex(); Controller.showToast('í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); if(state.currentView !== 'dashboard' && state.currentFilter.type !== 'all') { Controller.ACTION_HANDLERS['go-dashboard'](); } else { View.render(); } } }); },
                'close-modal': () => Controller.closeModal(),
                'close-modal-overlay': (el, e) => { if(e.target === el) Controller.closeModal(); },
                'confirm-action': () => { const onConfirm = state.modal.data.onConfirm; if (typeof onConfirm === 'function') onConfirm(); Controller.closeModal(); },
                'switch-mode': (el) => { Controller.saveScrollPosition(); state.workspaceMode = el.dataset.mode; View.render(); },
                'select-chapter': (el) => Controller.selectChapter(el.dataset.path),
                'toggle-toc-collapse': (el) => { const path = el.dataset.path; state.tocCollapseState[path] = !state.tocCollapseState[path]; View.render(); },
                'submit-new-project': (form) => Controller.submitNewProject(form),
                'switch-modal-tab': (el) => { state.modal.data.activeTab = el.dataset.tab; View.render(); },
                'open-settings': () => Controller.openModal('settings', {
                    projectName: state.activeProject.name,
                    projectCategoryId: state.activeProject.categoryId,
                    projectTags: [...(state.activeProject.tags || [])],
                    customPrompts: JSON.parse(JSON.stringify(state.activeProject.settings.customPrompts || []))
                }),
                'save-settings': async (form) => {
                    form.querySelectorAll('[data-setting-key]').forEach(input => {
                        const key = input.dataset.settingKey;
                        if(key === 'name') state.activeProject.name = input.value;
                        else if (key === 'categoryId') state.activeProject.categoryId = input.value;
                        else state.activeProject.settings[key] = input.type === 'number' ? parseInt(input.value, 10) : input.value;
                    });
                    state.activeProject.tags = state.modal.data.projectTags;
                    
                    const newCustomPrompts = [];
                    const promptContainers = form.querySelectorAll('#custom-prompts-container > div');
                    promptContainers.forEach(container => {
                        const id = container.dataset.promptId;
                        const nameInput = container.querySelector('[data-custom-prompt-key="name"]');
                        const templateInput = container.querySelector('[data-custom-prompt-key="template"]');
                        if (id && nameInput && templateInput) {
                            newCustomPrompts.push({
                                id,
                                name: nameInput.value.trim(),
                                template: templateInput.value.trim()
                            });
                        }
                    });
                    state.activeProject.settings.customPrompts = newCustomPrompts;

                    state.activeProject.updatedAt = new Date().toISOString();
                    await DB.put(CONFIG.STORES.PROJECTS, state.activeProject); 
                    Controller.updateTags();
                    Controller.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); 
                    Controller.closeModal(); 
                    View.render();
                },
                'add-custom-prompt': () => {
                    state.modal.data.customPrompts.push({
                        id: Utils.generateId('cp'),
                        name: 'ìƒˆ ë²„íŠ¼',
                        template: 'ì—¬ê¸°ì— í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì„ ì…ë ¥í•˜ì„¸ìš”.'
                    });
                    View.render();
                },
                'remove-custom-prompt': (el) => {
                    const idToRemove = el.dataset.id;
                    state.modal.data.customPrompts = state.modal.data.customPrompts.filter(p => p.id !== idToRemove);
                    View.render();
                },
                'copy-custom-prompt': (el) => {
                    const index = parseInt(el.dataset.index, 10);
                    const customPrompts = state.activeProject.settings.customPrompts || [];
                    const promptToCopy = customPrompts[index];

                    if (!promptToCopy || !promptToCopy.template) {
                        return Controller.showToast('í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', 'error');
                    }
                    
                    const { settings, toc } = state.activeProject;
                    const chapterNode = Utils.getNodeByPath(toc, state.activeChapterPath);
                    if (!chapterNode) {
                        return Controller.showToast('í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € ì±•í„°ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    }

                    const pathParts = state.activeChapterPath.split('.').map(Number);
                    const partNode = toc.children?.[pathParts[0]];
                    const fullTocText = Utils.generateTocText(toc, 0, '', state.activeChapterPath);
                    const partTocText = partNode ? Utils.generateTocText(partNode, 0, '', pathParts.slice(1).join('.')) : '';
                    const chapterDescription = state.activeChapterContent.notes || chapterNode.description || '';
                    const manuscript = state.activeChapterContent.manuscript || '';
                    const translation = state.activeChapterContent.translation || '';
                    const notes = state.activeChapterContent.notes || '';


                    let prompt = promptToCopy.template;
                    const replacements = {
                        '{{bookTitle}}': toc.title,
                        '{{projectGenre}}': settings.writingGenre,
                        '{{projectAgeGroup}}': settings.writingAgeGroup,
                        '{{projectAudience}}': settings.writingAudience,
                        '{{references}}': settings.writingReferences,
                        '{{partTitle}}': partNode?.title || '',
                        '{{partDescription}}': partNode?.description || '',
                        '{{chapterTitle}}': chapterNode.title,
                        '{{chapterDescription}}': chapterDescription,
                        '{{fullToc}}': fullTocText,
                        '{{partToc}}': partTocText,
                        '{{projectStyleExample}}': settings.writingStyle,
                        '{{manuscript}}': manuscript,
                        '{{translation}}': translation,
                        '{{notes}}': notes,
                    };

                    for (const [key, value] of Object.entries(replacements)) {
                        const placeholder = key.replace(/{{/g, '{{\\s*').replace(/}}/g, '\\s*}}');
                        prompt = prompt.replace(new RegExp(placeholder, 'g'), value || '');
                    }

                    Controller.copyToClipboard(prompt);
                },
                'copy-writing-prompt': () => Controller.copyPromptForCurrentChapter(),
                'copy-translation-prompt': () => Controller.copyTranslationPrompt(),
                'manage-quiz': () => Controller.openModal('manageQuiz'),
                'generate-quiz': () => Controller.generateQuiz(),
                'submit-api-key': (form) => { const key = form.querySelector('#api-key-input').value; if (key) { localStorage.setItem('googleApiKey', key); Controller.closeModal(); } },
                'copy-quiz-prompt': () => { const prompt = Controller.buildQuizPrompt(); if(prompt) Controller.copyToClipboard(prompt); else Controller.showToast('í€´ì¦ˆ ìƒì„±ì„ ìœ„í•œ ë‚´ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error'); },
                'add-questions-from-json': async (form) => { const jsonContent = new FormData(form).get('jsonContent'); try { const questions = JSON.parse(jsonContent.trim().match(/\[[\s\S]*\]/)?.[0] || '[]'); const content = state.activeChapterContent; content.questions = [...(content.questions || []), ...questions]; content.status = 'quiz-done'; await DB.put(CONFIG.STORES.CONTENTS, content); state.activeContentsMap.set(content.id, content); Controller.showToast(`${questions.length}ê°œì˜ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success'); View.render(); } catch (e) { Controller.showToast(`ìœ íš¨í•˜ì§€ ì•Šì€ JSONì…ë‹ˆë‹¤: ${e.message}`, 'error'); } },
                'delete-quiz-question': async (el) => { state.activeChapterContent.questions.splice(parseInt(el.dataset.index, 10), 1); await DB.put(CONFIG.STORES.CONTENTS, state.activeChapterContent); state.activeContentsMap.set(state.activeChapterContent.id, state.activeChapterContent); View.render(); },
                'start-quiz': () => Controller.startQuiz(),
                'exit-quiz': () => Controller.openModal('confirm', { title: 'í€´ì¦ˆ ë‚˜ê°€ê¸°', message: 'í€´ì¦ˆë¥¼ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', confirmText: 'ë‚˜ê°€ê¸°', onConfirm: () => { state.quizState = null; state.currentView = 'workspace'; View.render(); } }),
                'submit-answer': (el) => { const q = state.quizState.questions[state.quizState.currentIndex]; const selectedIndex = parseInt(el.dataset.index, 10); state.quizState.answers[state.quizState.currentIndex] = { selectedIndex, isCorrect: selectedIndex === q.answerIndex }; View.render(); },
                'submit-text-answer': (form) => { const userAnswer = new FormData(form).get('answer-input') || ''; const q = state.quizState.questions[state.quizState.currentIndex]; state.quizState.answers[state.quizState.currentIndex] = { userAnswer, isCorrect: userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase() }; View.render(); },
                'next-question': () => { if(state.quizState.currentIndex < state.quizState.questions.length - 1) { state.quizState.currentIndex++; } else { Controller.finishQuiz(); } View.render(); },
                'back-to-workspace': () => { state.quizState = null; state.currentView = 'workspace'; View.render(); },
                'manage-toc': () => Controller.openModal('manageToc', { editableToc: JSON.parse(JSON.stringify(state.activeProject.toc)) }),
                'toc-add-child': (el) => { const parentNode = Utils.getNodeByPath(state.modal.data.editableToc, el.dataset.path); parentNode.children.push({ title: "ìƒˆ í•­ëª©", children: [] }); View.render(); },
                'toc-add-root-item': () => { state.modal.data.editableToc.children.push({ title: "ìƒˆ ìµœìƒìœ„ í•­ëª©", children: [] }); View.render(); },
                'toc-delete': (el) => { const { parent, index } = Utils.getParentNodeAndIndexByPath(state.modal.data.editableToc, el.dataset.path); if (parent?.children) { parent.children.splice(index, 1); View.render(); } },
                'save-toc': () => Controller.saveToc(),
                'open-split-chapter-modal': () => {
                    const prompt = Controller.buildSplitChapterPrompt();
                    if (prompt) {
                        Controller.copyToClipboard(prompt);
                        Controller.openModal('splitChapter');
                    }
                },
                'submit-split-chapter': (form) => Controller.handleSplitChapterSubmit(form),
                'dismiss-toast': (el) => Controller.dismissToast(el.dataset.id),
                'remove-tag': (el) => { const tagToRemove = el.dataset.tag; state.modal.data.projectTags = state.modal.data.projectTags.filter(t => t !== tagToRemove); View.render(); },
                'select-tag-suggestion': (el) => { Controller.addTagToProject(el.dataset.tag); document.getElementById('setting-tags-input').value = ''; document.getElementById('tag-suggestions').classList.add('hidden'); },
                'toggle-sidebar-section': (el) => { const section = el.dataset.section; state.sidebarCollapseState[section] = !state.sidebarCollapseState[section]; View.render(); },
                'toggle-toc-all': (el) => {
                    const mode = el.dataset.mode;
                    const allPaths = Utils.getFlatToc(state.activeProject.toc).map(item => item.path);
                    if (mode === 'collapse') {
                        allPaths.forEach(path => state.tocCollapseState[path] = true);
                    } else {
                        state.tocCollapseState = {};
                    }
                    View.render();
                },
                'set-workspace-layout': (el) => { state.workspaceLayout = el.dataset.layout; View.render(); },
                'set-quiz-result-filter': (el) => { state.quizResultFilter = el.dataset.filter; View.render(); }
            }
        };
        
        Controller.init();
    </script>
</body>
</html>

