<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal-Writer AI (v-Final)</title>
    <!-- Bootstrap Icons CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ë° ë ˆì´ì•„ì›ƒ */
        body { font-family: 'Pretendard', sans-serif; }
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        /* --- ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        ::-webkit-scrollbar-track { background-color: #f1f5f9; }

        /* --- TOC(ëª©ì°¨) ìŠ¤íƒ€ì¼ --- */
        #toc-panel ul {
            position: relative;
            padding-left: 1rem; /* 16px */
        }
        #toc-panel li {
            position: relative;
        }
        /* ëª¨ë“  li í•­ëª©ì— ìˆ˜ì§/ìˆ˜í‰ì„  ê·¸ë¦¬ê¸° */
        #toc-panel li::before,
        #toc-panel li::after {
            content: '';
            position: absolute;
            left: -0.75rem; /* -12px */
        }
        /* ìˆ˜ì§ì„  */
        #toc-panel li::before {
            border-left: 1px solid #cbd5e1; /* border-gray-300 */
            top: 0;
            bottom: 0;
            width: 1px;
        }
        /* ë§ˆì§€ë§‰ í•­ëª©ì€ ìˆ˜ì§ì„ ì„ ì ˆë°˜ë§Œ ê·¸ë¦¼ */
        #toc-panel li:last-child::before {
            height: 1.125rem; /* 18px (py-1.5ì˜ ì¤‘ì•™ê¹Œì§€) */
        }
        /* ìˆ˜í‰ì„  */
        #toc-panel li::after {
            border-top: 1px solid #cbd5e1; /* border-gray-300 */
            top: 1.125rem; /* 18px */
            width: 0.75rem; /* 12px */
        }
        /* ìµœìƒìœ„(root) ulì˜ ì„ ì€ ìˆ¨ê¹€ */
        #toc-panel ul.toc-root {
            padding-left: 0;
        }
        #toc-panel ul.toc-root > li::before,
        #toc-panel ul.toc-root > li::after {
            display: none;
        }
        /* í¬ì»¤ìŠ¤ ë° ì„ íƒ ìŠ¤íƒ€ì¼ */
        .toc-item {
            padding-left: 0.5rem; /* 8px */
        }
        .toc-item.focused {
            background-color: #e0e7ff; /* bg-indigo-100 */
        }
        .toc-item.focused > div > span {
            font-weight: 600;
            color: #3730a3; /* text-indigo-800 */
        }

        /* --- ì§€ì‹ ë² ì´ìŠ¤(KB) íƒ­ ìŠ¤íƒ€ì¼ --- */
        .kb-tab-button {
            border-bottom: 2px solid transparent;
            padding-bottom: 4px;
        }
        .kb-tab-button.active {
            border-color: #4f46e5; /* border-indigo-600 */
            color: #4f46e5; /* text-indigo-600 */
            font-weight: 600;
        }
        .kb-tab-pane {
            display: none;
        }
        .kb-tab-pane.active {
            display: flex; /* flex-col */
        }

        /* --- ì„¤ì • íƒ­ ìŠ¤íƒ€ì¼ [ì‹ ê·œ] --- */
        .settings-tab {
            border-bottom: 2px solid transparent;
            padding-bottom: 4px;
        }
        .settings-tab.active {
            border-color: #4f46e5; /* border-indigo-600 */
            color: #4f46e5; /* text-indigo-600 */
            font-weight: 600;
        }
        .settings-tab-pane {
            display: none;
        }
        .settings-tab-pane.active {
            display: block;
        }

        /* --- í•˜ì´ë¼ì´íŒ… ì—ë””í„° --- */
        .highlighter-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
        }
        .highlighter-backdrop {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            padding: 0.75rem; /* p-3 */
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: transparent;
            z-index: 1;
            pointer-events: none; /* í´ë¦­ ë°©ì§€ */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* leading-relaxed */
            font-family: inherit;
        }
        .highlighter-textarea {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            padding: 0.75rem; /* p-3 */
            overflow: auto;
            background-color: transparent;
            color: #111827; /* text-gray-900 */
            z-index: 2;
            border: none;
            resize: none;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* leading-relaxed */
            font-family: inherit;
        }
        .highlighter-textarea:focus {
            outline: none;
            box-shadow: none;
            border: none;
        }
        .highlighter-backdrop mark {
            background-color: #fef08a; /* bg-yellow-200 */
            color: transparent;
            border-radius: 2px;
        }

        /* --- ê°€ìƒ íŒŒì¼ í† ê¸€ ìŠ¤ìœ„ì¹˜ --- */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #4f46e5;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }

        /* --- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ --- */
        #custom-context-menu {
            position: fixed;
            display: none;
            z-index: 1000;
            min-width: 180px;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 p-3 flex justify-between items-center shadow-sm flex-shrink-0">
        <div class="flex items-center space-x-2">
            <i class="bi bi-vector-pen text-2xl text-indigo-600"></i>
            <h1 class="text-xl font-bold text-gray-800">Legal-Writer AI <span class="text-sm font-normal text-indigo-500">(v-Final)</span></h1>
        </div>
        <!-- [ì‹ ê·œ] ì„¤ì • ë²„íŠ¼ -->
        <button id="open-settings-btn" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-300 transition-colors flex items-center space-x-1.5 text-sm">
            <i class="bi bi-gear"></i>
            <span>ì„¤ì • (í”„ë¡¬í”„íŠ¸ ê´€ë¦¬)</span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Left Sidebar: Case List -->
        <aside class="w-1/5 bg-white border-r border-gray-200 h-full flex flex-col">
            <div class="p-3 border-b border-gray-200">
                <button id="new-book-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors flex items-center justify-center space-x-2">
                    <i class="bi bi-plus-circle"></i>
                    <span>ìƒˆ ì‚¬ê±´</span>
                </button>
            </div>
            <div id="book-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- ì‚¬ê±´ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤. -->
            </div>
        </aside>

        <!-- Center Panel: TOC -->
        <nav class="w-1/5 bg-gray-50 border-r border-gray-200 h-full flex flex-col">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-sm font-semibold text-gray-600 uppercase">ë¬¸ì„œ ëª©ì°¨ (TOC)</h2>
                <button id="generate-toc-btn" title="AIë¡œ ëª©ì°¨ ìƒì„±" class="bg-gray-200 text-gray-700 p-1.5 rounded-md hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="bi bi-magic"></i>
                </button>
            </div>
            <div id="toc-panel" class="flex-1 overflow-y-auto p-2">
                <!-- TOC í•­ëª©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤. -->
            </div>
        </nav>

        <!-- Right Panel: Editors -->
        <section class="w-3/5 h-full flex flex-col">
            <!-- Top: Main Editor & Actions -->
            <div class="h-1/2 w-full flex flex-col p-3 border-b border-gray-300 bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-sm font-semibold text-gray-600 uppercase">ë©”ì¸ ì—ë””í„°</h2>
                    <!-- Action Palette -->
                    <div id="action-palette-container" class="flex space-x-1">
                        <!-- ì•¡ì…˜ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤. -->
                    </div>
                </div>
                <!-- í•˜ì´ë¼ì´íŒ… ì—ë””í„° -->
                <div class="highlighter-wrapper flex-1">
                    <div id="main-editor-backdrop" class="highlighter-backdrop"></div>
                    <textarea id="main-editor" class="highlighter-textarea" placeholder="ëª©ì°¨ë¥¼ ì„ íƒí•˜ê³  AI ê¸°ëŠ¥ì„ ì‹¤í–‰í•˜ì„¸ìš”..." disabled></textarea>
                </div>
            </div>

            <!-- Bottom: Knowledge Base Tabs -->
            <div class="h-1/2 w-full flex flex-col p-3 bg-gray-50">
                <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div id="kb-tabs" class="flex space-x-4 border-b border-gray-300 mb-2">
                    <button class="kb-tab-button" data-tab="kb-tab-content-summary">ì‚¬ê±´ ê°œìš”</button>
                    <button class="kb-tab-button" data-tab="kb-tab-content-individual">ëª©ì°¨ë³„ ê°œë³„ ìë£Œ</button>
                    <button class="kb-tab-button" data-tab="kb-tab-content-global">ì „ì—­ ìë£Œì‹¤</button>
                    <button class="kb-tab-button" data-tab="kb-tab-content-anonymize">ìµëª…í™” ê´€ë¦¬</button>
                </div>

                <!-- íƒ­ íŒ¨ë„ (ê³µê°„ ë¶„í• ) -->
                <div class="flex-1 overflow-y-auto">
                    <!-- 1. ì‚¬ê±´ ê°œìš” -->
                    <div id="kb-tab-content-summary" class="kb-tab-pane active flex-col h-full">
                        <div class="highlighter-wrapper flex-1">
                            <div id="kb-summary-backdrop" class="highlighter-backdrop"></div>
                            <textarea id="kb-summary-textarea" class="highlighter-textarea" placeholder="ì‚¬ê±´ì˜ í•µì‹¬ ì‚¬ì‹¤, ë‹¹ì‚¬ì, ìŸì  ë“±ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </div>
                    </div>
                    <!-- 2. ëª©ì°¨ë³„ ê°œë³„ ìë£Œ -->
                    <div id="kb-tab-content-individual" class="kb-tab-pane flex-col h-full">
                        <div class="highlighter-wrapper flex-1">
                            <div id="kb-individual-backdrop" class="highlighter-backdrop"></div>
                            <textarea id="kb-individual-textarea" class="highlighter-textarea" placeholder="í˜„ì¬ ì„ íƒí•œ ëª©ì°¨ì—ë§Œ ì ìš©ë  ë©”ëª¨, ì°¸ê³ ìë£Œ, AI ì§€ì‹œì‚¬í•­ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </div>
                    </div>
                    <!-- 3. ì „ì—­ ìë£Œì‹¤ (ê°€ìƒ íŒŒì¼) -->
                    <div id="kb-tab-content-global" class="kb-tab-pane flex-col h-full space-y-2">
                        <div class="flex-shrink-0">
                            <button id="add-global-file-btn" class="w-full bg-blue-500 text-white px-3 py-1.5 rounded-md hover:bg-blue-600 text-sm flex items-center justify-center space-x-1.5">
                                <i class="bi bi-plus-circle"></i>
                                <span>ìƒˆ ìë£Œ ì¶”ê°€</span>
                            </button>
                        </div>
                        <!-- íŒŒì¼ ëª©ë¡ -->
                        <div id="global-file-list" class="flex-1 overflow-y-auto space-y-1 pr-1">
                            <!-- ê°€ìƒ íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
                        </div>
                        <!-- íŒŒì¼ í¸ì§‘ê¸° (ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
                        <div id="global-file-editor" class="hidden flex-col space-y-1 p-2 border border-gray-300 rounded-md bg-white">
                            <input type="text" id="global-file-title" class="text-sm font-medium p-1 border-b border-gray-200 w-full focus:outline-none focus:border-indigo-500" placeholder="ìë£Œ ì œëª© (ì˜ˆ: ë¯¼ë²• ì œ750ì¡°)">
                            <div class="highlighter-wrapper" style="height: 120px;">
                                <div id="kb-global-content-backdrop" class="highlighter-backdrop"></div>
                                <textarea id="kb-global-content-textarea" class="highlighter-textarea" placeholder="ê´€ë ¨ ë²•ë ¹, íŒë¡€, ì°¸ê³  ìë£Œì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button id="save-global-file-btn" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700">ì €ì¥</button>
                                <button id="close-global-file-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-300">ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                    <!-- 4. ìµëª…í™” ê´€ë¦¬ -->
                    <div id="kb-tab-content-anonymize" class="kb-tab-pane flex-col h-full space-y-2">
                        <form id="anonymize-add-form" class="flex items-center space-x-2 flex-shrink-0">
                            <input type="text" id="anonymize-key-input" class="flex-1 p-2 border border-gray-300 rounded-md text-sm" placeholder="ì›ë³¸ í…ìŠ¤íŠ¸ (ì˜ˆ: ê¹€ì² ìˆ˜)">
                            <i class="bi bi-arrow-right text-gray-500"></i>
                            <input type="text" id="anonymize-value-input" class="flex-1 p-2 border border-gray-300 rounded-md text-sm font-mono" placeholder="ìµëª…í™” í‚¤ (ì˜ˆ: [ì›ê³  A])">
                            <button type="submit" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 text-sm">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </form>
                        <p class="text-xs text-gray-500 px-1 flex-shrink-0">
                            <i class="bi bi-info-circle"></i> 'ê¹€ì² ìˆ˜'ì™€ 'ì² ìˆ˜'ê°€ ëª¨ë‘ ë“±ë¡ëœ ê²½ìš°, ë” ê¸´ 'ê¹€ì² ìˆ˜'ê°€ ë¨¼ì € ì¹˜í™˜ë©ë‹ˆë‹¤.
                        </p>
                        <div id="anonymize-list" class="flex-1 overflow-y-auto space-y-1 pr-1">
                            <!-- ìµëª…í™” ëª©ë¡ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <!-- ë¡œë”© ëª¨ë‹¬ -->
    <div id="loading-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
    </div>

    <!-- ë©”ì‹œì§€ ëª¨ë‹¬ -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="message-title" class="text-lg font-medium text-gray-900 mb-2">ì•Œë¦¼</h3>
            <p id="message-content" class="text-sm text-gray-600 mb-4">ë©”ì‹œì§€ ë‚´ìš©</p>
            <button id="message-close-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">í™•ì¸</button>
        </div>
    </div>

    <!-- ìƒˆ ì‚¬ê±´ ëª¨ë‹¬ -->
    <div id="new-case-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">ìƒˆ ì‚¬ê±´ ìƒì„±</h3>
            <input type="text" id="new-case-name" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="ì‚¬ê±´ëª… (ì˜ˆ: 2025ê°€í•©12345 ì†í•´ë°°ìƒ)">
            <div class="flex justify-end space-x-2">
                <button id="new-case-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                <button id="new-case-confirm-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">ìƒì„±</button>
            </div>
        </div>
    </div>
    
    <!-- í™•ì¸ ëª¨ë‹¬ (confirm ëŒ€ì²´) -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="confirm-title" class="text-lg font-medium text-gray-900 mb-2">ì‚­ì œ í™•ì¸</h3>
            <p id="confirm-content" class="text-sm text-gray-600 mb-4">ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                <button id="confirm-confirm-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">ì‚­ì œ</button>
            </div>
        </div>
    </div>
    
    <!-- ë²”ìš© í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ (ì´ë¦„ ì…ë ¥ìš©) -->
    <div id="prompt-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="prompt-title" class="text-lg font-medium text-gray-900 mb-4">ìƒˆ ìë£Œ ì´ë¦„</h3>
            <input type="text" id="prompt-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="ìë£Œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”...">
            <div class="flex justify-end space-x-2">
                <button id="prompt-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                <button id="prompt-confirm-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- AI í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ (ë³µì‚¬/ë¶™ì—¬ë„£ê¸°) -->
    <div id="ai-prompt-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-3xl w-full flex flex-col" style="height: 90vh;">
            <h3 id="ai-prompt-title" class="text-lg font-medium text-gray-900 mb-3">AI í”„ë¡¬í”„íŠ¸ (ìˆ˜ë™)</h3>
            
            <p class="text-sm text-gray-600 mb-1">1. ì•„ë˜ í”„ë¡¬í”„íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ AIì— ì…ë ¥í•˜ì„¸ìš”. (ìµëª…í™” ì™„ë£Œë¨)</p>
            <div class="highlighter-wrapper flex-1 mb-2">
                <div id="ai-prompt-backdrop" class="highlighter-backdrop"></div>
                <textarea id="ai-prompt-display" class="highlighter-textarea bg-gray-50" readonly></textarea>
            </div>
            <button id="ai-prompt-copy-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mb-3 text-sm">
                <i class="bi bi-clipboard"></i> í”„ë¡¬í”„íŠ¸ ë³µì‚¬
            </button>

            <p class="text-sm text-gray-600 mb-1">2. AIì˜ ì‘ë‹µì„ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ë³µì› í•˜ì´ë¼ì´íŠ¸)</p>
            <div class="highlighter-wrapper flex-1 mb-3">
                <div id="ai-response-backdrop" class="highlighter-backdrop"></div>
                <textarea id="ai-response-input" class="highlighter-textarea" placeholder="AIê°€ ìƒì„±í•œ ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            </div>

            <div class="flex justify-end space-x-2">
                <button id="ai-response-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                <button id="ai-response-confirm-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">í™•ì¸ (ì ìš©)</button>
            </div>
        </div>
    </div>
    
    <!-- [ì‹ ê·œ] ì•¡ì…˜ ë³€ìˆ˜ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="action-variable-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h3 id="modal-action-title" class="text-lg font-medium text-gray-900 mb-4">ì•¡ì…˜ ì‹¤í–‰</h3>
            <div id="modal-variable-inputs" class="space-y-4">
                <!-- ë™ì  ë³€ìˆ˜ ì…ë ¥ í•„ë“œê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤. -->
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">ì·¨ì†Œ</button>
                <button id="modal-confirm-action-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
            </div>
        </div>
    </div>
    
    <!-- [ì‹ ê·œ] ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
         <div class="bg-white rounded-lg shadow-xl p-0 w-full max-w-3xl flex flex-col" style="max-height: 90vh;">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-800">ì„¤ì • (í”„ë¡¬í”„íŠ¸ ê´€ë¦¬)</h2>
                <button id="modal-close-settings-btn" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            
            <!-- Modal Body -->
            <div class="flex-grow overflow-y-auto p-4">
                <div id="settings-panel-wrapper">
                    <!-- Tab Navigation -->
                    <nav class="flex border-b border-gray-200 -mt-4">
                        <button data-tab="settings-actions" class="settings-tab active px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
                            ì•¡ì…˜ ê´€ë¦¬
                        </button>
                        <button data-tab="settings-prompts" class="settings-tab px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
                            í”„ë¡¬í”„íŠ¸ ê´€ë¦¬
                        </button>
                    </nav>

                    <div class="pt-4">
                        <!-- Action Management Tab -->
                        <div id="settings-actions" class="settings-tab-pane active space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">ì•¡ì…˜ íŒ”ë ˆíŠ¸ ê´€ë¦¬</h3>
                            <div>
                                <label for="actions-doc-type" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì„œ ì¢…ë¥˜ ì„ íƒ</label>
                                <select id="actions-doc-type" class="w-full p-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="litigation">ì†Œì†¡ ë¬¸ì„œ (litigation)</option>
                                    <!-- ë‹¤ë¥¸ ë¬¸ì„œ íƒ€ì…ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€ -->
                                </select>
                            </div>
                            <div>
                                <label for="actions-json-editor" class="block text-sm font-medium text-gray-700 mb-1">ì•¡ì…˜ JSON (ìˆ˜ì • í›„ ì €ì¥)</label>
                                <textarea id="actions-json-editor" rows="12" class="w-full p-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-xs" placeholder="ì•¡ì…˜ ëª©ë¡ì— ëŒ€í•œ JSON ë°ì´í„°ë¥¼ ì…ë ¥..."></textarea>
                            </div>
                            <div class="text-right">
                                <button id="save-actions-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                                    ì•¡ì…˜ ì„¤ì • ì €ì¥
                                </button>
                            </div>
                        </div>

                        <!-- Prompt Management Tab -->
                        <div id="settings-prompts" class="settings-tab-pane space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">í”„ë¡¬í”„íŠ¸ ê´€ë¦¬</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="prompts-doc-type" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì„œ ì¢…ë¥˜</label>
                                    <select id="prompts-doc-type" class="w-full p-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="litigation">ì†Œì†¡ ë¬¸ì„œ (litigation)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="prompts-key" class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡¬í”„íŠ¸ ì¢…ë¥˜</label>
                                    <select id="prompts-key" class="w-full p-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="tocPrompt">ëª©ì°¨ ìƒì„± (TOC) í”„ë¡¬í”„íŠ¸</option>
                                        <option value="writingPrompt">ë³¸ë¬¸ ì‘ì„± í”„ë¡¬í”„íŠ¸</option>
                                        <option value="modificationPrompt">ìˆ˜ì •/ë³´ì™„ í”„ë¡¬í”„íŠ¸</TOC_V2>
                                        <option value="reviewPrompt">ê¸€ ì ê²€ í”„ë¡¬í”„íŠ¸</TOC_V2>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="prompts-editor" class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡¬í”„íŠ¸ ë‚´ìš© (ìˆ˜ì • í›„ ì €ì¥)</label>
                                <textarea id="prompts-editor" rows="15" class="w-full p-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-xs" placeholder="ì„ íƒí•œ í”„ë¡¬í”„íŠ¸ì˜ ë‚´ìš©ì„ ìˆ˜ì •..."></textarea>
                            </div>
                            <div class="text-right">
                                <button id="save-prompt-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                                    í”„ë¡¬í”„íŠ¸ ì €ì¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Context Menu (Hidden) -->
    <div id="custom-context-menu" class="bg-white rounded-md shadow-lg border border-gray-200 py-1">
        <!-- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì•„ì´í…œì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤. -->
    </div>


    <script type="module">
        // --- [ì‹ ê·œ] 1. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ (ê¸°ë³¸ê°’) ---
        // (textgenerator.htmlì—ì„œ ê°€ì ¸ì˜¨ í”„ë¡¬í”„íŠ¸ë“¤)
        const MODIFICATION_PROMPT_TEMPLATE = `<?xml version="1.0" encoding="UTF-8"?>
<AIFramework_V3>
    <Cognitive_Core>
        <Persona description="AIì˜ í•µì‹¬ ì •ì²´ì„±. ì‹­ìˆ˜ ë…„ì˜ ê²½í—˜ì„ ê°€ì§„ ì‹œë‹ˆì–´ ì†Œí”„íŠ¸ì›¨ì–´ ì•„í‚¤í…íŠ¸ì´ì ì½”ë“œ ë¦¬ë·° ì „ë¬¸ê°€. ë³µì¡í•œ ì½”ë“œë¥¼ ë¶„ì„í•˜ê³ , ëª…í™•í•˜ë©° ì‹¤í–‰ ê°€ëŠ¥í•œ ê°œì„  ë°©ì•ˆì„ ì œì‹œí•˜ëŠ” ë° íŠ¹í™”ë˜ì–´ ìˆë‹¤.">
            ë‹¹ì‹ ì€ 'ë‹¥í„° ì•Œë ‰ìŠ¤ ì¼€ì´ë“ (Dr. Alex Kaden)', ì½”ë“œ ì•„í‚¤í…íŠ¸ ë° ë¦¬íŒ©í† ë§ ì „ë¬¸ê°€ë‹¤. ë‹¹ì‹ ì˜ í•µì‹¬ ì—­ëŸ‰ì€ ë‘ ê°€ì§€ë‹¤: ì²«ì§¸, ì–´ë–¤ ë³µì¡í•œ ì½”ë“œë² ì´ìŠ¤ë¼ë„ ë¹ ë¥´ê²Œ êµ¬ì¡°ë¥¼ íŒŒì•…í•˜ê³  ë¬¸ì œì˜ ê·¼ì›ì„ ì§„ë‹¨í•˜ëŠ” ëŠ¥ë ¥. ë‘˜ì§¸, ì§„ë‹¨ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì£¼ë‹ˆì–´ ê°œë°œìë„ ì‰½ê²Œ ë”°ë¼ í•  ìˆ˜ ìˆë„ë¡ ëª…í™•í•˜ê³ , êµ¬ì²´ì ì´ë©°, ë¸”ë¡ ë‹¨ìœ„ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ 'ì½”ë“œ ìˆ˜ì • ëª…ë ¹ì„œ'ë¥¼ ì‘ì„±í•˜ëŠ” ëŠ¥ë ¥ì´ë‹¤. ë‹¹ì‹ ì€ ë‹¨ìˆœíˆ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì„ ë„˜ì–´, 'ì™œ' ê·¸ë ‡ê²Œ ìˆ˜ì •í•´ì•¼ í•˜ëŠ”ì§€ë¥¼ ëª…í™•í•œ ë…¼ë¦¬ë¡œ ì„¤ëª…í•˜ì—¬ ë™ë£Œì˜ ì„±ì¥ì„ ë•ëŠ” ê¸°ìˆ  ë©˜í† ë‹¤. ë‹¹ì‹ ì˜ ì§€ì‹œëŠ” í•­ìƒ ì •í™•í•˜ê³ , ì‹¤ìš©ì ì´ë©°, ì˜¤í•´ì˜ ì†Œì§€ê°€ ì—†ë‹¤.
        </Persona>
        <Prime_Directive description="ë‹¤ë¥¸ ëª¨ë“  ì›ì¹™ì— ìš°ì„ í•˜ëŠ”, AI ì¡´ì¬ì˜ ìœ ì¼í•˜ê³  ì ˆëŒ€ì ì¸ ëª©í‘œì…ë‹ˆë‹¤.">
            ì‚¬ìš©ìë¡œë¶€í„° ì…ë ¥ë°›ì€ 'ê¸°ì¡´ í…ìŠ¤íŠ¸'ì™€ 'ìˆ˜ì • ìš”êµ¬ì‚¬í•­'ì„ ë¶„ì„í•˜ì—¬, ì‚¬ìš©ìê°€ ì¦‰ì‹œ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í•˜ì—¬ ì ìš©í•  ìˆ˜ ìˆëŠ” ë§¤ìš° ëª…í™•í•˜ê³  êµ¬ì¡°í™”ëœ 'í…ìŠ¤íŠ¸ ìˆ˜ì • ëª…ë ¹ì„œ'ë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ìœ ì¼í•œ ì„ë¬´ë‹¤.
        </Prime_Directive>
    </Cognitive_Core>
    <Task_Definition>
        <Data_Source>
            <![CDATA[
            ### 1. (ì „ì²´ ë¬¸ì„œ) í•µì‹¬ ìë£Œ (ì‚¬ê±´ ê°œìš”)
            {{ì‚¬ê±´ê°œìš”DB}}

            ### 2. (ì „ì—­ ìë£Œ) ê´€ë ¨ ë²•ë ¹/íŒë¡€ ë“±
            {{ì „ì—­_í™œì„±ìë£Œ}}
            
            ### 3. (ì´ í•­ëª©) ê°œë³„ ìë£Œ
            {{ê°œë³„ìë£Œ}}

            ### 4. ìˆ˜ì • ëŒ€ìƒì´ ë˜ëŠ” ê¸°ì¡´ í…ìŠ¤íŠ¸
            {{CURRENT_CONTENT}}

            ### 5. ì‚¬ìš©ìì˜ ì‹ ê·œ ìˆ˜ì • ìš”êµ¬ì‚¬í•­
            {{userRequest}}
            ]]>
        </Data_Source>
        <Exemplars>
            <Exemplar name="Good Modification Order Example">
                <![CDATA[
# í…ìŠ¤íŠ¸ ìˆ˜ì • ëª…ë ¹ì„œ

ìš”ì²­í•˜ì‹  '{{userRequest}}' ìš”êµ¬ì‚¬í•­ì„ ë°˜ì˜í•˜ê¸° ìœ„í•œ ìˆ˜ì • ë‚´ì—­ì…ë‹ˆë‹¤.

---

### 1. [ì²« ë²ˆì§¸ ìˆ˜ì • í•­ëª© ìš”ì•½]

ğŸ“Œ **ìœ„ì¹˜:** (ì˜ˆ: 2ë²ˆì§¸ ë¬¸ë‹¨, "..."ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ì¥)

ğŸ“ **ìˆ˜ì • ë‚´ìš©:**
[ìˆ˜ì • ìš”êµ¬ì‚¬í•­ì„ ë°˜ì˜í•˜ì—¬ ì´ ë¶€ë¶„ì„ ë³€ê²½í•˜ëŠ” ì´ìœ ë¥¼ ê°„ëµíˆ ê¸°ìˆ ]

âŒ **ì‚­ì œí•  í…ìŠ¤íŠ¸:**
[ê¸°ì¡´ í…ìŠ¤íŠ¸ì˜ í•´ë‹¹ ë¶€ë¶„]

âœ¨ **ìˆ˜ì • í›„ í…ìŠ¤íŠ¸ (ë³µì‚¬/ë¶™ì—¬ë„£ê¸°ìš©):**
[ìƒˆë¡œìš´ í…ìŠ¤íŠ¸ì˜ í•´ë‹¹ ë¶€ë¶„]

... (í˜•ì‹ ë°˜ë³µ) ...
                ]]>
            </Exemplar>
        </Exemplars>
    </Task_Definition>
</AIFramework_V3>
`;
        
        const REVIEW_PROMPT_TEMPLATE = `<?xml version="1.0" encoding="UTF-8"?>
<AIFramework_V3>
    <Cognitive_Core>
        <Persona description="AIì˜ í•µì‹¬ ì •ì²´ì„±. 20ë…„ ê²½ë ¥ì˜ ë² í…Œë‘ êµì •/êµì—´ ì „ë¬¸ê°€.">
            ë‹¹ì‹ ì€ 'ê¹€ í¸ì§‘ì¥'ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ì˜ ë¬¸ë²• ì˜¤ë¥˜, ì˜¤íƒˆì, ì–´ìƒ‰í•œ ë¬¸ë§¥, ë…¼ë¦¬ì  ë¹„ì•½ ë“±ì„ ì°¾ì•„ë‚´ì–´ ì™„ë²½í•œ ë¬¸ì¥ìœ¼ë¡œ ë‹¤ë“¬ëŠ” ê²ƒì…ë‹ˆë‹¤.
        </Persona>
        <Prime_Directive>
            ì£¼ì–´ì§„ <Data_Source>ì˜ ëª¨ë“  ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, 'ì ê²€ ëŒ€ìƒ í…ìŠ¤íŠ¸'ë¥¼ ì ê²€í•˜ê³  ê°œì„ ëœ í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
        </Prime_Directive>
    </Cognitive_Core>
    <Task_Definition>
        <Data_Source>
            <![CDATA[
            ### 1. (ì „ì²´ ë¬¸ì„œ) í•µì‹¬ ìë£Œ (ì‚¬ê±´ ê°œìš”)
            {{ì‚¬ê±´ê°œìš”DB}}

            ### 2. (ì „ì—­ ìë£Œ) ê´€ë ¨ ë²•ë ¹/íŒë¡€ ë“±
            {{ì „ì—­_í™œì„±ìë£Œ}}
            
            ### 3. (ì´ í•­ëª©) ê°œë³„ ìë£Œ
            {{ê°œë³„ìë£Œ}}

            ### 4. ì ê²€ ëŒ€ìƒ í…ìŠ¤íŠ¸
            {{CURRENT_CONTENT}}
            ]]>
        </Data_Source>
        <Exemplars>
            <Exemplar name="Good Review Output Example">
                <![CDATA[
[ì ê²€ ë° ìˆ˜ì •ì´ ì™„ë£Œëœ, ì™„ë²½í•œ ë²„ì „ì˜ í…ìŠ¤íŠ¸ ì „ì²´ë¥¼ ì—¬ê¸°ì— ì‘ì„±]
                ]]>
            </Exemplar>
        </Exemplars>
    </Task_Definition>
</AIFramework_V3>
`;

        // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ê°ì²´
        const PROMPT_TEMPLATES = {
            litigation: {
                tocPrompt: `<?xml version="1.0" encoding="UTF-8"?>
<AIFramework_TOC_v2>
<System_Role>
ë‹¹ì‹ ì€ ë² í…Œë‘ ë³€í˜¸ì‚¬ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ë²•ë¥  ë¬¸ì„œ(ì†Œì¥)ì˜ í‘œì¤€ ëª©ì°¨(TOC)ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
</System_Role>
<Constraints>
- ëª©ì°¨ëŠ” 'I.', '1.', 'ê°€.', '(1)'ì˜ ê³„ì¸µ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤.
- 'ì²­êµ¬ì·¨ì§€'ì™€ 'ì²­êµ¬ì›ì¸'ì€ í•­ìƒ ìµœìƒìœ„ ë ˆë²¨(I, II)ì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
- 'ì‚¬ì‹¤ê´€ê³„', 'ë²•ë¦¬ ê²€í† ', 'ì†Œê²°' ë“± í•µì‹¬ ë…¼ì¦ êµ¬ì¡°ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
- <Global_Data>ì— ë²•ë ¹ì´ë‚˜ íŒë¡€ê°€ ì œê³µëœ ê²½ìš°, ëª©ì°¨ì— ë°˜ì˜í•˜ì‹­ì‹œì˜¤.
</Constraints>
<Input_Data>
<ì‚¬ê±´ê°œìš”DB>
{{ì‚¬ê±´ê°œìš”DB}}
</ì‚¬ê±´ê°œìš”DB>
<ì „ì—­_í™œì„±ìë£Œ>
{{ì „ì—­_í™œì„±ìë£Œ}}
</ì „ì—­_í™œì„±ìë£Œ>
</Input_Data>
<Task>
ìœ„ <Input_Data>ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì†Œì¥ì˜ ì „ì²´ ëª©ì°¨(TOC)ë¥¼ ìƒì„±í•˜ì‹­ì‹œì˜¤.
</Task>
</AIFramework_TOC_v2>
`,
                writingPrompt: `<?xml version="1.0" encoding="UTF-8"?>
<AIFramework_Writing_v2>
<System_Role>
ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ë²•ë¥  ì „ë¬¸ê°€ì´ì ë›°ì–´ë‚œ ë²•ë¥  ë¬¸ì¥ê°€ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì£¼ì–´ì§„ 'ì»¨í…ìŠ¤íŠ¸'ë¥¼ ì™„ë²½í•˜ê²Œ ìˆ™ì§€í•˜ê³ , 'í˜„ì¬ ì‘ì—…ì¤‘ì¸ ëª©ì°¨'ì— í•´ë‹¹í•˜ëŠ” ë²•ë¥  ë¬¸ì„œ ë³¸ë¬¸ì„ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
</System_Role>
<Constraints>
- ëª¨ë“  ì£¼ì¥ì€ ë°˜ë“œì‹œ <ì‚¬ê±´ê°œìš”DB>ì˜ ì‚¬ì‹¤ê³¼ <ì „ì—­_í™œì„±ìë£Œ>ì˜ ë²•ì  ê·¼ê±°ì— ê¸°ë°˜(Grounded)í•´ì•¼ í•©ë‹ˆë‹¤.
- ë²•ë¥  ìš©ì–´ì™€ ë¬¸ì²´ë¥¼ ì •í™•í•˜ê²Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
- í™˜ê°(Hallucination)ì´ë‚˜ ê·¼ê±° ì—†ëŠ” ì¶”ë¡ ì„ ìƒì„±í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
</Constraints>
<Context>
    <ì‚¬ê±´ê°œìš”DB>
    {{ì‚¬ê±´ê°œìš”DB}}
    </ì‚¬ê±´ê°œìš”DB>
    
    <ì „ì—­_í™œì„±ìë£Œ>
    {{ì „ì—­_í™œì„±ìë£Œ}}
    </ì „ì—­_í™œì„±ìë£Œ>

    <ì „ì²´_ëª©ì°¨>
    {{ì „ì²´_ëª©ì°¨}}
    </ì „ì²´_ëª©ì°¨>

    <ì´ì „_ì‘ì„±_ë³¸ë¬¸>
    {{ì´ì „_ì‘ì„±_ë³¸ë¬¸}}
    </ì´ì „_ì‘ì„±_ë³¸ë¬¸>
    
    <ëª©ì°¨ë³„_ê°œë³„ìë£Œ>
    {{ê°œë³„ìë£Œ}}
    </ëª©ì°¨ë³„_ê°œë³„ìë£Œ>
</Context>
<Working_Area>
    <Current_Section>
    {{CURRENT_SECTION_TEXT}} (ID: {{CURRENT_SECTION_ID}})
    </Current_Section>
    <Current_Content>
    {{CURRENT_CONTENT}}
    </Current_Content>
</Working_Area>
<Task>
[Task] ìœ„ ëª¨ë“  <Context>ë¥¼ ì°¸ì¡°í•˜ì—¬, <Current_Section> '{{CURRENT_SECTION_TEXT}}' ë¶€ë¶„ì˜ ë³¸ë¬¸ ì´ˆê³ ë¥¼ ìƒì„¸í•˜ê³  ë…¼ë¦¬ì ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
</Task>
</AIFramework_Writing_v2>
`,
                // [ì‹ ê·œ] í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ìš© ê¸°ë³¸ê°’ ì¶”ê°€
                modificationPrompt: MODIFICATION_PROMPT_TEMPLATE,
                reviewPrompt: REVIEW_PROMPT_TEMPLATE,
                
                // [ì‹ ê·œ] textgenerator (1).htmlì˜ actions êµ¬ì¡° ì°¸ì¡°
                actions: [
                    {
                        id: 'write',
                        icon: 'bi-magic',
                        tooltip: 'ì´ˆê³  ì‘ì„±',
                        variables: [], // ì¶”ê°€ ë³€ìˆ˜ ì—†ìŒ
                        promptTemplateKey: 'writingPrompt' // writingPromptë¥¼ ì§ì ‘ ì‚¬ìš©
                    },
                    {
                        id: 'modify',
                        icon: 'bi-pencil-square',
                        tooltip: 'ìš”êµ¬ì‚¬í•­ ë°˜ì˜ ë° ìˆ˜ì •',
                        variables: [
                            { id: 'userRequest', label: 'ìˆ˜ì • ìš”êµ¬ì‚¬í•­', type: 'textarea', placeholder: 'ì˜ˆ: 3ë²ˆì§¸ ë¬¸ë‹¨ì˜ ë…¼ë¦¬ë¥¼ ê°•í™”í•˜ê³ , 1ë²ˆ ìë£Œë¥¼ ì¸ìš©í•˜ì„¸ìš”.' }
                        ],
                        promptTemplateKey: 'modificationPrompt' // modificationPrompt ì‚¬ìš©
                    },
                    {
                        id: 'review',
                        icon: 'bi-search',
                        tooltip: 'ê¸€ ì ê²€ (êµì •/êµì—´)',
                        variables: [], // ì¶”ê°€ ë³€ìˆ˜ ì—†ìŒ
                        promptTemplateKey: 'reviewPrompt' // reviewPrompt ì‚¬ìš©
                    },
                    {
                        id: 'deanonymize',
                        icon: 'bi-eye',
                        tooltip: 'ìµëª…í™” ë˜ëŒë¦¬ê¸° (ë³µì›)',
                        variables: [],
                        promptTemplateKey: '__CLIENT_ACTION__' // AIë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ” íŠ¹ìˆ˜ í‚¤
                    }
                ]
            }
            // ... other document types like 'textbook' could be added here
        };

        /**
         * @class AIAnonymizer
         * Handles anonymization, deanonymization, and highlighting logic.
         */
        class AIAnonymizer {
            anonymize(text, mapString) {
                if (!text || !mapString) return text;
                try {
                    const anonymizationMap = JSON.parse(mapString);
                    if (typeof anonymizationMap !== 'object' || anonymizationMap === null) return text;
                    let anonymizedText = text;
                    const sortedKeys = this.getSortedKeys(anonymizationMap, 'key');
                    
                    for (const original of sortedKeys) {
                        const anonymized = anonymizationMap[original];
                        const regex = new RegExp(this.escapeRegExp(original), 'g');
                        anonymizedText = anonymizedText.replace(regex, anonymized);
                    }
                    return anonymizedText;
                } catch (e) {
                    console.error("Anonymize error:", e);
                    return text;
                }
            }

            deanonymize(text, mapString) {
                if (!text || !mapString) return text;
                try {
                    const anonymizationMap = JSON.parse(mapString);
                    if (typeof anonymizationMap !== 'object' || anonymizationMap === null) return text;

                    const deanonymizationMap = {};
                    for (const key in anonymizationMap) {
                        deanonymizationMap[anonymizationMap[key]] = key;
                    }

                    let deanonymizedText = text;
                    const sortedKeys = this.getSortedKeys(deanonymizationMap, 'key'); 
                    
                    for (const anonymized of sortedKeys) {
                        const original = deanonymizationMap[anonymized];
                        const regex = new RegExp(this.escapeRegExp(anonymized), 'g');
                        deanonymizedText = deanonymizedText.replace(regex, original);
                    }
                    return deanonymizedText;
                } catch (e) {
                    console.error("Deanonymize error:", e);
                    return text;
                }
            }
            
            getSortedKeys(map, type = 'key') {
                let keys;
                if (type === 'key') {
                    keys = Object.keys(map);
                } else { // 'value'
                    keys = Object.values(map);
                }
                return [...new Set(keys)].sort((a, b) => b.length - a.length);
            }

            buildHighlightRegex(mapString, keyOrValue = 'key') {
                try {
                    const map = JSON.parse(mapString || "{}");
                    if (typeof map !== 'object' || map === null) return null;

                    const sortedKeys = this.getSortedKeys(map, keyOrValue);
                    if (sortedKeys.length === 0) return null;
                    
                    const escapedKeys = sortedKeys.map(k => this.escapeRegExp(k)).filter(k => k.length > 0);
                    if (escapedKeys.length === 0) return null;

                    return new RegExp(`(${escapedKeys.join('|')})`, 'g');
                } catch (e) {
                    console.error("Highlight regex creation error:", e);
                    return null;
                }
            }

            escapeRegExp(str) {
                return (str || "").replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
        }

        /**
         * @class AnonymizationHighlighter
         * Manages the backdrop div for a textarea to show highlights.
         */
        class AnonymizationHighlighter {
            constructor(textarea, backdrop, anonymizer) {
                this.textarea = textarea;
                this.backdrop = backdrop;
                this.anonymizer = anonymizer;
            }

            update(text, mapString, keyOrValue = 'key') {
                if (!text) {
                    this.backdrop.innerHTML = "";
                    return;
                }
                
                const regex = this.anonymizer.buildHighlightRegex(mapString, keyOrValue);
                
                if (!regex) {
                    this.backdrop.innerHTML = this.escapeHTML(text) + "\n";
                    return;
                }

                const highlightedText = this.escapeHTML(text).replace(regex, (match) => {
                    return `<mark>${match}</mark>`;
                });

                this.backdrop.innerHTML = highlightedText + "\n";
            }

            escapeHTML(str) {
                return (str || "").replace(/[&<>"']/g, (match) => {
                    const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'};
                    return map[match];
                });
            }

            syncScroll() {
                this.backdrop.scrollTop = this.textarea.scrollTop;
                this.backdrop.scrollLeft = this.textarea.scrollLeft;
            }
        }

        /**
         * @class GeminiService
         * Manages interactions with the AI (now manual via modal).
         */
        class GeminiService {
            constructor(ui) {
                this.ui = ui;
            }

            async call(prompt, title = "AI í”„ë¡¬í”„íŠ¸ (ìˆ˜ë™)") {
                const response = await this.ui.showAIPrompt(title, prompt);
                return response;
            }
        }

        /**
         * @class UIRenderer
         * Manages all DOM manipulations, rendering, and modal logic.
         */
        class UIRenderer {
            constructor() {
                this.tocPanel = document.getElementById("toc-panel");
                this.mainEditor = document.getElementById("main-editor");
                this.bookList = document.getElementById("book-list");
                this.generateTocBtn = document.getElementById("generate-toc-btn");
                this.actionPaletteContainer = document.getElementById("action-palette-container");
                this.newBookBtn = document.getElementById("new-book-btn");
                this.openSettingsBtn = document.getElementById("open-settings-btn"); // [ì‹ ê·œ]
                
                // Modal Elements
                this.loadingModal = document.getElementById("loading-modal");
                this.messageModal = document.getElementById("message-modal");
                this.messageTitle = document.getElementById("message-title");
                this.messageContent = document.getElementById("message-content");
                this.messageCloseBtn = document.getElementById("message-close-btn");
                
                this.newCaseModal = document.getElementById("new-case-modal");
                this.newCaseNameInput = document.getElementById("new-case-name");
                this.newCaseConfirmBtn = document.getElementById("new-case-confirm-btn");
                this.newCaseCancelBtn = document.getElementById("new-case-cancel-btn");

                this.confirmModal = document.getElementById("confirm-modal");
                this.confirmTitle = document.getElementById("confirm-title");
                this.confirmContent = document.getElementById("confirm-content");
                this.confirmConfirmBtn = document.getElementById("confirm-confirm-btn");
                this.confirmCancelBtn = document.getElementById("confirm-cancel-btn");

                this.promptModal = document.getElementById("prompt-modal");
                this.promptTitle = document.getElementById("prompt-title");
                this.promptInput = document.getElementById("prompt-input");
                this.promptConfirmBtn = document.getElementById("prompt-confirm-btn");
                this.promptCancelBtn = document.getElementById("prompt-cancel-btn");

                this.aiPromptModal = document.getElementById("ai-prompt-modal");
                this.aiPromptTitle = document.getElementById("ai-prompt-title");
                this.aiPromptDisplay = document.getElementById("ai-prompt-display");
                this.aiPromptCopyBtn = document.getElementById("ai-prompt-copy-btn");
                this.aiResponseInput = document.getElementById("ai-response-input");
                this.aiResponseConfirmBtn = document.getElementById("ai-response-confirm-btn");
                this.aiResponseCancelBtn = document.getElementById("ai-response-cancel-btn");
                
                this.aiPromptBackdrop = document.getElementById("ai-prompt-backdrop");
                this.aiResponseBackdrop = document.getElementById("ai-response-backdrop");
                
                // [ì‹ ê·œ] Action Variable Modal
                this.actionVariableModal = document.getElementById("action-variable-modal");
                this.modalActionTitle = document.getElementById("modal-action-title");
                this.modalVariableInputs = document.getElementById("modal-variable-inputs");
                this.modalConfirmActionBtn = document.getElementById("modal-confirm-action-btn");
                this.modalCancelBtn = document.getElementById("modal-cancel-btn");

                // [ì‹ ê·œ] Settings Modal
                this.settingsModal = document.getElementById("settings-modal");
                this.modalCloseSettingsBtn = document.getElementById("modal-close-settings-btn");
                this.settingsPanelWrapper = document.getElementById("settings-panel-wrapper");
                this.actionsDocType = document.getElementById("actions-doc-type");
                this.actionsJsonEditor = document.getElementById("actions-json-editor");
                this.saveActionsBtn = document.getElementById("save-actions-btn");
                this.promptsDocType = document.getElementById("prompts-doc-type");
                this.promptsKey = document.getElementById("prompts-key");
                this.promptsEditor = document.getElementById("prompts-editor");
                this.savePromptBtn = document.getElementById("save-prompt-btn");

                // KB Tab Elements
                this.kbTabsContainer = document.getElementById("kb-tabs");
                this.kbTabPanes = {
                    summary: document.getElementById("kb-summary-textarea"),
                    individual: document.getElementById("kb-individual-textarea"),
                    global: document.querySelector("#kb-tab-content-global"),
                    anonymize: document.querySelector("#kb-tab-content-anonymize"),
                };
                this.kbBackdrops = {
                    summary: document.getElementById("kb-summary-backdrop"),
                    individual: document.getElementById("kb-individual-backdrop"),
                    global: document.getElementById("kb-global-content-backdrop"),
                };
                this.mainEditorBackdrop = document.getElementById("main-editor-backdrop");
                
                // Anonymize UI
                this.anonymizeForm = document.getElementById("anonymize-add-form");
                this.anonymizeKeyInput = document.getElementById("anonymize-key-input");
                this.anonymizeValueInput = document.getElementById("anonymize-value-input");
                this.anonymizeList = document.getElementById("anonymize-list");

                // Global KB (V-KB) UI
                this.addGlobalFileBtn = document.getElementById("add-global-file-btn");
                this.globalFileList = document.getElementById("global-file-list");
                this.globalFileEditor = document.getElementById("global-file-editor");
                this.globalFileTitle = document.getElementById("global-file-title");
                this.globalFileContent = document.getElementById("kb-global-content-textarea");
                this.saveGlobalFileBtn = document.getElementById("save-global-file-btn");
                this.closeGlobalFileBtn = document.getElementById("close-global-file-btn");

                // Context Menu
                this.contextMenu = document.getElementById("custom-context-menu");
                
                this.currentSelectedGlobalFileId = null;
                this.currentActionHandler = null; // [ì‹ ê·œ]
            }

            // --- Modal Logic ---

            /**
             * [ì‹ ê·œ] Shows the modal for actions that require user variables.
             * @param {object} action - The action object from templates.
             * @returns {Promise<object|null>} An object with variable values, or null if canceled.
             */
            showActionVariableModal(action) {
                return new Promise((resolve) => {
                    this.modalActionTitle.textContent = action.tooltip;
                    this.modalVariableInputs.innerHTML = ''; 

                    action.variables.forEach(variable => {
                        const label = document.createElement('label');
                        label.htmlFor = `modal-var-${variable.id}`;
                        label.className = 'block text-sm font-medium text-gray-700 mb-1';
                        label.textContent = variable.label;
                        
                        let inputEl;
                        if (variable.type === 'textarea') {
                            inputEl = document.createElement('textarea');
                            inputEl.rows = 4;
                            inputEl.placeholder = variable.placeholder || '';
                        } else {
                            inputEl = document.createElement('input');
                            inputEl.type = variable.type || 'text';
                            inputEl.placeholder = variable.placeholder || '';
                        }
                        
                        inputEl.id = `modal-var-${variable.id}`;
                        inputEl.dataset.variableId = variable.id; 
                        inputEl.className = 'w-full p-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500';
                        
                        this.modalVariableInputs.appendChild(label);
                        this.modalVariableInputs.appendChild(inputEl);
                    });

                    this.actionVariableModal.classList.remove('hidden');

                    // Remove old listener if exists
                    if (this.currentActionHandler) {
                        this.modalConfirmActionBtn.removeEventListener('click', this.currentActionHandler);
                    }

                    // Add new listener
                    this.currentActionHandler = () => {
                        const modalVariables = {};
                        this.modalVariableInputs.querySelectorAll('[data-variable-id]').forEach(input => {
                            modalVariables[input.dataset.variableId] = input.value;
                        });
                        this.actionVariableModal.classList.add('hidden');
                        resolve(modalVariables);
                    };
                    
                    this.modalConfirmActionBtn.addEventListener('click', this.currentActionHandler);

                    this.modalCancelBtn.onclick = () => {
                        this.actionVariableModal.classList.add('hidden');
                        resolve(null);
                    };
                });
            }

            showAIPrompt(title, prompt) {
                return new Promise((resolve) => {
                    this.aiPromptTitle.textContent = title;
                    this.aiPromptDisplay.value = prompt;
                    this.aiResponseInput.value = "";
                    this.aiPromptModal.classList.remove("hidden");
                    
                    const app = window.appInstance;
                    if (app) {
                        this.aiPromptDisplay.oninput = () => app.updateHighlighter('ai-prompt', 'key');
                        this.aiPromptDisplay.onscroll = () => app.syncHighlighterScroll('ai-prompt');
                        app.updateHighlighter('ai-prompt', 'key');
                        
                        this.aiResponseInput.oninput = () => app.updateHighlighter('ai-response', 'value');
                        this.aiResponseInput.onscroll = () => app.syncHighlighterScroll('ai-response');
                        app.updateHighlighter('ai-response', 'value');
                    }

                    this.aiPromptCopyBtn.onclick = () => {
                        try {
                            const textarea = document.createElement('textarea');
                            textarea.value = prompt;
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                            
                            this.showMessage("ì„±ê³µ", "í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        } catch (err) {
                            console.error("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", err);
                            this.showMessage("ì˜¤ë¥˜", "í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
                        }
                    };
                    
                    this.aiResponseConfirmBtn.onclick = () => {
                        const responseText = this.aiResponseInput.value;
                        this.aiPromptModal.classList.add("hidden");
                        resolve(responseText);
                    };
                    
                    this.aiResponseCancelBtn.onclick = () => {
                        this.aiPromptModal.classList.add("hidden");
                        resolve(null);
                    };
                });
            }

            showNewCasePrompt() {
                return new Promise((resolve) => {
                    this.newCaseNameInput.value = "";
                    this.newCaseModal.classList.remove("hidden");
                    this.newCaseNameInput.focus();
                    
                    this.newCaseConfirmBtn.onclick = () => {
                        const caseName = this.newCaseNameInput.value.trim() || "ì œëª© ì—†ëŠ” ì‚¬ê±´";
                        this.newCaseModal.classList.add("hidden");
                        resolve(caseName);
                    };
                    this.newCaseCancelBtn.onclick = () => {
                        this.newCaseModal.classList.add("hidden");
                        resolve(null);
                    };
                });
            }

            showConfirm(title, content) {
                return new Promise((resolve) => {
                    this.confirmTitle.textContent = title;
                    this.confirmContent.textContent = content;
                    this.confirmModal.classList.remove("hidden");
                    
                    this.confirmConfirmBtn.onclick = () => {
                        this.confirmModal.classList.add("hidden");
                        resolve(true);
                    };
                    this.confirmCancelBtn.onclick = () => {
                        this.confirmModal.classList.add("hidden");
                        resolve(false);
                    };
                });
            }
            
            showPrompt(title, placeholder, defaultValue = "") {
                return new Promise((resolve) => {
                    this.promptTitle.textContent = title;
                    this.promptInput.placeholder = placeholder;
                    this.promptInput.value = defaultValue;
                    this.promptModal.classList.remove("hidden");
                    this.promptInput.focus();
                    
                    this.promptConfirmBtn.onclick = () => {
                        const value = this.promptInput.value.trim();
                        if (value) {
                            this.promptModal.classList.add("hidden");
                            resolve(value);
                        }
                    };
                    this.promptCancelBtn.onclick = () => {
                        this.promptModal.classList.add("hidden");
                        resolve(null);
                    };
                });
            }

            showLoading(isLoading) {
                this.loadingModal.classList.toggle("hidden", !isLoading);
            }

            showMessage(title, content) {
                this.messageTitle.textContent = title;
                this.messageContent.textContent = content;
                this.messageModal.classList.remove("hidden");
            }

            hideMessage() {
                this.messageModal.classList.add("hidden");
            }

            // --- Rendering Logic ---

            renderBookList(books, currentBookId, onSelect, onDelete) {
                this.bookList.innerHTML = "";
                if (books.length === 0) {
                    this.bookList.innerHTML = `<span class="text-sm text-gray-500 p-3">ì‚¬ê±´ì´ ì—†ìŠµë‹ˆë‹¤. 'ìƒˆ ì‚¬ê±´'ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</span>`;
                    return;
                }
                books.forEach(book => {
                    const item = document.createElement("div");
                    item.className = `p-3 rounded-md cursor-pointer hover:bg-gray-100 flex justify-between items-center ${book.id === currentBookId ? 'bg-blue-100 text-blue-700 font-medium' : ''}`;
                    item.dataset.id = book.id;
                    item.onclick = () => onSelect(book.id);
                    
                    const title = document.createElement("span");
                    title.textContent = book.bookName;
                    title.className = "text-sm truncate";
                    item.appendChild(title);
                    
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "ml-2 text-gray-400 hover:text-red-600 flex-shrink-0";
                    deleteBtn.innerHTML = `<i class="bi bi-trash" style="font-size: 0.875rem;"></i>`;
                    deleteBtn.title = "ì‚¬ê±´ ì‚­ì œ";
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        onDelete(book.id, book.bookName);
                    };
                    item.appendChild(deleteBtn);
                    this.bookList.appendChild(item);
                });
            }

            renderTOC(tocItems, currentSectionId, onSelect, onContextMenu) {
                this.tocPanel.innerHTML = "";
                const renderLevel = (items, level = 0) => {
                const ul = document.createElement("ul");
                if (level === 0) ul.classList.add('toc-root'); // .toc-root í´ë˜ìŠ¤ ì¶”ê°€
                
                    items.forEach(item => {
                        const li = document.createElement("li");
                        // [ìˆ˜ì •] í´ë˜ìŠ¤ ë³€ê²½ ë° CSS íŠ¸ë¦¬ í´ë˜ìŠ¤ ì¶”ê°€
                        li.className = "toc-item rounded-md cursor-pointer hover:bg-gray-200";
                        li.dataset.id = item.id;
                        li.title = item.text; // Tooltip for long text
                        
                        if (item.id === currentSectionId) {
                            li.classList.add("focused");
                        }
                        
                        // [ìˆ˜ì •] í´ë¦­ ì´ë²¤íŠ¸
                        li.onclick = (e) => {
                            e.stopPropagation();
                            onSelect(item.id);
                        };
                        
                        // [ì‹ ê·œ] ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì´ë²¤íŠ¸
                        li.oncontextmenu = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            onContextMenu(e, item);
                        };
                        
                        // [ì‹ ê·œ] ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ë¥¼ ë‹´ì„ div
                        const contentDiv = document.createElement("div");
                        contentDiv.className = "flex items-center space-x-1.5 p-1.5"; // p-1.5ëŠ” ê¸°ì¡´ liì˜ íŒ¨ë”©

                        // [ì‹ ê·œ] ì™„ë£Œ ìƒíƒœ ì•„ì´ì½˜
                        if (item.status === 'completed') {
                            const iconSpan = document.createElement("span");
                            iconSpan.innerHTML = `<i class="bi bi-check-circle-fill text-green-500"></i>`;
                            contentDiv.appendChild(iconSpan);
                        } else {
                            // ì•„ì´ì½˜ì´ ì—†ì„ ë•Œ ì •ë ¬ì„ ë§ì¶”ê¸° ìœ„í•œ ë¹ˆ ê³µê°„
                            const iconPlaceholder = document.createElement("span");
                            iconPlaceholder.innerHTML = `<i class="bi bi-dot text-gray-400"></i>`; // í˜¹ì€ íˆ¬ëª… ì•„ì´ì½˜
                            contentDiv.appendChild(iconPlaceholder);
                        }

                        const textSpan = document.createElement("span");
                        textSpan.textContent = item.text;
                        // [ìˆ˜ì •] í´ë˜ìŠ¤ ë³€ê²½ (block ì œê±°)
                        textSpan.className = "text-sm text-gray-800 truncate";
                        
                        contentDiv.appendChild(textSpan);
                        li.appendChild(contentDiv);
                        
                        if (item.children && item.children.length > 0) {
                            li.appendChild(renderLevel(item.children, level + 1));
                        }
                        ul.appendChild(li);
                    });
                    return ul;
                };
                this.tocPanel.appendChild(renderLevel(tocItems, 0));
            }

            renderActionPalette(actions, onAction) {
                this.actionPaletteContainer.innerHTML = "";
                actions.forEach(action => {
                    const button = document.createElement("button");
                    button.className = "bg-gray-200 text-gray-700 p-1.5 rounded-md hover:bg-gray-300 transition-colors";
                    button.title = action.tooltip;
                    button.innerHTML = `<i class="${action.icon}"></i>`;
                    button.onclick = () => onAction(action);
                    this.actionPaletteContainer.appendChild(button);
                });
            }

            showContextMenu(x, y, menuItems, onAction) {
                this.contextMenu.innerHTML = "";
                menuItems.forEach(item => {
                    const button = document.createElement("button");
                    button.className = "flex items-center space-x-2 w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100";
                    button.innerHTML = `<i class="bi ${item.icon} w-4 h-4"></i><span>${item.label}</span>`;
                    button.onclick = (e) => {
                        e.preventDefault();
                        onAction(item.action);
                        this.hideContextMenu();
                    };
                    this.contextMenu.appendChild(button);
                });
                
                this.contextMenu.style.left = `${x}px`;
                this.contextMenu.style.top = `${y}px`;
                this.contextMenu.style.display = "block";

                const clickOutsideHandler = (event) => {
                    if (!this.contextMenu.contains(event.target)) {
                        this.hideContextMenu();
                        document.removeEventListener("click", clickOutsideHandler);
                    }
                };
                setTimeout(() => document.addEventListener("click", clickOutsideHandler), 0);
            }

            hideContextMenu() {
                this.contextMenu.style.display = "none";
            }

            renderAnonymizationList(mapString, onDelete) {
                this.anonymizeList.innerHTML = "";
                let map = {};
                try {
                    map = JSON.parse(mapString || "{}");
                } catch (e) { console.error("Anonymization map parse error:", e); }

                const sortedKeys = Object.keys(map).sort((a, b) => b.length - a.length);

                if (sortedKeys.length === 0) {
                    this.anonymizeList.innerHTML = `<span class="text-sm text-gray-500 p-2">ë“±ë¡ëœ ìµëª…í™” í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
                    return;
                }

                sortedKeys.forEach(key => {
                    const value = map[key];
                    const item = document.createElement("div");
                    item.className = "flex items-center justify-between p-1.5 bg-white rounded border border-gray-200";
                    item.innerHTML = `
                        <div class="flex items-center space-x-2 overflow-hidden">
                            <span class="text-sm font-medium text-gray-900 truncate" title="${this.escapeHTML(key)}">${this.escapeHTML(key)}</span>
                            <i class="bi bi-arrow-right text-gray-400 text-xs"></i>
                            <span class="text-sm text-blue-600 font-mono bg-blue-50 px-1 py-0.5 rounded truncate" title="${this.escapeHTML(value)}">${this.escapeHTML(value)}</span>
                        </div>
                    `;
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "text-gray-400 hover:text-red-600 flex-shrink-0 p-1";
                    deleteBtn.innerHTML = `<i class="bi bi-x-lg" style="font-size: 0.75rem;"></i>`;
                    deleteBtn.title = "ì‚­ì œ";
                    deleteBtn.onclick = () => onDelete(key);
                    item.appendChild(deleteBtn);
                    this.anonymizeList.appendChild(item);
                });
            }

            renderGlobalFileList(files, onToggle, onSelect, onDelete, onRename) {
                this.globalFileList.innerHTML = "";
                if (!files || files.length === 0) {
                    this.globalFileList.innerHTML = `<span class="text-sm text-gray-500 p-2">ë“±ë¡ëœ ì „ì—­ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
                    return;
                }
                
                files.forEach(file => {
                    const item = document.createElement("div");
                    item.className = `flex items-center justify-between p-1.5 bg-white rounded border border-gray-200 ${file.id === this.currentSelectedGlobalFileId ? 'border-indigo-500' : ''}`;
                    
                    const left = document.createElement("div");
                    left.className = "flex items-center space-x-2 overflow-hidden";
                    
                    const toggle = document.createElement("label");
                    toggle.className = "toggle-switch";
                    const input = document.createElement("input");
                    input.type = "checkbox";
                    input.checked = file.isActive;
                    input.onchange = (e) => onToggle(file.id, e.target.checked);
                    const slider = document.createElement("span");
                    slider.className = "toggle-slider";
                    toggle.appendChild(input);
                    toggle.appendChild(slider);
                    
                    const title = document.createElement("span");
                    title.className = "text-sm text-gray-800 cursor-pointer hover:text-indigo-600 truncate";
                    title.textContent = file.title;
                    title.title = file.title;
                    title.onclick = () => onSelect(file);
                    
                    left.appendChild(toggle);
                    left.appendChild(title);
                    
                    const buttonGroup = document.createElement("div");
                    buttonGroup.className = "flex items-center space-x-1 flex-shrink-0";

                    const renameBtn = document.createElement("button");
                    renameBtn.className = "text-gray-400 hover:text-blue-600 p-1";
                    renameBtn.innerHTML = `<i class="bi bi-pencil" style="font-size: 0.875rem;"></i>`;
                    renameBtn.title = "ì´ë¦„ ë°”ê¾¸ê¸°";
                    renameBtn.onclick = (e) => {
                        e.stopPropagation();
                        onRename(file.id, file.title);
                    };

                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "text-gray-400 hover:text-red-600 p-1";
                    deleteBtn.innerHTML = `<i class="bi bi-trash" style="font-size: 0.875rem;"></i>`;
                    deleteBtn.title = "ìë£Œ ì‚­ì œ";
                    deleteBtn.onclick = () => onDelete(file.id);
                    
                    buttonGroup.appendChild(renameBtn);
                    buttonGroup.appendChild(deleteBtn);
                    
                    item.appendChild(left);
                    item.appendChild(buttonGroup);
                    this.globalFileList.appendChild(item);
                });
            }
            
            showGlobalFileEditor(file) {
                if (!file) {
                    this.globalFileEditor.classList.add("hidden");
                    this.currentSelectedGlobalFileId = null;
                    return;
                }
                
                this.currentSelectedGlobalFileId = file.id;
                this.globalFileTitle.value = file.title;
                this.globalFileContent.value = file.content;
                this.saveGlobalFileBtn.dataset.id = file.id;
                this.globalFileEditor.classList.remove("hidden");

                if (window.appInstance) {
                    window.appInstance.updateHighlighter('global');
                }
            }

            // --- UI Data Binding ---

            setEditorText(text) {
                this.mainEditor.value = text;
            }
            getEditorText() {
                return this.mainEditor.value;
            }

            setActiveTab(tabId) {
                this.kbTabsContainer.querySelectorAll('.kb-tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.kb-tab-pane').forEach(pane => pane.classList.remove('active'));
                
                const activeBtn = this.kbTabsContainer.querySelector(`[data-tab="${tabId}"]`);
                const activePane = document.getElementById(tabId);
                if (activeBtn) activeBtn.classList.add('active');
                if (activePane) activePane.classList.add('active');
                
                if (tabId !== 'kb-tab-content-global') {
                     this.showGlobalFileEditor(null);
                }
            }
            
            // [ì‹ ê·œ] ì„¤ì • ëª¨ë‹¬ì˜ íƒ­ ì „í™˜
            setActiveSettingsTab(tabId) {
                this.settingsPanelWrapper.querySelectorAll('.settings-tab').forEach(btn => btn.classList.remove('active', 'text-gray-700', 'font-semibold'));
                this.settingsPanelWrapper.querySelectorAll('.settings-tab-pane').forEach(pane => pane.classList.remove('active'));
                
                const activeBtn = this.settingsPanelWrapper.querySelector(`[data-tab="${tabId}"]`);
                const activePane = document.getElementById(tabId);
                
                if (activeBtn) activeBtn.classList.add('active', 'text-gray-700', 'font-semibold');
                if (activePane) activePane.classList.add('active');
            }

            loadBookDataToUI(book, app) {
                this.kbTabPanes.summary.value = book.kb_summary || "";
                this.kbTabPanes.individual.value = ""; 
                
                this.renderGlobalFileList(book.virtualFiles || [],
                    (id, isActive) => app.toggleGlobalFile(id, isActive),
                    (file) => app.selectGlobalFile(file),
                    (id) => app.deleteGlobalFile(id),
                    (id, title) => app.renameGlobalFile(id, title)
                );
                this.showGlobalFileEditor(null); 

                this.renderAnonymizationList(book.anonymizationMap || "{}", (key) => app.deleteAnonymizationPair(key));
                
                if (window.appInstance) {
                    window.appInstance.updateAllHighlighters();
                }
                this.setActiveTab("kb-tab-content-summary");
            }

            saveBookDataFromUI(book) {
                book.kb_summary = this.kbTabPanes.summary.value;
            }

            resetUI(app) {
                this.tocPanel.innerHTML = "<span class='text-sm text-gray-500 p-3'>ì‚¬ê±´ì„ ì„ íƒí•˜ì„¸ìš”.</span>";
                this.actionPaletteContainer.innerHTML = "";
                this.mainEditor.value = "";
                this.mainEditor.disabled = true;
                this.generateTocBtn.disabled = true;
                
                this.kbTabPanes.summary.value = "";
                this.kbTabPanes.individual.value = "";
                this.renderGlobalFileList([], () => {}, () => {}, () => {}, () => {});
                this.showGlobalFileEditor(null);
                this.renderAnonymizationList("{}", () => {});
            }

            attachEventListeners(app) {
                this.messageCloseBtn.onclick = () => this.hideMessage();
                
                this.kbTabsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.kb-tab-button');
                    if (button && button.dataset.tab) {
                        this.setActiveTab(button.dataset.tab);
                    }
                });
                
                this.addGlobalFileBtn.onclick = () => app.addNewGlobalFile();
                this.saveGlobalFileBtn.onclick = () => app.saveSelectedGlobalFile();
                this.closeGlobalFileBtn.onclick = () => this.showGlobalFileEditor(null);
                
                // [ì‹ ê·œ] ì„¤ì • ëª¨ë‹¬ ë¦¬ìŠ¤ë„ˆ
                this.openSettingsBtn.onclick = () => {
                    app.loadPromptEditorToUI(); // ëª¨ë‹¬ ì—´ ë•Œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
                    this.settingsModal.classList.remove('hidden');
                }
                this.modalCloseSettingsBtn.onclick = () => this.settingsModal.classList.add('hidden');
                
                this.settingsPanelWrapper.addEventListener('click', (e) => {
                     const button = e.target.closest('.settings-tab');
                    if (button && button.dataset.tab) {
                        this.setActiveSettingsTab(button.dataset.tab);
                    }
                });
                
                this.saveActionsBtn.onclick = () => app.saveCustomActionsFromUI();
                this.savePromptBtn.onclick = () => app.saveCustomPromptFromUI();
                this.actionsDocType.onchange = () => app.loadPromptEditorToUI();
                this.promptsDocType.onchange = () => app.loadPromptEditorToUI();
                this.promptsKey.onchange = () => app.loadPromptEditorToUI();
            }
            
            escapeHTML(str) {
                 return (str || "").replace(/[&<>"']/g, (match) => {
                    const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'};
                    return map[match];
                });
            }
        }

        /**
         * @class BookStorageService (IndexedDB)
         */
        class BookStorageService {
            constructor() {
                this.dbName = "LegalWriterDB_v_Final";
                this.dbVersion = 1;
                this.db = null;
            }

            async open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onerror = (event) => reject("IndexedDB open error: " + event.target.error);
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains("books")) {
                            db.createObjectStore("books", { keyPath: "id", autoIncrement: true });
                        }
                    };
                });
            }

            async getBook(id) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(["books"], "readonly");
                    const store = transaction.objectStore("books");
                    const request = store.get(id);
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject("Get book error: " + event.target.error);
                });
            }

            async getAllBooks() {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(["books"], "readonly");
                    const store = transaction.objectStore("books");
                    const request = store.getAll();
                    request.onsuccess = (event) => {
                        resolve(event.target.result.reverse());
                    };
                    request.onerror = (event) => reject("Get all books error: " + event.target.error);
                });
            }

            async saveBook(book) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(["books"], "readwrite");
                    const store = transaction.objectStore("books");
                    const request = store.put(book);
                    request.onsuccess = (event) => resolve(event.target.result); 
                    request.onerror = (event) => reject("Save book error: " + event.target.error);
                });
            }

            async deleteBook(id) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(["books"], "readwrite");
                    const store = transaction.objectStore("books");
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject("Delete book error: " + event.target.error);
                });
            }
        }
        
        /**
         * @class PromptBuilder
         */
        class PromptBuilder {
            // [ì‹ ê·œ] ìƒì„±ìì—ì„œ templatesë¥¼ ë°›ìŒ
            constructor(templates) {
                this.templates = templates;
            }

            buildTocPrompt(book) {
                const template = this.templates.litigation.tocPrompt;
                if (!template) return "TOC í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                
                const summary = book.kb_summary || "ë°ì´í„° ì—†ìŒ";
                const activeFiles = (book.virtualFiles || []).filter(f => f.isActive);
                const globalData = activeFiles.map(f => `
<Global_Data title="${this.escapeXML(f.title)}">
${this.escapeXML(f.content)}
</Global_Data>
                `).join('\n');

                let prompt = template;
                prompt = prompt.replace(new RegExp('{{ì‚¬ê±´ê°œìš”DB}}', 'g'), this.escapeXML(summary));
                prompt = prompt.replace(new RegExp('{{ì „ì—­_í™œì„±ìë£Œ}}', 'g'), globalData || "ë°ì´í„° ì—†ìŒ");
                
                return prompt;
            }

            buildActionPrompt(action, context, modalVariables = {}) {
                const { book, section, allTocText, previousText, currentText, individualContent } = context;
                
                // 1. ì‚¬ìš©í•  í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ê²°ì •
                const promptTemplateKey = action.promptTemplateKey;
                let template = this.templates.litigation[promptTemplateKey];
                
                if (!template) {
                    console.error(`í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ '${promptTemplateKey}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    return `ì˜¤ë¥˜: '${promptTemplateKey}' í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.`;
                }

                // 2. ì»¨í…ìŠ¤íŠ¸ ë³€ìˆ˜ ì¤€ë¹„
                const summary = book.kb_summary || "ë°ì´í„° ì—†ìŒ";
                const localData = individualContent || "ë°ì´í„° ì—†ìŒ";
                const activeFiles = (book.virtualFiles || []).filter(f => f.isActive);
                const globalData = activeFiles.map(f => `
<Global_Data title="${this.escapeXML(f.title)}">
${this.escapeXML(f.content)}
</Global_Data>
                `).join('\n');

                // 3. ëª¨ë“  ë³€ìˆ˜ë¥¼ ê°ì²´ë¡œ
                const allVars = {
                    '{{ì‚¬ê±´ê°œìš”DB}}': this.escapeXML(summary),
                    '{{ì „ì—­_í™œì„±ìë£Œ}}': globalData || "ë°ì´í„° ì—†ìŒ",
                    '{{ì „ì²´_ëª©ì°¨}}': this.escapeXML(allTocText),
                    '{{ì´ì „_ì‘ì„±_ë³¸ë¬¸}}': this.escapeXML(previousText) || "ì•„ì§ ì—†ìŒ",
                    '{{ê°œë³„ìë£Œ}}': this.escapeXML(localData),
                    '{{CURRENT_SECTION_ID}}': section.id,
                    '{{CURRENT_SECTION_TEXT}}': this.escapeXML(section.text),
                    '{{CURRENT_CONTENT}}': this.escapeXML(currentText) || "ì•„ì§ ì—†ìŒ",
                    ...modalVariables // userRequest ë“± ëª¨ë‹¬ ë³€ìˆ˜ ì¶”ê°€
                };
                
                // 4. ëª¨ë“  ë³€ìˆ˜ ì¼ê´„ ì¹˜í™˜
                let prompt = template;
                for (const key in allVars) {
                    // {{userRequest}} ê°™ì€ ëª¨ë‹¬ ë³€ìˆ˜ë„ ì¹˜í™˜
                    const value = allVars[key] || allVars[this.escapeXML(key)] || "";
                    prompt = prompt.replace(new RegExp(key, 'g'), value);
                }

                return prompt;
            }
            
            escapeXML(str) {
                return (str || "").replace(/[<>&'"]/g, (match) => {
                    const map = {'<': '&lt;', '>': '&gt;', '&': '&amp;', "'": '&#39;', '"': '&quot;'};
                    return map[match];
                });
            }
        }

        /**
         * @class App
         * Main application controller.
         */
        class App {
            constructor() {
                this.db = new BookStorageService();
                this.ui = new UIRenderer();
                this.gemini = new GeminiService(this.ui);
                this.anonymizer = new AIAnonymizer();
                this.highlighters = {};
                
                // [ì‹ ê·œ] í…œí”Œë¦¿ê³¼ ë¹Œë”ëŠ” initì—ì„œ ë¡œë“œ
                this.templates = null;
                this.promptBuilder = null; 

                this.books = [];
                this.currentBook = null;
                this.currentSectionId = null;
                
                this.contextMenuActions = [
                    { label: "ë°˜ë°• ë…¼ë¦¬ ìƒì„±", icon: "bi-lightbulb", action: "rebuttal" },
                    { label: "ë‚´ìš© ìš”ì•½í•˜ê¸°", icon: "bi-card-text", action: "summarize" },
                    { label: "ë” ìƒì„¸í•˜ê²Œ ì‘ì„±", icon: "bi-pencil-fill", action: "modify" },
                    { label: "ìµëª…í™” ì²˜ë¦¬", icon: "bi-eye-slash", action: "anonymize-add" },
                    { label: "ì‚¬ê±´ ê°œìš”ë¡œ ë“±ë¡", icon: "bi-bookmark-plus", action: "add-to-summary" },
                ];
            }

            /**
             * [ì‹ ê·œ] í…œí”Œë¦¿ ë¡œë“œ (localStorageì™€ ê¸°ë³¸ê°’ ë³‘í•©)
             */
            loadTemplates() {
                const defaultTemplates = JSON.parse(JSON.stringify(PROMPT_TEMPLATES));
                let customTemplates = {};
                try {
                    const stored = localStorage.getItem('legalWriterCustomTemplates');
                    if (stored) {
                        customTemplates = JSON.parse(stored);
                    }
                } catch (e) {
                    console.error("ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ íŒŒì‹± ì‹¤íŒ¨:", e);
                    localStorage.removeItem('legalWriterCustomTemplates');
                }

                // ê¸°ë³¸ê°’ ìœ„ì— ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ë®ì–´ì“°ê¸°
                if (customTemplates.litigation) {
                    // actionsì™€ í”„ë¡¬í”„íŠ¸ í‚¤ë“¤ì„ ê°œë³„ì ìœ¼ë¡œ ë³‘í•©
                    if (customTemplates.litigation.actions) {
                        defaultTemplates.litigation.actions = customTemplates.litigation.actions;
                    }
                    if (customTemplates.litigation.tocPrompt) {
                        defaultTemplates.litigation.tocPrompt = customTemplates.litigation.tocPrompt;
                    }
                    if (customTemplates.litigation.writingPrompt) {
                        defaultTemplates.litigation.writingPrompt = customTemplates.litigation.writingPrompt;
                    }
                     if (customTemplates.litigation.modificationPrompt) {
                        defaultTemplates.litigation.modificationPrompt = customTemplates.litigation.modificationPrompt;
                    }
                     if (customTemplates.litigation.reviewPrompt) {
                        defaultTemplates.litigation.reviewPrompt = customTemplates.litigation.reviewPrompt;
                    }
                }
                
                this.templates = defaultTemplates;
                this.promptBuilder = new PromptBuilder(this.templates); // ìƒˆ í…œí”Œë¦¿ìœ¼ë¡œ ë¹Œë” ì¬ìƒì„±
            }
            
            /**
             * [ì‹ ê·œ] ì»¤ìŠ¤í…€ í…œí”Œë¦¿ ì €ì¥ (UI ë¡œì§ ì•„ë‹˜)
             */
            saveCustomTemplate(docType, key, value) {
                let customTemplates = {};
                try {
                    const stored = localStorage.getItem('legalWriterCustomTemplates');
                    if (stored) {
                        customTemplates = JSON.parse(stored);
                    }
                } catch (e) { console.error("Error reading custom templates:", e); }

                if (!customTemplates[docType]) {
                    customTemplates[docType] = {};
                }
                customTemplates[docType][key] = value;
                
                try {
                    localStorage.setItem('legalWriterCustomTemplates', JSON.stringify(customTemplates));
                    this.loadTemplates(); // ì €ì¥ í›„ ì¦‰ì‹œ ë¦¬ë¡œë“œ
                    this.ui.showMessage("ì €ì¥ ì™„ë£Œ", "í”„ë¡¬í”„íŠ¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì— ë°˜ì˜ë©ë‹ˆë‹¤.");
                } catch (e) {
                    console.error("Failed to save custom templates:", e);
                    this.ui.showMessage("ì €ì¥ ì‹¤íŒ¨", "í”„ë¡¬í”„íŠ¸ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }
            
            /**
             * [ì‹ ê·œ] ì„¤ì • ëª¨ë‹¬ UIì— í˜„ì¬ í…œí”Œë¦¿ ë¡œë“œ
             */
            loadPromptEditorToUI() {
                try {
                    const actionsDocType = this.ui.actionsDocType.value;
                    const actions = this.templates[actionsDocType]?.actions || [];
                    this.ui.actionsJsonEditor.value = JSON.stringify(actions, null, 4);
                } catch (e) {
                    this.ui.actionsJsonEditor.value = "[]";
                }

                try {
                    const promptsDocType = this.ui.promptsDocType.value;
                    const promptsKey = this.ui.promptsKey.value;
                    
                    let promptContent = "";
                    if (promptsKey === 'modificationPrompt') {
                         promptContent = this.templates[promptsDocType]?.modificationPrompt || MODIFICATION_PROMPT_TEMPLATE;
                    } else if (promptsKey === 'reviewPrompt') {
                        promptContent = this.templates[promptsDocType]?.reviewPrompt || REVIEW_PROMPT_TEMPLATE;
                    } else {
                        promptContent = this.templates[promptsDocType]?.[promptsKey] || "";
                    }
                    this.ui.promptsEditor.value = promptContent;
                } catch (e) {
                    this.ui.promptsEditor.value = "í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                }
            }
            
            /**
             * [ì‹ ê·œ] ì„¤ì • UIì—ì„œ ì•¡ì…˜ ì €ì¥
             */
            saveCustomActionsFromUI() {
                const docType = this.ui.actionsDocType.value;
                try {
                    const actionsArray = JSON.parse(this.ui.actionsJsonEditor.value);
                    if (!Array.isArray(actionsArray)) throw new Error("JSONì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
                    
                    this.saveCustomTemplate(docType, 'actions', actionsArray);
                    // ì•¡ì…˜ íŒ”ë ˆíŠ¸ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
                    this.ui.renderActionPalette(
                        this.templates.litigation.actions || [], 
                        (action) => this.handleActionButton(action)
                    );
                } catch (e) {
                    this.ui.showMessage("ì €ì¥ ì‹¤íŒ¨", "ìœ íš¨í•˜ì§€ ì•Šì€ JSON í˜•ì‹ì…ë‹ˆë‹¤.\n" + e.message);
                }
            }
            
            /**
             * [ì‹ ê·œ] ì„¤ì • UIì—ì„œ í”„ë¡¬í”„íŠ¸ ì €ì¥
             */
            saveCustomPromptFromUI() {
                const docType = this.ui.promptsDocType.value;
                const key = this.ui.promptsKey.value;
                const content = this.ui.promptsEditor.value;
                this.saveCustomTemplate(docType, key, content);
            }

            /**
             * Initializes the application.
             */
            async init() {
                this.loadTemplates(); // [ì‹ ê·œ] í…œí”Œë¦¿ ë¨¼ì € ë¡œë“œ
                this.ui.attachEventListeners(this);
                this.initHighlighters();
                this.attachGlobalEventListeners();
                
                await this.db.open();
                await this.loadBookList();
                this.ui.resetUI(this);
            }
            
            initHighlighters() {
                this.highlighters = {
                    'main': new AnonymizationHighlighter(this.ui.mainEditor, this.ui.mainEditorBackdrop, this.anonymizer),
                    'summary': new AnonymizationHighlighter(this.ui.kbTabPanes.summary, this.ui.kbBackdrops.summary, this.anonymizer),
                    'individual': new AnonymizationHighlighter(this.ui.kbTabPanes.individual, this.ui.kbBackdrops.individual, this.anonymizer),
                    'global': new AnonymizationHighlighter(this.ui.globalFileContent, this.ui.kbBackdrops.global, this.anonymizer),
                    'ai-prompt': new AnonymizationHighlighter(this.ui.aiPromptDisplay, this.ui.aiPromptBackdrop, this.anonymizer),
                    'ai-response': new AnonymizationHighlighter(this.ui.aiResponseInput, this.ui.aiResponseBackdrop, this.anonymizer),
                };
            }
            
            attachGlobalEventListeners() {
                this.ui.newBookBtn.onclick = () => this.createNewBook();
                this.ui.generateTocBtn.onclick = () => this.generateTOC();
                
                this.ui.mainEditor.oncontextmenu = (e) => {
                    e.preventDefault();
                    const selection = window.getSelection().toString().trim();
                    const menuItems = this.contextMenuActions.filter(item => {
                        if (item.action === 'anonymize-add' || item.action === 'add-to-summary') {
                            return !!selection;
                        }
                        return true;
                    });
                    this.ui.showContextMenu(e.pageX, e.pageY, menuItems, (action) => this.handleContextMenuAction(action, selection));
                };
                
                this.ui.kbTabPanes.summary.onblur = () => this.saveCurrentBookDataFromUI();
                this.ui.kbTabPanes.individual.onblur = () => this.saveCurrentIndividualContent();
                
                const textareas = [
                    { id: 'main', el: this.ui.mainEditor },
                    { id: 'summary', el: this.ui.kbTabPanes.summary },
                    { id: 'individual', el: this.ui.kbTabPanes.individual },
                    { id: 'global', el: this.ui.globalFileContent }
                ];
                
                textareas.forEach(({ id, el }) => {
                    el.oninput = () => this.updateHighlighter(id);
                    el.onscroll = () => this.syncHighlighterScroll(id);
                });
                
                this.ui.anonymizeForm.onsubmit = (e) => {
                    e.preventDefault();
                    this.addAnonymizationPair();
                };
            }

            // --- Book (Case) Management ---

            async loadBookList() {
                this.books = await this.db.getAllBooks();
                this.ui.renderBookList(this.books, this.currentBook?.id, 
                    (id) => this.loadBook(id),
                    (id, name) => this.deleteBook(id, name)
                );
            }

            async loadBook(id) {
                this.currentBook = await this.db.getBook(id);
                this.currentSectionId = null;
                
                this.ui.renderBookList(this.books, this.currentBook.id, 
                    (id) => this.loadBook(id),
                    (id, name) => this.deleteBook(id, name)
                );
                this.ui.renderTOC(this.currentBook.toc || [], null, 
                    (id) => this.selectSection(id),
                    (e, item) => this.handleTocContextMenu(e, item)
                );
                
                this.ui.mainEditor.disabled = true;
                this.ui.generateTocBtn.disabled = false;
                
                this.ui.setEditorText("");
                this.ui.loadBookDataToUI(this.currentBook, this);
                
                // [ì‹ ê·œ] í…œí”Œë¦¿ ê¸°ë°˜ìœ¼ë¡œ ì•¡ì…˜ íŒ”ë ˆíŠ¸ ë Œë”ë§
                this.ui.renderActionPalette(
                    this.templates.litigation.actions || [], 
                    (action) => this.handleActionButton(action)
                );
                
                this.updateAllHighlighters();
            }

            async createNewBook() {
                const bookName = await this.ui.showNewCasePrompt();
                if (!bookName) return; 

                const newBook = {
                    bookName: bookName,
                    toc: [],
                    contents: {},
                    individualContents: {},
                    kb_summary: "",
                    anonymizationMap: "{}",
                    virtualFiles: [],
                    createdAt: Date.now(),
                    // [ì‹ ê·œ] ê¸°ë³¸ ë¬¸ì„œ íƒ€ì…ì„ litigationìœ¼ë¡œ ì„¤ì •
                    documentType: 'litigation' 
                };
                const newId = await this.db.saveBook(newBook);
                newBook.id = newId;
                
                this.books.unshift(newBook); 
                this.loadBook(newId);
            }

            async deleteBook(id, name) {
                const confirmed = await this.ui.showConfirm("ì‚¬ê±´ ì‚­ì œ", `'${name}' ì‚¬ê±´ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                if (!confirmed) return;

                await this.db.deleteBook(id);
                this.books = this.books.filter(b => b.id !== id);
                
                if (this.currentBook && this.currentBook.id === id) {
                    this.currentBook = null;
                    this.currentSectionId = null;
                    this.ui.resetUI(this);
                }
                
                this.ui.renderBookList(this.books, this.currentBook?.id, 
                    (id) => this.loadBook(id),
                    (id, name) => this.deleteBook(id, name)
                );
            }

            // --- Section (TOC) & Content Management ---

            selectSection(id) {
                if (this.currentSectionId !== null) {
                    this.saveCurrentSectionContent(true); 
                }
                
                this.currentSectionId = id;
                this.ui.renderTOC(this.currentBook.toc, id, 
                    (id) => this.selectSection(id),
                    (e, item) => this.handleTocContextMenu(e, item)
                );
                
                const content = this.currentBook.contents[id] || "";
                this.ui.setEditorText(content);
                this.ui.mainEditor.disabled = false;
                
                const individualContent = this.currentBook.individualContents[id] || "";
                this.ui.kbTabPanes.individual.value = individualContent;
                
                this.updateHighlighter('main');
                this.updateHighlighter('individual');

                // [ì‹ ê·œ] í…œí”Œë¦¿ ê¸°ë°˜ìœ¼ë¡œ ì•¡ì…˜ íŒ”ë ˆíŠ¸ ë Œë”ë§
                this.ui.renderActionPalette(
                    this.templates.litigation.actions || [], 
                    (action) => this.handleActionButton(action)
                );
            }

            async saveCurrentSectionContent(saveToDb = true) {
                if (this.currentBook && this.currentSectionId !== null) {
                    const content = this.ui.getEditorText();
                    this.currentBook.contents[this.currentSectionId] = content;
                    if (saveToDb) {
                        await this.db.saveBook(this.currentBook);
                    }
                }
            }
            
            async saveCurrentIndividualContent() {
                if (this.currentBook && this.currentSectionId !== null) {
                    const content = this.ui.kbTabPanes.individual.value;
                    if (!this.currentBook.individualContents) {
                        this.currentBook.individualContents = {};
                    }
                    this.currentBook.individualContents[this.currentSectionId] = content;
                    await this.db.saveBook(this.currentBook);
                }
            }

            async saveCurrentBookDataFromUI() {
                if (this.currentBook) {
                    this.ui.saveBookDataFromUI(this.currentBook);
                    await this.db.saveBook(this.currentBook);
                }
            }
            
            // --- Anonymization Handlers ---

            async addAnonymizationPair() {
                if (!this.currentBook) return;
                
                const key = this.ui.anonymizeKeyInput.value.trim();
                const value = this.ui.anonymizeValueInput.value.trim();
                
                if (!key || !value) {
                    this.ui.showMessage("ì…ë ¥ ì˜¤ë¥˜", "ì›ë³¸ í…ìŠ¤íŠ¸ì™€ ìµëª…í™” í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }
                
                let map = {};
                try {
                    map = JSON.parse(this.currentBook.anonymizationMap || "{}");
                } catch (e) { map = {}; }
                
                map[key] = value;
                this.currentBook.anonymizationMap = JSON.stringify(map);
                
                this.ui.renderAnonymizationList(this.currentBook.anonymizationMap, (k) => this.deleteAnonymizationPair(k));
                this.ui.anonymizeKeyInput.value = "";
                this.ui.anonymizeValueInput.value = "";
                
                await this.db.saveBook(this.currentBook);
                
                this.updateAllHighlighters();
            }
            
            async deleteAnonymizationPair(key) {
                if (!this.currentBook) return;
                
                const confirmed = await this.ui.showConfirm("ì‚­ì œ í™•ì¸", `'${key}' í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                if (confirmed) {
                    let map = {};
                    try {
                        map = JSON.parse(this.currentBook.anonymizationMap || "{}");
                    } catch (e) { map = {}; }
                    
                    delete map[key];
                    this.currentBook.anonymizationMap = JSON.stringify(map);
                    
                    this.ui.renderAnonymizationList(this.currentBook.anonymizationMap, (k) => this.deleteAnonymizationPair(k));
                    await this.db.saveBook(this.currentBook);
                    
                    this.updateAllHighlighters();
                }
            }
            
            // --- Global Data (V-KB) Handlers ---

            async addNewGlobalFile() {
                if (!this.currentBook) return;
                
                const title = await this.ui.showPrompt("ìƒˆ ìë£Œ ì¶”ê°€", "ìƒˆ ìë£Œì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", "ìƒˆ ìë£Œ");
                if (!title) return;

                const newFile = {
                    id: 'vf-' + Date.now(),
                    title: title,
                    content: '',
                    isActive: true
                };
                
                if (!this.currentBook.virtualFiles) {
                    this.currentBook.virtualFiles = [];
                }
                this.currentBook.virtualFiles.push(newFile);
                
                await this.db.saveBook(this.currentBook);
                
                this.ui.renderGlobalFileList(this.currentBook.virtualFiles,
                    (id, isActive) => this.toggleGlobalFile(id, isActive),
                    (file) => this.selectGlobalFile(file),
                    (id) => this.deleteGlobalFile(id),
                    (id, title) => this.renameGlobalFile(id, title)
                );
                this.ui.showGlobalFileEditor(newFile);
            }
            
            selectGlobalFile(file) {
                this.ui.showGlobalFileEditor(file);
                this.ui.renderGlobalFileList(this.currentBook.virtualFiles,
                    (id, isActive) => this.toggleGlobalFile(id, isActive),
                    (file) => this.selectGlobalFile(file),
                    (id) => this.deleteGlobalFile(id),
                    (id, title) => this.renameGlobalFile(id, title)
                );
            }
            
            async saveSelectedGlobalFile() {
                if (!this.currentBook || !this.ui.currentSelectedGlobalFileId) return;
                
                const fileId = this.ui.saveGlobalFileBtn.dataset.id;
                const file = this.currentBook.virtualFiles.find(f => f.id === fileId);
                
                if (file) {
                    file.title = this.ui.globalFileTitle.value;
                    file.content = this.ui.globalFileContent.value;
                    
                    await this.db.saveBook(this.currentBook);
                    
                    this.ui.renderGlobalFileList(this.currentBook.virtualFiles,
                        (id, isActive) => this.toggleGlobalFile(id, isActive),
                        (file) => this.selectGlobalFile(file),
                        (id) => this.deleteGlobalFile(id),
                        (id, title) => this.renameGlobalFile(id, title)
                    );
                    this.ui.showMessage("ì €ì¥ ì™„ë£Œ", `"${file.title}" ìë£Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            }

            async toggleGlobalFile(fileId, isActive) {
                if (!this.currentBook) return;
                
                const file = this.currentBook.virtualFiles.find(f => f.id === fileId);
                if (file) {
                    file.isActive = isActive;
                    await this.db.saveBook(this.currentBook);
                }
            }

            async renameGlobalFile(fileId, oldTitle) {
                if (!this.currentBook) return;

                const newTitle = await this.ui.showPrompt("ìë£Œ ì´ë¦„ ë°”ê¾¸ê¸°", "ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", oldTitle);
                if (!newTitle || newTitle === oldTitle) return; 

                const file = this.currentBook.virtualFiles.find(f => f.id === fileId);
                if (file) {
                    file.title = newTitle;
                    await this.db.saveBook(this.currentBook);

                    this.ui.renderGlobalFileList(this.currentBook.virtualFiles,
                        (id, isActive) => this.toggleGlobalFile(id, isActive),
                        (file) => this.selectGlobalFile(file),
                        (id) => this.deleteGlobalFile(id),
                        (id, title) => this.renameGlobalFile(id, title)
                    );
                    
                    if (this.ui.currentSelectedGlobalFileId === fileId) {
                        this.ui.globalFileTitle.value = newTitle;
                    }
                }
            }

            async deleteGlobalFile(fileId) {
                if (!this.currentBook) return;
                
                const file = this.currentBook.virtualFiles.find(f => f.id === fileId);
                const confirmed = await this.ui.showConfirm("ìë£Œ ì‚­ì œ", `'${file.title}' ìë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                
                if (confirmed) {
                    this.currentBook.virtualFiles = this.currentBook.virtualFiles.filter(f => f.id !== fileId);
                    await this.db.saveBook(this.currentBook);
                    
                    this.ui.renderGlobalFileList(this.currentBook.virtualFiles,
                        (id, isActive) => this.toggleGlobalFile(id, isActive),
                        (file) => this.selectGlobalFile(file),
                        (id) => this.deleteGlobalFile(id),
                        (id, title) => this.renameGlobalFile(id, title)
                    );
                    
                    if (this.ui.currentSelectedGlobalFileId === fileId) {
                        this.ui.showGlobalFileEditor(null);
                    }
                }
            }


            // --- AI Function Handlers ---

            async generateTOC() {
                if (!this.currentBook) return;
                
                const confirmed = await this.ui.showConfirm("ëª©ì°¨ ìƒì„±", "KB ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒˆ ëª©ì°¨ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê¸°ì¡´ ëª©ì°¨ì™€ ë³¸ë¬¸ì€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                if (!confirmed) return;

                this.ui.showLoading(true);
                try {
                    const rawPrompt = this.promptBuilder.buildTocPrompt(this.currentBook);
                    const prompt = this.anonymizer.anonymize(rawPrompt, this.currentBook.anonymizationMap);
                    
                    const anonymizedResult = await this.gemini.call(prompt, "ëª©ì°¨(TOC) ìƒì„±");
                    
                    if (anonymizedResult) {
                        const result = this.anonymizer.deanonymize(anonymizedResult, this.currentBook.anonymizationMap);
                        
                        // [ì‹ ê·œ] textgenerator.htmlì˜ íŒŒì„œ ë¡œì§ ì ìš©
                        const newToc = this.parseToc(result);
                        if (!Array.isArray(newToc)) {
                             throw new Error("AIê°€ ìœ íš¨í•œ JSON ë°°ì—´ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                        }
                        
                        let nextId = 0;
                        const generateIds = (items) => {
                            return items.map(item => ({
                                id: nextId++,
                                text: item.text,
                                status: "default", // [ì‹ ê·œ] ì‘ì—… ì™„ë£Œ ìƒíƒœ í•„ë“œ
                                children: item.children ? generateIds(item.children) : []
                            }));
                        };
                        
                        this.currentBook.toc = generateIds(newToc);
                        this.currentBook.contents = {}; 
                        this.currentBook.individualContents = {}; 
                        
                        await this.db.saveBook(this.currentBook);
                        this.selectSection(null); 
                        this.ui.renderTOC(this.currentBook.toc, null, (id) => this.selectSection(id));this.ui.renderTOC(this.currentBook.toc, null, 
                            (id) => this.selectSection(id),
                            (e, item) => this.handleTocContextMenu(e, item)
                        );
                        this.ui.setEditorText("");
                        this.ui.kbTabPanes.individual.value = "";
                    }
                } catch (error) {
                    console.error("TOC generation failed:", error);
                    this.ui.showMessage("TOC ìƒì„± ì˜¤ë¥˜", error.message);
                } finally {
                    this.ui.showLoading(false);
                }
            }
            
            parseToc(text) {
                try {
                    // 1. JSON íŒŒì‹± ì‹œë„
                    return JSON.parse(text);
                } catch (e) {
                     // 2. JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, í…ìŠ¤íŠ¸ ê³„ì¸µ íŒŒì„œ ì‹¤í–‰
                     console.error("Failed to parse TOC JSON (fallback to text parser):", e, text);
                     try {
                        const lines = text.split('\n').filter(line => line.trim().length > 0);
                        if (lines.length === 0) return [];

                        const getIndentLevel = (lineText) => {
                            const match = lineText.match(/^(\s*)/);
                            // íƒ­ì„ ìŠ¤í˜ì´ìŠ¤ 4ì¹¸ìœ¼ë¡œ ê³„ì‚° (í˜¹ì€ í•„ìš”ì— ë”°ë¼ ì¡°ì •)
                            const indent = match ? match[1].replace(/\t/g, '    ').length : 0;
                            return indent;
                        };

                        const root = { children: [] };
                        // ìŠ¤íƒ: [ { node: ë¶€ëª¨ë…¸ë“œ, level: ë¶€ëª¨ë…¸ë“œì˜ ë“¤ì—¬ì“°ê¸° ë ˆë²¨ } ]
                        const stack = [{ node: root, level: -1 }];

                        lines.forEach(line => {
                            const text = line.trim();
                            if (!text) return;

                            const level = getIndentLevel(line);
                            const newNode = { text: text, children: [] };

                            // í˜„ì¬ ìŠ¤íƒì—ì„œ í˜„ì¬ ë ˆë²¨ë³´ë‹¤ ë‚®ì€(ìƒìœ„) ë…¸ë“œë¥¼ ì°¾ìŒ
                            while (stack.length > 0 && stack[stack.length - 1].level >= level) {
                                stack.pop();
                            }

                            // ìŠ¤íƒì˜ topì´ í˜„ì¬ ë…¸ë“œì˜ ë¶€ëª¨
                            const parent = stack[stack.length - 1].node;
                            parent.children.push(newNode);
                            
                            // í˜„ì¬ ë…¸ë“œë¥¼ ìŠ¤íƒì— ì¶”ê°€
                            stack.push({ node: newNode, level: level });
                        });

                        return root.children;
                        
                     } catch (parseError) {
                        // 3. í…ìŠ¤íŠ¸ íŒŒì„œë„ ì‹¤íŒ¨í•˜ë©´, ê¸°ì¡´ì˜ ë‹¨ìˆœ í´ë°± ì‹¤í–‰
                        console.error("Failed to parse hierarchical text (fallback to flat list):", parseError, text);
                        const lines = text.split('\n').filter(line => line.trim() !== "");
                        return lines.map(line => ({
                            text: line.trim().replace(/<\/?(ul|li|p|div)>/g, ''),
                            children: []
                        }));
                     }
                }
            }
            
            async handleContextMenuAction(action, selection) {
                if (!this.currentBook) return;

                if (action === 'anonymize-add') {
                    this.ui.setActiveTab('kb-tab-content-anonymize');
                    this.ui.anonymizeKeyInput.value = selection;
                    this.ui.anonymizeValueInput.focus();
                    return;
                }
                
                if (action === 'add-to-summary') {
                    this.ui.kbTabPanes.summary.value += `\n- (ì£¼ìš” ì‚¬ì‹¤) ${selection}`;
                    await this.saveCurrentBookDataFromUI();
                    this.ui.showMessage("ì„±ê³µ", "ì„ íƒí•œ í…ìŠ¤íŠ¸ê°€ 'ì‚¬ê±´ ê°œìš”'ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    this.updateHighlighter('summary');
                    return;
                }
                
                // [ì‹ ê·œ] ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ì˜ AI ì•¡ì…˜ì„ ì•¡ì…˜ ë²„íŠ¼ê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
                const mockAction = {
                    id: action,
                    tooltip: `ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´: ${action}`,
                    actionType: action,
                    // textgenerator (1).htmlì˜ êµ¬ì¡°ë¥¼ ì°¸ì¡°í•˜ì—¬,
                    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì•¡ì…˜ì€ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •
                    variables: (action === 'modify') ? [{ id: 'userRequest', label: 'ìˆ˜ì • ìš”êµ¬ì‚¬í•­', type: 'textarea', placeholder: 'ì˜ˆ: 3ë²ˆì§¸ ë¬¸ë‹¨ì˜ ë…¼ë¦¬ë¥¼ ê°•í™”í•˜ê³ , 1ë²ˆ ìë£Œë¥¼ ì¸ìš©í•˜ì„¸ìš”.' }] : [],
                    promptTemplateKey: (action === 'modify') ? 'modificationPrompt' : 'writingPrompt' // ì„ì‹œ ë§¤í•‘
                };
                
                // 'rebuttal', 'summarize'ê°€ ë³„ë„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì„ ì¨ì•¼ í•œë‹¤ë©´
                // this.templates.litigation.actionsì— í•´ë‹¹ ì •ì˜ê°€ í•„ìš”í•¨.
                // í˜„ì¬ëŠ” 'modify'ë§Œ ë³€ìˆ˜ ëª¨ë‹¬ì„ ë„ìš°ê³ , ë‚˜ë¨¸ì§€ëŠ” 'writingPrompt'ë¥¼ ì“´ë‹¤ê³  ê°€ì •.
                
                // 'modify'ì™€ ë™ì¼í•œ ë¡œì§ì„ íƒœìš°ê¸°
                if (action === 'rebuttal' || action === 'summarize' || action === 'modify') {
                     const realAction = this.templates.litigation.actions.find(a => a.id === action);
                     if (realAction) {
                         await this.handleActionButton(realAction);
                     } else {
                         this.ui.showMessage("ì˜¤ë¥˜", `ì•¡ì…˜ '${action}'ì´(ê°€) ì„¤ì •ì—ì„œ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                     }
                }
            }

            async performDeanonymizeEditor() {
                if (!this.currentBook) throw new Error("í˜„ì¬ ì„ íƒëœ ì‚¬ê±´ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                const currentAnonymizedText = this.ui.getEditorText();
                if (!currentAnonymizedText) {
                    this.ui.showMessage("ì•Œë¦¼", "í¸ì§‘ê¸° ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
                    return;
                }
                
                const mapString = this.currentBook.anonymizationMap || "{}";
                const deanonymizedText = this.anonymizer.deanonymize(currentAnonymizedText, mapString);
                
                this.ui.setEditorText(deanonymizedText);
                
                // í•˜ì´ë¼ì´í„° ì—…ë°ì´íŠ¸
                this.updateHighlighter('main'); 
                
                // ë³µì›ëœ ë‚´ìš© ì €ì¥
                await this.saveCurrentSectionContent(true); 
                
                this.ui.showMessage("ë³µì› ì™„ë£Œ", "í¸ì§‘ê¸° ë³¸ë¬¸ì˜ ìµëª…í™”ë¥¼ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.");
            }

            
            
            /**
             * [ìˆ˜ì •] textgenerator (1).htmlì˜ ë¡œì§ì„ í†µí•©í•œ ì•¡ì…˜ í•¸ë“¤ëŸ¬
             */
            async handleActionButton(action) {
                if (!this.currentBook || this.currentSectionId === null) {
                    this.ui.showMessage("ì˜¤ë¥˜", "ë¨¼ì € ëª©ì°¨(TOC) í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
                    return;
                }

                // [ì‹ ê·œ] í´ë¼ì´ì–¸íŠ¸ ì „ìš© ì•¡ì…˜ ë¶„ê¸° ì²˜ë¦¬
                if (action.promptTemplateKey === '__CLIENT_ACTION__') {
                    this.ui.showLoading(true);
                    try {
                        switch (action.id) {
                            case 'deanonymize':
                                await this.performDeanonymizeEditor();
                                break;
                            default:
                                this.ui.showMessage("ì˜¤ë¥˜", "ì•Œ ìˆ˜ ì—†ëŠ” í´ë¼ì´ì–¸íŠ¸ ì•¡ì…˜ì…ë‹ˆë‹¤: " + action.id);
                        }
                    } catch (e) {
                        console.error("Client action failed:", e);
                        this.ui.showMessage("ì‘ì—… ì˜¤ë¥˜", e.message);
                    } finally {
                        this.ui.showLoading(false);
                    }
                    return; // AI ë¡œì§ì„ ì‹¤í–‰í•˜ì§€ ì•Šê³  ì¢…ë£Œ
                }

                // --- ê¸°ì¡´ AI í˜¸ì¶œ ë¡œì§ ---
                this.ui.showLoading(true);
                
                try {
                    let modalVariables = {};
                    
                    // 1. ë³€ìˆ˜ ì…ë ¥ ëª¨ë‹¬ì´ í•„ìš”í•œì§€ í™•ì¸
                    if (action.variables && action.variables.length > 0) {
                        modalVariables = await this.ui.showActionVariableModal(action);
                        if (!modalVariables) { // ì‚¬ìš©ìê°€ ì·¨ì†Œ
                            this.ui.showLoading(false);
                            return;
                        }
                    }

                    // 2. í”„ë¡¬í”„íŠ¸ ìƒì„±ì— í•„ìš”í•œ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
                    const section = this.findTocItem(this.currentBook.toc, this.currentSectionId);
                    if (!section) throw new Error("ì„ íƒëœ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    
                    const context = {
                        book: this.currentBook,
                        section: section,
                        allTocText: this.tocToText(this.currentBook.toc),
                        previousText: this.getPreviousSectionsText(this.currentSectionId),
                        currentText: this.ui.getEditorText(),
                        individualContent: this.currentBook.individualContents[this.currentSectionId] || ""
                    };
                    
                    // 3. í”„ë¡¬í”„íŠ¸ ë¹Œë“œ
                    const rawPrompt = this.promptBuilder.buildActionPrompt(action, context, modalVariables);
                    const anonymizedPrompt = this.anonymizer.anonymize(rawPrompt, this.currentBook.anonymizationMap);
                    
                    // 4. ìˆ˜ë™ ëª¨ë‹¬ í˜¸ì¶œ
                    const anonymizedResult = await this.gemini.call(anonymizedPrompt, `${section.text} - ${action.tooltip}`);
                    
                    if (anonymizedResult) {
                        const resultText = this.anonymizer.deanonymize(anonymizedResult, this.currentBook.anonymizationMap);
                        
                        // 5. ê²°ê³¼ ì ìš©
                        if (action.id === 'write') {
                             this.ui.setEditorText(resultText); // ë®ì–´ì“°ê¸°
                        } else {
                             // ìˆ˜ì •, ìš”ì•½ ë“±ì€ ë§ë¶™ì´ê¸°
                             this.ui.setEditorText(this.ui.getEditorText() + "\n\n--- AI ì‘ë‹µ (" + action.tooltip + ") ---\n" + resultText);
                        }
                    }
                    
                    await this.saveCurrentSectionContent(true); // ìƒˆ ë‚´ìš© ì €ì¥
                    this.updateHighlighter('main');
                    
                } catch (error) {
                    console.error(`${action.tooltip} failed:`, error);
                    this.ui.showMessage("AI ì‘ì—… ì˜¤ë¥˜", error.message);
                } finally {
                    this.ui.showLoading(false);
                }
            }

            // --- [ì‹ ê·œ] TOC ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í•¸ë“¤ëŸ¬ ---
            handleTocContextMenu(e, item) {
                const menuItems = [
                    {
                        label: item.status === 'completed' ? 'ë¯¸ì™„ë£Œë¡œ í‘œì‹œ' : 'ì™„ë£Œë¡œ í‘œì‹œ',
                        icon: item.status === 'completed' ? 'bi-arrow-counterclockwise' : 'bi-check-lg',
                        action: 'toggle-status'
                    }
                ];
                
                this.ui.showContextMenu(e.pageX, e.pageY, menuItems, (action) => {
                    if (action === 'toggle-status') {
                        const newStatus = item.status === 'completed' ? 'default' : 'completed';
                        this.updateTocItemStatus(item.id, newStatus);
                    }
                });
            }

            async updateTocItemStatus(itemId, newStatus) {
                if (!this.currentBook) return;

                const findAndUpdate = (items, id, status) => {
                    for (const item of items) {
                        if (item.id === id) {
                            item.status = status;
                            return true;
                        }
                        if (item.children && findAndUpdate(item.children, id, status)) {
                            return true;
                        }
                    }
                    return false;
                };

                findAndUpdate(this.currentBook.toc, itemId, newStatus);
                await this.db.saveBook(this.currentBook);
                
                // TOC UI ìƒˆë¡œê³ ì¹¨
                this.ui.renderTOC(this.currentBook.toc, this.currentSectionId, 
                    (id) => this.selectSection(id),
                    (e, item) => this.handleTocContextMenu(e, item)
                );
            }

            // --- Utility Methods ---
            findTocItem(items, id) {
                for (const item of items) {
                    if (item.id === id) return item;
                    if (item.children) {
                        const found = this.findTocItem(item.children, id);
                        if (found) return found;
                    }
                }
                return null;
            }

            tocToText(items, level = 0) {
                let text = "";
                items.forEach(item => {
                    text += " ".repeat(level * 2) + item.text + "\n";
                    if (item.children) {
                        text += this.tocToText(item.children, level + 1);
                    }
                });
                return text;
            }

            getPreviousSectionsText(currentSectionId) {
                const texts = [];
                const traverse = (items) => {
                    for (const item of items) {
                        if (item.id === currentSectionId) return true; 
                        if (this.currentBook.contents[item.id]) {
                            texts.push(`[${item.text}]\n${this.currentBook.contents[item.id]}`);
                        }
                        if (item.children) {
                            if (traverse(item.children)) return true;
                        }
                    }
                    return false;
                };
                traverse(this.currentBook.toc);
                return texts.join("\n\n---\n\n");
            }
            
            // --- Highlighter Control ---
            updateHighlighter(id, keyOrValue = 'key') {
                const highlighter = this.highlighters[id];
                if (highlighter) {
                    const text = highlighter.textarea.value;
                    const mapString = this.currentBook?.anonymizationMap || "{}";
                    highlighter.update(text, mapString, keyOrValue);
                }
            }

            updateAllHighlighters() {
                this.updateHighlighter('main');
                this.updateHighlighter('summary');
                this.updateHighlighter('individual');
                this.updateHighlighter('global');
            }

            syncHighlighterScroll(id) {
                const highlighter = this.highlighters[id];
                if (highlighter) {
                    highlighter.syncScroll();
                }
            }
        }

        // --- App Initialization ---
        window.addEventListener("load", () => {
            const app = new App();
            window.appInstance = app; 
            app.init().catch(err => {
                console.error("ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨:", err);
                app.ui.showMessage("ì¹˜ëª…ì  ì˜¤ë¥˜", "ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì´ˆê¸°í™”í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”: " + err.message);
            });
        });

    </script>
</body>
</html>

