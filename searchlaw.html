<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î≤ïÎ†π/ÌñâÏ†ïÍ∑úÏπô ÌÜµÌï© Îã§Ïö¥Î°úÎçî Î∞è Ï°∞Î¨∏ ÌÉêÏÉâÍ∏∞</title>
    <style>
        :root {
            /* Color Palette - Refined Dark Theme */
            --color-background-base: #1A1C20;
            --color-background-elevated-1: #23272C;
            --color-background-elevated-2: #2A2F36;
            --color-background-input: #181A1E;

            --color-border-subtle: #30353C;
            --color-border-interactive: #4A5058;

            --color-text-primary: #E1E6EB;
            --color-text-secondary: #A8B0BC;
            --color-text-placeholder: #707A8A;
            --color-text-disabled: #5F6874;

            --color-accent-primary: #3A86FF;
            --color-accent-primary-hover: #206FEE;
            --color-accent-primary-text: #FFFFFF;
            --color-accent-focus-shadow: rgba(58, 134, 255, 0.25);

            --color-success: #4CAF50;
            --color-error: #F44336;
            --color-warning: #FF9800;

            /* Typography */
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-family-mono: "SF Mono", "Consolas", "Liberation Mono", Menlo, Courier, monospace;

            --font-size-xs: 0.75rem;  /* 12px */
            --font-size-sm: 0.875rem; /* 14px */
            --font-size-md: 1rem;     /* 16px */
            --font-size-lg: 1.125rem; /* 18px */
            --font-size-xl: 1.25rem;  /* 20px */
            --font-size-2xl: 1.5rem;  /* 24px */
            --font-size-3xl: 1.875rem;/* 30px */

            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Spacing & Sizing */
            --spacing-base: 8px;
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 10px;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 3px 5px -1px rgba(0, 0, 0, 0.15), 0 2px 3px -1px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 12px -3px rgba(0, 0, 0, 0.2), 0 3px 5px -2px rgba(0, 0, 0, 0.08);

            /* Transitions */
            --transition-fast: all 0.15s ease-out;
            --transition-normal: all 0.25s ease-out;
        }

        /* Global Resets & Base Styles */
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family-sans);
            font-size: var(--font-size-md);
            line-height: var(--line-height-relaxed);
            background-color: var(--color-background-base);
            color: var(--color-text-primary);
            margin: 0;
            padding: calc(var(--spacing-base) * 3);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Application Container */
        .app-container {
            width: 100%;
            max-width: 860px;
            background-color: var(--color-background-elevated-1);
            border-radius: var(--radius-lg);
            padding: calc(var(--spacing-base) * 3.5);
            box-shadow: var(--shadow-lg);
        }

        .app-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            text-align: center;
            margin-bottom: calc(var(--spacing-base) * 4);
        }

        /* Sections */
        .section {
            background-color: var(--color-background-elevated-2);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2.5);
            margin-bottom: calc(var(--spacing-base) * 3.5);
            box-shadow: var(--shadow-md);
        }
        .section:last-of-type { margin-bottom: 0; }

        .section-title-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: calc(var(--spacing-base) * 1.5);
            margin-bottom: calc(var(--spacing-base) * 2.5);
            border-bottom: 1px solid var(--color-border-subtle);
        }
        .section-title-actions {
            display: flex;
            gap: calc(var(--spacing-base) * 1);
        }
        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.75);
        }
        .section-title-icon {
            width: var(--font-size-lg);
            height: var(--font-size-lg);
            color: var(--color-text-secondary);
        }

        /* Form Elements */
        .api-key-area { margin-bottom: calc(var(--spacing-base) * 2.5); }
        .api-key-area label, .explorer-input-group label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            margin-bottom: calc(var(--spacing-base) * 0.75);
        }
        .search-input, .api-key-input, .explorer-input, .range-input {
            width: 100%;
            padding: calc(var(--spacing-base) * 1.25) calc(var(--spacing-base) * 1.5);
            background-color: var(--color-background-input);
            border: 1px solid var(--color-border-interactive);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: var(--font-size-md);
            transition: var(--transition-normal);
        }
        .search-input::placeholder, .api-key-input::placeholder, .explorer-input::placeholder, .range-input::placeholder { color: var(--color-text-placeholder); }
        .search-input:focus, .api-key-input:focus, .explorer-input:focus, .range-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 2.5px var(--color-accent-focus-shadow);
        }
        .search-area { display: flex; gap: var(--spacing-base); align-items: stretch; }
        .search-input-wrapper { flex-grow: 1; position: relative; }
        .clear-search-btn {
            position: absolute; right: var(--spacing-base); top: 50%; transform: translateY(-50%);
            background: transparent; border: none; color: var(--color-text-secondary);
            font-size: var(--font-size-xl); line-height: 1; cursor: pointer; padding: var(--spacing-base);
            display: none; transition: var(--transition-fast);
        }
        .clear-search-btn:hover { color: var(--color-text-primary); }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-sm); border: 1px solid transparent;
            cursor: pointer; text-decoration: none; white-space: nowrap;
            transition: var(--transition-normal);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none !important; }

        .btn-primary {
            background-color: var(--color-accent-primary); color: var(--color-accent-primary-text);
            border-color: var(--color-accent-primary);
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-accent-primary-hover); border-color: var(--color-accent-primary-hover); box-shadow: var(--shadow-sm); }

        .btn-secondary {
            background-color: var(--color-background-elevated-1); color: var(--color-text-secondary);
            border-color: var(--color-border-interactive);
        }
        .btn-secondary:hover:not(:disabled) { background-color: var(--color-background-elevated-2); border-color: var(--color-text-primary); color: var(--color-text-primary); }

        .icon-btn {
            background: transparent; color: var(--color-text-secondary);
            padding: calc(var(--spacing-base) * 0.5);
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            border: none; cursor: pointer;
        }
        .icon-btn svg { width: calc(var(--font-size-md) * 1.1); height: calc(var(--font-size-md) * 1.1); fill: currentColor; }
        .icon-btn:hover:not(:disabled) { background-color: var(--color-background-elevated-2); color: var(--color-accent-primary); }

        /* */
        /* Search Results List */
        #results-list {
            list-style: none; padding: 0;
            display: flex; flex-direction: column; gap: calc(var(--spacing-base) * 0.75);
            max-height: 420px; overflow-y: auto; margin-top: var(--spacing-base);
        }
        #results-list li {
            background-color: var(--color-background-elevated-1);
            border-radius: var(--radius-sm);
            padding: calc(var(--spacing-base) * 1.25) calc(var(--spacing-base) * 1.5);
            display: grid;
            grid-template-columns: auto 1fr auto; /* Checkbox | Main | Actions */
            grid-template-areas: "checkbox main actions";
            align-items: center; /* Vertically center */
            gap: 0 calc(var(--spacing-base) * 1.5); /* No row gap, col gap */
            border: 1px solid var(--color-border-subtle);
            transition: var(--transition-fast);
            box-shadow: var(--shadow-sm);
            cursor: pointer; /* Req 2: Make clickable area obvious */
        }
        #results-list li:hover { border-color: var(--color-border-interactive); background-color: var(--color-background-elevated-2); transform: translateY(-1px); }

        .result-item-checkbox-wrapper { 
            grid-area: checkbox; 
            /* padding-top: calc(var(--spacing-base) * 0.25); REMOVED for centering */
        }
        #results-list input[type="checkbox"] {
            accent-color: var(--color-accent-primary);
            width: var(--font-size-lg); height: var(--font-size-lg);
            cursor: pointer; margin-top: 1px;
        }

        .result-item-main {
            grid-area: main;
            display: flex; flex-direction: column;
            gap: calc(var(--spacing-base) * 0.25);
        }
        .item-name {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            line-height: var(--line-height-normal);
            word-break: break-word;
        }
        .item-meta {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* */
        .result-item-actions {
            grid-area: actions;
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.5); /* Reduced gap */
            margin-top: 0; /* REMOVED margin-top */
            padding-left: calc(var(--spacing-base) * 1);
            cursor: default; /* Override li cursor */
        }
        /* üèõÔ∏è Req 2: Ensure buttons inside actions are still clickable */
        .result-item-actions .btn, .result-item-actions .icon-btn {
            cursor: pointer;
        }

        .btn-explore {
            font-size: var(--font-size-xs);
            padding: calc(var(--spacing-base)*0.5) calc(var(--spacing-base)*1);
            background-color: transparent;
            color: var(--color-accent-primary);
            border: 1px solid var(--color-accent-primary);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
        }
        .btn-explore:hover:not(:disabled) { background-color: rgba(58, 134, 255, 0.1); }

        /* Status Message */
        .status-message {
            padding: calc(var(--spacing-base) * 1.25) calc(var(--spacing-base) * 1.5);
            margin-top: calc(var(--spacing-base) * 2.5);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            background-color: var(--color-background-elevated-2);
            border-radius: var(--radius-sm);
            text-align: center;
            border: 1px solid var(--color-border-subtle);
        }
        .status-message.error-message { color: var(--color-error); border-color: var(--color-error); background-color: rgba(244, 67, 54, 0.05); }
        .status-message.success-message { color: var(--color-success); border-color: var(--color-success); background-color: rgba(76, 175, 80, 0.05); }

        .download-area {
            margin-top: calc(var(--spacing-base) * 3);
            padding-top: calc(var(--spacing-base) * 2.5);
            border-top: 1px solid var(--color-border-subtle);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* JSON Modal */
        .modal {
            display: none; position: fixed; z-index: 1000;
            inset: 0; overflow: auto;
            background-color: rgba(12, 14, 17, 0.8);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: var(--color-background-elevated-2);
            margin: 5vh auto; padding: calc(var(--spacing-base) * 3.5);
            border: 1px solid var(--color-border-subtle); border-radius: var(--radius-lg);
            width: clamp(300px, 90%, 900px);
            max-height: 90vh; overflow-y: auto;
            color: var(--color-text-primary); position: relative; box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: calc(var(--spacing-base) * 1.5); margin-bottom: calc(var(--spacing-base) * 2.5);
            border-bottom: 1px solid var(--color-border-subtle);
        }
        .modal-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); }
        .close-modal-btn {
            background: transparent; border: none; color: var(--color-text-secondary);
            font-size: var(--font-size-2xl); line-height: 1; cursor: pointer;
            padding: var(--spacing-base); border-radius: 50%;
        }
        .close-modal-btn:hover { background-color: var(--color-background-elevated-1); color: var(--color-text-primary); }
        #jsonDisplayArea {
            background-color: var(--color-background-input);
            border: 1px solid var(--color-border-subtle); border-radius: var(--radius-sm);
            padding: calc(var(--spacing-base) * 2); max-height: 70vh; overflow-y: auto;
            white-space: pre; font-family: var(--font-family-mono);
            font-size: var(--font-size-sm); line-height: var(--line-height-normal);
            color: var(--color-text-secondary);
        }

        /* Law Explorer Modal */
        #lawExplorerModal {
            display: none; position: fixed; z-index: 1001;
            inset: 0; overflow: auto;
            background-color: rgba(12, 14, 17, 0.8);
            backdrop-filter: blur(4px);
        }
        #lawExplorerModal .modal-content {
            width: clamp(500px, 90%, 1000px);
            max-height: 90vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        #lawExplorerModal .modal-header {
            flex: none;
        }
        .tab-list {
            list-style: none; margin: 0; padding: 0;
            display: flex; border-bottom: 1px solid var(--color-border-subtle);
            overflow-x: auto; flex: none;
        }
        .tab-list li {
            flex: none; padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            text-align: center; cursor: pointer;
            border-top-left-radius: var(--radius-md);
            border-top-right-radius: var(--radius-md);
            background-color: var(--color-background-elevated-1);
            margin-right: var(--spacing-base);
            line-height: var(--line-height-normal);
            max-width: 140px;
            white-space: normal;
            transition: var(--transition-fast);
        }
        .tab-list li.active {
            background-color: var(--color-background-base);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-interactive);
            border-bottom: none;
            box-shadow: var(--shadow-sm);
        }
        .tab-contents {
            background-color: var(--color-background-elevated-2);
            flex: 1 1 auto;
            overflow-y: auto;
            display: flex; flex-direction: column;
            padding: calc(var(--spacing-base) * 2);
        }
        .tab-content {
            display: none; flex: 1 1 auto; flex-direction: column;
        }
        .tab-content.active {
            display: flex;
        }
        .range-input-container {
            display: flex; gap: var(--spacing-base); margin-bottom: calc(var(--spacing-base) * 1.5);
            align-items: center; flex-wrap: wrap;
        }
        .range-input-container label {
            font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);
            white-space: nowrap;
        }
        .copy-btn {
            background-color: var(--color-background-elevated-1);
            border: 1px solid var(--color-border-interactive);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            padding: calc(var(--spacing-base) * 0.75) calc(var(--spacing-base) * 1.5);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .copy-btn:hover:not(:disabled) {
            background-color: var(--color-background-elevated-2);
            color: var(--color-accent-primary);
        }
        .provision-block {
            margin-bottom: calc(var(--spacing-base) * 2);
        }
        .provision-title {
            font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); color: var(--color-text-primary);
            margin-bottom: var(--spacing-base);
        }
        .provision-content {
            font-size: var(--font-size-sm); line-height: var(--line-height-relaxed); color: var(--color-text-secondary);
            white-space: pre-wrap; margin-bottom: var(--spacing-base);
        }
        .provision-sub-item, .provision-sub-sub-item {
            margin-left: calc(var(--spacing-base) * 2);
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-background-input); border-radius: var(--radius-md); }
        ::-webkit-scrollbar-thumb { background: var(--color-border-interactive); border-radius: var(--radius-md); border: 2px solid var(--color-background-input); }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-text-secondary); }
        html { scrollbar-width: thin; scrollbar-color: var(--color-border-interactive) var(--color-background-input); }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="app-title">Î≤ïÎ†π/ÌñâÏ†ïÍ∑úÏπô ÌÜµÌï© Îã§Ïö¥Î°úÎçî Î∞è Ï°∞Î¨∏ ÌÉêÏÉâÍ∏∞</h1>

        <div class="section">
            <div class="section-title-area">
                <h2 class="section-title">
                    <svg class="section-title-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3zm0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/>
                    </svg>
                    Í≤ÄÏÉâ Ï°∞Í±¥
                </h2>
            </div>
            <div class="api-key-area">
                <label for="apiKey">API ÌÇ§ (Íµ≠Í∞ÄÎ≤ïÎ†πÏ†ïÎ≥¥ÏÑºÌÑ∞ Open API)</label>
                <input type="text" id="apiKey" class="api-key-input" value="" placeholder="API ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
            </div>
            <div class="search-area">
                <div class="search-input-wrapper">
                    <input type="text" id="searchQuery" class="search-input" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†• (ÏΩ§Îßà(,)Î°ú Ïó¨Îü¨ Í≤ÄÏÉâÏñ¥ ÏûÖÎ†• Í∞ÄÎä•)">
                    <button type="button" class="clear-search-btn" id="clearSearchQueryButton" title="Í≤ÄÏÉâÏñ¥ ÏßÄÏö∞Í∏∞">&times;</button>
                </div>
                <button id="searchButton" class="btn btn-primary">Í≤ÄÏÉâ</button>
            </div>
        </div>

        <div class="section">
            <div class="section-title-area">
                <h2 class="section-title">
                    <svg class="section-title-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                    Í≤ÄÏÉâ Í≤∞Í≥º (<span id="selectedCount">0</span>Í∞ú ÏÑ†ÌÉùÎê®)
                </h2>
                <div class="section-title-actions">
                    <button id="selectAllButton" class="btn btn-secondary">Î™®Îëê ÏÑ†ÌÉù</button>
                    <button id="clearSelectionButton" class="btn btn-secondary">ÏÑ†ÌÉù Ìï¥Ï†ú</button>
                </div>
            </div>
            <ul id="results-list"></ul>
            <div id="statusMessage" class="status-message" role="status">
                Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÍ≥† Í≤ÄÏÉâ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî.
            </div>
            <div class="download-area">
                <button id="downloadButton" class="btn btn-primary">ÏÑ†ÌÉù Ìï≠Î™© ZIP Îã§Ïö¥Î°úÎìú</button>
                <div id="actualDownloadContainer"></div>
            </div>
        </div>
    </div>

    <div id="lawExplorerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Î≤ïÎ†π Ï°∞Î¨∏ ÌÉêÏÉâÍ∏∞</span>
                <button type="button" id="closeLawExplorerModal" class="close-modal-btn" title="Îã´Í∏∞">&times;</button>
            </div>
            <ul class="tab-list" id="lawTabList"></ul>
            <div class="tab-contents" id="lawTabContents"></div>
        </div>
    </div>

    <div id="jsonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="jsonModalTitle" class="modal-title">JSON Îç∞Ïù¥ÌÑ∞</span>
                <button type="button" id="closeJsonModalBtn" class="close-modal-btn" title="Îã´Í∏∞">&times;</button>
            </div>
            <pre id="jsonDisplayArea"></pre>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // ÏÉÅÎã® Î≥ÄÏàò Î∞è Ìï®Ïàò Ïú†ÏßÄ (Í≤ÄÏÉâ, Îã§Ïö¥Î°úÎìú Î∂ÄÎ∂Ñ)
        const apiKeyInput = document.getElementById('apiKey');
        const searchQueryInput = document.getElementById('searchQuery');
        const searchButton = document.getElementById('searchButton');
        const clearSearchQueryButton = document.getElementById('clearSearchQueryButton');
        const resultsList = document.getElementById('results-list');
        const statusMessage = document.getElementById('statusMessage');
        const downloadButton = document.getElementById('downloadButton');
        const selectAllButton = document.getElementById('selectAllButton');
        const clearSelectionButton = document.getElementById('clearSelectionButton');
        const selectedCountSpan = document.getElementById('selectedCount');
        const actualDownloadContainer = document.getElementById('actualDownloadContainer');
        const API_KEY_STORAGE_KEY = 'lawDownloaderApiKey_v2';

        let currentResults = [];

        function _ensureListJs(data) {
            if (data === null || typeof data === 'undefined') return [];
            return Array.isArray(data) ? data : [data];
        }

        function stripHtml(html) {
            if (!html) return "";
            const tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            let text = tmp.textContent || tmp.innerText || "";
            text = text.replace(/&nbsp;/g, ' ').replace(/&lt;/g, '<')
                       .replace(/&gt;/g, '>').replace(/&amp;/g, '&');
            text = text.replace(/[ \t]{2,}/g, ' ');
            text = text.replace(/\n{3,}/g, '\n\n');
            return text.trim();
        }

        function flattenContentForDisplay(dataItem, cleanHtml = true) {
            let lines = [];
            function recurse(item) {
                if (typeof item === 'string') {
                    const cleaned = cleanHtml ? stripHtml(item) : item;
                    if (cleaned.trim()) lines.push(cleaned.trim());
                } else if (Array.isArray(item)) {
                    item.forEach(recurse);
                } else if (typeof item === 'object' && item !== null) {
                    Object.values(item).forEach(recurse);
                } else if (item !== null && typeof item !== 'undefined') {
                    const cleaned = cleanHtml ? stripHtml(String(item)) : String(item);
                    if (cleaned.trim()) lines.push(cleaned.trim());
                }
            }
            recurse(dataItem);
            return lines.join('\n');
        }

        function setStatus(message, type = 'info', targetElement = statusMessage) {
            targetElement.textContent = message;
            targetElement.className = 'status-message';
            if (type === 'error') {
                targetElement.classList.add('error-message');
            } else if (type === 'success') {
                targetElement.classList.add('success-message');
            }
        }

        function toggleInputsDisabled(disabled) {
            apiKeyInput.disabled = disabled;
            searchQueryInput.disabled = disabled;
            searchButton.disabled = disabled;
        }

        function toggleDownloadControlsDisabled(disabled) {
            downloadButton.disabled = disabled;
            clearSelectionButton.disabled = disabled;
            if (selectAllButton) { // üèõÔ∏è Ïã†Í∑ú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Ï∂îÍ∞Ä
                selectAllButton.disabled = disabled;
            }
            resultsList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = disabled);
        }

        async function makeApiRequest(endpoint, params, itemNameForLog = null, itemTypeForLog = null, retries = 2, timeout = 20000, attemptDelay = 1500) {
            const currentApiKeyVal = apiKeyInput.value.trim();
            if (!currentApiKeyVal) {
                const apiKeyError = new Error("API ÌÇ§Í∞Ä ÏûÖÎ†•ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. API ÌÇ§Î•º ÏûÖÎ†• ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
                apiKeyError.isAuthError = true;
                throw apiKeyError;
            }

            const clonedParams = { ...params };
            clonedParams["OC"] = currentApiKeyVal;
            clonedParams["type"] = "JSON";
            const queryParams = new URLSearchParams(clonedParams);
            const url = `https://www.law.go.kr/DRF/${endpoint}?${queryParams.toString()}`;
            let lastError = null;
            const logPrefix = itemNameForLog ? `'${itemNameForLog}' (${itemTypeForLog || 'Ìï≠Î™©'})` : `[${endpoint}]`;

            for (let attempt = 0; attempt <= retries; attempt++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                try {
                    if (attempt > 0) {
                        const delay = attemptDelay * attempt;
                        setStatus(`${logPrefix} ÏöîÏ≤≠ Ïû¨ÏãúÎèÑ (${attempt}/${retries})...`, 'info', statusMessage);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        let errorData;
                        try { errorData = await response.json(); } catch (e) {}
                        let errorMsg = `${logPrefix} API ÏöîÏ≤≠ Ïã§Ìå® (${response.status} ${response.statusText})`;
                        if (errorData?.Error?.message) errorMsg += `: ${errorData.Error.message}`;

                        if (response.status === 401 || response.status === 403) {
                            errorMsg += ` - API ÌÇ§Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÍ±∞ÎÇò Í∂åÌïúÏù¥ ÏóÜÏùÑ Ïàò ÏûàÏäµÎãàÎã§. ÌôïÏù∏ ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`;
                            const authError = new Error(errorMsg);
                            authError.isAuthError = true;
                            throw authError;
                        }
                        lastError = new Error(errorMsg);
                        if (attempt >= retries) throw lastError;
                        continue;
                    }
                    const data = await response.json();
                    if (data.Error) {
                        const apiError = new Error(`${logPrefix} API ÏÑúÎ≤Ñ Ïò§Î•ò: ${data.Error.message} (ÏΩîÎìú: ${data.Error.errorCode})`);
                        apiError.isApiError = true;
                        lastError = apiError;
                        if (attempt >= retries) throw lastError;
                        continue;
                    }

                    const mainDataKey = endpoint === "lawSearch.do" ? (clonedParams.target === "law" ? "LawSearch" : "AdmRulSearch")
                                        : (clonedParams.target === "law" ? "Î≤ïÎ†π" : "AdmRulService");

                    if (!data[mainDataKey] && (Object.keys(data).length <= 2 && (data.hasOwnProperty(mainDataKey.toUpperCase()) || data.hasOwnProperty("TYPE")))) {
                         return { _isEmptyResult: true, ...data };
                    }
                    return data;

                } catch (error) {
                    clearTimeout(timeoutId);
                    lastError = error;
                    if (error.isAuthError) throw error;
                    if (error.name === 'AbortError') {
                        lastError = new Error(`${logPrefix} ÏöîÏ≤≠ ÏãúÍ∞Ñ Ï¥àÍ≥º (${timeout/1000}Ï¥à)`);
                        lastError.isTimeout = true;
                    } else if (!(error instanceof Error)) {
                        lastError = new Error(`${logPrefix} ÎÑ§Ìä∏ÏõåÌÅ¨ ÎòêÎäî Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò: ${String(error)}`);
                    }
                    if (attempt >= retries) {
                        const finalErrorMsg = `${logPrefix} ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå® (Î™®Îì† Ïû¨ÏãúÎèÑ ÌõÑ): ${lastError.message}`;
                        const finalError = new Error(finalErrorMsg);
                        finalError.originalErrorName = lastError.name;
                        finalError.isTimeout = !!lastError.isTimeout;
                        finalError.isAuthError = !!lastError.isAuthError;
                        finalError.isApiError = !!lastError.isApiError;
                        throw finalError;
                    }
                }
            }
            const ultimateFallbackError = new Error(`${logPrefix} ÏöîÏ≤≠Ïù¥ Î™®Îì† Ïû¨ÏãúÎèÑ ÌõÑÏóêÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§.`);
            ultimateFallbackError.originalError = lastError;
            throw ultimateFallbackError;
        }

        // Í≤ÄÏÉâ Ï≤òÎ¶¨ (Î°úÏßÅ Ïú†ÏßÄ)
        searchButton.addEventListener('click', async () => {
            const rawQueryInput = searchQueryInput.value.trim();
            if (!rawQueryInput) {
                setStatus("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", 'error'); searchQueryInput.focus(); return;
            }
            const currentApiKey = apiKeyInput.value.trim();
            if (!currentApiKey) {
                setStatus("API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", 'error'); apiKeyInput.focus(); return;
            }
            const queries = rawQueryInput.split(',').map(q => q.trim()).filter(q => q.length > 0);
            if (queries.length === 0) {
                setStatus("Ïú†Ìö®Ìïú Í≤ÄÏÉâÏñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.", 'error'); searchQueryInput.focus(); return;
            }

            setStatus(`Ï¥ù ${queries.length}Í∞úÏùò Í≤ÄÏÉâÏñ¥ Ï≤òÎ¶¨ ÏãúÏûë...`, 'info');
            resultsList.innerHTML = ''; currentResults = []; updateSelectedCount();
            toggleInputsDisabled(true); toggleDownloadControlsDisabled(true);

            let allCombinedResultsAccumulator = [];
            let queryErrorMessages = [];
            let successfullyProcessedQueries = 0;

            try {
                for (let i = 0; i < queries.length; i++) {
                    const query = queries[i];
                    setStatus(`"${query}" Í≤ÄÏÉâ Ï§ë (${i + 1}/${queries.length})...`, 'info');

                    const lawParams = {"target": "law", "query": query, "display": 20, "searchTp": "1"};
                    const admrulParams = {"target": "admrul", "query": query, "display": 20};
                    let lawErrorForThisQuery = null;
                    let admrulErrorForThisQuery = null;

                    const [lawData, admrulData] = await Promise.all([
                        makeApiRequest("lawSearch.do", lawParams, `Î≤ïÎ†π "${query}"`, "Í≤ÄÏÉâ").catch(e => {
                            lawErrorForThisQuery = e.message;
                            if (e.isAuthError) throw e;
                            return null;
                        }),
                        makeApiRequest("lawSearch.do", admrulParams, `ÌñâÏ†ïÍ∑úÏπô "${query}"`, "Í≤ÄÏÉâ").catch(e => {
                            admrulErrorForThisQuery = e.message;
                            if (e.isAuthError) throw e;
                            return null;
                        })
                    ]);

                    let resultsForThisQuery = [];
                    if (lawData?._isEmptyResult) { }
                    else if (lawData?.LawSearch?.law) {
                        _ensureListJs(lawData.LawSearch.law).forEach(item => resultsForThisQuery.push({
                            id: item.Î≤ïÎ†πÏùºÎ†®Î≤àÌò∏, name: stripHtml(item.Î≤ïÎ†πÎ™ÖÌïúÍ∏Ä), date: item.ÏãúÌñâÏùºÏûê,
                            type: 'law', typeDisplay: 'Î≤ïÎ†π'
                        }));
                    } else if (!lawErrorForThisQuery) {
                        lawErrorForThisQuery = `Î≤ïÎ†π Í≤ÄÏÉâ ("${query}"): Ïïå Ïàò ÏóÜÎäî ÏùëÎãµ ÎòêÎäî Í≤∞Í≥º ÏóÜÏùå.`;
                    }

                    if (admrulData?._isEmptyResult) { }
                    else if (admrulData?.AdmRulSearch?.admrul) {
                        _ensureListJs(admrulData.AdmRulSearch.admrul).forEach(item => resultsForThisQuery.push({
                            id: item.ÌñâÏ†ïÍ∑úÏπôÏùºÎ†®Î≤àÌò∏, name: stripHtml(item.ÌñâÏ†ïÍ∑úÏπôÎ™Ö), date: item.Î∞úÎ†πÏùºÏûê,
                            type: 'admrul', typeDisplay: 'ÌñâÏ†ïÍ∑úÏπô'
                        }));
                    } else if (!admrulErrorForThisQuery) {
                        admrulErrorForThisQuery = `ÌñâÏ†ïÍ∑úÏπô Í≤ÄÏÉâ ("${query}"): Ïïå Ïàò ÏóÜÎäî ÏùëÎãµ ÎòêÎäî Í≤∞Í≥º ÏóÜÏùå.`;
                    }

                    if (lawErrorForThisQuery) queryErrorMessages.push(lawErrorForThisQuery);
                    if (admrulErrorForThisQuery) queryErrorMessages.push(admrulErrorForThisQuery);
                    if (resultsForThisQuery.length > 0) allCombinedResultsAccumulator.push(...resultsForThisQuery);
                    if (!lawErrorForThisQuery && !admrulErrorForThisQuery) successfullyProcessedQueries++;
                }

                const uniqueResults = []; const seenItems = new Set();
                for (const item of allCombinedResultsAccumulator) {
                    const uniqueKey = `${item.type}_${item.id}`;
                    if (!seenItems.has(uniqueKey)) { uniqueResults.push(item); seenItems.add(uniqueKey); }
                }
                currentResults = uniqueResults; renderResults(currentResults);

                let finalStatusMsg = ""; let finalStatusType = 'info';
                if (currentResults.length > 0) {
                    finalStatusMsg = `Ï¥ù ${queries.length}Í∞ú Í≤ÄÏÉâÏñ¥ Ï§ë ${successfullyProcessedQueries}Í∞ú Ï≤òÎ¶¨ ÏôÑÎ£å. ${currentResults.length}Í∞úÏùò Í≥†Ïú† Í≤∞Í≥ºÎ•º Ï∞æÏïòÏäµÎãàÎã§.`;
                    finalStatusType = 'success'; toggleDownloadControlsDisabled(false);
                } else if (successfullyProcessedQueries === queries.length && queryErrorMessages.length === 0) {
                    finalStatusMsg = `Ï¥ù ${queries.length}Í∞ú Í≤ÄÏÉâÏñ¥Ïóê ÎåÄÌï¥ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.`;
                } else {
                    finalStatusMsg = `Í≤ÄÏÉâ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.`;
                    finalStatusType = 'error';
                }
                if (queryErrorMessages.length > 0) {
                    const errorSummary = queryErrorMessages.join("\n");
                    finalStatusMsg += `\n\n[Î∞úÏÉùÌïú Ïò§Î•ò ÏöîÏïΩ]\n${errorSummary}`;
                    finalStatusType = 'error';
                }
                setStatus(finalStatusMsg.trim() || "Í≤ÄÏÉâ ÏôÑÎ£å.", finalStatusType);

            } catch (error) {
                console.error("Ï†ÑÏ≤¥ Í≤ÄÏÉâ Ï≤òÎ¶¨ Ï§ë ÏπòÎ™ÖÏ†Å Ïò§Î•ò:", error);
                let displayErrorMessage = `Í≤ÄÏÉâ Ï§ë ÏπòÎ™ÖÏ†Å Ïò§Î•ò Î∞úÏÉù: ${error.message}`;
                if (error.isAuthError) {
                    displayErrorMessage = `API Ïù∏Ï¶ù Ïò§Î•ò: ${error.message}. API ÌÇ§Î•º ÌôïÏù∏ ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`;
                    apiKeyInput.focus();
                }
                setStatus(displayErrorMessage, 'error');
                currentResults = []; renderResults(currentResults);
            } finally {
                toggleInputsDisabled(false);
            }
        });

        // Í≤ÄÏÉâÏñ¥ ÏßÄÏö∞Í∏∞ Î≤ÑÌäº
        clearSearchQueryButton.addEventListener('click', () => {
            searchQueryInput.value = '';
            clearSearchQueryButton.style.display = 'none';
            searchQueryInput.focus();
        });
        searchQueryInput.addEventListener('input', () => {
            clearSearchQueryButton.style.display = searchQueryInput.value ? 'block' : 'none';
        });

        function updateSelectedCount() {
            // üèõÔ∏è Ï†ÑÏ≤¥ Ìï≠Î™©Í≥º ÏÑ†ÌÉùÎêú Ìï≠Î™© ÏàòÎ•º Ï†ïÌôïÌûà Í≥ÑÏÇ∞
            const allCheckboxes = resultsList.querySelectorAll('input[type="checkbox"]:not(:disabled)');
            const checkedCheckboxes = resultsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)');
            
            const count = checkedCheckboxes.length;
            const total = allCheckboxes.length;

            selectedCountSpan.textContent = count;
            
            const hasResults = total > 0;
            const allSelected = hasResults && count === total;

            // üèõÔ∏è Î™®Îì† Î≤ÑÌäºÏùò ÏÉÅÌÉúÎ•º ÏÉà Î°úÏßÅÏóê Îî∞Îùº ÏóÖÎç∞Ïù¥Ìä∏
            downloadButton.disabled = !(hasResults && count > 0);
            clearSelectionButton.disabled = !(hasResults && count > 0);
            
            if (selectAllButton) { // Ensure it exists
                selectAllButton.disabled = !hasResults || allSelected;
            }
        }
        resultsList.addEventListener('change', updateSelectedCount);

        function renderResults(results) {
            resultsList.innerHTML = '';
            if (!results || results.length === 0) { updateSelectedCount(); return; }
            results.forEach((item, index) => {
                const li = document.createElement('li');
                li.setAttribute('role', 'listitem');

                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'result-item-checkbox-wrapper';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `item-${index}`;
                checkbox.dataset.docId = item.id;
                checkbox.dataset.docType = item.type;
                checkbox.dataset.docName = item.name;
                checkbox.dataset.docTypeDisplay = item.typeDisplay; // üèõÔ∏è ZIP Í∏∞Îä• ÏúÑÌï¥ typeDisplay Ï∂îÍ∞Ä
                checkbox.setAttribute('aria-labelledby', `item-name-${index}`);
                checkboxWrapper.appendChild(checkbox);

                const mainContentDiv = document.createElement('div');
                mainContentDiv.className = 'result-item-main';

                const nameLabel = document.createElement('label');
                nameLabel.htmlFor = `item-${index}`;
                nameLabel.id = `item-name-${index}`;
                nameLabel.className = 'item-name';
                nameLabel.textContent = item.name;
                mainContentDiv.appendChild(nameLabel);

                const metaSpan = document.createElement('span');
                metaSpan.className = 'item-meta';
                metaSpan.textContent = `${item.typeDisplay} | ${item.type === 'law' ? 'ÏãúÌñâÏùº' : 'Î∞úÎ†πÏùº'}: ${item.date || 'Ï†ïÎ≥¥ÏóÜÏùå'}`;
                mainContentDiv.appendChild(metaSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'result-item-actions';

                const exploreButton = document.createElement('button');
                exploreButton.textContent = 'Ï°∞Î¨∏ ÌÉêÏÉâ';
                exploreButton.className = 'btn btn-explore';
                exploreButton.type = 'button';
                exploreButton.title = `${item.name} Ï°∞Î¨∏ ÌÉêÏÉâÌïòÍ∏∞`;
                exploreButton.setAttribute('aria-label', `${item.name} Ï°∞Î¨∏ ÌÉêÏÉâ`);
                exploreButton.addEventListener('click', (e) => {
                    e.stopPropagation(); openLawExplorer(item);
                });
                actionsDiv.appendChild(exploreButton);

                const jsonButton = document.createElement('button');
                jsonButton.type = 'button';
                jsonButton.className = 'icon-btn';
                jsonButton.title = `${item.name} JSON Îç∞Ïù¥ÌÑ∞ Î≥¥Í∏∞`;
                jsonButton.setAttribute('aria-label', `${item.name} JSON Îç∞Ïù¥ÌÑ∞ Î≥¥Í∏∞`);
                jsonButton.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.62001 3.95995C9.22001 3.55995 8.62001 3.55995 8.22001 3.95995L3.51001 8.67995C2.82001 9.35995 2.82001 10.53 3.51001 11.21L8.18001 15.89C8.58001 16.29 9.18001 16.29 9.58001 15.89L10.01 15.46C10.35 15.12 10.31 14.56 9.93001 14.26L6.21001 11.12C6.08001 11.01 6.08001 10.82 6.21001 10.71L9.89001 7.59995C10.28 7.29995 10.32 6.73995 9.97001 6.40995L9.62001 3.95995Z" fill="currentColor"/>
                    <path d="M14.38 3.95995C14.78 3.55995 15.38 3.55995 15.78 3.95995L20.49 8.67995C21.18 9.35995 21.18 10.53 20.49 11.21L15.82 15.89C15.42 16.29 14.82 16.29 14.42 15.89L13.99 15.46C13.65 15.12 13.69 14.56 14.07 14.26L17.79 11.12C17.92 11.01 17.92 10.82 17.79 10.71L14.11 7.59995C13.72 7.29995 13.68 6.73995 14.03 6.40995L14.38 3.95995Z" fill="currentColor"/>
                </svg>`;
                jsonButton.addEventListener('click', (e) => {
                    e.stopPropagation(); showLawJsonModal(item);
                });
                actionsDiv.appendChild(jsonButton);

                const linkButton = document.createElement('button');
                linkButton.type = 'button';
                linkButton.className = 'icon-btn';
                linkButton.title = `${item.name} Íµ≠Í∞ÄÎ≤ïÎ†πÏ†ïÎ≥¥ÏÑºÌÑ∞ÏóêÏÑú Î≥¥Í∏∞`;
                linkButton.setAttribute('aria-label', `${item.name} Íµ≠Í∞ÄÎ≤ïÎ†πÏ†ïÎ≥¥ÏÑºÌÑ∞ÏóêÏÑú Î≥¥Í∏∞`);
                linkButton.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.54 10.4601L21.0001 2.99996M21.0001 2.99996H16.54M21.0001 2.99996V7.46005M11.2501 2.99996H6.90008C5.01008 2.99996 3.45008 4.55996 3.45008 6.44996V17.55C3.45008 19.44 5.01008 21 6.90008 21H18.0001C19.8901 21 21.4501 19.44 21.4501 17.55V12.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`;
                linkButton.addEventListener('click', (e) => {
                    e.stopPropagation(); openLawPageLink(item);
                });
                actionsDiv.appendChild(linkButton);

                li.appendChild(checkboxWrapper);
                li.appendChild(mainContentDiv);
                li.appendChild(actionsDiv); // Actions moved to be a direct child

                // üèõÔ∏è Req 2: ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î°úÏßÅ (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ, CSS Í∞úÏÑ†ÏúºÎ°ú Î≥¥ÏôÑÎê®)
                li.addEventListener('click', (e) => {
                    // Check if the click target is NOT the checkbox AND not inside the actions div
                    if (e.target !== checkbox && !actionsDiv.contains(e.target) && !checkbox.disabled) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
                resultsList.appendChild(li);
            });
            updateSelectedCount();
        }

        clearSelectionButton.addEventListener('click', () => {
            if (clearSelectionButton.disabled) return;
            resultsList.querySelectorAll('input[type="checkbox"]:not(:disabled)').forEach(cb => {
                cb.checked = false;
                // cb.dispatchEvent(new Event('change', { bubbles: true })); // üèõÔ∏è ÎπÑÌö®Ïú®Ï†ÅÏù¥ÎØÄÎ°ú Ï†úÍ±∞
            });
            updateSelectedCount(); // üèõÔ∏è Ïó¨Í∏∞ÏóêÏÑú Ìïú Î≤àÎßå Ìò∏Ï∂ú
        });

        selectAllButton.addEventListener('click', () => {
            if (selectAllButton.disabled) return;
            resultsList.querySelectorAll('input[type="checkbox"]:not(:disabled)').forEach(cb => {
                cb.checked = true;
            });
            updateSelectedCount(); // üèõÔ∏è ÏÉÅÌÉú Í∞±Ïã†ÏùÑ ÏúÑÌï¥ Ìïú Î≤àÎßå Ìò∏Ï∂ú
        });
        
        /*
        */
        // Îã§Ïö¥Î°úÎìú Î°úÏßÅ (JSZipÏúºÎ°ú ÍµêÏ≤¥)
        downloadButton.addEventListener('click', async () => {
            if (typeof JSZip === 'undefined') {
                setStatus("ZIP ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ® Ìï¥Ï£ºÏÑ∏Ïöî.", 'error');
                return;
            }
            actualDownloadContainer.innerHTML = '';

            const selectedItems = [];
            resultsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)').forEach(cb => {
                selectedItems.push({ 
                    id: cb.dataset.docId, 
                    type: cb.dataset.docType, 
                    name: cb.dataset.docName,
                    typeDisplay: cb.dataset.docTypeDisplay // üèõÔ∏è Get typeDisplay from checkbox
                });
            });

            if (selectedItems.length === 0) {
                setStatus("Îã§Ïö¥Î°úÎìúÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.", 'error');
                return;
            }

            setStatus(`ÏÑ†ÌÉùÎêú ${selectedItems.length}Í∞ú Ìï≠Î™© Ï≤òÎ¶¨ ÏãúÏûë...`, 'info');
            toggleDownloadControlsDisabled(true); toggleInputsDisabled(true);

            let successfulFetches = 0;
            let totalErrorOccurred = false;
            const CHUNK_SIZE = 5;
            const resultsMap = new Map();
            let authErrorDuringDownload = false;

            for (let i = 0; i < selectedItems.length; i += CHUNK_SIZE) {
                if (authErrorDuringDownload) break;
                const chunkSelectedItems = selectedItems.slice(i, i + CHUNK_SIZE);
                const chunkIndices = Array.from({ length: chunkSelectedItems.length }, (_, k) => i + k);
                setStatus(`Ìï≠Î™© ${i + 1}Î∂ÄÌÑ∞ ${Math.min(i + CHUNK_SIZE, selectedItems.length)}/${selectedItems.length} ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Îäî Ï§ë...`, 'info');

                const chunkPromises = chunkSelectedItems.map(async (item, localIndex) => {
                    const originalIndex = chunkIndices[localIndex];
                    const itemTypeDisplay = item.typeDisplay || (item.type === 'law' ? 'Î≤ïÎ†π' : 'ÌñâÏ†ïÍ∑úÏπô'); // Fallback
                    try {
                        let detailDataRoot;
                        if (item.type === 'law') {
                            const jsonData = await makeApiRequest("lawService.do", { "target": "law", "MST": item.id }, item.name, itemTypeDisplay);
                            if (jsonData?._isEmptyResult || !jsonData?.Î≤ïÎ†π) detailDataRoot = { _isEmptyResult: true, Í∏∞Î≥∏Ï†ïÎ≥¥: { Î≤ïÎ†πÎ™ÖÌïúÍ∏Ä: item.name } };
                            else detailDataRoot = jsonData.Î≤ïÎ†π;
                        } else if (item.type === 'admrul') {
                            const data = await makeApiRequest("lawService.do", { "target": "admrul", "ID": item.id }, item.name, itemTypeDisplay);
                            if (data?._isEmptyResult || !data?.AdmRulService) detailDataRoot = { _isEmptyResult: true, Í∏∞Î≥∏Ï†ïÎ≥¥: { ÌñâÏ†ïÍ∑úÏπôÎ™Ö: item.name } };
                            else detailDataRoot = data.AdmRulService;
                        } else {
                            throw new Error(`Ïïå Ïàò ÏóÜÎäî Ìï≠Î™© ÌÉÄÏûÖ: ${item.type}`);
                        }

                        let Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò = "";
                        const itemName = detailDataRoot?.Í∏∞Î≥∏Ï†ïÎ≥¥?.Î≤ïÎ†πÎ™ÖÌïúÍ∏Ä || detailDataRoot?.Í∏∞Î≥∏Ï†ïÎ≥¥?.ÌñâÏ†ïÍ∑úÏπôÎ™Ö || item.name;
                        Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += `--- ${itemName} (${itemTypeDisplay} ID: ${item.id}) ---\n\n`;

                        if (detailDataRoot._isEmptyResult) {
                             Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += "[APIÏóêÏÑú Îπà Í≤∞Í≥ºÎ•º Î∞òÌôòÌñàÍ±∞ÎÇò Ï£ºÏöî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÏÉÅÏÑ∏ ÎÇ¥Ïö©Ïù¥ ÏóÜÏùÑ Ïàò ÏûàÏäµÎãàÎã§.]\n\n";
                        } else {
                            if (item.type === 'law' && detailDataRoot) {
                                if (detailDataRoot.Ï°∞Î¨∏?.Ï°∞Î¨∏Îã®ÏúÑ) {
                                    Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += "## Î≥∏Î¨∏ (Ï°∞Î¨∏)\n";
                                    _ensureListJs(detailDataRoot.Ï°∞Î¨∏.Ï°∞Î¨∏Îã®ÏúÑ).forEach(jo => {
                                        Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += `**Ï†ú${jo.Ï°∞Î¨∏Î≤àÌò∏}Ï°∞` + (jo.Ï°∞Î¨∏Ï†úÎ™© ? `(${stripHtml(jo.Ï°∞Î¨∏Ï†úÎ™©)})` : '') + '**\n' + flattenContentForDisplay(jo.Ï°∞Î¨∏ÎÇ¥Ïö© || "") + "\n";
                                        if (jo.Ìï≠) {
                                            _ensureListJs(jo.Ìï≠).forEach(hang => {
                                                Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += `* ${flattenContentForDisplay(hang.Ìï≠ÎÇ¥Ïö© || "").trim()}\n`;
                                                if (hang.Ìò∏) {
                                                    _ensureListJs(hang.Ìò∏).forEach(ho => {
                                                        Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += `  - ${flattenContentForDisplay(ho.Ìò∏ÎÇ¥Ïö© || "").trim()}\n`;
                                                        if (ho.Î™©) {
                                                            _ensureListJs(ho.Î™©).forEach(mok => {
                                                                Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += `    ‚Ä¢ ${flattenContentForDisplay(mok.Î™©ÎÇ¥Ïö© || "").trim()}\n`;
                                                            });
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                        Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += "\n";
                                    });
                                }
                                if (detailDataRoot.Î∂ÄÏπô?.Î∂ÄÏπôÎã®ÏúÑ) { Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += "## Î∂ÄÏπô\n"; _ensureListJs(detailDataRoot.Î∂ÄÏπô.Î∂ÄÏπôÎã®ÏúÑ).forEach(bu => { Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += `**Î∂ÄÏπô (${bu.Î∂ÄÏπôÍ≥µÌè¨ÏùºÏûê || ''})**\n${flattenContentForDisplay(bu.Î∂ÄÏπôÎÇ¥Ïö© || "")}\n\n`; });}
                                if (detailDataRoot.Ï†úÍ∞úÏ†ïÏù¥Ïú†?.Ï†úÍ∞úÏ†ïÏù¥Ïú†ÎÇ¥Ïö©) Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += "## Ï†úÍ∞úÏ†ï Ïù¥Ïú†\n" + flattenContentForDisplay(detailDataRoot.Ï†úÍ∞úÏ†ïÏù¥Ïú†.Ï†úÍ∞úÏ†ïÏù¥Ïú†ÎÇ¥Ïö©) + "\n\n";
                            } else if (item.type === 'admrul' && detailDataRoot) {
                                if (detailDataRoot.Ï°∞Î¨∏ÎÇ¥Ïö©) Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += "## Î≥∏Î¨∏\n" + flattenContentForDisplay(detailDataRoot.Ï°∞Î¨∏ÎÇ¥Ïö©) + "\n\n";
                                if (detailDataRoot.ÌñâÏ†ïÍ∑úÏπôÎ∂ÄÏπô?.Î∂ÄÏπôÎã®ÏúÑ) { Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += "## Î∂ÄÏπô\n"; _ensureListJs(detailDataRoot.ÌñâÏ†ïÍ∑úÏπôÎ∂ÄÏπô.Î∂ÄÏπôÎã®ÏúÑ).forEach(bu => { Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += `**Î∂ÄÏπô (${bu.Î∂ÄÏπôÌÇ§ || bu.Î∂ÄÏπôÍ≥µÌè¨ÏùºÏûê || ''})**\n${flattenContentForDisplay(bu.Î∂ÄÏπôÎÇ¥Ïö© || "")}\n\n`;});}
                                const Ïù¥Ïú†ÎÇ¥Ïö© = detailDataRoot.Ï†úÍ∞úÏ†ïÏù¥Ïú†?.Ï†úÍ∞úÏ†ïÏù¥Ïú†ÎÇ¥Ïö© || detailDataRoot.ÌñâÏ†ïÍ∑úÏπôÏ†úÍ∞úÏ†ïÏù¥Ïú†?.Ï†úÍ∞úÏ†ïÏù¥Ïú†ÎÇ¥Ïö©;
                                if (Ïù¥Ïú†ÎÇ¥Ïö©) Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò += "## Ï†úÍ∞úÏ†ï Ïù¥Ïú†\n" + flattenContentForDisplay(Ïù¥Ïú†ÎÇ¥Ïö©) + "\n\n";
                            }
                        }
                        return { originalIndex, success: true, content: Î≥∏Î¨∏ÎÇ¥Ïö©ÏÑπÏÖò.trimEnd() + "\n\n", name: item.name }; // @@@@ separator Ï†úÍ±∞
                    } catch (error) {
                        if (error.isAuthError) authErrorDuringDownload = true;
                        let userFriendlyErrorMsg = error.message || "Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò";
                        if (error.message?.includes("ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®")) {
                             userFriendlyErrorMsg = error.message.substring(error.message.indexOf(":") + 2).trim();
                        } else if (error.isTimeout) userFriendlyErrorMsg = `ÏöîÏ≤≠ ÏãúÍ∞Ñ Ï¥àÍ≥ºÎ°ú Ïã§Ìå®ÌñàÏäµÎãàÎã§ (Ïû¨ÏãúÎèÑ Ìè¨Ìï®).`;
                        else if (error.isAuthError) userFriendlyErrorMsg = `API Ïù∏Ï¶ù Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. API ÌÇ§Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.`;
                        return { originalIndex, success: false, errorContent: `--- ${item.name} (${itemTypeDisplay}, ID: ${item.id}) ---\n[Ïò§Î•ò: ${userFriendlyErrorMsg}]\n\n`, name: item.name }; // @@@@ separator Ï†úÍ±∞
                    }
                });
                const chunkPromiseResults = await Promise.all(chunkPromises);
                for (const result of chunkPromiseResults) {
                    resultsMap.set(result.originalIndex, result);
                }
                if (authErrorDuringDownload) {
                    setStatus("API Ïù∏Ï¶ù Ïò§Î•òÍ∞Ä Î∞úÏÉùÌïòÏó¨ Îã§Ïö¥Î°úÎìúÎ•º Ï§ëÎã®Ìï©ÎãàÎã§. API ÌÇ§Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.", "error");
                    break;
                }
            }

            // üèõÔ∏è ZIP ÏÉùÏÑ± Î°úÏßÅ ÏãúÏûë
            if (!authErrorDuringDownload) {
                const zip = new JSZip(); // üèõÔ∏è Rule R2.1.x (Axiom of Pragmatic Tooling)
                let filesAdded = 0;

                for (let i = 0; i < selectedItems.length; i++) {
                    const result = resultsMap.get(i);
                    const item = selectedItems[i]; // Get original item info
                    
                    let content = "";
                    // üèõÔ∏è Rule R2.4.x (Axiom of SOLID Architecture) - Clean, reusable filename logic
                    let baseFileName = item.name.replace(/[\\/*?:"<>|]/g, "_").substring(0, 60).trim() || `[${item.id}]`;
                    let finalFileName = "";

                    if (result) {
                        if (result.success) {
                            content = result.content; // Already cleaned
                            finalFileName = `[${item.typeDisplay}] ${baseFileName}.txt`;
                            successfulFetches++;
                        } else {
                            content = result.errorContent; // Already cleaned
                            finalFileName = `[Ïò§Î•ò] [${item.typeDisplay}] ${baseFileName}.txt`;
                            totalErrorOccurred = true;
                        }
                    } else {
                        content = `--- ${item.name} (ID: ${item.id}) ---\n[Í≤∞Í≥º Ï≤òÎ¶¨ Ï§ë Ïïå Ïàò ÏóÜÎäî ÎàÑÎùΩ Î∞úÏÉù]\n\n`;
                        finalFileName = `[ÎàÑÎùΩ] [${item.typeDisplay}] ${baseFileName}.txt`;
                        totalErrorOccurred = true;
                    }
                    
                    // Add file to zip
                    zip.file(finalFileName, content);
                    filesAdded++;
                }

                if (filesAdded > 0) {
                    setStatus("ZIP ÌååÏùº ÏÉùÏÑ± Ï§ë... (Ìï≠Î™©Ïù¥ ÎßéÏúºÎ©¥ ÏãúÍ∞ÑÏù¥ Í±∏Î¶¥ Ïàò ÏûàÏäµÎãàÎã§)", "info");
                    
                    // Generate final filename for the ZIP
                    let zipFileName = "Î≤ïÎ†π_ÌñâÏ†ïÍ∑úÏπô_ÌÜµÌï©Î≥∏.zip";
                    if (selectedItems.length === 1) {
                        let baseName = selectedItems[0].name.replace(/[\\/*?:"<>|]/g, "_").substring(0, 60).trim();
                        zipFileName = `[${selectedItems[0].typeDisplay}] ${baseName}.zip`;
                    } else {
                        zipFileName = `Î≤ïÎ†π_ÌÜµÌï©_${selectedItems.length}Í±¥.zip`;
                    }

                    // üèõÔ∏è Axiom of Systemic Scalability - Use async generation
                    zip.generateAsync({ type: "blob" })
                        .then(function(blob) {
                            const blobUrl = URL.createObjectURL(blob);
                            const downloadLink = document.createElement('a');
                            downloadLink.href = blobUrl;
                            downloadLink.download = zipFileName;
                            downloadLink.textContent = `ZIP Îã§Ïö¥Î°úÎìú (${zipFileName})`;
                            downloadLink.className = "btn btn-primary";
                            actualDownloadContainer.innerHTML = ''; // Clear previous
                            actualDownloadContainer.appendChild(downloadLink);

                            let downloadOutcomeMsg = "";
                            let downloadOutcomeType = 'info';
                            if (successfulFetches > 0 && !totalErrorOccurred) {
                                downloadOutcomeMsg = `ZIP ÌååÏùº '${zipFileName}' Ï§ÄÎπÑ ÏôÑÎ£å! ÏïÑÎûò Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Îã§Ïö¥Î°úÎìúÌïòÏÑ∏Ïöî. (${successfulFetches}Í∞ú Ìï≠Î™© ÏÑ±Í≥µ)`;
                                downloadOutcomeType = 'success';
                            } else if (successfulFetches > 0 && totalErrorOccurred) {
                                downloadOutcomeMsg = `ÏùºÎ∂Ä Ìï≠Î™© Ïò§Î•òÏôÄ Ìï®Íªò '${zipFileName}' Ï§ÄÎπÑ ÏôÑÎ£å. (ÏÑ±Í≥µ: ${successfulFetches}/${selectedItems.length}Í∞ú). ÏïÑÎûò Î≤ÑÌäºÏúºÎ°ú Îã§Ïö¥Î°úÎìúÌïòÏÑ∏Ïöî.`;
                                downloadOutcomeType = 'error';
                            } else {
                                downloadOutcomeMsg = `Î™®Îì† Ìï≠Î™© Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò Î∞úÏÉù. '${zipFileName}' ÌååÏùºÏù¥ ÏÉùÏÑ±ÎêòÏóàÏßÄÎßå ÎÇ¥Ïö©Ïù¥ Ïò§Î•ò Ï†ïÎ≥¥Ïùº Ïàò ÏûàÏäµÎãàÎã§.`;
                                downloadOutcomeType = 'error';
                            }
                            setStatus(downloadOutcomeMsg, downloadOutcomeType);
                        })
                        .catch(function (err) {
                            setStatus(`ZIP ÌååÏùº ÏÉùÏÑ± Ïò§Î•ò: ${err.message}`, "error");
                        })
                        .finally(() => { 
                            // üèõÔ∏è Axiom of Systemic Scalability - Ensure UI is re-enabled after async op
                            toggleDownloadControlsDisabled(false);
                            toggleInputsDisabled(false);
                            updateSelectedCount();
                        });

                } else {
                     if (selectedItems.length > 0) {
                        setStatus(`ÏÑ†ÌÉùÎêú ${selectedItems.length}Í∞ú Ìï≠Î™©Ïóê ÎåÄÌï¥ Îã§Ïö¥Î°úÎìúÌï† ÎÇ¥Ïö©Ïù¥ ÏóÜÍ±∞ÎÇò Î™®Îì† Ìï≠Î™© Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.`, 'error');
                     } else {
                        setStatus("Îã§Ïö¥Î°úÎìúÌï† Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.", "error");
                     }
                     // Re-enable controls immediately if nothing to zip
                     toggleDownloadControlsDisabled(false);
                     toggleInputsDisabled(false);
                     updateSelectedCount();
                }
            } else { // if (authErrorDuringDownload)
                 // Re-enable controls if auth error stopped process
                 toggleDownloadControlsDisabled(false);
                 toggleInputsDisabled(false);
                 updateSelectedCount();
            }
        });

        if (statusMessage) {
             setStatus("API ÌÇ§ÏôÄ Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†• ÌõÑ Í≤ÄÏÉâÌïòÏÑ∏Ïöî. Í≤ÄÏÉâ Í≤∞Í≥ºÏóêÏÑú 'Ï°∞Î¨∏ ÌÉêÏÉâ' Î≤ÑÌäºÏúºÎ°ú ÌÉêÏÉâÍ∏∞Î•º Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.", 'info');
        }

        // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú API ÌÇ§ Î°úÎìú/Ï†ÄÏû•
        function loadApiKey() {
            const storedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (storedApiKey) apiKeyInput.value = storedApiKey;
        }
        function saveApiKey() {
            const keyToSave = apiKeyInput.value.trim();
            if (keyToSave) {
                localStorage.setItem(API_KEY_STORAGE_KEY, keyToSave);
            } else {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
            }
        }
        apiKeyInput.addEventListener('input', saveApiKey);
        window.addEventListener('load', loadApiKey);

        // ------------------------------
        // Î≤ïÎ†π ÌÉêÏÉâ Î™®Îã¨ Î∞è ÌÉ≠ Íµ¨ÌòÑ
        // ------------------------------
        const lawExplorerModal = document.getElementById('lawExplorerModal');
        const closeLawExplorerModalBtn = document.getElementById('closeLawExplorerModal');
        const lawTabList = document.getElementById('lawTabList');
        const lawTabContents = document.getElementById('lawTabContents');

        // Map to store Î°úÎìúÎêú Î≤ïÎ†π/Í∑úÏπô Îç∞Ïù¥ÌÑ∞
        const lawDataMap = new Map();

        // ÌÉ≠ ÌÅ¥Î¶≠ Ïãú ÌôúÏÑ±Ìôî
        lawTabList.addEventListener('click', (e) => {
            if (e.target.tagName === 'LI') {
                const tabId = e.target.dataset.tabId;
                activateTab(tabId);
            }
        });

        // Î™®Îã¨ Îã´Í∏∞
        closeLawExplorerModalBtn.addEventListener('click', () => {
            lawExplorerModal.style.display = 'none';
        });
        window.addEventListener('click', (e) => {
            if (e.target === lawExplorerModal) {
                lawExplorerModal.style.display = 'none';
            }
        });

        /**
         * ÏÉàÎ°úÏö¥ Î≤ïÎ†π/Í∑úÏπô ÌÉ≠ ÏÉùÏÑ± Î∞è Îç∞Ïù¥ÌÑ∞ Î°úÎìú
         * @param {Object} item - { id, name, type, typeDisplay }
         */
        async function openLawExplorer(item) {
            const tabId = `${item.type}_${item.id}`;
            // Ïù¥ÎØ∏ ÌÉ≠Ïù¥ Ï°¥Ïû¨ÌïòÎ©¥ ÌôúÏÑ±ÌôîÎßå
            if (lawDataMap.has(tabId)) {
                activateTab(tabId);
                lawExplorerModal.style.display = 'flex';
                return;
            }

            // ÌÉ≠ ÏöîÏÜå ÏÉùÏÑ±
            const tabElement = document.createElement('li');
            tabElement.textContent = item.name;
            tabElement.dataset.tabId = tabId;
            tabElement.title = item.name;
            lawTabList.appendChild(tabElement);

            // ÌÉ≠ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ ÏÉùÏÑ±
            const contentDiv = document.createElement('div');
            contentDiv.className = 'tab-content';
            contentDiv.id = `content_${tabId}`;
            lawTabContents.appendChild(contentDiv);

            // Ï†ÄÏû•
            lawDataMap.set(tabId, { item, data: null });

            activateTab(tabId);
            lawExplorerModal.style.display = 'flex';
            await loadLawDataIntoTab(tabId);
        }

        /**
         * ÌÉ≠ ÌôúÏÑ±Ìôî: Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω Î∞è ÏΩòÌÖêÏ∏† ÌÜ†Í∏Ä
         * @param {string} tabId
         */
        function activateTab(tabId) {
            // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
            lawTabList.querySelectorAll('li').forEach(li => {
                li.classList.toggle('active', li.dataset.tabId === tabId);
            });
            // Î™®Îì† ÏΩòÌÖêÏ∏† ÎπÑÌôúÏÑ±Ìôî
            lawTabContents.querySelectorAll('.tab-content').forEach(div => {
                div.classList.toggle('active', div.id === `content_${tabId}`);
            });
        }

        /**
         * Î≤ïÎ†π/Í∑úÏπô Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è UI Íµ¨ÏÑ±
         * @param {string} tabId
         */
        async function loadLawDataIntoTab(tabId) {
            const { item } = lawDataMap.get(tabId);
            const contentDiv = document.getElementById(`content_${tabId}`);
            contentDiv.innerHTML = `<p>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</p>`;

            try {
                let params = {};
                if (item.type === 'law') {
                    params = { "target": "law", "MST": item.id, "display": 200, "JOSEY": "Ï°∞Î¨∏ÌÇ§,Ï°∞Î¨∏Î≤àÌò∏,Ï°∞Î¨∏Ï†úÎ™©,Ï°∞Î¨∏ÎÇ¥Ïö©,Ï°∞Î¨∏Ïó¨Î∂Ä,Ìï≠Î≤àÌò∏,Ìï≠ÎÇ¥Ïö©,Ìò∏Î≤àÌò∏,Ìò∏ÎÇ¥Ïö©,Î™©Î≤àÌò∏,Î™©ÎÇ¥Ïö©" };
                } else {
                    params = { "target": "admrul", "ID": item.id, "display": 200 };
                }
                const lawData = await makeApiRequest("lawService.do", params, item.name, item.typeDisplay);

                let selectedData = null;
                if (item.type === 'law' && lawData && lawData.Î≤ïÎ†π) {
                    selectedData = lawData.Î≤ïÎ†π;
                } else if (item.type === 'admrul' && lawData && lawData.AdmRulService) {
                    selectedData = lawData.AdmRulService;
                } else if (lawData && lawData._isEmptyResult) {
                    contentDiv.innerHTML = `<p>Ìï¥Îãπ Î≤ïÎ†π/Í∑úÏπôÏùò ÏÉÅÏÑ∏ Ï†ïÎ≥¥Í∞Ä Ï†úÍ≥µÎêòÏßÄ ÏïäÏäµÎãàÎã§.</p>`;
                    lawDataMap.set(tabId, { item, data: null });
                    return;
                } else {
                    throw new Error("Î≤ïÎ†π ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.");
                }

                // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                lawDataMap.set(tabId, { item, data: selectedData });
                renderTabContent(tabId);

            } catch (error) {
                console.error(`ÌÉ≠ ${tabId} Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:`, error);
                contentDiv.innerHTML = `<p>Ïò§Î•ò Î∞úÏÉù: ${error.message}</p>`;
            }
        }

        /**
         * ÌÉ≠ ÏΩòÌÖêÏ∏† Î†åÎçîÎßÅ: Î≤îÏúÑ ÏûÖÎ†• Î∞è Í≤∞Í≥º ÌëúÏãú
         * @param {string} tabId
         */
        function renderTabContent(tabId) {
            const { item, data } = lawDataMap.get(tabId);
            const contentDiv = document.getElementById(`content_${tabId}`);
            contentDiv.innerHTML = '';

            if (!data) {
                contentDiv.innerHTML = `<p>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
                return;
            }

            // Î≤îÏúÑ ÏûÖÎ†• UI (Ìïú Ï§ÑÎ°ú)
            const rangeContainer = document.createElement('div');
            rangeContainer.className = 'range-input-container';

            if (item.type === 'law') {
                const startLabel = document.createElement('label');
                startLabel.textContent = 'Ï†ú';
                const startInput = document.createElement('input');
                startInput.type = 'number';
                startInput.min = '1';
                startInput.className = 'range-input';
                startInput.placeholder = 'ÏãúÏûëÏ°∞Î¨∏';
                startInput.id = `start_${tabId}`;

                const tilde = document.createElement('span');
                tilde.textContent = '~';

                const endInput = document.createElement('input');
                endInput.type = 'number';
                endInput.min = '1';
                endInput.className = 'range-input';
                endInput.placeholder = 'ÎÅùÏ°∞Î¨∏';
                endInput.id = `end_${tabId}`;

                rangeContainer.appendChild(startLabel);
                rangeContainer.appendChild(startInput);
                rangeContainer.appendChild(tilde);
                rangeContainer.appendChild(endInput);

                // Ï¶âÍ∞Å Î†åÎçîÎßÅ
                startInput.addEventListener('input', () => {
                    const startVal = parseInt(startInput.value, 10);
                    const endVal = parseInt(endInput.value, 10);
                    if (!isNaN(startVal) && (isNaN(endVal) || endVal < startVal)) {
                        displaySingleArticle(tabId, startVal);
                    } else if (!isNaN(startVal) && !isNaN(endVal)) {
                        displayLawRange(tabId);
                    }
                });
                endInput.addEventListener('input', () => {
                    const startVal = parseInt(startInput.value, 10);
                    const endVal = parseInt(endInput.value, 10);
                    if (!isNaN(startVal) && !isNaN(endVal)) {
                        displayLawRange(tabId);
                    }
                });
            } else {
                const infoP = document.createElement('p');
                infoP.textContent = 'Ïù¥ ÌñâÏ†ïÍ∑úÏπôÏùÄ Ï°∞Î¨∏ Î≤îÏúÑ Ï°∞ÌöåÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§. ÏïÑÎûò Ï†ÑÏ≤¥ ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.';
                rangeContainer.appendChild(infoP);
            }

            // Î≥µÏÇ¨ Î≤ÑÌäº
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'Î≥µÏÇ¨';
            copyBtn.className = 'copy-btn';
            copyBtn.addEventListener('click', () => {
                copyProvisions(tabId);
            });
            rangeContainer.appendChild(copyBtn);

            // ÏΩòÌÖêÏ∏† ÌëúÏãú ÏòÅÏó≠
            const displayArea = document.createElement('div');
            displayArea.id = `display_${tabId}`;
            displayArea.style.flex = '1';

            contentDiv.appendChild(rangeContainer);
            contentDiv.appendChild(displayArea);

            // Ï¥àÍ∏∞ Î°úÎìú
            if (item.type === 'admrul') {
                displayFullAdmrul(tabId);
            }
        }

        /**
         * Îã®Ïùº Ï°∞Î¨∏ Î∞îÎ°ú Î†åÎçîÎßÅ
         * @param {string} tabId
         * @param {number} joNumber
         */
        function displaySingleArticle(tabId, joNumber) {
            const { data } = lawDataMap.get(tabId);
            const displayArea = document.getElementById(`display_${tabId}`);
            if (!data) {
                displayArea.innerHTML = `<p>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
                return;
            }
            const articles = _ensureListJs(data.Ï°∞Î¨∏?.Ï°∞Î¨∏Îã®ÏúÑ);
            const matched = articles.filter(jo => parseInt(jo.Ï°∞Î¨∏Î≤àÌò∏, 10) === joNumber);
            if (!matched.length) {
                displayArea.innerHTML = `<p>Ï†ú${joNumber}Ï°∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>`;
                return;
            }
            displayArea.innerHTML = '';
            matched.forEach((jo, idx) => {
                const block = document.createElement('div');
                block.className = 'provision-block';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'provision-title';
                titleDiv.textContent = jo.Ï°∞Î¨∏Ïó¨Î∂Ä === 'Ï†ÑÎ¨∏' 
                    ? stripHtml(jo.Ï°∞Î¨∏ÎÇ¥Ïö© || '') 
                    : `Ï†ú${jo.Ï°∞Î¨∏Î≤àÌò∏}Ï°∞ ${jo.Ï°∞Î¨∏Ï†úÎ™© ? `(${stripHtml(jo.Ï°∞Î¨∏Ï†úÎ™©)})` : ''}`;
                block.appendChild(titleDiv);

                let joContent = jo.Ï°∞Î¨∏Ïó¨Î∂Ä !== 'Ï†ÑÎ¨∏' ? stripHtml(jo.Ï°∞Î¨∏ÎÇ¥Ïö© || '') : '';
                if (joContent) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'provision-content';
                    contentDiv.textContent = joContent;
                    block.appendChild(contentDiv);
                }

                const hangs = _ensureListJs(jo.Ìï≠);
                hangs.forEach(hang => {
                    const hangDiv = document.createElement('div');
                    hangDiv.className = 'provision-sub-item';
                    hangDiv.innerHTML = `${stripHtml(hang.Ìï≠ÎÇ¥Ïö© || '')}`;
                    block.appendChild(hangDiv);

                    const hos = _ensureListJs(hang.Ìò∏);
                    hos.forEach(ho => {
                        const hoDiv = document.createElement('div');
                        hoDiv.className = 'provision-sub-sub-item';
                        hoDiv.innerHTML = ` ${stripHtml(ho.Ìò∏ÎÇ¥Ïö© || '')}`;
                        block.appendChild(hoDiv);

                        const moks = _ensureListJs(ho.Î™©);
                        moks.forEach(mok => {
                            const mokDiv = document.createElement('div');
                            mokDiv.className = 'provision-sub-sub-item';
                            mokDiv.style.marginLeft = '4rem';
                            mokDiv.innerHTML = ` ${stripHtml(mok.Î™©ÎÇ¥Ïö© || '')}`;
                            block.appendChild(mokDiv);
                        });
                    });
                });

                displayArea.appendChild(block);
                if (idx < matched.length - 1) {
                    const hr = document.createElement('hr');
                    hr.style.border = '0';
                    hr.style.height = '1px';
                    hr.style.backgroundColor = 'var(--color-border-subtle)';
                    hr.style.margin = 'calc(var(--spacing-base)*2) 0';
                    displayArea.appendChild(hr);
                }
            });
        }

        /**
         * Î≤ïÎ†π Ï°∞Î¨∏ Î≤îÏúÑÏóê ÎßûÍ≤å ÌëúÏãú
         * @param {string} tabId
         */
        function displayLawRange(tabId) {
            const { data } = lawDataMap.get(tabId);
            const startVal = parseInt(document.getElementById(`start_${tabId}`).value, 10);
            const endVal = parseInt(document.getElementById(`end_${tabId}`).value, 10);
            const displayArea = document.getElementById(`display_${tabId}`);

            if (isNaN(startVal) || isNaN(endVal) || startVal < 1 || endVal < startVal) {
                displayArea.innerHTML = `<p style="color: var(--color-error);">Ïú†Ìö®Ìïú Î≤îÏúÑÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî. (Ïòà: 1 ~ 200)</p>`;
                return;
            }

            const articles = _ensureListJs(data.Ï°∞Î¨∏?.Ï°∞Î¨∏Îã®ÏúÑ);
            if (!articles.length) {
                displayArea.innerHTML = `<p>Ï°∞Î¨∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
                return;
            }

            const filtered = articles.filter(jo => {
                const num = parseInt(jo.Ï°∞Î¨∏Î≤àÌò∏, 10);
                return !isNaN(num) && num >= startVal && num <= endVal;
            });

            if (!filtered.length) {
                displayArea.innerHTML = `<p>Ï†ú${startVal}Ï°∞Î∂ÄÌÑ∞ Ï†ú${endVal}Ï°∞ ÏÇ¨Ïù¥Ïóê Ìï¥ÎãπÌïòÎäî Ï°∞Î¨∏ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>`;
                return;
            }

            displayArea.innerHTML = '';
            filtered.forEach((jo, idx) => {
                const block = document.createElement('div');
                block.className = 'provision-block';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'provision-title';
                titleDiv.textContent = jo.Ï°∞Î¨∏Ïó¨Î∂Ä === 'Ï†ÑÎ¨∏' 
                    ? stripHtml(jo.Ï°∞Î¨∏ÎÇ¥Ïö© || '') 
                    : `Ï†ú${jo.Ï°∞Î¨∏Î≤àÌò∏}Ï°∞ ${jo.Ï°∞Î¨∏Ï†úÎ™© ? `(${stripHtml(jo.Ï°∞Î¨∏Ï†úÎ™©)})` : ''}`;
                block.appendChild(titleDiv);

                let joContent = jo.Ï°∞Î¨∏Ïó¨Î∂Ä !== 'Ï†ÑÎ¨∏' ? stripHtml(jo.Ï°∞Î¨∏ÎÇ¥Ïö© || '') : '';
                if (joContent) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'provision-content';
                    contentDiv.textContent = joContent;
                    block.appendChild(contentDiv);
                }

                const hangs = _ensureListJs(jo.Ìï≠);
                hangs.forEach(hang => {
                    const hangDiv = document.createElement('div');
                    hangDiv.className = 'provision-sub-item';
                    hangDiv.innerHTML = `${stripHtml(hang.Ìï≠ÎÇ¥Ïö© || '')}`;
                    block.appendChild(hangDiv);

                    const hos = _ensureListJs(hang.Ìò∏);
                    hos.forEach(ho => {
                        const hoDiv = document.createElement('div');
                        hoDiv.className = 'provision-sub-sub-item';
                        hoDiv.innerHTML = `${stripHtml(ho.Ìò∏ÎÇ¥Ïö© || '')}`;
                        block.appendChild(hoDiv);

                        const moks = _ensureListJs(ho.Î™©);
                        moks.forEach(mok => {
                            const mokDiv = document.createElement('div');
                            mokDiv.className = 'provision-sub-sub-item';
                            mokDiv.style.marginLeft = '4rem';
                            mokDiv.innerHTML = `${stripHtml(mok.Î™©ÎÇ¥Ïö© || '')}`;
                            block.appendChild(mokDiv);
                        });
                    });
                });

                displayArea.appendChild(block);
                if (idx < filtered.length - 1) {
                    const hr = document.createElement('hr');
                    hr.style.border = '0';
                    hr.style.height = '1px';
                    hr.style.backgroundColor = 'var(--color-border-subtle)';
                    hr.style.margin = 'calc(var(--spacing-base)*2) 0';
                    displayArea.appendChild(hr);
                }
            });
        }

        /**
         * ÌñâÏ†ïÍ∑úÏπô Ï†ÑÏ≤¥ ÎÇ¥Ïö© ÌëúÏãú
         * @param {string} tabId
         */
        function displayFullAdmrul(tabId) {
            const { data } = lawDataMap.get(tabId);
            const displayArea = document.getElementById(`display_${tabId}`);
            const content = data.Ï°∞Î¨∏ÎÇ¥Ïö© ? stripHtml(data.Ï°∞Î¨∏ÎÇ¥Ïö©) : 'Î≥∏Î¨∏ ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
            displayArea.innerHTML = `<div class="provision-content">${content}</div>`;
        }

        /**
         * ÌëúÏãúÎêú Ï°∞Î¨∏ ÎÇ¥Ïö© Î≥µÏÇ¨ (Android Ìò∏ÌôòÏÑ± Í∞ïÌôî)
         * @param {string} tabId
         */
        function copyProvisions(tabId) {
            const displayArea = document.getElementById(`display_${tabId}`);
            const textToCopy = displayArea.innerText;
            if (!textToCopy) return;

            // AndroidÎ•º ÏúÑÌïú execCommand Î≥µÏÇ¨
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('Ï°∞Î¨∏ ÎÇ¥Ïö©Ïù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
                } else {
                    alert('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú Î≥µÏÇ¨Ìï¥ Ï£ºÏÑ∏Ïöî.');
                }
            } catch (err) {
                alert('Î≥µÏÇ¨ Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + err);
            }
            document.body.removeChild(textarea);
        }

        // JSON Modal Í¥ÄÎ†®
        const jsonModal = document.getElementById('jsonModal');
        const jsonModalTitle = document.getElementById('jsonModalTitle');
        const jsonDisplayArea = document.getElementById('jsonDisplayArea');
        const closeJsonModalBtn = document.getElementById('closeJsonModalBtn');

        async function showLawJsonModal(item) {
            setStatus("JSON Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...", "info");
            jsonModalTitle.textContent = `"${item.name}" (${item.typeDisplay}) JSON Îç∞Ïù¥ÌÑ∞`;
            jsonDisplayArea.textContent = "Î°úÎî© Ï§ë...";
            jsonModal.style.display = "flex";

            try {
                let params = {};
                if (item.type === 'law') {
                    params = {"target": "law", "MST": item.id, "display": 200, "JOSEY": "Ï°∞Î¨∏ÌÇ§,Ï°∞Î¨∏Î≤àÌò∏,Ï°∞Î¨∏Ï†úÎ™©,Ï°∞Î¨∏ÎÇ¥Ïö©,Ï°∞Î¨∏Ïó¨Î∂Ä,Ìï≠Î≤àÌò∏,Ìï≠ÎÇ¥Ïö©,Ìò∏Î≤àÌò∏,Ìò∏ÎÇ¥Ïö©,Î™©Î≤àÌò∏,Î™©ÎÇ¥Ïö©"};
                } else if (item.type === 'admrul') {
                    params = {"target": "admrul", "ID": item.id, "display": 200};
                } else {
                    throw new Error("Ïïå Ïàò ÏóÜÎäî Ìï≠Î™© ÌÉÄÏûÖ");
                }
                const data = await makeApiRequest("lawService.do", params, item.name, `${item.typeDisplay} JSON`);
                jsonDisplayArea.textContent = JSON.stringify(data, null, 2);
                setStatus("JSON Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏôÑÎ£å.", "success");
            } catch (error) {
                jsonDisplayArea.textContent = `JSON Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.\nÏò§Î•ò: ${error.message}`;
                setStatus(`JSON Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®: ${error.message}`, "error");
            }
        }

        closeJsonModalBtn.addEventListener('click', () => {
            jsonModal.style.display = "none";
        });
        window.addEventListener('click', (event) => {
            if (event.target === jsonModal) {
                jsonModal.style.display = "none";
            }
        });

        // Ïô∏Î∂Ä ÎßÅÌÅ¨ Ïó¥Í∏∞
        function openLawPageLink(item) {
            let url = "";
            if (item.type === 'law') {
                url = `https://www.law.go.kr/LSW/lsInfoP.do?lsiSeq=${item.id}&viewCls=lsRvsDocInfoR`;
            } else if (item.type === 'admrul') {
                url = `https://www.law.go.kr/LSW/admRulInfoP.do?admRulSeq=${item.id}`;
            }
            if (url) {
                window.open(url, '_blank', 'noopener,noreferrer');
            } else {
                setStatus("Ìï¥Îãπ Ìï≠Î™©Ïùò Ïô∏Î∂Ä ÎßÅÌÅ¨Î•º ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.", "error");
            }
        }
    </script>
</body>
</html>
