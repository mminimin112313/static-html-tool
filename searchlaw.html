<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>법령/행정규칙 통합 다운로더 및 조문 탐색기</title>
    <style>
        :root {
            /* Color Palette - Refined Dark Theme */
            --color-background-base: #1A1C20;
            --color-background-elevated-1: #23272C;
            --color-background-elevated-2: #2A2F36;
            --color-background-input: #181A1E;

            --color-border-subtle: #30353C;
            --color-border-interactive: #4A5058;

            --color-text-primary: #E1E6EB;
            --color-text-secondary: #A8B0BC;
            --color-text-placeholder: #707A8A;
            --color-text-disabled: #5F6874;

            --color-accent-primary: #3A86FF;
            --color-accent-primary-hover: #206FEE;
            --color-accent-primary-text: #FFFFFF;
            --color-accent-focus-shadow: rgba(58, 134, 255, 0.25);

            --color-success: #4CAF50;
            --color-error: #F44336;
            --color-warning: #FF9800;

            /* Typography */
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-family-mono: "SF Mono", "Consolas", "Liberation Mono", Menlo, Courier, monospace;

            --font-size-xs: 0.75rem;  /* 12px */
            --font-size-sm: 0.875rem; /* 14px */
            --font-size-md: 1rem;     /* 16px */
            --font-size-lg: 1.125rem; /* 18px */
            --font-size-xl: 1.25rem;  /* 20px */
            --font-size-2xl: 1.5rem;  /* 24px */
            --font-size-3xl: 1.875rem;/* 30px */

            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Spacing & Sizing */
            --spacing-base: 8px;
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 10px;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 3px 5px -1px rgba(0, 0, 0, 0.15), 0 2px 3px -1px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 12px -3px rgba(0, 0, 0, 0.2), 0 3px 5px -2px rgba(0, 0, 0, 0.08);

            /* Transitions */
            --transition-fast: all 0.15s ease-out;
            --transition-normal: all 0.25s ease-out;
        }

        /* Global Resets & Base Styles */
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family-sans);
            font-size: var(--font-size-md);
            line-height: var(--line-height-relaxed);
            background-color: var(--color-background-base);
            color: var(--color-text-primary);
            margin: 0;
            padding: calc(var(--spacing-base) * 3);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Application Container */
        .app-container {
            width: 100%;
            max-width: 860px;
            background-color: var(--color-background-elevated-1);
            border-radius: var(--radius-lg);
            padding: calc(var(--spacing-base) * 3.5);
            box-shadow: var(--shadow-lg);
        }

        .app-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            text-align: center;
            margin-bottom: calc(var(--spacing-base) * 4);
        }

        /* Sections */
        .section {
            background-color: var(--color-background-elevated-2);
            border-radius: var(--radius-md);
            padding: calc(var(--spacing-base) * 2.5);
            margin-bottom: calc(var(--spacing-base) * 3.5);
            box-shadow: var(--shadow-md);
        }
        .section:last-of-type { margin-bottom: 0; }

        .section-title-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: calc(var(--spacing-base) * 1.5);
            margin-bottom: calc(var(--spacing-base) * 2.5);
            border-bottom: 1px solid var(--color-border-subtle);
        }
        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 0.75);
        }
        .section-title-icon {
            width: var(--font-size-lg);
            height: var(--font-size-lg);
            color: var(--color-text-secondary);
        }

        /* Form Elements */
        .api-key-area { margin-bottom: calc(var(--spacing-base) * 2.5); }
        .api-key-area label, .explorer-input-group label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            margin-bottom: calc(var(--spacing-base) * 0.75);
        }
        .search-input, .api-key-input, .explorer-input, .range-input {
            width: 100%;
            padding: calc(var(--spacing-base) * 1.25) calc(var(--spacing-base) * 1.5);
            background-color: var(--color-background-input);
            border: 1px solid var(--color-border-interactive);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: var(--font-size-md);
            transition: var(--transition-normal);
        }
        .search-input::placeholder, .api-key-input::placeholder, .explorer-input::placeholder, .range-input::placeholder { color: var(--color-text-placeholder); }
        .search-input:focus, .api-key-input:focus, .explorer-input:focus, .range-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 2.5px var(--color-accent-focus-shadow);
        }
        .search-area { display: flex; gap: var(--spacing-base); align-items: stretch; }
        .search-input-wrapper { flex-grow: 1; position: relative; }
        .clear-search-btn {
            position: absolute; right: var(--spacing-base); top: 50%; transform: translateY(-50%);
            background: transparent; border: none; color: var(--color-text-secondary);
            font-size: var(--font-size-xl); line-height: 1; cursor: pointer; padding: var(--spacing-base);
            display: none; transition: var(--transition-fast);
        }
        .clear-search-btn:hover { color: var(--color-text-primary); }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 2);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-sm); border: 1px solid transparent;
            cursor: pointer; text-decoration: none; white-space: nowrap;
            transition: var(--transition-normal);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none !important; }

        .btn-primary {
            background-color: var(--color-accent-primary); color: var(--color-accent-primary-text);
            border-color: var(--color-accent-primary);
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-accent-primary-hover); border-color: var(--color-accent-primary-hover); box-shadow: var(--shadow-sm); }

        .btn-secondary {
            background-color: var(--color-background-elevated-1); color: var(--color-text-secondary);
            border-color: var(--color-border-interactive);
        }
        .btn-secondary:hover:not(:disabled) { background-color: var(--color-background-elevated-2); border-color: var(--color-text-primary); color: var(--color-text-primary); }

        .icon-btn {
            background: transparent; color: var(--color-text-secondary);
            padding: calc(var(--spacing-base) * 0.5);
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            border: none; cursor: pointer;
        }
        .icon-btn svg { width: calc(var(--font-size-md) * 1.1); height: calc(var(--font-size-md) * 1.1); fill: currentColor; }
        .icon-btn:hover:not(:disabled) { background-color: var(--color-background-elevated-2); color: var(--color-accent-primary); }

        /* Search Results List */
        #results-list {
            list-style: none; padding: 0;
            display: flex; flex-direction: column; gap: calc(var(--spacing-base) * 0.75);
            max-height: 420px; overflow-y: auto; margin-top: var(--spacing-base);
        }
        #results-list li {
            background-color: var(--color-background-elevated-1);
            border-radius: var(--radius-sm);
            padding: calc(var(--spacing-base) * 1.25) calc(var(--spacing-base) * 1.5);
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-areas:
                "checkbox main"
                "checkbox actions";
            align-items: start;
            gap: calc(var(--spacing-base) * 0.5) calc(var(--spacing-base) * 1.25);
            border: 1px solid var(--color-border-subtle);
            transition: var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }
        #results-list li:hover { border-color: var(--color-border-interactive); background-color: var(--color-background-elevated-2); transform: translateY(-1px); }

        .result-item-checkbox-wrapper { grid-area: checkbox; padding-top: calc(var(--spacing-base) * 0.25); }
        #results-list input[type="checkbox"] {
            accent-color: var(--color-accent-primary);
            width: var(--font-size-lg); height: var(--font-size-lg);
            cursor: pointer; margin-top: 1px;
        }

        .result-item-main {
            grid-area: main;
            display: flex; flex-direction: column;
            gap: calc(var(--spacing-base) * 0.25);
        }
        .item-name {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            line-height: var(--line-height-normal);
            word-break: break-word;
        }
        .item-meta {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .result-item-actions {
            grid-area: actions;
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-base) * 1);
            margin-top: calc(var(--spacing-base) * 1);
            padding-left: 0;
        }
        .btn-explore {
            font-size: var(--font-size-xs);
            padding: calc(var(--spacing-base)*0.5) calc(var(--spacing-base)*1);
            background-color: transparent;
            color: var(--color-accent-primary);
            border: 1px solid var(--color-accent-primary);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
        }
        .btn-explore:hover:not(:disabled) { background-color: rgba(58, 134, 255, 0.1); }

        /* Status Message */
        .status-message {
            padding: calc(var(--spacing-base) * 1.25) calc(var(--spacing-base) * 1.5);
            margin-top: calc(var(--spacing-base) * 2.5);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            background-color: var(--color-background-elevated-2);
            border-radius: var(--radius-sm);
            text-align: center;
            border: 1px solid var(--color-border-subtle);
        }
        .status-message.error-message { color: var(--color-error); border-color: var(--color-error); background-color: rgba(244, 67, 54, 0.05); }
        .status-message.success-message { color: var(--color-success); border-color: var(--color-success); background-color: rgba(76, 175, 80, 0.05); }

        .download-area {
            margin-top: calc(var(--spacing-base) * 3);
            padding-top: calc(var(--spacing-base) * 2.5);
            border-top: 1px solid var(--color-border-subtle);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* JSON Modal */
        .modal {
            display: none; position: fixed; z-index: 1000;
            inset: 0; overflow: auto;
            background-color: rgba(12, 14, 17, 0.8);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: var(--color-background-elevated-2);
            margin: 5vh auto; padding: calc(var(--spacing-base) * 3.5);
            border: 1px solid var(--color-border-subtle); border-radius: var(--radius-lg);
            width: clamp(300px, 90%, 900px);
            max-height: 90vh; overflow-y: auto;
            color: var(--color-text-primary); position: relative; box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: calc(var(--spacing-base) * 1.5); margin-bottom: calc(var(--spacing-base) * 2.5);
            border-bottom: 1px solid var(--color-border-subtle);
        }
        .modal-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); }
        .close-modal-btn {
            background: transparent; border: none; color: var(--color-text-secondary);
            font-size: var(--font-size-2xl); line-height: 1; cursor: pointer;
            padding: var(--spacing-base); border-radius: 50%;
        }
        .close-modal-btn:hover { background-color: var(--color-background-elevated-1); color: var(--color-text-primary); }
        #jsonDisplayArea {
            background-color: var(--color-background-input);
            border: 1px solid var(--color-border-subtle); border-radius: var(--radius-sm);
            padding: calc(var(--spacing-base) * 2); max-height: 70vh; overflow-y: auto;
            white-space: pre; font-family: var(--font-family-mono);
            font-size: var(--font-size-sm); line-height: var(--line-height-normal);
            color: var(--color-text-secondary);
        }

        /* Law Explorer Modal */
        #lawExplorerModal {
            display: none; position: fixed; z-index: 1001;
            inset: 0; overflow: auto;
            background-color: rgba(12, 14, 17, 0.8);
            backdrop-filter: blur(4px);
        }
        #lawExplorerModal .modal-content {
            width: clamp(500px, 90%, 1000px);
            max-height: 90vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        #lawExplorerModal .modal-header {
            flex: none;
        }
        .tab-list {
            list-style: none; margin: 0; padding: 0;
            display: flex; border-bottom: 1px solid var(--color-border-subtle);
            overflow-x: auto; flex: none;
        }
        .tab-list li {
            flex: none; padding: calc(var(--spacing-base) * 1) calc(var(--spacing-base) * 1.5);
            font-size: var(--font-size-xs); font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            text-align: center; cursor: pointer;
            border-top-left-radius: var(--radius-md);
            border-top-right-radius: var(--radius-md);
            background-color: var(--color-background-elevated-1);
            margin-right: var(--spacing-base);
            line-height: var(--line-height-normal);
            max-width: 140px;
            white-space: normal;
            transition: var(--transition-fast);
        }
        .tab-list li.active {
            background-color: var(--color-background-base);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-interactive);
            border-bottom: none;
            box-shadow: var(--shadow-sm);
        }
        .tab-contents {
            background-color: var(--color-background-elevated-2);
            flex: 1 1 auto;
            overflow-y: auto;
            display: flex; flex-direction: column;
            padding: calc(var(--spacing-base) * 2);
        }
        .tab-content {
            display: none; flex: 1 1 auto; flex-direction: column;
        }
        .tab-content.active {
            display: flex;
        }
        .range-input-container {
            display: flex; gap: var(--spacing-base); margin-bottom: calc(var(--spacing-base) * 1.5);
            align-items: center; flex-wrap: wrap;
        }
        .range-input-container label {
            font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);
            white-space: nowrap;
        }
        .copy-btn {
            background-color: var(--color-background-elevated-1);
            border: 1px solid var(--color-border-interactive);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            padding: calc(var(--spacing-base) * 0.75) calc(var(--spacing-base) * 1.5);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .copy-btn:hover:not(:disabled) {
            background-color: var(--color-background-elevated-2);
            color: var(--color-accent-primary);
        }
        .provision-block {
            margin-bottom: calc(var(--spacing-base) * 2);
        }
        .provision-title {
            font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); color: var(--color-text-primary);
            margin-bottom: var(--spacing-base);
        }
        .provision-content {
            font-size: var(--font-size-sm); line-height: var(--line-height-relaxed); color: var(--color-text-secondary);
            white-space: pre-wrap; margin-bottom: var(--spacing-base);
        }
        .provision-sub-item, .provision-sub-sub-item {
            margin-left: calc(var(--spacing-base) * 2);
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-background-input); border-radius: var(--radius-md); }
        ::-webkit-scrollbar-thumb { background: var(--color-border-interactive); border-radius: var(--radius-md); border: 2px solid var(--color-background-input); }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-text-secondary); }
        html { scrollbar-width: thin; scrollbar-color: var(--color-border-interactive) var(--color-background-input); }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="app-title">법령/행정규칙 통합 다운로더 및 조문 탐색기</h1>

        <!-- 검색 섹션 -->
        <div class="section">
            <div class="section-title-area">
                <h2 class="section-title">
                    <svg class="section-title-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3zm0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/>
                    </svg>
                    검색 조건
                </h2>
            </div>
            <div class="api-key-area">
                <label for="apiKey">API 키 (국가법령정보센터 Open API)</label>
                <input type="text" id="apiKey" class="api-key-input" value="" placeholder="API 키를 입력하세요">
            </div>
            <div class="search-area">
                <div class="search-input-wrapper">
                    <input type="text" id="searchQuery" class="search-input" placeholder="검색어 입력 (콤마(,)로 여러 검색어 입력 가능)">
                    <button type="button" class="clear-search-btn" id="clearSearchQueryButton" title="검색어 지우기">&times;</button>
                </div>
                <button id="searchButton" class="btn btn-primary">검색</button>
            </div>
        </div>

        <!-- 검색 결과 섹션 -->
        <div class="section">
            <div class="section-title-area">
                <h2 class="section-title">
                    <svg class="section-title-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                    검색 결과 (<span id="selectedCount">0</span>개 선택됨)
                </h2>
                <button id="clearSelectionButton" class="btn btn-secondary">선택 해제</button>
            </div>
            <ul id="results-list"></ul>
            <div id="statusMessage" class="status-message" role="status">
                검색어를 입력하고 검색 버튼을 누르세요.
            </div>
            <div class="download-area">
                <button id="downloadButton" class="btn btn-primary">선택 항목 다운로드</button>
                <div id="actualDownloadContainer"></div>
            </div>
        </div>
    </div>

    <!-- Law Explorer Modal -->
    <div id="lawExplorerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">법령 조문 탐색기</span>
                <button type="button" id="closeLawExplorerModal" class="close-modal-btn" title="닫기">&times;</button>
            </div>
            <ul class="tab-list" id="lawTabList"></ul>
            <div class="tab-contents" id="lawTabContents"></div>
        </div>
    </div>

    <!-- JSON Modal -->
    <div id="jsonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="jsonModalTitle" class="modal-title">JSON 데이터</span>
                <button type="button" id="closeJsonModalBtn" class="close-modal-btn" title="닫기">&times;</button>
            </div>
            <pre id="jsonDisplayArea"></pre>
        </div>
    </div>

    <script>
        // 상단 변수 및 함수 유지 (검색, 다운로드 부분)
        const apiKeyInput = document.getElementById('apiKey');
        const searchQueryInput = document.getElementById('searchQuery');
        const searchButton = document.getElementById('searchButton');
        const clearSearchQueryButton = document.getElementById('clearSearchQueryButton');
        const resultsList = document.getElementById('results-list');
        const statusMessage = document.getElementById('statusMessage');
        const downloadButton = document.getElementById('downloadButton');
        const clearSelectionButton = document.getElementById('clearSelectionButton');
        const selectedCountSpan = document.getElementById('selectedCount');
        const actualDownloadContainer = document.getElementById('actualDownloadContainer');
        const API_KEY_STORAGE_KEY = 'lawDownloaderApiKey_v2';

        let currentResults = [];

        function _ensureListJs(data) {
            if (data === null || typeof data === 'undefined') return [];
            return Array.isArray(data) ? data : [data];
        }

        function stripHtml(html) {
            if (!html) return "";
            const tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            let text = tmp.textContent || tmp.innerText || "";
            text = text.replace(/&nbsp;/g, ' ').replace(/&lt;/g, '<')
                       .replace(/&gt;/g, '>').replace(/&amp;/g, '&');
            text = text.replace(/[ \t]{2,}/g, ' ');
            text = text.replace(/\n{3,}/g, '\n\n');
            return text.trim();
        }

        function flattenContentForDisplay(dataItem, cleanHtml = true) {
            let lines = [];
            function recurse(item) {
                if (typeof item === 'string') {
                    const cleaned = cleanHtml ? stripHtml(item) : item;
                    if (cleaned.trim()) lines.push(cleaned.trim());
                } else if (Array.isArray(item)) {
                    item.forEach(recurse);
                } else if (typeof item === 'object' && item !== null) {
                    Object.values(item).forEach(recurse);
                } else if (item !== null && typeof item !== 'undefined') {
                    const cleaned = cleanHtml ? stripHtml(String(item)) : String(item);
                    if (cleaned.trim()) lines.push(cleaned.trim());
                }
            }
            recurse(dataItem);
            return lines.join('\n');
        }

        function setStatus(message, type = 'info', targetElement = statusMessage) {
            targetElement.textContent = message;
            targetElement.className = 'status-message';
            if (type === 'error') {
                targetElement.classList.add('error-message');
            } else if (type === 'success') {
                targetElement.classList.add('success-message');
            }
        }

        function toggleInputsDisabled(disabled) {
            apiKeyInput.disabled = disabled;
            searchQueryInput.disabled = disabled;
            searchButton.disabled = disabled;
        }

        function toggleDownloadControlsDisabled(disabled) {
            downloadButton.disabled = disabled;
            clearSelectionButton.disabled = disabled;
            resultsList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = disabled);
        }

        async function makeApiRequest(endpoint, params, itemNameForLog = null, itemTypeForLog = null, retries = 2, timeout = 20000, attemptDelay = 1500) {
            const currentApiKeyVal = apiKeyInput.value.trim();
            if (!currentApiKeyVal) {
                const apiKeyError = new Error("API 키가 입력되지 않았습니다. API 키를 입력 후 다시 시도해주세요.");
                apiKeyError.isAuthError = true;
                throw apiKeyError;
            }

            const clonedParams = { ...params };
            clonedParams["OC"] = currentApiKeyVal;
            clonedParams["type"] = "JSON";
            const queryParams = new URLSearchParams(clonedParams);
            const url = `https://www.law.go.kr/DRF/${endpoint}?${queryParams.toString()}`;
            let lastError = null;
            const logPrefix = itemNameForLog ? `'${itemNameForLog}' (${itemTypeForLog || '항목'})` : `[${endpoint}]`;

            for (let attempt = 0; attempt <= retries; attempt++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                try {
                    if (attempt > 0) {
                        const delay = attemptDelay * attempt;
                        setStatus(`${logPrefix} 요청 재시도 (${attempt}/${retries})...`, 'info', statusMessage);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        let errorData;
                        try { errorData = await response.json(); } catch (e) {}
                        let errorMsg = `${logPrefix} API 요청 실패 (${response.status} ${response.statusText})`;
                        if (errorData?.Error?.message) errorMsg += `: ${errorData.Error.message}`;

                        if (response.status === 401 || response.status === 403) {
                            errorMsg += ` - API 키가 유효하지 않거나 권한이 없을 수 있습니다. 확인 후 다시 시도해주세요.`;
                            const authError = new Error(errorMsg);
                            authError.isAuthError = true;
                            throw authError;
                        }
                        lastError = new Error(errorMsg);
                        if (attempt >= retries) throw lastError;
                        continue;
                    }
                    const data = await response.json();
                    if (data.Error) {
                        const apiError = new Error(`${logPrefix} API 서버 오류: ${data.Error.message} (코드: ${data.Error.errorCode})`);
                        apiError.isApiError = true;
                        lastError = apiError;
                        if (attempt >= retries) throw lastError;
                        continue;
                    }

                    const mainDataKey = endpoint === "lawSearch.do" ? (clonedParams.target === "law" ? "LawSearch" : "AdmRulSearch")
                                        : (clonedParams.target === "law" ? "법령" : "AdmRulService");

                    if (!data[mainDataKey] && (Object.keys(data).length <= 2 && (data.hasOwnProperty(mainDataKey.toUpperCase()) || data.hasOwnProperty("TYPE")))) {
                         return { _isEmptyResult: true, ...data };
                    }
                    return data;

                } catch (error) {
                    clearTimeout(timeoutId);
                    lastError = error;
                    if (error.isAuthError) throw error;
                    if (error.name === 'AbortError') {
                        lastError = new Error(`${logPrefix} 요청 시간 초과 (${timeout/1000}초)`);
                        lastError.isTimeout = true;
                    } else if (!(error instanceof Error)) {
                        lastError = new Error(`${logPrefix} 네트워크 또는 알 수 없는 오류: ${String(error)}`);
                    }
                    if (attempt >= retries) {
                        const finalErrorMsg = `${logPrefix} 상세 정보 가져오기 실패 (모든 재시도 후): ${lastError.message}`;
                        const finalError = new Error(finalErrorMsg);
                        finalError.originalErrorName = lastError.name;
                        finalError.isTimeout = !!lastError.isTimeout;
                        finalError.isAuthError = !!lastError.isAuthError;
                        finalError.isApiError = !!lastError.isApiError;
                        throw finalError;
                    }
                }
            }
            const ultimateFallbackError = new Error(`${logPrefix} 요청이 모든 재시도 후에도 실패했습니다.`);
            ultimateFallbackError.originalError = lastError;
            throw ultimateFallbackError;
        }

        // 검색 처리 (로직 유지)
        searchButton.addEventListener('click', async () => {
            const rawQueryInput = searchQueryInput.value.trim();
            if (!rawQueryInput) {
                setStatus("검색어를 입력해주세요.", 'error'); searchQueryInput.focus(); return;
            }
            const currentApiKey = apiKeyInput.value.trim();
            if (!currentApiKey) {
                setStatus("API 키를 입력해주세요.", 'error'); apiKeyInput.focus(); return;
            }
            const queries = rawQueryInput.split(',').map(q => q.trim()).filter(q => q.length > 0);
            if (queries.length === 0) {
                setStatus("유효한 검색어가 없습니다.", 'error'); searchQueryInput.focus(); return;
            }

            setStatus(`총 ${queries.length}개의 검색어 처리 시작...`, 'info');
            resultsList.innerHTML = ''; currentResults = []; updateSelectedCount();
            toggleInputsDisabled(true); toggleDownloadControlsDisabled(true);

            let allCombinedResultsAccumulator = [];
            let queryErrorMessages = [];
            let successfullyProcessedQueries = 0;

            try {
                for (let i = 0; i < queries.length; i++) {
                    const query = queries[i];
                    setStatus(`"${query}" 검색 중 (${i + 1}/${queries.length})...`, 'info');

                    const lawParams = {"target": "law", "query": query, "display": 20, "searchTp": "1"};
                    const admrulParams = {"target": "admrul", "query": query, "display": 20};
                    let lawErrorForThisQuery = null;
                    let admrulErrorForThisQuery = null;

                    const [lawData, admrulData] = await Promise.all([
                        makeApiRequest("lawSearch.do", lawParams, `법령 "${query}"`, "검색").catch(e => {
                            lawErrorForThisQuery = e.message;
                            if (e.isAuthError) throw e;
                            return null;
                        }),
                        makeApiRequest("lawSearch.do", admrulParams, `행정규칙 "${query}"`, "검색").catch(e => {
                            admrulErrorForThisQuery = e.message;
                            if (e.isAuthError) throw e;
                            return null;
                        })
                    ]);

                    let resultsForThisQuery = [];
                    if (lawData?._isEmptyResult) { }
                    else if (lawData?.LawSearch?.law) {
                        _ensureListJs(lawData.LawSearch.law).forEach(item => resultsForThisQuery.push({
                            id: item.법령일련번호, name: stripHtml(item.법령명한글), date: item.시행일자,
                            type: 'law', typeDisplay: '법령'
                        }));
                    } else if (!lawErrorForThisQuery) {
                        lawErrorForThisQuery = `법령 검색 ("${query}"): 알 수 없는 응답 또는 결과 없음.`;
                    }

                    if (admrulData?._isEmptyResult) { }
                    else if (admrulData?.AdmRulSearch?.admrul) {
                        _ensureListJs(admrulData.AdmRulSearch.admrul).forEach(item => resultsForThisQuery.push({
                            id: item.행정규칙일련번호, name: stripHtml(item.행정규칙명), date: item.발령일자,
                            type: 'admrul', typeDisplay: '행정규칙'
                        }));
                    } else if (!admrulErrorForThisQuery) {
                        admrulErrorForThisQuery = `행정규칙 검색 ("${query}"): 알 수 없는 응답 또는 결과 없음.`;
                    }

                    if (lawErrorForThisQuery) queryErrorMessages.push(lawErrorForThisQuery);
                    if (admrulErrorForThisQuery) queryErrorMessages.push(admrulErrorForThisQuery);
                    if (resultsForThisQuery.length > 0) allCombinedResultsAccumulator.push(...resultsForThisQuery);
                    if (!lawErrorForThisQuery && !admrulErrorForThisQuery) successfullyProcessedQueries++;
                }

                const uniqueResults = []; const seenItems = new Set();
                for (const item of allCombinedResultsAccumulator) {
                    const uniqueKey = `${item.type}_${item.id}`;
                    if (!seenItems.has(uniqueKey)) { uniqueResults.push(item); seenItems.add(uniqueKey); }
                }
                currentResults = uniqueResults; renderResults(currentResults);

                let finalStatusMsg = ""; let finalStatusType = 'info';
                if (currentResults.length > 0) {
                    finalStatusMsg = `총 ${queries.length}개 검색어 중 ${successfullyProcessedQueries}개 처리 완료. ${currentResults.length}개의 고유 결과를 찾았습니다.`;
                    finalStatusType = 'success'; toggleDownloadControlsDisabled(false);
                } else if (successfullyProcessedQueries === queries.length && queryErrorMessages.length === 0) {
                    finalStatusMsg = `총 ${queries.length}개 검색어에 대해 결과가 없습니다.`;
                } else {
                    finalStatusMsg = `검색 중 문제가 발생했습니다.`;
                    finalStatusType = 'error';
                }
                if (queryErrorMessages.length > 0) {
                    const errorSummary = queryErrorMessages.join("\n");
                    finalStatusMsg += `\n\n[발생한 오류 요약]\n${errorSummary}`;
                    finalStatusType = 'error';
                }
                setStatus(finalStatusMsg.trim() || "검색 완료.", finalStatusType);

            } catch (error) {
                console.error("전체 검색 처리 중 치명적 오류:", error);
                let displayErrorMessage = `검색 중 치명적 오류 발생: ${error.message}`;
                if (error.isAuthError) {
                    displayErrorMessage = `API 인증 오류: ${error.message}. API 키를 확인 후 다시 시도해주세요.`;
                    apiKeyInput.focus();
                }
                setStatus(displayErrorMessage, 'error');
                currentResults = []; renderResults(currentResults);
            } finally {
                toggleInputsDisabled(false);
            }
        });

        // 검색어 지우기 버튼
        clearSearchQueryButton.addEventListener('click', () => {
            searchQueryInput.value = '';
            clearSearchQueryButton.style.display = 'none';
            searchQueryInput.focus();
        });
        searchQueryInput.addEventListener('input', () => {
            clearSearchQueryButton.style.display = searchQueryInput.value ? 'block' : 'none';
        });

        function updateSelectedCount() {
            const count = resultsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)').length;
            selectedCountSpan.textContent = count;
            const hasResults = currentResults && currentResults.length > 0;
            downloadButton.disabled = !(hasResults && count > 0);
            clearSelectionButton.disabled = !(hasResults && count > 0);
        }
        resultsList.addEventListener('change', updateSelectedCount);

        function renderResults(results) {
            resultsList.innerHTML = '';
            if (!results || results.length === 0) { updateSelectedCount(); return; }
            results.forEach((item, index) => {
                const li = document.createElement('li');
                li.setAttribute('role', 'listitem');

                const checkboxWrapper = document.createElement('div');
                checkboxWrapper.className = 'result-item-checkbox-wrapper';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `item-${index}`;
                checkbox.dataset.docId = item.id;
                checkbox.dataset.docType = item.type;
                checkbox.dataset.docName = item.name;
                checkbox.setAttribute('aria-labelledby', `item-name-${index}`);
                checkboxWrapper.appendChild(checkbox);

                const mainContentDiv = document.createElement('div');
                mainContentDiv.className = 'result-item-main';

                const nameLabel = document.createElement('label');
                nameLabel.htmlFor = `item-${index}`;
                nameLabel.id = `item-name-${index}`;
                nameLabel.className = 'item-name';
                nameLabel.textContent = item.name;
                mainContentDiv.appendChild(nameLabel);

                const metaSpan = document.createElement('span');
                metaSpan.className = 'item-meta';
                metaSpan.textContent = `${item.typeDisplay} | ${item.type === 'law' ? '시행일' : '발령일'}: ${item.date || '정보없음'}`;
                mainContentDiv.appendChild(metaSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'result-item-actions';

                const exploreButton = document.createElement('button');
                exploreButton.textContent = '조문 탐색';
                exploreButton.className = 'btn btn-explore';
                exploreButton.type = 'button';
                exploreButton.title = `${item.name} 조문 탐색하기`;
                exploreButton.setAttribute('aria-label', `${item.name} 조문 탐색`);
                exploreButton.addEventListener('click', (e) => {
                    e.stopPropagation(); openLawExplorer(item);
                });
                actionsDiv.appendChild(exploreButton);

                const jsonButton = document.createElement('button');
                jsonButton.type = 'button';
                jsonButton.className = 'icon-btn';
                jsonButton.title = `${item.name} JSON 데이터 보기`;
                jsonButton.setAttribute('aria-label', `${item.name} JSON 데이터 보기`);
                jsonButton.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.62001 3.95995C9.22001 3.55995 8.62001 3.55995 8.22001 3.95995L3.51001 8.67995C2.82001 9.35995 2.82001 10.53 3.51001 11.21L8.18001 15.89C8.58001 16.29 9.18001 16.29 9.58001 15.89L10.01 15.46C10.35 15.12 10.31 14.56 9.93001 14.26L6.21001 11.12C6.08001 11.01 6.08001 10.82 6.21001 10.71L9.89001 7.59995C10.28 7.29995 10.32 6.73995 9.97001 6.40995L9.62001 3.95995Z" fill="currentColor"/>
                    <path d="M14.38 3.95995C14.78 3.55995 15.38 3.55995 15.78 3.95995L20.49 8.67995C21.18 9.35995 21.18 10.53 20.49 11.21L15.82 15.89C15.42 16.29 14.82 16.29 14.42 15.89L13.99 15.46C13.65 15.12 13.69 14.56 14.07 14.26L17.79 11.12C17.92 11.01 17.92 10.82 17.79 10.71L14.11 7.59995C13.72 7.29995 13.68 6.73995 14.03 6.40995L14.38 3.95995Z" fill="currentColor"/>
                </svg>`;
                jsonButton.addEventListener('click', (e) => {
                    e.stopPropagation(); showLawJsonModal(item);
                });
                actionsDiv.appendChild(jsonButton);

                const linkButton = document.createElement('button');
                linkButton.type = 'button';
                linkButton.className = 'icon-btn';
                linkButton.title = `${item.name} 국가법령정보센터에서 보기`;
                linkButton.setAttribute('aria-label', `${item.name} 국가법령정보센터에서 보기`);
                linkButton.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.54 10.4601L21.0001 2.99996M21.0001 2.99996H16.54M21.0001 2.99996V7.46005M11.2501 2.99996H6.90008C5.01008 2.99996 3.45008 4.55996 3.45008 6.44996V17.55C3.45008 19.44 5.01008 21 6.90008 21H18.0001C19.8901 21 21.4501 19.44 21.4501 17.55V12.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`;
                linkButton.addEventListener('click', (e) => {
                    e.stopPropagation(); openLawPageLink(item);
                });
                actionsDiv.appendChild(linkButton);

                li.appendChild(checkboxWrapper);
                li.appendChild(mainContentDiv);
                mainContentDiv.appendChild(actionsDiv);

                li.addEventListener('click', (e) => {
                    if (e.target !== checkbox && !actionsDiv.contains(e.target) && !checkbox.disabled) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
                resultsList.appendChild(li);
            });
            updateSelectedCount();
        }

        clearSelectionButton.addEventListener('click', () => {
            if (clearSelectionButton.disabled) return;
            resultsList.querySelectorAll('input[type="checkbox"]:not(:disabled)').forEach(cb => {
                cb.checked = false; cb.dispatchEvent(new Event('change', { bubbles: true }));
            });
        });

        // 다운로드 로직 (기존 그대로)
        downloadButton.addEventListener('click', async () => {
            actualDownloadContainer.innerHTML = '';

            const selectedItems = [];
            resultsList.querySelectorAll('input[type="checkbox"]:checked:not(:disabled)').forEach(cb => {
                selectedItems.push({ id: cb.dataset.docId, type: cb.dataset.docType, name: cb.dataset.docName });
            });

            if (selectedItems.length === 0) {
                setStatus("다운로드할 항목을 선택해주세요.", 'error');
                return;
            }

            setStatus(`선택된 ${selectedItems.length}개 항목 처리 시작...`, 'info');
            toggleDownloadControlsDisabled(true); toggleInputsDisabled(true);

            let 통합본문 = "";
            let fileNames = [];
            let totalErrorOccurred = false, successfulFetches = 0;
            const CHUNK_SIZE = 5;
            const resultsMap = new Map();
            let authErrorDuringDownload = false;

            for (let i = 0; i < selectedItems.length; i += CHUNK_SIZE) {
                if (authErrorDuringDownload) break;
                const chunkSelectedItems = selectedItems.slice(i, i + CHUNK_SIZE);
                const chunkIndices = Array.from({ length: chunkSelectedItems.length }, (_, k) => i + k);
                setStatus(`항목 ${i + 1}부터 ${Math.min(i + CHUNK_SIZE, selectedItems.length)}/${selectedItems.length} 상세 정보 가져오는 중...`, 'info');

                const chunkPromises = chunkSelectedItems.map(async (item, localIndex) => {
                    const originalIndex = chunkIndices[localIndex];
                    const itemTypeDisplay = item.type === 'law' ? '법령' : '행정규칙';
                    try {
                        let detailDataRoot;
                        if (item.type === 'law') {
                            const jsonData = await makeApiRequest("lawService.do", { "target": "law", "MST": item.id }, item.name, itemTypeDisplay);
                            if (jsonData?._isEmptyResult || !jsonData?.법령) detailDataRoot = { _isEmptyResult: true, 기본정보: { 법령명한글: item.name } };
                            else detailDataRoot = jsonData.법령;
                        } else if (item.type === 'admrul') {
                            const data = await makeApiRequest("lawService.do", { "target": "admrul", "ID": item.id }, item.name, itemTypeDisplay);
                            if (data?._isEmptyResult || !data?.AdmRulService) detailDataRoot = { _isEmptyResult: true, 기본정보: { 행정규칙명: item.name } };
                            else detailDataRoot = data.AdmRulService;
                        } else {
                            throw new Error(`알 수 없는 항목 타입: ${item.type}`);
                        }

                        let 본문내용섹션 = "";
                        const itemName = detailDataRoot?.기본정보?.법령명한글 || detailDataRoot?.기본정보?.행정규칙명 || item.name;
                        본문내용섹션 += `--- ${itemName} (${itemTypeDisplay} ID: ${item.id}) ---\n\n`;

                        if (detailDataRoot._isEmptyResult) {
                             본문내용섹션 += "[API에서 빈 결과를 반환했거나 주요 데이터가 없습니다. 상세 내용이 없을 수 있습니다.]\n\n";
                        } else {
                            if (item.type === 'law' && detailDataRoot) {
                                if (detailDataRoot.조문?.조문단위) {
                                    본문내용섹션 += "## 본문 (조문)\n";
                                    _ensureListJs(detailDataRoot.조문.조문단위).forEach(jo => {
                                        본문내용섹션 += `**제${jo.조문번호}조` + (jo.조문제목 ? `(${stripHtml(jo.조문제목)})` : '') + '**\n' + flattenContentForDisplay(jo.조문내용 || "") + "\n";
                                        if (jo.항) {
                                            _ensureListJs(jo.항).forEach(hang => {
                                                본문내용섹션 += `* ${flattenContentForDisplay(hang.항내용 || "").trim()}\n`;
                                                if (hang.호) {
                                                    _ensureListJs(hang.호).forEach(ho => {
                                                        본문내용섹션 += `  - ${flattenContentForDisplay(ho.호내용 || "").trim()}\n`;
                                                        if (ho.목) {
                                                            _ensureListJs(ho.목).forEach(mok => {
                                                                본문내용섹션 += `    • ${flattenContentForDisplay(mok.목내용 || "").trim()}\n`;
                                                            });
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                        본문내용섹션 += "\n";
                                    });
                                }
                                if (detailDataRoot.부칙?.부칙단위) { 본문내용섹션 += "## 부칙\n"; _ensureListJs(detailDataRoot.부칙.부칙단위).forEach(bu => { 본문내용섹션 += `**부칙 (${bu.부칙공포일자 || ''})**\n${flattenContentForDisplay(bu.부칙내용 || "")}\n\n`; });}
                                if (detailDataRoot.제개정이유?.제개정이유내용) 본문내용섹션 += "## 제개정 이유\n" + flattenContentForDisplay(detailDataRoot.제개정이유.제개정이유내용) + "\n\n";
                            } else if (item.type === 'admrul' && detailDataRoot) {
                                if (detailDataRoot.조문내용) 본문내용섹션 += "## 본문\n" + flattenContentForDisplay(detailDataRoot.조문내용) + "\n\n";
                                if (detailDataRoot.행정규칙부칙?.부칙단위) { 본문내용섹션 += "## 부칙\n"; _ensureListJs(detailDataRoot.행정규칙부칙.부칙단위).forEach(bu => { 본문내용섹션 += `**부칙 (${bu.부칙키 || bu.부칙공포일자 || ''})**\n${flattenContentForDisplay(bu.부칙내용 || "")}\n\n`;});}
                                const 이유내용 = detailDataRoot.제개정이유?.제개정이유내용 || detailDataRoot.행정규칙제개정이유?.제개정이유내용;
                                if (이유내용) 본문내용섹션 += "## 제개정 이유\n" + flattenContentForDisplay(이유내용) + "\n\n";
                            }
                        }
                        return { originalIndex, success: true, content: 본문내용섹션.trimEnd() + "\n\n@@@@\n\n", name: item.name };
                    } catch (error) {
                        if (error.isAuthError) authErrorDuringDownload = true;
                        let userFriendlyErrorMsg = error.message || "알 수 없는 오류";
                        if (error.message?.includes("상세 정보 가져오기 실패")) {
                             userFriendlyErrorMsg = error.message.substring(error.message.indexOf(":") + 2).trim();
                        } else if (error.isTimeout) userFriendlyErrorMsg = `요청 시간 초과로 실패했습니다 (재시도 포함).`;
                        else if (error.isAuthError) userFriendlyErrorMsg = `API 인증 오류가 발생했습니다. API 키를 확인해주세요.`;
                        return { originalIndex, success: false, errorContent: `--- ${item.name} (${itemTypeDisplay}, ID: ${item.id}) ---\n[오류: ${userFriendlyErrorMsg}]\n\n@@@@\n\n`, name: item.name };
                    }
                });
                const chunkPromiseResults = await Promise.all(chunkPromises);
                for (const result of chunkPromiseResults) {
                    resultsMap.set(result.originalIndex, result);
                }
                if (authErrorDuringDownload) {
                    setStatus("API 인증 오류가 발생하여 다운로드를 중단합니다. API 키를 확인해주세요.", "error");
                    break;
                }
            }

            if (!authErrorDuringDownload) {
                for (let i = 0; i < selectedItems.length; i++) {
                    const result = resultsMap.get(i);
                    if (result) {
                        if (result.success) {
                            통합본문 += result.content;
                            fileNames.push(result.name.replace(/[\\/*?:"<>|]/g, "").substring(0, 20).trim());
                            successfulFetches++;
                        } else {
                            통합본문 += result.errorContent;
                            fileNames.push(result.name.replace(/[\\/*?:"<>|]/g, "").substring(0, 20).trim() + "_오류");
                            totalErrorOccurred = true;
                        }
                    } else {
                        const item = selectedItems[i];
                        통합본문 += `--- ${item.name} (ID: ${item.id}) ---\n[결과 처리 중 알 수 없는 누락 발생]\n\n@@@@\n\n`;
                        fileNames.push(item.name.replace(/[\\/*?:"<>|]/g, "").substring(0, 20).trim() + "_누락");
                        totalErrorOccurred = true;
                    }
                }

                if (통합본문.endsWith("\n\n@@@@\n\n")) 통합본문 = 통합본문.slice(0, -"\n\n@@@@\n\n".length + 2);
                else if (통합본문.endsWith("@@@@\n\n")) 통합본문 = 통합본문.slice(0, -"\n\n@@@@\n\n".length);

                if (통합본문.trim().length === 0 && successfulFetches === 0 && selectedItems.length > 0) {
                    setStatus(`선택된 ${selectedItems.length}개 항목에 대해 다운로드할 내용이 없거나 모든 항목 처리 중 오류가 발생했습니다. 콘솔 로그를 확인해주세요.`, 'error');
                    totalErrorOccurred = true;
                } else {
                    let finalFileName = fileNames.filter(Boolean).join("_").substring(0, 100).trim() || "통합문서";
                    finalFileName = finalFileName.replace(/__+/g, '_') + ".txt";

                    const blob = new Blob([통합본문], { type: 'text/plain;charset=utf-8' });
                    const blobUrl = URL.createObjectURL(blob);

                    const downloadLink = document.createElement('a');
                    downloadLink.href = blobUrl;
                    downloadLink.download = finalFileName;
                    downloadLink.textContent = "다운로드";
                    downloadLink.className = "btn btn-primary";
                    actualDownloadContainer.appendChild(downloadLink);

                    let downloadOutcomeMsg = "";
                    let downloadOutcomeType = 'info';
                    if (successfulFetches > 0 && !totalErrorOccurred) {
                        downloadOutcomeMsg = `통합 파일 '${finalFileName}' 준비 완료! 아래 버튼을 클릭하여 다운로드하세요. (${successfulFetches}개 항목 성공)`;
                        downloadOutcomeType = 'success';
                    } else if (successfulFetches > 0 && totalErrorOccurred) {
                        downloadOutcomeMsg = `일부 항목 오류와 함께 '${finalFileName}' 준비 완료되었습니다. (성공: ${successfulFetches}/${selectedItems.length}개). 아래 버튼으로 다운로드하세요.`;
                        downloadOutcomeType = 'error';
                    } else if (successfulFetches === 0 && totalErrorOccurred) {
                        downloadOutcomeMsg = `모든 항목 처리 중 오류 발생. '${finalFileName}' 파일이 생성되었지만 내용이 오류 정보일 수 있습니다. 아래 버튼으로 다운로드하세요.`;
                        downloadOutcomeType = 'error';
                    } else if (successfulFetches === 0 && !totalErrorOccurred && selectedItems.length > 0) {
                        downloadOutcomeMsg = `'${finalFileName}' 파일 준비 완료. 모든 항목이 비어있거나 내용이 없습니다. (${successfulFetches}/${selectedItems.length}개 처리). 아래 버튼으로 다운로드하세요.`;
                        downloadOutcomeType = 'info';
                    }

                    setStatus(downloadOutcomeMsg, downloadOutcomeType);
                }
            }

            toggleDownloadControlsDisabled(false);
            toggleInputsDisabled(false);
            updateSelectedCount();
        });

        if (statusMessage) {
             setStatus("API 키와 검색어를 입력 후 검색하세요. 검색 결과에서 '조문 탐색' 버튼으로 탐색기를 이용할 수 있습니다.", 'info');
        }

        // 로컬스토리지에서 API 키 로드/저장
        function loadApiKey() {
            const storedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (storedApiKey) apiKeyInput.value = storedApiKey;
        }
        function saveApiKey() {
            const keyToSave = apiKeyInput.value.trim();
            if (keyToSave) {
                localStorage.setItem(API_KEY_STORAGE_KEY, keyToSave);
            } else {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
            }
        }
        apiKeyInput.addEventListener('input', saveApiKey);
        window.addEventListener('load', loadApiKey);

        // ------------------------------
        // 법령 탐색 모달 및 탭 구현
        // ------------------------------
        const lawExplorerModal = document.getElementById('lawExplorerModal');
        const closeLawExplorerModalBtn = document.getElementById('closeLawExplorerModal');
        const lawTabList = document.getElementById('lawTabList');
        const lawTabContents = document.getElementById('lawTabContents');

        // Map to store 로드된 법령/규칙 데이터
        const lawDataMap = new Map();

        // 탭 클릭 시 활성화
        lawTabList.addEventListener('click', (e) => {
            if (e.target.tagName === 'LI') {
                const tabId = e.target.dataset.tabId;
                activateTab(tabId);
            }
        });

        // 모달 닫기
        closeLawExplorerModalBtn.addEventListener('click', () => {
            lawExplorerModal.style.display = 'none';
        });
        window.addEventListener('click', (e) => {
            if (e.target === lawExplorerModal) {
                lawExplorerModal.style.display = 'none';
            }
        });

        /**
         * 새로운 법령/규칙 탭 생성 및 데이터 로드
         * @param {Object} item - { id, name, type, typeDisplay }
         */
        async function openLawExplorer(item) {
            const tabId = `${item.type}_${item.id}`;
            // 이미 탭이 존재하면 활성화만
            if (lawDataMap.has(tabId)) {
                activateTab(tabId);
                lawExplorerModal.style.display = 'flex';
                return;
            }

            // 탭 요소 생성
            const tabElement = document.createElement('li');
            tabElement.textContent = item.name;
            tabElement.dataset.tabId = tabId;
            tabElement.title = item.name;
            lawTabList.appendChild(tabElement);

            // 탭 콘텐츠 영역 생성
            const contentDiv = document.createElement('div');
            contentDiv.className = 'tab-content';
            contentDiv.id = `content_${tabId}`;
            lawTabContents.appendChild(contentDiv);

            // 저장
            lawDataMap.set(tabId, { item, data: null });

            activateTab(tabId);
            lawExplorerModal.style.display = 'flex';
            await loadLawDataIntoTab(tabId);
        }

        /**
         * 탭 활성화: 버튼 스타일 변경 및 콘텐츠 토글
         * @param {string} tabId
         */
        function activateTab(tabId) {
            // 모든 탭 비활성화
            lawTabList.querySelectorAll('li').forEach(li => {
                li.classList.toggle('active', li.dataset.tabId === tabId);
            });
            // 모든 콘텐츠 비활성화
            lawTabContents.querySelectorAll('.tab-content').forEach(div => {
                div.classList.toggle('active', div.id === `content_${tabId}`);
            });
        }

        /**
         * 법령/규칙 데이터 로드 및 UI 구성
         * @param {string} tabId
         */
        async function loadLawDataIntoTab(tabId) {
            const { item } = lawDataMap.get(tabId);
            const contentDiv = document.getElementById(`content_${tabId}`);
            contentDiv.innerHTML = `<p>데이터를 불러오는 중입니다...</p>`;

            try {
                let params = {};
                if (item.type === 'law') {
                    params = { "target": "law", "MST": item.id, "display": 200, "JOSEY": "조문키,조문번호,조문제목,조문내용,조문여부,항번호,항내용,호번호,호내용,목번호,목내용" };
                } else {
                    params = { "target": "admrul", "ID": item.id, "display": 200 };
                }
                const lawData = await makeApiRequest("lawService.do", params, item.name, item.typeDisplay);

                let selectedData = null;
                if (item.type === 'law' && lawData && lawData.법령) {
                    selectedData = lawData.법령;
                } else if (item.type === 'admrul' && lawData && lawData.AdmRulService) {
                    selectedData = lawData.AdmRulService;
                } else if (lawData && lawData._isEmptyResult) {
                    contentDiv.innerHTML = `<p>해당 법령/규칙의 상세 정보가 제공되지 않습니다.</p>`;
                    lawDataMap.set(tabId, { item, data: null });
                    return;
                } else {
                    throw new Error("법령 상세 정보 형식이 올바르지 않거나 비어있습니다.");
                }

                // 저장된 데이터 업데이트
                lawDataMap.set(tabId, { item, data: selectedData });
                renderTabContent(tabId);

            } catch (error) {
                console.error(`탭 ${tabId} 데이터 로드 오류:`, error);
                contentDiv.innerHTML = `<p>오류 발생: ${error.message}</p>`;
            }
        }

        /**
         * 탭 콘텐츠 렌더링: 범위 입력 및 결과 표시
         * @param {string} tabId
         */
        function renderTabContent(tabId) {
            const { item, data } = lawDataMap.get(tabId);
            const contentDiv = document.getElementById(`content_${tabId}`);
            contentDiv.innerHTML = '';

            if (!data) {
                contentDiv.innerHTML = `<p>데이터가 없습니다.</p>`;
                return;
            }

            // 범위 입력 UI (한 줄로)
            const rangeContainer = document.createElement('div');
            rangeContainer.className = 'range-input-container';

            if (item.type === 'law') {
                const startLabel = document.createElement('label');
                startLabel.textContent = '제';
                const startInput = document.createElement('input');
                startInput.type = 'number';
                startInput.min = '1';
                startInput.className = 'range-input';
                startInput.placeholder = '시작조문';
                startInput.id = `start_${tabId}`;

                const tilde = document.createElement('span');
                tilde.textContent = '~';

                const endInput = document.createElement('input');
                endInput.type = 'number';
                endInput.min = '1';
                endInput.className = 'range-input';
                endInput.placeholder = '끝조문';
                endInput.id = `end_${tabId}`;

                rangeContainer.appendChild(startLabel);
                rangeContainer.appendChild(startInput);
                rangeContainer.appendChild(tilde);
                rangeContainer.appendChild(endInput);

                // 즉각 렌더링
                startInput.addEventListener('input', () => {
                    const startVal = parseInt(startInput.value, 10);
                    const endVal = parseInt(endInput.value, 10);
                    if (!isNaN(startVal) && (isNaN(endVal) || endVal < startVal)) {
                        displaySingleArticle(tabId, startVal);
                    } else if (!isNaN(startVal) && !isNaN(endVal)) {
                        displayLawRange(tabId);
                    }
                });
                endInput.addEventListener('input', () => {
                    const startVal = parseInt(startInput.value, 10);
                    const endVal = parseInt(endInput.value, 10);
                    if (!isNaN(startVal) && !isNaN(endVal)) {
                        displayLawRange(tabId);
                    }
                });
            } else {
                const infoP = document.createElement('p');
                infoP.textContent = '이 행정규칙은 조문 범위 조회를 지원하지 않습니다. 아래 전체 내용을 확인하세요.';
                rangeContainer.appendChild(infoP);
            }

            // 복사 버튼
            const copyBtn = document.createElement('button');
            copyBtn.textContent = '복사';
            copyBtn.className = 'copy-btn';
            copyBtn.addEventListener('click', () => {
                copyProvisions(tabId);
            });
            rangeContainer.appendChild(copyBtn);

            // 콘텐츠 표시 영역
            const displayArea = document.createElement('div');
            displayArea.id = `display_${tabId}`;
            displayArea.style.flex = '1';

            contentDiv.appendChild(rangeContainer);
            contentDiv.appendChild(displayArea);

            // 초기 로드
            if (item.type === 'admrul') {
                displayFullAdmrul(tabId);
            }
        }

        /**
         * 단일 조문 바로 렌더링
         * @param {string} tabId
         * @param {number} joNumber
         */
        function displaySingleArticle(tabId, joNumber) {
            const { data } = lawDataMap.get(tabId);
            const displayArea = document.getElementById(`display_${tabId}`);
            if (!data) {
                displayArea.innerHTML = `<p>데이터가 없습니다.</p>`;
                return;
            }
            const articles = _ensureListJs(data.조문?.조문단위);
            const matched = articles.filter(jo => parseInt(jo.조문번호, 10) === joNumber);
            if (!matched.length) {
                displayArea.innerHTML = `<p>제${joNumber}조를 찾을 수 없습니다.</p>`;
                return;
            }
            displayArea.innerHTML = '';
            matched.forEach((jo, idx) => {
                const block = document.createElement('div');
                block.className = 'provision-block';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'provision-title';
                titleDiv.textContent = jo.조문여부 === '전문' 
                    ? stripHtml(jo.조문내용 || '') 
                    : `제${jo.조문번호}조 ${jo.조문제목 ? `(${stripHtml(jo.조문제목)})` : ''}`;
                block.appendChild(titleDiv);

                let joContent = jo.조문여부 !== '전문' ? stripHtml(jo.조문내용 || '') : '';
                if (joContent) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'provision-content';
                    contentDiv.textContent = joContent;
                    block.appendChild(contentDiv);
                }

                const hangs = _ensureListJs(jo.항);
                hangs.forEach(hang => {
                    const hangDiv = document.createElement('div');
                    hangDiv.className = 'provision-sub-item';
                    hangDiv.innerHTML = `${stripHtml(hang.항내용 || '')}`;
                    block.appendChild(hangDiv);

                    const hos = _ensureListJs(hang.호);
                    hos.forEach(ho => {
                        const hoDiv = document.createElement('div');
                        hoDiv.className = 'provision-sub-sub-item';
                        hoDiv.innerHTML = ` ${stripHtml(ho.호내용 || '')}`;
                        block.appendChild(hoDiv);

                        const moks = _ensureListJs(ho.목);
                        moks.forEach(mok => {
                            const mokDiv = document.createElement('div');
                            mokDiv.className = 'provision-sub-sub-item';
                            mokDiv.style.marginLeft = '4rem';
                            mokDiv.innerHTML = ` ${stripHtml(mok.목내용 || '')}`;
                            block.appendChild(mokDiv);
                        });
                    });
                });

                displayArea.appendChild(block);
                if (idx < matched.length - 1) {
                    const hr = document.createElement('hr');
                    hr.style.border = '0';
                    hr.style.height = '1px';
                    hr.style.backgroundColor = 'var(--color-border-subtle)';
                    hr.style.margin = 'calc(var(--spacing-base)*2) 0';
                    displayArea.appendChild(hr);
                }
            });
        }

        /**
         * 법령 조문 범위에 맞게 표시
         * @param {string} tabId
         */
        function displayLawRange(tabId) {
            const { data } = lawDataMap.get(tabId);
            const startVal = parseInt(document.getElementById(`start_${tabId}`).value, 10);
            const endVal = parseInt(document.getElementById(`end_${tabId}`).value, 10);
            const displayArea = document.getElementById(`display_${tabId}`);

            if (isNaN(startVal) || isNaN(endVal) || startVal < 1 || endVal < startVal) {
                displayArea.innerHTML = `<p style="color: var(--color-error);">유효한 범위를 입력하세요. (예: 1 ~ 200)</p>`;
                return;
            }

            const articles = _ensureListJs(data.조문?.조문단위);
            if (!articles.length) {
                displayArea.innerHTML = `<p>조문 정보가 없습니다.</p>`;
                return;
            }

            const filtered = articles.filter(jo => {
                const num = parseInt(jo.조문번호, 10);
                return !isNaN(num) && num >= startVal && num <= endVal;
            });

            if (!filtered.length) {
                displayArea.innerHTML = `<p>제${startVal}조부터 제${endVal}조 사이에 해당하는 조문을 찾을 수 없습니다.</p>`;
                return;
            }

            displayArea.innerHTML = '';
            filtered.forEach((jo, idx) => {
                const block = document.createElement('div');
                block.className = 'provision-block';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'provision-title';
                titleDiv.textContent = jo.조문여부 === '전문' 
                    ? stripHtml(jo.조문내용 || '') 
                    : `제${jo.조문번호}조 ${jo.조문제목 ? `(${stripHtml(jo.조문제목)})` : ''}`;
                block.appendChild(titleDiv);

                let joContent = jo.조문여부 !== '전문' ? stripHtml(jo.조문내용 || '') : '';
                if (joContent) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'provision-content';
                    contentDiv.textContent = joContent;
                    block.appendChild(contentDiv);
                }

                const hangs = _ensureListJs(jo.항);
                hangs.forEach(hang => {
                    const hangDiv = document.createElement('div');
                    hangDiv.className = 'provision-sub-item';
                    hangDiv.innerHTML = `${stripHtml(hang.항내용 || '')}`;
                    block.appendChild(hangDiv);

                    const hos = _ensureListJs(hang.호);
                    hos.forEach(ho => {
                        const hoDiv = document.createElement('div');
                        hoDiv.className = 'provision-sub-sub-item';
                        hoDiv.innerHTML = `${stripHtml(ho.호내용 || '')}`;
                        block.appendChild(hoDiv);

                        const moks = _ensureListJs(ho.목);
                        moks.forEach(mok => {
                            const mokDiv = document.createElement('div');
                            mokDiv.className = 'provision-sub-sub-item';
                            mokDiv.style.marginLeft = '4rem';
                            mokDiv.innerHTML = `${stripHtml(mok.목내용 || '')}`;
                            block.appendChild(mokDiv);
                        });
                    });
                });

                displayArea.appendChild(block);
                if (idx < filtered.length - 1) {
                    const hr = document.createElement('hr');
                    hr.style.border = '0';
                    hr.style.height = '1px';
                    hr.style.backgroundColor = 'var(--color-border-subtle)';
                    hr.style.margin = 'calc(var(--spacing-base)*2) 0';
                    displayArea.appendChild(hr);
                }
            });
        }

        /**
         * 행정규칙 전체 내용 표시
         * @param {string} tabId
         */
        function displayFullAdmrul(tabId) {
            const { data } = lawDataMap.get(tabId);
            const displayArea = document.getElementById(`display_${tabId}`);
            const content = data.조문내용 ? stripHtml(data.조문내용) : '본문 내용이 없습니다.';
            displayArea.innerHTML = `<div class="provision-content">${content}</div>`;
        }

        /**
         * 표시된 조문 내용 복사 (Android 호환성 강화)
         * @param {string} tabId
         */
        function copyProvisions(tabId) {
            const displayArea = document.getElementById(`display_${tabId}`);
            const textToCopy = displayArea.innerText;
            if (!textToCopy) return;

            // Android를 위한 execCommand 복사
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('조문 내용이 클립보드에 복사되었습니다.');
                } else {
                    alert('복사에 실패했습니다. 수동으로 복사해 주세요.');
                }
            } catch (err) {
                alert('복사 중 오류 발생: ' + err);
            }
            document.body.removeChild(textarea);
        }

        // JSON Modal 관련
        const jsonModal = document.getElementById('jsonModal');
        const jsonModalTitle = document.getElementById('jsonModalTitle');
        const jsonDisplayArea = document.getElementById('jsonDisplayArea');
        const closeJsonModalBtn = document.getElementById('closeJsonModalBtn');

        async function showLawJsonModal(item) {
            setStatus("JSON 데이터 로딩 중...", "info");
            jsonModalTitle.textContent = `"${item.name}" (${item.typeDisplay}) JSON 데이터`;
            jsonDisplayArea.textContent = "로딩 중...";
            jsonModal.style.display = "flex";

            try {
                let params = {};
                if (item.type === 'law') {
                    params = {"target": "law", "MST": item.id, "display": 200, "JOSEY": "조문키,조문번호,조문제목,조문내용,조문여부,항번호,항내용,호번호,호내용,목번호,목내용"};
                } else if (item.type === 'admrul') {
                    params = {"target": "admrul", "ID": item.id, "display": 200};
                } else {
                    throw new Error("알 수 없는 항목 타입");
                }
                const data = await makeApiRequest("lawService.do", params, item.name, `${item.typeDisplay} JSON`);
                jsonDisplayArea.textContent = JSON.stringify(data, null, 2);
                setStatus("JSON 데이터 로딩 완료.", "success");
            } catch (error) {
                jsonDisplayArea.textContent = `JSON 데이터를 가져오는 데 실패했습니다.\n오류: ${error.message}`;
                setStatus(`JSON 데이터 로딩 실패: ${error.message}`, "error");
            }
        }

        closeJsonModalBtn.addEventListener('click', () => {
            jsonModal.style.display = "none";
        });
        window.addEventListener('click', (event) => {
            if (event.target === jsonModal) {
                jsonModal.style.display = "none";
            }
        });

        // 외부 링크 열기
        function openLawPageLink(item) {
            let url = "";
            if (item.type === 'law') {
                url = `https://www.law.go.kr/LSW/lsInfoP.do?lsiSeq=${item.id}&viewCls=lsRvsDocInfoR`;
            } else if (item.type === 'admrul') {
                url = `https://www.law.go.kr/LSW/admRulInfoP.do?admRulSeq=${item.id}`;
            }
            if (url) {
                window.open(url, '_blank', 'noopener,noreferrer');
            } else {
                setStatus("해당 항목의 외부 링크를 생성할 수 없습니다.", "error");
            }
        }
    </script>
</body>
</html>
