<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base App (Firebase v1)</title>
    <!-- 1. Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- 3. Marked.js (Markdown Renderer) CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- ğŸ“Œ [NEW] Firebase v8 SDK (v9 ëª¨ë“ˆ ë°©ì‹ì€ ì´ íŒŒì¼ êµ¬ì¡°ì—ì„œ ë³µì¡í•¨) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* ... (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë™ì¼) ... */
        body {
            font-family: 'Inter', 'Pretendard', sans-serif;
            -webkit-font-smoothing: antialiased; /* iOS/Mac ê°€ë…ì„± í–¥ìƒ */
            -moz-osx-font-smoothing: grayscale;
        }

        /* ğŸ“Œ [NEW] A. ì„¤ì • íƒ­(Settings) UI ìŠ¤íƒ€ì¼ */
        #settings-nav button {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-align: left;
            font-weight: 500;
            color: #374151; /* text-gray-700 */
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
        }
        #settings-nav button:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }
        #settings-nav button.settings-nav-active {
            background-color: #e0f2fe; /* bg-sky-100 */
            color: #0c4a6e; /* text-sky-800 */
            font-weight: 600;
        }

        /* ğŸ“Œ [NEW] B. ë·°ì–´(Viewer) ê°€ë…ì„± í–¥ìƒ ìŠ¤íƒ€ì¼ */
        /* ğŸ“Œ [FIX] ëª¨ë“  ì„ íƒìë¥¼ #c03-body ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½ */
        #c03-body h1,
        #c03-body h2,
        #c03-body h3,
        #c03-body h4,
        #c03-body h5,
        #c03-body h6 {
            font-weight: 700;
            letter-spacing: -0.025em; /* tracking-tight */
            color: #1f2937; /* text-gray-900 */
        }
        #c03-body h1 {
            font-size: 2.25rem; /* text-4xl */
            line-height: 2.5rem;
            margin-top: 2rem; /* my-8 */
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
            padding-bottom: 0.75rem;
        }
        #c03-body h2 {
            font-size: 1.875rem; /* text-3xl */
            line-height: 2.25rem;
            margin-top: 2.5rem; /* mt-10 */
            margin-bottom: 1rem; /* mb-4 */
        }
        #c03-body h3 {
            font-size: 1.5rem; /* text-2xl */
            line-height: 2rem;
            margin-top: 2rem; /* mt-8 */
            margin-bottom: 0.75rem; /* mb-3 */
        }
        #c03-body h4 {
            font-size: 1.25rem; /* text-xl */
            line-height: 1.75rem;
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        #c03-body p {
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75; /* leading-loose (1.75) */
            color: #374151; /* text-gray-700 */
            margin-top: 1.25rem; /* my-5 */
            margin-bottom: 1.25rem;
        }
        #c03-body ul,
        #c03-body ol {
            font-size: 1.125rem; /* text-lg */
            color: #374151; /* text-gray-700 */
            margin-top: 1.25rem; /* my-5 */
            margin-bottom: 1.25rem;
            padding-left: 1.75rem; /* pl-7 */
        }
        #c03-body ul {
            list-style-type: disc;
        }
        #c03-body ol {
            list-style-type: decimal;
        }
        #c03-body li {
            padding-left: 0.5rem; /* pl-2 */
            margin-top: 0.75rem; /* space-y-3 */
        }
        #c03-body li > p {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        #c03-body li::marker {
            color: #6b7280; /* text-gray-500 */
        }
        /* ìš”ì•½(c03-summary)ì´ ì•„ë‹Œ, ì¼ë°˜ blockquote ìŠ¤íƒ€ì¼ */
        #c03-body blockquote {
            margin-top: 1.5rem; /* my-6 */
            margin-bottom: 1.5rem;
            padding-left: 1.25rem; /* pl-5 */
            border-left-width: 4px;
            border-color: #d1d5db; /* border-gray-300 */
            font-style: italic;
            color: #4b5563; /* text-gray-600 */
        }
        #c03-body blockquote p {
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75;
        }
        /* ì¸ë¼ì¸ ì½”ë“œ */
        #c03-body code:not(pre *) {
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 0.9em; /* text-sm ëŒ€ë¹„ ì‚´ì§ ì‘ê²Œ */
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #dc2626; /* text-red-600 */
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            border-radius: 0.375rem; /* rounded-md */
            word-break: break-all;
        }
        /* ì½”ë“œ ë¸”ë¡ */
        #c03-body pre {
            background-color: #1f2937; /* bg-gray-800 */
            color: #f3f4f6; /* text-gray-100 */
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            overflow-x: auto;
            margin-top: 1.5rem; /* my-6 */
            margin-bottom: 1.5rem;
        }
        #c03-body pre code {
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* leading-relaxed */
            background-color: transparent !important;
            color: inherit !important;
            padding: 0 !important;
        }
        #c03-body a {
            color: #2563eb; /* text-blue-600 */
            text-decoration: underline;
            font-weight: 500;
        }
        #c03-body a:hover {
            color: #1d4ed8; /* text-blue-700 */
        }
        #c03-body hr {
            margin-top: 2rem; /* my-8 */
            margin-bottom: 2rem;
            border-top: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .analyzing-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .note-item-active {
            background-color: #e0f2fe;
        }
        .folder-drag-over {
            background-color: #dbeafe;
            outline: 2px dashed #3b82f6;
        }
        .folder-item .folder-actions {
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
        }
        .folder-item:hover .folder-actions {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 antialiased">

    <!-- 
    ğŸ“Œ [MODIFIED] ì „ì—­ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ (ìµœëŒ€ ë„ˆë¹„ ì ìš©)
    - max-w-7xl: ì™€ì´ë“œ ìŠ¤í¬ë¦°ì—ì„œ ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šê²Œ ìµœëŒ€ ë„ˆë¹„ ì„¤ì •
    - mx-auto: ê°€ìš´ë° ì •ë ¬
    - shadow-2xl: ì‹œê°ì  êµ¬ë¶„ì„ ìœ„í•œ ê·¸ë¦¼ì (ì„ íƒ ì‚¬í•­)
    -->
    <div id="app" class="h-screen w-full max-w-7xl mx-auto shadow-2xl bg-gray-100">

        <!-- 
        ============================================================
        [NEW] V-00: ë¡œê·¸ì¸ ë·° (Login View)
        ============================================================
        -->
        <div id="view-login" class="hidden flex flex-col h-screen items-center justify-center text-center p-6">
            <i class="bi bi-journal-richtext text-8xl text-gray-300 mb-6"></i>
            <h1 class="text-4xl font-bold text-gray-800 mb-4">Knowledge Base</h1>
            <p class="text-lg text-gray-600 mb-8">Firebaseì™€ AIë¡œ êµ¬ë™ë˜ëŠ” ê°œì¸ìš© ë…¸íŠ¸ ì•±</p>
            
            <button id="btn-google-login" class="flex items-center justify-center bg-white text-gray-700 px-6 py-3 rounded-lg shadow-md hover:shadow-lg transition duration-150 border border-gray-300">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
            
            <p class="text-gray-500 text-sm mt-8">
                Firebase ì„¤ì •ì´ í•„ìš”í•˜ì‹ ê°€ìš”? 
                <a href="#/settings" id="btn-goto-settings-from-login" class="text-blue-600 hover:underline">ì„¤ì • í™”ë©´ìœ¼ë¡œ ì´ë™</a>
            </p>
        </div>


        <!-- V-01: ëŒ€ì‹œë³´ë“œ ë·° (Dashboard View) -->
        <div id="view-dashboard" class="hidden flex flex-col h-screen">
            <!-- 
            ğŸ“Œ [MODIFIED] V-01 í—¤ë” (ì‚¬ìš©ì ì •ë³´ í‘œì‹œ)
            -->
            <header class="flex-shrink-0 bg-white border-b border-gray-200 p-3 flex justify-between items-center shadow-sm">
                <div class="flex items-center space-x-4">
                    <!-- ğŸ“Œ [NEW] Hamburger Menu Button (Mobile) -->
                    <button id="btn-hamburger" class="md:hidden flex items-center justify-center w-10 h-10 text-gray-700 rounded-lg hover:bg-gray-100">
                        <i class="bi bi-list text-2xl"></i>
                    </button>
                    <button id="btn-new-note" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition duration-150">
                        <i class="bi bi-plus-lg mr-2"></i>
                        ì‹ ê·œ ë…¸íŠ¸
                    </button>
                    <div class="relative">
                        <input type="text" placeholder="ê¸€ë¡œë²Œ ê²€ìƒ‰ (TBD)..." class="pl-8 pr-3 py-2 border border-gray-300 rounded-lg text-sm w-64" disabled>
                        <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <!-- ğŸ“Œ [NEW] ì‚¬ìš©ì ì •ë³´ ë° ì„¤ì • ë²„íŠ¼ -->
                <div id="user-profile-area" class="flex items-center space-x-3">
                    <span id="user-display-name" class="text-sm font-medium text-gray-700 hidden"></span>
                    <img id="user-avatar" class="w-8 h-8 rounded-full hidden" alt="User Avatar">
                    <a href="#/settings" id="btn-settings" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200" title="ì„¤ì •">
                        <i class="bi bi-gear-fill text-xl"></i>
                    </a>
                </div>
            </header>
            
            <!-- ... (V-01 main íƒœê·¸ ë° í•˜ìœ„ êµ¬ì¡°ëŠ” ê¸°ì¡´ê³¼ ë™ì¼) ... -->
            <main class="flex-1 grid grid-cols-1 md:grid-cols-12 overflow-hidden">
                <div id="main-sidebar" class="fixed inset-y-0 left-0 z-30 w-full max-w-xs transform -translate-x-full bg-gray-50 border-r border-gray-200 flex flex-col h-full transition-transform duration-300 md:relative md:translate-x-0 md:max-w-none md:inset-auto md:z-auto md:col-span-4">
                    <nav id="c01-nav-pane" class="flex flex-col h-1/2 overflow-y-auto">
                        <div class="p-3 sticky top-0 bg-gray-50 z-10 border-b border-gray-200">
                            <div class="relative">
                                <input type="text" id="c06-nav-search" placeholder="í´ë”/íƒœê·¸ ê²€ìƒ‰..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="flex-1 p-3 space-y-4">
                            <ul class="space-y-1">
                                <li><a href="#" data-filter-type="all" class="nav-filter-btn flex items-center px-3 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium"><i class="bi bi-journal-text w-6 text-gray-600"></i> ëª¨ë“  ë…¸íŠ¸</a></li>
                                <!-- ğŸ“Œ [MODIFIED] 'ë¯¸ë¶„ë¥˜'ì— data-folder-id="root" ì¶”ê°€ (í´ë” ë“œë¡­ìš©) -->
                                <li><a href="#" data-filter-type="category" data-filter-value="root" class="nav-filter-btn flex items-center px-3 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium" data-folder-id="root"><i class="bi bi-archive w-6 text-gray-600"></i> ë¯¸ë¶„ë¥˜</a></li>
                            </ul>
                            <div>
                                <div class="flex justify-between items-center px-3 mb-2">
                                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">í´ë”</h3>
                                    <button id="nav-new-folder-btn" class="c12-btn text-gray-500 hover:text-blue-600" title="ì‹ ê·œ í´ë”">
                                        <i class="bi bi-folder-plus"></i>
                                    </button>
                                </div>
                                <div id="c01-folder-tree" class="space-y-0.5">
                                    <!-- JSë¡œ ë™ì  ë Œë”ë§ë¨ -->
                                </div>
                            </div>
                            <div>
                                <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">íƒœê·¸</h3>
                                <div id="c01-tag-list" class="space-y-1">
                                    <!-- JSë¡œ ë™ì  ë Œë”ë§ë¨ -->
                                </div>
                            </div>
                        </div>
                        <div class="p-3 mt-auto border-t border-gray-200 sticky bottom-0 bg-gray-50">
                            <a href="#/manage" id="btn-manage-nav" class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium text-gray-700">
                                <i class="bi bi-gear w-6 text-gray-600"></i> íƒœê·¸ ê´€ë¦¬
                            </a>
                        </div>
                    </nav>
                    <div class="h-2 flex-shrink-0 bg-gray-100 border-t border-b border-gray-200 cursor-n-resize" title="Drag to resize (TBD)"></div>
                    <aside id="c02-note-list-pane" class="flex flex-col h-1/2 overflow-y-auto">
                        <div class="p-3 sticky top-0 bg-gray-50 z-10 border-b border-gray-200">
                            <h2 id="c02-header" class="text-lg font-semibold text-gray-800 mb-3">ëª¨ë“  ë…¸íŠ¸</h2>
                            <div class="relative">
                                <input type="text" id="c02-note-search" placeholder="ë…¸íŠ¸ ê²€ìƒ‰ (ì œëª©, ë³¸ë¬¸)..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div id="c02-note-list" class="flex-1 divide-y divide-gray-200">
                            <!-- C-07: Note List Item (JSë¡œ ë™ì  ë Œë”ë§ë¨) -->
                        </div>
                    </aside>
                </div>
                <section id="c03-viewer-pane" class="md:col-span-8 bg-white h-full overflow-y-auto flex flex-col">
                    <div id="c09-viewer-header" class="hidden p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                    </div>
                    <div id="c03-viewer-content" class="flex-1 p-6 md:p-10">
                        <div id="c03-welcome-screen" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                            <i class="bi bi-journal-richtext text-6xl text-gray-300 mb-4"></i>
                            <h2 class="text-2xl font-semibold">Knowledge Base</h2>
                            <p class="mt-2">ì¢Œì¸¡ì—ì„œ ë…¸íŠ¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ 'ì‹ ê·œ ë…¸íŠ¸'ë¥¼ ì‘ì„±í•˜ì„¸ìš”.</p>
                        </div>
                        <!-- ğŸ“Œ [MODIFIED] ë·°ì–´ ê°€ë…ì„± ë˜í¼ (max-w-75ch) -->
                        <div id="c03-note-content" class="hidden mx-auto max-w-[75ch]">
                            <blockquote id="c03-summary" class="border-l-4 border-blue-300 bg-blue-50 p-4 text-blue-800 rounded-r-lg"></blockquote>
                            <div id="c03-tags-top" class="flex flex-wrap gap-2 my-4"></div>
                            <!-- ğŸ“Œ [MODIFIED] ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ì€ ì—¬ê¸°ì— ì£¼ì…ë¨ (#c03-body) -->
                            <div id="c03-body" class="mt-6"></div>
                            <hr class="my-8">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">ì—°ê´€ ë¬¸ì„œ</h3>
                            <div id="c03-related-docs" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- V-02: ì—ë””í„° ë·° (Editor View) - (ê¸°ì¡´ê³¼ ë™ì¼) -->
        <div id="view-editor" class="hidden flex flex-col h-screen bg-gray-50">
            <!-- ... (V-02 ë‚´ìš©ì€ ê¸°ì¡´ê³¼ ë™ì¼) ... -->
            <header id="c04-editor-header" class="flex-shrink-0 bg-white border-b border-gray-200 p-3 flex justify-between items-center shadow-sm sticky top-0 z-10">
                <div>
                    <button id="editor-cancel-btn" class="text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition duration-150">ì·¨ì†Œ</button>
                </div>
                <div>
                    <button id="editor-delete-btn" class="text-red-600 px-4 py-2 rounded-lg hover:bg-red-50 transition duration-150 mr-2 hidden">
                        <i class="bi bi-trash mr-1"></i> ì‚­ì œ
                    </button>
                    <button id="editor-save-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition duration-150 disabled:opacity-50" disabled>
                        <i class="bi bi-check-lg mr-1"></i> ì €ì¥
                    </button>
                </div>
            </header>
            <form id="editor-form" class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 p-6 overflow-y-auto">
                <div class="lg:col-span-8 space-y-6">
                    <input type="text" id="editor-title" name="title" placeholder="ë…¸íŠ¸ ì œëª©" class="w-full text-3xl font-bold p-2 border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none bg-transparent">
                    <textarea id="editor-body" name="body" placeholder="ë³¸ë¬¸ ë‚´ìš©ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”..." class="w-full h-[60vh] lg:h-[70vh] p-4 border border-gray-300 rounded-lg text-base leading-relaxed focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner"></textarea>
                </div>
                <div class="lg:col-span-4 space-y-6 bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-fit sticky top-24">
                    <div>
                        <label for="editor-summary" class="block text-sm font-medium text-gray-700 mb-1">ìš”ì•½</label>
                        <textarea id="editor-summary" name="summary" rows="3" placeholder="ë…¸íŠ¸ ìš”ì•½..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="editor-category" class="block text-sm font-medium text-gray-700 mb-1">í´ë” (ì˜ˆ: Work/ProjectA)</label>
                        <input type="text" id="editor-category" name="category" placeholder="ê²½ë¡œ ì…ë ¥ (ì—†ìœ¼ë©´ ë¯¸ë¶„ë¥˜)" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" list="category-datalist">
                        <datalist id="category-datalist"></datalist>
                    </div>
                    <div>
                        <label for="editor-tags" class="block text-sm font-medium text-gray-700 mb-1">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="text" id="editor-tags" name="tags" placeholder="ì˜ˆ: react, ai, javascript" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" list="tag-datalist">
                        <datalist id="tag-datalist"></datalist>
                    </div>
                </div>
            </form>
        </div>

        <!-- V-03: ë¶„ë¥˜ ê´€ë¦¬ ë·° (íƒœê·¸ ì „ìš©) - (ê¸°ì¡´ê³¼ ë™ì¼) -->
        <div id="view-management" class="hidden flex flex-col h-screen">
            <!-- ... (V-03 ë‚´ìš©ì€ ê¸°ì¡´ê³¼ ë™ì¼) ... -->
            <header class="flex-shrink-0 bg-white border-b border-gray-200 p-3 flex items-center shadow-sm">
                <button id="btn-back-to-dashboard" class="flex items-center text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-50 transition duration-150">
                    <i class="bi bi-arrow-left mr-2"></i>
                    ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </button>
                <h1 class="text-xl font-semibold mx-auto">íƒœê·¸ ê´€ë¦¬</h1>
            </header>
            <main class="flex-1 p-6 overflow-y-auto bg-gray-50 flex justify-center">
                <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col w-full max-w-2xl">
                    <h2 class="text-xl font-semibold mb-4">íƒœê·¸ ê´€ë¦¬</h2>
                    <div class="relative mb-4">
                        <input type="text" id="c06-tag-manage-search" placeholder="íƒœê·¸ ê²€ìƒ‰..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div id="management-tag-list" class="flex-1 overflow-y-auto divide-y divide-gray-100 pr-2">
                        <!-- JS ë Œë”ë§ -->
                    </div>
                </section>
            </main>
        </div>
        
        <!-- 
        ============================================================
        ğŸ“Œ [MODIFIED] V-04: ì„¤ì • ë·° (Firebase ì„¤ì • ë° ì¸ì¦)
        ============================================================
        -->
        <div id="view-settings" class="hidden flex flex-col h-screen">
            <!-- ìƒë‹¨ í—¤ë” -->
            <header class="flex-shrink-0 bg-white border-b border-gray-200 p-3 flex items-center shadow-sm">
                <button id="settings-back-btn" class="flex items-center text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-50 transition duration-150">
                    <i class="bi bi-arrow-left mr-2"></i>
                    ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </button>
                <h1 class="text-xl font-semibold mx-auto">ì„¤ì •</h1>
            </header>
            <!-- ğŸ“Œ [MODIFIED] ì„¤ì • í¼ (2ë‹¨ íƒ­ ë ˆì´ì•„ì›ƒ) -->
            <main class="flex-1 p-6 md:p-10 overflow-y-auto bg-gray-50">
                <div class="max-w-6xl mx-auto flex flex-col md:flex-row md:space-x-8">
                    
                    <!-- 1. ì„¤ì • íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                    <nav id="settings-nav" class="md:w-1/4 flex-shrink-0 mb-6 md:mb-0">
                        <div class="space-y-1">
                            <button type="button" data-section="firebase" class="settings-nav-active">
                                <i class="bi bi-fire w-5 mr-3"></i> Firebase
                            </button>
                            <button type="button" data-section="account">
                                <i class="bi bi-person-circle w-5 mr-3"></i> ê³„ì •
                            </button>
                            <button type="button" data-section="ai">
                                <i class="bi bi-robot w-5 mr-3"></i> AI / í”„ë¡¬í”„íŠ¸
                            </button>
                        </div>
                    </nav>

                    <!-- 2. ì„¤ì • ì»¨í…íŠ¸ ì˜ì—­ -->
                    <div class="md:w-3/4 bg-white p-6 md:p-8 rounded-lg shadow-sm border border-gray-200">
                        
                        <!-- 2-A. Firebase ì„¤ì • íƒ­ -->
                        <section id="settings-section-firebase" class="settings-section space-y-6">
                            <h2 class="text-2xl font-semibold text-gray-900 border-b pb-3">Firebase ì„¤ì •</h2>
                            <div>
                                <label for="settings-firebase-config" class="block text-sm font-medium text-gray-700 mb-1">Firebase ì„¤ì • (JSON/JS)</label>
                                <textarea id="settings-firebase-config" rows="10" class="w-full p-2 border border-gray-300 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ 'firebaseConfig' ë³€ìˆ˜ ì„ ì–¸ë¬¸(const firebaseConfig = {...}) ë˜ëŠ” JSON ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                                <p class="text-xs text-gray-500 mt-2">ì´ ì„¤ì •ì€ ë¸Œë¼ìš°ì €ì˜ `localStorage`ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                                <button id="settings-save-firebase-config-btn" type="button" class="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-700 transition duration-150">
                                    Firebase ì„¤ì • ì €ì¥ (ë° ìƒˆë¡œê³ ì¹¨)
                                </button>
                            </div>
                        </section>

                        <!-- 2-B. ê³„ì • ì„¤ì • íƒ­ -->
                        <section id="settings-section-account" class="settings-section space-y-6 hidden">
                            <h2 class="text-2xl font-semibold text-gray-900 border-b pb-3">ê³„ì • ê´€ë¦¬</h2>
                            <div id="settings-auth-section" class="space-y-3">
                                <div id="settings-user-info" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <img id="settings-user-avatar" class="w-10 h-10 rounded-full" alt="User Avatar">
                                    <div>
                                        <div id="settings-user-name" class="font-semibold text-gray-800"></div>
                                        <div id="settings-user-email" class="text-sm text-gray-600"></div>
                                    </div>
                                </div>
                                <button id="settings-logout-btn" type="button" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-700 transition duration-150">
                                    ë¡œê·¸ì•„ì›ƒ
                                </button>
                            </div>
                        </section>
                        
                        <!-- 2-C. AI/í”„ë¡¬í”„íŠ¸ ì„¤ì • íƒ­ (form íƒœê·¸ëŠ” ì´ ì„¹ì…˜ë§Œ ê°ìŒ‰ë‹ˆë‹¤) -->
                        <form id="settings-form">
                            <section id="settings-section-ai" class="settings-section space-y-6 hidden">
                                <h2 class="text-2xl font-semibold text-gray-900 border-b pb-3">AI / í”„ë¡¬í”„íŠ¸ ì„¤ì •</h2>
                                
                                <!-- Gemini API í‚¤ -->
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-medium text-gray-700">Gemini API í‚¤ (Firestoreì— ì €ì¥)</label>
                                        <button type="button" id="settings-add-api-key-btn" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                            <i class="bi bi-plus-circle-fill mr-1"></i> API í‚¤ ì¶”ê°€
                                        </button>
                                    </div>
                                    <div id="settings-api-key-list" class="space-y-3">
                                        <!-- JSë¡œ ë™ì  ë Œë”ë§ë¨ -->
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">API í‚¤ëŠ” **Firestore**ì˜ ì‚¬ìš©ì ë¬¸ì„œì— ì•”í˜¸í™”ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                                </div>
        
                                <!-- AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ -->
                                <div>
                                    <label for="settings-system-prompt" class="block text-sm font-medium text-gray-700 mb-1">AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
                                    <textarea id="settings-system-prompt" name="aiSystemPrompt" rows="12" class="w-full p-2 border border-gray-300 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                
                                <!-- AI ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ -->
                                <div>
                                    <label for="settings-user-prompt" class="block text-sm font-medium text-gray-700 mb-1">AI ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</label>
                                    <textarea id="settings-user-prompt" name="aiUserPromptTemplate" rows="14" class="w-full p-2 border border-gray-300 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    <p class="text-xs text-gray-500 mt-1">
                                        ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:
                                        <code class="text-xs text-red-600 bg-gray-100 px-1 py-0.5 rounded">{{TITLE}}</code>,
                                        <code class="text-xs text-red-600 bg-gray-100 px-1 py-0.5 rounded">{{BODY}}</code>,
                                        <code class="text-xs text-red-600 bg-gray-100 px-1 py-0.5 rounded">{{OTHER_NOTES_JSON}}</code>,
                                        <code class="text-xs text-red-600 bg-gray-100 px-1 py-0.5 rounded">{{VFS_STRUCTURE_JSON}}</code>
                                    </p>
                                </div>
        
                                <!-- ì €ì¥ ë²„íŠ¼ -->
                                <div class="flex justify-end pt-4 border-t">
                                    <button id="settings-save-ai-btn" type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition duration-150">
                                        AI/í”„ë¡¬í”„íŠ¸ ì„¤ì • ì €ì¥
                                    </button>
                                </div>
                            </section>
                        </form>
                        
                    </div>
                </div>
            </main>
        </div>

        <div id="sidebar-backdrop" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-20 md:hidden"></div>
        <!-- C-13: Toast (Non-blocking Notification) - (ê¸°ì¡´ê³¼ ë™ì¼) -->
        <div id="c13-toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white z-50 transition-all duration-300">
            <!-- ... (Toast ë‚´ìš©ì€ ê¸°ì¡´ê³¼ ë™ì¼) ... -->
            <span id="c13-toast-icon" class="mr-2"></span>
            <span id="c13-toast-message"></span>
        </div>

        <!-- C-14: Modal (ì…ë ¥ í•„ë“œ ì¶”ê°€) - (ê¸°ì¡´ê³¼ ë™ì¼) -->
        <div id="c14-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <!-- ... (Modal ë‚´ìš©ì€ ê¸°ì¡´ê³¼ ë™ì¼) ... -->
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                <h3 id="c14-modal-title" class="text-lg font-semibold mb-2"></h3>
                <p id="c14-modal-content" class="text-sm text-gray-700 mb-4"></p>
                <input type="text" id="c14-modal-input" class="hidden w-full p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="">
                <div class="flex justify-end space-x-3">
                    <button id="c14-modal-cancel" class="text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition duration-150">ì·¨ì†Œ</button>
                    <button id="c14-modal-confirm" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition duration-150">í™•ì¸</button>
                </div>
            </div>
        </div>

    </div>

    <!-- 
    ============================================================
    ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
    ============================================================
    ğŸ“Œ [MODIFIED] v8: ë²„ê·¸ ìˆ˜ì • ë° UI/UX ê°œì„ 
    - (v7) Firebase (Firestore, Auth) ì—°ë™
    - (v8) ë·°ì–´ ê°€ë…ì„±(íƒ€ì´í¬ê·¸ë˜í”¼) ëŒ€í­ ê°œì„ 
    - (v8) ì„¤ì • íƒ­ UI ê°œí¸
    - (v8) í´ë” -> í´ë” ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë™ ê¸°ëŠ¥
    - (v8) AI í´ë” ë®ì–´ì“°ê¸° ë²„ê·¸ ìˆ˜ì •
    - (v8) 'ì‹ ê·œ í´ë”' ê²½ë¡œ ì§ê´€ì„± ê°œì„ 
    ============================================================
    -->
    <script type="module">
        // ğŸ“Œ [NEW] Firebase ê¸€ë¡œë²Œ ë³€ìˆ˜
        let db, auth;
        let currentUserId = null;
        const FIREBASE_CONFIG_KEY = 'kb_firebaseConfig_v7'; // localStorage í‚¤

        // --- 1. DB (Firestore) ì„œë¹„ìŠ¤ ëª¨ë“ˆ ---
        const dbService = {
            /**
             * ğŸ“Œ [MODIFIED] Firebase ì´ˆê¸°í™”
             * localStorageì—ì„œ configë¥¼ ë¡œë“œí•˜ì—¬ Firebase ì•±ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
             * @returns {boolean} ì´ˆê¸°í™” ì„±ê³µ ì—¬ë¶€
             */
            initDB: () => {
                try {
                    const configStr = localStorage.getItem(FIREBASE_CONFIG_KEY);
                    if (!configStr) {
                        console.warn("Firebase configê°€ localStorageì— ì—†ìŠµë‹ˆë‹¤.");
                        return false;
                    }
                    const firebaseConfig = JSON.parse(configStr);
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    console.log('Firebaseê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return true;
                } catch (error) {
                    console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    localStorage.removeItem(FIREBASE_CONFIG_KEY); // ì˜ëª»ëœ config ì œê±°
                    return false;
                }
            },

            /**
             * ğŸ“Œ [MODIFIED] Firebase Config ì €ì¥ (JS ê°ì²´ íŒŒì‹±)
             * @param {string} configString - Firebase config JSON ë˜ëŠ” JS ê°ì²´ ë¬¸ìì—´
             */
            saveFirebaseConfig: (configString) => {
                let configObj;
                
                // 1. Try parsing as strict JSON
                try {
                    configObj = JSON.parse(configString);
                } catch (e1) {
                    // 2. Try parsing as a JS object literal (e.g., { key: "value" })
                    try {
                        configObj = (new Function('return ' + configString))();
                    } catch (e2) {
                        // 3. Try parsing as a JS variable declaration (e.g., const firebaseConfig = { ... })
                        try {
                            // 'const config = ...' ë˜ëŠ” 'var firebaseConfig = ...'ì™€ ê°™ì€ ë³€ìˆ˜ ì´ë¦„ ì¶”ì¶œ
                            const varNameMatch = configString.match(/(?:const|let|var)\s+([\w$]+)\s*=/);
                            if (varNameMatch && varNameMatch[1]) {
                                const varName = varNameMatch[1];
                                configObj = (new Function(configString + `; return ${varName};`))();
                            } else {
                                throw new Error("Not a recognized variable declaration.");
                            }
                        } catch (e3) {
                            console.error("Firebase config parsing failed all methods:", e1, e2, e3);
                            return false; // ëª¨ë“  íŒŒì‹± ì‹œë„ ì‹¤íŒ¨
                        }
                    }
                }

                // 4. Validation and Storage
                try {
                    if (!configObj || !configObj.apiKey || !configObj.projectId) {
                        throw new Error("í•„ìˆ˜ Firebase config ì†ì„±(apiKey, projectId)ì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    // ğŸ“Œ [MODIFIED] í•­ìƒ í‘œì¤€ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                    localStorage.setItem(FIREBASE_CONFIG_KEY, JSON.stringify(configObj));
                    return true;
                } catch (error) {
                    console.error("Firebase config validation or storage failed:", error);
                    ui.showToast(error.message, "error"); // ğŸ“Œ ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°±
                    return false;
                }
            },

            /**
             * ğŸ“Œ [NEW] Firebase Config ë¡œë“œ
             * @returns {string} ì €ì¥ëœ config JSON ë¬¸ìì—´
             */
            getFirebaseConfig: () => {
                return localStorage.getItem(FIREBASE_CONFIG_KEY) || "";
            },

            /**
             * ğŸ“Œ [NEW] ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
             * @param {function} onAuthStateChangedCallback - ì¸ì¦ ìƒíƒœ ë³€ê²½ ì‹œ í˜¸ì¶œë  ì½œë°± (user ê°ì²´ ì „ë‹¬)
             */
            watchAuth: (onAuthStateChangedCallback) => {
                if (!auth) return;
                auth.onAuthStateChanged(onAuthStateChangedCallback);
            },

            /**
             * ğŸ“Œ [NEW] Google ë¡œê·¸ì¸
             */
            loginWithGoogle: () => {
                if (!auth) return;
                const provider = new firebase.auth.GoogleAuthProvider();
                return auth.signInWithPopup(provider);
            },

            /**
             * ğŸ“Œ [NEW] ë¡œê·¸ì•„ì›ƒ
             */
            logout: () => {
                if (!auth) return;
                return auth.signOut();
            },

            /**
             * ğŸ“Œ [NEW] ì‚¬ìš©ìë³„ Firestore ì»¬ë ‰ì…˜ ë ˆí¼ëŸ°ìŠ¤
             * @param {string} collectionName - ì»¬ë ‰ì…˜ ì´ë¦„ ('notes', 'vfs', 'settings')
             * @returns {firebase.firestore.CollectionReference}
             */
            getCollection: (collectionName) => {
                if (!currentUserId) {
                    throw new Error("ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
                // ëª¨ë“  ë°ì´í„°ë¥¼ ì‚¬ìš©ìë³„ë¡œ ë¶„ë¦¬
                return db.collection('users').doc(currentUserId).collection(collectionName);
            },
            
            // --- ğŸ“Œ [MODIFIED] Notes CRUD ---
            
            /**
             * @param {object} note - note ê°ì²´ (id ì œì™¸)
             * @returns {Promise<string>} ìƒˆë¡œ ìƒì„±ëœ note ID
             */
            addNote: (note) => {
                // FirestoreëŠ” 'id'ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±/ê´€ë¦¬í•©ë‹ˆë‹¤.
                const { id, ...noteData } = note;
                return dbService.getCollection('notes').add(noteData)
                    .then(docRef => docRef.id);
            },
            
            /**
             * @param {object} note - note ê°ì²´ (id í¬í•¨)
             * @returns {Promise<void>}
             */
            updateNote: (note) => {
                const noteId = note.id;
                const { id, ...noteData } = note;
                // .set()ì€ ë¬¸ì„œë¥¼ ë®ì–´ì“°ë¯€ë¡œ, í•„ë“œ ë³‘í•©ì„ ìœ„í•´ { merge: true } ì‚¬ìš©
                return dbService.getCollection('notes').doc(noteId).set(noteData, { merge: true });
            },

            deleteNote: (id) => {
                return dbService.getCollection('notes').doc(id).delete();
            },

            getNote: (id) => {
                return dbService.getCollection('notes').doc(id).get()
                    .then(doc => doc.exists ? { id: doc.id, ...doc.data() } : null);
            },

            getAllNotes: () => {
                return dbService.getCollection('notes').get()
                    .then(snapshot => 
                        snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }))
                    );
            },

            // --- ğŸ“Œ [MODIFIED] VFS (Folders) CRUD ---

            addVfsNode: (node) => {
                // Firestoreê°€ ìë™ IDë¥¼ ìƒì„±í•˜ë„ë¡ `add` ì‚¬ìš©
                const { id, ...nodeData } = node;
                return dbService.getCollection('vfs').add(nodeData)
                    .then(docRef => docRef.id);
            },
            
            updateVfsNode: (node) => {
                const nodeId = node.id;
                const { id, ...nodeData } = node;
                return dbService.getCollection('vfs').doc(nodeId).set(nodeData, { merge: true });
            },

            deleteVfsNode: (id) => {
                return dbService.getCollection('vfs').doc(id).delete();
            },

            getAllVfsNodes: () => {
                return dbService.getCollection('vfs').get()
                    .then(snapshot => 
                        snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }))
                    );
            },
            
            // --- ğŸ“Œ [MODIFIED] Settings (AI Keys, Prompts) CRUD ---

            getSettings: () => {
                // ì„¤ì •ì€ 'default'ë¼ëŠ” IDë¥¼ ê°€ì§„ ë‹¨ì¼ ë¬¸ì„œì— ì €ì¥
                return dbService.getCollection('settings').doc('default').get()
                    .then(doc => doc.exists ? doc.data() : null);
            },
            
            saveSettings: (settingsData) => {
                return dbService.getCollection('settings').doc('default').set(settingsData, { merge: true });
            },
            
            // --- ğŸ“Œ [REMOVED] IndexedDB / ê´€ê³„í˜• Tags í•¨ìˆ˜ë“¤ ---

            // --- ğŸ“Œ [MODIFIED] VFS ìœ í‹¸ë¦¬í‹° (Firestore ID ì‚¬ìš©) ---
            findOrCreateFolderPath: (path, allVfsNodes) => {
                return new Promise(async (resolve, reject) => {
                    let parentId = 'root';
                    const parts = path.split('/').filter(Boolean);
                    
                    for (const part of parts) {
                        // Firestore IDëŠ” ë¬¸ìì—´ì´ë¯€ë¡œ find ë¡œì§ ìˆ˜ì •
                        let node = allVfsNodes.find(n => n.name === part && n.parentId === parentId);
                        
                        if (!node) {
                            const newNodeData = { name: part, parentId: parentId };
                            // Firestoreì— ì¶”ê°€í•˜ê³  ìƒˆ IDë¥¼ ë°›ì•„ì˜´
                            const newId = await dbService.addVfsNode(newNodeData);
                            node = { id: newId, ...newNodeData };
                            allVfsNodes.push(node); // ë¡œì»¬ ìºì‹œì—ë„ ì¶”ê°€
                        }
                        parentId = node.id; // ë‹¤ìŒ ë¶€ëª¨ IDëŠ” ìƒˆ ID(ë¬¸ìì—´)
                    }
                    resolve(parentId); // ìµœì¢… í´ë” ID(ë¬¸ìì—´) ë°˜í™˜
                });
            },

            getFolderPath: (id, allVfsNodes) => {
                if (id === 'root' || !id) return '';
                const path = [];
                let currentId = id;
                let sanityCheck = 0;
                while (currentId !== 'root' && sanityCheck < 10) {
                    const node = allVfsNodes.find(n => n.id === currentId);
                    if (!node) break;
                    path.unshift(node.name);
                    currentId = node.parentId;
                    sanityCheck++;
                }
                return path.join('/');
            },
        };

        // --- 2. ìƒíƒœ(State) ë° í—¬í¼(Helpers) ëª¨ë“ˆ ---
        const DEFAULT_SETTINGS = {
            // ğŸ“Œ [MODIFIED] í•œêµ­ì–´ ë©”íƒ€ë°ì´í„° ìƒì„± ì§€ì‹œ
            aiSystemPrompt: `ë‹¹ì‹ ì€ ì „ë¬¸ ì§€ì‹ ê´€ë¦¬ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì œê³µë˜ëŠ” ë…¸íŠ¸(ì œëª©, ë³¸ë¬¸), ë‹¤ë¥¸ ë¬¸ì„œ ëª©ë¡, í˜„ì¬ í´ë” êµ¬ì¡°(VFS)ë¥¼ ë¶„ì„í•´ì•¼ í•©ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ë…¸íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ *ì˜¤ì§* ë‹¤ìŒ JSON ìŠ¤í‚¤ë§ˆì™€ *ì •í™•íˆ* ì¼ì¹˜í•˜ëŠ” ìœ íš¨í•œ JSON ê°ì²´ë§Œì„ í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:
{
  "suggestedSummary": "ë…¸íŠ¸ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ìš”ì•½í•œ ë¬¸ë‹¨ì…ë‹ˆë‹¤.",
  "suggestedTags": ["íƒœê·¸1", "íƒœê·¸2", "í•µì‹¬í‚¤ì›Œë“œ3"],
  "suggestedRelatedIds": ["noteId1", "noteId2", "noteId3"],
  "suggestedFolderPath": "ì—…ë¬´/í”„ë¡œì íŠ¸/AI"
}
ì§€ì¹¨:
1.  suggestedSummary: [í•œêµ­ì–´]ë¡œ ì‘ì„±ëœ í•œ ë¬¸ë‹¨ì˜ ê°„ê²°í•œ ìš”ì•½.
2.  suggestedTags: [í•œêµ­ì–´]ë¡œ ëœ 3-5ê°œì˜ ê´€ë ¨ í•µì‹¬ í‚¤ì›Œë“œ.
3.  suggestedRelatedIds: 'ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¸ì„œ' ëª©ë¡ì—ì„œ ë§¤ìš° ê´€ë ¨ì„±ì´ ë†’ì€ ë¬¸ì„œì˜ *ë¬¸ìì—´ ID* ë°°ì—´ (ìˆ«ì ì•„ë‹˜).
4.  suggestedFolderPath: ë…¸íŠ¸ ë‚´ìš©ê³¼ 'VFS êµ¬ì¡°'ë¥¼ ë¶„ì„í•˜ì—¬ *ê°€ì¥ ë…¼ë¦¬ì ì¸* í´ë” ê²½ë¡œë¥¼ ì œì•ˆ. ê¸°ì¡´ ê²½ë¡œ ë˜ëŠ” ìƒˆ ê²½ë¡œì¼ ìˆ˜ ìˆìŒ. ì ì ˆí•œ í´ë”ê°€ ì—†ìœ¼ë©´ "" ë¹ˆ ë¬¸ìì—´ ë°˜í™˜. (í´ë” ê²½ë¡œëŠ” ì˜ì–´ë¥¼ ìœ ì§€í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.)`,
            aiUserPromptTemplate: `---
Available Documents (JSON):
{{OTHER_NOTES_JSON}}
---
Current VFS Structure (JSON):
{{VFS_STRUCTURE_JSON}}
---
Analyze this Note:
Title: {{TITLE}}
Body:
{{BODY}}`,
            // ğŸ“Œ [NEW] Gemini API í‚¤ ì„¤ì • ê¸°ë³¸ê°’
            apiKeys: [] // { id, name, key }
        };

        let state = {
            // ğŸ“Œ [NEW] ì¸ì¦/ì´ˆê¸°í™” ìƒíƒœ
            isFirebaseReady: false,
            isLoggedIn: false,
            currentUser: null, // Firebase user ê°ì²´
            
            currentView: 'login',
            notes: [],
            vfsNodes: [],
            tags: [], // {id, name} - ğŸ“Œ [MODIFIED] notesì—ì„œ íŒŒìƒëœ ë‹¨ìˆœ ë°°ì—´
            
            settings: { ...DEFAULT_SETTINGS },
            apiKeyIndex: 0,
            
            expandedFolders: new Set(),
            currentFilter: { type: 'all', value: null }, 
            selectedNoteId: null,
            editingNoteId: null,
            noteSearchTerm: '',
            navSearchTerm: '',
            toastTimeout: null,
            modalConfirmCallback: null,
        };

        const helpers = {
            // (formatDate, summarize, getAiStatusIcon, fetchWithBackoff - ê¸°ì¡´ê³¼ ë™ì¼)
            formatDate: (isoString) => {
                if (!isoString) return '';
                // Firestore Timestamp ê°ì²´ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ .toDate()ë¡œ ë³€í™˜
                const date = (isoString.toDate) ? isoString.toDate() : new Date(isoString);
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                });
            },
            summarize: (text, length = 70) => {
                if (!text) return 'ìš”ì•½ ì—†ìŒ';
                return text.length > length ? text.substring(0, length) + '...' : text;
            },
            getAiStatusIcon: (status) => {
                switch (status) {
                    case 'analyzing':
                        return '<i class="bi bi-arrow-clockwise analyzing-spin text-blue-500" title="AI ë¶„ì„ ì¤‘..."></i>';
                    case 'failed':
                        return '<i class="bi bi-exclamation-triangle-fill text-red-500" title="AI ë¶„ì„ ì‹¤íŒ¨"></i>';
                    case 'complete':
                    default:
                        return '';
                }
            },
            fetchWithBackoff: async (url, options, retries = 3, delay = 1000) => {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if ((response.status === 429 || response.status >= 500) && retries > 0) { 
                            await new Promise(res => setTimeout(res, delay));
                            return helpers.fetchWithBackoff(url, options, retries - 1, delay * 2);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return helpers.fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    console.error("Fetch failed after retries:", error);
                    throw error;
                }
            },

            // ğŸ“Œ [MODIFIED] íƒœê·¸ íŒŒì„œ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ì§€ë§Œ, ì´ì œ ë°°ì—´ì„ ë°˜í™˜)
            sanitizeTags: (tagsString) => {
                return tagsString.split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
            },
            sanitizeCategory: (categoryString) => {
                return categoryString.trim() || null;
            },

            // ğŸ“Œ [MODIFIED] í•´ì‹œ íŒŒì„œ (IDê°€ ì´ì œ ë¬¸ìì—´ì„)
            parseHash: (hash) => {
                const parts = hash.replace(/^#\//, '').split('/');
                const view = parts[0] || 'login'; // ê¸°ë³¸ ë·°ë¥¼ 'login'ìœ¼ë¡œ ë³€ê²½
                let id = null;
                if (view === 'editor' && parts[1]) {
                    id = parts[1]; // IDëŠ” ì´ì œ ë¬¸ìì—´
                } else if (view === 'dashboard' && parts[1] === 'note' && parts[2]) {
                    id = parts[2]; // IDëŠ” ì´ì œ ë¬¸ìì—´
                }
                return { view, id };
            }
        };

        // --- 3. UI ë Œë”ë§(Rendering) ëª¨ë“ˆ ---
        const ui = {
            /**
             * ğŸ“Œ [NEW] ë·° ì „í™˜ í—¬í¼
             * @param {string} viewId - 'view-login', 'view-dashboard' ë“±
             */
            showView: (viewId) => {
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-editor').classList.add('hidden');
                document.getElementById('view-management').classList.add('hidden');
                document.getElementById('view-settings').classList.add('hidden');

                const view = document.getElementById(viewId);
                if (view) {
                    view.classList.remove('hidden');
                } else {
                    document.getElementById('view-login').classList.remove('hidden');
                }
            },

            // ğŸ“Œ [MODIFIED] ë¼ìš°íŒ… í•¸ë“¤ëŸ¬
            handleRouting: () => {
                // 1. Firebase ì¤€ë¹„ê°€ ì•ˆëìœ¼ë©´ 'ì„¤ì •'ìœ¼ë¡œ ê°•ì œ ì´ë™
                if (!state.isFirebaseReady) {
                    state.currentView = 'settings';
                    ui.showView('view-settings');
                    ui.renderSettings();
                    // ğŸ“Œ [MODIFIED] Firebase ì¤€ë¹„ê°€ ì•ˆëì„ ë•Œ 'firebase' íƒ­ì„ ê°•ì œë¡œ ì—½ë‹ˆë‹¤.
                    ui.showSettingsSection('firebase');
                    return;
                }
                
                // 2. ë¡œê·¸ì¸ì´ ì•ˆëìœ¼ë©´ 'ë¡œê·¸ì¸'ìœ¼ë¡œ ê°•ì œ ì´ë™ (ë‹¨, í•´ì‹œê°€ 'ì„¤ì •'ì¸ ê²½ìš°ëŠ” ì˜ˆì™¸)
                const parsedHash = helpers.parseHash(window.location.hash);
                if (!state.isLoggedIn && parsedHash.view !== 'settings') {
                    state.currentView = 'login';
                    ui.showView('view-login');
                    ui.renderLogin();
                    return;
                }
                
                // 3. ë¡œê·¸ì¸ ë˜ì—ˆìœ¼ë©´ í•´ì‹œ ë”°ë¼ ë Œë”ë§
                const { view, id } = parsedHash;
                state.currentView = view;
                
                ui.showView(`view-${view}`);

                if (view === 'dashboard') {
                    state.selectedNoteId = id || null; 
                    state.editingNoteId = null;
                    ui.renderDashboard();
                } else if (view === 'editor') {
                    state.editingNoteId = id || null;
                    ui.renderEditor();
                } else if (view === 'management') {
                    ui.renderManagement();
                } else if (view === 'settings') {
                    ui.renderSettings();
                    // ğŸ“Œ [NEW] ì„¤ì • ë·°ì˜ ê¸°ë³¸ íƒ­ì„ ì—½ë‹ˆë‹¤.
                    // Firebase ì¤€ë¹„ê°€ ì•ˆëê±°ë‚˜ ë¡œê·¸ì•„ì›ƒ ìƒíƒœë©´ 'firebase' íƒ­
                    // ë¡œê·¸ì¸ ìƒíƒœë©´ 'account' íƒ­
                    if (!state.isFirebaseReady || !state.isLoggedIn) {
                        ui.showSettingsSection('firebase');
                    } else {
                        ui.showSettingsSection('account');
                    }
                } else if (view === 'login') {
                    ui.renderLogin();
                }
            },

            /**
             * ğŸ“Œ [NEW] ì„¤ì • ë·° ë‚´ë¶€ ì„¹ì…˜ í† ê¸€
             * @param {string} sectionId - 'firebase', 'account', 'ai'
             */
            showSettingsSection: (sectionId) => {
                // 1. ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                document.querySelectorAll('.settings-section').forEach(el => el.classList.add('hidden'));
                // 2. ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™”
                document.querySelectorAll('#settings-nav button').forEach(el => el.classList.remove('settings-nav-active'));

                // 3. ëŒ€ìƒ ì„¹ì…˜ í‘œì‹œ
                const section = document.getElementById(`settings-section-${sectionId}`);
                if (section) {
                    section.classList.remove('hidden');
                }
                
                // 4. ëŒ€ìƒ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í™œì„±í™”
                const navBtn = document.querySelector(`#settings-nav button[data-section="${sectionId}"]`);
                if (navBtn) {
                    navBtn.classList.add('settings-nav-active');
                }
            },

            /**
             * ğŸ“Œ [NEW] ë¡œê·¸ì¸ ë·° ë Œë”ë§
             */
            renderLogin: () => {
                // ì´ ë·°ëŠ” ì •ì ì´ë¯€ë¡œ íŠ¹ë³„íˆ ë Œë”ë§í•  ë°ì´í„°ê°€ ì—†ìŒ
                ui.showView('view-login');
            },

            // --- V-01: ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ---
            renderDashboard: () => {
                // ğŸ“Œ [NEW] ì‚¬ìš©ì ì •ë³´ í—¤ë” ë Œë”ë§
                const user = state.currentUser;
                if (user) {
                    document.getElementById('user-display-name').textContent = user.displayName;
                    document.getElementById('user-avatar').src = user.photoURL;
                    document.getElementById('user-display-name').classList.remove('hidden');
                    document.getElementById('user-avatar').classList.remove('hidden');
                }

                // ğŸ“Œ [NEW] Calculate counts for folders and tags
                const folderNoteCounts = new Map();
                const tagNoteCounts = new Map();

                for (const note of state.notes) {
                    // 1. Folder count (notes directly in the folder)
                    const parentId = note.parentId || 'root'; // 'ë¯¸ë¶„ë¥˜'ëŠ” 'root'
                    folderNoteCounts.set(parentId, (folderNoteCounts.get(parentId) || 0) + 1);

                    // 2. Tag count
                    (note.tags || []).forEach(tag => {
                        tagNoteCounts.set(tag, (tagNoteCounts.get(tag) || 0) + 1);
                    });
                }
                
                // 3. 'ëª¨ë“  ë…¸íŠ¸' ì¹´ìš´íŠ¸
                folderNoteCounts.set('all', state.notes.length);
                
                ui.renderNavPane(folderNoteCounts, tagNoteCounts); // ğŸ“Œ [MODIFIED]
                ui.renderNoteListPane();
                ui.renderViewerPane();
            },
            
            // ğŸ“Œ [MODIFIED] Nav Pane ë Œë”ë§ (ë‹¨ìˆœí™”ëœ Tag ë¡œì§)
            renderNavPane: (folderNoteCounts, tagNoteCounts) => {
                const folderTreeContainer = document.getElementById('c01-folder-tree');
                const tagListContainer = document.getElementById('c01-tag-list');
                const searchTerm = state.navSearchTerm.toLowerCase();

                // ğŸ“Œ [NEW] 'ëª¨ë“  ë…¸íŠ¸' ë° 'ë¯¸ë¶„ë¥˜' ì¹´ìš´íŠ¸ í‘œì‹œ
                const allCount = folderNoteCounts.get('all') || 0;
                const rootCount = folderNoteCounts.get('root') || 0;
                const ul = document.querySelector('#c01-nav-pane .space-y-1'); // 'ëª¨ë“  ë…¸íŠ¸'ê°€ í¬í•¨ëœ <ul>
                if (ul) {
                    ul.innerHTML = `
                        <li><a href="#" data-filter-type="all" class="nav-filter-btn flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium">
                            <span class="flex items-center"><i class="bi bi-journal-text w-6 text-gray-600"></i> ëª¨ë“  ë…¸íŠ¸</span>
                            <span class="text-gray-500 text-xs ml-1">(${allCount})</span>
                        </a></li>
                        <li><a href="#" data-filter-type="category" data-filter-value="root" class="nav-filter-btn flex justify-between items-center px-3 py-2 rounded-lg hover:bg-gray-200 text-sm font-medium" data-folder-id="root">
                            <span class="flex items-center"><i class="bi bi-archive w-6 text-gray-600"></i> ë¯¸ë¶„ë¥˜</span>
                            <span class="text-gray-500 text-xs ml-1">(${rootCount})</span>
                        </a></li>
                    `;
                }
                
                // VFS (í´ë”) ë Œë”ë§ (ì¹´ìš´íŠ¸ ë§µ ì „ë‹¬)
                if (folderTreeContainer) {
                    const filteredNodes = state.vfsNodes.filter(n => n.name.toLowerCase().includes(searchTerm));
                    folderTreeContainer.innerHTML = ui.buildVfsTreeHTML(filteredNodes, 'root', 0, folderNoteCounts); // ğŸ“Œ [MODIFIED]
                }
                
                // ğŸ“Œ [MODIFIED] Tags ë Œë”ë§ (ì¹´ìš´íŠ¸ í‘œì‹œ)
                if (tagListContainer) {
                    // state.tagsëŠ” {id: "name", name: "name"} í˜•íƒœì„
                    const filteredTags = state.tags.filter(t => t.name.toLowerCase().includes(searchTerm));
                    const tagsHtml = filteredTags.map(tag => {
                        const count = tagNoteCounts.get(tag.name) || 0; // ğŸ“Œ [NEW] Get count
                        return `
                        <li>
                            <a href="#" data-filter-type="tag" data-filter-value="${tag.id}" 
                               class="nav-filter-btn flex items-center justify-between px-3 py-1.5 rounded-lg hover:bg-gray-200 text-sm">
                               <span class="flex items-center truncate"><i class="bi bi-hash w-6 text-gray-500"></i> <span class="truncate">${tag.name}</span></span>
                               ${count > 0 ? `<span class="text-gray-500 text-xs ml-1 flex-shrink-0">(${count})</span>` : ''}
                            </a>
                        </li>
                    `}).join('');
                    tagListContainer.innerHTML = `<ul class="space-y-1">${tagsHtml}</ul>`;
                }
                // ... (í™œì„± í•„í„° UI ì—…ë°ì´íŠ¸ ë¡œì§ - ê¸°ì¡´ê³¼ ë™ì¼) ...
                document.querySelectorAll('.nav-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold');
                    const type = btn.dataset.filterType;
                    const value = btn.dataset.filterValue;
                    if (type === state.currentFilter.type && value === String(state.currentFilter.value)) { // IDê°€ ë¬¸ìì—´ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ String() ë¹„êµ
                        btn.classList.add('bg-blue-100', 'text-blue-700', 'font-semibold');
                    }
                });
            },
            
            // ğŸ“Œ [MODIFIED] VFS Tree HTML ë¹Œë” (í´ë” ì¹´ìš´íŠ¸ ì¶”ê°€)
            buildVfsTreeHTML: (allNodes, parentId, level, folderNoteCounts) => {
                const children = allNodes
                    .filter(node => node.parentId === parentId)
                    .sort((a, b) => a.name.localeCompare(b.name));
                if (children.length === 0 && parentId === 'root') return '<p class="px-3 text-xs text-gray-500">í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return children.map(node => {
                    const isExpanded = state.expandedFolders.has(node.id);
                    const hasChildren = allNodes.some(n => n.parentId === node.id);
                    const count = folderNoteCounts.get(node.id) || 0; // ğŸ“Œ [NEW]
                    
                    let html = `<div style="padding-left: ${level * 1}rem;">`;
                    html += `
                        <div class="folder-item flex items-center justify-between group">
                            <a href="#" data-filter-type="category" data-filter-value="${node.id}"
                               class="nav-filter-btn flex-1 flex items-center justify-between py-1.5 rounded-lg hover:bg-gray-200 text-sm truncate"
                               data-folder-id="${node.id}"
                               draggable="true" 
                            >
                                <span class="flex items-center truncate">
                                    <i data-folder-id="${node.id}" class="folder-toggle-btn bi ${isExpanded ? 'bi-caret-down-fill' : (hasChildren ? 'bi-caret-right-fill' : 'bi-dot')} w-6 text-gray-500 cursor-pointer"></i>
                                    <i class="bi bi-folder w-6 text-yellow-600"></i>
                                    <span class="ml-1 truncate">${node.name}</span>
                                </span>
                                <!-- ğŸ“Œ [NEW] Add count -->
                                ${count > 0 ? `<span class="text-gray-500 text-xs ml-1 flex-shrink-0">(${count})</span>` : ''}
                            </a>
                            <div class="folder-actions flex-shrink-0 space-x-1.5 pr-2">
                                <button data-id="${node.id}" class="rename-folder-btn c12-btn text-gray-500 hover:text-blue-600 p-0.5" title="ì´ë¦„ ë³€ê²½">
                                    <i class="bi bi-pencil" style="font-size: 0.8rem;"></i>
                                </button>
                                <button data-id="${node.id}" class="delete-folder-btn c12-btn text-gray-500 hover:text-red-600 p-0.5" title="ì‚­ì œ">
                                    <i class="bi bi-trash" style="font-size: 0.8rem;"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    if (hasChildren && isExpanded) {
                        html += ui.buildVfsTreeHTML(allNodes, node.id, level + 1);
                    }
                    html += `</div>`;
                    return html;
                }).join('');
            },

            // ğŸ“Œ [MODIFIED] Note List Pane (Tag í•„í„° ë¡œì§ ìˆ˜ì •)
            renderNoteListPane: async () => {
                const listContainer = document.getElementById('c02-note-list');
                const header = document.getElementById('c02-header');
                if (!listContainer || !header) return;
                
                let filteredNotes = state.notes;
                const { type, value } = state.currentFilter;
                
                if (type === 'all') {
                    header.textContent = 'ëª¨ë“  ë…¸íŠ¸';
                } else if (type === 'category') {
                    if (value === 'root') {
                        header.textContent = 'ë¯¸ë¶„ë¥˜';
                        filteredNotes = filteredNotes.filter(n => !n.parentId || n.parentId === 'root');
                    } else {
                        const folder = state.vfsNodes.find(n => n.id === value);
                        header.textContent = folder ? folder.name : 'ì•Œ ìˆ˜ ì—†ëŠ” í´ë”';
                        filteredNotes = filteredNotes.filter(n => n.parentId === value);
                    }
                } else if (type === 'tag') {
                    // ğŸ“Œ [MODIFIED] 'value'ëŠ” ì´ì œ íƒœê·¸ ì´ë¦„(string)ì„
                    const tagName = value; 
                    header.textContent = `#${tagName}`;
                    // ğŸ“Œ [MODIFIED] note.tags ë°°ì—´ì—ì„œ ì§ì ‘ ê²€ìƒ‰ (DB í˜¸ì¶œ ë¶ˆí•„ìš”)
                    filteredNotes = filteredNotes.filter(n => n.tags && n.tags.includes(tagName));
                }
                
                // ... (ê²€ìƒ‰ ë° ì •ë ¬ ë¡œì§ - ê¸°ì¡´ê³¼ ë™ì¼) ...
                const searchTerm = state.noteSearchTerm.toLowerCase();
                if (searchTerm) {
                    filteredNotes = filteredNotes.filter(n => 
                        n.title.toLowerCase().includes(searchTerm) ||
                        n.body.toLowerCase().includes(searchTerm)
                    );
                }
                
                // ğŸ“Œ [MODIFIED] Firestore Timestamp ì •ë ¬
                filteredNotes.sort((a, b) => {
                    const dateA = a.updatedAt?.toDate ? a.updatedAt.toDate() : new Date(a.updatedAt);
                    const dateB = b.updatedAt?.toDate ? b.updatedAt.toDate() : new Date(b.updatedAt);
                    return dateB - dateA;
                });

                // ... (ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ HTML - IDë¥¼ ë¬¸ìì—´ë¡œ ì‚¬ìš©) ...
                if (filteredNotes.length === 0) {
                    listContainer.innerHTML = '<p class="p-4 text-center text-gray-500 text-sm">ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                listContainer.innerHTML = filteredNotes.map(note => {
                    const isActive = note.id === state.selectedNoteId;
                    return `
                        <div data-note-id="${note.id}" 
                             class="note-item p-4 cursor-pointer hover:bg-gray-100 ${isActive ? 'note-item-active' : ''}"
                             draggable="true"
                        >
                            <div class="flex justify-between items-center mb-1">
                                <h3 class="font-semibold text-gray-800 truncate">${note.title || 'ì œëª© ì—†ìŒ'}</h3>
                                <span class="c08-ai-status flex-shrink-0 ml-2">
                                    ${helpers.getAiStatusIcon(note.aiStatus)}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2 truncate">${helpers.summarize(note.summary || note.body)}</p>
                            <p class="text-xs text-gray-400">${helpers.formatDate(note.updatedAt)}</p>
                        </div>
                    `;
                }).join('');
            },

            // ğŸ“Œ [MODIFIED] Viewer Pane (Tag ë¡œì§ ìˆ˜ì •)
            renderViewerPane: async () => {
                const note = state.notes.find(n => n.id === state.selectedNoteId);
                const welcomeScreen = document.getElementById('c03-welcome-screen');
                const noteContent = document.getElementById('c03-note-content');
                const header = document.getElementById('c09-viewer-header');
                if (!welcomeScreen || !noteContent || !header) return; 

                if (!note) {
                    welcomeScreen.classList.remove('hidden');
                    noteContent.classList.add('hidden');
                    header.classList.add('hidden');
                    return;
                }
                
                // ... (í—¤ë” ë Œë”ë§ - ê¸°ì¡´ê³¼ ë™ì¼) ...
                welcomeScreen.classList.add('hidden');
                noteContent.classList.remove('hidden');
                header.classList.remove('hidden');
                
                header.innerHTML = `
                    <div class="flex justify-between items-center max-w-[75ch] mx-auto w-full">
                        <h2 class="text-2xl font-bold text-gray-800 truncate pr-4">${note.title}</h2>
                        <div class="flex items-center space-x-3 flex-shrink-0">
                            <button id="viewer-re-analyze-btn" class="c12-btn text-sm text-gray-600 hover:text-blue-600 transition duration-150 flex items-center">
                                <span class="c08-ai-status mr-1">${helpers.getAiStatusIcon(note.aiStatus)}</span>
                                AI ì¬ë¶„ì„
                            </button>
                            <button id="viewer-delete-btn" class="c12-btn text-gray-600 hover:text-red-600 transition duration-150" title="ì‚­ì œ">
                                <i class="bi bi-trash text-lg"></i>
                            </button>
                            <button id="viewer-edit-btn" class="c12-btn text-gray-600 hover:text-blue-600 transition duration-150" title="ìˆ˜ì •">
                                <i class="bi bi-pencil text-lg"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // ... (ìš”ì•½ ë Œë”ë§ - ê¸°ì¡´ê³¼ ë™ì¼) ...
                const summaryEl = document.getElementById('c03-summary');
                if (summaryEl) {
                    if (note.summary) {
                        summaryEl.textContent = note.summary;
                        summaryEl.classList.remove('hidden');
                    } else {
                        summaryEl.classList.add('hidden');
                    }
                }
                
                // ğŸ“Œ [MODIFIED] Tags ë Œë”ë§ (note.tags ë°°ì—´ ì‚¬ìš©)
                const tagsTopContainer = document.getElementById('c03-tags-top');
                if (tagsTopContainer) {
                    const tags = note.tags || []; // DB í˜¸ì¶œ ë¶ˆí•„ìš”
                    if (tags && tags.length > 0) {
                        tagsTopContainer.innerHTML = tags.map(tagName => 
                            `<span class="c10-tag-badge bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-gray-300">#${tagName}</span>`
                        ).join('');
                        tagsTopContainer.classList.remove('hidden');
                    } else {
                        tagsTopContainer.classList.add('hidden');
                    }
                }
                
                // ... (ë³¸ë¬¸ ë Œë”ë§ - ê¸°ì¡´ê³¼ ë™ì¼) ...
                const bodyEl = document.getElementById('c03-body');
                if (bodyEl) {
                    bodyEl.innerHTML = marked.parse(note.body || 'ì‘ì„±ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ... (ì—°ê´€ ë¬¸ì„œ ë Œë”ë§ - IDê°€ ë¬¸ìì—´ì„) ...
                const relatedDocsEl = document.getElementById('c03-related-docs');
                if (relatedDocsEl) {
                    if (note.relatedIds && note.relatedIds.length > 0) { 
                        const relatedNotes = note.relatedIds
                            .map(id => state.notes.find(n => n.id === id)) // IDëŠ” ì´ì œ ë¬¸ìì—´
                            .filter(Boolean);
                        
                        relatedDocsEl.innerHTML = relatedNotes.map(n => 
                            `<a href="#/dashboard/note/${n.id}" class="c10-tag-badge bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm cursor-pointer hover:bg-blue-200">${n.title}</a>`
                        ).join('');
                    } else {
                        relatedDocsEl.innerHTML = '<p class="text-sm text-gray-500">ì—°ê´€ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                }
            },

            // ğŸ“Œ [MODIFIED] ì—ë””í„° ë·° ë Œë”ë§ (Tag ë¡œì§ ìˆ˜ì •)
            renderEditor: async () => {
                const note = state.notes.find(n => n.id === state.editingNoteId);
                const form = document.getElementById('editor-form');
                const deleteBtn = document.getElementById('editor-delete-btn');
                const saveBtn = document.getElementById('editor-save-btn');
                if (!form || !deleteBtn || !saveBtn) return;
                
                if (note) {
                    form.elements.title.value = note.title || '';
                    form.elements.body.value = note.body || '';
                    form.elements.summary.value = note.summary || '';
                    form.elements.category.value = await dbService.getFolderPath(note.parentId, state.vfsNodes);
                    // ğŸ“Œ [MODIFIED] note.tags ë°°ì—´ì„ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜
                    form.elements.tags.value = (note.tags || []).join(', ');
                    deleteBtn.classList.remove('hidden');
                } else {
                    form.reset();
                    if (state.currentFilter.type === 'category' && state.currentFilter.value !== 'root') {
                        form.elements.category.value = await dbService.getFolderPath(state.currentFilter.value, state.vfsNodes);
                    }
                    deleteBtn.classList.add('hidden');
                }

                // ... (Datalist ë Œë”ë§ - state.tagsê°€ ë‹¨ìˆœ ê°ì²´ ë°°ì—´ì„) ...
                const categoryDatalist = document.getElementById('category-datalist');
                if (categoryDatalist) {
                    const paths = state.vfsNodes.map(n => dbService.getFolderPath(n.id, state.vfsNodes));
                    categoryDatalist.innerHTML = [...new Set(paths)]
                        .map(p => `<option value="${p}"></option>`).join('');
                }
                const tagDatalist = document.getElementById('tag-datalist');
                if (tagDatalist) {
                    tagDatalist.innerHTML = state.tags // state.tagsëŠ” {id, name}
                        .map(t => `<option value="${t.name}"></option>`).join('');
                }
                
                saveBtn.disabled = true;
            },

            // ğŸ“Œ [MODIFIED] ê´€ë¦¬ ë·° ë Œë”ë§ (Tag ë¡œì§ ìˆ˜ì •)
            renderManagement: async () => {
                const tagList = document.getElementById('management-tag-list');
                if (!tagList) return;
                
                const tagSearchEl = document.getElementById('c06-tag-manage-search');
                const tagSearch = tagSearchEl ? tagSearchEl.value.toLowerCase() : '';
                
                const filteredTags = state.tags.filter(t => t.name.toLowerCase().includes(tagSearch));
                
                let tagsHtml = [];
                for (const tag of filteredTags) {
                    // ğŸ“Œ [MODIFIED] ë…¸íŠ¸ ì¹´ìš´íŠ¸ë¥¼ state.notesì—ì„œ ì§ì ‘ ê³„ì‚°
                    const count = state.notes.filter(n => n.tags && n.tags.includes(tag.name)).length;
                    
                    tagsHtml.push(`
                        <div class="flex justify-between items-center py-3 group">
                            <span class="text-gray-800">#${tag.name} <span class="text-gray-400 text-sm">(${count})</span></span>
                            <button data-id="${tag.id}" data-name="${tag.name}" class="manage-delete-tag-btn c12-btn text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `);
                }
                tagList.innerHTML = tagsHtml.join('');
            },

            // ğŸ“Œ [MODIFIED] V-04: ì„¤ì • ë·° ë Œë”ë§ (Firebase UI ë¶„ë¦¬)
            renderSettings: () => {
                const form = document.getElementById('settings-form');
                if (!form) return;

                // 1. Firebase Config ë Œë”ë§ (localStorageì—ì„œ)
                // í¼ì´ 2-C ì„¹ì…˜(AI)ì—ë§Œ ìˆìœ¼ë¯€ë¡œ, firebase-configëŠ” form.elementsë¡œ ì ‘ê·¼ ë¶ˆê°€
                document.getElementById('settings-firebase-config').value = dbService.getFirebaseConfig();
                
                // 2. ì¸ì¦/AI ì„¹ì…˜ í‘œì‹œ ì—¬ë¶€
                if (state.isLoggedIn && state.currentUser) {
                    
                    // 3. ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                    document.getElementById('settings-user-avatar').src = state.currentUser.photoURL;
                    document.getElementById('settings-user-name').textContent = state.currentUser.displayName;
                    document.getElementById('settings-user-email').textContent = state.currentUser.email;

                    // 4. AI ì„¤ì • ë Œë”ë§ (Firestore state.settingsì—ì„œ)
                    const keyListContainer = document.getElementById('settings-api-key-list');
                    keyListContainer.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°
                    const apiKeys = state.settings.apiKeys || [];
                
                    if (apiKeys.length === 0) {
                        keyListContainer.innerHTML = '<p class="text-sm text-gray-500 text-center p-2">API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. "í‚¤ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';
                    } else {
                        apiKeys.forEach((key) => {
                            const keyEl = document.createElement('div');
                            keyEl.className = 'api-key-item relative flex items-center space-x-2';
                            // ğŸ“Œ [MODIFIED] IDë¥¼ ëœë¤ UUIDë¡œ ì‚¬ìš©
                            keyEl.innerHTML = `
                                <input type="hidden" class="api-key-id" value="${key.id}">
                                <input type="text" class="api-key-name w-1/3 p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                       placeholder="í‚¤ ë ˆì´ë¸” (ì˜ˆ: 'Primary')" value="${key.name}">
                                <input type="password" class="api-key-value w-2/3 p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                       placeholder="sk-..." value="${key.key}">
                                <button type="button" class="toggle-api-key-btn absolute inset-y-0 right-10 px-3 flex items-center text-gray-500 hover:text-blue-600" title="í‚¤ ë³´ê¸°/ìˆ¨ê¸°ê¸°">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                                <button type="button" class="delete-api-key-btn flex-shrink-0 text-gray-400 hover:text-red-600" title="í‚¤ ì‚­ì œ">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            `;
                            keyListContainer.appendChild(keyEl);
                        });
                    }

                    // 5. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì±„ìš°ê¸° (Firestore state.settingsì—ì„œ)
                    form.elements.aiSystemPrompt.value = state.settings.aiSystemPrompt;
                    form.elements.aiUserPromptTemplate.value = state.settings.aiUserPromptTemplate;

                } else {
                    // --- ë¹„ë¡œê·¸ì¸/Firebase ì¤€ë¹„ ì•ˆëœ ê²½ìš° ---
                    // (í‘œì‹œ/ìˆ¨ê¹€ ë¡œì§ ì œê±°)
                }
            },
            
            // C-13: Toast (ê¸°ì¡´ê³¼ ë™ì¼)
            showToast: (message, type = 'success') => {
                // ... (v5 Toast ë¡œì§ ë™ì¼) ...
                const toast = document.getElementById('c13-toast');
                const icon = document.getElementById('c13-toast-icon');
                const msg = document.getElementById('c13-toast-message');
                if (!toast || !icon || !msg) return;
                if (state.toastTimeout) clearTimeout(state.toastTimeout);
                toast.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');
                if (type === 'success') {
                    toast.classList.add('bg-green-600');
                    icon.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                } else if (type === 'error') {
                    toast.classList.add('bg-red-600');
                    icon.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i>';
                } else if (type === 'loading') {
                    toast.classList.add('bg-blue-600');
                    icon.innerHTML = '<i class="bi bi-arrow-clockwise analyzing-spin"></i>';
                }
                msg.textContent = message;
                toast.classList.remove('hidden', 'opacity-0');
                if (type !== 'loading') {
                    state.toastTimeout = setTimeout(() => {
                        toast.classList.add('opacity-0');
                        setTimeout(() => toast.classList.add('hidden'), 300);
                    }, 3000);
                }
            },
            hideToast: () => {
                const toast = document.getElementById('c13-toast');
                if (toast) {
                    toast.classList.add('opacity-0');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }
            },
            
            // C-14: Modal (ê¸°ì¡´ê³¼ ë™ì¼)
            showModal: (title, content, onConfirm, options = {}) => {
                // ... (v5 ëª¨ë‹¬ ë¡œì§ ë™ì¼) ...
                const { showInput = false, inputPlaceholder = '', inputValue = '', confirmText = 'í™•ì¸' } = options;
                const modal = document.getElementById('c14-modal');
                const modalTitle = document.getElementById('c14-modal-title');
                const modalContent = document.getElementById('c14-modal-content');
                const modalInput = document.getElementById('c14-modal-input');
                const modalConfirm = document.getElementById('c14-modal-confirm');
                if (!modal || !modalTitle || !modalContent || !modalInput || !modalConfirm) return;
                modalTitle.textContent = title;
                modalContent.textContent = content;
                if (showInput) {
                    modalInput.classList.remove('hidden');
                    modalInput.placeholder = inputPlaceholder;
                    modalInput.value = inputValue;
                    modalInput.focus();
                } else {
                    modalInput.classList.add('hidden');
                    modalInput.value = '';
                }
                modalConfirm.textContent = confirmText;
                if (confirmText.includes('ì‚­ì œ')) {
                     modalConfirm.classList.add('bg-red-600', 'hover:bg-red-700');
                     modalConfirm.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                } else {
                     modalConfirm.classList.remove('bg-red-600', 'hover:bg-red-700');
                     modalConfirm.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
                modal.classList.remove('hidden');
                state.modalConfirmCallback = onConfirm;
            },
            hideModal: () => {
                const modal = document.getElementById('c14-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
                state.modalConfirmCallback = null;
            }
        };

        // --- 4. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬(Event Handlers) ë° ë¼ìš°íŒ… ---
        const handlers = {
            /**
             * ğŸ“Œ [NEW] ì•± ì§„ì…ì  (initApp -> initEvents)
             * ì•± ì‹œì‘ ì‹œ ëª¨ë“  ì´ë²¤íŠ¸ë¥¼ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
             */
            initEvents: () => {
                window.addEventListener('hashchange', ui.handleRouting);
                
                // V-00 ë¡œê·¸ì¸
                document.getElementById('btn-google-login')?.addEventListener('click', handlers.handleLoginClick);
                document.getElementById('btn-goto-settings-from-login')?.addEventListener('click', () => window.location.hash = '#/settings');
                
                // V-01 ëŒ€ì‹œë³´ë“œ (ê¸°ì¡´ê³¼ ë™ì¼)
                document.getElementById('btn-new-note')?.addEventListener('click', handlers.handleNewNoteClick);
                document.getElementById('c01-nav-pane')?.addEventListener('click', handlers.handleNavPaneClick);
                document.getElementById('c02-note-list')?.addEventListener('click', handlers.handleNoteItemClick);
                document.getElementById('c03-viewer-pane')?.addEventListener('click', handlers.handleViewerActions);
                document.getElementById('c06-nav-search')?.addEventListener('input', handlers.handleNavSearch);
                document.getElementById('c02-note-search')?.addEventListener('input', handlers.handleNoteSearch);
                document.getElementById('nav-new-folder-btn')?.addEventListener('click', handlers.handleNewFolderClick);
                document.getElementById('c02-note-list')?.addEventListener('dragstart', handlers.handleNoteDragStart);
                document.getElementById('c01-nav-pane')?.addEventListener('dragstart', handlers.handleVfsDragStart); // ğŸ“Œ [NEW]
                document.getElementById('c01-nav-pane')?.addEventListener('dragover', handlers.handleFolderDragOver);
                document.getElementById('c01-nav-pane')?.addEventListener('dragleave', handlers.handleFolderDragLeave);
                document.getElementById('c01-nav-pane')?.addEventListener('drop', handlers.handleFolderDrop);
                
                // V-02 ì—ë””í„° (ê¸°ì¡´ê³¼ ë™ì¼)
                document.getElementById('editor-form')?.addEventListener('input', handlers.handleEditorFormChange);
                document.getElementById('editor-save-btn')?.addEventListener('click', handlers.handleEditorSave);
                document.getElementById('editor-cancel-btn')?.addEventListener('click', handlers.handleEditorCancel);
                document.getElementById('editor-delete-btn')?.addEventListener('click', handlers.handleEditorDelete);
                
                // V-03 ê´€ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼)
                document.getElementById('btn-back-to-dashboard')?.addEventListener('click', handlers.handleManageBack);
                document.getElementById('management-tag-list')?.addEventListener('click', handlers.handleManageDelete);
                document.getElementById('c06-tag-manage-search')?.addEventListener('input', handlers.handleManageSearch);

                
                // V-04 ì„¤ì • (ğŸ“Œ [MODIFIED] ì €ì¥ ë²„íŠ¼ ë¶„ë¦¬)
                document.getElementById('settings-back-btn')?.addEventListener('click', handlers.handleSettingsBack);
                document.getElementById('settings-nav')?.addEventListener('click', handlers.handleSettingsNavClick); // ğŸ“Œ [NEW]
                document.getElementById('settings-save-firebase-config-btn')?.addEventListener('click', handlers.handleFirebaseConfigSave);
                document.getElementById('settings-form')?.addEventListener('submit', handlers.handleSettingsSave); // AI/í”„ë¡¬í”„íŠ¸ ì €ì¥
                document.getElementById('settings-logout-btn')?.addEventListener('click', handlers.handleLogoutClick);
                document.getElementById('settings-add-api-key-btn')?.addEventListener('click', handlers.handleSettingsAddApiKeyClick);
                document.getElementById('settings-api-key-list')?.addEventListener('click', handlers.handleSettingsKeyListClick);
                
                // C-14 ëª¨ë‹¬ (ê¸°ì¡´ê³¼ ë™ì¼)
                document.getElementById('c14-modal-cancel')?.addEventListener('click', handlers.handleModalCancel);
                document.getElementById('c14-modal-confirm')?.addEventListener('click', handlers.handleModalConfirm);
                
                document.getElementById('btn-hamburger')?.addEventListener('click', handlers.handleHamburgerClick);
                document.getElementById('sidebar-backdrop')?.addEventListener('click', handlers.handleBackdropClick);
                
                console.log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ë°”ì¸ë”©ë˜ì—ˆìŠµë‹ˆë‹¤.');
            },

            /**
             * ğŸ“Œ [NEW] ì¸ì¦ ìƒíƒœ ë³€ê²½ í•¸ë“¤ëŸ¬ (í•µì‹¬ ë¡œì§)
             * @param {firebase.User} user - Firebase user ê°ì²´
             */
            onAuthStateChanged: async (user) => {
                if (user) {
                    // --- ë¡œê·¸ì¸ ì„±ê³µ ---
                    console.log("ë¡œê·¸ì¸ ì„±ê³µ:", user.uid);
                    state.isLoggedIn = true;
                    state.currentUser = {
                        uid: user.uid,
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL
                    };
                    currentUserId = user.uid;
                    
                    ui.showToast(`${user.displayName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.`, "success");
                    await handlers.fetchAllDataAndRender();
                    
                    // í•´ì‹œê°€ ì—†ê±°ë‚˜ ë¡œê·¸ì¸/ì„¤ì • ë·°ì˜€ë‹¤ë©´ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    const currentHash = window.location.hash;
                    if (!currentHash || currentHash === '#/' || currentHash === '#/login' || currentHash === '#/settings') {
                        window.location.hash = '#/dashboard';
                    } else {
                        ui.handleRouting(); // ê¸°ì¡´ í•´ì‹œ ìœ ì§€
                    }

                } else {
                    // --- ë¡œê·¸ì•„ì›ƒ ë˜ëŠ” ë¹„ë¡œê·¸ì¸ ---
                    console.log("ë¡œê·¸ì•„ì›ƒë˜ì—ˆê±°ë‚˜ ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    state.isLoggedIn = false;
                    state.currentUser = null;
                    currentUserId = null;
                    
                    // ë¡œì»¬ ìƒíƒœ ì´ˆê¸°í™”
                    state.notes = [];
                    state.vfsNodes = [];
                    state.tags = [];
                    state.settings = { ...DEFAULT_SETTINGS };

                    // í•´ì‹œê°€ ì„¤ì •ì´ ì•„ë‹ˆë©´ ë¡œê·¸ì¸ ë·°ë¡œ ê°•ì œ ì´ë™
                    if (window.location.hash !== '#/settings') {
                        window.location.hash = '#/login';
                    } else {
                        ui.handleRouting(); // ì„¤ì • ë·°ëŠ” í—ˆìš©
                    }
                }
            },

            /**
             * ğŸ“Œ [MODIFIED] ë°ì´í„° ë¡œë“œ (Firestore ê¸°ë°˜)
             */
            fetchAllDataAndRender: async () => {
                if (!state.isLoggedIn) return; // ë¡œê·¸ì¸ ì•ˆëìœ¼ë©´ ì‹¤í–‰ ì•ˆí•¨
                
                ui.showToast("ë°ì´í„° ë¡œë“œ ì¤‘...", "loading");
                try {
                    const [notes, vfsNodes, dbSettings] = await Promise.all([
                        dbService.getAllNotes(),
                        dbService.getAllVfsNodes(),
                        dbService.getSettings()
                    ]);
                    
                    state.notes = notes;
                    state.vfsNodes = vfsNodes;
                    state.settings = { ...DEFAULT_SETTINGS, ...(dbSettings || {}) };

                    // ğŸ“Œ [NEW] Tag ìƒíƒœ ì¬ìƒì„± (ë¹„ì •ê·œí™”)
                    // state.notesì—ì„œ ëª¨ë“  íƒœê·¸ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ìœ ë‹ˆí¬í•œ state.tags ë°°ì—´ ìƒì„±
                    const allTagNames = new Set();
                    state.notes.forEach(note => {
                        (note.tags || []).forEach(tag => allTagNames.add(tag));
                    });
                    state.tags = Array.from(allTagNames).sort().map(name => ({
                        id: name, // íƒœê·¸ ê´€ë¦¬ë¥¼ ìœ„í•´ ì´ë¦„ ìì²´ë¥¼ IDë¡œ ì‚¬ìš©
                        name: name
                    }));
                    
                    ui.hideToast();
                    ui.handleRouting(); // ë°ì´í„° ë¡œë“œ í›„ í˜„ì¬ ë·° ë Œë”ë§

                } catch (error) {
                    console.error("ë°ì´í„° ë¡œë”© ë° ë Œë”ë§ ì‹¤íŒ¨:", error);
                    ui.showToast("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", "error");
                }
            },
            
            // --- V-00 / V-04 ì¸ì¦ í•¸ë“¤ëŸ¬ ---
            handleLoginClick: () => {
                dbService.loginWithGoogle().catch(error => {
                    console.error("Google ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                    ui.showToast(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, "error");
                });
            },
            handleLogoutClick: () => {
                dbService.logout();
            },

            // --- V-01 í•¸ë“¤ëŸ¬ (ê¸°ì¡´ê³¼ ë™ì¼, IDëŠ” ì´ì œ ë¬¸ìì—´) ---
            handleNewNoteClick: () => {
                window.location.hash = '#/editor';
            },
            handleNavPaneClick: (e) => {
                // ... (í´ë” í† ê¸€/ì´ë¦„ë³€ê²½/ì‚­ì œ ë¡œì§ - ê¸°ì¡´ê³¼ ë™ì¼) ...
                const folderToggle = e.target.closest('.folder-toggle-btn');
                const renameBtn = e.target.closest('.rename-folder-btn');
                const deleteBtn = e.target.closest('.delete-folder-btn');
                if (folderToggle) {
                    e.preventDefault(); e.stopPropagation();
                    const path = folderToggle.dataset.folderId; // ë¬¸ìì—´ ID
                    if (state.expandedFolders.has(path)) {
                        state.expandedFolders.delete(path);
                    } else {
                        state.expandedFolders.add(path);
                    }
                    ui.renderNavPane(); return;
                }
                if (renameBtn) {
                    e.preventDefault(); e.stopPropagation();
                    handlers.handleRenameFolder(renameBtn.dataset.id); return; // ë¬¸ìì—´ ID
                }
                if (deleteBtn) {
                    e.preventDefault(); e.stopPropagation();
                    handlers.handleDeleteFolder(deleteBtn.dataset.id); return; // ë¬¸ìì—´ ID
                }
                handlers.handleNavFilterClick(e);
            },
            handleNavFilterClick: (e) => {
                const target = e.target.closest('.nav-filter-btn');
                if (!target) return;
                e.preventDefault();
                state.currentFilter.type = target.dataset.filterType;
                state.currentFilter.value = target.dataset.filterValue || null; // IDëŠ” ë¬¸ìì—´
                ui.renderNoteListPane();
                document.querySelectorAll('.nav-filter-btn').forEach(btn => btn.classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold'));
                target.classList.add('bg-blue-100', 'text-blue-700', 'font-semibold');
            },
            handleNoteItemClick: (e) => {
                const target = e.target.closest('.note-item');
                if (!target) return;
                const noteId = target.dataset.noteId; // ë¬¸ìì—´ ID
                window.location.hash = `#/dashboard/note/${noteId}`;
            },
            handleViewerActions: (e) => {
                if (e.target.closest('#viewer-edit-btn')) {
                    window.location.hash = `#/editor/${state.selectedNoteId}`;
                }
                else if (e.target.closest('#viewer-delete-btn')) {
                    const note = state.notes.find(n => n.id === state.selectedNoteId);
                    if (note) {
                        ui.showModal(
                            'ë…¸íŠ¸ ì‚­ì œ',
                            `'${note.title}' ë…¸íŠ¸ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                            async () => {
                                await dbService.deleteNote(state.selectedNoteId);
                                ui.hideModal();
                                ui.showToast('ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                
                                // ğŸ“Œ [MODIFIED] ì „ì²´ ë¦¬í˜ì¹˜ ëŒ€ì‹  ë¡œì»¬ ìƒíƒœì—ì„œ ì œê±°
                                state.notes = state.notes.filter(n => n.id !== state.selectedNoteId);
                                state.selectedNoteId = null;
                                window.location.hash = '#/dashboard';
                                ui.renderDashboard(); // ë‹¤ì‹œ ë Œë”ë§
                            },
                            { confirmText: 'ì‚­ì œ' } 
                        );
                    }
                }
                else if (e.target.closest('#viewer-re-analyze-btn')) {
                    handlers.triggerAiAnalysis(state.selectedNoteId);
                }
            },

            // ğŸ“Œ [MODIFIED] Drag/Drop í•¸ë“¤ëŸ¬ (JSON ë°ì´í„° ì‚¬ìš©)
            handleNoteDragStart: (e) => {
                const target = e.target.closest('.note-item');
                if (target) {
                    // ğŸ“Œ [MODIFIED] ë…¸íŠ¸ì„ì„ ëª…ì‹œí•˜ëŠ” JSON ë°ì´í„°ë¡œ ë³€ê²½
                    e.dataTransfer.setData('application/json', JSON.stringify({
                        type: 'note',
                        id: target.dataset.noteId 
                    }));
                    e.dataTransfer.effectAllowed = 'move';
                }
            },
            handleFolderDragOver: (e) => {
                e.preventDefault();
                const target = e.target.closest('.nav-filter-btn[data-folder-id]');
                if (target) {
                    document.querySelectorAll('.folder-drag-over').forEach(el => el.classList.remove('folder-drag-over'));
                    target.classList.add('folder-drag-over');
                    e.dataTransfer.dropEffect = 'move';
                } else {
                    e.dataTransfer.dropEffect = 'none';
                }
            },
            handleFolderDragLeave: (e) => {
                e.target.closest('.nav-filter-btn[data-folder-id]')?.classList.remove('folder-drag-over');
            },
            handleFolderDrop: async (e) => {
                e.preventDefault();
                document.querySelectorAll('.folder-drag-over').forEach(el => el.classList.remove('folder-drag-over'));
                const target = e.target.closest('.nav-filter-btn[data-folder-id]');
                if (!target) return;
                
                const newParentId = target.dataset.folderId; // The folder we are dropping ON
                let data;
                try {
                    // ğŸ“Œ [MODIFIED] JSON ë°ì´í„°ë¥¼ íŒŒì‹±
                    data = JSON.parse(e.dataTransfer.getData('application/json'));
                } catch (err) { return; }

                if (!data || !data.id || !newParentId) return;

                if (data.type === 'note') {
                    // --- Case 1: Note Drop Logic (ê¸°ì¡´ ë¡œì§) ---
                    const noteId = data.id;
                    const note = state.notes.find(n => n.id === noteId);
                    if (note && note.parentId !== newParentId) {
                        note.parentId = newParentId;
                        await dbService.updateNote(note);
                        ui.showToast(`'${note.title}' ë…¸íŠ¸ë¥¼ ì´ë™í–ˆìŠµë‹ˆë‹¤.`, 'success');
                        ui.renderDashboard(); // ë…¸íŠ¸ ëª©ë¡ë„ ë¦¬í”„ë ˆì‹œ
                    }
                } else if (data.type === 'vfs') {
                    // --- ğŸ“Œ [NEW] Case 2: Folder Drop Logic ---
                    const folderId = data.id; // ë“œë˜ê·¸í•œ í´ë”
                    const folder = state.vfsNodes.find(n => n.id === folderId);
                    
                    // ìœ íš¨ì„± ê²€ì‚¬:
                    // 1. ìê¸° ìì‹ ì—ê²Œ ë“œë¡­ ë¶ˆê°€
                    // 2. ë¶€ëª¨ê°€ ì´ë¯¸ ë™ì¼í•œ ê²½ìš°
                    if (!folder || folderId === newParentId || folder.parentId === newParentId) {
                        return;
                    }

                    // 3. ìì‹ ì˜ í•˜ìœ„ í´ë”ë¡œ ì´ë™ ë¶ˆê°€ (ìˆœí™˜ ì°¸ì¡° ë°©ì§€)
                    let p = newParentId;
                    while (p !== 'root' && p != null) {
                        if (p === folderId) {
                            ui.showToast("ìì‹ ì˜ í•˜ìœ„ í´ë”ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                            return;
                        }
                        const parentNode = state.vfsNodes.find(n => n.id === p);
                        p = parentNode ? parentNode.parentId : null;
                    }

                    // ëª¨ë“  ê²€ì‚¬ í†µê³¼: í´ë” ì´ë™
                    folder.parentId = newParentId;
                    await dbService.updateVfsNode(folder);
                    ui.showToast(`'${folder.name}' í´ë”ë¥¼ ì´ë™í–ˆìŠµë‹ˆë‹¤.`, 'success');
                    ui.renderNavPane(); // Nav Paneë§Œ ë¦¬í”„ë ˆì‹œ
                }
            },

            /**
             * ğŸ“Œ [NEW] í´ë” ë“œë˜ê·¸ ì‹œì‘ í•¸ë“¤ëŸ¬
             */
            handleVfsDragStart: (e) => {
                const target = e.target.closest('.nav-filter-btn[data-folder-id]');
                if (target) {
                    const folderId = target.dataset.folderId;
                    // 'ë¯¸ë¶„ë¥˜(root)' í´ë”ëŠ” ë“œë˜ê·¸í•  ìˆ˜ ì—†ìŒ
                    if (folderId === 'root') {
                        e.preventDefault();
                        return;
                    }
                    e.dataTransfer.setData('application/json', JSON.stringify({
                        type: 'vfs',
                        id: folderId
                    }));
                    e.dataTransfer.effectAllowed = 'move';
                }
            },

            // --- ğŸ“Œ [NEW] Responsive Sidebar Handlers ---
            handleHamburgerClick: () => {
                const sidebar = document.getElementById('main-sidebar');
                const backdrop = document.getElementById('sidebar-backdrop');
                if (sidebar && backdrop) {
                    sidebar.classList.remove('-translate-x-full');
                    backdrop.classList.remove('hidden');
                }
            },
            handleBackdropClick: () => {
                const sidebar = document.getElementById('main-sidebar');
                const backdrop = document.getElementById('sidebar-backdrop');
                if (sidebar && backdrop) {
                    sidebar.classList.add('-translate-x-full');
                    backdrop.classList.add('hidden');
                }
            },

            // --- V-02 í•¸ë“¤ëŸ¬ ---
            handleEditorFormChange: () => {
                const saveBtn = document.getElementById('editor-save-btn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                }
            },
            handleEditorCancel: () => {
                // ğŸ“Œ [MODIFIED] ë’¤ë¡œ ê°€ê¸° (ì´ì „ ë·°ê°€ dashboard/note/ID ì¼ ìˆ˜ ìˆìŒ)
                if (state.editingNoteId) {
                    window.location.hash = `#/dashboard/note/${state.editingNoteId}`;
                } else {
                    window.location.hash = '#/dashboard';
                }
            },
            
            // ğŸ“Œ [MODIFIED] ì—ë””í„° ì €ì¥ (AI í´ë” ë®ì–´ì“°ê¸° ë°©ì§€)
            handleEditorSave: async (e) => {
                e.preventDefault();
                ui.showToast("ì €ì¥ ì¤‘...", "loading");
                const form = document.getElementById('editor-form');
                if (!form) {
                    ui.showToast("ì €ì¥ ì‹¤íŒ¨: í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                    return;
                }
                
                // Firestore Timestamp ì‚¬ìš©
                const now = firebase.firestore.FieldValue.serverTimestamp();
                
                const categoryString = helpers.sanitizeCategory(form.elements.category.value);
                let parentId = 'root';
                if (categoryString) {
                    // VFS ë…¸ë“œëŠ” state.vfsNodes (ë¡œì»¬ ìºì‹œ)ë¥¼ ì‚¬ìš©
                    parentId = await dbService.findOrCreateFolderPath(categoryString, state.vfsNodes);
                }
                
                // ğŸ“Œ [NEW] Tagsë¥¼ ë°°ì—´ë¡œ íŒŒì‹±
                const tagNames = helpers.sanitizeTags(form.elements.tags.value);

                const noteData = {
                    title: form.elements.title.value || 'ì œëª© ì—†ìŒ',
                    body: form.elements.body.value,
                    summary: form.elements.summary.value, 
                    parentId: parentId,
                    tags: tagNames, // ğŸ“Œ [NEW] íƒœê·¸ ë°°ì—´
                    updatedAt: now,
                    aiStatus: 'analyzing', 
                    relatedIds: [] 
                };

                try {
                    let savedNoteId;
                    if (state.editingNoteId) {
                        const originalNote = state.notes.find(n => n.id === state.editingNoteId);
                        noteData.id = state.editingNoteId; // ID (ë¬¸ìì—´)
                        noteData.createdAt = originalNote ? originalNote.createdAt : now; // ìƒì„±ì¼ ìœ ì§€
                        noteData.relatedIds = originalNote ? (originalNote.relatedIds || []) : [];
                        await dbService.updateNote(noteData);
                        savedNoteId = noteData.id;
                    } else {
                        noteData.createdAt = now;
                        // ğŸ“Œ [MODIFIED] addNoteëŠ” IDë¥¼ ë°˜í™˜
                        savedNoteId = await dbService.addNote(noteData);
                    }
                    
                    ui.hideToast();
                    ui.showToast("ì €ì¥ ì™„ë£Œ! AI ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...", "loading");
                    
                    // ğŸ“Œ [MODIFIED] DBì—ì„œ ë‹¤ì‹œ ë¡œë“œ (Timestamp ë“±ì„ ë°›ì•„ì˜¤ê¸° ìœ„í•´)
                    await handlers.fetchAllDataAndRender();
                    window.location.hash = `#/dashboard/note/${savedNoteId}`;
                    
                    // ğŸ“Œ [MODIFIED] AI ë¶„ì„ ì‹œ, ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•œ categoryStringì„ ì „ë‹¬í•©ë‹ˆë‹¤.
                    handlers.triggerAiAnalysis(savedNoteId, categoryString);

                } catch (error) {
                    console.error("ì €ì¥ ì‹¤íŒ¨:", error);
                    ui.showToast(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`, "error");
                }
            },
            handleEditorDelete: () => {
                const note = state.notes.find(n => n.id === state.editingNoteId);
                if (note) {
                    ui.showModal(
                        'ë…¸íŠ¸ ì‚­ì œ',
                        `'${note.title}' ë…¸íŠ¸ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                        async () => {
                            await dbService.deleteNote(state.editingNoteId);
                            ui.hideModal();
                            ui.showToast('ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                            
                            // ğŸ“Œ [MODIFIED] ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                            state.notes = state.notes.filter(n => n.id !== state.editingNoteId);
                            state.selectedNoteId = null;
                            state.editingNoteId = null;
                            window.location.hash = '#/dashboard';
                            // ui.handleRouting(); // í•´ì‹œ ë³€ê²½ì´ ìë™ìœ¼ë¡œ ë¼ìš°íŒ… íŠ¸ë¦¬ê±°
                        },
                        { confirmText: 'ì‚­ì œ' }
                    );
                }
            },
            
            // ğŸ“Œ [MODIFIED] C-08 AI ë¶„ì„ (AI í´ë” ë®ì–´ì“°ê¸° ë°©ì§€)
            triggerAiAnalysis: async (noteId, userSpecifiedCategory = null) => {
                if (typeof noteId !== 'string') return; // IDëŠ” ì´ì œ ë¬¸ìì—´
                
                // 1. ğŸ“Œ (v7: state.settings.apiKeysëŠ” {id, name, key} ê°ì²´ ë°°ì—´)
                const apiKeyStrings = (state.settings.apiKeys || []).map(k => k.key).filter(Boolean);
                if (apiKeyStrings.length === 0) {
                    console.error("Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 'ì„¤ì •' íƒ­ì—ì„œ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                    ui.showToast("AI ë¶„ì„ ì‹¤íŒ¨: API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
                    try {
                        const noteToUpdate = await dbService.getNote(noteId);
                        if(noteToUpdate) {
                            noteToUpdate.aiStatus = 'failed';
                            await dbService.updateNote(noteToUpdate);
                            if (state.currentView === 'dashboard') await handlers.fetchAllDataAndRender();
                        }
                    } catch(e) {}
                    return;
                }
                
                // ğŸ“Œ í‚¤ ìˆœí™˜
                state.apiKeyIndex = (state.apiKeyIndex || 0) % apiKeyStrings.length;
                const apiKey = apiKeyStrings[state.apiKeyIndex];
                state.apiKeyIndex++;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                // 2. ë…¸íŠ¸ ìƒíƒœ ë³€ê²½ (ê¸°ì¡´ê³¼ ë™ì¼)
                let note;
                try {
                    note = await dbService.getNote(noteId); // DBì—ì„œ ìµœì‹  ë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
                    if (!note) return;
                    if (note.aiStatus !== 'analyzing') {
                        note.aiStatus = 'analyzing';
                        await dbService.updateNote(note); // note ê°ì²´ ì „ì²´ ì—…ë°ì´íŠ¸
                        if (state.currentView === 'dashboard') {
                             // ë¡œì»¬ stateë„ ì—…ë°ì´íŠ¸í•˜ì—¬ UI ì¦‰ì‹œ ë°˜ì˜
                             const localNote = state.notes.find(n => n.id === noteId);
                             if(localNote) localNote.aiStatus = 'analyzing';
                             ui.renderDashboard();
                        }
                    }
                } catch (error) {
                    console.error("AI ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨ (DB):", error);
                    ui.showToast("AI ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨", "error");
                    return;
                }

                // 3. í”„ë¡¬í”„íŠ¸ ë°ì´í„° ì¤€ë¹„ (IDê°€ ë¬¸ìì—´ì„)
                const otherNotesMetadata = state.notes
                    .filter(n => n.id !== noteId)
                    .map(n => ({ id: n.id, title: n.title, summary: n.summary || helpers.summarize(n.body, 100) }))
                    .slice(0, 30);
                const vfsStructure = state.vfsNodes.map(n => ({ id: n.id, name: n.name, parentId: n.parentId }));
                const systemPrompt = state.settings.aiSystemPrompt;
                const userPrompt = state.settings.aiUserPromptTemplate
                    .replace('{{TITLE}}', note.title)
                    .replace('{{BODY}}', note.body)
                    .replace('{{OTHER_NOTES_JSON}}', JSON.stringify(otherNotesMetadata, null, 2))
                    .replace('{{VFS_STRUCTURE_JSON}}', JSON.stringify(vfsStructure, null, 2));
                
                // 4. Payload (ğŸ“Œ [MODIFIED] suggestedRelatedIdsë¥¼ STRING ë°°ì—´ë¡œ ìš”ì²­)
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userPrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "suggestedSummary": { "type": "STRING" },
                                "suggestedTags": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "suggestedRelatedIds": { "type": "ARRAY", "items": { "type": "STRING" } }, // ğŸ“Œ IDê°€ ë¬¸ìì—´
                                "suggestedFolderPath": { "type": "STRING" }
                            },
                            required: ["suggestedSummary", "suggestedTags", "suggestedRelatedIds", "suggestedFolderPath"]
                        }
                    }
                };

                // 5. API í˜¸ì¶œ ë° ì‘ë‹µ ì²˜ë¦¬ (ğŸ“Œ [MODIFIED] Tag ì €ì¥ ë¡œì§)
                try {
                    const result = await helpers.fetchWithBackoff(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("Invalid AI response structure.");
                    
                    const aiResponse = JSON.parse(jsonText);
                    const latestNote = await dbService.getNote(noteId); // DBì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                    latestNote.summary = latestNote.summary || aiResponse.suggestedSummary;
                    
                    // ğŸ“Œ [MODIFIED] ë¹„ì •ê·œí™”ëœ Tag ì €ì¥
                    const suggestedTagNames = (aiResponse.suggestedTags || [])
                        .map(tag => tag.toLowerCase().trim().replace(/#/g, ''))
                        .filter(Boolean);
                    if (suggestedTagNames.length > 0) {
                        const existingTagNames = latestNote.tags || [];
                        // Setì„ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ì œê±° ë° ë³‘í•©
                        latestNote.tags = Array.from(new Set([...existingTagNames, ...suggestedTagNames]));
                    }
                    
                    latestNote.relatedIds = aiResponse.suggestedRelatedIds || []; // IDëŠ” ì´ë¯¸ ë¬¸ìì—´
                    
                    // ğŸ“Œ [MODIFIED] AI í´ë” ì œì•ˆ ë¡œì§ (ë²„ê·¸ ìˆ˜ì •)
                    if (userSpecifiedCategory === null && aiResponse.suggestedFolderPath) {
                        try {
                            // state.vfsNodesë¥¼ ìµœì‹ ìœ¼ë¡œ ìœ ì§€í•˜ë©° í´ë” ìƒì„±
                            const newParentId = await dbService.findOrCreateFolderPath(aiResponse.suggestedFolderPath, state.vfsNodes);
                            latestNote.parentId = newParentId;
                        } catch (folderError) {
                            console.error("AI ì œì•ˆ í´ë” ìƒì„± ì‹¤íŒ¨:", folderError);
                        }
                    }
                    // else: ì‚¬ìš©ìê°€ í´ë”ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì§€ì •í–ˆìœ¼ë¯€ë¡œ(userSpecifiedCategoryê°€ nullì´ ì•„ë‹˜), AI ì œì•ˆì„ ë¬´ì‹œí•©ë‹ˆë‹¤.
                    
                    latestNote.aiStatus = 'complete';
                    await dbService.updateNote(latestNote);
                    ui.showToast("AI ë¶„ì„ ì™„ë£Œ!", "success");

                } catch (error) {
                    console.error("AI ë¶„ì„ API í˜¸ì¶œ ì‹¤íŒ¨:", error);
                    ui.showToast(`AI ë¶„ì„ ì‹¤íŒ¨ (í‚¤ ì¸ë±ìŠ¤: ${state.apiKeyIndex - 1})`, "error");
                    try {
                        const noteToUpdate = await dbService.getNote(noteId);
                        if (noteToUpdate) {
                            noteToUpdate.aiStatus = 'failed';
                            await dbService.updateNote(noteToUpdate);
                        }
                    } catch (dbError) {}
                } finally {
                    // ğŸ“Œ [MODIFIED] AI ë¶„ì„ ì™„ë£Œ í›„ ì „ì²´ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                    await handlers.fetchAllDataAndRender();
                }
            },

            // --- V-03 í•¸ë“¤ëŸ¬ ---
            handleManageBack: () => {
                window.location.hash = '#/dashboard';
            },
            
            // ğŸ“Œ [MODIFIED] íƒœê·¸ ì‚­ì œ í•¸ë“¤ëŸ¬
            handleManageDelete: async (e) => {
                const deleteTagBtn = e.target.closest('.manage-delete-tag-btn');
                if (deleteTagBtn) {
                    const tagId = deleteTagBtn.dataset.id; // íƒœê·¸ ì´ë¦„
                    const tagName = deleteTagBtn.dataset.name; // íƒœê·¸ ì´ë¦„
                    if (!tagName) return;
                    
                    // ğŸ“Œ [MODIFIED] ì¹´ìš´íŠ¸
                    const notesWithTag = state.notes.filter(n => n.tags && n.tags.includes(tagName));
                    
                    ui.showModal(
                        'íƒœê·¸ ì‚­ì œ',
                        `'${tagName}' íƒœê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ${notesWithTag.length}ê°œ ë…¸íŠ¸ì—ì„œ ì´ íƒœê·¸ê°€ ì œê±°ë©ë‹ˆë‹¤.`,
                        async () => {
                            ui.showToast("íƒœê·¸ ì‚­ì œ ì¤‘...", "loading");
                            try {
                                // ğŸ“Œ [MODIFIED] ì´ íƒœê·¸ë¥¼ í¬í•¨í•˜ëŠ” ëª¨ë“  ë…¸íŠ¸ë¥¼ ì—…ë°ì´íŠ¸
                                for (const note of notesWithTag) {
                                    note.tags = note.tags.filter(t => t !== tagName);
                                    await dbService.updateNote(note);
                                }
                                ui.hideModal();
                                ui.showToast('íƒœê·¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                // ğŸ“Œ [MODIFIED] DBì—ì„œ ë‹¤ì‹œ ë¡œë“œ
                                await handlers.fetchAllDataAndRender();
                            } catch (error) {
                                ui.showToast("íƒœê·¸ ì‚­ì œ ì‹¤íŒ¨", "error");
                            }
                        },
                        { confirmText: 'ì‚­ì œ' }
                    );
                }
            },

            // --- VFS í´ë” ì•¡ì…˜ í•¸ë“¤ëŸ¬ (ê¸°ì¡´ê³¼ ë™ì¼, IDëŠ” ë¬¸ìì—´) ---
            handleNewFolderClick: async () => {
                // ğŸ“Œ [MODIFIED] ì´ ë²„íŠ¼ì€ ì‚¬ìš©ìì˜ í˜¼ë€ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ í•­ìƒ ìµœìƒìœ„(root)ì— í´ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                const parentId = 'root';
                ui.showModal(
                    'ì‹ ê·œ í´ë” ìƒì„±',
                    'ìƒˆ í´ë”ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:',
                    async (newName) => { 
                        if (newName) {
                            const newNodeData = { name: newName, parentId: parentId };
                            // ğŸ“Œ [MODIFIED] addVfsNodeëŠ” IDë¥¼ ë°˜í™˜
                            const newId = await dbService.addVfsNode(newNodeData);
                            // ë¡œì»¬ ìºì‹œì— ì¦‰ì‹œ ë°˜ì˜
                            state.vfsNodes.push({ id: newId, ...newNodeData });
                            state.expandedFolders.add(parentId); 
                            ui.renderDashboard(); // ğŸ“Œ [FIX] Re-render entire dashboard to recalc counts
                            ui.hideModal();
                        } else if (newName === '') {
                             ui.showToast('í´ë” ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                        }
                    },
                    { showInput: true, inputPlaceholder: 'New Folder', confirmText: 'ìƒì„±' }
                );
            },
            handleRenameFolder: async (id) => {
                const node = state.vfsNodes.find(n => n.id === id);
                if (!node) return;
                ui.showModal(
                    'í´ë” ì´ë¦„ ë³€ê²½',
                    `"${node.name}" í´ë”ì˜ ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`,
                    async (newName) => { 
                        if (newName && newName !== node.name) {
                            node.name = newName;
                            await dbService.updateVfsNode(node);
                            ui.renderDashboard(); // ğŸ“Œ [FIX] Re-render entire dashboard to recalc counts
                            ui.hideModal();
                        } else if (newName === '') {
                            ui.showToast('í´ë” ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                        }
                    },
                    { showInput: true, inputValue: node.name, confirmText: 'ë³€ê²½' }
                );
            },
            handleDeleteFolder: async (id) => {
                const node = state.vfsNodes.find(n => n.id === id);
                if (!node) return;
                const hasChildFolders = state.vfsNodes.some(n => n.parentId === id);
                const hasChildNotes = state.notes.some(n => n.parentId === id);
                if (hasChildFolders || hasChildNotes) {
                    ui.showToast("í´ë”ê°€ ë¹„ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. í•˜ìœ„ í•­ëª©ì„ ë¨¼ì € ì´ë™/ì‚­ì œí•˜ì„¸ìš”.", "error");
                    return;
                }
                ui.showModal(
                    'í´ë” ì‚­ì œ',
                    `'${node.name}' í´ë”ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    async () => {
                        await dbService.deleteVfsNode(id);
                        ui.hideModal();
                        ui.showToast('í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        // ğŸ“Œ [MODIFIED] ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ë¦¬ë Œë”
                        state.vfsNodes = state.vfsNodes.filter(n => n.id !== id);
                        ui.renderDashboard(); // ğŸ“Œ [FIX] Re-render entire dashboard to recalc counts
                    },
                    { confirmText: 'ì‚­ì œ' }
                );
            },

            // --- ğŸ“Œ [NEW] V-04 ì„¤ì • í•¸ë“¤ëŸ¬ (ì €ì¥ ë¡œì§ ë¶„ë¦¬) ---
            handleSettingsBack: () => {
                // ğŸ“Œ [MODIFIED] ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ëŒ€ì‹œë³´ë“œ ë˜ëŠ” ë¡œê·¸ì¸ ë·°ë¡œ ì´ë™
                if (state.isLoggedIn) {
                    window.location.hash = '#/dashboard';
                } else {
                    window.location.hash = '#/login';
                }
            },
            
            /**
             * ğŸ“Œ [NEW] Firebase Config ì €ì¥ í•¸ë“¤ëŸ¬
             */
            handleFirebaseConfigSave: (e) => {
                e.preventDefault();
                const configJson = document.getElementById('settings-firebase-config').value;
                if (!configJson) {
                    ui.showToast("Firebase ì„¤ì • JSONì„ ì…ë ¥í•˜ì„¸ìš”.", "error");
                    return;
                }
                
                if (dbService.saveFirebaseConfig(configJson)) {
                    ui.showToast("Firebase ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...", "success");
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    ui.showToast("ìœ íš¨í•˜ì§€ ì•Šì€ JSON í˜•ì‹ì…ë‹ˆë‹¤. ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                }
            },

            /**
             * ğŸ“Œ [NEW] ì„¤ì • íƒ­ ë„¤ë¹„ê²Œì´ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬
             */
            handleSettingsNavClick: (e) => {
                const navBtn = e.target.closest('button[data-section]');
                if (!navBtn) return;
                
                const sectionId = navBtn.dataset.section;
                ui.showSettingsSection(sectionId);
            },

            /**
             * ğŸ“Œ [MODIFIED] AI/í”„ë¡¬í”„íŠ¸ ì„¤ì • ì €ì¥ í•¸ë“¤ëŸ¬ (Firestoreì— ì €ì¥)
             */
            handleSettingsSave: async (e) => {
                e.preventDefault();
                ui.showToast("ì„¤ì • ì €ì¥ ì¤‘...", "loading");
                
                const form = document.getElementById('settings-form');
                if (!form) return;

                const keyDomItems = document.querySelectorAll('#settings-api-key-list .api-key-item');
                const newApiKeys = [];
                
                try {
                    // 1. API í‚¤ (DOMì—ì„œ ì½ê¸°)
                    for (const item of keyDomItems) {
                        const id = item.querySelector('.api-key-id').value || crypto.randomUUID(); // ìƒˆ í‚¤ëŠ” UUID ìƒì„±
                        const name = item.querySelector('.api-key-name').value.trim();
                        const key = item.querySelector('.api-key-value').value.trim();

                        if (!name || !key) {
                            ui.showToast("í‚¤ ë ˆì´ë¸”ê³¼ í‚¤ ê°’ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                            continue; // ì´ í‚¤ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŒ
                        }
                        newApiKeys.push({ id, name, key });
                    }
                    
                    // 2. í”„ë¡¬í”„íŠ¸/ì„¤ì • ê°ì²´ ìƒì„±
                    const newSettings = {
                        aiSystemPrompt: form.elements.aiSystemPrompt.value,
                        aiUserPromptTemplate: form.elements.aiUserPromptTemplate.value,
                        apiKeys: newApiKeys // ğŸ“Œ API í‚¤ ë°°ì—´ì„ settings ê°ì²´ì— í¬í•¨
                    };
                    
                    // 3. Firestoreì— ì €ì¥
                    await dbService.saveSettings(newSettings);
                    
                    // 4. ë¡œì»¬ state ì—…ë°ì´íŠ¸
                    state.settings = { ...state.settings, ...newSettings };
                    
                    ui.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                } catch (error) {
                    console.error("ì„¤ì • ì €ì¥ ì‹¤íŒ¨:", error);
                    ui.showToast('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            },
            
            // ğŸ“Œ [MODIFIED] Gemini API í‚¤ ì¶”ê°€ (DOMë§Œ ì¡°ì‘)
            handleSettingsAddApiKeyClick: () => {
                const keyListContainer = document.getElementById('settings-api-key-list');
                const noKeyMsg = keyListContainer.querySelector('p');
                if (noKeyMsg) noKeyMsg.remove();
                
                const keyEl = document.createElement('div');
                keyEl.className = 'api-key-item relative flex items-center space-x-2';
                keyEl.innerHTML = `
                    <input type="hidden" class="api-key-id" value="">
                    <input type="text" class="api-key-name w-1/3 p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="í‚¤ ë ˆì´ë¸” (ì˜ˆ: 'Primary')">
                    <input type="password" class="api-key-value w-2/3 p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="sk-...">
                    <button type="button" class="toggle-api-key-btn absolute inset-y-0 right-10 px-3 flex items-center text-gray-500 hover:text-blue-600" title="í‚¤ ë³´ê¸°/ìˆ¨ê¸°ê¸°">
                        <i class="bi bi-eye-fill"></i>
                    </button>
                    <button type="button" class="delete-api-key-btn flex-shrink-0 text-gray-400 hover:text-red-600" title="í‚¤ ì‚­ì œ">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                `;
                keyListContainer.appendChild(keyEl);
                keyEl.querySelector('.api-key-name')?.focus();
            },
            
            // ğŸ“Œ [MODIFIED] Gemini API í‚¤ í† ê¸€/ì‚­ì œ (DOMë§Œ ì¡°ì‘)
            handleSettingsKeyListClick: (e) => {
                const toggleBtn = e.target.closest('.toggle-api-key-btn');
                const deleteBtn = e.target.closest('.delete-api-key-btn');
                
                if (toggleBtn) {
                    const input = toggleBtn.closest('.api-key-item').querySelector('.api-key-value');
                    const icon = toggleBtn.querySelector('i');
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('bi-eye-fill');
                        icon.classList.add('bi-eye-slash-fill');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('bi-eye-slash-fill');
                        icon.classList.add('bi-eye-fill');
                    }
                }
                
                if (deleteBtn) {
                    deleteBtn.closest('.api-key-item').remove();
                }
            },

            // --- C-14 Modal í•¸ë“¤ëŸ¬ (ê¸°ì¡´ê³¼ ë™ì¼) ---
            handleModalCancel: () => {
                ui.hideModal();
            },
            handleModalConfirm: () => {
                if (state.modalConfirmCallback) {
                    try {
                        const modalInput = document.getElementById('c14-modal-input');
                        const inputValue = modalInput.classList.contains('hidden') ? null : modalInput.value;
                        if (inputValue !== null) {
                            state.modalConfirmCallback(inputValue);
                        } else {
                            state.modalConfirmCallback();
                        }
                    } catch (error) {
                        console.error("Modal confirm callback error:", error);
                    }
                }
            },

            // --- ê²€ìƒ‰ í•¸ë“¤ëŸ¬ (ê¸°ì¡´ê³¼ ë™ì¼) ---
            handleNavSearch: (e) => {
                state.navSearchTerm = e.target.value;
                ui.renderNavPane();
            },
            handleNoteSearch: (e) => {
                state.noteSearchTerm = e.target.value;
                ui.renderNoteListPane();
            },
            handleManageSearch: () => {
                ui.renderManagement();
            }
        };

        // --- 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”(Initialization) ---
        /**
         * ğŸ“Œ [NEW] ì•± ì‹œì‘ ë©”ì¸ í•¨ìˆ˜
         */
        function initApp() {
             try {
                // 1. ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë¨¼ì € ë°”ì¸ë”©í•©ë‹ˆë‹¤.
                handlers.initEvents();
                
                // 2. localStorageì—ì„œ Firebase Configë¥¼ ì½ì–´ ì´ˆê¸°í™”ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.
                const isFirebaseReady = dbService.initDB();
                
                if (isFirebaseReady) {
                    // 3. ì´ˆê¸°í™” ì„±ê³µ: Firebase Auth ìƒíƒœ ë³€ê²½ì„ ê°ì§€í•©ë‹ˆë‹¤.
                    console.log("Firebase ì¤€ë¹„ ì™„ë£Œ. ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...");
                    state.isFirebaseReady = true;
                    dbService.watchAuth(handlers.onAuthStateChanged);
                } else {
                    // 4. ì´ˆê¸°í™” ì‹¤íŒ¨ (Config ì—†ìŒ): 'ì„¤ì •' ë·°ë¡œ ê°•ì œ ì´ë™
                    console.log("Firebase ì¤€ë¹„ ì•ˆë¨. ì„¤ì • ë·°ë¡œ ì´ë™.");
                    state.isFirebaseReady = false;
                    window.location.hash = '#/settings';
                    ui.handleRouting(); // ë¼ìš°í„°ê°€ 'ì„¤ì •' ë·°ë¥¼ ë Œë”ë§í•˜ë„ë¡ í•¨
                }
                
                // (ì´ì „ 'fetchAllDataAndRender' í˜¸ì¶œì€ watchAuth ë‚´ë¶€ë¡œ ì´ë™ë¨)
                
            } catch (error) {
                console.error('ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨:', error);
                document.body.innerHTML = '<p class="text-center text-red-500 p-10">ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>';
            }
        }
        
        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì•± ì‹œì‘
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

