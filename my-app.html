<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë“œí˜• ì¹¸ë°˜ ì„ë¬´ ì²´ê³„</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .kanban-column {
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        .task-card {
            cursor: grab; /* ë“œë˜ê·¸ ê°€ëŠ¥í•¨ì„ ë‚˜íƒ€ë‚´ëŠ” ì»¤ì„œ */
            transition: all 0.2s ease-in-out;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .task-card.dragging {
            opacity: 0.5; /* ë“œë˜ê·¸ ì¤‘ì¸ ì¹´ë“œ íˆ¬ëª…í•˜ê²Œ */
        }
        .kanban-column.drag-over {
            background-color: #e0f2fe; /* blue-100 ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ ë°°ê²½ ë³€ê²½ */
            border-color: #38b2ac; /* teal-500 */
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
            overflow-y: auto; /* Ensure scrollability for small screens */
            padding: 1rem;
        }
        .modal-content {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            /* ë°˜ì‘ì„±ì„ ìœ„í•´ max-widthë¥¼ 90%ë¡œ ìœ ì§€í•˜ê³ , ê³ ì •ê°’ ëŒ€ì‹  rem ì‚¬ìš© */
            max-width: 56rem; /* Tailwind's max-w-2xl is 42rem, max-w-4xl is 56rem */
            max-height: 90vh; /* Viewport height percentage */
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideInUp 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: bold;
            z-index: 1001;
            animation: toastFadeIn 0.3s ease-out, toastFadeOut 0.5s ease-out 2.5s forwards;
        }
        .toast.success { background-color: #22c55e; } /* green-500 */
        .toast.error { background-color: #ef4444; }   /* red-500 */
        .toast.info { background-color: #3b82f6; }    /* blue-500 */

        @keyframes toastFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        @keyframes toastFadeOut {
            to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
        /* ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ì¤„ ë°”ê¿ˆ ë° ì™„ë£Œ ì‹œ ìƒ‰ìƒ ë³€ê²½) */
        .checklist-item-text-input {
            white-space: normal; /* ê¸°ë³¸ ì¤„ ë°”ê¿ˆ í—ˆìš© */
            word-break: break-word; /* ê¸´ ë‹¨ì–´ê°€ ì˜ë¦¬ì§€ ì•Šê³  ì¤„ ë°”ê¿ˆ ë˜ë„ë¡ */
            width: 100%; /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ë¥¼ ì±„ìš°ë„ë¡ */
            background-color: transparent; /* ë°°ê²½ íˆ¬ëª… */
            border: none; /* í…Œë‘ë¦¬ ì œê±° */
            outline: none; /* í¬ì»¤ìŠ¤ ì•„ì›ƒë¼ì¸ ì œê±° */
        }
        .checklist-item-text-input.completed {
            color: #9ca3af; /* gray-400 */
            text-decoration: line-through;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Google ë¡œê·¸ì¸ ê´€ë ¨ ëª¨ë“ˆ ì¶”ê°€
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ë“¤ì´ ì •ì˜ë˜ì–´ ìˆì§€ ì•Šì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ê¸°ë³¸ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        // Canvas í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ì§€ ì•Šì„ ê²½ìš°, ì—¬ê¸°ì— ì§ì ‘ Firebase êµ¬ì„± ì •ë³´ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
        // 1. Firebase í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  ì›¹ ì•±ì„ ì¶”ê°€í•œ í›„ 'firebaseConfig' ê°ì²´ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        // 2. Firestore ë°ì´í„°ë² ì´ìŠ¤ì™€ Google ì¸ì¦ì„ í™œì„±í™”í•˜ì„¸ìš”. (ì¤‘ìš”: Firebase ì½˜ì†”ì—ì„œ "Authentication" -> "Sign-in method" íƒ­ì—ì„œ Google ë¡œê·¸ì¸ ê³µê¸‰ìë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.)
        // 3. Firestore ê·œì¹™ì„ ì´ì „ì— ì œê³µëœ ê·œì¹™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.
        // **** ì¤‘ìš”: ë¡œì»¬ì—ì„œ ê°œë°œ ì‹œ, Firebase ì½˜ì†”ì˜ Authentication -> Settings íƒ­ì—ì„œ
        //            'Authorized domains'ì— 'localhost' (ë° '127.0.0.1' í•„ìš” ì‹œ)ë¥¼ ë°˜ë“œì‹œ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. ****
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBhdnR6FVsIyX4ZqmhWs4kGpJJ1XTeTUtc",
            authDomain: "mykanban-1b1d8.firebaseapp.com",
            projectId: "mykanban-1b1d8",
            storageBucket: "mykanban-1b1d8.firebasestorage.app",
            messagingSenderId: "883153186548",
            appId: "1:883153186548:web:30b213362194ab2fd178a1",
            // measurementId: "G-5GXC1KK383" // ì´ ì•±ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•´ë„ ë¬´ë°©.
        };
        // projectIdë¥¼ appIdë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        window.appId = typeof __app_id !== 'undefined' ? __app_id : window.firebaseConfig.projectId;
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // ë¡œì»¬ì—ì„œëŠ” ì´ í† í°ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

        // Firebase ì´ˆê¸°í™” (ì•± ë¡œë“œ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰)
        try {
            window.firebaseApp = initializeApp(window.firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”:", e);
            document.getElementById('loading-overlay').innerHTML = `
                <div class="flex flex-col items-center p-6 bg-white rounded-xl shadow-lg text-center">
                    <p class="text-red-600 font-bold text-lg mb-2">ì˜¤ë¥˜: Firebase ì´ˆê¸°í™” ì‹¤íŒ¨</p>
                    <p class="text-gray-700 text-md">ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                    <p class="text-gray-500 text-sm mt-2">(API í‚¤ ë˜ëŠ” í”„ë¡œì íŠ¸ ID ëˆ„ë½ ë“±)</p>
                </div>
            `;
        }

        // ì „ì—­ ë²”ìœ„ì— Firebase í•¨ìˆ˜ë“¤ì„ ë…¸ì¶œí•©ë‹ˆë‹¤.
        window.getAuth = getAuth;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
    </script>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-[2000]">
        <div class="flex flex-col items-center p-6 bg-white rounded-xl shadow-lg">
            <svg class="animate-spin h-8 w-8 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-700 text-lg">ì¸ì¦ ë° ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <div class="min-h-screen p-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header with Title and Settings -->
            <header class="flex justify-between items-center mb-8 p-4 rounded-xl shadow-lg bg-white">
                <h1 class="text-4xl font-extrabold text-blue-800">
                    ì¹´ë“œí˜• ì¹¸ë°˜ ì„ë¬´ ì²´ê³„ ğŸš€
                </h1>
                <div class="flex items-center space-x-4">
                    <!-- Google ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì´ ì´ì œ ì„¤ì • ëª¨ë‹¬ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤. -->
                    <button id="settings-button" class="text-gray-600 hover:text-blue-800 text-3xl transition duration-200">
                        <i class="fas fa-bars"></i> <!-- Hamburger icon for settings -->
                    </button>
                </div>
            </header>

            <p id="user-id-display" class="text-center text-sm text-gray-500 mb-4"></p>

            <!-- ìƒˆ ì¹´ë“œ ì¶”ê°€ ì„¹ì…˜ -->
            <div class="bg-white p-6 rounded-xl shadow-xl mb-8 border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">ìƒˆë¡œìš´ ì„ë¬´ ì¶”ê°€</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input
                        type="text"
                        id="new-card-title"
                        placeholder="ì„ë¬´ ì œëª© (ì˜ˆ: íŒ€ íšŒì˜ ì¤€ë¹„)"
                        class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-lg"
                    />
                    <textarea
                        id="new-card-description"
                        placeholder="ìƒì„¸ ì„¤ëª… (ì„ íƒ ì‚¬í•­, 1000ì ì œí•œ)"
                        rows="2"
                        maxlength="1000"
                        class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-lg resize-y"
                    ></textarea>
                </div>
                <button
                    id="add-card-button"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-xl"
                >
                    ì„ë¬´ ì¹´ë“œ ì¶”ê°€
                </button>
            </div>

            <!-- ì¹¸ë°˜ ë³´ë“œ ì„¹ì…˜ -->
            <div id="kanban-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Columns will be rendered here by JavaScript -->
            </div>

            <!-- ì „ì²´ í”„ë¡œì íŠ¸ AI ë³´ê³ ì„œ ì„¹ì…˜ -->
            <div class="bg-white p-6 rounded-xl shadow-xl mt-8 border border-green-200">
                <h2 class="text-2xl font-semibold text-green-700 mb-4 flex items-center">
                    <i class="fas fa-brain mr-3"></i> ì „ì²´ í”„ë¡œì íŠ¸ AI ë³´ê³ ì„œ
                </h2>
                <button
                    id="overall-ai-report-button"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-xl flex items-center justify-center"
                >
                    <span id="overall-ai-report-loading-text">AI ë³´ê³ ì„œ ìƒì„±</span>
                    <svg id="overall-ai-report-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
                <div id="overall-ai-report-content" class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200 hidden">
                    <pre class="whitespace-pre-wrap font-mono text-gray-800 text-sm leading-relaxed"></pre>
                    <p id="overall-ai-report-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals (Initially hidden) -->
    <div id="task-detail-modal" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <!-- Modal content will be dynamically rendered here -->
        </div>
    </div>

    <div id="settings-modal" class="modal hidden">
        <div class="modal-content w-full max-w-3xl">
            <!-- Settings content will be dynamically rendered here -->
        </div>
    </div>

    <!-- Confirmation Modal (for task deletion) -->
    <div id="confirm-modal" class="modal hidden">
        <div class="modal-content p-6 max-w-sm text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
            <p class="text-gray-700 mb-6">ì‚­ì œëœ ì„ë¬´ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">ì·¨ì†Œ</button>
                <button id="confirm-delete-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">ì‚­ì œ</button>
            </div>
        </div>
    </div>


    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 left-1/2 -translate-x-1/2 flex flex-col items-center space-y-2 z-[1001]"></div>

    <script>
        // Global state variables
        let currentUserId = null;
        let isAuthReady = false;
        let tasks = []; // Array of all tasks
        let currentSettings = {
            gemini_api_key: '', // Gemini API Key
            // ëª¨ë“  í”„ë¡¬í”„íŠ¸ì— 'interaction language : korean' ì¶”ê°€
            ai_checklist_prompt: "interaction language : korean\nGenerate a detailed task checklist and execution steps for the task: '{taskTitle}'. Provide the response only as a JSON object with a single key 'checklist' which is an array of strings. Each string should be a step. Do not include any other text or explanation. Example: {\"checklist\": [\"Step 1: Get started\", \"Step 2: Finish up\"]}",
            ai_advice_prompt: "interaction language : korean\nGiven the following task details and history, provide concise advice or a helpful notification for the user. Focus on actionable insights or next steps. Provide the response only as a JSON object with a single key 'advice' which is a string. Do not include any other text or explanation. Task Details:\\n{taskDetails}\\n\\nTask History:\\n{historyDetails}\\n\\nExample: {\"advice\": \"Consider breaking down complex steps into smaller actions for better progress tracking.\"}",
            ai_overall_report_prompt: "interaction language : korean\nGiven the following user information, global AI requirements, and a list of all tasks across different Kanban columns, provide a concise summary of the project status, identify the most critical next steps, and offer strategic advice. Provide the response only as a JSON object with keys 'summary' (string), 'recommendedActions' (array of strings), and 'strategicAdvice' (string). Do not include any other text or explanation.\n\nUser Information:\\n{userInfo}\n\nGlobal AI Requirements:\\n{globalAIRequirements}\n\nAll Tasks (Title, Description, Checklist, Status, History):\\n{allTasksDetails}\n\nExample: {\"summary\": \"Project is at a critical juncture.\", \"recommendedActions\": [\"Prioritize 'Fix login bug'\", \"Review 'Marketing campaign' progress\"], \"strategicAdvice\": \"Focus on immediate blockers before planning new features.\"}",
            ai_general_assistant_prompt: "interaction language : korean\nYou are a highly capable AI assistant for a Kanban task management system. Your goal is to help the user manage their tasks efficiently and provide insightful assistance based on their specific commands. Analyze the provided task details, user information, global AI requirements, and your past interactions. Respond concisely and directly to the user's command. If a specific action is requested (e.g., 'generate X steps'), try to fulfill it. If a question is asked, answer it. If you cannot fulfill the request or need more information, clearly state so.\n\nUser Information:\\n{userInfo}\n\nGlobal AI Requirements:\\n{globalAIRequirements}\n\nCurrent Task Details:\\n{taskDetails}\n\nTask History:\\n{historyDetails}\n\nUser Command:\\n{userCommand}\n\nProvide the response only as a JSON object with a single key 'response' which is a string. Do not include any other text or explanation outside the 'response' key.",
            user_info: {
                name: '',
                role: '',
                goals: ''
            },
            global_ai_requirements: "Think slowly and meticulously, review the question content tens of thousands of times, and generate answers to the question diligently without laziness." // ì „ì—­ í”„ë¡¬í”„íŠ¸ ì¶”ê°€
        };

        const kanbanColumns = [
            { id: 'todo', title: 'í•  ì¼' },
            { id: 'in-progress', title: 'ì§„í–‰ ì¤‘' },
            { id: 'review', title: 'ê²€í† ' },
            { id: 'done', title: 'ì™„ë£Œ' },
        ];

        // DOM elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const userIdDisplay = document.getElementById('user-id-display');
        const newCardTitleInput = document.getElementById('new-card-title');
        const newCardDescriptionInput = document.getElementById('new-card-description');
        const addCardButton = document.getElementById('add-card-button');
        const kanbanBoard = document.getElementById('kanban-board');
        const taskDetailModal = document.getElementById('task-detail-modal');
        const taskDetailModalContent = taskDetailModal.querySelector('.modal-content');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsModalContent = settingsModal.querySelector('.modal-content');
        const overallAIReportButton = document.getElementById('overall-ai-report-button');
        const overallAIReportLoadingText = document.getElementById('overall-ai-report-loading-text');
        const overallAIReportLoadingSpinner = document.getElementById('overall-ai-report-loading-spinner');
        const overallAIReportContent = document.getElementById('overall-ai-report-content');
        const overallAIReportError = document.getElementById('overall-ai-report-error');
        const toastContainer = document.getElementById('toast-container');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmCancelButton = document.getElementById('confirm-cancel-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');

        // Firestore references (will be set after Firebase init)
        let tasksCollectionRef;
        let settingsDocRef;

        // --- Utility Functions ---

        /**
         * Shows a toast notification.
         * @param {string} message - The message to display.
         * @param {'success' | 'error' | 'info'} type - Type of toast.
         */
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Remove toast after a delay
            setTimeout(() => {
                toast.remove();
            }, 3000); // 3 seconds
        }

        /**
         * Debounce function to limit function call frequency.
         * @param {function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Helper function to add a history entry to a task.
         * Limits the event string to 100 characters.
         * @param {object} task - The task object to update.
         * @param {string} event - The event description.
         * @returns {object} - The updated task object with new history.
         */
        function addHistoryEntry(task, event) {
            const newHistory = task.history ? [...task.history] : [];
            const limitedEvent = event.substring(0, 100); // 100ì ì œí•œ
            newHistory.push({ timestamp: Date.now(), event: limitedEvent });
            return { ...task, history: newHistory };
        }

        /**
         * HTML sanitization helper to prevent XSS.
         * @param {string} text - The input text.
         * @returns {string} - Sanitized text.
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        // --- Core Render Functions ---

        /**
         * Handles drag start event for task cards.
         * @param {DragEvent} event
         */
        function drag(event) {
            event.dataTransfer.setData("text/plain", event.target.id);
            event.dataTransfer.setData("text/sourceColumnId", event.target.closest('.kanban-column').id);
            event.target.classList.add('dragging'); // ë“œë˜ê·¸ ì¤‘ ì‹œê°ì  í”¼ë“œë°±
        }

        /**
         * Allows dropping on a Kanban column.
         * @param {DragEvent} event
         */
        function allowDrop(event) {
            event.preventDefault(); // Necessary to allow drop
            // ë“œë˜ê·¸ ì˜¤ë²„ ì‹œ ì»¬ëŸ¼ ë°°ê²½ ë³€ê²½
            event.currentTarget.classList.add('drag-over');
        }

        /**
         * Handles drag leave event from a Kanban column.
         * @param {DragEvent} event
         */
        function dragLeave(event) {
            // ë“œë˜ê·¸ ë¦¬ë¸Œ ì‹œ ì»¬ëŸ¼ ë°°ê²½ ë³µì›
            event.currentTarget.classList.remove('drag-over');
        }

        /**
         * Handles drop event on a Kanban column.
         * @param {DragEvent} event
         */
        async function drop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over'); // ë“œë¡­ í›„ ë°°ê²½ ë³µì›

            const taskId = event.dataTransfer.getData("text/plain").replace('task-card-', ''); // Remove prefix
            const sourceColumnId = event.dataTransfer.getData("text/sourceColumnId");
            const targetColumnId = event.currentTarget.id; // Get ID of the column where it's dropped

            const draggedCard = document.getElementById(`task-card-${taskId}`);
            if (draggedCard) {
                draggedCard.classList.remove('dragging'); // ë“œë˜ê·¸ í”¼ë“œë°± ì œê±°
            }

            if (sourceColumnId !== targetColumnId) {
                await moveCard(taskId, targetColumnId);
            }
        }

        /**
         * Renders the entire Kanban board and its cards.
         */
        function renderKanbanBoard() {
            kanbanBoard.innerHTML = ''; // Clear existing board

            // Group tasks by columnId
            const columnsWithTasks = kanbanColumns.map(col => ({
                ...col,
                tasks: tasks.filter(task => task.columnId === col.id).sort((a, b) => a.createdAt - b.createdAt)
            }));

            columnsWithTasks.forEach(column => {
                const columnDiv = document.createElement('div');
                columnDiv.id = column.id; // ì»¬ëŸ¼ ID ì„¤ì • (ë“œë¡­ íƒ€ê²Ÿìœ¼ë¡œ ì‚¬ìš©)
                columnDiv.className = 'kanban-column bg-blue-50 p-5 rounded-xl shadow-lg border border-blue-300';
                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                columnDiv.addEventListener('dragover', allowDrop);
                columnDiv.addEventListener('dragleave', dragLeave);
                columnDiv.addEventListener('drop', drop);

                columnDiv.innerHTML = `
                    <h2 class="text-2xl font-bold text-blue-800 mb-5 border-b-2 border-blue-400 pb-3">
                        ${escapeHtml(column.title)} (${column.tasks.length})
                    </h2>
                    <div class="flex-grow space-y-4">
                        ${column.tasks.length === 0 ? `<p class="text-gray-500 text-center py-4">ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>` : ''}
                    </div>
                `;
                const tasksContainer = columnDiv.querySelector('.flex-grow.space-y-4');

                column.tasks.forEach(task => {
                    const cardDiv = document.createElement('div');
                    cardDiv.id = `task-card-${task.id}`;
                    cardDiv.className = 'task-card bg-white p-4 rounded-lg shadow-md border border-gray-200';
                    cardDiv.setAttribute('draggable', 'true'); // ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
                    cardDiv.addEventListener('dragstart', drag); // ë“œë˜ê·¸ ì‹œì‘ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                    cardDiv.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${escapeHtml(task.title)}</h3>
                        ${task.description ? `<p class="text-sm text-gray-600 mb-3 line-clamp-2">${escapeHtml(task.description)}</p>` : ''}
                        <button class="ai-assist-checklist-button w-full bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center mb-3" data-task-id="${task.id}" data-task-title="${escapeHtml(task.title)}">
                            AI ë³´ì¡° (ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±)
                        </button>
                    `;
                    cardDiv.addEventListener('click', () => openDetailModal(task, column.id));
                    tasksContainer.appendChild(cardDiv);
                });
                kanbanBoard.appendChild(columnDiv);
            });

            // Attach event listeners for AI assist buttons after rendering
            document.querySelectorAll('.ai-assist-checklist-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.stopPropagation(); // Prevent opening detail modal
                    const taskId = e.target.dataset.taskId;
                    const taskTitle = e.target.dataset.taskTitle;

                    // AI ê¸°ëŠ¥ ì‚¬ìš© ì „ API í‚¤ í™•ì¸
                    if (!currentSettings.gemini_api_key) {
                        showToast("AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                        openSettingsModal(); // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
                        return;
                    }

                    e.target.disabled = true; // Disable button during AI call
                    e.target.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ìƒì„± ì¤‘...`;
                    await handleAIAssistChecklist(taskId, taskTitle);
                    e.target.disabled = false; // Re-enable button
                    e.target.innerHTML = 'AI ë³´ì¡° (ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±)';
                });
            });
        }

        /**
         * Renders the task detail modal.
         * @param {object} task - The task object.
         * @param {string} currentColumnId - The ID of the column the task is currently in.
         */
        function renderTaskDetailModal(task, currentColumnId) {
            taskDetailModalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <input
                        type="text"
                        id="modal-task-title"
                        value="${escapeHtml(task.title)}"
                        class="text-3xl font-bold text-blue-800 w-full bg-transparent border-none focus:ring-0 focus:outline-none"
                    />
                    <button id="modal-close-button" class="text-gray-500 hover:text-gray-700 text-4xl leading-none font-light">
                        &times;
                    </button>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-gray-700 mb-2">ìƒì„¸ ì„¤ëª…</h4>
                    <textarea
                        id="modal-task-description"
                        rows="4"
                        maxlength="1000"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-lg resize-y"
                        placeholder="ìƒì„¸ ì„¤ëª… ì¶”ê°€..."
                    >${escapeHtml(task.description || '')}</textarea>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-gray-700 mb-2">ì²´í¬ë¦¬ìŠ¤íŠ¸</h4>
                    <div id="modal-checklist-items" class="space-y-2">
                        ${task.checklist && task.checklist.length > 0 ?
                            task.checklist.map((item, index) => `
                                <div class="flex items-center text-lg text-gray-800 group">
                                    <input type="checkbox" id="checklist-item-${index}" class="mr-3 h-5 w-5 rounded text-blue-600 focus:ring-blue-500" ${item.completed ? 'checked' : ''}>
                                    <input type="text" value="${escapeHtml(item.text)}" class="flex-grow ${item.completed ? 'checklist-item-text-input completed' : 'checklist-item-text-input'}" data-index="${index}">
                                    <button class="delete-checklist-item-button text-red-500 hover:text-red-700 ml-2 text-xl opacity-0 group-hover:opacity-100 transition-opacity" data-index="${index}">&times;</button>
                                </div>
                            `).join('')
                            : `<p class="text-gray-500">ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`
                        }
                    </div>
                    <div class="flex items-center mt-3">
                        <input type="text" id="add-checklist-item-input" class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-md" placeholder="ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€">
                        <button id="add-checklist-item-button" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white text-md font-bold py-2 px-4 rounded-lg shadow-sm transition duration-200">ì¶”ê°€</button>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-xl font-semibold text-gray-700 mb-2">ë©”ëª¨</h4>
                    <textarea
                        id="modal-task-memo"
                        rows="3"
                        maxlength="1000"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-lg resize-y"
                        placeholder="ë©”ëª¨ ì¶”ê°€..."
                    >${escapeHtml(task.memo || '')}</textarea>
                </div>

                <!-- AI ë¹„ì„œ (ëŒ€í™”í˜•) -->
                <div class="mb-6 border-t pt-4 border-gray-200">
                    <h4 class="text-xl font-semibold text-blue-700 mb-2 flex items-center"><i class="fas fa-robot mr-2"></i> AI ë¹„ì„œ</h4>
                    <textarea id="ai-assistant-command-input" rows="3" maxlength="500" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-lg resize-y mb-3" placeholder="AIì—ê²Œ ëª…ë ¹í•˜ê±°ë‚˜ ì§ˆë¬¸í•˜ì„¸ìš” (ì˜ˆ: ì´ ì„ë¬´ì˜ ë‹¤ìŒ ë‹¨ê³„ 3ê°€ì§€ ìƒì„±í•´ì¤˜)."></textarea>
                    <button id="send-ai-command-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-lg flex items-center justify-center">
                        <span id="send-ai-command-loading-text">AIì—ê²Œ ëª…ë ¹</span>
                        <svg id="send-ai-command-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <p id="ai-assistant-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </div>

                <div class="mb-6 border-t pt-4 border-gray-200 max-h-48 overflow-y-auto">
                    <h4 class="text-xl font-semibold text-gray-700 mb-2">ì„ë¬´ ê¸°ë¡</h4>
                    <ul class="space-y-1 text-sm text-gray-600">
                        ${task.history && task.history.length > 0 ?
                            task.history.slice().reverse().map(entry => `
                                <li class="border-b border-gray-100 py-1 last:border-b-0">
                                    <span class="font-mono text-gray-500 text-xs mr-2">[${new Date(entry.timestamp).toLocaleString()}]</span>
                                    ${escapeHtml(entry.event)}
                                </li>
                            `).join('')
                            : `<p class="text-gray-500">ê¸°ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>`
                        }
                    </ul>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 flex flex-wrap gap-2 justify-center">
                    ${kanbanColumns.map(col => `
                        ${col.id !== currentColumnId ? `
                            <button class="move-card-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200" data-target-column="${col.id}">
                                ${escapeHtml(col.title)}ìœ¼ë¡œ ì´ë™
                            </button>
                        ` : ''}
                    `).join('')}
                    <button id="delete-task-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                        ì„ë¬´ ì‚­ì œ
                    </button>
                </div>
            `;

            // Attach event listeners for modal elements
            document.getElementById('modal-close-button').addEventListener('click', closeDetailModal);

            const modalTaskTitleInput = document.getElementById('modal-task-title');
            const modalTaskDescriptionInput = document.getElementById('modal-task-description');
            const modalTaskMemoInput = document.getElementById('modal-task-memo');

            modalTaskTitleInput.addEventListener('input', debounce((e) => updateTaskField(task.id, 'title', e.target.value), 500));
            modalTaskDescriptionInput.addEventListener('input', debounce((e) => updateTaskField(task.id, 'description', e.target.value), 500));
            modalTaskMemoInput.addEventListener('input', debounce((e) => updateTaskField(task.id, 'memo', e.target.value), 500));

            // Checklist event listeners
            document.querySelectorAll('#modal-checklist-items input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const index = parseInt(e.target.id.split('-')[2]);
                    toggleChecklistItem(task.id, index);
                });
            });
            document.querySelectorAll('#modal-checklist-items input[type="text"]').forEach(input => {
                input.addEventListener('input', debounce((e) => {
                    const index = parseInt(e.target.dataset.index);
                    editChecklistItem(task.id, index, e.target.value);
                }, 500));
            });
            document.querySelectorAll('.delete-checklist-item-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // íŒì—… ë‹«ê¸° ë°©ì§€
                    const index = parseInt(e.target.dataset.index);
                    deleteChecklistItem(task.id, index);
                });
            });
            document.getElementById('add-checklist-item-button').addEventListener('click', () => {
                const input = document.getElementById('add-checklist-item-input');
                if (input.value.trim()) {
                    addChecklistItem(task.id, input.value.trim());
                    input.value = '';
                }
            });

            // AI Assistant Send Command button
            document.getElementById('send-ai-command-button').addEventListener('click', async () => {
                const commandInput = document.getElementById('ai-assistant-command-input');
                const command = commandInput.value.trim();
                if (!command) {
                    showToast("AIì—ê²Œ ëª…ë ¹í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "info");
                    return;
                }

                // AI ê¸°ëŠ¥ ì‚¬ìš© ì „ API í‚¤ í™•ì¸
                if (!currentSettings.gemini_api_key) {
                    showToast("AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                    openSettingsModal(); // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
                    return;
                }

                const btn = document.getElementById('send-ai-command-button');
                const loadingText = document.getElementById('send-ai-command-loading-text');
                const spinner = document.getElementById('send-ai-command-loading-spinner');
                const errorDisplay = document.getElementById('ai-assistant-error');

                btn.disabled = true;
                loadingText.textContent = 'ì²˜ë¦¬ ì¤‘...';
                spinner.classList.remove('hidden');
                errorDisplay.classList.add('hidden');

                await handleAIAssistGeneralCommand(task.id, command);

                btn.disabled = false;
                loadingText.textContent = 'AIì—ê²Œ ëª…ë ¹';
                spinner.classList.add('hidden');
                commandInput.value = ''; // Clear input after sending command
            });


            // Move card buttons
            document.querySelectorAll('.move-card-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetColumnId = e.target.dataset.targetColumn;
                    moveCard(task.id, targetColumnId);
                    closeDetailModal();
                });
            });

            // Delete Task button
            document.getElementById('delete-task-button').addEventListener('click', () => {
                showConfirmModal(task.id);
            });
        }

        /**
         * Renders the settings modal.
         */
        function renderSettingsModal() {
            // ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ê²°ì •
            const isUserLoggedIn = currentUserId !== null;
            const userEmail = window.auth.currentUser ? window.auth.currentUser.email : '';

            settingsModalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-3xl font-bold text-blue-800">ì„¤ì •</h2>
                    <button id="settings-modal-close-button" class="text-gray-500 hover:text-gray-700 text-4xl leading-none font-light">
                        &times;
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- ê³„ì • ì •ë³´ ë° ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-user-circle mr-2"></i> ê³„ì •</h3>
                        <p class="text-md text-gray-800 mb-3">
                            ${isUserLoggedIn ? `ë¡œê·¸ì¸ë¨: <span class="font-bold">${escapeHtml(userEmail || 'ì•Œ ìˆ˜ ì—†ìŒ')}</span>` : 'ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ'}
                        </p>
                        <div class="flex flex-wrap gap-3">
                            <button id="google-signin-button-modal" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center ${isUserLoggedIn ? 'hidden' : ''}">
                                <i class="fab fa-google mr-2"></i> Google ë¡œê·¸ì¸
                            </button>
                            <button id="google-signout-button-modal" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center ${isUserLoggedIn ? '' : 'hidden'}">
                                <i class="fas fa-sign-out-alt mr-2"></i> ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>
                    </div>

                    <!-- Gemini API Key ì„¤ì • -->
                    <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h3 class="text-xl font-semibold text-yellow-700 mb-3 flex items-center"><i class="fas fa-key mr-2"></i> Gemini API í‚¤ ì„¤ì •</h3>
                        <p class="text-sm text-gray-700 mb-2">ë¡œì»¬ì—ì„œ AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a>ì—ì„œ Gemini API í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.</p>
                        <input type="text" id="gemini-api-key" value="${escapeHtml(currentSettings.gemini_api_key)}" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <!-- ì‚¬ìš©ì ì •ë³´ ì„¤ì • -->
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-xl font-semibold text-blue-700 mb-3">ì‚¬ìš©ì ì •ë³´</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="user-info-name" class="block text-gray-700 text-sm font-bold mb-1">ì´ë¦„:</label>
                                <input type="text" id="user-info-name" value="${escapeHtml(currentSettings.user_info.name)}" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                            <div>
                                <label for="user-info-role" class="block text-gray-700 text-sm font-bold mb-1">ì—­í• :</label>
                                <input type="text" id="user-info-role" value="${escapeHtml(currentSettings.user_info.role)}" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                            <div class="md:col-span-2">
                                <label for="user-info-goals" class="block text-gray-700 text-sm font-bold mb-1">ì£¼ìš” ëª©í‘œ:</label>
                                <textarea id="user-info-goals" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y">${escapeHtml(currentSettings.user_info.goals)}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- AI ìš”êµ¬ì‚¬í•­ ì„¤ì • -->
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                        <h3 class="text-xl font-semibold text-green-700 mb-3">AIì— ëŒ€í•œ ì „ì—­ ìš”êµ¬ì‚¬í•­ (ë¹„ì„œ ê¸°ëŠ¥ ê°•í™”)</h3>
                        <textarea id="global-ai-requirements" rows="5" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y" placeholder="AIê°€ ëª¨ë“  í”„ë¡œì íŠ¸ì— ëŒ€í•´ ê³ ë ¤í•´ì•¼ í•  íŠ¹ë³„ ì§€ì¹¨ì´ë‚˜ ì›ì¹™ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: 'í•­ìƒ íš¨ìœ¨ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ê³ , ì¸ì§€ ê³¼ë¶€í•˜ë¥¼ ì¤„ì´ëŠ” ë°©í–¥ìœ¼ë¡œ ì¡°ì–¸í•´ì¤˜.'">${escapeHtml(currentSettings.global_ai_requirements)}</textarea>
                    </div>

                    <!-- AI í”„ë¡¬í”„íŠ¸ ì„¤ì • -->
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <h3 class="text-xl font-semibold text-purple-700 mb-3">AI í”„ë¡¬í”„íŠ¸ ì„¤ì • (ê³ ê¸‰)</h3>
                        <p class="text-sm text-gray-600 mb-4">í”„ë¡¬í”„íŠ¸ëŠ” JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ë„ë¡ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. '{taskTitle}', '{taskDetails}', '{historyDetails}', '{userInfo}', '{globalAIRequirements}', '{allTasksDetails}', '{userCommand}' ë“±ì˜ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="ai-checklist-prompt" class="block text-gray-700 text-sm font-bold mb-1">ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± í”„ë¡¬í”„íŠ¸:</label>
                                <textarea id="ai-checklist-prompt" rows="5" class="w-full p-2 border border-gray-300 rounded-lg font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y">${escapeHtml(currentSettings.ai_checklist_prompt)}</textarea>
                            </div>
                            <div>
                                <label for="ai-advice-prompt" class="block text-gray-700 text-sm font-bold mb-1">ì¡°ì–¸/ì•Œë¦¼ ìƒì„± í”„ë¡¬í”„íŠ¸:</label>
                                <textarea id="ai-advice-prompt" rows="5" class="w-full p-2 border border-gray-300 rounded-lg font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y">${escapeHtml(currentSettings.ai_advice_prompt)}</textarea>
                            </div>
                            <div>
                                <label for="ai-overall-report-prompt" class="block text-gray-700 text-sm font-bold mb-1">ì „ì²´ í”„ë¡œì íŠ¸ ë³´ê³ ì„œ í”„ë¡¬í”„íŠ¸:</label>
                                <textarea id="ai-overall-report-prompt" rows="5" class="w-full p-2 border border-gray-300 rounded-lg font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y">${escapeHtml(currentSettings.ai_overall_report_prompt)}</textarea>
                            </div>
                            <div>
                                <label for="ai-general-assistant-prompt" class="block text-gray-700 text-sm font-bold mb-1">ì¼ë°˜ AI ë¹„ì„œ í”„ë¡¬í”„íŠ¸:</label>
                                <textarea id="ai-general-assistant-prompt" rows="5" class="w-full p-2 border border-gray-300 rounded-lg font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y">${escapeHtml(currentSettings.ai_general_assistant_prompt)}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end">
                    <button id="save-settings-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                        ì„¤ì • ì €ì¥
                    </button>
                </div>
            `;

            // Attach event listeners for settings modal elements
            document.getElementById('settings-modal-close-button').addEventListener('click', closeSettingsModal);

            const saveSettingsButton = document.getElementById('save-settings-button');
            saveSettingsButton.addEventListener('click', saveSettings);

            // Google ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            const googleSigninButtonModal = document.getElementById('google-signin-button-modal');
            const googleSignoutButtonModal = document.getElementById('google-signout-button-modal');
            if (googleSigninButtonModal) googleSigninButtonModal.addEventListener('click', handleGoogleSignIn);
            if (googleSignoutButtonModal) googleSignoutButtonModal.addEventListener('click', handleSignOut);

            // Debounced updates for settings inputs
            document.getElementById('gemini-api-key').addEventListener('input', debounce((e) => currentSettings.gemini_api_key = e.target.value, 300));
            document.getElementById('user-info-name').addEventListener('input', debounce((e) => currentSettings.user_info.name = e.target.value, 300));
            document.getElementById('user-info-role').addEventListener('input', debounce((e) => currentSettings.user_info.role = e.target.value, 300));
            document.getElementById('user-info-goals').addEventListener('input', debounce((e) => currentSettings.user_info.goals = e.target.value, 300));
            document.getElementById('global-ai-requirements').addEventListener('input', debounce((e) => currentSettings.global_ai_requirements = e.target.value, 300));
            document.getElementById('ai-checklist-prompt').addEventListener('input', debounce((e) => currentSettings.ai_checklist_prompt = e.target.value, 300));
            document.getElementById('ai-advice-prompt').addEventListener('input', debounce((e) => currentSettings.ai_advice_prompt = e.target.value, 300));
            document.getElementById('ai-overall-report-prompt').addEventListener('input', debounce((e) => currentSettings.ai_overall_report_prompt = e.target.value, 300));
            document.getElementById('ai-general-assistant-prompt').addEventListener('input', debounce((e) => currentSettings.ai_general_assistant_prompt = e.target.value, 300));
        }

        // --- Modal Control Functions ---

        function openDetailModal(task, columnId) {
            renderTaskDetailModal(task, columnId);
            taskDetailModal.classList.remove('hidden');
            taskDetailModalContent.dataset.taskId = task.id; // í˜„ì¬ ì—´ë¦° ì‘ì—…ì˜ IDë¥¼ ëª¨ë‹¬ ì½˜í…ì¸ ì— ì €ì¥
        }

        function closeDetailModal() {
            taskDetailModal.classList.add('hidden');
            taskDetailModalContent.removeAttribute('dataset.taskId'); // ëª¨ë‹¬ ë‹«ì„ ë•Œ ID ì œê±°
        }

        function openSettingsModal() {
            renderSettingsModal(); // ëª¨ë‹¬ì„ ì—´ ë•Œë§ˆë‹¤ ë‚´ìš©ì„ ìƒˆë¡œ ë Œë”ë§í•˜ì—¬ ë¡œê·¸ì¸ ìƒíƒœ ë°˜ì˜
            settingsModal.classList.remove('hidden');
        }

        function closeSettingsModal() {
            settingsModal.classList.add('hidden');
        }

        /**
         * Shows a confirmation modal.
         * @param {string} taskIdToDelete - The ID of the task to delete.
         */
        let currentTaskIdToDelete = null; // ì‚­ì œí•  ì„ë¬´ì˜ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜
        function showConfirmModal(taskId) {
            currentTaskIdToDelete = taskId;
            confirmModal.classList.remove('hidden');
            confirmCancelButton.addEventListener('click', closeConfirmModal, { once: true }); // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡
            confirmDeleteButton.addEventListener('click', handleDeleteConfirmed, { once: true }); // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡
        }

        function closeConfirmModal() {
            confirmModal.classList.add('hidden');
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì´ë¯¸ {once: true}ë¡œ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ ì•ˆì „ì„ ìœ„í•´)
            confirmCancelButton.removeEventListener('click', closeConfirmModal);
            confirmDeleteButton.removeEventListener('click', handleDeleteConfirmed);
            currentTaskIdToDelete = null;
        }

        async function handleDeleteConfirmed() {
            if (currentTaskIdToDelete) {
                await deleteTask(currentTaskIdToDelete);
                closeConfirmModal();
                closeDetailModal(); // ì„ë¬´ ì‚­ì œ í›„ ìƒì„¸ ëª¨ë‹¬ë„ ë‹«ê¸°
            }
        }


        // --- Firebase Authentication & Firestore Interactions ---

        /**
         * Handles Google Sign-In.
         */
        async function handleGoogleSignIn() {
            try {
                const provider = new window.GoogleAuthProvider();
                await window.signInWithPopup(window.auth, provider);
                showToast("Google ë¡œê·¸ì¸ ì„±ê³µ!", "success");
                // onAuthStateChanged ë¦¬ìŠ¤ë„ˆê°€ ì‚¬ìš©ì ìƒíƒœë¥¼ ì²˜ë¦¬í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•  ê²ƒì…ë‹ˆë‹¤.
                closeSettingsModal(); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
            } catch (error) {
                console.error("Google ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                let errorMessage = `Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`;
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "ë¡œê·¸ì¸ íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.";
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = "Firebase ì½˜ì†”ì—ì„œ 'Authorized domains'ì— í˜„ì¬ ë„ë©”ì¸(localhost)ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.";
                }
                showToast(errorMessage, "error");
            }
        }

        /**
         * Handles user sign-out.
         */
        async function handleSignOut() {
            try {
                await window.signOut(window.auth);
                showToast("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
                // onAuthStateChanged ë¦¬ìŠ¤ë„ˆê°€ ì‚¬ìš©ì ìƒíƒœë¥¼ ì²˜ë¦¬í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•  ê²ƒì…ë‹ˆë‹¤.
                closeSettingsModal(); // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ì‹œ ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
            } catch (error) {
                console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
                showToast(`ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`, "error");
            }
        }

        /**
         * Initializes Firebase and sets up authentication listener and data snapshot listener.
         */
        async function initializeAppAndFirestore() {
            try {
                if (!window.auth || !window.db) {
                    return; // Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ëŠ” ì´ë¯¸ ì²˜ë¦¬ë¨
                }

                // onAuthStateChanged ë¦¬ìŠ¤ë„ˆëŠ” Firebase ì¸ì¦ ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
                // Google ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ, í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì„¸ì…˜ ë³µì› ë“± ëª¨ë“  ê²½ìš°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                window.onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `í˜„ì¬ ì‚¬ìš©ì ID: ${currentUserId}`;
                        console.log("Authenticated with user ID:", currentUserId);

                        tasksCollectionRef = window.collection(window.db, `artifacts/${window.appId}/users/${currentUserId}/tasks`);
                        settingsDocRef = window.doc(window.db, `artifacts/${window.appId}/users/${currentUserId}/settings`, 'user_settings');

                        // Set up real-time listener for tasks
                        window.onSnapshot(window.query(tasksCollectionRef), (snapshot) => {
                            tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderKanbanBoard(); // Re-render board on data change

                            // ë§Œì•½ ëª¨ë‹¬ì´ ì—´ë ¤ ìˆê³ , í˜„ì¬ ëª¨ë‹¬ì— í‘œì‹œëœ ì‘ì—…ì´ ì—…ë°ì´íŠ¸ëœ ì‘ì—…ì´ë¼ë©´ ëª¨ë‹¬ë„ ìƒˆë¡œê³ ì¹¨
                            if (!taskDetailModal.classList.contains('hidden')) {
                                const currentModalTaskId = taskDetailModalContent.dataset.taskId; // datasetì—ì„œ ID ê°€ì ¸ì˜¤ê¸°
                                const updatedTaskInList = tasks.find(t => t.id === currentModalTaskId);
                                if (updatedTaskInList) {
                                    const currentModalColumnId = updatedTaskInList.columnId; // ì—…ë°ì´íŠ¸ëœ ì»¬ëŸ¼ ID
                                    renderTaskDetailModal(updatedTaskInList, currentModalColumnId);
                                } else {
                                    // í˜„ì¬ ëª¨ë‹¬ì˜ ì„ë¬´ê°€ ì‚­ì œëœ ê²½ìš°
                                    closeDetailModal();
                                }
                            }
                        }, (error) => {
                            console.error("Error fetching tasks from Firestore:", error);
                            showToast("ì„ë¬´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                        });

                        // Load settings (ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ìë³„ ì„¤ì • ë¡œë“œ)
                        await loadSettings();
                        // Google ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ì ì´ë¦„ì„ user_info.nameì— ìë™ìœ¼ë¡œ ì±„ì›Œë„£ê¸°
                        if (user.displayName && !currentSettings.user_info.name) {
                            currentSettings.user_info.name = user.displayName;
                            await saveSettings(); // ì„¤ì • ì €ì¥
                        }


                    } else {
                        console.log("No user is signed in.");
                        currentUserId = null;
                        userIdDisplay.textContent = 'ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ';

                        // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ë°ì´í„° ë° ì„¤ì • ì´ˆê¸°í™”
                        tasks = []; // ë°ì´í„° ì§€ìš°ê¸°
                        currentSettings.user_info = { name: '', role: '', goals: '' }; // ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”
                        currentSettings.global_ai_requirements = "Think slowly and meticulously, review the question content tens of thousands of times, and generate answers to the question diligently without laziness."; // ì „ì—­ AI ìš”êµ¬ì‚¬í•­ ì´ˆê¸°ê°’ìœ¼ë¡œ ì¬ì„¤ì •
                        // AI KeyëŠ” ìœ ì§€ (ì‚¬ìš©ìê°€ ì§ì ‘ ì„¤ì •í•œ ê°’)
                        renderKanbanBoard(); // ë³´ë“œ ë¹„ìš°ê¸°
                    }
                    isAuthReady = true;
                    loadingOverlay.classList.add('hidden'); // Hide loading overlay once auth is ready
                    addCardButton.disabled = !currentUserId; // Enable/disable add card button based on auth
                    overallAIReportButton.disabled = !currentUserId; // Enable/disable AI report button

                    // ëª¨ë‹¬ì´ ì—´ë ¤ ìˆë‹¤ë©´, ë¡œê·¸ì¸ ìƒíƒœ ë³€í™”ë¥¼ ë°˜ì˜í•˜ì—¬ ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ë³€ê²½ ë“±)
                    if (!settingsModal.classList.contains('hidden')) {
                         renderSettingsModal();
                    }
                });

            }
            catch (error) {
                console.error("Firebase ì¸ì¦ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", error);
                showToast(`ì¸ì¦ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, "error");
                isAuthReady = true;
                loadingOverlay.classList.add('hidden');
            }
        }

        /**
         * Adds a new card to Firestore.
         */
        async function handleAddCard() {
            if (!currentUserId || newCardTitleInput.value.trim() === '') {
                showToast("ì„ë¬´ ì œëª©ì„ ì…ë ¥í•˜ê³  ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.", "error");
                return;
            }

            const newTask = {
                title: newCardTitleInput.value.trim(),
                description: newCardDescriptionInput.value.trim().substring(0, 1000), // 1000ì ì œí•œ
                columnId: 'todo',
                checklist: [],
                memo: '',
                history: [{ timestamp: Date.now(), event: 'ì¹´ë“œ ìƒì„±ë¨' }],
                createdAt: Date.now() // For sorting
            };

            try {
                await window.addDoc(tasksCollectionRef, newTask);
                showToast("ìƒˆ ì„ë¬´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                newCardTitleInput.value = '';
                newCardDescriptionInput.value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                showToast("ì„ë¬´ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.", "error");
            }
        }

        /**
         * Updates a field of a task in Firestore.
         * @param {string} taskId - The ID of the task.
         * @param {string} field - The field name (e.g., 'title', 'description', 'memo').
         * @param {any} value - The new value for the field.
         */
        async function updateTaskField(taskId, field, value) {
            if (!currentUserId) return;
            const taskToUpdate = tasks.find(t => t.id === taskId);
            if (!taskToUpdate) return;

            const updatedTaskWithHistory = addHistoryEntry(taskToUpdate, `${field} ì—…ë°ì´íŠ¸`);
            // Apply 1000 char limit to description and memo
            if (field === 'description' || field === 'memo') {
                value = value.substring(0, 1000);
            }

            try {
                await window.updateDoc(window.doc(tasksCollectionRef, taskId), {
                    [field]: value,
                    history: updatedTaskWithHistory.history
                });
                // showToast("`${taskToUpdate.title} ì„ë¬´ ${field} ì—…ë°ì´íŠ¸ë¨`", "success"); // Too many toasts for debounced updates
            } catch (e) {
                console.error(`Error updating task ${field}: `, e);
                showToast(`${taskToUpdate.title} ì„ë¬´ ${field} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨.`, "error");
            }
        }

        /**
         * Moves a card to a different column in Firestore.
         * @param {string} taskId - The ID of the task to move.
         * @param {string} targetColumnId - The ID of the target column.
         */
        async function moveCard(taskId, targetColumnId) {
            if (!currentUserId) return;
            const taskToMove = tasks.find(t => t.id === taskId);
            if (!taskToMove) return;

            const updatedTaskWithHistory = addHistoryEntry(taskToMove, `${taskToMove.columnId}ì—ì„œ ${targetColumnId}ë¡œ ì´ë™`);

            try {
                await window.updateDoc(window.doc(tasksCollectionRef, taskId), {
                    columnId: targetColumnId,
                    history: updatedTaskWithHistory.history
                });
                showToast(`${taskToMove.title}ì´(ê°€) ${targetColumnId}ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
            } catch (e) {
                console.error("Error moving card: ", e);
                showToast("ì¹´ë“œ ì´ë™ ì‹¤íŒ¨.", "error");
            }
        }

        /**
         * Toggles the completion status of a checklist item in Firestore.
         * @param {string} taskId - The ID of the task.
         * @param {number} itemIndex - The index of the checklist item.
         */
        async function toggleChecklistItem(taskId, itemIndex) {
            if (!currentUserId) return;
            const taskToUpdate = tasks.find(t => t.id === taskId);
            if (!taskToUpdate || !taskToUpdate.checklist) return;

            const updatedChecklist = [...taskToUpdate.checklist];
            updatedChecklist[itemIndex] = {
                ...updatedChecklist[itemIndex],
                completed: !updatedChecklist[itemIndex].completed
            };

            const event = `ì²´í¬ë¦¬ìŠ¤íŠ¸ '${updatedChecklist[itemIndex].text}' ${updatedChecklist[itemIndex].completed ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'} ë³€ê²½`;
            const updatedTaskWithHistory = addHistoryEntry(taskToUpdate, event);

            try {
                await window.updateDoc(window.doc(tasksCollectionRef, taskId), {
                    checklist: updatedChecklist,
                    history: updatedTaskWithHistory.history
                });
                showToast("ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë³€ê²½ë¨", "success");
            } catch (e) {
                console.error("Error toggling checklist item: ", e);
                showToast("ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨.", "error");
            }
        }

        /**
         * Adds a new checklist item to a task in Firestore.
         * @param {string} taskId - The ID of the task.
         * @param {string} itemText - The text of the new checklist item.
         */
        async function addChecklistItem(taskId, itemText) {
            if (!currentUserId || !itemText.trim()) return;
            const taskToUpdate = tasks.find(t => t.id === taskId);
            if (!taskToUpdate) return;

            const newChecklist = [...taskToUpdate.checklist || [], { text: itemText.trim(), completed: false }];
            const updatedTaskWithHistory = addHistoryEntry(taskToUpdate, `ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€: '${itemText}'`);

            try {
                await window.updateDoc(window.doc(tasksCollectionRef, taskId), {
                    checklist: newChecklist,
                    history: updatedTaskWithHistory.history
                });
                showToast("ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€ë¨", "success");
            } catch (e) {
                console.error("Error adding checklist item: ", e);
                showToast("ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€ ì‹¤íŒ¨.", "error");
            }
        }

        /**
         * Deletes a checklist item from a task in Firestore.
         * @param {string} taskId - The ID of the task.
         * @param {number} itemIndex - The index of the checklist item to delete.
         */
        async function deleteChecklistItem(taskId, itemIndex) {
            if (!currentUserId) return;
            const taskToUpdate = tasks.find(t => t.id === taskId);
            if (!taskToUpdate || !taskToUpdate.checklist) return;

            const deletedItemText = taskToUpdate.checklist[itemIndex].text;
            const newChecklist = taskToUpdate.checklist.filter((_, idx) => idx !== itemIndex);
            const updatedTaskWithHistory = addHistoryEntry(taskToUpdate, `ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚­ì œ: '${deletedItemText}'`);

            try {
                await window.updateDoc(window.doc(tasksCollectionRef, taskId), {
                    checklist: newChecklist,
                    history: updatedTaskWithHistory.history
                });
                showToast("ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚­ì œë¨", "success");
            } catch (e) {
                console.error("Error deleting checklist item: ", e);
                showToast("ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚­ì œ ì‹¤íŒ¨.", "error");
            }
        }

        /**
         * Edits the text of a checklist item in Firestore.
         * @param {string} taskId - The ID of the task.
         * @param {number} itemIndex - The index of the checklist item to edit.
         * @param {string} newText - The new text for the checklist item.
         */
        async function editChecklistItem(taskId, itemIndex, newText) {
            if (!currentUserId || !newText.trim()) return;
            const taskToUpdate = tasks.find(t => t.id === taskId);
            if (!taskToUpdate || !taskToUpdate.checklist) return;

            const originalText = taskToUpdate.checklist[itemIndex].text;
            const updatedChecklist = [...taskToUpdate.checklist];
            updatedChecklist[itemIndex] = {
                ...updatedChecklist[itemIndex],
                text: newText.trim()
            };
            const updatedTaskWithHistory = addHistoryEntry(taskToUpdate, `ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© '${originalText}'ë¥¼ '${newText}'ë¡œ ìˆ˜ì •`);

            try {
                await window.updateDoc(window.doc(tasksCollectionRef, taskId), {
                    checklist: updatedChecklist,
                    history: updatedTaskWithHistory.history
                });
                // showToast("ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ìˆ˜ì •ë¨", "success"); // Too many toasts for debounced updates
            } catch (e) {
                console.error("Error editing checklist item: ", e);
                showToast("ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ìˆ˜ì • ì‹¤íŒ¨.", "error");
            }
        }

        /**
         * Deletes a task from Firestore.
         * @param {string} taskId - The ID of the task to delete.
         */
        async function deleteTask(taskId) {
            if (!currentUserId) return;
            const taskToDelete = tasks.find(t => t.id === taskId);
            if (!taskToDelete) return;

            try {
                await window.deleteDoc(window.doc(tasksCollectionRef, taskId));
                showToast(`"${taskToDelete.title}" ì„ë¬´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, "success");
            } catch (e) {
                console.error("Error deleting task: ", e);
                showToast(`"${taskToDelete.title}" ì„ë¬´ ì‚­ì œ ì‹¤íŒ¨.`, "error");
            }
        }

        /**
         * Loads user settings from Firestore.
         */
        async function loadSettings() {
            if (!currentUserId) return;
            try {
                const docSnap = await window.getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    // ê¸°ì¡´ currentSettingsì— ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ ê¸°ë³¸ê°’ì€ ìœ ì§€í•˜ê³ , Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¨ ê°’ìœ¼ë¡œ ë®ì–´ì”Œì›€
                    currentSettings = {
                        ...currentSettings,
                        ...docSnap.data()
                    };
                    console.log("Settings loaded:", currentSettings);
                } else {
                    console.log("No settings document found, using default settings and saving them.");
                    // ìƒˆ ì‚¬ìš©ìì´ê±°ë‚˜ ì„¤ì • ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì„¤ì •ì„ ì €ì¥
                    await window.setDoc(settingsDocRef, currentSettings);
                }
            } catch (e) {
                console.error("Error loading settings: ", e);
                showToast("ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨.", "error");
            }
        }

        /**
         * Saves user settings to Firestore.
         */
        async function saveSettings() {
            if (!currentUserId) return;
            try {
                await window.setDoc(settingsDocRef, currentSettings);
                showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                closeSettingsModal();
            } catch (e) {
                console.error("Error saving settings: ", e);
                showToast("ì„¤ì • ì €ì¥ ì‹¤íŒ¨.", "error");
            }
        }

        // --- AI API Interactions ---

        /**
         * Generic function to call Gemini API.
         * @param {string} prompt - The text prompt for the AI.
         * @param {object} responseSchema - JSON schema for the expected response.
         * @returns {Promise<object>} - Parsed JSON response from AI.
         */
        async function callGeminiAPI(prompt, responseSchema) {
            const apiKey = currentSettings.gemini_api_key;
            if (!apiKey) {
                throw new Error("Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema,
                },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let errorData;
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { error: { message: `ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒíƒœ: ${response.status}` } };
                }
                const errorMessage = errorData.error ? errorData.error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                throw new Error(`API ì˜¤ë¥˜: ${response.status} ${response.statusText} - ${errorMessage}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const jsonString = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonString);
            } else {
                throw new Error("AI ì‘ë‹µì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }
        }

        /**
         * Calls AI to generate a checklist for a task.
         * @param {string} taskId - The ID of the task.
         * @param {string} taskTitle - The title of the task.
         */
        async function handleAIAssistChecklist(taskId, taskTitle) {
            if (!currentUserId) {
                showToast("ë¡œê·¸ì¸ í›„ AI ë³´ì¡° ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "error");
                return;
            }
            // AI ê¸°ëŠ¥ ì‚¬ìš© ì „ API í‚¤ í™•ì¸
            if (!currentSettings.gemini_api_key) {
                showToast("AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                openSettingsModal(); // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
                return;
            }

            try {
                // í”„ë¡¬í”„íŠ¸ì— 'interaction language : korean'ì´ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                const prompt = currentSettings.ai_checklist_prompt.replace('{taskTitle}', taskTitle);
                const responseSchema = {
                    type: "OBJECT",
                    properties: {
                        "checklist": { type: "ARRAY", items: { type: "STRING" } }
                    },
                    required: ["checklist"],
                };

                const parsedJson = await callGeminiAPI(prompt, responseSchema);

                if (parsedJson && parsedJson.checklist && Array.isArray(parsedJson.checklist)) {
                    const newChecklistItems = parsedJson.checklist.map(item => ({ text: item, completed: false }));

                    const taskRef = window.doc(tasksCollectionRef, taskId);
                    const currentTaskSnapshot = await window.getDoc(taskRef);
                    if (currentTaskSnapshot.exists()) {
                        const currentTaskData = currentTaskSnapshot.data();
                        const updatedChecklist = [...currentTaskData.checklist || [], ...newChecklistItems];
                        const updatedTaskWithHistory = addHistoryEntry(currentTaskData, 'AIê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€');
                        await window.updateDoc(taskRef, {
                            checklist: updatedChecklist,
                            history: updatedTaskWithHistory.history,
                        });
                        showToast("AI ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                    }
                } else {
                    showToast("AI ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì²´í¬ë¦¬ìŠ¤íŠ¸)", "error");
                }
            } catch (error) {
                console.error('AI Assist Checklist Error:', error);
                showToast(`AI ë³´ì¡° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, "error");
            }
        }

        /**
         * Calls AI for a general command/question on a specific task.
         * @param {string} taskId - The ID of the task.
         * @param {string} userCommand - The user's command/question to the AI.
         */
        async function handleAIAssistGeneralCommand(taskId, userCommand) {
            if (!currentUserId) {
                showToast("ë¡œê·¸ì¸ í›„ AI ë¹„ì„œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "error");
                return;
            }
            // AI ê¸°ëŠ¥ ì‚¬ìš© ì „ API í‚¤ í™•ì¸
            if (!currentSettings.gemini_api_key) {
                showToast("AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                openSettingsModal(); // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
                return;
            }

            const taskToInteract = tasks.find(t => t.id === taskId);
            if (!taskToInteract) return;

            const aiAssistantErrorDisplay = document.getElementById('ai-assistant-error');
            aiAssistantErrorDisplay.classList.add('hidden'); // Hide previous error

            try {
                const taskDetails = `Title: ${taskToInteract.title}\nDescription: ${taskToInteract.description || 'N/A'}\nMemo: ${taskToInteract.memo || 'N/A'}\nChecklist: ${taskToInteract.checklist.map(item => item.text).join(', ')}\nStatus: ${kanbanColumns.find(col => col.id === taskToInteract.columnId)?.title || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
                // ìµœê·¼ 10ê°œ ê¸°ë¡ë§Œ í¬í•¨
                const limitedHistory = taskToInteract.history
                    ? [...taskToInteract.history].sort((a, b) => b.timestamp - a.timestamp).slice(0, 10)
                    : [];
                const historyDetails = limitedHistory.map(entry => `${new Date(entry.timestamp).toLocaleString()}: ${entry.event}`).join('\n');
                
                const userInfoDetails = `Name: ${currentSettings.user_info.name}\nRole: ${currentSettings.user_info.role}\nGoals: ${currentSettings.user_info.goals}`;
                const globalAIRequirements = currentSettings.global_ai_requirements;

                // í”„ë¡¬í”„íŠ¸ì— 'interaction language : korean'ì´ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                const prompt = currentSettings.ai_general_assistant_prompt
                    .replace('{userInfo}', userInfoDetails)
                    .replace('{globalAIRequirements}', globalAIRequirements)
                    .replace('{taskDetails}', taskDetails)
                    .replace('{historyDetails}', historyDetails)
                    .replace('{userCommand}', userCommand);

                const responseSchema = {
                    type: "OBJECT",
                    properties: { "response": { type: "STRING" } },
                    required: ["response"],
                };

                const parsedJson = await callGeminiAPI(prompt, responseSchema);

                if (parsedJson && parsedJson.response) {
                    const aiResponseText = parsedJson.response;
                    const taskRef = window.doc(tasksCollectionRef, taskId);
                    const updatedTaskWithHistory = addHistoryEntry(taskToInteract, `ì‚¬ìš©ì: ${userCommand}\nAI ë¹„ì„œ: ${aiResponseText}`);
                    await window.updateDoc(taskRef, {
                        history: updatedTaskWithHistory.history,
                    });
                    showToast("AI ë¹„ì„œ ì‘ë‹µì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                    // ëª¨ë‹¬ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ìµœì‹  ê¸°ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                    openDetailModal(updatedTaskWithHistory, taskToInteract.columnId);
                } else {
                    showToast("AI ë¹„ì„œ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", "error");
                    aiAssistantErrorDisplay.textContent = "AI ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    aiAssistantErrorDisplay.classList.remove('hidden');
                }
            } catch (error) {
                console.error('AI Assistant Command Error:', error);
                aiAssistantErrorDisplay.textContent = `AI ë¹„ì„œ ì˜¤ë¥˜: ${error.message}`;
                aiAssistantErrorDisplay.classList.remove('hidden');
                showToast(`AI ë¹„ì„œ ì˜¤ë¥˜: ${error.message}`, "error");
            }
        }


        /**
         * Calls AI to generate an overall project report.
         * @param {string} userId - The ID of the current user.
         */
        async function handleOverallAIReport() {
            if (!currentUserId) {
                showToast("ë¡œê·¸ì¸ í›„ ì „ì²´ í”„ë¡œì íŠ¸ ë³´ê³ ì„œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "error");
                return;
            }
            // AI ê¸°ëŠ¥ ì‚¬ìš© ì „ API í‚¤ í™•ì¸
            if (!currentSettings.gemini_api_key) {
                showToast("AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
                openSettingsModal(); // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
                return;
            }

            const btn = overallAIReportButton;
            const loadingText = overallAIReportLoadingText;
            const spinner = overallAIReportLoadingSpinner;
            const contentDiv = overallAIReportContent;
            const errorDisplay = overallAIReportError;

            btn.disabled = true;
            loadingText.textContent = 'ë³´ê³ ì„œ ìƒì„± ì¤‘...';
            spinner.classList.remove('hidden');
            contentDiv.classList.add('hidden');
            errorDisplay.classList.add('hidden');

            try {
                const userInfoDetails = `Name: ${currentSettings.user_info.name}\nRole: ${currentSettings.user_info.role}\nGoals: ${currentSettings.user_info.goals}`;
                const globalAIRequirements = currentSettings.global_ai_requirements;
                const allTasksDetails = tasks.map(task => {
                    const checklistInfo = task.checklist && task.checklist.length > 0
                        ? `Checklist: ${task.checklist.map(item => `${item.text} (${item.completed ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'})`).join(', ')}`
                        : 'No checklist.';
                    // ê° ì„ë¬´ì— ëŒ€í•´ì„œë„ ìµœê·¼ 10ê°œ ê¸°ë¡ë§Œ í¬í•¨
                    const limitedTaskHistory = task.history
                        ? [...task.history].sort((a, b) => b.timestamp - a.timestamp).slice(0, 10)
                        : [];
                    const historyInfo = limitedTaskHistory.length > 0
                        ? `History: ${limitedTaskHistory.map(entry => `${new Date(entry.timestamp).toLocaleDateString()}: ${entry.event}`).join('; ')}`
                        : 'No history.';
                    return `Task Title: ${task.title}\nDescription: ${task.description}\nStatus: ${kanbanColumns.find(col => col.id === task.columnId)?.title || task.columnId}\n${checklistInfo}\n${historyInfo}\n---`;
                }).join('\n');

                // í”„ë¡¬í”„íŠ¸ì— 'interaction language : korean'ì´ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                const prompt = currentSettings.ai_overall_report_prompt
                    .replace('{userInfo}', userInfoDetails)
                    .replace('{globalAIRequirements}', globalAIRequirements)
                    .replace('{allTasksDetails}', allTasksDetails);

                const responseSchema = {
                    type: "OBJECT",
                    properties: {
                        "summary": { type: "STRING" },
                        "recommendedActions": { type: "ARRAY", items: { type: "STRING" } },
                        "strategicAdvice": { type: "STRING" }
                    },
                    required: ["summary", "recommendedActions", "strategicAdvice"],
                };

                const parsedJson = await callGeminiAPI(prompt, responseSchema);

                if (parsedJson && parsedJson.summary && parsedJson.recommendedActions && parsedJson.strategicAdvice) {
                    let reportContent = `ìš”ì•½:\n${parsedJson.summary}\n\nì¶”ì²œ í™œë™:\n`;
                    parsedJson.recommendedActions.forEach((action, index) => {
                        reportContent += `${index + 1}. ${action}\n`;
                    });
                    reportContent += `\nì „ëµì  ì¡°ì–¸:\n${parsedJson.strategicAdvice}`;
                    contentDiv.querySelector('pre').textContent = reportContent;
                    contentDiv.classList.remove('hidden');
                    showToast("AI ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                } else {
                    errorDisplay.textContent = "AI ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë³´ê³ ì„œ)";
                    errorDisplay.classList.remove('hidden');
                    showToast("AI ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨ (í˜•ì‹ ì˜¤ë¥˜).", "error");
                }
            } catch (error) {
                console.error('Overall AI Report Error:', error);
                errorDisplay.textContent = `AI ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                errorDisplay.classList.remove('hidden');
                showToast(`AI ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, "error");
            } finally {
                btn.disabled = false;
                loadingText.textContent = 'AI ë³´ê³ ì„œ ìƒì„±';
                spinner.classList.add('hidden');
            }
        }


        // --- Event Listeners Initialization ---

        window.onload = async () => {
            // Firebase ì´ˆê¸°í™” ì „ì— authì™€ db ê°ì²´ê°€ ìœ íš¨í•œì§€ í™•ì¸í•©ë‹ˆë‹¤.
            // ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ëŠ” initializeAppAndFirestore í˜¸ì¶œì„ ê±´ë„ˆë›°ë„ë¡ í•©ë‹ˆë‹¤.
            if (window.firebaseApp && window.db && window.auth) {
                await initializeAppAndFirestore();
            } else {
                console.error("Firebase is not properly initialized. Cannot proceed with app functions.");
                // ë¡œë”© ì˜¤ë²„ë ˆì´ëŠ” Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ìˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€
                return; // Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ë‚˜ë¨¸ì§€ ë¡œì§ ì‹¤í–‰ ì¤‘ë‹¨
            }

            // settingsButtonì€ í•­ìƒ ì¡´ì¬í•˜ë©° í´ë¦­ ì‹œ ëª¨ë‹¬ì„ ë Œë”ë§í•˜ê³  ì—´ë„ë¡ í•©ë‹ˆë‹¤.
            settingsButton.addEventListener('click', openSettingsModal);

            // ë‚˜ë¨¸ì§€ í•µì‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            addCardButton.addEventListener('click', handleAddCard);
            overallAIReportButton.addEventListener('click', handleOverallAIReport);

            // Close modal on backdrop click
            taskDetailModal.addEventListener('click', (e) => {
                if (e.target === taskDetailModal) closeDetailModal();
            });
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeSettingsModal();
            });
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) closeConfirmModal();
            });
        };
    </script>
</body>
</html>
