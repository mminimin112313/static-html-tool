<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project P.R.I.M.E.</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .line-clamp-1 {
                display: -webkit-box;
                -webkit-line-clamp: 1;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .line-clamp-3 {
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .diff-added {
                background-color: #d4edda; /* Light green */
                color: #155724; /* Dark green */
            }
            .diff-removed {
                background-color: #f8d7da; /* Light red */
                color: #721c24; /* Dark red */
                text-decoration: line-through;
            }
            .dark .diff-added {
                background-color: #1e3d2a;
                color: #5cb85c;
            }
            .dark .diff-removed {
                background-color: #4f2f32;
                color: #dc3545;
            }
            /* Custom Scrollbar for better UX */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            .dark::-webkit-scrollbar-track {
                background: #2d2d2d;
            }
            ::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 10px;
            }
            .dark::-webkit-scrollbar-thumb {
                background: #555;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            .dark::-webkit-scrollbar-thumb:hover {
                background: #777;
            }
            /* Style for multi-select dropdown */
            .multi-select-dropdown {
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid #e2e8f0; /* gray-300 */
                border-radius: 0.75rem; /* rounded-xl */
                background-color: #fff; /* bg-white */
            }
            .dark .multi-select-dropdown {
                border-color: #4a5568; /* gray-700 */
                background-color: #1e1e1e; /* dark-card */
            }
            .multi-select-item {
                padding: 0.75rem; /* p-3 */
                cursor: pointer;
            }
            .multi-select-item:hover {
                background-color: #f0f4f8; /* gray-100 */
            }
            .dark .multi-select-item:hover {
                background-color: #2d3748; /* gray-700 */
            }
            .multi-select-item.selected {
                background-color: #e0f2fe; /* blue-100 */
                color: #1a73e8; /* prime-blue */
                font-weight: 600;
            }
            .dark .multi-select-item.selected {
                background-color: #1a202c; /* dark-bg */
                color: #63b3ed; /* prime-blue equivalent for dark */
            }
        }
    </style>

    <!-- Feather Icons CDN -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- React and ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!--
        Tailwind CSS Configuration for custom colors and dark mode.
        Based on the design system principles.
    -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans KR', 'sans-serif'],
                    },
                    colors: {
                        'prime-blue': '#1a73e8',
                        'prime-gray': '#f5f5f5',
                        'dark-bg': '#121212',
                        'dark-card': '#1e1e1e',
                        'dark-text': '#e0e0e0',
                        'accent-orange': '#ff9800',
                        'accent-purple': '#9c27b0',
                        'accent-yellow': '#ffeb3b',
                    },
                }
            }
        }
    </script>
</head>

<body class="bg-gray-100 dark:bg-dark-bg text-gray-900 dark:text-dark-text font-sans transition-colors duration-300">

    <!-- Main Application Container -->
    <div id="app" class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white dark:bg-dark-card p-6 flex flex-col shadow-lg transition-all duration-300 transform -translate-x-full md:translate-x-0 fixed md:relative z-50">
            <div class="flex items-center space-x-3 mb-8">
                <i data-feather="grid" class="h-8 w-8 text-prime-blue"></i>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-dark-text">P.R.I.M.E.</h1>
            </div>
            <!-- User Profile Section -->
            <div id="user-profile" class="flex items-center space-x-3 mb-8">
                <img src="https://via.placeholder.com/40" alt="User Profile" class="w-10 h-10 rounded-full border-2 border-prime-blue">
                <div class="flex-1">
                    <div id="user-display-name" class="font-semibold truncate">Guest</div>
                    <div id="user-id-display" class="text-xs text-gray-500 dark:text-gray-400 truncate"></div>
                </div>
            </div>
            <!-- Navigation -->
            <nav class="flex-1 space-y-2">
                <a href="#" id="nav-my-templates" class="flex items-center space-x-3 p-3 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors cursor-pointer" data-view="my-templates">
                    <i data-feather="file-text"></i>
                    <span>나의 템플릿</span>
                </a>
                <a href="#" id="nav-shared-templates" class="flex items-center space-x-3 p-3 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors cursor-pointer" data-view="shared-templates">
                    <i data-feather="share-2"></i>
                    <span>공유된 템플릿</span>
                </a>
                <a href="#" id="nav-snippets" class="flex items-center space-x-3 p-3 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors cursor-pointer" data-view="snippets">
                    <i data-feather="code"></i>
                    <span>상용구</span>
                </a>
                <!-- New: Groups Navigation -->
                <a href="#" id="nav-groups" class="flex items-center space-x-3 p-3 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors cursor-pointer" data-view="groups">
                    <i data-feather="folder"></i>
                    <span>그룹</span>
                </a>
                <a href="#" id="nav-export-data" class="flex items-center space-x-3 p-3 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors cursor-pointer">
                    <i data-feather="download"></i>
                    <span>데이터 내보내기</span>
                </a>
            </nav>
            <!-- Settings and Dark Mode Toggle -->
            <div class="mt-auto space-y-4">
                <div id="nav-settings" class="flex items-center space-x-3 p-3 rounded-xl cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors">
                    <i data-feather="settings"></i>
                    <span>설정</span>
                </div>
                <div class="flex items-center space-x-3 p-3 rounded-xl cursor-pointer" id="dark-mode-toggle">
                    <i data-feather="moon"></i>
                    <span>Dark Mode</span>
                </div>
                <a href="#" id="logout-button" class="flex items-center space-x-3 p-3 rounded-xl font-medium hover:bg-red-200 dark:hover:bg-red-900 transition-colors cursor-pointer text-red-600 dark:text-red-400">
                    <i data-feather="log-out"></i>
                    <span>로그아웃</span>
                </a>
            </div>
        </aside>

        <!-- Sidebar Overlay for mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden hidden"></div>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col p-6 overflow-y-auto">

            <!-- Header -->
            <header class="flex items-center justify-between mb-8">
                <div class="flex items-center space-x-4">
                    <button id="sidebar-toggle-button" class="md:hidden p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors">
                        <i data-feather="menu"></i>
                    </button>
                    <h2 id="current-view-title" class="text-3xl font-bold flex items-center space-x-2">
                        <i id="current-view-icon" data-feather="file-text" class="h-8 w-8 text-prime-blue"></i>
                        <span>나의 템플릿</span>
                    </h2>
                    <div id="view-options" class="flex items-center space-x-2 ml-4">
                        <button id="view-gallery" class="p-2 rounded-xl text-prime-blue bg-prime-blue/10 hover:bg-prime-blue/20 transition-colors">
                            <i data-feather="grid"></i>
                        </button>
                        <button id="view-list" class="p-2 rounded-xl text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors">
                            <i data-feather="list"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- New: Group Filter Dropdown -->
                    <div id="group-filter-container" class="relative hidden">
                        <button id="group-filter-button" class="flex items-center space-x-2 px-4 py-2 rounded-xl bg-white dark:bg-dark-card border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <i data-feather="tag" class="h-5 w-5 text-gray-500"></i>
                            <span id="selected-group-name">그룹 필터</span>
                            <i data-feather="chevron-down" class="h-4 w-4 text-gray-500"></i>
                        </button>
                        <div id="group-filter-dropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-dark-card rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 z-10 hidden">
                            <div class="p-2">
                                <button class="block w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-group-id="all">모든 그룹</button>
                                <div id="group-filter-list">
                                    <!-- Groups will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="text" id="global-search" placeholder="검색 (제목, 내용, 태그)" class="pl-10 pr-4 py-2 rounded-xl bg-white dark:bg-dark-card border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue w-64 transition-all duration-200">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-feather="search" class="h-5 w-5 text-gray-400"></i>
                        </div>
                    </div>
                    <button id="add-new-button" class="bg-prime-blue text-white px-4 py-2 rounded-xl font-semibold shadow-md hover:bg-blue-600 transition-colors flex items-center space-x-2">
                        <i data-feather="plus"></i>
                        <span>새 항목</span>
                    </button>
                </div>
            </header>

            <!-- Main Content Area: Templates / Snippets / Groups List -->
            <div id="content-container" class="flex-1 overflow-y-auto pr-2">
                <!-- Template/Snippet Cards or Group List will be rendered here by JavaScript -->
                <div id="template-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Example Template Card - To be rendered dynamically -->
                </div>
                <div id="group-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                    <!-- Group Cards will be rendered here -->
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <!-- Login/Signup Modal -->
    <div id="login-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md relative">
            <h2 class="text-2xl font-bold mb-6 text-center">로그인 또는 회원가입</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium mb-1">이메일</label>
                    <input type="email" id="login-email" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue" placeholder="email@example.com">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium mb-1">비밀번호</label>
                    <input type="password" id="login-password" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue" placeholder="********">
                </div>
                <button type="submit" class="w-full bg-prime-blue text-white p-3 rounded-xl font-semibold hover:bg-blue-600 transition-colors">로그인</button>
                <button type="button" id="signup-button" class="w-full border border-prime-blue text-prime-blue p-3 rounded-xl font-semibold hover:bg-prime-blue/10 transition-colors">회원가입</button>
            </form>
            <div class="mt-4 text-center text-gray-500 dark:text-gray-400">또는</div>
            <button type="button" id="google-login-button" class="mt-4 w-full bg-red-600 text-white p-3 rounded-xl font-semibold shadow-md hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 40.5z"></path></svg>
                <span>Google로 로그인</span>
            </button>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Template/Snippet CRUD Modal -->
    <div id="crud-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-3xl h-5/6 flex flex-col relative">
            <h2 id="crud-modal-title" class="text-2xl font-bold mb-6">새 템플릿 생성</h2>
            <form id="crud-form" class="flex-1 flex flex-col space-y-4 overflow-y-auto">
                <div>
                    <label for="template-title" class="block text-sm font-medium mb-1">제목</label>
                    <input type="text" id="template-title" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue" placeholder="템플릿 제목을 입력하세요">
                </div>
                <div>
                    <label for="template-description" class="block text-sm font-medium mb-1">설명 (선택 사항)</label>
                    <textarea id="template-description" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue resize-y h-24" placeholder="프롬프트의 목적, 사용 예시, 제약 사항 등을 입력하세요."></textarea>
                </div>
                <div class="flex-1 flex flex-col overflow-hidden">
                    <label for="template-content" class="block text-sm font-medium mb-1">내용</label>
                    <div class="relative flex-1 flex flex-col">
                        <textarea id="template-content" class="flex-1 w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue resize-y leading-relaxed" placeholder="프롬프트 내용을 입력하세요. 동적 변수: {{변수명}}, 상용구: !!상용구명, 템플릿 포함: @템플릿명"></textarea>
                        <!-- Composition Context Menu for Snippets -->
                        <div id="snippet-composition-menu" class="absolute left-0 right-0 top-full mt-1 bg-white dark:bg-gray-800 p-2 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 max-h-48 overflow-y-auto z-10 hidden">
                            <!-- Items will be populated here -->
                        </div>
                    </div>
                    <button type="button" id="prompt-enhance-button" class="mt-2 text-sm text-prime-blue hover:underline">
                        ✨ 프롬프트 개선 ✨
                    </button>
                </div>
                <div>
                    <label for="template-tags" class="block text-sm font-medium mb-1">태그 (쉼표로 구분)</label>
                    <input type="text" id="template-tags" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue" placeholder="예: 개발, 마케팅, 디자인">
                    <button type="button" id="tag-suggestion-button" class="mt-2 text-sm text-prime-blue hover:underline">
                        ✨ 태그 추천 ✨
                    </button>
                </div>
                <!-- New: Group Selection -->
                <div id="template-group-selection" class="relative">
                    <label for="template-groups" class="block text-sm font-medium mb-1">그룹 선택 (다중 선택 가능)</label>
                    <div class="flex flex-wrap gap-2 p-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 cursor-text min-h-[44px]" id="selected-groups-display">
                        <!-- Selected group chips will go here -->
                        <span class="text-gray-500 dark:text-gray-400" id="no-groups-selected">그룹을 선택하세요...</span>
                    </div>
                    <div id="group-multi-select-dropdown" class="multi-select-dropdown absolute w-full mt-1 rounded-xl shadow-lg z-20 hidden">
                        <!-- Group options will be populated here -->
                    </div>
                    <input type="hidden" id="template-selected-group-ids"> <!-- To store selected group IDs -->
                </div>

                <div class="flex justify-end space-x-2 mt-auto pt-4">
                    <button type="button" class="modal-close-button bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-5 py-3 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">취소</button>
                    <button type="submit" id="save-template-button" class="bg-prime-blue text-white px-5 py-3 rounded-xl font-semibold shadow-md hover:bg-blue-600 transition-colors">저장</button>
                </div>
            </form>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Run Prompt Modal -->
    <div id="run-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-3xl h-5/6 flex flex-col relative">
            <h2 class="text-2xl font-bold mb-6" id="run-modal-title-display"></h2>
            <div id="run-variables-container" class="space-y-4 mb-6 overflow-visible">
                <!-- Dynamic variable inputs will be rendered here -->
            </div>
            <div class="flex-1 flex flex-col overflow-hidden">
                <label for="compiled-prompt-preview" class="block text-sm font-medium mb-2">완성된 프롬프트</label>
                <div class="relative flex-1">
                    <textarea id="compiled-prompt-preview" readonly class="w-full h-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 resize-none font-mono text-sm"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button type="button" id="show-compiled-prompt" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-5 py-3 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">완성본 보기</button>
                <button type="button" id="copy-compiled-prompt" class="bg-prime-blue text-white px-5 py-3 rounded-xl font-semibold shadow-md hover:bg-blue-600 transition-colors">복사</button>
            </div>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal fixed inset-0 bg-black bg-opacity50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-4xl h-5/6 flex flex-col overflow-hidden relative">
            <h2 class="text-2xl font-bold mb-6">프롬프트 분석</h2>
            <div class="flex-1 flex flex-col overflow-hidden">
                <div id="analytics-tabs" class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
                    <button class="tab-button p-4 border-b-2 border-prime-blue text-prime-blue font-semibold" data-tab="dashboard">요약 대시보드</button>
                    <button class="tab-button p-4 border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 text-gray-600 dark:text-gray-400 font-semibold" data-tab="versions">버전 기록</button>
                </div>
                <div id="dashboard-tab-content" class="tab-content overflow-y-auto flex-1">
                    <div id="analytics-dashboard-root"></div>
                </div>
                <div id="versions-tab-content" class="tab-content overflow-y-auto flex-1 hidden">
                    <ul id="version-list" class="space-y-4"></ul>
                </div>
            </div>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Version Diff Modal -->
    <div id="diff-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-4xl h-5/6 flex flex-col relative">
            <h2 class="text-2xl font-bold mb-6">버전 비교</h2>
            <div class="flex-1 overflow-y-auto font-mono text-sm leading-relaxed p-4 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                <pre id="diff-content"></pre>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button type="button" id="restore-from-diff-button" class="bg-prime-blue text-white px-5 py-3 rounded-xl font-semibold shadow-md hover:bg-blue-600 transition-colors">이 버전으로 복원</button>
            </div>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md relative">
            <h2 class="text-2xl font-bold mb-6">템플릿 공유</h2>
            <form id="share-form" class="space-y-4">
                <div>
                    <label for="share-email" class="block text-sm font-medium mb-1">초대할 사용자 이메일</label>
                    <input type="email" id="share-email" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue" placeholder="email@example.com">
                </div>
                <div>
                    <label for="share-permission" class="block text-sm font-medium mb-1">권한 부여</label>
                    <select id="share-permission" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue">
                        <option value="viewer">Viewer (보기 및 실행)</option>
                        <option value="editor">Editor (편집, 버전 관리)</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-prime-blue text-white p-3 rounded-xl font-semibold hover:bg-blue-600 transition-colors">공유하기</button>
            </form>
            <div class="mt-6">
                <h3 class="font-semibold mb-2">현재 협업자</h3>
                <ul id="collaborator-list" class="space-y-2">
                    <!-- Collaborator list will be rendered here -->
                </ul>
            </div>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Group CRUD Modal (New) -->
    <div id="group-crud-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md relative">
            <h2 id="group-crud-modal-title" class="text-2xl font-bold mb-6">새 그룹 생성</h2>
            <form id="group-crud-form" class="space-y-4">
                <div>
                    <label for="group-name" class="block text-sm font-medium mb-1">그룹 이름</label>
                    <input type="text" id="group-name" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue" placeholder="그룹 이름을 입력하세요">
                </div>
                <div>
                    <label for="group-description" class="block text-sm font-medium mb-1">설명 (선택 사항)</label>
                    <textarea id="group-description" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue resize-y h-24" placeholder="그룹에 대한 설명을 입력하세요."></textarea>
                </div>
                <div class="flex justify-end space-x-2 mt-auto pt-4">
                    <button type="button" class="modal-close-button bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-5 py-3 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">취소</button>
                    <button type="submit" id="save-group-button" class="bg-prime-blue text-white px-5 py-3 rounded-xl font-semibold shadow-md hover:bg-blue-600 transition-colors">저장</button>
                </div>
            </form>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-md relative">
            <h2 class="text-2xl font-bold mb-6">설정</h2>
            <form id="settings-form" class="space-y-4">
                <div>
                    <label for="gemini-api-key" class="block text-sm font-medium mb-1">Gemini API Key</label>
                    <input type="password" id="gemini-api-key" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue" placeholder="Gemini API Key를 입력하세요">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">LLM 기반 기능 (프롬프트 개선, 태그 추천)에 사용됩니다.</p>
                </div>
                <button type="submit" class="w-full bg-prime-blue text-white p-3 rounded-xl font-semibold hover:bg-blue-600 transition-colors">저장</button>
            </form>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Message/Alert Modal -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center relative">
            <h3 id="message-title" class="text-xl font-bold mb-4"></h3>
            <p id="message-content" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <button id="message-ok-button" class="bg-prime-blue text-white px-6 py-2 rounded-xl font-semibold hover:bg-blue-600 transition-colors">확인</button>
            <button class="modal-close-button absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"><i data-feather="x" class="h-6 w-6"></i></button>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-prime-blue"></div>
    </div>

    <!--
        React Component for Analytics Dashboard.
        This script tag must have type="text/babel" to be transpiled by Babel Standalone.
    -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        const AnalyticsDashboard = ({ data }) => {
            if (!data) {
                return <div className="text-center text-gray-500 dark:text-gray-400">데이터를 불러오는 중입니다...</div>;
            }

            const totalVersions = data.versions ? data.versions.length : 0;

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-gray-50 dark:bg-gray-800 p-6 rounded-2xl shadow-inner border border-gray-200 dark:border-gray-700">
                            <h3 className="text-lg font-semibold text-gray-700 dark:text-dark-text mb-2">총 버전 수</h3>
                            <div className="text-5xl font-bold text-prime-blue">{totalVersions}</div>
                        </div>
                        <div className="bg-gray-50 dark:bg-gray-800 p-6 rounded-2xl shadow-inner border border-gray-200 dark:border-gray-700">
                            <h3 className="text-lg font-semibold text-gray-700 dark:text-dark-text mb-2">기타 통계</h3>
                            <div className="text-5xl font-bold text-accent-orange">N/A</div>
                        </div>
                    </div>
                    <div className="bg-gray-50 dark:bg-gray-800 p-6 rounded-2xl shadow-inner border border-gray-200 dark:border-gray-700 min-h-[300px] flex items-center justify-center">
                        <p className="text-gray-500 dark:text-gray-400">데이터 시각화 차트 영역</p>
                    </div>
                </div>
            );
        };

        // This function will be called from Vanilla JS to render the React component
        window.renderAnalyticsDashboard = (data) => {
            const root = document.getElementById('analytics-dashboard-root');
            if (root) {
                ReactDOM.render(<AnalyticsDashboard data={data} />, root);
            }
        };
    </script>

    <!--
        Main Application Logic (Vanilla JavaScript)
        This script uses ES Modules to manage dependencies.
    -->
    <script type="module">
        // -----------------------------------------------------------
        // V. 기술 스택 (Technical Stack)
        // 5.2 백엔드 (Backend - BaaS)
        // Firebase CDN imports and configuration
        // -----------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, where, onSnapshot, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Provided Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAu9SO6kz8IkIsdRrx8CxbIf_j8rNStSc",
            authDomain: "myproject-c8755.firebaseapp.com",
            projectId: "myproject-c8755",
            storageBucket: "myproject-c8755.firebasestorage.app",
            messagingSenderId: "688390265283",
            appId: "1:688390265283:web:d4d5da40b0d9f2ceb78576",
            measurementId: "G-SFX7GVPRME"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variable for Gemini API Key, can be updated from settings
        let GEMINI_API_KEY = "";
        const GEMINI_API_URL = (apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

        // Global app ID for Firestore paths (using Canvas global if available)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // -----------------------------------------------------------
        // IV. 비기능적 요구사항 (Non-Functional Requirements)
        // 4.3 유지보수성 (Maintainability)
        // Utility functions for UI/UX
        // -----------------------------------------------------------
        // Helper function for debouncing
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        const showLoading = () => document.getElementById('loading-overlay').classList.remove('hidden');
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');
        
        const showModal = (modalId) => {
            const modalElement = document.getElementById(modalId);
            modalElement.classList.remove('hidden');
            // Add event listener to close modal when clicking outside of its content
            const contentElement = modalElement.querySelector('div:first-child');
            if (modalElement && contentElement) {
                function clickOutsideHandler(event) {
                    if (!contentElement.contains(event.target)) {
                        hideModal(modalId);
                        modalElement.removeEventListener('click', clickOutsideHandler);
                    }
                }
                modalElement.addEventListener('click', clickOutsideHandler);
            }
        };

        const hideModal = (modalId) => {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'crud-modal') {
                document.getElementById('snippet-composition-menu').classList.add('hidden');
                document.getElementById('group-multi-select-dropdown').classList.add('hidden'); // Hide group dropdown
            }
            if (modalId === 'group-filter-dropdown') {
                document.getElementById('group-filter-dropdown').classList.add('hidden');
            }
        };

        const showMessage = (title, message, isError = false) => {
            const modal = document.getElementById('message-modal');
            modal.querySelector('#message-title').textContent = title;
            modal.querySelector('#message-content').innerHTML = message;
            showModal('message-modal');
        };
        document.getElementById('message-ok-button').addEventListener('click', () => hideModal('message-modal'));
        document.querySelectorAll('.modal-close-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                hideModal(e.target.closest('.modal').id);
            });
        });

        // Simple Diff function (line-by-line comparison for now)
        function generateDiffHtml(originalText, newText) {
            const originalLines = originalText.split('\n');
            const newLines = newText.split('\n');
            let html = '';

            const maxLength = Math.max(originalLines.length, newLines.length);

            for (let i = 0; i < maxLength; i++) {
                const originalLine = originalLines[i] !== undefined ? originalLines[i] : '';
                const newLine = newLines[i] !== undefined ? newLines[i] : '';

                if (originalLine === newLine) {
                    html += `<span>${newLine}</span>\n`;
                } else {
                    if (originalLines[i] !== undefined) {
                        html += `<span class="diff-removed">${originalLine}</span>\n`;
                    }
                    if (newLines[i] !== undefined) {
                        html += `<span class="diff-added">${newLine}</span>\n`;
                    }
                }
            }
            return html;
        }


        // -----------------------------------------------------------
        // II. 사용자 기능 명세 (User Functional Specifications)
        // 2.1 사용자 계정 및 인증 (User Account & Authentication)
        // -----------------------------------------------------------
        let currentUser = null;
        let currentUserId = null; // Store userId for Firestore paths
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const googleLoginButton = document.getElementById('google-login-button');
        const userProfile = document.getElementById('user-profile');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const userDisplayName = document.getElementById('user-display-name');
        const userIdDisplay = document.getElementById('user-id-display'); // New element for UID
        const currentViewTitle = document.getElementById('current-view-title');
        const currentViewIcon = document.getElementById('current-view-icon');
        const settingsModal = document.getElementById('settings-modal');
        const settingsForm = document.getElementById('settings-form');
        const geminiApiKeyInput = document.getElementById('gemini-api-key');

        // Function to update the header title and icon based on currentView
        const updateHeaderViewDisplay = (view) => {
            let iconName = 'file-text';
            let titleText = '나의 템플릿';
            const viewOptions = document.getElementById('view-options');
            const groupFilterContainer = document.getElementById('group-filter-container');

            // Hide/show view options and group filter based on view
            if (view === 'my-templates' || view === 'shared-templates') {
                viewOptions.classList.remove('hidden');
                groupFilterContainer.classList.remove('hidden');
            } else {
                viewOptions.classList.add('hidden');
                groupFilterContainer.classList.add('hidden');
            }

            switch (view) {
                case 'my-templates':
                    iconName = 'file-text';
                    titleText = '나의 템플릿';
                    break;
                case 'shared-templates':
                    iconName = 'share-2';
                    titleText = '공유된 템플릿';
                    break;
                case 'snippets':
                    iconName = 'code';
                    titleText = '상용구';
                    break;
                case 'groups':
                    iconName = 'folder';
                    titleText = '그룹 관리';
                    viewOptions.classList.add('hidden'); // Hide view options for groups
                    groupFilterContainer.classList.add('hidden'); // Hide group filter for group management
                    break;
            }
            currentViewIcon.setAttribute('data-feather', iconName);
            currentViewTitle.querySelector('span').textContent = titleText;
            feather.replace();
        };

        sidebarToggleButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                currentUserId = user.uid; // Set currentUserId
                hideModal('login-modal');
                userDisplayName.textContent = user.displayName || user.email;
                userIdDisplay.textContent = `UID: ${user.uid}`; // Display UID

                // Create or update user profile document in Firestore
                await setDoc(doc(db, "users", currentUserId), {
                    uid: currentUserId,
                    email: user.email,
                    displayName: user.displayName || 'Anonymous User',
                    createdAt: new Date(),
                }, { merge: true });

                // Load user settings (including API Key)
                const settingsDoc = await getDoc(doc(db, "users", currentUserId, "settings", "llm_config"));
                if (settingsDoc.exists()) {
                    GEMINI_API_KEY = settingsDoc.data().geminiApiKey || "";
                } else {
                    GEMINI_API_KEY = "";
                }
                
                // Initial render of templates and setup listeners
                setupRealtimeListeners();
                updateHeaderViewDisplay(currentView); // Initial header display
            } else {
                currentUser = null;
                currentUserId = null; // Clear userId
                showModal('login-modal');
                userDisplayName.textContent = 'Guest';
                userIdDisplay.textContent = ''; // Clear UID display
                GEMINI_API_KEY = "";
                renderTemplates([]); // Clear the template list
                renderGroups([]); // Clear group list
            }
        });

        // Use __initial_auth_token if available for Canvas environment
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
                console.error("Custom token sign-in error:", error);
                signInAnonymously(auth).catch((anonError) => {
                    console.error("Anonymous sign-in error:", anonError);
                });
            });
        } else {
            // Fallback to anonymous sign-in if no custom token
            signInAnonymously(auth).catch((error) => {
                console.error("Anonymous sign-in error:", error);
            });
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target['login-email'].value;
            const password = e.target['login-password'].value;
            showLoading();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('로그인 성공', '환영합니다!');
            } catch (error) {
                console.error("Login error:", error);
                showMessage('로그인 실패', `에러: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('signup-button').addEventListener('click', async () => {
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            showLoading();
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage('회원가입 성공', '계정이 생성되었습니다. 자동으로 로그인됩니다.');
            } catch (error) {
                console.error("Signup error:", error);
                showMessage('회원가입 실패', `에러: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        });

        googleLoginButton.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            showLoading();
            try {
                await signInWithPopup(auth, provider);
                showMessage('Google 로그인 성공', 'Google 계정으로 로그인되었습니다!');
            } catch (error) {
                console.error("Google login error:", error);
                showMessage('Google 로그인 실패', `에러: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        });

        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
            showMessage('로그아웃', '성공적으로 로그아웃되었습니다.');
            renderTemplates([]); // Clear the template list
            renderGroups([]); // Clear the group list
        });

        // Settings Menu Click
        document.getElementById('nav-settings').addEventListener('click', async () => {
            if (currentUser) {
                const settingsDoc = await getDoc(doc(db, "users", currentUserId, "settings", "llm_config"));
                if (settingsDoc.exists()) {
                    geminiApiKeyInput.value = settingsDoc.data().geminiApiKey || "";
                } else {
                    geminiApiKeyInput.value = "";
                }
                showModal('settings-modal');
            } else {
                showMessage('로그인 필요', '설정을 변경하려면 로그인해야 합니다.', true);
            }
        });

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showMessage('오류', '로그인 상태가 아닙니다.', true);
                return;
            }
            const apiKey = geminiApiKeyInput.value;
            showLoading();
            try {
                await setDoc(doc(db, "users", currentUserId, "settings", "llm_config"), {
                    geminiApiKey: apiKey,
                    updatedAt: new Date()
                }, { merge: true });
                GEMINI_API_KEY = apiKey; // Update global API key
                showMessage('설정 저장 완료', 'API 키가 성공적으로 저장되었습니다.');
                hideModal('settings-modal');
            } catch (error) {
                console.error("Save settings error:", error);
                showMessage('설정 저장 실패', `오류: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        });


        // -----------------------------------------------------------
        // 3.2 디자인 시스템 (Design System) - Dark Mode
        // -----------------------------------------------------------
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        darkModeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('dark-mode', isDark);
            feather.replace(); // Re-render icons for color change
        });

        if (localStorage.getItem('dark-mode') === 'true' || (!('dark-mode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        // -----------------------------------------------------------
        // 2.2 프롬프트 템플릿 관리 (Prompt Template Management)
        // 2.3 상용구(Snippet) 관리 (Snippet Management)
        // 2.10 템플릿 그룹화 (New Feature)
        // -----------------------------------------------------------
        const contentContainer = document.getElementById('template-list'); // For templates/snippets
        const groupListContainer = document.getElementById('group-list'); // For groups
        const addNewButton = document.getElementById('add-new-button');
        const crudModal = document.getElementById('crud-modal');
        const groupCrudModal = document.getElementById('group-crud-modal'); // New group modal
        const runModal = document.getElementById('run-modal');
        const analyticsModal = document.getElementById('analytics-modal');
        const diffModal = document.getElementById('diff-modal');
        const shareModal = document.getElementById('share-modal');
        const globalSearchInput = document.getElementById('global-search');

        let currentView = 'my-templates'; // Default view
        let templates = [];
        let snippets = [];
        let groups = []; // New: Store groups

        let selectedGroupFilterId = 'all'; // Default filter for groups

        // Function to render templates/snippets
        const renderTemplates = (items = []) => {
            contentContainer.innerHTML = '';
            groupListContainer.classList.add('hidden'); // Hide group list
            contentContainer.classList.remove('hidden'); // Show template list

            const isGalleryView = document.getElementById('view-gallery').classList.contains('text-prime-blue');
            contentContainer.className = `grid gap-6 ${isGalleryView ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1'}`;

            items.forEach(item => {
                const isTemplate = item.type === 'template';
                const contentSnippetClass = isGalleryView ? 'line-clamp-3' : 'line-clamp-1';
                const descriptionSnippetClass = isGalleryView ? 'line-clamp-2' : 'line-clamp-1';

                const cardHtml = `
                    <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-lg transition-transform transform hover:scale-[1.02] cursor-pointer template-card" data-id="${item.id}" data-type="${item.type}">
                        <h3 class="text-xl font-semibold mb-2 line-clamp-1">${item.title}</h3>
                        ${item.description ? `<p class="text-gray-500 dark:text-gray-400 text-xs mb-2 ${descriptionSnippetClass}">${item.description}</p>` : ''}
                        <p class="text-gray-600 dark:text-gray-300 text-sm mb-4 ${contentSnippetClass}">${item.content.replace(/\n/g, '<br/>')}</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${isTemplate && item.tags ? item.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-200 cursor-pointer tag-chip" data-tag="${tag}">#${tag}</span>`).join('') : ''}
                            ${item.groupIds && item.groupIds.length > 0 ? item.groupIds.map(groupId => {
                                const group = groups.find(g => g.id === groupId);
                                return group ? `<span class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded-full dark:bg-purple-900 dark:text-purple-200 cursor-pointer group-chip" data-group-id="${groupId}">#${group.name}</span>` : '';
                            }).join('') : ''}
                        </div>
                        <div class="flex justify-end space-x-2">
                            ${isTemplate ? `<button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors run-btn" title="실행"><i data-feather="play" class="h-5 w-5 text-prime-blue"></i></button>` : ''}
                            ${isTemplate ? `<button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors analytics-btn" title="분석"><i data-feather="activity" class="h-5 w-5 text-accent-purple"></i></button>` : ''}
                            <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors edit-btn" title="수정"><i data-feather="edit" class="h-5 w-5 text-accent-orange"></i></button>
                            ${isTemplate ? `<button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors share-btn" title="공유"><i data-feather="share-2" class="h-5 w-5 text-green-600"></i></button>` : ''}
                            <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors delete-btn" title="삭제"><i data-feather="trash-2" class="h-5 w-5 text-red-600"></i></button>
                        </div>
                    </div>
                `;
                contentContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
            feather.replace();
        };

        // Function to render groups
        const renderGroups = (items = []) => {
            groupListContainer.innerHTML = '';
            contentContainer.classList.add('hidden'); // Hide template list
            groupListContainer.classList.remove('hidden'); // Show group list

            groupListContainer.className = `grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3`;

            if (items.length === 0) {
                groupListContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">아직 생성된 그룹이 없습니다. 새로운 그룹을 추가해보세요!</p>';
            }

            items.forEach(group => {
                const groupCardHtml = `
                    <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-lg transition-transform transform hover:scale-[1.02] cursor-pointer group-card" data-id="${group.id}">
                        <h3 class="text-xl font-semibold mb-2 line-clamp-1">${group.name}</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-sm mb-4 line-clamp-3">${group.description || '설명 없음'}</p>
                        <div class="flex justify-end space-x-2">
                            <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors edit-group-btn" title="그룹 수정"><i data-feather="edit" class="h-5 w-5 text-accent-orange"></i></button>
                            <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors delete-group-btn" title="그룹 삭제"><i data-feather="trash-2" class="h-5 w-5 text-red-600"></i></button>
                        </div>
                    </div>
                `;
                groupListContainer.insertAdjacentHTML('beforeend', groupCardHtml);
            });
            feather.replace();
        };

        const setupRealtimeListeners = () => {
            if (!currentUserId) return; // Ensure user is logged in

            // Listener for templates owned by the current user
            onSnapshot(query(collection(db, `users/${currentUserId}/templates`)), (snapshot) => {
                templates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'template' }));
                if (currentView === 'my-templates') {
                    applyFiltersAndRender();
                }
            });

            // Listener for templates shared with the current user
            // We'll use a top-level 'shared_templates' collection for querying,
            // and then fetch the actual template data from the owner's collection.
            // This requires a different sharing model than the current one.
            // For simplicity and to match the existing structure, we'll assume templates
            // are stored globally and security rules handle access, or that `sharedWith` array is used.
            // Given the existing `permissions` map, we'll query for templates where the current user's UID is a key in the permissions map.
            // Firestore does not directly support querying map keys.
            // The most scalable way for shared templates is to have a `sharedWith` array on the template document.
            // Let's modify the sharing logic to add `sharedWith` array.
            onSnapshot(query(collection(db, `templates`), where(`permissions.${currentUserId}`, 'in', ['viewer', 'editor'])), (snapshot) => {
                const sharedTemplates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'template' }));
                // Filter out templates owned by the current user from the shared view
                const filteredSharedTemplates = sharedTemplates.filter(t => t.owner_uid !== currentUserId);
                // Merge with owned templates for overall 'templates' array, but keep separate for view logic
                templates = [...templates.filter(t => t.owner_uid === currentUserId), ...filteredSharedTemplates];
                if (currentView === 'shared-templates') {
                    applyFiltersAndRender();
                }
            });

            // Listener for snippets owned by the current user
            onSnapshot(query(collection(db, `users/${currentUserId}/snippets`)), (snapshot) => {
                snippets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'snippet' }));
                if (currentView === 'snippets') {
                    applyFiltersAndRender();
                }
            });

            // Listener for groups owned by the current user
            onSnapshot(query(collection(db, `users/${currentUserId}/groups`)), (snapshot) => {
                groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'groups') {
                    renderGroups(groups);
                }
                populateGroupFilterDropdown(); // Update group filter dropdown
                populateGroupMultiSelect(); // Update group multi-select in CRUD modal
            });
        };

        // Function to apply search and group filters
        const applyFiltersAndRender = () => {
            let filteredItems = [];
            let sourceData = [];

            if (currentView === 'snippets') {
                sourceData = snippets;
            } else if (currentView === 'my-templates') {
                sourceData = templates.filter(t => t.owner_uid === currentUserId);
            } else if (currentView === 'shared-templates') {
                sourceData = templates.filter(t => t.permissions && t.permissions[currentUserId] && t.permissions[currentUserId] !== 'owner');
            } else if (currentView === 'groups') {
                renderGroups(groups); // Groups have their own rendering
                return;
            }

            // Apply group filter
            if (selectedGroupFilterId !== 'all') {
                sourceData = sourceData.filter(item => item.groupIds && item.groupIds.includes(selectedGroupFilterId));
            }

            // Apply global search
            const searchTerm = globalSearchInput.value.toLowerCase();
            if (searchTerm) {
                filteredItems = sourceData.filter(item => {
                    const terms = searchTerm.split(/\s+/).filter(Boolean);
                    let hasAnd = searchTerm.includes(' and ');
                    let hasOr = searchTerm.includes(' or ');

                    if (hasAnd && hasOr) {
                        return item.title.toLowerCase().includes(searchTerm) ||
                               item.content.toLowerCase().includes(searchTerm) ||
                               (item.tags && item.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
                    } else if (hasAnd) {
                        const andTerms = searchTerm.split(' and ').filter(Boolean);
                        return andTerms.every(term =>
                            item.title.toLowerCase().includes(term.trim()) ||
                            item.content.toLowerCase().includes(term.trim()) ||
                            (item.tags && item.tags.some(tag => tag.toLowerCase().includes(term.trim())))
                        );
                    } else if (hasOr) {
                        const orTerms = searchTerm.split(' or ').filter(Boolean);
                        return orTerms.some(term =>
                            item.title.toLowerCase().includes(term.trim()) ||
                            item.content.toLowerCase().includes(term.trim()) ||
                            (item.tags && item.tags.some(tag => tag.toLowerCase().includes(term.trim())))
                        );
                    } else {
                        return terms.some(term =>
                            item.title.toLowerCase().includes(term) ||
                            item.content.toLowerCase().includes(term) ||
                            (item.tags && item.tags.some(tag => tag.toLowerCase().includes(term)))
                        );
                    }
                });
            } else {
                filteredItems = sourceData;
            }
            renderTemplates(filteredItems);
        };


        document.getElementById('nav-my-templates').addEventListener('click', () => {
            currentView = 'my-templates';
            updateHeaderViewDisplay(currentView);
            applyFiltersAndRender();
        });
        document.getElementById('nav-shared-templates').addEventListener('click', () => {
            currentView = 'shared-templates';
            updateHeaderViewDisplay(currentView);
            applyFiltersAndRender();
        });
        document.getElementById('nav-snippets').addEventListener('click', () => {
            currentView = 'snippets';
            updateHeaderViewDisplay(currentView);
            applyFiltersAndRender();
        });
        document.getElementById('nav-groups').addEventListener('click', () => {
            currentView = 'groups';
            updateHeaderViewDisplay(currentView);
            renderGroups(groups); // Directly render groups when this view is selected
        });


        document.getElementById('view-gallery').addEventListener('click', (e) => {
            e.currentTarget.classList.add('text-prime-blue', 'bg-prime-blue/10');
            document.getElementById('view-list').classList.remove('text-prime-blue', 'bg-prime-blue/10');
            applyFiltersAndRender(); // Re-render current view with new layout
        });
        document.getElementById('view-list').addEventListener('click', (e) => {
            e.currentTarget.classList.add('text-prime-blue', 'bg-prime-blue/10');
            document.getElementById('view-gallery').classList.remove('text-prime-blue', 'bg-prime-blue/10');
            applyFiltersAndRender(); // Re-render current view with new layout
        });

        // Global Search & Filtering
        globalSearchInput.addEventListener('input', debounce(applyFiltersAndRender, 300));

        // Tag click handler for search
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tag-chip')) {
                const tag = e.target.dataset.tag;
                globalSearchInput.value = tag;
                applyFiltersAndRender(); // Trigger search
            } else if (e.target.classList.contains('group-chip')) { // New: Group chip click handler
                const groupId = e.target.dataset.groupId;
                selectedGroupFilterId = groupId;
                const group = groups.find(g => g.id === groupId);
                document.getElementById('selected-group-name').textContent = group ? group.name : '모든 그룹';
                hideModal('group-filter-dropdown');
                applyFiltersAndRender();
            }
        });

        // Group Filter Dropdown Logic
        const groupFilterButton = document.getElementById('group-filter-button');
        const groupFilterDropdown = document.getElementById('group-filter-dropdown');
        const groupFilterList = document.getElementById('group-filter-list');
        const selectedGroupNameDisplay = document.getElementById('selected-group-name');

        groupFilterButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent document click from closing immediately
            groupFilterDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!groupFilterDropdown.contains(e.target) && !groupFilterButton.contains(e.target)) {
                hideModal('group-filter-dropdown');
            }
        });

        groupFilterDropdown.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.groupId) {
                selectedGroupFilterId = e.target.dataset.groupId;
                const group = groups.find(g => g.id === selectedGroupFilterId);
                selectedGroupNameDisplay.textContent = group ? group.name : '모든 그룹';
                hideModal('group-filter-dropdown');
                applyFiltersAndRender();
            }
        });

        const populateGroupFilterDropdown = () => {
            groupFilterList.innerHTML = '';
            groups.forEach(group => {
                const button = document.createElement('button');
                button.className = 'block w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700';
                button.dataset.groupId = group.id;
                button.textContent = group.name;
                groupFilterList.appendChild(button);
            });
            // Ensure "All Groups" is selected if no specific filter is active
            if (selectedGroupFilterId === 'all') {
                selectedGroupNameDisplay.textContent = '모든 그룹';
            } else {
                const selectedGroup = groups.find(g => g.id === selectedGroupFilterId);
                selectedGroupNameDisplay.textContent = selectedGroup ? selectedGroup.name : '모든 그룹';
            }
        };


        // -----------------------------------------------------------
        // 2.4 프롬프트 저작 및 실행 (Prompt Authoring & Execution)
        // 2.9 LLM 기반 지능형 기능 (LLM-Powered Intelligent Features)
        // -----------------------------------------------------------
        const crudForm = document.getElementById('crud-form');
        let currentCrudItemId = null;
        let currentCrudItemType = null;
        const templateContentInput = document.getElementById('template-content');
        const templateDescriptionInput = document.getElementById('template-description');
        const snippetCompositionMenu = document.getElementById('snippet-composition-menu');
        const SNIPPET_COMPOSITION_PREFIX = '!!';
        const TEMPLATE_COMPOSITION_PREFIX = '@'; // For template composition (not live search yet)

        // Group Multi-Select in CRUD Modal
        const selectedGroupsDisplay = document.getElementById('selected-groups-display');
        const groupMultiSelectDropdown = document.getElementById('group-multi-select-dropdown');
        const templateSelectedGroupIdsInput = document.getElementById('template-selected-group-ids'); // Hidden input to store selected IDs

        let selectedGroupIds = []; // Temporarily store selected group IDs for the current CRUD operation

        // Populate group multi-select dropdown
        const populateGroupMultiSelect = () => {
            groupMultiSelectDropdown.innerHTML = '';
            if (groups.length === 0) {
                groupMultiSelectDropdown.innerHTML = '<div class="p-3 text-gray-500 dark:text-gray-400">생성된 그룹이 없습니다.</div>';
                return;
            }
            groups.forEach(group => {
                const div = document.createElement('div');
                div.className = 'multi-select-item';
                div.dataset.groupId = group.id;
                div.textContent = group.name;
                if (selectedGroupIds.includes(group.id)) {
                    div.classList.add('selected');
                }
                groupMultiSelectDropdown.appendChild(div);
            });
        };

        // Update selected groups display (chips)
        const updateSelectedGroupsDisplay = () => {
            selectedGroupsDisplay.innerHTML = '';
            if (selectedGroupIds.length === 0) {
                selectedGroupsDisplay.innerHTML = '<span class="text-gray-500 dark:text-gray-400" id="no-groups-selected">그룹을 선택하세요...</span>';
            } else {
                selectedGroupIds.forEach(groupId => {
                    const group = groups.find(g => g.id === groupId);
                    if (group) {
                        const chip = document.createElement('span');
                        chip.className = 'inline-flex items-center bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded-full dark:bg-purple-900 dark:text-purple-200 cursor-pointer';
                        chip.innerHTML = `#${group.name} <i data-feather="x" class="ml-1 h-3 w-3 remove-group-chip" data-group-id="${groupId}"></i>`;
                        selectedGroupsDisplay.appendChild(chip);
                    }
                });
                feather.replace(); // Re-render feather icons for new chips
            }
        };

        // Toggle group selection in multi-select dropdown
        groupMultiSelectDropdown.addEventListener('click', (e) => {
            const item = e.target.closest('.multi-select-item');
            if (item) {
                const groupId = item.dataset.groupId;
                if (selectedGroupIds.includes(groupId)) {
                    selectedGroupIds = selectedGroupIds.filter(id => id !== groupId);
                    item.classList.remove('selected');
                } else {
                    selectedGroupIds.push(groupId);
                    item.classList.add('selected');
                }
                updateSelectedGroupsDisplay();
            }
        });

        // Open/Close group multi-select dropdown
        selectedGroupsDisplay.addEventListener('click', (e) => {
            // Check if click was on a chip's remove button
            if (e.target.classList.contains('remove-group-chip')) {
                const groupIdToRemove = e.target.dataset.groupId;
                selectedGroupIds = selectedGroupIds.filter(id => id !== groupIdToRemove);
                updateSelectedGroupsDisplay();
                populateGroupMultiSelect(); // Update dropdown state
                e.stopPropagation(); // Prevent dropdown from opening
                return;
            }
            groupMultiSelectDropdown.classList.toggle('hidden');
            populateGroupMultiSelect(); // Refresh list on open
        });

        // Close group multi-select dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!groupMultiSelectDropdown.contains(e.target) && !selectedGroupsDisplay.contains(e.target)) {
                groupMultiSelectDropdown.classList.add('hidden');
            }
        });


        // Undo/Redo state
        let undoStack = [];
        let redoStack = [];
        const MAX_UNDO_STACK_SIZE = 100;

        const saveToUndoStack = debounce(() => {
            const currentContent = templateContentInput.value;
            if (undoStack.length === 0 || undoStack[undoStack.length - 1] !== currentContent) {
                undoStack.push(currentContent);
                if (undoStack.length > MAX_UNDO_STACK_SIZE) {
                    undoStack.shift();
                }
                redoStack = [];
            }
        }, 300);

        const undo = () => {
            if (undoStack.length > 1) {
                const currentState = undoStack.pop();
                redoStack.push(currentState);
                templateContentInput.value = undoStack[undoStack.length - 1];
                templateContentInput.focus();
            } else if (undoStack.length === 1) {
                const currentState = undoStack.pop();
                redoStack.push(currentState);
                templateContentInput.value = '';
                templateContentInput.focus();
            }
        };

        const redo = () => {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                undoStack.push(nextState);
                templateContentInput.value = nextState;
                templateContentInput.focus();
            }
        };

        templateContentInput.addEventListener('input', saveToUndoStack);
        templateContentInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            } else if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Z') {
                e.preventDefault();
                redo();
            }
        });


        addNewButton.addEventListener('click', () => {
            if (currentView === 'groups') {
                document.getElementById('group-crud-modal-title').textContent = '새 그룹 생성';
                document.getElementById('group-crud-form').reset();
                groupCrudModal.dataset.editId = ''; // Clear edit ID
                showModal('group-crud-modal');
            } else {
                document.getElementById('crud-modal-title').textContent = currentView === 'snippets' ? '새 상용구 생성' : '새 템플릿 생성';
                crudForm.reset();
                currentCrudItemId = null;
                currentCrudItemType = currentView === 'snippets' ? 'snippet' : 'template';
                // Show/hide tags and description input based on type
                document.getElementById('template-tags').closest('div').classList.toggle('hidden', currentCrudItemType === 'snippet');
                document.getElementById('tag-suggestion-button').classList.toggle('hidden', currentCrudItemType === 'snippet');
                templateDescriptionInput.closest('div').classList.toggle('hidden', currentCrudItemType === 'snippet');
                document.getElementById('template-group-selection').classList.toggle('hidden', currentCrudItemType === 'snippet'); // Hide group selection for snippets

                selectedGroupIds = []; // Reset selected groups
                updateSelectedGroupsDisplay();
                populateGroupMultiSelect(); // Populate dropdown with all groups

                showModal('crud-modal');
                templateContentInput.focus();

                undoStack = [''];
                redoStack = [];
            }
        });

        // Dynamic variable parsing
        const extractVariables = (content) => {
            const regex = /\{\{(.*?)\}\}/g;
            const variables = new Set();
            let match;
            while ((match = regex.exec(content)) !== null) {
                variables.add(match[1]);
            }
            return Array.from(variables);
        };

        // Prompt composition logic
        const resolveCompositions = (content, allTemplates, allSnippets, maxDepth = 5, path = []) => {
            if (maxDepth <= 0) {
                console.warn("Circular reference detected or maximum nesting depth exceeded. Aborting recursion.");
                return content;
            }

            let composedContent = content;

            // Snippet composition (!!snippet_title)
            composedContent = composedContent.replace(/(?:^|\s)!!(\S+)/g, (match, snippetTitle) => {
                const snippet = allSnippets.find(s => s.title === snippetTitle);
                return snippet ? (match.startsWith(' ') ? ` ${snippet.content}` : snippet.content) : match;
            });

            // Template composition (@template_title)
            composedContent = composedContent.replace(/@(\w+)/g, (match, templateTitle) => {
                const template = allTemplates.find(t => t.title === templateTitle);
                if (template) {
                    if (path.includes(template.id)) {
                        console.warn(`Circular reference detected for template '${template.title}' (ID: ${template.id}). Aborting recursion.`);
                        return match;
                    }
                    return resolveCompositions(template.content, allTemplates, allSnippets, maxDepth - 1, [...path, template.id]);
                }
                return match;
            });
            return composedContent;
        };

        // Function to update the compiled prompt preview in run modal
        const updateRunModalCompiledPrompt = () => {
            const template = templates.find(t => t.id === runModal.dataset.templateId);
            if (!template) return;

            let compiledContent = '';
            const runVariableInputs = Array.from(document.querySelectorAll('#run-variables-container textarea'));
            const initialTemplateContent = template.content;

            try {
                let processedContent = resolveCompositions(initialTemplateContent, templates, snippets);
                
                const currentVariableValues = {};
                runVariableInputs.forEach(input => {
                    currentVariableValues[input.dataset.varName] = input.value;
                });

                compiledContent = processedContent.replace(/\{\{(.*?)\}\}/g, (match, varName) => {
                    return currentVariableValues[varName] !== undefined ? currentVariableValues[varName] : match;
                });

            } catch (error) {
                console.error("Composition error during auto-render:", error);
                compiledContent = `Error: ${error.message}`;
            }
            
            document.getElementById('compiled-prompt-preview').value = compiledContent;
        };

        // Debounced version of the update function for run modal inputs
        const debouncedUpdateRunModal = debounce(updateRunModalCompiledPrompt, 800);


        // Run Modal logic
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.run-btn')) {
                const card = e.target.closest('.template-card');
                const templateId = card.dataset.id;
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    document.getElementById('run-modal-title-display').textContent = template.title;
                    const variablesContainer = document.getElementById('run-variables-container');
                    variablesContainer.innerHTML = '';

                    try {
                        const baseCompiledContent = resolveCompositions(template.content, templates, snippets);
                        const variables = extractVariables(baseCompiledContent);
                        
                        if (variables.length > 0) {
                            variables.forEach(variable => {
                                const inputHtml = `
                                    <div>
                                        <label for="run-var-${variable}" class="block text-sm font-medium mb-1">${variable}</label>
                                        <textarea id="run-var-${variable}" data-var-name="${variable}" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-prime-blue resize-y h-24"></textarea>
                                    </div>
                                `;
                                variablesContainer.insertAdjacentHTML('beforeend', inputHtml);
                            });
                            variablesContainer.querySelectorAll('textarea').forEach(input => {
                                input.addEventListener('input', debouncedUpdateRunModal);
                            });
                        } else {
                            variablesContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">이 프롬프트에는 동적 변수가 없습니다.</p>';
                        }
                        
                        runModal.dataset.templateId = templateId;
                        showModal('run-modal');
                        updateRunModalCompiledPrompt();
                    } catch (error) {
                        showMessage('프롬프트 컴포지션 오류', error.message, true);
                        console.error("Composition error:", error);
                    }
                }
            }
        });

        // Manual 'Show Compiled Prompt' button logic
        document.getElementById('show-compiled-prompt').addEventListener('click', updateRunModalCompiledPrompt);


        document.getElementById('copy-compiled-prompt').addEventListener('click', async () => {
            const compiledPrompt = document.getElementById('compiled-prompt-preview').value;
            try {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = compiledPrompt;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);

                showMessage('복사 완료', '프롬프트가 클립보드에 복사되었습니다!');
                hideModal('run-modal');
            } catch (err) {
                console.error('Failed to copy:', err);
                showMessage('작업 실패', '클립보드 복사에 실패했습니다.', true);
            }
        });

        // LLM features
        document.getElementById('prompt-enhance-button').addEventListener('click', async () => {
            const content = templateContentInput.value;
            if (!content) {
                showMessage('입력 필요', '개선할 프롬프트 내용을 입력해주세요.', true);
                return;
            }
            if (!GEMINI_API_KEY) {
                showMessage('API 키 필요', 'Gemini API 키가 설정되지 않았습니다. 설정에서 API 키를 입력해주세요.', true);
                return;
            }

            showLoading();
            try {
                const payload = {
                    contents: [{ parts: [{ text: `다음 프롬프트 내용을 더 명확하고 효과적으로 개선해줘. 개선된 내용만 응답해줘:\n\n${content}` }] }]
                };
                const response = await fetch(GEMINI_API_URL(GEMINI_API_KEY), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const enhancedContent = result.candidates[0].content.parts[0].text;
                
                const confirmApply = await new Promise(resolve => {
                    const confirmModal = document.getElementById('message-modal');
                    confirmModal.querySelector('#message-title').textContent = '프롬프트 개선 제안';
                    confirmModal.querySelector('#message-content').innerHTML = `개선된 프롬프트 내용을 적용하시겠습니까?<br/><pre class="bg-gray-100 dark:bg-gray-900 p-2 rounded-lg mt-2 text-xs text-left whitespace-pre-wrap">${enhancedContent}</pre>`;
                    const okButton = confirmModal.querySelector('#message-ok-button');
                    const originalOkText = okButton.textContent;
                    
                    okButton.textContent = '적용';
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = '취소';
                    cancelButton.className = 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-6 py-2 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors ml-2';
                    okButton.parentNode.insertBefore(cancelButton, okButton.nextSibling);

                    const clickHandler = (e) => {
                        if (e.target === okButton) {
                            resolve(true);
                        } else if (e.target === cancelButton) {
                            resolve(false);
                        }
                        okButton.removeEventListener('click', clickHandler);
                        cancelButton.removeEventListener('click', clickHandler);
                        cancelButton.remove();
                        okButton.textContent = originalOkText;
                        hideModal('message-modal');
                    };
                    okButton.addEventListener('click', clickHandler);
                    cancelButton.addEventListener('click', clickHandler);
                    showModal('message-modal');
                });

                if (confirmApply) {
                    templateContentInput.value = enhancedContent;
                }

            } catch (error) {
                console.error("LLM API error (enhance):", error);
                showMessage('LLM 오류', '프롬프트 개선 기능을 사용할 수 없습니다. API 키를 확인하거나 나중에 다시 시도해주세요.', true);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('tag-suggestion-button').addEventListener('click', async () => {
            const title = document.getElementById('template-title').value;
            const content = templateContentInput.value;
            if (!title && !content) {
                showMessage('입력 필요', '제목 또는 내용을 입력해주세요.', true);
                return;
            }
            if (!GEMINI_API_KEY) {
                showMessage('API 키 필요', 'Gemini API 키가 설정되지 않았습니다. 설정에서 API 키를 입력해주세요.', true);
                return;
            }
            showLoading();
            try {
                const payload = {
                    contents: [{ parts: [{ text: `다음 제목과 내용에 가장 적합한 5개 이하의 태그를 JSON 배열 형식으로만 추천해줘. 다른 설명은 필요 없어. 예시: ["마케팅", "광고", "카피라이팅"]\n\n제목: ${title}\n내용: ${content}` }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: { "type": "STRING" }
                        }
                    }
                };
                const response = await fetch(GEMINI_API_URL(GEMINI_API_KEY), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const recommendedTags = JSON.parse(result.candidates[0].content.parts[0].text);
                const currentTags = document.getElementById('template-tags').value.split(',').map(tag => tag.trim()).filter(Boolean);
                const mergedTags = [...new Set([...currentTags, ...recommendedTags])];
                document.getElementById('template-tags').value = mergedTags.join(', ');
                showMessage('태그 추천 완료', 'LLM이 태그를 추천했습니다.');
            } catch (error) {
                console.error("LLM API error (tag suggestion):", error);
                showMessage('LLM 오류', '태그 추천 기능을 사용할 수 없습니다. API 키를 확인하거나 나중에 다시 시도해주세요.', true);
            } finally {
                hideLoading();
            }
        });

        // Live search and insertion for snippets (!! prefix)
        let currentMatchedSnippetPrefix = '';
        let currentHighlightedSnippetIndex = -1;

        templateContentInput.addEventListener('input', (e) => {
            const cursorPosition = e.target.selectionStart;
            const textBeforeCursor = e.target.value.substring(0, cursorPosition);
            const snippetTriggerMatch = textBeforeCursor.match(/(?:^|\s)!!(\S*)$/);

            if (snippetTriggerMatch) {
                currentMatchedSnippetPrefix = snippetTriggerMatch[0];
                const searchTerm = snippetTriggerMatch[1].toLowerCase();
                
                const filteredSnippets = snippets.filter(snippet =>
                    snippet.title.toLowerCase().includes(searchTerm)
                ).slice(0, 5);

                if (filteredSnippets.length > 0) {
                    snippetCompositionMenu.innerHTML = '';
                    filteredSnippets.forEach((snippet, index) => {
                        const div = document.createElement('div');
                        div.className = 'p-2 cursor-pointer hover:bg-prime-blue/20 dark:hover:bg-prime-blue/40 rounded-lg text-sm truncate';
                        div.textContent = snippet.title;
                        div.dataset.snippetContent = snippet.content;
                        div.dataset.index = index;

                        div.addEventListener('click', () => {
                            insertSnippet(snippet.content, currentMatchedSnippetPrefix.length);
                            snippetCompositionMenu.classList.add('hidden');
                            templateContentInput.focus();
                        });
                        snippetCompositionMenu.appendChild(div);
                    });
                    currentHighlightedSnippetIndex = -1;

                    snippetCompositionMenu.classList.remove('hidden');
                } else {
                    snippetCompositionMenu.classList.add('hidden');
                    currentHighlightedSnippetIndex = -1;
                    currentMatchedSnippetPrefix = '';
                }
            } else {
                snippetCompositionMenu.classList.add('hidden');
                currentHighlightedSnippetIndex = -1;
                currentMatchedSnippetPrefix = '';
            }
        });

        // Keyboard navigation for snippet menu
        templateContentInput.addEventListener('keydown', (e) => {
            const items = Array.from(snippetCompositionMenu.children);
            if (snippetCompositionMenu.classList.contains('hidden') || items.length === 0) {
                return;
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (currentHighlightedSnippetIndex !== -1) {
                    items[currentHighlightedSnippetIndex].classList.remove('bg-prime-blue/20', 'dark:bg-prime-blue/40');
                }
                currentHighlightedSnippetIndex = (currentHighlightedSnippetIndex + 1) % items.length;
                items[currentHighlightedSnippetIndex].classList.add('bg-prime-blue/20', 'dark:bg-prime-blue/40');
                items[currentHighlightedSnippetIndex].scrollIntoView({ block: 'nearest', inline: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (currentHighlightedSnippetIndex !== -1) {
                    items[currentHighlightedSnippetIndex].classList.remove('bg-prime-blue/20', 'dark:bg-prime-blue/40');
                }
                currentHighlightedSnippetIndex = (currentHighlightedSnippetIndex - 1 + items.length) % items.length;
                items[currentHighlightedSnippetIndex].classList.add('bg-prime-blue/20', 'dark:bg-prime-blue/40');
                items[currentHighlightedSnippetIndex].scrollIntoView({ block: 'nearest', inline: 'nearest' });
            } else if (e.key === 'Enter') {
                if (currentHighlightedSnippetIndex !== -1) {
                    e.preventDefault();
                    const selectedSnippetContent = items[currentHighlightedSnippetIndex].dataset.snippetContent;
                    insertSnippet(selectedSnippetContent, currentMatchedSnippetPrefix.length);
                    snippetCompositionMenu.classList.add('hidden');
                    currentHighlightedSnippetIndex = -1;
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                snippetCompositionMenu.classList.add('hidden');
                currentHighlightedSnippetIndex = -1;
            }
        });

        function insertSnippet(contentToInsert, matchedPrefixLength) {
            const textarea = templateContentInput;
            const start = textarea.selectionStart;
            const originalText = textarea.value;

            const replacementStart = start - matchedPrefixLength;

            const newText = originalText.substring(0, replacementStart) + contentToInsert + originalText.substring(start);
            textarea.value = newText;
            textarea.selectionStart = textarea.selectionEnd = replacementStart + contentToInsert.length;
            textarea.focus();
        }


        // CRUD Form Submission (Templates & Snippets)
        crudForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = e.target['template-title'].value;
            const description = e.target['template-description'].value;
            const content = e.target['template-content'].value;
            const tags = (currentCrudItemType === 'template' && e.target['template-tags'].value) ? e.target['template-tags'].value.split(',').map(tag => tag.trim()).filter(Boolean) : [];
            const isUpdate = !!currentCrudItemId;

            showLoading();
            try {
                if (currentCrudItemType === 'snippet') {
                    const snippetData = { title, content, updatedAt: new Date(), owner_uid: currentUserId };
                    if (selectedGroupIds.length > 0) {
                        snippetData.groupIds = selectedGroupIds;
                    } else {
                        snippetData.groupIds = []; // Ensure it's an empty array if nothing selected
                    }

                    if (isUpdate) {
                        await updateDoc(doc(db, `users/${currentUserId}/snippets`, currentCrudItemId), snippetData);
                    } else {
                        await addDoc(collection(db, `users/${currentUserId}/snippets`), { ...snippetData, createdAt: new Date() });
                    }
                } else { // Templates
                    const templateData = { title, description, content, tags, updatedAt: new Date(), owner_uid: currentUserId };
                    if (selectedGroupIds.length > 0) {
                        templateData.groupIds = selectedGroupIds;
                    } else {
                        templateData.groupIds = []; // Ensure it's an empty array if nothing selected
                    }

                    if (isUpdate) {
                        const existingTemplate = templates.find(t => t.id === currentCrudItemId);
                        await updateDoc(doc(db, `users/${currentUserId}/templates`, currentCrudItemId), templateData);
                        
                        // Auto-generate version if content, description, tags, or groups changed
                        const oldGroupIds = existingTemplate.groupIds || [];
                        const contentChanged = existingTemplate.content !== content;
                        const descriptionChanged = existingTemplate.description !== description;
                        const tagsChanged = JSON.stringify(existingTemplate.tags) !== JSON.stringify(tags);
                        const groupsChanged = JSON.stringify(oldGroupIds.sort()) !== JSON.stringify(selectedGroupIds.sort());

                        if (existingTemplate && (contentChanged || descriptionChanged || tagsChanged || groupsChanged)) {
                            await addDoc(collection(db, `users/${currentUserId}/templates`, currentCrudItemId, "versions"), {
                                content: existingTemplate.content,
                                title: existingTemplate.title,
                                description: existingTemplate.description || '',
                                tags: existingTemplate.tags || [],
                                groupIds: oldGroupIds, // Store previous group IDs
                                updatedAt: existingTemplate.updatedAt,
                                updatedBy: currentUserId
                            });
                        }
                    } else {
                        await addDoc(collection(db, `users/${currentUserId}/templates`), {
                            ...templateData,
                            createdAt: new Date(),
                            permissions: { [currentUserId]: 'owner' }
                        });
                    }
                }
                showMessage('성공', `성공적으로 ${isUpdate ? '수정' : '생성'}되었습니다!`);
                hideModal('crud-modal');
            } catch (error) {
                console.error("CRUD operation error:", error);
                showMessage('실패', `작업 중 오류가 발생했습니다: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        });

        // Edit button click handler
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-btn')) {
                const card = e.target.closest('.template-card');
                const itemId = card.dataset.id;
                const itemType = card.dataset.type;
                const itemData = (itemType === 'template' ? templates : snippets).find(item => item.id === itemId);
                if (itemData) {
                    currentCrudItemId = itemId;
                    currentCrudItemType = itemType;
                    document.getElementById('crud-modal-title').textContent = itemType === 'template' ? '템플릿 수정' : '상용구 수정';
                    crudForm['template-title'].value = itemData.title;
                    crudForm['template-content'].value = itemData.content;
                    
                    const tagsDiv = document.getElementById('template-tags').closest('div');
                    const tagSuggestionBtn = document.getElementById('tag-suggestion-button');
                    const descriptionDiv = templateDescriptionInput.closest('div');
                    const groupSelectionDiv = document.getElementById('template-group-selection');
                    
                    if (itemType === 'template') {
                        tagsDiv.classList.remove('hidden');
                        tagSuggestionBtn.classList.remove('hidden');
                        descriptionDiv.classList.remove('hidden');
                        groupSelectionDiv.classList.remove('hidden'); // Show group selection for templates
                        crudForm['template-tags'].value = itemData.tags ? itemData.tags.join(', ') : '';
                        templateDescriptionInput.value = itemData.description || '';
                        selectedGroupIds = itemData.groupIds || []; // Load existing group IDs
                    } else {
                        tagsDiv.classList.add('hidden');
                        tagSuggestionBtn.classList.add('hidden');
                        descriptionDiv.classList.add('hidden');
                        groupSelectionDiv.classList.remove('hidden'); // Show group selection for snippets too
                        crudForm['template-tags'].value = '';
                        templateDescriptionInput.value = '';
                        selectedGroupIds = itemData.groupIds || []; // Load existing group IDs for snippets
                    }
                    updateSelectedGroupsDisplay();
                    populateGroupMultiSelect();
                    showModal('crud-modal');
                    templateContentInput.focus();

                    undoStack = [itemData.content];
                    redoStack = [];
                }
            }
        });

        // Delete button click handler
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                const card = e.target.closest('.template-card');
                const itemId = card.dataset.id;
                const itemType = card.dataset.type;
                
                const confirmDelete = await new Promise(resolve => {
                    const confirmModal = document.getElementById('message-modal');
                    confirmModal.querySelector('#message-title').textContent = '삭제 확인';
                    confirmModal.querySelector('#message-content').textContent = '정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.';
                    const okButton = confirmModal.querySelector('#message-ok-button');
                    const originalOkText = okButton.textContent;
                    
                    okButton.textContent = '삭제';
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = '취소';
                    cancelButton.className = 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-6 py-2 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors ml-2';
                    okButton.parentNode.insertBefore(cancelButton, okButton.nextSibling);

                    const clickHandler = (e) => {
                        if (e.target === okButton) {
                            resolve(true);
                        } else if (e.target === cancelButton) {
                            resolve(false);
                        }
                        okButton.removeEventListener('click', clickHandler);
                        cancelButton.removeEventListener('click', clickHandler);
                        cancelButton.remove();
                        okButton.textContent = originalOkText;
                        hideModal('message-modal');
                    };
                    okButton.addEventListener('click', clickHandler);
                    cancelButton.addEventListener('click', clickHandler);
                    showModal('message-modal');
                });

                if (confirmDelete) {
                    showLoading();
                    try {
                        const collectionPath = itemType === 'template' ? `users/${currentUserId}/templates` : `users/${currentUserId}/snippets`;
                        await deleteDoc(doc(db, collectionPath, itemId));
                        showMessage('삭제 완료', '성공적으로 삭제되었습니다.');
                    } catch (error) {
                        console.error("Delete operation error:", error);
                        showMessage('삭제 실패', `삭제 중 오류가 발생했습니다: ${error.message}`, true);
                    } finally {
                        hideLoading();
                    }
                }
            }
        });

        // -----------------------------------------------------------
        // 2.10 그룹 관리 (New Feature)
        // -----------------------------------------------------------
        const groupCrudForm = document.getElementById('group-crud-form');
        let currentGroupCrudId = null;

        // Group CRUD Form Submission
        groupCrudForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = e.target['group-name'].value;
            const groupDescription = e.target['group-description'].value;
            const isUpdate = !!groupCrudModal.dataset.editId; // Check dataset for edit ID

            showLoading();
            try {
                const groupData = { name: groupName, description: groupDescription, updatedAt: new Date(), owner_uid: currentUserId };
                if (isUpdate) {
                    await updateDoc(doc(db, `users/${currentUserId}/groups`, groupCrudModal.dataset.editId), groupData);
                } else {
                    await addDoc(collection(db, `users/${currentUserId}/groups`), { ...groupData, createdAt: new Date() });
                }
                showMessage('성공', `그룹이 성공적으로 ${isUpdate ? '수정' : '생성'}되었습니다!`);
                hideModal('group-crud-modal');
            } catch (error) {
                console.error("Group CRUD operation error:", error);
                showMessage('실패', `그룹 작업 중 오류가 발생했습니다: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        });

        // Edit Group button click handler
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-group-btn')) {
                const card = e.target.closest('.group-card');
                const groupId = card.dataset.id;
                const groupData = groups.find(g => g.id === groupId);
                if (groupData) {
                    groupCrudModal.dataset.editId = groupId; // Set edit ID
                    document.getElementById('group-crud-modal-title').textContent = '그룹 수정';
                    groupCrudForm['group-name'].value = groupData.name;
                    groupCrudForm['group-description'].value = groupData.description || '';
                    showModal('group-crud-modal');
                }
            }
        });

        // Delete Group button click handler
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-group-btn')) {
                const card = e.target.closest('.group-card');
                const groupId = card.dataset.id;
                
                const confirmDelete = await new Promise(resolve => {
                    const confirmModal = document.getElementById('message-modal');
                    confirmModal.querySelector('#message-title').textContent = '그룹 삭제 확인';
                    confirmModal.querySelector('#message-content').textContent = '정말로 이 그룹을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.';
                    const okButton = confirmModal.querySelector('#message-ok-button');
                    const originalOkText = okButton.textContent;
                    
                    okButton.textContent = '삭제';
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = '취소';
                    cancelButton.className = 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-6 py-2 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors ml-2';
                    okButton.parentNode.insertBefore(cancelButton, okButton.nextSibling);

                    const clickHandler = (e) => {
                        if (e.target === okButton) {
                            resolve(true);
                        } else if (e.target === cancelButton) {
                            resolve(false);
                        }
                        okButton.removeEventListener('click', clickHandler);
                        cancelButton.removeEventListener('click', clickHandler);
                        cancelButton.remove();
                        okButton.textContent = originalOkText;
                        hideModal('message-modal');
                    };
                    okButton.addEventListener('click', clickHandler);
                    cancelButton.addEventListener('click', clickHandler);
                    showModal('message-modal');
                });

                if (confirmDelete) {
                    showLoading();
                    try {
                        // Remove group ID from all associated templates/snippets
                        const templatesToUpdate = templates.filter(t => t.groupIds && t.groupIds.includes(groupId));
                        const snippetsToUpdate = snippets.filter(s => s.groupIds && s.groupIds.includes(groupId));

                        const updatePromises = [];
                        templatesToUpdate.forEach(t => {
                            updatePromises.push(updateDoc(doc(db, `users/${currentUserId}/templates`, t.id), {
                                groupIds: arrayRemove(groupId)
                            }));
                        });
                        snippetsToUpdate.forEach(s => {
                            updatePromises.push(updateDoc(doc(db, `users/${currentUserId}/snippets`, s.id), {
                                groupIds: arrayRemove(groupId)
                            }));
                        });
                        await Promise.all(updatePromises);

                        await deleteDoc(doc(db, `users/${currentUserId}/groups`, groupId));
                        showMessage('삭제 완료', '그룹이 성공적으로 삭제되었습니다.');
                    } catch (error) {
                        console.error("Delete group operation error:", error);
                        showMessage('삭제 실패', `그룹 삭제 중 오류가 발생했습니다: ${error.message}`, true);
                    } finally {
                        hideLoading();
                    }
                }
            }
        });


        // -----------------------------------------------------------
        // 2.5 분석 및 최적화 (Analytics & Optimization)
        // 2.7 버전 관리 (Version Control)
        // -----------------------------------------------------------
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.analytics-btn')) {
                const card = e.target.closest('.template-card');
                const templateId = card.dataset.id;
                showLoading();
                try {
                    const versionSnapshot = await getDocs(collection(db, `users/${currentUserId}/templates`, templateId, "versions"));
                    const versionData = versionSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), updatedAt: doc.data().updatedAt.toDate() }));
                    
                    versionData.sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime());

                    const analyticsData = { versions: versionData };
                    window.renderAnalyticsDashboard(analyticsData);
                    
                    const versionList = document.getElementById('version-list');
                    versionList.innerHTML = versionData.map(item => `
                        <li class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold">버전: ${item.updatedAt.toLocaleString()}</span>
                                <div>
                                    <button class="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs px-3 py-1 rounded-full hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors compare-version-btn" data-version-id="${item.id}" data-template-id="${templateId}">비교</button>
                                    <button class="bg-prime-blue text-white text-xs px-3 py-1 rounded-full hover:bg-blue-600 transition-colors restore-version-btn" data-version-id="${item.id}" data-template-id="${templateId}">복원</button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">변경자 UID: ${item.updatedBy}</p>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                ${item.groupIds && item.groupIds.length > 0 ? `그룹: ${item.groupIds.map(id => groups.find(g => g.id === id)?.name || id).join(', ')}` : '그룹 없음'}
                            </div>
                        </li>
                    `).join('');
                    
                    analyticsModal.dataset.templateId = templateId;
                    showModal('analytics-modal');

                } catch (error) {
                    console.error("Analytics fetch error:", error);
                    showMessage('데이터 조회 실패', '분석 데이터를 불러오는 데 실패했습니다.', true);
                } finally {
                    hideLoading();
                }
            }
        });

        // Version Diff Logic
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.compare-version-btn')) {
                const versionId = e.target.closest('.compare-version-btn').dataset.versionId;
                const templateId = e.target.closest('.compare-version-btn').dataset.templateId;
                showLoading();
                try {
                    const currentTemplateDoc = await getDoc(doc(db, `users/${currentUserId}/templates`, templateId));
                    const versionDoc = await getDoc(doc(db, `users/${currentUserId}/templates`, templateId, "versions", versionId));

                    if (currentTemplateDoc.exists() && versionDoc.exists()) {
                        const currentContent = currentTemplateDoc.data().content;
                        const versionContent = versionDoc.data().content;
                        
                        const diffHtml = generateDiffHtml(versionContent, currentContent);
                        document.getElementById('diff-content').innerHTML = diffHtml;
                        diffModal.dataset.versionId = versionId;
                        diffModal.dataset.templateId = templateId;
                        showModal('diff-modal');
                    } else {
                        showMessage('오류', '버전 데이터를 찾을 수 없습니다.', true);
                    }
                } catch (error) {
                    console.error("Diff comparison error:", error);
                    showMessage('비교 실패', `버전 비교 중 오류가 발생했습니다: ${error.message}`, true);
                } finally {
                    hideLoading();
                }
            }
        });

        // Restore from Diff Modal Button
        document.getElementById('restore-from-diff-button').addEventListener('click', async () => {
            const versionId = diffModal.dataset.versionId;
            const templateId = diffModal.dataset.templateId;
            if (versionId && templateId) {
                const restoreBtn = document.querySelector(`.restore-version-btn[data-version-id="${versionId}"][data-template-id="${templateId}"]`);
                if (restoreBtn) {
                    hideModal('diff-modal');
                    restoreBtn.click();
                }
            }
        });


        // Version restore logic
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.restore-version-btn')) {
                const versionId = e.target.closest('.restore-version-btn').dataset.versionId;
                const templateId = e.target.closest('.restore-version-btn').dataset.templateId;
                
                const confirmRestore = await new Promise(resolve => {
                    const confirmModal = document.getElementById('message-modal');
                    confirmModal.querySelector('#message-title').textContent = '버전 복원 확인';
                    confirmModal.querySelector('#message-content').textContent = '정말로 이 버전으로 복원하시겠습니까? 현재 내용은 덮어쓰여집니다.';
                    const okButton = confirmModal.querySelector('#message-ok-button');
                    const originalOkText = okButton.textContent;
                    
                    okButton.textContent = '복원';
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = '취소';
                    cancelButton.className = 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-6 py-2 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors ml-2';
                    okButton.parentNode.insertBefore(cancelButton, okButton.nextSibling);

                    const clickHandler = (e) => {
                        if (e.target === okButton) {
                            resolve(true);
                        } else if (e.target === cancelButton) {
                            resolve(false);
                        }
                        okButton.removeEventListener('click', clickHandler);
                        cancelButton.removeEventListener('click', clickHandler);
                        cancelButton.remove();
                        okButton.textContent = originalOkText;
                        hideModal('message-modal');
                    };
                    okButton.addEventListener('click', clickHandler);
                    cancelButton.addEventListener('click', clickHandler);
                    showModal('message-modal');
                });

                if (confirmRestore) {
                    showLoading();
                    try {
                        const versionDoc = await getDoc(doc(db, `users/${currentUserId}/templates`, templateId, "versions", versionId));
                        if (versionDoc.exists()) {
                            const versionData = versionDoc.data();
                            await updateDoc(doc(db, `users/${currentUserId}/templates`, templateId), {
                                content: versionData.content,
                                title: versionData.title,
                                description: versionData.description || '',
                                tags: versionData.tags || [],
                                groupIds: versionData.groupIds || [], // Restore group IDs
                                updatedAt: new Date()
                            });
                            showMessage('복원 성공', '선택된 버전으로 템플릿이 복원되었습니다.');
                            hideModal('analytics-modal');
                        } else {
                            showMessage('오류', '버전 데이터를 찾을 수 없습니다.', true);
                        }
                    } catch (error) {
                        console.error("Version restore error:", error);
                        showMessage('복원 실패', `복원 중 오류가 발생했습니다: ${error.message}`, true);
                    } finally {
                        hideLoading();
                    }
                }
            }
        });
        
        // Tab switching logic for Analytics Modal
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-button').forEach(tabBtn => {
                    tabBtn.classList.remove('border-prime-blue', 'text-prime-blue', 'bg-gray-100', 'dark:bg-gray-800');
                    tabBtn.classList.add('border-transparent', 'text-gray-600', 'dark:text-gray-400');
                });
                e.target.classList.add('border-prime-blue', 'text-prime-blue');
                if (document.documentElement.classList.contains('dark')) {
                    e.target.classList.add('dark:bg-gray-800');
                } else {
                    e.target.classList.add('bg-gray-100');
                }

                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`${e.target.dataset.tab}-tab-content`).classList.remove('hidden');
            });
        });

        // -----------------------------------------------------------
        // 2.6 협업 및 공유 (Collaboration & Sharing)
        // -----------------------------------------------------------
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.share-btn')) {
                const card = e.target.closest('.template-card');
                const templateId = card.dataset.id;
                const templateDoc = await getDoc(doc(db, `users/${currentUserId}/templates`, templateId)); // Fetch from owner's collection
                const templateData = templateDoc.data();
                
                const collaboratorList = document.getElementById('collaborator-list');
                collaboratorList.innerHTML = '';
                
                if (templateData.permissions) {
                    const permissionEntries = Object.entries(templateData.permissions);
                    for (const [uid, role] of permissionEntries) {
                        const userDoc = await getDoc(doc(db, "users", uid));
                        const userData = userDoc.exists() ? userDoc.data() : { email: `UID: ${uid}` };
                        
                        collaboratorList.insertAdjacentHTML('beforeend', `
                            <li class="flex items-center justify-between p-2 rounded-xl bg-gray-50 dark:bg-gray-800">
                                <div class="flex-1">
                                    <span class="font-medium">${userData.email || userData.displayName || `UID: ${uid}`}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">(${role === 'owner' ? '소유자' : role === 'editor' ? '편집자' : '뷰어'})</span>
                                </div>
                                ${role !== 'owner' ? `<button class="text-red-500 hover:text-red-700 remove-collaborator" data-uid="${uid}">삭제</button>` : ''}
                            </li>
                        `);
                    }
                }

                shareModal.dataset.templateId = templateId;
                showModal('share-modal');
            }
        });

        document.getElementById('share-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target['share-email'].value;
            const permission = e.target['share-permission'].value;
            const templateId = shareModal.dataset.templateId;
            showLoading();
            try {
                // Find user UID by email
                const userQuery = query(collection(db, "users"), where("email", "==", email));
                const userSnapshot = await getDocs(userQuery);
                if (userSnapshot.empty) {
                    showMessage('사용자 없음', '해당 이메일의 사용자를 찾을 수 없습니다. 사용자 이메일이 정확한지 확인해주세요.', true);
                    hideLoading();
                    return;
                }
                const invitedUid = userSnapshot.docs[0].id;

                if (invitedUid === currentUserId) {
                    showMessage('오류', '자기 자신에게는 권한을 공유할 수 없습니다.', true);
                    hideLoading();
                    return;
                }
                
                const templateRef = doc(db, `users/${currentUserId}/templates`, templateId); // Update owner's template
                await updateDoc(templateRef, {
                    [`permissions.${invitedUid}`]: permission,
                    sharedWith: arrayUnion(invitedUid) // Add to sharedWith array for efficient querying
                });
                showMessage('공유 성공', '사용자가 초대되었습니다!');
                hideModal('share-modal');
                setTimeout(() => document.querySelector('.share-btn[data-id="' + templateId + '"]').click(), 100);

            } catch (error) {
                console.error("Sharing error:", error);
                showMessage('공유 실패', `공유 중 오류가 발생했습니다: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        });

        document.addEventListener('click', async (e) => {
            if (e.target.closest('.remove-collaborator')) {
                const uidToRemove = e.target.closest('.remove-collaborator').dataset.uid;
                const templateId = shareModal.dataset.templateId;
                
                const confirmRemove = await new Promise(resolve => {
                    const confirmModal = document.getElementById('message-modal');
                    confirmModal.querySelector('#message-title').textContent = '협업자 삭제 확인';
                    confirmModal.querySelector('#message-content').textContent = '정말로 이 협업자를 목록에서 삭제하시겠습니까?';
                    const okButton = confirmModal.querySelector('#message-ok-button');
                    const originalOkText = okButton.textContent;
                    
                    okButton.textContent = '삭제';
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = '취소';
                    cancelButton.className = 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-6 py-2 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors ml-2';
                    okButton.parentNode.insertBefore(cancelButton, okButton.nextSibling);

                    const clickHandler = (e) => {
                        if (e.target === okButton) {
                            resolve(true);
                        } else if (e.target === cancelButton) {
                            resolve(false);
                        }
                        okButton.removeEventListener('click', clickHandler);
                        cancelButton.removeEventListener('click', clickHandler);
                        cancelButton.remove();
                        okButton.textContent = originalOkText;
                        hideModal('message-modal');
                    };
                    okButton.addEventListener('click', clickHandler);
                    cancelButton.addEventListener('click', clickHandler);
                    showModal('message-modal');
                });


                if (confirmRemove) {
                    showLoading();
                    try {
                        const templateRef = doc(db, `users/${currentUserId}/templates`, templateId);
                        // Use FieldValue.delete() to remove the specific key from the map
                        const updates = {};
                        updates[`permissions.${uidToRemove}`] = null; // Firestore's way to delete a field
                        
                        await updateDoc(templateRef, {
                            ...updates,
                            sharedWith: arrayRemove(uidToRemove) // Remove from sharedWith array
                        });
                        showMessage('삭제 완료', '협업자가 목록에서 제거되었습니다.');
                        hideModal('share-modal');
                        setTimeout(() => document.querySelector('.share-btn[data-id="' + templateId + '"]').click(), 100);
                    } catch (error) {
                        console.error("Remove collaborator error:", error);
                        showMessage('삭제 실패', `삭제 중 오류가 발생했습니다: ${error.message}`, true);
                    } finally {
                        hideLoading();
                    }
                }
            }
        });

        // -----------------------------------------------------------
        // 2.8 데이터 관리 (Data Management)
        // -----------------------------------------------------------
        document.getElementById('nav-export-data').addEventListener('click', async () => {
            showLoading();
            try {
                if (!currentUserId) {
                    showMessage('오류', '로그인 상태가 아닙니다. 데이터를 내보낼 수 없습니다.', true);
                    hideLoading();
                    return;
                }
                const myTemplatesSnapshot = await getDocs(query(collection(db, `users/${currentUserId}/templates`)));
                const mySnippetsSnapshot = await getDocs(query(collection(db, `users/${currentUserId}/snippets`)));
                const myGroupsSnapshot = await getDocs(query(collection(db, `users/${currentUserId}/groups`))); // Export groups too
                
                const myTemplates = myTemplatesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const mySnippets = mySnippetsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const myGroups = myGroupsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const exportData = {
                    templates: myTemplates,
                    snippets: mySnippets,
                    groups: myGroups, // Include groups in export
                    exportedAt: new Date().toISOString(),
                    exportedBy: currentUser.email || currentUser.uid
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Project_PRIME_Data_Export_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('내보내기 완료', '소유한 모든 데이터가 JSON 파일로 다운로드되었습니다.');
            } catch (error) {
                console.error("Export error:", error);
                showMessage('내보내기 실패', `데이터 내보내기 중 오류가 발생했습니다: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        });

        // Initialize Feather Icons at the end
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
        });
    </script>
</body>

</html>
