<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenith Translator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* Theme Variables - Classic Minimalist */
        :root {
            /* Dark Mode (Default) */
            --bg-base: #09090b;      /* Zinc 950 */
            --bg-surface: #18181b;   /* Zinc 900 */
            --bg-hover: #27272a;     /* Zinc 800 */
            --border-color: #27272a; /* Zinc 800 */
            
            --text-primary: #f4f4f5; /* Zinc 100 */
            --text-secondary: #a1a1aa; /* Zinc 400 */
            --text-tertiary: #52525b;  /* Zinc 600 */
            
            --accent-color: #fff;    /* White Accent in Dark Mode */
            --accent-text: #000;
            
            --status-translating: #38bdf8; /* Sky 400 */
            --status-completed: #4ade80;   /* Green 400 */
            --status-error: #fb7185;       /* Rose 400 */
        }

        [data-theme="light"] {
            /* Light Mode - Classic Swiss Style */
            --bg-base: #ffffff;
            --bg-surface: #f8fafc;   /* Slate 50 */
            --bg-hover: #f1f5f9;     /* Slate 100 */
            --border-color: #e2e8f0; /* Slate 200 */
            
            --text-primary: #0f172a; /* Slate 900 */
            --text-secondary: #64748b; /* Slate 500 */
            --text-tertiary: #94a3b8;  /* Slate 400 */
            
            --accent-color: #0f172a; /* Slate 900 */
            --accent-text: #fff;
            
            --status-translating: #0ea5e9; /* Sky 500 */
            --status-completed: #22c55e;   /* Green 500 */
            --status-error: #f43f5e;       /* Rose 500 */
        }

        body {
            background-color: var(--bg-base);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        /* Utility Classes */
        .bg-base { background-color: var(--bg-base); }
        .bg-surface { background-color: var(--bg-surface); }
        .bg-hover:hover { background-color: var(--bg-hover); }
        .border-classic { border-color: var(--border-color); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }

        /* Solid UI Elements */
        .panel {
            background-color: var(--bg-base);
            border: 1px solid var(--border-color);
        }
        
        .panel-surface {
            background-color: var(--bg-surface);
            border-right: 1px solid var(--border-color);
        }

        .input-classic {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .input-classic:focus {
            border-color: var(--text-secondary);
            outline: none;
        }

        .btn-classic {
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 500;
            transition: all 0.15s ease;
        }
        .btn-classic:hover:not(:disabled) {
            background-color: var(--bg-hover);
            border-color: var(--text-secondary);
        }
        .btn-classic:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: var(--accent-text);
            border: 1px solid var(--accent-color);
            font-weight: 600;
        }
        .btn-accent:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-accent:disabled {
            opacity: 0.5;
            transform: none;
            cursor: not-allowed;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border: 2px solid var(--bg-base); /* Creates padding effect */
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        .editor-font {
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.6;
        }

        /* Animations */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in-up 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useReducer, useRef, useMemo, useContext, createContext } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 16, className = "" }) => {
            return <i className={`bi bi-${name} ${className}`} style={{ fontSize: size }}></i>;
        };

        // --- EXPORT/IMPORT LOGIC ---
        const ProjectUtils = {
            // Save Project State (Native JSON)
            saveProject: (fileTree, name) => {
                const projectData = {
                    version: '1.0',
                    timestamp: Date.now(),
                    name: name,
                    tree: fileTree
                };
                const blob = new Blob([JSON.stringify(projectData)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name.replace(/\.[^/.]+$/, "")}.zenith`;
                a.click();
                URL.revokeObjectURL(url);
            },

            // Export Result (ZIP)
            exportZip: async (rootNode) => {
                const zip = new JSZip();
                const addToZip = (folder, node) => {
                    if (node.isFolder) {
                        const newFolder = folder.folder(node.name);
                        node.children.forEach(child => addToZip(newFolder, child));
                    } else {
                        const contentToSave = node.translation || node.content;
                        if (contentToSave !== null) folder.file(node.name, contentToSave);
                    }
                };
                rootNode.children.forEach(child => addToZip(zip, child));
                return await zip.generateAsync({ type: "blob" });
            },
            
            // Export Result (EPUB) - Same logic as before
            exportEpub: async (rootNode, title) => {
                 const zip = new JSZip();
                const uuid = "urn:uuid:" + Math.random().toString(36).substring(2);
                const textNodes = [];
                const traverse = (node) => {
                    if (node.isFolder) node.children.forEach(traverse);
                    else if (node.isTranslatable && (node.translation || node.content)) textNodes.push(node);
                };
                traverse(rootNode);
                if (textNodes.length === 0) throw new Error("No text content found.");

                zip.file("mimetype", "application/epub+zip", { compression: "STORE" });
                zip.folder("META-INF").file("container.xml", `<?xml version="1.0" encoding="UTF-8" ?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);
                
                const oebps = zip.folder("OEBPS");
                const textFolder = oebps.folder("Text");
                let manifestItems = "", spineItems = "", navPoints = "";

                textNodes.forEach((node, index) => {
                    const fileId = `file_${index}`;
                    const fileName = `Text/${fileId}.xhtml`;
                    const content = (node.translation || node.content || "").replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').split('\n').map(l => `<p>${l}</p>`).join('');
                    textFolder.file(`${fileId}.xhtml`, `<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>${node.name}</title></head><body><h1>${node.name}</h1>${content}</body></html>`);
                    manifestItems += `<item id="${fileId}" href="${fileName}" media-type="application/xhtml+xml"/>\n`;
                    spineItems += `<itemref idref="${fileId}"/>\n`;
                    navPoints += `<navPoint id="navPoint-${index}" playOrder="${index + 1}"><navLabel><text>${node.name}</text></navLabel><content src="${fileName}"/></navPoint>\n`;
                });

                oebps.file("content.opf", `<?xml version="1.0" encoding="UTF-8"?><package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="2.0"><metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf"><dc:title>${title}</dc:title><dc:language>ko</dc:language><dc:identifier id="BookId" opf:scheme="UUID">${uuid}</dc:identifier><dc:creator>Zenith</dc:creator></metadata><manifest><item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>${manifestItems}</manifest><spine toc="ncx">${spineItems}</spine></package>`);
                oebps.file("toc.ncx", `<?xml version="1.0" encoding="UTF-8"?><ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1"><head><meta name="dtb:uid" content="${uuid}"/></head><docTitle><text>${title}</text></docTitle><navMap>${navPoints}</navMap></ncx>`);
                return await zip.generateAsync({ type: "blob" });
            }
        };

        // --- SERVICE LAYER ---
        class GeminiService {
            constructor(apiKeys, config = {}) {
                this.apiKeys = apiKeys.map(k => ({ key: typeof k === 'string' ? k : k.key, status: 'ready', lastUsed: 0 }));
                this.config = { textModel: config.textModel || 'gemini-2.5-flash', maxRetries: 3, ...config };
            }
            _getRateLimit() { return this.config.textModel.includes('pro') ? 30000 : 4000; }
            async _fetchWithBackoff(url, options, retries = 3, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) return response;
                    if (response.status >= 500 && retries > 0) throw new Error(`Server error ${response.status}`);
                    return response;
                } catch (error) {
                    if (retries > 0) { await new Promise(r => setTimeout(r, delay)); return this._fetchWithBackoff(url, options, retries - 1, delay * 2); }
                    throw error;
                }
            }
            async _callApiWithKey(prompt, systemPrompt, keyObj) {
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${this.config.textModel}:generateContent?key=${keyObj.key}`;
                try {
                    const response = await this._fetchWithBackoff(endpoint, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined })
                    }, this.config.maxRetries);
                    if (response.status === 429) return { success: false, status: 429, error: "Rate limit exceeded" };
                    if (!response.ok) return { success: false, status: response.status, error: await response.text() };
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    return text ? { success: true, text, usedKey: keyObj.key } : { success: false, error: 'No content' };
                } catch (e) { return { success: false, error: e.message }; }
            }
            
            // Added back the missing callApi method
            async callApi(prompt, systemPrompt) {
                const rateLimit = this._getRateLimit();
                // Pick the key used least recently
                const keyObj = this.apiKeys.sort((a, b) => a.lastUsed - b.lastUsed)[0];
                
                if (!keyObj) return { success: false, error: "No API keys configured" };

                const now = Date.now();
                const timeSinceLast = now - keyObj.lastUsed;
                
                // Enforce rate limit for single calls too
                if (timeSinceLast < rateLimit) {
                    await new Promise(r => setTimeout(r, rateLimit - timeSinceLast));
                }

                keyObj.lastUsed = Date.now();
                return await this._callApiWithKey(prompt, systemPrompt, keyObj);
            }

            async processBatch(items, systemPrompt, callbacks) {
                const queue = [...items];
                const rateLimit = this._getRateLimit();
                const runWorker = async (keyObj) => {
                    while (queue.length > 0) {
                        const now = Date.now();
                        if (now - keyObj.lastUsed < rateLimit) await new Promise(r => setTimeout(r, rateLimit - (now - keyObj.lastUsed)));
                        if (queue.length === 0) break;
                        const item = queue.shift();
                        keyObj.lastUsed = Date.now();
                        callbacks.onStart(item.id);
                        const result = await this._callApiWithKey(item.content, systemPrompt, keyObj);
                        if (result.status === 429) { queue.push(item); await new Promise(r => setTimeout(r, rateLimit * 2)); }
                        else callbacks.onComplete(item.id, result);
                        callbacks.onProgress();
                    }
                };
                await Promise.all(this.apiKeys.map(key => runWorker(key)));
            }
        }

        // --- COMPONENTS ---

        const Dashboard = ({ onNewProject, onLoadProject }) => {
            const fileInputRef = useRef(null);
            
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const projectData = JSON.parse(event.target.result);
                        if (!projectData.tree) throw new Error("Invalid project file");
                        onLoadProject(projectData);
                    } catch (err) {
                        alert("프로젝트 파일 로드 실패: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="flex flex-col items-center justify-center h-screen w-full bg-base animate-fade-in p-8">
                    <div className="max-w-2xl w-full text-center mb-12">
                        <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-surface border-classic mb-6">
                            <Icon name="translate" className="text-3xl text-primary" />
                        </div>
                        <h1 className="text-4xl font-bold tracking-tight mb-4 text-primary">Zenith Translator</h1>
                        <p className="text-secondary text-lg">
                            Professional localization tool. Simple, fast, and timeless.
                        </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                        {/* Card 1: New Project */}
                        <div className="panel p-8 rounded-xl hover:border-gray-400 transition-colors cursor-default">
                            <Icon name="folder-plus" className="text-3xl mb-4 text-primary" />
                            <h3 className="text-xl font-semibold mb-2 text-primary">New Project</h3>
                            <p className="text-tertiary mb-6 text-sm">Start a new localization project from a ZIP file.</p>
                            <label className="btn-accent w-full py-3 rounded-lg flex items-center justify-center gap-2 cursor-pointer transition-transform active:scale-95">
                                <span>Select ZIP File</span>
                                <input type="file" className="hidden" accept=".zip" onChange={onNewProject} />
                            </label>
                        </div>

                        {/* Card 2: Load Project */}
                        <div className="panel p-8 rounded-xl hover:border-gray-400 transition-colors cursor-default">
                            <Icon name="upload" className="text-3xl mb-4 text-primary" />
                            <h3 className="text-xl font-semibold mb-2 text-primary">Import Project</h3>
                            <p className="text-tertiary mb-6 text-sm">Resume work from a saved .zenith file.</p>
                            <label className="btn-classic w-full py-3 rounded-lg flex items-center justify-center gap-2 cursor-pointer transition-transform active:scale-95">
                                <span>Load .zenith File</span>
                                <input type="file" className="hidden" accept=".zenith,.json" onChange={handleFileChange} />
                            </label>
                        </div>
                    </div>
                    
                    <div className="mt-12 text-tertiary text-xs">
                        v2.0.0 Classic Edition • Secure Local Processing
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, settings, onSave }) => {
            const [localSettings, setLocalSettings] = useState(settings);
            useEffect(() => { setLocalSettings(settings); }, [settings]);
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                    <div className="panel p-6 rounded-xl w-[500px] shadow-2xl animate-fade-in">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-lg font-semibold flex items-center gap-2">
                                <Icon name="sliders" /> Settings
                            </h2>
                            <button onClick={onClose} className="text-tertiary hover:text-primary"><Icon name="x-lg" /></button>
                        </div>
                        <div className="space-y-5">
                            <div>
                                <label className="block text-xs font-bold uppercase tracking-wider mb-2 text-tertiary">API Keys</label>
                                <input type="text" className="input-classic w-full px-3 py-2 rounded-lg text-sm" value={localSettings.apiKeys.join(',')} onChange={e => setLocalSettings({...localSettings, apiKeys: e.target.value.split(',').map(k=>k.trim())})} placeholder="Paste Gemini API Keys..." />
                            </div>
                            <div>
                                <label className="block text-xs font-bold uppercase tracking-wider mb-2 text-tertiary">Model</label>
                                <div className="relative">
                                    <select className="input-classic w-full px-3 py-2 rounded-lg text-sm appearance-none" value={localSettings.modelId} onChange={e => setLocalSettings({...localSettings, modelId: e.target.value})}>
                                        <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash (Latest)</option>
                                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Stable)</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (High Quality)</option>
                                    </select>
                                    <Icon name="chevron-down" className="absolute right-3 top-1/2 -translate-y-1/2 text-tertiary pointer-events-none" size={12} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold uppercase tracking-wider mb-2 text-tertiary">System Prompt</label>
                                <textarea className="input-classic w-full px-3 py-2 rounded-lg h-24 editor-font text-sm resize-none" value={localSettings.systemPrompt} onChange={e => setLocalSettings({...localSettings, systemPrompt: e.target.value})} />
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 mt-8">
                            <button onClick={onClose} className="btn-classic px-4 py-2 rounded-lg text-sm">Cancel</button>
                            <button onClick={() => { onSave(localSettings); onClose(); }} className="btn-accent px-4 py-2 rounded-lg text-sm">Save Changes</button>
                        </div>
                    </div>
                </div>
            );
        };

        const FileTreeItem = ({ node, level, onSelect, selectedId }) => {
            const [isOpen, setIsOpen] = useState(true);
            const isSelected = selectedId === node.id;
            
            let statusDot = null;
            if (!node.isFolder && node.isTranslatable) {
                const color = node.status === 'translating' ? 'var(--status-translating)' : 
                              node.status === 'completed' ? 'var(--status-completed)' :
                              node.status === 'error' ? 'var(--status-error)' : 'var(--text-tertiary)';
                statusDot = <span className="w-1.5 h-1.5 rounded-full ml-auto" style={{ backgroundColor: color }}></span>;
            }

            return (
                <div className="select-none text-sm font-medium">
                    <div 
                        className={`flex items-center py-1.5 px-3 cursor-pointer transition-colors border-l-2
                            ${isSelected 
                                ? 'bg-hover border-primary text-primary' 
                                : 'border-transparent text-secondary hover:text-primary hover:bg-hover'}`}
                        style={{ paddingLeft: `${level * 16 + 12}px`, borderColor: isSelected ? 'var(--text-primary)' : 'transparent' }}
                        onClick={() => { if (node.isFolder) setIsOpen(!isOpen); else onSelect(node); }}
                    >
                        <span className={`mr-2 ${isSelected ? 'text-primary' : 'text-tertiary'}`}>
                            <Icon name={node.isFolder ? (isOpen ? "folder2-open" : "folder2") : "file-earmark-text"} size={14} />
                        </span>
                        <span className="truncate">{node.name}</span>
                        {statusDot}
                    </div>
                    {node.isFolder && isOpen && (
                        <div>{node.children.map(child => <FileTreeItem key={child.id} node={child} level={level + 1} onSelect={onSelect} selectedId={selectedId} />)}</div>
                    )}
                </div>
            );
        };

        const App = () => {
            // View State: 'dashboard' | 'workspace'
            const [view, setView] = useState('dashboard');
            
            // Project State
            const [project, setProject] = useState(null); // { name, tree }
            const [selectedNodeId, setSelectedNodeId] = useState(null);
            
            const [settings, setSettings] = useState({ apiKeys: [], modelId: 'gemini-2.5-flash', systemPrompt: "Translate programming comments and strings to Korean. Keep code logic intact." });
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState({ current: 0, total: 0 });
            const [theme, setTheme] = useState('dark');

            // Theme Effect
            useEffect(() => { document.documentElement.setAttribute('data-theme', theme); }, [theme]);

            // Utils
            const generateId = () => Math.random().toString(36).substr(2, 9);
            const isTranslatableTarget = (name) => !['png','jpg','jpeg','gif','zip','exe','pdf','mp4'].includes(name.split('.').pop().toLowerCase());

            const geminiService = useMemo(() => new GeminiService(settings.apiKeys, { textModel: settings.modelId }), [settings.apiKeys, settings.modelId]);

            // Tree Helpers
            const updateNode = (root, id, updater) => {
                if (root.id === id) return updater(root);
                if (root.children) return { ...root, children: root.children.map(c => updateNode(c, id, updater)) };
                return root;
            };
            const findNode = (root, id) => {
                if (root.id === id) return root;
                if (root.children) { for (let c of root.children) { const found = findNode(c, id); if (found) return found; } }
                return null;
            };
            const getTranslatableNodes = (root) => {
                let nodes = [];
                const traverse = (n) => {
                    if (!n.isFolder && n.isTranslatable && !n.translation) nodes.push(n);
                    if (n.children) n.children.forEach(traverse);
                };
                traverse(root);
                return nodes;
            };

            // Handlers
            const handleNewProject = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const zip = new JSZip();
                    const content = await zip.loadAsync(file);
                    const root = { id: 'root', name: file.name, isFolder: true, children: [] };
                    
                    for (const [path, entry] of Object.entries(content.files)) {
                        if (entry.dir) continue;
                        const parts = path.split('/');
                        const fileName = parts.pop();
                        let current = root.children;
                        parts.forEach(part => {
                            let folder = current.find(n => n.name === part && n.isFolder);
                            if (!folder) { folder = { id: generateId(), name: part, isFolder: true, children: [] }; current.push(folder); }
                            current = folder.children;
                        });
                        const isTranslatable = isTranslatableTarget(fileName);
                        let textContent = null;
                        if (isTranslatable) textContent = await entry.async('string');
                        current.push({ id: generateId(), name: fileName, isFolder: false, isTranslatable, content: textContent, translation: null, status: 'idle' });
                    }
                    setProject({ name: file.name, tree: root });
                    setView('workspace');
                } catch (e) { alert("Error: " + e.message); }
            };

            const handleLoadProject = (loadedData) => {
                setProject({ name: loadedData.name, tree: loadedData.tree });
                setView('workspace');
            };

            const handleSaveProject = () => {
                if (!project) return;
                ProjectUtils.saveProject(project.tree, project.name);
            };

            const handleExportFile = async (type) => {
                if (!project) return;
                const blob = type === 'zip' ? await ProjectUtils.exportZip(project.tree) : await ProjectUtils.exportEpub(project.tree, project.name);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${project.name.replace('.zip','')}_translated.${type}`;
                a.click();
            };

            const handleTranslateAll = async () => {
                if (!settings.apiKeys.length || !settings.apiKeys[0]) { setIsSettingsOpen(true); return; }
                const nodes = getTranslatableNodes(project.tree);
                if (!nodes.length) return alert("Nothing to translate.");
                
                setIsProcessing(true);
                setProgress({ current: 0, total: nodes.length });
                let currentTree = project.tree;
                
                // Helper to batch update state to avoid too many re-renders
                const safeUpdate = (id, updater) => {
                    currentTree = updateNode(currentTree, id, updater);
                    setProject(prev => ({ ...prev, tree: currentTree }));
                };

                await geminiService.processBatch(nodes, settings.systemPrompt, {
                    onStart: (id) => safeUpdate(id, n => ({ ...n, status: 'translating' })),
                    onComplete: (id, res) => {
                        if (res.success) safeUpdate(id, n => ({ ...n, status: 'completed', translation: res.text }));
                        else safeUpdate(id, n => ({ ...n, status: 'error' }));
                        setProgress(p => ({ ...p, current: p.current + 1 }));
                    },
                    onProgress: () => {}
                });
                setIsProcessing(false);
            };

            const handleSingleTranslate = async (id) => {
                if (!settings.apiKeys.length) { setIsSettingsOpen(true); return; }
                const node = findNode(project.tree, id);
                setProject(p => ({ ...p, tree: updateNode(p.tree, id, n => ({ ...n, status: 'translating' })) }));
                const res = await geminiService.callApi(node.content, settings.systemPrompt);
                if (res.success) setProject(p => ({ ...p, tree: updateNode(p.tree, id, n => ({ ...n, status: 'completed', translation: res.text })) }));
                else setProject(p => ({ ...p, tree: updateNode(p.tree, id, n => ({ ...n, status: 'error' })) }));
            };

            const selectedNode = useMemo(() => project ? findNode(project.tree, selectedNodeId) : null, [project, selectedNodeId]);

            // --- VIEW RENDER ---
            if (view === 'dashboard') {
                return <Dashboard onNewProject={handleNewProject} onLoadProject={handleLoadProject} />;
            }

            return (
                <div className="flex h-screen w-screen bg-base text-primary">
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} settings={settings} onSave={setSettings} />
                    
                    {/* Sidebar */}
                    <div className="w-[300px] flex-shrink-0 panel-surface flex flex-col z-20">
                        {/* Header */}
                        <div className="h-14 flex items-center justify-between px-4 border-b border-classic bg-base">
                            <div className="flex items-center gap-2 font-bold text-lg cursor-pointer" onClick={() => setView('dashboard')}>
                                <Icon name="arrow-left" className="text-secondary hover:text-primary" />
                                <span>{project.name.length > 15 ? project.name.substr(0,15)+'...' : project.name}</span>
                            </div>
                            <div className="flex gap-1">
                                <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2 rounded hover:bg-hover text-secondary hover:text-primary"><Icon name={theme === 'dark' ? 'sun' : 'moon'} /></button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 rounded hover:bg-hover text-secondary hover:text-primary"><Icon name="sliders" /></button>
                            </div>
                        </div>

                        {/* File Tree */}
                        <div className="flex-1 overflow-y-auto py-2">
                            <FileTreeItem node={project.tree} level={0} onSelect={n => setSelectedNodeId(n.id)} selectedId={selectedNodeId} />
                        </div>

                        {/* Actions */}
                        <div className="p-4 border-t border-classic bg-base space-y-3">
                            <button onClick={handleTranslateAll} disabled={isProcessing} className="btn-accent w-full py-2.5 rounded-lg flex items-center justify-center gap-2 text-sm shadow-sm">
                                {isProcessing ? <><Icon name="arrow-repeat" className="animate-spin" /> {Math.round((progress.current/progress.total)*100)}%</> : <><Icon name="lightning-charge-fill" /> Translate All</>}
                            </button>
                            <div className="grid grid-cols-3 gap-2">
                                <button onClick={handleSaveProject} className="btn-classic py-2 rounded-lg text-xs flex flex-col items-center justify-center gap-1" title="Save Project State">
                                    <Icon name="save" /> Save
                                </button>
                                <button onClick={() => handleExportFile('zip')} className="btn-classic py-2 rounded-lg text-xs flex flex-col items-center justify-center gap-1" title="Export ZIP">
                                    <Icon name="file-zip" /> ZIP
                                </button>
                                <button onClick={() => handleExportFile('epub')} className="btn-classic py-2 rounded-lg text-xs flex flex-col items-center justify-center gap-1" title="Export EPUB">
                                    <Icon name="book" /> EPUB
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Workspace */}
                    <div className="flex-1 flex flex-col bg-base relative">
                        {selectedNode && selectedNode.isTranslatable ? (
                            <>
                                <div className="h-14 border-b border-classic flex items-center justify-between px-6 bg-base">
                                    <span className="font-mono text-sm text-secondary flex items-center gap-2">
                                        <Icon name="file-earmark-code" /> {selectedNode.name}
                                    </span>
                                    <span className={`text-xs px-2 py-1 rounded font-medium border ${
                                        selectedNode.status === 'completed' ? 'border-green-900 text-green-500 bg-green-900/10' :
                                        selectedNode.status === 'translating' ? 'border-sky-900 text-sky-500 bg-sky-900/10' :
                                        'border-classic text-tertiary'
                                    }`}>
                                        {selectedNode.status.toUpperCase()}
                                    </span>
                                </div>
                                <div className="flex-1 flex overflow-hidden">
                                    <div className="flex-1 flex flex-col border-r border-classic">
                                        <div className="px-4 py-2 text-xs font-bold text-tertiary bg-surface border-b border-classic uppercase">Original</div>
                                        <textarea className="flex-1 w-full bg-base p-6 resize-none outline-none editor-font text-sm text-secondary" value={selectedNode.content || ""} readOnly />
                                    </div>
                                    <div className="flex-1 flex flex-col">
                                        <div className="px-4 py-2 text-xs font-bold text-primary bg-surface border-b border-classic uppercase flex justify-between items-center">
                                            <span>Translation</span>
                                            <button onClick={() => handleSingleTranslate(selectedNode.id)} className="text-primary hover:text-blue-400"><Icon name="arrow-clockwise" /></button>
                                        </div>
                                        <textarea 
                                            className="flex-1 w-full bg-base p-6 resize-none outline-none editor-font text-sm text-primary" 
                                            value={selectedNode.translation || ""} 
                                            onChange={e => setProject(p => ({...p, tree: updateNode(p.tree, selectedNode.id, n => ({...n, translation: e.target.value}))}))}
                                            placeholder="Translation will appear here..."
                                        />
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-tertiary">
                                <Icon name="grid-1x2" className="text-6xl mb-4 opacity-20" />
                                <p>Select a file to translate</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
