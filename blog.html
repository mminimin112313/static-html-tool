<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>콘텐츠 허브 | v2.1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 외부 라이브러리: JSZip (ZIP 처리), Marked (Markdown 렌더링) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /*
            DESIGN SYSTEM DEFINITION
            - Typography: Poppins
            - Spacing Unit: 8px
            - Corner Radius: 8px (md), 12px (lg)
        */

        :root {
            --font-family: 'Poppins', sans-serif;
            --space-unit: 8px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --color-primary: #3B82F6;
            --color-primary-hover: #2563EB;
            --color-background: #F3F4F6;
            --color-surface: #FFFFFF;
            --color-text-primary: #1F2937;
            --color-text-secondary: #6B7280;
            --color-border: #E5E7EB;
            --color-danger: #EF4444;
            --color-danger-hover: #DC2626;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* --- Base & Reset --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, h5, h6 { font-weight: 600; }

        /* --- Layout --- */
        .app-container { display: flex; height: 100vh; width: 100%; position: relative; }
        .sidebar {
            width: 280px; background-color: var(--color-surface); border-right: 1px solid var(--color-border);
            display: flex; flex-direction: column; padding: calc(var(--space-unit) * 3); flex-shrink: 0;
        }
        .sidebar-header { display: flex; align-items: center; gap: calc(var(--space-unit) * 1.5); margin-bottom: calc(var(--space-unit) * 4); }
        .sidebar-header .logo-icon { width: 32px; height: 32px; color: var(--color-primary); }
        .sidebar-header h1 { font-size: 20px; font-weight: 700; }
        .sidebar-nav { flex-grow: 1; overflow-y: auto; }
        .sidebar-footer { margin-top: auto; padding-top: calc(var(--space-unit) * 2); border-top: 1px solid var(--color-border); }
        .main-content { flex-grow: 1; padding: calc(var(--space-unit) * 4); overflow-y: auto; display: flex; flex-direction: column; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--space-unit) * 2); flex-shrink: 0; }
        .main-header h2 { font-size: 28px; }
        
        /* Topic Resources */
        .topic-resources-container { background-color: var(--color-surface); padding: calc(var(--space-unit) * 3); border-radius: var(--radius-lg); margin-bottom: calc(var(--space-unit) * 2); box-shadow: var(--shadow-md); flex-shrink: 0; }
        .topic-resources-container h4 { font-size: 18px; margin-bottom: var(--space-unit); }
        .topic-resources-container p { font-size: 14px; color: var(--color-text-secondary); margin-bottom: calc(var(--space-unit) * 2); }
        
        .topic-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--space-unit) * 3); flex-shrink: 0; flex-wrap: wrap; gap: 8px; }
        .topic-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .view-switcher { display: flex; background-color: var(--color-background); padding: 4px; border-radius: var(--radius-md); }
        .view-switcher .btn { background-color: transparent; border: none; padding: 6px 12px; }
        .view-switcher .btn.active { background-color: var(--color-surface); box-shadow: var(--shadow-md); }

        /* --- Components --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: var(--space-unit);
            padding: calc(var(--space-unit) * 1.25) calc(var(--space-unit) * 2); border-radius: var(--radius-md);
            border: none; font-family: inherit; font-weight: 500; font-size: 14px; cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none; white-space: nowrap;
        }
        .btn-icon { width: 18px; height: 18px; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border); }
        .btn-secondary:hover { background-color: var(--color-background); }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover { background-color: var(--color-danger-hover); }
        .btn-danger-ghost { background-color: transparent; color: var(--color-danger); }
        .btn-danger-ghost:hover { background-color: rgba(239, 68, 68, 0.1); }
        .btn-full { width: 100%; }
        
        .prompt-actions { display: flex; gap: 8px; margin-bottom: 8px; }
        .prompt-actions .btn { flex-grow: 1; }
        .hamburger-btn { display: none; background: none; border: none; padding: 8px; cursor: pointer; }

        /* Topic List */
        .nav-group-title {
            font-size: 12px; font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase;
            letter-spacing: 0.05em; padding: 0 calc(var(--space-unit) * 1.5);
            margin-top: calc(var(--space-unit) * 3); margin-bottom: var(--space-unit);
        }
        .topic-list a, .sidebar-footer-list a {
            display: flex; align-items: center; gap: calc(var(--space-unit) * 1.5); padding: var(--space-unit) calc(var(--space-unit) * 1.5);
            border-radius: var(--radius-md); text-decoration: none; color: var(--color-text-primary);
            font-size: 14px; font-weight: 500; transition: background-color 0.2s, color 0.2s;
        }
        .topic-list a:hover, .sidebar-footer-list a:hover { background-color: var(--color-background); }
        .topic-list a.active { background-color: var(--color-primary); color: white; }
        .topic-list a .nav-icon, .sidebar-footer-list a .nav-icon { width: 16px; height: 16px; }

        /* Welcome & Empty States */
        .centered-view { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .centered-view .icon-wrapper { background-color: var(--color-surface); padding: calc(var(--space-unit) * 2); border-radius: 50%; margin-bottom: calc(var(--space-unit) * 3); box-shadow: var(--shadow-md); }
        .centered-view .icon-wrapper svg { width: 48px; height: 48px; color: var(--color-primary); }
        .centered-view h2 { font-size: 24px; margin-bottom: var(--space-unit); }
        .centered-view p { color: var(--color-text-secondary); max-width: 400px; margin-bottom: calc(var(--space-unit) * 3); }

        /* Post Cards */
        .post-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: calc(var(--space-unit) * 3); border-radius: var(--radius-lg); transition: all 0.2s ease; }
        .post-card-grid.drag-over-posts { border: 2px dashed var(--color-primary); background-color: #EBF2FF; padding: calc(var(--space-unit) * 2); }
        .post-card {
            background-color: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-border);
            padding: calc(var(--space-unit) * 2); display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: var(--shadow-md); transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer;
        }
        .post-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .post-card h3 { font-size: 16px; margin-bottom: calc(var(--space-unit) * 1.5); }
        .post-card-tags { display: flex; flex-wrap: wrap; gap: calc(var(--space-unit) * 0.5); margin-bottom: calc(var(--space-unit) * 1.5); }
        .post-card-tag { background-color: var(--color-background); color: var(--color-text-secondary); font-size: 10px; font-weight: 500; padding: 2px 6px; border-radius: 4px; }
        .progress-bar-container { width: 100%; background-color: var(--color-background); border-radius: 99px; height: 8px; margin-bottom: var(--space-unit); overflow: hidden; }
        .progress-bar { background-color: var(--color-primary); height: 100%; border-radius: 99px; transition: width 0.3s ease; }
        .progress-text { font-size: 12px; color: var(--color-text-secondary); }
        .post-card-footer { font-size: 12px; color: var(--color-text-secondary); margin-top: calc(var(--space-unit) * 2); }
        
        /* Kanban View */
        .kanban-board { display: flex; gap: calc(var(--space-unit) * 2); overflow-x: auto; padding-bottom: var(--space-unit); flex-grow: 1; }
        .kanban-column { width: 300px; flex-shrink: 0; background-color: var(--color-background); border-radius: var(--radius-lg); display: flex; flex-direction: column; }
        .kanban-column.drag-over { background-color: #E5E7EB; }
        .kanban-column-header { padding: calc(var(--space-unit) * 1.5) calc(var(--space-unit) * 2); font-weight: 600; border-bottom: 1px solid var(--color-border); }
        .kanban-column-cards { padding: var(--space-unit); flex-grow: 1; overflow-y: auto; }
        .kanban-column-cards .post-card { margin-bottom: var(--space-unit); }
        
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: calc(var(--space-unit) * 2) calc(var(--space-unit) * 3); border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: var(--space-unit); }
        .modal-close-btn:hover { color: var(--color-text-primary); }
        .modal-close-btn svg { width: 20px; height: 20px; }
        .modal-body { padding: calc(var(--space-unit) * 3); }
        .modal-footer { padding: calc(var(--space-unit) * 2) calc(var(--space-unit) * 3); border-top: 1px solid var(--color-border); display: flex; justify-content: flex-end; gap: var(--space-unit); background-color: #F9FAFB; border-bottom-left-radius: var(--radius-lg); border-bottom-right-radius: var(--radius-lg); }
        
        /* Forms */
        .form-group { margin-bottom: calc(var(--space-unit) * 2); }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: var(--space-unit); }
        .form-input, .form-textarea {
            width: 100%; padding: calc(var(--space-unit) * 1.25) calc(var(--space-unit) * 1.5);
            border-radius: var(--radius-md); border: 1px solid var(--color-border); background-color: var(--color-surface);
            font-family: inherit; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .form-textarea { resize: vertical; min-height: 100px; }
        .form-hint { font-size: 12px; color: var(--color-text-secondary); margin-top: var(--space-unit); }

        /* Post Modal Specifics */
        #post-modal .modal-content { max-width: 1024px; max-height: 90vh; display: flex; flex-direction: column; }
        #post-modal .modal-body { flex-grow: 1; overflow-y: auto; }
        #modal-post-title { font-size: 24px; font-weight: 700; border: none; padding: 0; }
        #modal-post-title:focus { box-shadow: none; }
        .post-modal-grid { display: grid; grid-template-columns: 1fr 2fr; gap: calc(var(--space-unit) * 4); }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: calc(var(--space-unit) * 2); padding-bottom: var(--space-unit); border-bottom: 1px solid var(--color-border); }
        
        /* Checklist */
        .checklist-item { display: flex; align-items: center; gap: calc(var(--space-unit) * 1.5); padding: var(--space-unit) 0; cursor: pointer; }
        .checklist-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--color-primary); }
        .checklist-item span { transition: color 0.2s, text-decoration 0.2s; }
        .checklist-item input:checked + span { color: var(--color-text-secondary); text-decoration: line-through; }

        /* --- NEW: Text Editor with Highlighter and Preview --- */
        .editor-container { position: relative; width: 100%; height: 200px; font-family: inherit; }
        .editor-container .form-textarea, 
        .editor-container #content-highlighter,
        .editor-container #post-preview-area {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0;
            padding: calc(var(--space-unit) * 1.25) calc(var(--space-unit) * 1.5);
            border-radius: var(--radius-md); border: 1px solid var(--color-border);
            font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;
        }
        .editor-container .form-textarea {
            z-index: 2; color: transparent; background: transparent; caret-color: var(--color-text-primary);
        }
        .editor-container #content-highlighter { z-index: 1; background-color: var(--color-surface); pointer-events: none; overflow: hidden; }
        #content-highlighter .highlight { background-color: rgba(245, 158, 11, 0.3); } /* --color-warning with opacity */
        #post-preview-area {
             z-index: 3; background-color: var(--color-surface); overflow-y: auto;
             -webkit-font-smoothing: auto; -moz-osx-font-smoothing: auto;
        }
        .editor-header { display: flex; justify-content: space-between; align-items: center; }
        .editor-actions { display: flex; gap: 8px; align-items: center; }
        /* Markdown Preview Styles */
        #post-preview-area h1, #post-preview-area h2, #post-preview-area h3 { border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; margin-bottom: 0.5em; margin-top: 1em; }
        #post-preview-area p { margin-bottom: 1em; }
        #post-preview-area ul, #post-preview-area ol { padding-left: 2em; margin-bottom: 1em; }
        #post-preview-area blockquote { border-left: 4px solid var(--color-border); padding-left: 1em; margin-left: 0; color: var(--color-text-secondary); }
        #post-preview-area code { background-color: var(--color-background); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; }
        #post-preview-area pre { background-color: var(--color-background); padding: 1em; border-radius: var(--radius-md); overflow-x: auto; }
        #post-preview-area pre code { padding: 0; background: none; }

        /* Diagram Uploader */
        .diagram-uploader { width: 100%; border: 2px dashed var(--color-border); border-radius: var(--radius-md); padding: var(--space-unit); transition: border-color 0.2s; }
        .diagram-uploader.dragover { border-color: var(--color-primary); }
        .diagram-upload-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; background-color: var(--color-background); border-radius: var(--radius-md); color: var(--color-text-secondary); font-size: 14px; text-align: center; cursor: pointer; }
        .diagram-upload-area svg { width: 32px; height: 32px; margin-bottom: var(--space-unit); }
        .diagram-preview-grid {
            margin-top: var(--space-unit);
            display: grid;
            /* [MODIFIED] Increased minimum thumbnail size from 100px to 180px */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: var(--space-unit);
        }
        .diagram-thumbnail { position: relative; width: 100%; padding-top: 100%; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--color-border); }
        .diagram-thumbnail img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .delete-diagram-btn { position: absolute; top: 4px; right: 4px; background-color: rgba(239, 68, 68, 0.8); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .diagram-thumbnail:hover .delete-diagram-btn { opacity: 1; }
        
        /* Toast Notification */
        #toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: var(--radius-md); color: white; box-shadow: var(--shadow-lg); opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; z-index: 100; }
        #toast.show { opacity: 1; transform: translateY(0); }
        #toast.success { background-color: var(--color-success); }
        #toast.error { background-color: var(--color-danger); }
        
        /* Utility */
        .hidden { display: none !important; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .delete-text { display: inline; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-background); }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; z-index: 1000; transform: translateX(-100%); transition: transform 0.3s ease-in-out; box-shadow: var(--shadow-lg); }
            .app-container.sidebar-open .sidebar { transform: translateX(0); }
            .app-container.sidebar-open .sidebar-overlay { display: block; }
            .main-content { padding: calc(var(--space-unit) * 2); }
            .main-header { position: relative; margin-bottom: calc(var(--space-unit) * 3); }
            .main-header h2 { position: absolute; left: 50%; transform: translateX(-50%); width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; font-size: 22px; }
            .hamburger-btn { display: block; z-index: 1001; }
            .delete-text { display: none; }
            .post-card-grid { grid-template-columns: 1fr; }
            .post-modal-grid { grid-template-columns: 1fr; }
            #post-modal .modal-content { width: 95%; height: 90vh; }
            .kanban-board { flex-direction: column; gap: calc(var(--space-unit) * 3); }
            .kanban-column { width: 100%; }
            .topic-controls { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v10"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="m12 15-2-2 4-4 2 2-4 4Z"/></svg>
                <h1>콘텐츠 허브</h1>
            </header>
            <button id="show-add-topic-modal-btn" class="btn btn-primary btn-full" style="margin-bottom: 24px;">
                <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>새 주제 추가</span>
            </button>
            <nav class="sidebar-nav">
                <h2 class="nav-group-title">주제 목록</h2>
                <div id="topic-list" class="topic-list"></div>
            </nav>
            <footer class="sidebar-footer">
                <h2 class="nav-group-title">관리</h2>
                <div id="sidebar-footer-list" class="sidebar-footer-list">
                    <a href="#" id="settings-btn"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg> 설정</a>
                    <a href="#" id="export-data-btn"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> 데이터 내보내기</a>
                    <a href="#" id="import-data-btn"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> 데이터 가져오기</a>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
            </footer>
        </aside>
        <div class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div id="welcome-view" class="centered-view">
                <div class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M12 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="m12 15-2-2 4-4 2 2-4 4Z"/></svg></div>
                <h2>콘텐츠 허브에 오신 것을 환영합니다</h2><p>좌측의 '새 주제 추가' 버튼을 눌러 블로그 글 관리를 시작하세요.</p>
            </div>
            <div id="topic-view" class="hidden">
                <header class="main-header">
                    <button class="hamburger-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
                    <h2 id="topic-title"></h2>
                    <button id="delete-topic-btn" class="btn btn-danger-ghost"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg><span class="delete-text">주제 삭제</span></button>
                </header>
                <section class="topic-resources-container">
                    <h4>주제별 자료</h4><p>이 주제의 모든 게시물에서 공통으로 사용할 자료입니다. 프롬프트에서 {{자료}} 변수로 사용할 수 있습니다.</p>
                    <textarea id="topic-resources-input" class="form-textarea" placeholder="주제와 관련된 정보, 키워드, 참조 링크 등을 입력하세요..."></textarea>
                </section>
                <div class="topic-controls">
                    <div class="topic-actions">
                        <button id="show-add-post-modal-btn" class="btn btn-secondary"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> <span>새 게시물 추가</span></button>
                        <button id="upload-post-files-btn" class="btn btn-secondary"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> <span>파일에서 게시물 추가</span></button>
                    </div>
                    <div class="view-switcher">
                        <button class="btn btn-secondary active" data-view="grid">Grid</button>
                        <button class="btn btn-secondary" data-view="kanban">Kanban</button>
                    </div>
                </div>
                <div id="post-card-container" class="post-card-grid"></div>
                <div id="kanban-board-view" class="kanban-board hidden"></div>
            </div>
        </main>
    </div>
    
    <input type="file" id="post-upload-input" class="hidden" accept=".txt,text/plain" multiple>

    <!-- Modals -->
    <div id="add-topic-modal" class="modal-overlay"><div class="modal-content"><header class="modal-header"><h3>새 주제 추가</h3><button class="modal-close-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></header><div class="modal-body"><div class="form-group"><label for="topic-names-input" class="form-label">주제</label><textarea id="topic-names-input" class="form-textarea" placeholder="예:&#10;인공지능&#10;마케팅 자동화"></textarea><p class="form-hint">여러 개를 추가하려면 줄바꿈으로 구분해주세요.</p></div></div><footer class="modal-footer"><button class="btn btn-secondary modal-close-btn">취소</button><button id="add-topic-confirm-btn" class="btn btn-primary">추가하기</button></footer></div></div>
    <div id="add-post-modal" class="modal-overlay"><div class="modal-content"><header class="modal-header"><h3>새 게시물 추가</h3><button class="modal-close-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></header><div class="modal-body"><div class="form-group"><label for="post-titles-input" class="form-label">게시물 제목</label><textarea id="post-titles-input" class="form-textarea" placeholder="예:&#10;첫 번째 게시물&#10;두 번째 게시물"></textarea><p class="form-hint">여러 개를 추가하려면 줄바꿈으로 구분해주세요.</p></div></div><footer class="modal-footer"><button class="btn btn-secondary modal-close-btn">취소</button><button id="add-post-confirm-btn" class="btn btn-primary">추가하기</button></footer></div></div>
    <div id="settings-modal" class="modal-overlay"><div class="modal-content" style="max-width: 700px;"><header class="modal-header"><h3>설정</h3><button class="modal-close-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></header><div class="modal-body"><p class="form-hint" style="margin-bottom: 16px;">프롬프트에 {{제목}}, {{내용}}, {{자료}}를 포함하여 동적으로 값을 삽입할 수 있습니다.</p><div class="form-group"><label for="blog-prompt-input" class="form-label">블로그 글 생성 프롬프트</label><textarea id="blog-prompt-input" rows="4" class="form-textarea"></textarea></div><div class="form-group"><label for="diagram-prompt-input" class="form-label">도표 생성 프롬프트</label><textarea id="diagram-prompt-input" rows="4" class="form-textarea"></textarea></div></div><footer class="modal-footer"><button class="btn btn-secondary modal-close-btn">취소</button><button id="save-settings-btn" class="btn btn-primary">설정 저장</button></footer></div></div>

    <div id="post-modal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header"><input type="text" id="modal-post-title" class="form-input" placeholder="게시물 제목..."><button class="modal-close-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></header>
            <div class="modal-body">
                <div class="post-modal-grid">
                    <div>
                        <h4 class="section-title">빠른 프롬프트</h4>
                        <div style="margin-bottom: 8px;"><p class="form-label" style="font-size: 12px; margin-bottom: 4px;">블로그 글 프롬프트</p><div class="prompt-actions"><button class="btn btn-secondary prompt-action-btn" data-type="blog" data-action="copy"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span>복사</span></button><button class="btn btn-secondary prompt-action-btn" data-type="blog" data-action="download"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> <span>다운로드</span></button></div></div>
                        <div style="margin-bottom: 24px;"><p class="form-label" style="font-size: 12px; margin-bottom: 4px;">도표 생성 프롬프트</p><div class="prompt-actions"><button class="btn btn-secondary prompt-action-btn" data-type="diagram" data-action="copy"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span>복사</span></button><button class="btn btn-secondary prompt-action-btn" data-type="diagram" data-action="download"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> <span>다운로드</span></button></div></div>
                        <h4 class="section-title">작업 체크리스트</h4>
                        <div id="checklist-container"></div>
                    </div>
                    <div>
                        <div class="form-group">
                            <div class="editor-header">
                                <label for="modal-post-content" class="form-label">블로그 글 내용</label>
                                <div class="editor-actions">
                                    <button id="clean-text-btn" class="btn btn-secondary" style="padding: 4px 8px;">텍스트 정제</button>
                                    <button id="toggle-preview-btn" class="btn btn-secondary" style="padding: 4px 8px;">미리보기</button>
                                </div>
                            </div>
                            <div class="editor-container">
                                <div id="content-highlighter"></div>
                                <textarea id="modal-post-content" class="form-textarea" spellcheck="false" placeholder="생성된 블로그 글 내용을 여기에 붙여넣으세요..."></textarea>
                                <div id="post-preview-area" class="hidden"></div>
                            </div>
                        </div>
                        <div class="form-group"><label class="form-label">도표 이미지</label><div id="diagram-uploader" class="diagram-uploader"><div id="diagram-preview-grid" class="diagram-preview-grid"></div><div id="diagram-upload-area" class="diagram-upload-area"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-2.4-4.2-4.8-4.8-1.4-.3-2.7-.1-3.9.7L12 8l-1.2-1.2a5.2 5.2 0 0 0-7.4 0L2 8.2" /><path d="M10.2 13.8a5.2 5.2 0 0 0 7.4 0l1.2-1.2" /><path d="m22 17-1.5-1.5" /><path d="M13.5 15.5 12 17l-1.5-1.5" /><path d="M2 17l1.5-1.5" /><path d="m10.5 15.5 1.5 1.5 1.5-1.5" /></svg><p>클릭 또는 드래그 앤 드롭<br>이미지, ZIP 파일 붙여넣기 (Ctrl+V)</p></div></div><input type="file" id="diagram-upload-input" class="hidden" accept="image/*,.zip,application/zip" multiple></div>
                    </div>
                </div>
            </div>
            <footer class="modal-footer">
                <button id="delete-post-btn" class="btn btn-danger-ghost" style="margin-right: auto;">게시물 삭제</button>
                <button class="btn btn-primary modal-close-btn">닫기</button>
            </footer>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay"><div class="modal-content" style="max-width: 400px;"><header class="modal-header"><h3 id="confirm-title">확인</h3></header><div class="modal-body"><p id="confirm-message"></p></div><footer class="modal-footer"><button id="confirm-cancel-btn" class="btn btn-secondary">취소</button><button id="confirm-ok-btn" class="btn btn-danger">삭제</button></footer></div></div>

    <div id="toast"></div>

    <script>
    // --- IndexedDB Helper (Database Abstraction Layer) ---
    const db = {
        _db: null,
        // 데이터베이스 버전 3으로 증가 (스키마 변경)
        _version: 3, 
        init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('BlogWorkflowDB_Redesigned', this._version);
                request.onerror = (event) => reject("IndexedDB error: " + request.error);
                request.onsuccess = (event) => {
                    this._db = event.target.result;
                    resolve(this._db);
                };
                request.onupgradeneeded = async (event) => {
                    this._db = event.target.result;
                    const tx = event.target.transaction;
                    
                    // 버전 2로 업그레이드: topics, settings 저장소 생성
                    if (event.oldVersion < 2) {
                        if (!this._db.objectStoreNames.contains('topics')) {
                            this._db.createObjectStore('topics', { keyPath: 'id' });
                        }
                        if (!this._db.objectStoreNames.contains('settings')) {
                            this._db.createObjectStore('settings', { keyPath: 'id' });
                        }
                    }
                    
                    // 버전 3으로 업그레이드: posts 저장소 생성 및 데이터 마이그레이션
                    if (event.oldVersion < 3) {
                        if (!this._db.objectStoreNames.contains('posts')) {
                           const postStore = this._db.createObjectStore('posts', { keyPath: 'id' });
                           postStore.createIndex('topicId', 'topicId', { unique: false });
                        }
                        
                        // 데이터 마이그레이션: 기존 topics의 posts 배열을 새로운 posts 저장소로 이동
                        try {
                            const topicStore = tx.objectStore('topics');
                            const postStore = tx.objectStore('posts');
                            const oldTopics = await new Promise((res, rej) => {
                                const r = topicStore.getAll();
                                r.onsuccess = () => res(r.result);
                                r.onerror = () => rej(r.error);
                            });

                            for (const topic of oldTopics) {
                                if (topic.posts && Array.isArray(topic.posts)) {
                                    for (const post of topic.posts) {
                                        post.topicId = topic.id; // 외래 키 추가
                                        postStore.put(post);
                                    }
                                    delete topic.posts; // 기존 topic 객체에서 posts 배열 삭제
                                    topicStore.put(topic);
                                }
                            }
                            console.log("Database migration to v3 completed.");
                        } catch (error) {
                            console.error("Database migration failed:", error);
                            tx.abort(); // 마이그레이션 실패 시 트랜잭션 롤백
                        }
                    }
                };
            });
        },
        _getStore(name, mode) { return this._db.transaction(name, mode).objectStore(name); },
        async getAll(storeName) { return new Promise((resolve, reject) => { const r = this._getStore(storeName, 'readonly').getAll(); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); },
        async get(storeName, key) { return new Promise((resolve, reject) => { const r = this._getStore(storeName, 'readonly').get(key); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); },
        async put(storeName, data) { return new Promise((resolve, reject) => { const r = this._getStore(storeName, 'readwrite').put(data); r.onsuccess = () => resolve(r.result); r.onerror = () => reject(r.error); }); },
        async delete(storeName, key) { return new Promise((resolve, reject) => { const r = this._getStore(storeName, 'readwrite').delete(key); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); },
        // 특정 인덱스를 사용해 모든 데이터를 가져오는 헬퍼 함수
        async getAllByIndex(storeName, indexName, key) {
             return new Promise((resolve, reject) => {
                const store = this._getStore(storeName, 'readonly');
                const index = store.index(indexName);
                const request = index.getAll(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
    };

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            await db.init();
        } catch (error) {
            console.error("Failed to initialize database:", error);
            alert("데이터베이스 초기화에 실패했습니다. 앱을 사용할 수 없습니다.");
            return;
        }

        // --- State Management ---
        const state = {
            topics: [],
            posts: new Map(), // key: topicId, value: array of posts
            settings: { blogPrompt: '...', diagramPrompt: '...' },
            activeTopicId: null,
            activePostId: null,
            currentView: 'grid',
            isEditorPreview: false,
        };

        // --- DOM Elements ---
        const appContainer = document.querySelector('.app-container');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.querySelector('.sidebar-overlay');
        const hamburgerBtn = document.querySelector('.hamburger-btn');
        const topicList = document.getElementById('topic-list');
        const welcomeView = document.getElementById('welcome-view');
        const topicView = document.getElementById('topic-view');
        const topicTitle = document.getElementById('topic-title');
        const deleteTopicBtn = document.getElementById('delete-topic-btn');
        const postCardContainer = document.getElementById('post-card-container');
        const kanbanBoardView = document.getElementById('kanban-board-view');
        const toast = document.getElementById('toast');
        const topicResourcesInput = document.getElementById('topic-resources-input');

        const modals = { addTopic: document.getElementById('add-topic-modal'), addPost: document.getElementById('add-post-modal'), settings: document.getElementById('settings-modal'), post: document.getElementById('post-modal'), confirm: document.getElementById('confirm-modal') };
        
        const showAddTopicModalBtn = document.getElementById('show-add-topic-modal-btn');
        const addTopicConfirmBtn = document.getElementById('add-topic-confirm-btn');
        const showAddPostModalBtn = document.getElementById('show-add-post-modal-btn');
        const uploadPostFilesBtn = document.getElementById('upload-post-files-btn');
        const addPostConfirmBtn = document.getElementById('add-post-confirm-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const exportDataBtn = document.getElementById('export-data-btn');
        const importDataBtn = document.getElementById('import-data-btn');
        const viewSwitcherBtns = document.querySelectorAll('.view-switcher .btn');

        const topicNamesInput = document.getElementById('topic-names-input');
        const postTitlesInput = document.getElementById('post-titles-input');
        const postUploadInput = document.getElementById('post-upload-input');
        const blogPromptInput = document.getElementById('blog-prompt-input');
        const diagramPromptInput = document.getElementById('diagram-prompt-input');
        const importFileInput = document.getElementById('import-file-input');
        
        const modalPostTitle = document.getElementById('modal-post-title');
        const checklistContainer = document.getElementById('checklist-container');
        const diagramUploader = document.getElementById('diagram-uploader');
        const diagramUploadArea = document.getElementById('diagram-upload-area');
        const diagramUploadInput = document.getElementById('diagram-upload-input');
        const diagramPreviewGrid = document.getElementById('diagram-preview-grid');
        const deletePostBtn = document.getElementById('delete-post-btn');
        
        const contentEditor = document.getElementById('modal-post-content');
        const contentHighlighter = document.getElementById('content-highlighter');
        const postPreviewArea = document.getElementById('post-preview-area');
        const cleanTextBtn = document.getElementById('clean-text-btn');
        const togglePreviewBtn = document.getElementById('toggle-preview-btn');

        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        let confirmCallback = null;
        
        // --- Utility Functions ---
        const debounce = (func, delay) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; };
        const showToast = (msg, isErr=false) => { toast.textContent = msg; toast.className = isErr ? 'error' : 'success'; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); };
        const openModal = (el) => el.classList.add('visible');
        const closeModal = (el) => el.classList.remove('visible');
        const showConfirm = (msg, onConfirm) => { confirmMessage.textContent = msg; confirmCallback = onConfirm; openModal(modals.confirm); };
        const parseTags = (c) => { const m = c.match(/#([a-zA-Z0-9ㄱ-ㅎㅏ-ㅣ가-힣_]+)/g); return m ? [...new Set(m.map(t => t.substring(1)))] : []; };

        // --- Data Logic (Refactored for Normalized DB) ---
        const loadInitialData = async () => {
            state.topics = await db.getAll('topics');
            state.posts.clear();
            const savedSettings = await db.get('settings', 'userSettings');
            if (savedSettings) state.settings = savedSettings.data;
            refreshUI();
        };

        const setActiveTopic = async (topicId) => {
            state.activeTopicId = topicId;
            if (topicId && !state.posts.has(topicId)) {
                const postsForTopic = await db.getAllByIndex('posts', 'topicId', topicId);
                state.posts.set(topicId, postsForTopic);
            }
            refreshUI();
        };

        // --- Rendering ---
        const renderTopics = () => {
            topicList.innerHTML = '';
            if (state.topics.length === 0) {
                topicList.innerHTML = `<p style="padding: 0 12px; font-size: 14px; color: var(--color-text-secondary);">주제가 없습니다.</p>`;
                return;
            }
            state.topics.forEach(topic => {
                const topicEl = document.createElement('a');
                topicEl.href = '#';
                topicEl.dataset.id = topic.id;
                topicEl.className = state.activeTopicId === topic.id ? 'active' : '';
                topicEl.innerHTML = `<svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg><span>${topic.name}</span>`;
                topicEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    setActiveTopic(topic.id);
                    if (window.innerWidth <= 768) appContainer.classList.remove('sidebar-open');
                });
                topicList.appendChild(topicEl);
            });
        };

        const createPostCardElement = (post) => {
            const progress = post.checklist.filter(c => c.done).length;
            const total = post.checklist.length;
            const progressPercentage = total > 0 ? (progress / total) * 100 : 0;
            const card = document.createElement('div');
            card.className = 'post-card';
            card.dataset.postId = post.id;
            card.draggable = true;
            const tagsHTML = post.tags.map(tag => `<span class="post-card-tag">#${tag}</span>`).join('');
            card.innerHTML = `<div><h3>${post.title}</h3><div class="post-card-tags">${tagsHTML}</div><div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercentage}%"></div></div><p class="progress-text">진행률: ${progress} / ${total}</p></div><div class="post-card-footer">최근 업데이트: ${new Date(post.updatedAt).toLocaleString()}</div>`;
            card.addEventListener('click', () => openPostModal(post.id));
            card.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', post.id); e.dataTransfer.effectAllowed = 'move'; });
            return card;
        };
        
        const renderPostCards = () => {
            postCardContainer.innerHTML = '';
            const posts = state.posts.get(state.activeTopicId) || [];
            if (posts.length === 0) {
                 postCardContainer.innerHTML = `<div class="centered-view" style="grid-column: 1 / -1; padding: 40px 0; min-height: 300px;"><div class="icon-wrapper" style="background-color: #e0e7ff;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg></div><h2 style="font-size: 20px;">게시물이 없습니다</h2><p>게시물을 추가하거나<br>여기에 .txt 파일을 드래그 앤 드롭하세요.</p></div>`;
                return;
            }
            posts.forEach(post => { const card = createPostCardElement(post); postCardContainer.appendChild(card); });
        };
        
        const renderKanbanBoard = () => {
            kanbanBoardView.innerHTML = '';
            const posts = state.posts.get(state.activeTopicId) || [];
            const kanbanColumns = ['아이디어', '초안 작성', '검토 중', '발행 완료'];
            kanbanColumns.forEach(status => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                column.dataset.status = status;
                column.innerHTML = `<div class="kanban-column-header">${status}</div><div class="kanban-column-cards"></div>`;
                const cardsContainer = column.querySelector('.kanban-column-cards');
                posts.filter(p => p.status === status).forEach(p => cardsContainer.appendChild(createPostCardElement(p)));
                column.addEventListener('dragover', (e) => { e.preventDefault(); column.classList.add('drag-over'); });
                column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
                column.addEventListener('drop', async (e) => {
                    e.preventDefault(); column.classList.remove('drag-over');
                    const postId = e.dataTransfer.getData('text/plain');
                    const post = posts.find(p => p.id === postId);
                    if (post && post.status !== status) {
                        post.status = status;
                        await db.put('posts', post);
                        renderKanbanBoard();
                    }
                });
                kanbanBoardView.appendChild(column);
            });
        };

        const renderActiveView = () => {
            if (state.activeTopicId) {
                const activeTopic = state.topics.find(t => t.id === state.activeTopicId);
                if (activeTopic) {
                    welcomeView.classList.add('hidden');
                    topicView.classList.remove('hidden');
                    topicTitle.textContent = activeTopic.name;
                    topicResourcesInput.value = activeTopic.resources || '';
                    if (state.currentView === 'grid') {
                        postCardContainer.classList.remove('hidden'); kanbanBoardView.classList.add('hidden');
                        renderPostCards();
                    } else {
                        postCardContainer.classList.add('hidden'); kanbanBoardView.classList.remove('hidden');
                        renderKanbanBoard();
                    }
                } else {
                    state.activeTopicId = null;
                    welcomeView.classList.remove('hidden'); topicView.classList.add('hidden');
                }
            } else {
                welcomeView.classList.remove('hidden'); topicView.classList.add('hidden');
            }
        };

        const refreshUI = () => { renderTopics(); renderActiveView(); };
        
        // --- CRUD Functions ---
        const addTopics = async () => {
            const names = topicNamesInput.value.split('\n').map(s => s.trim()).filter(Boolean);
            if (names.length === 0) return;
            let lastNewTopicId = null;
            for (const name of names) {
                const newTopic = { id: Date.now().toString() + Math.random(), name: name, resources: '' };
                await db.put('topics', newTopic);
                state.topics.push(newTopic);
                lastNewTopicId = newTopic.id;
            }
            topicNamesInput.value = '';
            closeModal(modals.addTopic);
            if (lastNewTopicId) await setActiveTopic(lastNewTopicId);
            showToast(`${names.length}개의 주제를 추가했습니다.`);
        };
        
        const deleteActiveTopic = async () => {
            if (!state.activeTopicId) return;
            showConfirm('이 주제와 모든 게시물을 정말로 삭제하시겠습니까?', async () => {
                const topicIdToDelete = state.activeTopicId;
                const postsToDelete = state.posts.get(topicIdToDelete) || [];
                for (const post of postsToDelete) {
                    await db.delete('posts', post.id);
                }
                await db.delete('topics', topicIdToDelete);
                state.topics = state.topics.filter(t => t.id !== topicIdToDelete);
                state.posts.delete(topicIdToDelete);
                state.activeTopicId = state.topics.length > 0 ? state.topics[0].id : null;
                if(state.activeTopicId) await setActiveTopic(state.activeTopicId);
                else refreshUI();
                
                showToast('주제를 삭제했습니다.');
                closeModal(modals.confirm);
            });
        };

        const createNewPostObject = (title, content = '', topicId) => {
            const checklist = [
                { id: 'c1', text: '블로그 글 생성', done: !!content },
                { id: 'c2', text: '블로그 글 내용 붙여넣기', done: !!content },
                { id: 'c3', text: '도표 생성', done: false },
                { id: 'c4', text: '도표 이미지 업로드', done: false },
                { id: 'c5', text: '블로그에 업로드', done: false },
            ];
            return {
                id: Date.now().toString() + Math.random(),
                topicId: topicId,
                title: title,
                content: content,
                diagrams: [],
                tags: parseTags(content),
                status: '아이디어',
                checklist: checklist,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
            };
        };
        
        const addPost = async () => {
            const titles = postTitlesInput.value.split('\n').map(s => s.trim()).filter(Boolean);
            if (titles.length === 0 || !state.activeTopicId) return;
            const currentPosts = state.posts.get(state.activeTopicId) || [];
            for (const title of titles) {
                const newPost = createNewPostObject(title, '', state.activeTopicId);
                await db.put('posts', newPost);
                currentPosts.push(newPost);
            }
            postTitlesInput.value = '';
            closeModal(modals.addPost);
            refreshUI();
            showToast(`${titles.length}개의 게시물을 추가했습니다.`);
        };
        
        const addPostsFromFiles = async (files) => {
            if (!state.activeTopicId) { showToast('먼저 주제를 선택해주세요.', true); return; }
            if (!files || files.length === 0) return;
            const currentPosts = state.posts.get(state.activeTopicId) || [];
            const readFile = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ title: file.name.replace(/\.txt$/, ''), content: reader.result });
                reader.onerror = (error) => reject(error);
                reader.readAsText(file, 'UTF-8');
            });
            try {
                const postsData = await Promise.all([...files].map(readFile));
                for (const data of postsData) {
                    const newPost = createNewPostObject(data.title, data.content, state.activeTopicId);
                    await db.put('posts', newPost);
                    currentPosts.push(newPost);
                }
                refreshUI();
                showToast(`${postsData.length}개의 게시물을 파일에서 추가했습니다.`);
            } catch (error) {
                console.error("Error reading files:", error);
                showToast('파일을 읽는 중 오류가 발생했습니다.', true);
            }
        };

        const deletePost = async () => {
            if (!state.activePostId) return;
            showConfirm('이 게시물을 정말로 삭제하시겠습니까?', async () => {
                await db.delete('posts', state.activePostId);
                let currentPosts = state.posts.get(state.activeTopicId) || [];
                currentPosts = currentPosts.filter(p => p.id !== state.activePostId);
                state.posts.set(state.activeTopicId, currentPosts);
                
                state.activePostId = null;
                closeModal(modals.post);
                closeModal(modals.confirm);
                refreshUI();
                showToast('게시물을 삭제했습니다.');
            });
        };

        // --- Post Modal Logic ---
        const openPostModal = (postId) => {
            state.activePostId = postId;
            const post = (state.posts.get(state.activeTopicId) || []).find(p => p.id === postId);
            if (!post) return;
            
            modalPostTitle.value = post.title;
            contentEditor.value = post.content;
            renderChecklistInModal(post);
            renderDiagrams(post.diagrams || []);
            state.isEditorPreview = false;
            updateEditorVisibility();
            updateHighlighter();
            openModal(modals.post);
        };
        
        const autoSavePost = async () => {
            if (!state.activePostId || !state.activeTopicId) return;
            const post = (state.posts.get(state.activeTopicId) || []).find(p => p.id === state.activePostId);
            if (!post) return;

            post.title = modalPostTitle.value;
            post.content = contentEditor.value;
            post.tags = parseTags(post.content);
            post.updatedAt = new Date().toISOString();
            
            await db.put('posts', post);
            
            const cardInUI = document.querySelector(`.post-card[data-post-id="${post.id}"]`);
            if (cardInUI) {
                const newCard = createPostCardElement(post);
                cardInUI.replaceWith(newCard);
            }
            console.log("Auto-saved post:", post.title);
        };
        const debouncedAutoSave = debounce(autoSavePost, 750);
        
        const renderChecklistInModal = (post) => {
            checklistContainer.innerHTML = '';
            post.checklist.forEach(item => {
                const el = document.createElement('label');
                el.className = 'checklist-item';
                el.innerHTML = `<input type="checkbox" data-id="${item.id}" ${item.done ? 'checked' : ''}><span>${item.text}</span>`;
                el.querySelector('input').addEventListener('change', (e) => { item.done = e.target.checked; autoSavePost(); });
                checklistContainer.appendChild(el);
            });
        };
        
        const updateChecklistItem = (post, itemId, isDone) => {
            const item = post.checklist.find(i => i.id === itemId);
            if (item && item.done !== isDone) { item.done = isDone; renderChecklistInModal(post); autoSavePost(); }
        };

        // --- Diagram Logic ---
        const renderDiagrams = (diagrams) => {
            diagramPreviewGrid.innerHTML = '';
            if (diagrams && diagrams.length > 0) {
                diagramUploadArea.classList.add('hidden');
                diagrams.forEach((diagramData, index) => {
                    const thumb = document.createElement('div');
                    thumb.className = 'diagram-thumbnail';
                    thumb.innerHTML = `<img src="${diagramData.url}" alt="${diagramData.name}"><button class="delete-diagram-btn" data-index="${index}"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>`;
                    thumb.querySelector('.delete-diagram-btn').addEventListener('click', () => deleteDiagram(index));
                    diagramPreviewGrid.appendChild(thumb);
                });
            } else {
                diagramUploadArea.classList.remove('hidden');
            }
        };

        const isImageAsset = (fileName) => /\.((png)|(jpe?g)|(gif)|(webp)|(svg))$/i.test(fileName);
        const getMimeTypeFromFileName = (fileName) => {
            const ext = fileName.split('.').pop().toLowerCase();
            if (ext === 'png') return 'image/png';
            if (ext === 'jpg' || ext === 'jpeg') return 'image/jpeg';
            if (ext === 'gif') return 'image/gif';
            if (ext === 'webp') return 'image/webp';
            if (ext === 'svg') return 'image/svg+xml';
            return null;
        };

        // [MODIFIED] Refactored function to sort files and zip entries by name before processing.
        const handleDiagramFiles = async (files) => {
            const post = (state.posts.get(state.activeTopicId) || []).find(p => p.id === state.activePostId);
            if (!post) return;
        
            const initialDiagramCount = post.diagrams.length;
            let fileProcessingPromises = [];

            try {
                // 1. Convert FileList to an array and sort by file name.
                const sortedFiles = Array.from(files).sort((a, b) => a.name.localeCompare(b.name));
        
                for (const file of sortedFiles) {
                    if (file.type.startsWith('image/')) {
                        // Handle regular image files
                        const promise = new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve({ name: file.name, url: e.target.result });
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        fileProcessingPromises.push(promise);
                    } else if (file.name.toLowerCase().endsWith('.zip')) {
                        // Handle ZIP files
                        const zipPromise = (async () => {
                            const zip = await JSZip.loadAsync(file);
                            const zipEntries = [];
                            zip.forEach((_, zipEntry) => {
                                if (isImageAsset(zipEntry.name) && !zipEntry.dir) {
                                    zipEntries.push(zipEntry);
                                }
                            });
        
                            // 2. Sort entries within the ZIP file by name.
                            zipEntries.sort((a, b) => a.name.localeCompare(b.name));
        
                            // Process sorted entries
                            const entryPromises = zipEntries.map(async (entry) => {
                                const base64 = await entry.async('base64');
                                const mimeType = getMimeTypeFromFileName(entry.name);
                                if (mimeType) {
                                    return { name: entry.name, url: `data:${mimeType};base64,${base64}` };
                                }
                                return null;
                            });
                            
                            // Await all promises from this zip and filter out any nulls
                            return (await Promise.all(entryPromises)).filter(Boolean);
                        })();
                        fileProcessingPromises.push(zipPromise);
                    }
                }
        
                // 3. Resolve all promises and add the new diagrams to the post.
                const results = await Promise.all(fileProcessingPromises);
                const newDiagrams = results.flat(); // .flat() handles arrays of diagrams from ZIP files.
                
                if (!post.diagrams) post.diagrams = [];
                post.diagrams.push(...newDiagrams);
                
                // Sort the entire diagrams array by name after adding new ones
                post.diagrams.sort((a,b) => a.name.localeCompare(b.name));

                renderDiagrams(post.diagrams);
                
                if (post.diagrams.length > initialDiagramCount) {
                    updateChecklistItem(post, 'c4', true); // This will trigger autoSave
                } else {
                    autoSavePost();
                }
            } catch (error) {
                console.error("Error handling diagram files:", error);
                showToast('파일 처리 중 오류가 발생했습니다.', true);
            }
        };
        
        const deleteDiagram = (index) => {
            const post = (state.posts.get(state.activeTopicId) || []).find(p => p.id === state.activePostId);
            if (post && post.diagrams) {
                post.diagrams.splice(index, 1);
                renderDiagrams(post.diagrams);
                if (post.diagrams.length === 0) {
                    updateChecklistItem(post, 'c4', false);
                } else {
                    autoSavePost();
                }
            }
        };

        // --- Data Management & Prompts ---
        const getPromptText = (type, post) => {
            if (!post) return null;
            const activeTopic = state.topics.find(t => t.id === post.topicId);
            const resources = activeTopic.resources || '';
            let promptTemplate = type === 'blog' ? state.settings.blogPrompt : state.settings.diagramPrompt;
            if (type === 'diagram' && !post.content) {
                showToast('도표 프롬프트는 글 내용이 필요합니다.', true);
                return null;
            }
            return promptTemplate.replace(/\{\{제목\}\}/g, post.title).replace(/\{\{내용\}\}/g, post.content).replace(/\{\{자료\}\}/g, resources);
        };
        
        const exportData = async () => {
            const topics = await db.getAll('topics');
            const posts = await db.getAll('posts');
            const settings = await db.get('settings', 'userSettings');
            const dataToExport = { topics, posts, settings };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `content-hub-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const importData = (file) => {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.topics && (imported.posts || imported.topics.some(t => t.posts))) {
                        showConfirm('현재 데이터를 덮어쓰고 가져오시겠습니까?', async () => {
                            const topicStore = db._getStore('topics', 'readwrite');
                            const postStore = db._getStore('posts', 'readwrite');
                            const settingsStore = db._getStore('settings', 'readwrite');
                            await Promise.all([
                                new Promise(res => { const r = topicStore.clear(); r.onsuccess = res; }),
                                new Promise(res => { const r = postStore.clear(); r.onsuccess = res; }),
                                new Promise(res => { const r = settingsStore.clear(); r.onsuccess = res; })
                            ]);
                            
                            for (const topic of imported.topics) {
                                if (topic.posts && Array.isArray(topic.posts)) {
                                    for (const post of topic.posts) {
                                        post.topicId = topic.id;
                                        await db.put('posts', post);
                                    }
                                    delete topic.posts;
                                }
                                await db.put('topics', topic);
                            }
                            if (imported.posts && Array.isArray(imported.posts)) {
                                 for (const post of imported.posts) await db.put('posts', post);
                            }
                            if (imported.settings) await db.put('settings', imported.settings);
                            
                            await loadInitialData();
                            showToast('데이터를 성공적으로 가져왔습니다.');
                            closeModal(modals.confirm);
                        });
                    } else { showToast('잘못된 파일 형식입니다.', true); }
                } catch (error) { showToast('파일을 읽는 중 오류 발생.', true); }
            };
            reader.readAsText(file);
        };
        
        // --- Text Editor & Preview Logic ---
        const FAKE_SPACE_REGEX = /[\u200B-\u200D\uFEFF*]/g;
        const updateHighlighter = () => {
            const text = contentEditor.value;
            const highlightedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(FAKE_SPACE_REGEX, '<span class="highlight">$&</span>');
            contentHighlighter.innerHTML = highlightedText;
            contentHighlighter.scrollTop = contentEditor.scrollTop;
            contentHighlighter.scrollLeft = contentEditor.scrollLeft;
        };
        
        const updatePreview = () => {
            if (state.isEditorPreview) {
                postPreviewArea.innerHTML = marked.parse(contentEditor.value);
            }
        };

        const updateEditorVisibility = () => {
            if (state.isEditorPreview) {
                postPreviewArea.classList.remove('hidden');
                contentEditor.classList.add('hidden');
                contentHighlighter.classList.add('hidden');
                togglePreviewBtn.textContent = '편집하기';
                togglePreviewBtn.classList.add('active');
                updatePreview();
            } else {
                postPreviewArea.classList.add('hidden');
                contentEditor.classList.remove('hidden');
                contentHighlighter.classList.remove('hidden');
                togglePreviewBtn.textContent = '미리보기';
                togglePreviewBtn.classList.remove('active');
            }
        };

        // --- Event Listeners ---
        cleanTextBtn.addEventListener('click', () => {
            const cleanedText = contentEditor.value.replace(FAKE_SPACE_REGEX, '');
            if (contentEditor.value !== cleanedText) {
                contentEditor.value = cleanedText;
                contentEditor.dispatchEvent(new Event('input', { bubbles: true }));
                showToast('불필요한 공백과 문자를 제거했습니다.');
            } else { showToast('제거할 문자가 없습니다.'); }
        });
        
        togglePreviewBtn.addEventListener('click', () => { state.isEditorPreview = !state.isEditorPreview; updateEditorVisibility(); });
        contentEditor.addEventListener('input', () => { updateHighlighter(); updatePreview(); debouncedAutoSave(); const post = (state.posts.get(state.activeTopicId) || []).find(p => p.id === state.activePostId); if(post) updateChecklistItem(post, 'c2', contentEditor.value.trim().length > 0); });
        contentEditor.addEventListener('scroll', () => { contentHighlighter.scrollTop = contentEditor.scrollTop; contentHighlighter.scrollLeft = contentEditor.scrollLeft; });
        modalPostTitle.addEventListener('input', debouncedAutoSave);
        deletePostBtn.addEventListener('click', deletePost);

        showAddTopicModalBtn.addEventListener('click', () => openModal(modals.addTopic));
        addTopicConfirmBtn.addEventListener('click', addTopics);
        showAddPostModalBtn.addEventListener('click', () => openModal(modals.addPost));
        addPostConfirmBtn.addEventListener('click', addPost);
        deleteTopicBtn.addEventListener('click', deleteActiveTopic);
        settingsBtn.addEventListener('click', () => { blogPromptInput.value = state.settings.blogPrompt; diagramPromptInput.value = state.settings.diagramPrompt; openModal(modals.settings); });
        saveSettingsBtn.addEventListener('click', async () => { state.settings.blogPrompt = blogPromptInput.value; state.settings.diagramPrompt = diagramPromptInput.value; await db.put('settings', { id: 'userSettings', data: state.settings }); closeModal(modals.settings); showToast('설정을 저장했습니다.'); });
        topicResourcesInput.addEventListener('input', debounce(async () => { if (!state.activeTopicId) return; const topic = state.topics.find(t=>t.id===state.activeTopicId); if(topic) { topic.resources = topicResourcesInput.value; await db.put('topics', topic); console.log("Saved topic resources"); }}, 750));
        
        document.querySelectorAll('.prompt-action-btn').forEach(btn => btn.addEventListener('click', () => {
            const post = (state.posts.get(state.activeTopicId) || []).find(p => p.id === state.activePostId);
            const promptText = getPromptText(btn.dataset.type, post);
            if(promptText === null) return;
            if (btn.dataset.action === 'copy') { navigator.clipboard.writeText(promptText).then(() => { showToast('프롬프트가 복사되었습니다!'); if (btn.dataset.type === 'blog') updateChecklistItem(post, 'c1', true); if (btn.dataset.type === 'diagram') updateChecklistItem(post, 'c3', true); }).catch(err => showToast('복사 실패.', true)); }
            else if (btn.dataset.action === 'download') { const blob = new Blob([promptText], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${btn.dataset.type}_prompt.txt`; a.click(); URL.revokeObjectURL(url); }
        }));
        
        viewSwitcherBtns.forEach(btn => btn.addEventListener('click', () => { state.currentView = btn.dataset.view; viewSwitcherBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderActiveView(); }));
        
        diagramUploadArea.addEventListener('click', () => diagramUploadInput.click());
        diagramUploadInput.addEventListener('change', (e) => handleDiagramFiles(e.target.files));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => diagramUploader.addEventListener(ev, e => {e.preventDefault(); e.stopPropagation();}, false));
        ['dragenter', 'dragover'].forEach(ev => diagramUploader.addEventListener(ev, () => diagramUploader.classList.add('dragover'), false));
        ['dragleave', 'drop'].forEach(ev => diagramUploader.addEventListener(ev, () => diagramUploader.classList.remove('dragover'), false));
        diagramUploader.addEventListener('drop', (e) => handleDiagramFiles(e.dataTransfer.files), false);
        modals.post.addEventListener('paste', (e) => { if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') { handleDiagramFiles(e.clipboardData.files); } });
        
        uploadPostFilesBtn.addEventListener('click', () => postUploadInput.click());
        postUploadInput.addEventListener('change', (e) => { addPostsFromFiles(e.target.files); e.target.value = null; });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => postCardContainer.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }, false));
        ['dragenter', 'dragover'].forEach(ev => postCardContainer.addEventListener(ev, () => { if(state.activeTopicId) postCardContainer.classList.add('drag-over-posts'); }, false));
        ['dragleave', 'drop'].forEach(ev => postCardContainer.addEventListener(ev, () => postCardContainer.classList.remove('drag-over-posts'), false));
        postCardContainer.addEventListener('drop', e => { const files = [...e.dataTransfer.files].filter(f => f.type === 'text/plain' || f.name.endsWith('.txt')); if(files.length > 0) addPostsFromFiles(files); }, false);

        Object.values(modals).forEach(m => { m.addEventListener('click', (e) => { if (e.target === m) closeModal(m); }); m.querySelectorAll('.modal-close-btn').forEach(b => b.addEventListener('click', () => closeModal(m))); });
        confirmCancelBtn.addEventListener('click', () => { closeModal(modals.confirm); confirmCallback = null; });
        modals.confirm.querySelector('.modal-close-btn')?.addEventListener('click', () => { closeModal(modals.confirm); confirmCallback = null; });
        confirmOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); });
        
        exportDataBtn.addEventListener('click', (e) => { e.preventDefault(); exportData(); });
        importDataBtn.addEventListener('click', (e) => { e.preventDefault(); importFileInput.click(); });
        importFileInput.addEventListener('change', (e) => { importData(e.target.files[0]); e.target.value = null; });
        hamburgerBtn.addEventListener('click', () => appContainer.classList.toggle('sidebar-open'));
        sidebarOverlay.addEventListener('click', () => appContainer.classList.remove('sidebar-open'));

        // --- Final Initialization ---
        await loadInitialData();
    });
    </script>
</body>
</html>
