<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 텍스트 추출기 (Multi-File)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Noto Sans KR) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans KR', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
        // PDF.js Worker 설정
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        body {
            background-color: #f8fafc;
        }
        .drag-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        /* Custom Scrollbar */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        textarea::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .file-list-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .file-list-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .file-list-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 shadow-sm z-10 shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i data-lucide="layers" class="text-brand-600 w-6 h-6"></i>
                <h1 class="text-xl font-bold text-slate-800">PDF 텍스트 추출기 <span class="text-xs font-normal text-slate-500 ml-1">Multi</span></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="resetApp()" class="text-slate-500 hover:text-slate-700 p-2 rounded-full hover:bg-slate-100 transition-colors" title="전체 초기화">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden max-w-7xl mx-auto w-full">
        
        <!-- Left Panel: Controls & Input -->
        <div class="w-full lg:w-1/3 p-4 overflow-y-auto border-r border-slate-200 bg-white flex flex-col gap-6">
            
            <!-- Upload Area -->
            <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all duration-200 group cursor-pointer hover:border-brand-500 hover:bg-slate-50 relative">
                <input type="file" id="file-input" class="hidden" accept=".pdf" multiple>
                <div class="flex flex-col items-center gap-3">
                    <div id="drop-icon" class="w-12 h-12 bg-blue-50 text-brand-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p id="drop-text-main" class="font-medium text-slate-700">PDF 파일 추가</p>
                        <p id="drop-text-sub" class="text-xs text-slate-400 mt-1">드래그하거나 클릭하여 여러 파일을 선택하세요.</p>
                    </div>
                </div>
            </div>

            <!-- File List Container -->
            <div id="file-list-wrapper" class="hidden flex flex-col gap-2 max-h-60">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                        <i data-lucide="files" class="w-4 h-4"></i> 선택된 파일 <span id="file-count" class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs">0</span>
                    </h3>
                    <button onclick="clearFiles()" class="text-xs text-red-500 hover:text-red-700 font-medium">전체 삭제</button>
                </div>
                <div id="file-list" class="flex flex-col gap-2 overflow-y-auto file-list-scrollbar pr-1">
                    <!-- File Items will be injected here -->
                </div>
            </div>

            <!-- Options -->
            <div class="space-y-4">
                <h3 class="text-sm font-semibold text-slate-900 flex items-center gap-2">
                    <i data-lucide="settings-2" class="w-4 h-4"></i> 추출 옵션
                </h3>
                
                <div class="space-y-3">
                    <!-- Range -->
                    <div>
                        <label class="text-xs font-medium text-slate-600 mb-1 block">공통 페이지 범위 (선택 사항)</label>
                        <div class="flex gap-2 items-center">
                            <input type="number" id="page-start" placeholder="1" min="1" class="w-full text-sm border-slate-300 rounded-md shadow-sm focus:ring-brand-500 focus:border-brand-500 p-2 border">
                            <span class="text-slate-400">-</span>
                            <input type="number" id="page-end" placeholder="끝" class="w-full text-sm border-slate-300 rounded-md shadow-sm focus:ring-brand-500 focus:border-brand-500 p-2 border">
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">* 모든 파일에 동일하게 적용됩니다. 비워두면 전체입니다.</p>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white border border-slate-200 rounded-md p-3 space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="smart-join" class="rounded border-slate-300 text-brand-600 focus:ring-brand-500" checked>
                            <span class="text-sm text-slate-600 group-hover:text-slate-800">문장 자동 연결 (줄바꿈 제거)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="clean-space" class="rounded border-slate-300 text-brand-600 focus:ring-brand-500" checked>
                            <span class="text-sm text-slate-600 group-hover:text-slate-800">과도한 공백 제거</span>
                        </label>
                         <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="add-page-num" class="rounded border-slate-300 text-brand-600 focus:ring-brand-500" checked>
                            <span class="text-sm text-slate-600 group-hover:text-slate-800">페이지/파일 구분자 삽입</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <button id="extract-btn" onclick="startExtraction()" class="w-full bg-brand-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-md transition-all" disabled>
                <i data-lucide="play" class="w-4 h-4"></i> 텍스트 추출 시작
            </button>

            <!-- Progress Bar -->
            <div id="progress-container" class="hidden space-y-2">
                <div class="flex justify-between text-xs text-slate-500">
                    <span id="progress-status" class="truncate max-w-[70%]">대기 중...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden">
                    <div id="progress-bar" class="bg-brand-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

        </div>

        <!-- Right Panel: Result & Editor -->
        <div class="flex-1 bg-slate-50 p-4 lg:p-6 flex flex-col h-full overflow-hidden relative">
            
            <div class="flex items-center justify-between mb-3 shrink-0">
                <h2 class="font-semibold text-slate-700 flex items-center gap-2">
                    <i data-lucide="file-output" class="w-4 h-4"></i> 통합 결과
                </h2>
                <div class="flex gap-2" id="action-buttons">
                    <button onclick="copyToClipboard()" class="text-xs bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-3 py-1.5 rounded-md flex items-center gap-1.5 shadow-sm transition-all disabled:opacity-50" id="btn-copy" disabled>
                        <i data-lucide="copy" class="w-3 h-3"></i> 복사
                    </button>
                    <button onclick="downloadText()" class="text-xs bg-brand-600 text-white hover:bg-brand-700 px-3 py-1.5 rounded-md flex items-center gap-1.5 shadow-sm transition-all disabled:opacity-50" id="btn-download" disabled>
                        <i data-lucide="download" class="w-3 h-3"></i> .txt 다운로드
                    </button>
                </div>
            </div>

            <div class="relative flex-1 rounded-lg border border-slate-300 bg-white shadow-sm overflow-hidden flex flex-col">
                <textarea id="result-text" class="flex-1 w-full p-4 resize-none outline-none text-sm leading-relaxed text-slate-700 font-mono" placeholder="선택한 파일들의 텍스트가 순서대로 여기에 합쳐집니다."></textarea>
                
                <!-- Status Footer inside Textarea container -->
                <div class="bg-slate-50 border-t border-slate-200 px-3 py-2 text-xs text-slate-500 flex justify-between items-center shrink-0">
                    <div id="result-stats">글자 수: 0</div>
                    <div class="text-slate-400">Editable</div>
                </div>
                
                <!-- Overlay Loader -->
                <div id="loading-overlay" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-10 hidden flex flex-col items-center justify-center">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-10 w-10 mb-3"></div>
                    <p class="text-sm font-medium text-slate-600 animate-pulse">파일 처리 중...</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm transition-opacity duration-300 opacity-0 pointer-events-none z-50 flex items-center gap-2">
        <i data-lucide="info" class="w-4 h-4 text-brand-400"></i>
        <span id="toast-msg">메시지</span>
    </div>

    <script>
        // --- Variables ---
        let selectedFiles = []; // Array to store multiple files
        let isExtracting = false;

        // --- Elements ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileListWrapper = document.getElementById('file-list-wrapper');
        const fileListContainer = document.getElementById('file-list');
        const fileCountEl = document.getElementById('file-count');
        
        const extractBtn = document.getElementById('extract-btn');
        const resultText = document.getElementById('result-text');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const progressStatus = document.getElementById('progress-status');
        const loadingOverlay = document.getElementById('loading-overlay');
        const btnCopy = document.getElementById('btn-copy');
        const btnDownload = document.getElementById('btn-download');
        const resultStats = document.getElementById('result-stats');

        // --- Initialization ---
        lucide.createIcons();

        // --- Event Listeners ---
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length) {
                handleFiles(e.dataTransfer.files);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFiles(e.target.files);
                // Reset input so same files can be selected again if cleared
                fileInput.value = '';
            }
        });

        resultText.addEventListener('input', updateStats);

        // --- Functions ---

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.textContent = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(f => f.type === 'application/pdf');
            
            if (newFiles.length === 0) {
                showToast('PDF 파일만 지원합니다.', 'error');
                return;
            }

            // Append new files
            selectedFiles = [...selectedFiles, ...newFiles];
            updateFileListUI();
            showToast(`${newFiles.length}개 파일이 추가되었습니다.`);
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileListUI();
        }

        function clearFiles() {
            selectedFiles = [];
            updateFileListUI();
            resetProgress();
            // resultText.value = ''; // Optional: Clear result when files are cleared? Let's keep result.
        }

        function updateFileListUI() {
            fileListContainer.innerHTML = '';
            fileCountEl.textContent = selectedFiles.length;

            const dropIcon = document.getElementById('drop-icon');
            const dropTextMain = document.getElementById('drop-text-main');
            const dropTextSub = document.getElementById('drop-text-sub');

            if (selectedFiles.length > 0) {
                fileListWrapper.classList.remove('hidden');
                
                dropZone.classList.remove('p-8');
                dropZone.classList.add('p-4');
                
                if(dropTextMain) dropTextMain.textContent = "파일 추가하기";
                if(dropTextSub) dropTextSub.classList.add('hidden');
                
                if(dropIcon) {
                    dropIcon.classList.remove('w-12', 'h-12');
                    dropIcon.classList.add('w-8', 'h-8');
                }
                
                extractBtn.disabled = false;
                extractBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                fileListWrapper.classList.add('hidden');
                
                dropZone.classList.add('p-8');
                dropZone.classList.remove('p-4');
                
                if(dropTextMain) dropTextMain.textContent = "PDF 파일 추가";
                if(dropTextSub) dropTextSub.classList.remove('hidden');
                
                if(dropIcon) {
                    dropIcon.classList.remove('w-8', 'h-8');
                    dropIcon.classList.add('w-12', 'h-12');
                }
                
                extractBtn.disabled = true;
                extractBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }

            selectedFiles.forEach((file, index) => {
                const el = document.createElement('div');
                el.className = 'bg-slate-50 border border-slate-200 rounded p-2 flex items-center gap-2 group hover:border-brand-200 transition-colors';
                el.innerHTML = `
                    <div class="bg-white p-1.5 rounded border border-slate-100 text-brand-600">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-medium text-slate-700 truncate">${file.name}</p>
                        <p class="text-[10px] text-slate-400">${(file.size / (1024*1024)).toFixed(2)} MB</p>
                    </div>
                    <button onclick="removeFile(${index})" class="text-slate-400 hover:text-red-500 p-1 rounded-full hover:bg-slate-100">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                `;
                fileListContainer.appendChild(el);
            });
            
            lucide.createIcons();
        }

        function resetApp() {
            clearFiles();
            resultText.value = '';
            updateStats();
            btnCopy.disabled = true;
            btnDownload.disabled = true;
            document.getElementById('page-start').value = '';
            document.getElementById('page-end').value = '';
            resetProgress();
        }

        function resetProgress() {
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            document.getElementById('progress-percent').textContent = '0%';
        }

        function updateStats() {
            const text = resultText.value;
            const length = text.length;
            resultStats.textContent = `글자 수: ${length.toLocaleString()}`;
        }

        async function startExtraction() {
            if (selectedFiles.length === 0 || isExtracting) return;

            isExtracting = true;
            extractBtn.disabled = true;
            extractBtn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> 처리 중...';
            loadingOverlay.classList.remove('hidden');
            progressContainer.classList.remove('hidden');
            resultText.value = ''; 

            const smartJoin = document.getElementById('smart-join').checked;
            const cleanSpace = document.getElementById('clean-space').checked;
            const addPageNum = document.getElementById('add-page-num').checked;
            
            // Global Page Range Inputs
            const pageStartInput = parseInt(document.getElementById('page-start').value);
            const pageEndInput = parseInt(document.getElementById('page-end').value);

            let accumulatedText = "";

            try {
                for (let fIndex = 0; fIndex < selectedFiles.length; fIndex++) {
                    const file = selectedFiles[fIndex];
                    
                    // Update Status for File Switch
                    progressStatus.textContent = `파일 (${fIndex + 1}/${selectedFiles.length}): ${file.name}`;
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                    const pdfDoc = await loadingTask.promise;
                    
                    const numPages = pdfDoc.numPages;
                    let startPage = (pageStartInput && pageStartInput >= 1) ? pageStartInput : 1;
                    let endPage = (pageEndInput && pageEndInput <= numPages) ? pageEndInput : numPages;

                    if (startPage > numPages) startPage = 1;
                    if (endPage < startPage) endPage = numPages;

                    // File Header
                    if (selectedFiles.length > 1 || addPageNum) {
                        accumulatedText += `\n=================================================================\n`;
                        accumulatedText += `FILE: ${file.name} (Total Pages: ${numPages})\n`;
                        accumulatedText += `=================================================================\n\n`;
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        // Calculate Global Progress (approximate logic per file chunk)
                        const fileProgress = ((i - startPage + 1) / (endPage - startPage + 1));
                        const globalProgress = ((fIndex + fileProgress) / selectedFiles.length) * 100;
                        
                        progressBar.style.width = `${Math.min(globalProgress, 100)}%`;
                        document.getElementById('progress-percent').textContent = `${Math.round(globalProgress)}%`;
                        
                        // Per-page status only if it's slow
                        if (numPages > 20) {
                             progressStatus.textContent = `(${fIndex + 1}/${selectedFiles.length}) ${file.name} - P.${i}`;
                        }

                        const page = await pdfDoc.getPage(i);
                        const textContent = await page.getTextContent();
                        
                        let pageText = "";
                        let lastY = -1;
                        
                        for (let item of textContent.items) {
                            if (lastY != -1 && Math.abs(item.transform[5] - lastY) > 5) {
                                pageText += "\n";
                            } else if (pageText !== "" && !pageText.endsWith(" ") && !pageText.endsWith("\n")) {
                                pageText += " ";
                            }
                            pageText += item.str;
                            lastY = item.transform[5];
                        }

                        if (cleanSpace) pageText = pageText.replace(/\s+/g, ' ').trim();
                        if (smartJoin) pageText = pageText.replace(/([^\.\?\!\n])\n([^\n])/g, '$1 $2');
                        if (addPageNum) accumulatedText += `\n--- [${file.name}] Page ${i} ---\n\n`;

                        accumulatedText += pageText + "\n\n";
                        
                        if (i % 5 === 0) await new Promise(resolve => setTimeout(resolve, 0));
                    }
                    
                    // Add separation between files
                    accumulatedText += "\n\n";
                }

                resultText.value = accumulatedText.trim();
                updateStats();
                
                showToast('모든 파일의 처리가 완료되었습니다.');
                btnCopy.disabled = false;
                btnDownload.disabled = false;
                
                // Final Progress State
                progressBar.style.width = '100%';
                document.getElementById('progress-percent').textContent = '100%';
                progressStatus.textContent = '완료됨';

            } catch (error) {
                console.error(error);
                showToast('오류 발생: ' + error.message, 'error');
            } finally {
                isExtracting = false;
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<i data-lucide="play" class="w-4 h-4 mr-2"></i> 텍스트 추출 시작';
                lucide.createIcons();
                loadingOverlay.classList.add('hidden');
            }
        }

        function copyToClipboard() {
            resultText.select();
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            showToast('전체 결과가 복사되었습니다.');
        }

        function downloadText() {
            if (!resultText.value) return;
            
            const textToSave = resultText.value;
            // Generate filename based on first file or generic
            const fileName = selectedFiles.length === 1 
                ? `${selectedFiles[0].name.replace('.pdf', '')}_extracted.txt`
                : `merged_extraction_${selectedFiles.length}files.txt`;

            const blob = new Blob([textToSave], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('파일이 다운로드 되었습니다.');
        }
    </script>
</body>
</html>
