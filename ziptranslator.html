<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBook ë²ˆì—­ ê´€ë¦¬ ë„êµ¬ v5.7 (SoC Refactored)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        /* ë‹¤í¬ëª¨ë“œ í…Œë§ˆ ë° ì „ì²´ ë ˆì´ì•„ì›ƒ */
        :root {
            --bg-primary: #131314;
            --bg-secondary: #1e1f20;
            --bg-tertiary: #2d2e30;
            --bg-hover: #3c4043;
            --text-primary: #e2e2e3;
            --text-secondary: #bdc1c6;
            --accent-blue: #8ab4f8;
            --accent-yellow: #fdd663;
            --accent-pink: #f28b82;
            --border-color: #3c4043;
            --header-height: 60px;
            --sidebar-width: 280px;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            font-size: 16px;
            height: 100vh;
            overflow: hidden;
        }

        /* ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ */
        .btn { 
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem; border-radius: 0.5rem; 
            font-weight: 600; transition: all 0.2s ease-in-out; 
            border: 1px solid transparent; cursor: pointer;
        }
        .btn i { font-size: 1.1rem; }
        .btn-primary { background-color: var(--accent-blue); color: var(--bg-primary); }
        .btn-primary:hover { filter: brightness(0.9); }
        .btn-danger { background-color: var(--accent-pink); color: var(--bg-primary); }
        .btn-danger:hover { filter: brightness(0.9); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--bg-hover); }
        .btn-warning { background-color: var(--accent-yellow); color: var(--bg-primary); }
        .btn-warning:hover { filter: brightness(0.9); }

        input[type="text"], textarea {
            background-color: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border-color); border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none; border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.3);
        }

        /* ë ˆì´ì•„ì›ƒ */
        #app { display: flex; flex-direction: column; height: 100%; }
        header { 
            height: var(--header-height); background-color: var(--bg-secondary); 
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
       
        /* [ìˆ˜ì •ë¨] ëŒ€ì‹œë³´ë“œ & ì‘ì—…ê³µê°„ ë·°ê°€ ì»¨í…Œì´ë„ˆë¥¼ ì±„ìš°ê³ , ë·° ìì²´ëŠ” ìŠ¤í¬ë¡¤ë˜ì§€ ì•Šë„ë¡ ìˆ˜ì • */
        #dashboard-view, #workspace-view {
            display: flex; /* ìì‹ ìš”ì†Œ(header, main)ì˜ ë ˆì´ì•„ì›ƒì„ ìœ„í•´ flexë¡œ ì„¤ì • */
            flex-direction: column; /* ìì‹ ìš”ì†Œë¥¼ ìˆ˜ì§ìœ¼ë¡œ ìŒ“ìŒ */
            flex-grow: 1; /* #appì˜ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
            overflow: hidden; /* ë·° ìì²´ê°€ ìŠ¤í¬ë¡¤ë˜ëŠ” ê²ƒì„ ë°©ì§€. ë‚´ë¶€ mainë§Œ ìŠ¤í¬ë¡¤ë¨ */
        }
       
        #dashboard-view > main { flex-grow: 1; overflow-y: auto; }
        .dashboard-content-wrapper { padding: 1.5rem; }

        .card { 
            background-color: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 0.75rem; transition: all 0.2s ease-in-out; 
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-4px); border-color: var(--accent-blue); }
        .progress-bar-bg { background-color: var(--bg-tertiary); }
        .progress-bar { background-color: var(--accent-blue); }

        #workspace-view > main { display: flex; flex-grow: 1; overflow: hidden; }
        aside { 
            width: var(--sidebar-width); background-color: var(--bg-secondary); 
            border-right: 1px solid var(--border-color); flex-shrink: 0;
            display: flex; flex-direction: column;
        }
        #file-list { flex-grow: 1; overflow-y: auto; }
        .file-item, .dir-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 0.375rem; cursor: pointer; }
        .file-item:hover, .dir-item:hover { background-color: var(--bg-hover); }
        .file-item.selected { background-color: var(--accent-blue) !important; color: var(--bg-primary); font-weight: 600; }
        .file-item.selected .status-icon { color: var(--bg-primary) !important; }
        .file-item.copied-prompt { border-left: 3px solid var(--accent-yellow); }
        .status-icon.status-translated { color: var(--accent-blue); }
        .status-icon.status-untranslated { color: var(--text-secondary); }

        .editor-container { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .editor-panes { display: flex; flex-grow: 1; min-height: 0; }
        .editor-pane { width: 50%; display: flex; flex-direction: column; padding: 1rem; }
        .editor-pane:first-child { border-right: 1px solid var(--border-color); }
        .editor-pane textarea, .editor-pane .text-display { 
            flex-grow: 1; background-color: var(--bg-primary); 
            border: 1px solid var(--border-color); border-radius: 0.375rem; 
            padding: 0.75rem; overflow-y: auto;
        }
       
        /* ëª¨ë‹¬ ë° í† ìŠ¤íŠ¸ */
        .modal-backdrop { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.7); z-index: 50; }
        .modal-content { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; }
       
        @keyframes toast-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
        .toast {
            animation: toast-in 0.4s ease, toast-out 0.4s ease 2.6s forwards;
            padding: 0.75rem 1.25rem; min-width: 280px; max-width: 90%;
            text-align: center; color: var(--bg-primary);
            border-radius: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-weight: 600;
        }
        .toast.toast-success { background-color: var(--accent-blue); }
        .toast.toast-error { background-color: var(--accent-pink); }
        .toast.toast-info { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div id="app">
        <div id="loading-view" class="fixed inset-0 bg-black bg-opacity-75 flex-col items-center justify-center z-50 hidden">
            <div class="w-16 h-16 border-4 border-t-4 border-t-[var(--accent-blue)] border-[var(--border-color)] rounded-full animate-spin"></div>
            <p id="loading-message" class="text-white text-xl mt-4">í”„ë¡œì íŠ¸ ì²˜ë¦¬ ì¤‘...</p>
        </div>
       
        <div id="confirm-modal" class="modal-backdrop hidden">
            <div class="modal-content w-full max-w-md p-6">
                <h3 id="confirm-title" class="text-lg font-bold mb-4"></h3>
                <p id="confirm-message" class="mb-6 text-[var(--text-secondary)]"></p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-cancel-btn" class="btn btn-secondary">ì·¨ì†Œ</button>
                    <button id="confirm-ok-btn" class="btn btn-danger">ì‚­ì œ</button>
                </div>
            </div>
        </div>

        <div id="dashboard-view">
            <header class="flex justify-between items-center px-6">
                <h1 class="text-xl font-bold">eBook ë²ˆì—­ ëŒ€ì‹œë³´ë“œ</h1>
                <button id="new-project-btn" class="btn btn-primary"><i class="bi bi-plus-lg"></i>ìƒˆ í”„ë¡œì íŠ¸</button>
                <input type="file" id="zip-file-input" class="hidden" accept=".zip">
            </header>
            <main>
                <div class="dashboard-content-wrapper">
                    <div id="project-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        </div>
                    <div id="no-project-message" class="text-center py-12 hidden">
                        <i class="bi bi-folder-x text-5xl text-[var(--text-secondary)]"></i>
                        <h3 class="mt-4 text-lg font-medium">í”„ë¡œì íŠ¸ ì—†ìŒ</h3>
                        <p class="mt-1 text-[var(--text-secondary)]">ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•˜ì—¬ ë²ˆì—­ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </main>
        </div>

        <div id="workspace-view" class="hidden">
            <header class="flex justify-between items-center px-4">
                <div class="flex items-center gap-2">
                    <button id="back-to-dashboard-btn" class="p-2 rounded-full hover:bg-[var(--bg-hover)]">
                        <i class="bi bi-arrow-left text-xl"></i>
                    </button>
                    <h2 id="workspace-project-name" class="text-lg font-bold"></h2>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="export-btn" class="btn btn-secondary"><i class="bi bi-box-arrow-down"></i>ë‚´ë³´ë‚´ê¸°</button>
                    <button id="copy-prompt-btn" class="btn btn-secondary"><i class="bi bi-clipboard"></i>í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button>
                    <button id="save-translation-btn" class="btn btn-primary"><i class="bi bi-check-lg"></i>ì €ì¥</button>
                </div>
            </header>
            <main>
                <aside>
                    <div class="p-4 border-b border-[var(--border-color)]">
                        <h3 class="font-semibold">íŒŒì¼ ëª©ë¡</h3>
                    </div>
                    <div id="file-list" class="p-2"></div>
                </aside>
                <div class="editor-container">
                    <div class="p-4 border-b border-[var(--border-color)] bg-[var(--bg-secondary)]">
                        <label for="prompt-template-input" class="block text-sm font-medium mb-1 text-[var(--text-secondary)]">í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ( `&lt;&lt;ì›ë¬¸&gt;&gt;` ë³€ìˆ˜ ì‚¬ìš©)</label>
                        <input type="text" id="prompt-template-input" class="w-full" placeholder="ì˜ˆ: ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜: <<ì›ë¬¸>>">
                    </div>
                    <div class="editor-panes">
                        <section class="editor-pane">
                            <h3 class="text-lg font-semibold mb-2 flex-shrink-0">ì›ë¬¸: <span id="original-file-name" class="font-normal text-[var(--text-secondary)]"></span></h3>
                            <pre id="original-text" class="text-display whitespace-pre-wrap text-sm leading-relaxed"></pre>
                        </section>
                        <section class="editor-pane">
                            <h3 class="text-lg font-semibold mb-2 flex-shrink-0">ë²ˆì—­ë¬¸</h3>
                            <textarea id="translated-text" class="text-sm leading-relaxed" placeholder="ì—¬ê¸°ì— ë²ˆì—­ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>
   
    <div id="toast-container" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] space-y-2"></div>

    <script id="worker" type="javascript/worker">
        // Web Worker ìŠ¤í¬ë¦½íŠ¸ëŠ” ë³€ê²½ ì‚¬í•­ ì—†ìŒ
        self.importScripts('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js');
        self.onmessage=async e=>{const{type:r,payload:s}=e.data;"PROCESS_ZIP"===r&&async function(e){const r=new JSZip;try{self.postMessage({type:"PROGRESS",payload:"ZIP íŒŒì¼ ë¡œë”© ì¤‘..."});const s=await r.loadAsync(e);self.postMessage({type:"PROGRESS",payload:"íŒŒì¼ ëª©ë¡ ë¶„ì„ ì¤‘..."});const t=[];s.forEach((e,r)=>{r.dir||!e.toLowerCase().endsWith(".txt")||t.push(r)});const o=t.length,a=[];for(let e=0;e<o;e++){const r=t[e],s=await r.async("string");a.push({name:r.name,originalText:s}),(e+1)%10==0||e+1===o&&self.postMessage({type:"PROGRESS",payload:`íŒŒì¼ ì²˜ë¦¬ ì¤‘... (${e+1}/${o})`})}self.postMessage({type:"SUCCESS",payload:{files:a}})}catch(e){self.postMessage({type:"ERROR",payload:e.message})}}(s.file)};
    </script>

    <script type="module">
        // ìƒìˆ˜ ë° ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ë³€ê²½ ì—†ìŒ)
        const DB_NAME = 'eBookTranslatorDB', DB_VERSION = 1, PROJECTS_STORE = 'projects', FILES_STORE = 'files';
        let db, worker, currentProjectId = null, currentFile = null;
        const workspaceFileMap = new Map();

        // DOM ìš”ì†Œ ìºì‹± (ë³€ê²½ ì—†ìŒ)
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const views = {
            loading: $('#loading-view'),
            dashboard: $('#dashboard-view'),
            workspace: $('#workspace-view'),
        };
        const dom = {
            loadingMessage: $('#loading-message'), newProjectBtn: $('#new-project-btn'), zipFileInput: $('#zip-file-input'),
            projectList: $('#project-list'), noProjectMessage: $('#no-project-message'), backToDashboardBtn: $('#back-to-dashboard-btn'),
            workspaceProjectName: $('#workspace-project-name'), fileListContainer: $('#file-list'), originalFileName: $('#original-file-name'),
            originalTextEl: $('#original-text'), translatedTextEl: $('#translated-text'), saveTranslationBtn: $('#save-translation-btn'),
            copyPromptBtn: $('#copy-prompt-btn'), exportBtn: $('#export-btn'), promptTemplateInput: $('#prompt-template-input'),
            confirmModal: $('#confirm-modal'), confirmOkBtn: $('#confirm-ok-btn'), confirmCancelBtn: $('#confirm-cancel-btn'),
            toastContainer: $('#toast-container')
        };
       
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ)
        const utils = {
            async copyToClipboard(text) {
                if (navigator.clipboard && window.isSecureContext) {
                    try { await navigator.clipboard.writeText(text); return true; } catch (err) { console.error('Clipboard API failed:', err); }
                }
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.top = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try { return document.execCommand('copy'); } catch (err) { return false; } finally { document.body.removeChild(textArea); }
            }
        };
       
        // IndexedDB ê´€ë¦¬ ê°ì²´ (ë³€ê²½ ì—†ìŒ)
        const dbManager = {
            initDB:()=>new Promise((r,e)=>{const t=indexedDB.open(DB_NAME,DB_VERSION);t.onerror=t=>e("IndexedDB failed: "+t.target.errorCode),t.onsuccess=e=>{db=e.target.result,r(db)},t.onupgradeneeded=e=>{const r=e.target.result;r.objectStoreNames.contains(PROJECTS_STORE)||r.createObjectStore(PROJECTS_STORE,{keyPath:"id"}),r.objectStoreNames.contains(FILES_STORE)||r.createObjectStore(FILES_STORE,{keyPath:["projectId","name"]}).createIndex("by_project","projectId",{unique:!1})}}),
            addProject:e=>new Promise((r,t)=>{const s=db.transaction([PROJECTS_STORE],"readwrite");s.objectStore(PROJECTS_STORE).add(e),s.oncomplete=()=>r(),s.onerror=e=>t(e.target.error)}),
            getProjects:()=>new Promise((r,e)=>{const t=db.transaction([PROJECTS_STORE],"readonly").objectStore(PROJECTS_STORE).getAll();t.onsuccess=()=>r(t.result),t.onerror=r=>e(r.target.error)}),
            getProject:e=>new Promise((r,t)=>{const s=db.transaction([PROJECTS_STORE],"readonly").objectStore(PROJECTS_STORE).get(e);s.onsuccess=()=>r(s.result),s.onerror=e=>t(e.target.error)}),
            updateProject:e=>new Promise((r,t)=>{const s=db.transaction([PROJECTS_STORE],"readwrite");s.objectStore(PROJECTS_STORE).put(e),s.oncomplete=()=>r(),s.onerror=e=>t(e.target.error)}),
            deleteProject:e=>new Promise((r,t)=>{const s=db.transaction([PROJECTS_STORE,FILES_STORE],"readwrite");s.objectStore(PROJECTS_STORE).delete(e);const o=s.objectStore(FILES_STORE).index("by_project").openCursor(IDBKeyRange.only(e));o.onsuccess=e=>{const r=e.target.result;r&&(r.delete(),r.continue())},s.oncomplete=()=>r(),s.onerror=e=>t(e.target.error)}),
            addFiles:e=>new Promise((r,t)=>{if(0===e.length)return void r();const s=db.transaction([FILES_STORE],"readwrite");e.forEach(e=>s.objectStore(FILES_STORE).add(e)),s.oncomplete=()=>r(),s.onerror=e=>t(e.target.error)}),
            getFilesForProject:e=>new Promise((r,t)=>{const s=db.transaction([FILES_STORE],"readonly").objectStore(FILES_STORE).index("by_project").getAll(e);s.onsuccess=()=>r(s.result),s.onerror=e=>t(e.target.error)}),
            updateFile:e=>new Promise((r,t)=>{const s=db.transaction([FILES_STORE],"readwrite");s.objectStore(FILES_STORE).put(e),s.oncomplete=()=>r(),s.onerror=e=>t(e.target.error)})
        };

        const uiManager = {
            /**
             * [ìˆ˜ì •ë¨] ë·° ì „í™˜ ë¡œì§: í´ë˜ìŠ¤ ê¸°ë°˜ìœ¼ë¡œë§Œ ì œì–´í•˜ì—¬ ì•ˆì •ì„± í™•ë³´.
             * ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ 'ì–´ë–¤ ë·°ë¥¼ ë³´ì—¬ì¤„ ê²ƒì¸ê°€'ë§Œ ê²°ì •í•˜ë©°, ë°ì´í„° ë Œë”ë§ì€ ê´€ì—¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
             */
            switchView(viewName) {
                Object.values(views).forEach(v => v.classList.add('hidden'));
                if (views[viewName]) {
                    views[viewName].classList.remove('hidden');
                }
            },
            showLoading(message) { dom.loadingMessage.textContent = message; views.loading.classList.remove('hidden'); views.loading.classList.add('flex'); },
            hideLoading() { views.loading.classList.add('hidden'); views.loading.classList.remove('flex'); },
            
            /**
             * ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ê³  í™”ë©´ì— ë Œë”ë§í•œë‹¤. (ë·° ì „í™˜ì€ í¬í•¨í•˜ì§€ ì•ŠìŒ)
             */
            async renderDashboard() {
                const projects = await dbManager.getProjects();
                dom.projectList.innerHTML = '';
                if (projects.length === 0) {
                    dom.noProjectMessage.classList.remove('hidden');
                } else {
                    dom.noProjectMessage.classList.add('hidden');
                    projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    // ë³‘ë ¬ ì²˜ë¦¬ë¥¼ í†µí•´ ë Œë”ë§ ì†ë„ ê°œì„ 
                    const projectCardsPromises = projects.map(async (project) => {
                        const files = await dbManager.getFilesForProject(project.id);
                        const total = files.length, translated = files.filter(f => f.status === 'translated').length;
                        const progress = total > 0 ? Math.round((translated / total) * 100) : 0;
                        const card = document.createElement('div');
                        card.className = 'card p-4';
                        card.innerHTML = `
                            <div class="flex-grow">
                                <div class="flex justify-between items-start gap-2">
                                    <h3 class="text-lg font-bold truncate" title="${project.name}">${project.name}</h3>
                                    <button data-project-id="${project.id}" class="delete-project-btn p-1 text-[var(--text-secondary)] hover:text-[var(--accent-pink)] rounded-full flex-shrink-0"><i class="bi bi-trash3"></i></button>
                                </div>
                                <p class="text-sm text-[var(--text-secondary)] mt-1 mb-3">ìƒì„±ì¼: ${new Date(project.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="mt-auto">
                                <div class="flex justify-between text-sm font-medium"><p>ì§„í–‰ë¥ </p><p>${progress}% (${translated}/${total})</p></div>
                                <div class="w-full progress-bar-bg rounded-full h-2 mt-1"><div class="progress-bar h-2 rounded-full" style="width: ${progress}%"></div></div>
                                <button data-project-id="${project.id}" class="open-project-btn btn btn-primary w-full mt-4">ì‘ì—… ì‹œì‘</button>
                            </div>`;
                        return card;
                    });
                    const projectCards = await Promise.all(projectCardsPromises);
                    projectCards.forEach(card => dom.projectList.appendChild(card));
                }
            },
            
            /**
             * ì‘ì—… ê³µê°„ ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ê³  í™”ë©´ì— ë Œë”ë§í•œë‹¤. (ë·° ì „í™˜ì€ í¬í•¨í•˜ì§€ ì•ŠìŒ)
             */
            async renderWorkspace(projectId) {
                currentProjectId = projectId;
                const project = await dbManager.getProject(projectId);
                const files = await dbManager.getFilesForProject(projectId);
                
                dom.workspaceProjectName.textContent = project.name;
                dom.promptTemplateInput.value = project.promptTemplate || 'ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜: <<ì›ë¬¸>>';
                
                workspaceFileMap.clear();
                files.forEach(file => workspaceFileMap.set(file.name, file));
                
                const fileTree = {};
                files.forEach(file => {
                    let current = fileTree;
                    file.name.split('/').forEach((part, i, arr) => {
                        if (i === arr.length - 1) current[part] = file;
                        else { current[part] = current[part] || {}; current = current[part]; }
                    });
                });
                
                dom.fileListContainer.innerHTML = this.buildFileTreeHTML(fileTree);
                this.clearEditorPane();
            },
            buildFileTreeHTML(node) {
                let html = '<ul class="space-y-1">';
                Object.keys(node).sort((a,b)=>{const aIsDir=typeof node[a].name==="undefined",bIsDir=typeof node[b].name==="undefined";if(aIsDir&&!bIsDir)return-1;if(!aIsDir&&bIsDir)return 1;return a.localeCompare(b)}).forEach(key=>{
                    const isDir = typeof node[key].name === "undefined";
                    if (isDir) {
                        html += `<li><details open><summary class="dir-item"><i class="bi bi-folder-fill text-[var(--accent-yellow)]"></i><span class="font-medium text-sm">${key}</span></summary><div class="pl-4">${this.buildFileTreeHTML(node[key])}</div></details></li>`;
                    } else {
                        const file = node[key];
                        const iconClass = file.status === 'translated' ? 'status-translated' : 'status-untranslated';
                        const promptClass = file.promptCopied ? 'copied-prompt' : '';
                        html += `<li><div class="file-item ${promptClass}" data-file-name="${file.name}"><i class="bi bi-check-circle-fill status-icon ${iconClass}"></i><span class="text-sm truncate" title="${key}">${key}</span></div></li>`;
                    }
                });
                return html + '</ul>';
            },
            clearEditorPane() {
                currentFile = null; 
                dom.originalFileName.textContent = ''; 
                dom.originalTextEl.textContent = 'ì¢Œì¸¡ ëª©ë¡ì—ì„œ ë²ˆì—­í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'; 
                dom.translatedTextEl.value = '';
                $$('.file-item.selected').forEach(el => el.classList.remove('selected'));
            },
            updateFileStatusIcon(fileName, status) {
                const icon = dom.fileListContainer.querySelector(`[data-file-name="${fileName}"] .status-icon`);
                if (icon) {
                    icon.classList.toggle('status-translated', status === 'translated');
                    icon.classList.toggle('status-untranslated', status !== 'translated');
                }
            },
            updatePromptCopiedIndicator(fileName, isCopied) {
                const fileItem = dom.fileListContainer.querySelector(`[data-file-name="${fileName}"]`);
                if(fileItem) fileItem.classList.toggle('copied-prompt', isCopied);
            },
            showConfirm(title, message) {
                return new Promise(resolve => {
                    $('#confirm-title').textContent = title; $('#confirm-message').textContent = message; 
                    dom.confirmModal.classList.remove('hidden');
                    const onOk = () => { cleanup(); resolve(true); }; 
                    const onCancel = () => { cleanup(); resolve(false); };
                    const cleanup = () => { 
                        dom.confirmOkBtn.removeEventListener('click', onOk); 
                        dom.confirmCancelBtn.removeEventListener('click', onCancel); 
                        dom.confirmModal.classList.add('hidden'); 
                    };
                    dom.confirmOkBtn.addEventListener('click', onOk, { once: true }); 
                    dom.confirmCancelBtn.addEventListener('click', onCancel, { once: true });
                });
            },
            showToast(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                dom.toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), duration);
            }
        };

        const eventHandlers = {
            init() {
                dom.newProjectBtn.addEventListener('click', () => dom.zipFileInput.click());
                dom.zipFileInput.addEventListener('change', this.handleNewProject);
               
                // [ìˆ˜ì •ë¨] ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ë°ì´í„° ë Œë”ë§ê³¼ ë·° ì „í™˜ì„ ëª…ì‹œì ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ í˜¸ì¶œ
                dom.projectList.addEventListener('click', async (e) => {
                    const openBtn = e.target.closest('.open-project-btn');
                    const deleteBtn = e.target.closest('.delete-project-btn');

                    if (openBtn) {
                        uiManager.showLoading('ì‘ì—… ê³µê°„ ë¡œë”© ì¤‘...');
                        await uiManager.renderWorkspace(openBtn.dataset.projectId); // 1. ë°ì´í„° ì¤€ë¹„
                        uiManager.hideLoading();
                        uiManager.switchView('workspace'); // 2. ë·° ì „í™˜
                    }
                    if (deleteBtn) {
                        this.handleDeleteProject(deleteBtn.dataset.projectId);
                    }
                });

                // [ìˆ˜ì •ë¨] ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°ˆ ë•Œë„ ë™ì¼í•œ íŒ¨í„´ ì ìš©
                dom.backToDashboardBtn.addEventListener('click', async () => {
                    currentProjectId = null;
                    uiManager.showLoading('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì¤‘...');
                    await uiManager.renderDashboard(); // 1. ë°ì´í„° ì¤€ë¹„
                    uiManager.hideLoading();
                    uiManager.switchView('dashboard'); // 2. ë·° ì „í™˜
                });

                dom.fileListContainer.addEventListener('click', (e) => { const fileItem = e.target.closest('.file-item'); if (fileItem) this.handleFileSelect(fileItem.dataset.fileName); });
                dom.saveTranslationBtn.addEventListener('click', this.handleSaveTranslation);
                dom.copyPromptBtn.addEventListener('click', this.handleCopyPrompt);
                dom.exportBtn.addEventListener('click', this.handleExport);
                dom.promptTemplateInput.addEventListener('blur', this.handleSavePromptTemplate);
            },
            handleNewProject: async (event) => { const file = event.target.files[0]; if (!file) return; uiManager.showLoading('í”„ë¡œì íŠ¸ ìƒì„± ì¤‘...'); worker.postMessage({ type: 'PROCESS_ZIP', payload: { file } }); dom.zipFileInput.value = ''; },
            handleDeleteProject: async (projectId) => { const p = await dbManager.getProject(projectId); const ok = await uiManager.showConfirm('í”„ë¡œì íŠ¸ ì‚­ì œ', `'${p.name}' í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ íŒŒì¼ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`); if (ok) { await dbManager.deleteProject(projectId); uiManager.showToast(`'${p.name}' ì‚­ì œ ì™„ë£Œ.`, 'info'); uiManager.renderDashboard(); } },
            handleFileSelect: async (fileName) => {
                // ë‹¤ë¥¸ íŒŒì¼ ì„ íƒ ì „, í˜„ì¬ ì‘ì—… ë‚´ìš© ìë™ ì €ì¥
                if (currentFile && dom.translatedTextEl.value !== (currentFile.translatedText || '')) {
                    await eventHandlers.handleSaveTranslation({ showToast: false, moveToNext: false });
                }

                const file = workspaceFileMap.get(fileName);
                if (file) {
                    currentFile = file; 
                    dom.originalFileName.textContent = file.name.split('/').pop(); 
                    dom.originalTextEl.textContent = file.originalText; 
                    dom.translatedTextEl.value = file.translatedText || '';
                    
                    $$('.file-item.selected').forEach(el => el.classList.remove('selected'));
                    dom.fileListContainer.querySelector(`[data-file-name="${fileName}"]`)?.classList.add('selected');
                    dom.copyPromptBtn.className = `btn ${file.promptCopied ? 'btn-warning' : 'btn-secondary'}`;
                }
            },
            handleSaveTranslation: async (options = {}) => {
                const { showToast = true, moveToNext = true } = options;
                if (!currentFile) { if (showToast) uiManager.showToast('ì €ì¥í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                
                const newText = dom.translatedTextEl.value;
                const oldText = currentFile.translatedText || '';
                const hasChanged = newText !== oldText;

                if (!hasChanged && !moveToNext) return;

                currentFile.translatedText = newText; 
                currentFile.status = newText.trim() ? 'translated' : 'untranslated';
                
                await dbManager.updateFile(currentFile);
                uiManager.updateFileStatusIcon(currentFile.name, currentFile.status);
                if (hasChanged && showToast) uiManager.showToast(`'${currentFile.name.split('/').pop()}' ì €ì¥ ì™„ë£Œ!`, 'success');
                workspaceFileMap.set(currentFile.name, currentFile);
                
                if (moveToNext) {
                    const fileItems = Array.from($$('.file-item'));
                    const files = fileItems.map(el => el.dataset.fileName);
                    const currentIndex = files.indexOf(currentFile.name);
                    
                    // ë‹¤ìŒ ë¯¸ë²ˆì—­ íŒŒì¼ì„ ì°¾ìŒ (í˜„ì¬ íŒŒì¼ ë‹¤ìŒë¶€í„° ìˆœíšŒ)
                    const nextFileToTranslate = [...files.slice(currentIndex + 1), ...files.slice(0, currentIndex + 1)].find(f => workspaceFileMap.get(f)?.status === 'untranslated');

                    if (nextFileToTranslate) {
                        eventHandlers.handleFileSelect(nextFileToTranslate);
                    } else if (hasChanged) {
                        uiManager.showToast('ëª¨ë“  íŒŒì¼ ë²ˆì—­ ì™„ë£Œ! ğŸ‰', 'info');
                    }
                }
            },
            handleSavePromptTemplate: async () => { if (!currentProjectId) return; const p = await dbManager.getProject(currentProjectId); const t = dom.promptTemplateInput.value; if (p.promptTemplate === t) return; p.promptTemplate = t; await dbManager.updateProject(p); uiManager.showToast('í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì €ì¥ë¨.', 'info'); },
            handleCopyPrompt: async () => { if (!currentFile) { uiManager.showToast('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.', 'error'); return; } if (!currentFile.promptCopied) { currentFile.promptCopied = true; await dbManager.updateFile(currentFile); workspaceFileMap.get(currentFile.name).promptCopied = true; dom.copyPromptBtn.className = 'btn btn-warning'; uiManager.updatePromptCopiedIndicator(currentFile.name, true); } const t = dom.promptTemplateInput.value || '<<ì›ë¬¸>>', p = t.replace('<<ì›ë¬¸>>', currentFile.originalText); if (await utils.copyToClipboard(p)) uiManager.showToast('í”„ë¡¬í”„íŠ¸ ë³µì‚¬ ì™„ë£Œ.'); else uiManager.showToast('ë³µì‚¬ ì‹¤íŒ¨.', 'error'); },
            handleExport: async () => { if (!currentProjectId) return; uiManager.showLoading('ë‚´ë³´ë‚´ê¸° íŒŒì¼ ìƒì„± ì¤‘...'); try { const p = await dbManager.getProject(currentProjectId), files = await dbManager.getFilesForProject(currentProjectId); files.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true })); let text = `í”„ë¡œì íŠ¸: ${p.name}\në‚´ë³´ë‚´ê¸° ë‚ ì§œ: ${new Date().toLocaleString()}\n========================================\n\n`; files.forEach(f => { text += `--- íŒŒì¼: ${f.name} ---\n${f.translatedText||"[ë²ˆì—­ë˜ì§€ ì•ŠìŒ]"}\n\n` }); const blob = new Blob([text], { type: "text/plain;charset=utf-8" }), url = URL.createObjectURL(blob), a = document.createElement("a"); a.href = url, a.download = `${p.name}_ë²ˆì—­ë³¸.txt`, document.body.appendChild(a), a.click(), document.body.removeChild(a), URL.revokeObjectURL(url), uiManager.showToast('ë²ˆì—­ë³¸ì´ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.', 'info'); } catch (err) { uiManager.showToast('ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error'); console.error(err); } finally { uiManager.hideLoading(); } }
        };

        function setupWorker() {
            const script = $('#worker').textContent;
            worker = new Worker(URL.createObjectURL(new Blob([script], { type: 'application/javascript' })));
            worker.onmessage = async (e) => {
                const { type, payload } = e.data;
                if (type === 'PROGRESS') return uiManager.showLoading(payload);
                if (type === 'ERROR') { uiManager.hideLoading(); return uiManager.showToast(`íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ${payload}`, 'error'); }
                if (type === 'SUCCESS') {
                    const newProjectId = `proj_${Date.now()}`;
                    const originalFileName = dom.zipFileInput.files[0]?.name || 'ìƒˆ í”„ë¡œì íŠ¸.zip';
                    const projectName = originalFileName.replace(/\.zip$/i, '');
                    const newProject = { id: newProjectId, name: projectName, createdAt: new Date().toISOString(), promptTemplate: 'ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜: <<ì›ë¬¸>>' };
                    const filesToSave = payload.files.map(f => ({ ...f, projectId: newProjectId, translatedText: '', status: 'untranslated', promptCopied: false }));
                    
                    await dbManager.addProject(newProject);
                    await dbManager.addFiles(filesToSave);
                    
                    uiManager.showToast(`'${projectName}' í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ.`, 'success');
                    await uiManager.renderDashboard(); // ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë§Œ ë‹¤ì‹œ ë¡œë“œ
                    uiManager.hideLoading();
                    // ë·° ì „í™˜ì€ í•˜ì§€ ì•ŠìŒ (ì´ë¯¸ ëŒ€ì‹œë³´ë“œ ë·° ìƒíƒœ)
                }
            };
        }
       
        async function init() {
            try { 
                await dbManager.initDB(); 
                setupWorker(); 
                eventHandlers.init(); 
                
                // [ìˆ˜ì •ë¨] ì´ˆê¸°í™” ì‹œ ë°ì´í„° ë Œë”ë§ í›„, ëª…ì‹œì ìœ¼ë¡œ ë·°ë¥¼ ì „í™˜
                uiManager.showLoading('ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì¤‘...');
                await uiManager.renderDashboard(); // 1. ì´ˆê¸° ë°ì´í„° ì¤€ë¹„
                uiManager.hideLoading();
                uiManager.switchView('dashboard'); // 2. ì´ˆê¸° ë·° ì„¤ì •
            }
            catch (error) { 
                console.error("ì´ˆê¸°í™” ì‹¤íŒ¨:", error); 
                document.body.innerHTML = `<div class="p-8 text-center text-red-500">ì•± ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. IndexedDBê°€ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ëŠ”ì§€, ë˜ëŠ” ë¹„ê³µê°œ ëª¨ë“œê°€ ì•„ë‹Œì§€ í™•ì¸í•˜ì„¸ìš”.</div>`; 
            }
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
