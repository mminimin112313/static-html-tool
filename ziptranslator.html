<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBook ë²ˆì—­ ê´€ë¦¬ ë„êµ¬ v6.2 (Prompt UX Enhanced)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        :root {
            --bg-primary: #131314; --bg-secondary: #1e1f20; --bg-tertiary: #2d2e30;
            --bg-hover: #3c4043; --text-primary: #e2e2e3; --text-secondary: #bdc1c6;
            --accent-blue: #8ab4f8; --accent-yellow: #fdd663; --accent-pink: #f28b82;
            --border-color: #3c4043; --header-height: 60px; --sidebar-width: 280px;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); font-size: 16px; height: 100vh; overflow: hidden; }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; border: 1px solid transparent; cursor: pointer; }
        .btn i { font-size: 1.1rem; }
        .btn-primary { background-color: var(--accent-blue); color: var(--bg-primary); }
        .btn-primary:hover { filter: brightness(0.9); }
        .btn-danger { background-color: var(--accent-pink); color: var(--bg-primary); }
        .btn-danger:hover { filter: brightness(0.9); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--bg-hover); }
        .btn-icon { padding: 0.5rem; }
        input[type="text"], textarea { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.3); }
        #app { display: flex; flex-direction: column; height: 100%; }
        header { height: var(--header-height); background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .view { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        #dashboard-view > main { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; transition: all 0.2s ease-in-out; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-4px); border-color: var(--accent-blue); }
        .progress-bar-bg { background-color: var(--bg-tertiary); }
        .progress-bar { background-color: var(--accent-blue); }
        #workspace-view > main { display: flex; flex-grow: 1; overflow: hidden; }
        aside { width: var(--sidebar-width); background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; }
        #file-list { flex-grow: 1; overflow-y: auto; }
        .file-item, .dir-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 0.375rem; cursor: pointer; }
        .file-item:hover, .dir-item:hover { background-color: var(--bg-hover); }
        .file-item.selected { background-color: var(--accent-blue) !important; color: var(--bg-primary); font-weight: 600; }
        .file-item.selected .status-icon { color: var(--bg-primary) !important; }
        .status-icon.status-translated { color: var(--accent-blue); }
        .status-icon.status-untranslated { color: var(--text-secondary); }
        .editor-container { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .editor-panes { display: flex; flex-grow: 1; min-height: 0; }
        .editor-pane { width: 50%; display: flex; flex-direction: column; padding: 1rem; }
        .editor-pane:first-child { border-right: 1px solid var(--border-color); }
        .editor-pane textarea, .editor-pane .text-display { flex-grow: 1; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.75rem; overflow-y: auto; white-space: pre-wrap; }
        .modal-backdrop { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.7); z-index: 50; }
        .modal-content { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; }
        @keyframes toast-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
        .toast { animation: toast-in 0.4s ease, toast-out 0.4s ease 2.6s forwards; padding: 0.75rem 1.25rem; min-width: 280px; max-width: 90%; text-align: center; color: var(--bg-primary); border-radius: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-weight: 600; }
        .toast.toast-success { background-color: var(--accent-blue); }
        .toast.toast-error { background-color: var(--accent-pink); }
        .toast.toast-info { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="app">
        <div id="loading-view" class="modal-backdrop hidden">
            <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 border-4 border-t-4 border-t-[var(--accent-blue)] border-[var(--border-color)] rounded-full animate-spin"></div>
                <p id="loading-message" class="text-white text-xl mt-4"></p>
            </div>
        </div>

        <div id="confirm-modal" class="modal-backdrop hidden">
            <div class="modal-content w-full max-w-md p-6">
                <h3 id="confirm-title" class="text-lg font-bold mb-4"></h3>
                <p id="confirm-message" class="mb-6 text-[var(--text-secondary)]"></p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-cancel-btn" class="btn btn-secondary">ì·¨ì†Œ</button>
                    <button id="confirm-ok-btn" class="btn btn-danger">ì‚­ì œ</button>
                </div>
            </div>
        </div>

        <div id="prompt-modal" class="modal-backdrop hidden">
            <div class="modal-content w-full max-w-2xl p-6 flex flex-col">
                <h3 class="text-lg font-bold mb-4">í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì„¤ì •</h3>
                <p class="text-sm text-[var(--text-secondary)] mb-4">
                    `{{text}}`ë¥¼ ì›ë¬¸ì´ ë“¤ì–´ê°ˆ ìœ„ì¹˜ì— ì‚¬ìš©í•˜ì„¸ìš”. ì´ í”„ë¡¬í”„íŠ¸ëŠ” í˜„ì¬ í”„ë¡œì íŠ¸ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
                </p>
                <textarea id="prompt-modal-textarea" class="w-full h-48 min-h-32 text-sm" rows="8"></textarea>
                <div class="flex justify-end space-x-4 mt-6">
                    <button data-action="close-prompt-modal" class="btn btn-secondary">ì·¨ì†Œ</button>
                    <button data-action="save-prompt" class="btn btn-primary">ì €ì¥</button>
                </div>
            </div>
        </div>

        <div id="dashboard-view" class="view">
            <header class="flex justify-between items-center px-6">
                <h1 class="text-xl font-bold">eBook ë²ˆì—­ ëŒ€ì‹œë³´ë“œ</h1>
                <button id="new-project-btn" class="btn btn-primary"><i class="bi bi-plus-lg"></i>ìƒˆ í”„ë¡œì íŠ¸</button>
                <input type="file" id="zip-file-input" class="hidden" accept=".zip">
            </header>
            <main>
                <div id="project-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                <div id="no-project-message" class="text-center py-12 hidden">
                    <i class="bi bi-folder-x text-5xl text-[var(--text-secondary)]"></i>
                    <h3 class="mt-4 text-lg font-medium">í”„ë¡œì íŠ¸ ì—†ìŒ</h3>
                    <p class="mt-1 text-[var(--text-secondary)]">ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•˜ì—¬ ë²ˆì—­ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </main>
        </div>

        <div id="workspace-view" class="view">
            <header class="flex justify-between items-center px-4">
                <div class="flex items-center gap-2">
                    <button data-action="back-to-dashboard" class="p-2 rounded-full hover:bg-[var(--bg-hover)]"><i class="bi bi-arrow-left text-xl"></i></button>
                    <h2 id="workspace-project-name" class="text-lg font-bold"></h2>
                </div>
                <div class="flex items-center space-x-2">
                    <button data-action="copy-prompt" class="btn btn-secondary"><i class="bi bi-clipboard"></i>í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button>
                    <button data-action="export" class="btn btn-secondary"><i class="bi bi-box-arrow-down"></i>ë‚´ë³´ë‚´ê¸°</button>
                    <button data-action="save-translation" class="btn btn-primary"><i class="bi bi-check-lg"></i>ì €ì¥</button>
                    <button data-action="open-prompt-modal" class="btn btn-secondary btn-icon" title="í”„ë¡¬í”„íŠ¸ ì„¤ì •"><i class="bi bi-gear-fill"></i></button>
                </div>
            </header>
            <main>
                <aside>
                    <div class="p-4 border-b border-[var(--border-color)]"><h3 class="font-semibold">íŒŒì¼ ëª©ë¡</h3></div>
                    <div id="file-list" class="p-2"></div>
                </aside>
                <div class="editor-container">
                    <div class="editor-panes p-2">
                        <section class="editor-pane">
                            <h3 class="text-lg font-semibold mb-2 flex-shrink-0">ì›ë¬¸: <span id="original-file-name" class="font-normal text-[var(--text-secondary)]"></span></h3>
                            <div id="original-text" class="text-display"></div>
                        </section>
                        <section class="editor-pane">
                            <h3 class="text-lg font-semibold mb-2 flex-shrink-0">ë²ˆì—­ë¬¸</h3>
                            <textarea id="translated-text" class="text-sm" placeholder="ì—¬ê¸°ì— ë²ˆì—­ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>
   
    <div id="toast-container" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] space-y-2"></div>
    <script id="worker" type="javascript/worker">self.importScripts('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js');self.onmessage=async e=>{const{type:r,payload:s}=e.data;"PROCESS_ZIP"===r&&async function(e){const r=new JSZip;try{self.postMessage({type:"PROGRESS",payload:"ZIP íŒŒì¼ ë¡œë”© ì¤‘..."});const s=await r.loadAsync(e);self.postMessage({type:"PROGRESS",payload:"íŒŒì¼ ëª©ë¡ ë¶„ì„ ì¤‘..."});const t=[];s.forEach((e,r)=>{r.dir||!e.toLowerCase().endsWith(".txt")||t.push(r)});const o=t.length,a=[];for(let e=0;e<o;e++){const r=t[e],s=await r.async("string");a.push({name:r.name,originalText:s}),(e+1)%10==0||e+1===o&&self.postMessage({type:"PROGRESS",payload:`íŒŒì¼ ì²˜ë¦¬ ì¤‘... (${e+1}/${o})`})}self.postMessage({type:"SUCCESS",payload:{files:a}})}catch(e){self.postMessage({type:"ERROR",payload:e.message})}}(s.file)};</script>

    <script type="module">
        const $ = (selector) => document.querySelector(selector);
        const dom = {
            app: $('#app'),
            views: { dashboard: $('#dashboard-view'), workspace: $('#workspace-view') },
            loading: { view: $('#loading-view'), message: $('#loading-message') },
            dashboard: { projectList: $('#project-list'), noProjectMessage: $('#no-project-message'), zipFileInput: $('#zip-file-input') },
            workspace: {
                projectName: $('#workspace-project-name'), fileList: $('#file-list'), 
                originalFileName: $('#original-file-name'), originalText: $('#original-text'), translatedText: $('#translated-text')
            },
            confirm: { modal: $('#confirm-modal'), title: $('#confirm-title'), message: $('#confirm-message'), okBtn: $('#confirm-ok-btn'), cancelBtn: $('#confirm-cancel-btn') },
            promptModal: { view: $('#prompt-modal'), textarea: $('#prompt-modal-textarea')},
            toastContainer: $('#toast-container')
        };
        const dbManager={db:null,initDB(){return new Promise((e,t)=>{const o=indexedDB.open("eBookTranslatorDB_v6",1);o.onerror=e=>t(`IndexedDB Error: ${e.target.errorCode}`),o.onsuccess=t=>{this.db=t.target.result,e(this.db)},o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("projects")||t.createObjectStore("projects",{keyPath:"id"}),t.objectStoreNames.contains("files")||t.createObjectStore("files",{keyPath:["projectId","name"]}).createIndex("by_project","projectId",{unique:!1})}})},get(e,t){return new Promise((o,r)=>{const n=this.db.transaction(e).objectStore(e).get(t);n.onsuccess=()=>o(n.result),n.onerror=()=>r(n.error)})},getAll(e){return new Promise((t,o)=>{const r=this.db.transaction(e).objectStore(e).getAll();r.onsuccess=()=>t(r.result),r.onerror=()=>o(r.error)})},put(e,t){return new Promise((o,r)=>{const n=this.db.transaction(e,"readwrite");n.objectStore(e).put(t),n.oncomplete=()=>o(),n.onerror=()=>r(n.error)})},delete(e,t){return new Promise((o,r)=>{const n=this.db.transaction(e,"readwrite");n.objectStore(e).delete(t),n.oncomplete=()=>o(),n.onerror=()=>r(n.error)})},getFilesForProject(e){return new Promise((t,o)=>{const r=this.db.transaction("files").objectStore("files").index("by_project").getAll(e);r.onsuccess=()=>t(r.result),r.onerror=()=>o(r.error)})},async deleteProjectAndFiles(e){const t=await this.getFilesForProject(e),o=this.db.transaction(["projects","files"],"readwrite"),r=o.objectStore("files");t.forEach(t=>r.delete([t.projectId,t.name])),o.objectStore("projects").delete(e);return new Promise((e,t)=>{o.oncomplete=()=>e(),o.onerror=()=>t(o.error)})}};
        
        let worker;
        function setupWorker(){const e=$("#worker").textContent;worker=new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"}))),worker.onmessage=e=>{const{type:t,payload:o}=e.data;"PROGRESS"===t?actions.setLoading(!0,o):"ERROR"===t?actions.handleError(`Worker Error: ${o}`):"SUCCESS"===t&&actions.createProject(dom.dashboard.zipFileInput.files[0],o.files)}}

        const state = {
            currentView: 'dashboard',
            isLoading: true,
            loadingMessage: 'ì´ˆê¸°í™” ì¤‘...',
            projects: [],
            isPromptModalOpen: false, // NEW
            workspace: {
                projectId: null, projectName: '', files: [],
                currentFile: null, promptTemplate: ''
            }
        };

        function render() {
            dom.loading.view.classList.toggle('hidden', !state.isLoading);
            if(state.isLoading) dom.loading.message.textContent = state.loadingMessage;
            
            dom.promptModal.view.classList.toggle('hidden', !state.isPromptModalOpen); // NEW
            if(state.isPromptModalOpen) dom.promptModal.textarea.value = state.workspace.promptTemplate;

            for(const viewKey in dom.views) {
                dom.views[viewKey].classList.toggle('hidden', state.currentView !== viewKey);
            }
            if (state.currentView === 'dashboard') renderDashboard();
            else if (state.currentView === 'workspace') renderWorkspace();
        }
        
        function renderDashboard(){const{projects:e}=state;dom.dashboard.projectList.innerHTML="",dom.dashboard.noProjectMessage.classList.toggle("hidden",e.length>0),e.length>0&&(e.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)),e.forEach(e=>{const t=document.createElement("div");t.className="card p-4";const o=e.totalFiles>0?Math.round(e.translatedFiles/e.totalFiles*100):0;t.innerHTML=`
                        <div class="flex-grow">
                            <div class="flex justify-between items-start gap-2">
                                <h3 class="text-lg font-bold truncate" title="${e.name}">${e.name}</h3>
                                <button data-action="delete-project" data-project-id="${e.id}" class="p-1 text-[var(--text-secondary)] hover:text-[var(--accent-pink)] rounded-full flex-shrink-0"><i class="bi bi-trash3"></i></button>
                            </div>
                            <p class="text-sm text-[var(--text-secondary)] mt-1 mb-3">ìƒì„±ì¼: ${new Date(e.createdAt).toLocaleDateString()}</p>
                        </div>
                        <div class="mt-auto">
                            <div class="flex justify-between text-sm font-medium"><p>ì§„í–‰ë¥ </p><p>${o}% (${e.translatedFiles}/${e.totalFiles})</p></div>
                            <div class="w-full progress-bar-bg rounded-full h-2 mt-1"><div class="progress-bar h-2 rounded-full" style="width: ${o}%"></div></div>
                            <button data-action="open-workspace" data-project-id="${e.id}" class="btn btn-primary w-full mt-4">ì‘ì—… ì‹œì‘</button>
                        </div>`,dom.dashboard.projectList.appendChild(t)}))}
        function renderWorkspace(){const{projectName:e,files:t,currentFile:o}=state.workspace;dom.workspace.projectName.textContent=e;const r={};t.forEach(e=>{let t=r;e.name.split("/").forEach((o,n,s)=>{n===s.length-1?t[o]=e:(t[o]=t[o]||{},t=t[o])})}),dom.workspace.fileList.innerHTML=buildFileTreeHTML(r),o?(dom.workspace.originalFileName.textContent=o.name.split("/").pop(),dom.workspace.originalText.textContent=o.originalText,dom.workspace.translatedText.value=o.translatedText||"",dom.workspace.translatedText.disabled=!1,dom.workspace.fileList.querySelector(`[data-file-name="${CSS.escape(o.name)}"]`)?.classList.add("selected")):(dom.workspace.originalFileName.textContent="",dom.workspace.originalText.textContent="ì¢Œì¸¡ ëª©ë¡ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.",dom.workspace.translatedText.value="",dom.workspace.translatedText.disabled=!0)}
        function buildFileTreeHTML(e){let t='<ul class="space-y-1">';return Object.keys(e).sort((t,o)=>{const r=!e[t].name,n=!e[o].name;return r&&!n?-1:!r&&n?1:t.localeCompare(o)}).forEach(o=>{e[o].name?t+=`<li><div class="file-item" data-action="select-file" data-file-name="${e[o].name}"><i class="bi bi-check-circle-fill status-icon ${"translated"===e[o].status?"status-translated":"status-untranslated"}"></i><span class="text-sm truncate" title="${o}">${o}</span></div></li>`:t+=`<li><details open><summary class="dir-item"><i class="bi bi-folder-fill text-[var(--accent-yellow)]"></i><span class="font-medium text-sm">${o}</span></summary><div class="pl-4">${buildFileTreeHTML(e[o])}</div></details></li>`}),t+"</ul>"}

        function setState(newState){for(const key in newState){if(key==='workspace'&&typeof newState[key]==='object'&&newState[key]!==null&&!Array.isArray(newState[key])){state.workspace={...state.workspace,...newState[key]}}else{state[key]=newState[key]}}render()}

        const actions = {
            setLoading(isLoading, message = '') { setState({ isLoading, loadingMessage: message }) },
            showToast(message, type = 'success') { const e=document.createElement("div");e.className=`toast toast-${type}`,e.textContent=message,dom.toastContainer.appendChild(e),setTimeout(()=>e.remove(),3e3) },
            async showConfirm(title, message) { dom.confirm.title.textContent=title,dom.confirm.message.textContent=message,dom.confirm.modal.classList.remove("hidden");return new Promise(e=>{const t=o=>{dom.confirm.modal.classList.add("hidden"),dom.confirm.okBtn.onclick=null,dom.confirm.cancelBtn.onclick=null,e(o)};dom.confirm.okBtn.onclick=()=>t(!0),dom.confirm.cancelBtn.onclick=()=>t(!1)}) },
            handleError(error, userMessage = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.') { console.error(error);this.setLoading(false);this.showToast(userMessage, 'error') },
            async init() { try{await dbManager.initDB(),setupWorker(),this.setLoading(true,'í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë”© ì¤‘...'),await this.loadDashboard()}catch(e){this.handleError(e,"ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨")} },
            async loadDashboard() { this.setLoading(true,'ëŒ€ì‹œë³´ë“œ ë¡œë”© ì¤‘...');const e=await dbManager.getAll("projects");for(const t of e){const o=await dbManager.getFilesForProject(t.id);t.totalFiles=o.length,t.translatedFiles=o.filter(e=>"translated"===e.status).length}setState({currentView:'dashboard',isLoading:!1,projects:e,isPromptModalOpen:!1}) },
            async openWorkspace(projectId) { this.setLoading(true,'ì‘ì—… ê³µê°„ ë¡œë”© ì¤‘...');try{const e=await dbManager.get("projects",projectId),t=await dbManager.getFilesForProject(projectId);setState({currentView:"workspace",isLoading:!1,workspace:{projectId:e.id,projectName:e.name,files:t,currentFile:null,promptTemplate:e.promptTemplate||"ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜: {{text}}"}})}catch(e){this.handleError(e,"í”„ë¡œì íŠ¸ë¥¼ ì—¬ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")} },
            selectFile(fileName) { const e=state.workspace.files.find(e=>e.name===fileName);e&&setState({workspace:{currentFile:e}}) },
            async saveCurrentFile(moveToNext=!1) { const{currentFile:e}=state.workspace,{translatedText:t}=dom.workspace;if(!e)return;const o=t.value;if(e.translatedText===o)return void(moveToNext&&this.selectNextUntranslated());const r={...e,translatedText:o,status:o.trim()?"translated":"untranslated"};await dbManager.put("files",r),this.showToast(`${r.name.split("/").pop()} ì €ì¥ ì™„ë£Œ!`,"success");const n=state.workspace.files.map(t=>t.name===r.name?r:t);setState({workspace:{files:n,currentFile:r}}),moveToNext&&this.selectNextUntranslated() },
            selectNextUntranslated() { const{files:e,currentFile:t}=state.workspace,o=e.findIndex(e=>e.name===t.name),r=[...e.slice(o+1),...e.slice(0,o+1)].find(e=>"untranslated"===e.status);r?this.selectFile(r.name):this.showToast("ëª¨ë“  íŒŒì¼ ë²ˆì—­ ì™„ë£Œ! ğŸ‰","info") },
            async createProject(zipFile, files) { try{const e=`proj_${Date.now()}`,t=zipFile.name.replace(/\.zip$/i,"")||"ìƒˆ í”„ë¡œì íŠ¸",o={id:e,name:t,createdAt:new Date().toISOString(),promptTemplate:"ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜: {{text}}"};await dbManager.put("projects",o);const r=files.map(t=>({...t,projectId:e,translatedText:"",status:"untranslated"}));for(const n of r)await dbManager.put("files",n);this.showToast(`'${t}' í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ.`,"success"),await this.loadDashboard()}catch(e){this.handleError(e,"í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨")}finally{dom.dashboard.zipFileInput.value=""} },
            async deleteProject(projectId) { const e=state.projects.find(e=>e.id===projectId);if(!e)return;const t=await this.showConfirm("í”„ë¡œì íŠ¸ ì‚­ì œ",`'${e.name}' í”„ë¡œì íŠ¸ì™€ ëª¨ë“  íŒŒì¼ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);t&&(this.setLoading(true,`'${e.name}' ì‚­ì œ ì¤‘...`),await dbManager.deleteProjectAndFiles(projectId),this.showToast(`'${e.name}' ì‚­ì œ ì™„ë£Œ.`,"info"),await this.loadDashboard()) },
            async exportTranslations() { const{projectId:e,projectName:t,files:o}=state.workspace;if(!e)return;this.setLoading(true,"í…ìŠ¤íŠ¸ íŒŒì¼ ìƒì„± ì¤‘...");o.sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0}));let r=`í”„ë¡œì íŠ¸: ${t}\në‚´ë³´ë‚´ê¸° ë‚ ì§œ: ${new Date().toLocaleString()}\n========================================\n\n`;o.forEach(e=>{r+=`--- íŒŒì¼: ${e.name} ---\n${e.translatedText||"[ë²ˆì—­ë˜ì§€ ì•ŠìŒ]"}\n\n`});const n=new Blob([r],{type:"text/plain;charset=utf-8"}),s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=`${t}_ë²ˆì—­ë³¸.txt`,a.click(),URL.revokeObjectURL(s),a.remove(),this.setLoading(false),this.showToast("ë²ˆì—­ë³¸ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.","info")},
            // --- NEW & UPDATED PROMPT ACTIONS ---
            openPromptModal() { setState({ isPromptModalOpen: true }) },
            closePromptModal() { setState({ isPromptModalOpen: false }) },
            async savePrompt() {
                const newTemplate = dom.promptModal.textarea.value;
                if (state.workspace.promptTemplate === newTemplate) return this.closePromptModal();
                const project = await dbManager.get('projects', state.workspace.projectId);
                project.promptTemplate = newTemplate;
                await dbManager.put('projects', project);
                setState({ workspace: { promptTemplate: newTemplate }, isPromptModalOpen: false });
                this.showToast('í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ', 'info');
            },
            async copyPrompt() {
                const { currentFile, promptTemplate } = state.workspace;
                if (!currentFile) return this.showToast('ë¨¼ì € íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                const prompt = promptTemplate.replace(/\{\{text\}\}/g, currentFile.originalText);
                try {
                    await navigator.clipboard.writeText(prompt);
                    this.showToast('í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch(err) {
                    this.handleError(err, 'í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨');
                }
            }
        };

        dom.app.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const { action, projectId, fileName } = target.dataset;
            if (actions[action]) actions[action](projectId || fileName);
            else if(action === 'delete-project') actions.deleteProject(projectId); // Special case due to legacy naming
        });
        
        $('#new-project-btn').addEventListener('click',()=>dom.dashboard.zipFileInput.click());
        dom.dashboard.zipFileInput.addEventListener('change', (e) => { e.target.files.length && worker.postMessage({ type: 'PROCESS_ZIP', payload: { file: e.target.files[0] } }) });

        actions.init();
    </script>
</body>
</html>
