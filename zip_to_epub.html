<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD ZIP to EPUB 변환기</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Required Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        
        /* EPUB Preview Styles simulating reader */
        .preview-content {
            font-family: serif;
            line-height: 1.6;
        }
        .preview-content h1 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .preview-content h2 { font-size: 1.3em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .preview-content p { margin-bottom: 1em; }
        .preview-content code { background: #f3f4f6; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
        .preview-content pre { background: #1f2937; color: #f3f4f6; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 1em; }
        .preview-content blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; color: #4b5563; font-style: italic; }
        .preview-content img { max-width: 100%; height: auto; display: block; margin: 1em auto; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 mb-2">MD ZIP to EPUB 변환기</h1>
            <p class="text-gray-500">Markdown 파일이 담긴 ZIP을 업로드하면 전자책(EPUB)으로 만들어드립니다.</p>
        </header>

        <!-- Main Content -->
        <div class="bg-white rounded-xl shadow-lg p-6 space-y-6">
            
            <!-- 1. Metadata Input -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">책 제목</label>
                    <input type="text" id="bookTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="예: 나의 개발 일지" value="변환된 전자책">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">저자</label>
                    <input type="text" id="bookAuthor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="예: 홍길동" value="Unknown">
                </div>
            </div>

            <!-- 2. File Upload Zone -->
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center transition-colors cursor-pointer hover:border-indigo-400 group">
                <input type="file" id="fileInput" accept=".zip" class="hidden">
                <div class="space-y-3">
                    <svg class="mx-auto h-12 w-12 text-gray-400 group-hover:text-indigo-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <div class="text-gray-600">
                        <span class="font-medium text-indigo-600 hover:text-indigo-500">ZIP 파일 선택</span> 또는 여기로 드래그하세요
                    </div>
                    <p class="text-xs text-gray-400">.md 파일들이 포함된 ZIP 파일 (최대 50MB 권장)</p>
                </div>
            </div>

            <!-- 3. File List & Status -->
            <div id="fileListContainer" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium text-gray-700">발견된 챕터 (Markdown 파일)</h3>
                    <span id="fileCount" class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">0개</span>
                </div>
                <div class="bg-gray-50 rounded-lg border border-gray-200 max-h-60 overflow-y-auto p-2" id="fileList">
                    <!-- Files will be listed here -->
                </div>
                <p class="text-xs text-gray-500 mt-2 text-right">* 파일명을 기준으로 자동 정렬되었습니다.</p>
            </div>

            <!-- 4. Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 pt-4">
                <button id="convertBtn" class="flex-1 bg-indigo-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-indigo-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    EPUB 변환 및 다운로드
                </button>
                <button id="resetBtn" class="bg-white text-gray-700 font-medium py-3 px-6 rounded-lg border border-gray-300 hover:bg-gray-50 transition hidden">
                    초기화
                </button>
            </div>

            <!-- Progress Bar -->
            <div id="progressContainer" class="hidden">
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                    <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="statusText" class="text-sm text-center text-gray-600">준비 중...</p>
            </div>
        </div>

        <!-- Guide -->
        <div class="mt-8 bg-white rounded-xl shadow p-6">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                사용 팁
            </h3>
            <ul class="list-disc list-inside space-y-2 text-sm text-gray-600">
                <li><strong>파일 순서:</strong> 파일 이름을 <code>01_서론.md</code>, <code>02_본론.md</code>와 같이 숫자로 시작하게 만들면 순서가 정확하게 잡힙니다.</li>
                <li><strong>이미지:</strong> 현재 버전은 텍스트 중심입니다. Markdown 내의 이미지 문법은 텍스트로 남거나 깨진 이미지로 표시될 수 있습니다.</li>
                <li><strong>제목:</strong> Markdown 파일 내부의 첫 번째 <code># 제목</code> 태그나 파일 이름을 챕터 제목으로 사용합니다.</li>
            </ul>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const convertBtn = document.getElementById('convertBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const bookTitleInput = document.getElementById('bookTitle');
        const bookAuthorInput = document.getElementById('bookAuthor');

        // --- State ---
        let loadedZip = null;
        let mdFiles = [];

        // --- Event Listeners ---
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        convertBtn.addEventListener('click', generateEpub);
        resetBtn.addEventListener('click', () => location.reload());

        // --- Logic ---

        async function handleFile(file) {
            if (!file.name.endsWith('.zip')) {
                alert('ZIP 파일만 업로드 가능합니다.');
                return;
            }

            // UI Reset
            fileList.innerHTML = '';
            mdFiles = [];
            convertBtn.disabled = true;
            statusText.innerText = 'ZIP 파일 분석 중...';
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '10%';

            try {
                loadedZip = await JSZip.loadAsync(file);
                
                // Filter for .md files and ignore __MACOSX garbage
                const fileNames = Object.keys(loadedZip.files).filter(name => 
                    name.toLowerCase().endsWith('.md') && 
                    !name.includes('__MACOSX') &&
                    !loadedZip.files[name].dir
                );

                if (fileNames.length === 0) {
                    alert('ZIP 파일 내에 .md 파일이 없습니다.');
                    progressContainer.classList.add('hidden');
                    return;
                }

                // Sort files smartly (Natural Sort: 1, 2, 10 instead of 1, 10, 2)
                fileNames.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

                progressBar.style.width = '50%';

                // Display files
                fileNames.forEach((name, index) => {
                    // Extract a clean title from filename
                    const simpleName = name.split('/').pop().replace('.md', '');
                    mdFiles.push({
                        path: name,
                        title: simpleName.replace(/^[0-9_\-\.\s]+/, '') || simpleName, // Remove leading numbers for title display if possible
                        originalName: name
                    });

                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 hover:bg-white rounded border-b border-gray-100 last:border-0 text-sm';
                    div.innerHTML = `
                        <div class="flex items-center gap-2 truncate">
                            <span class="text-gray-400 font-mono w-6 text-right">${index + 1}.</span>
                            <span class="font-medium text-gray-700 truncate" title="${name}">${name}</span>
                        </div>
                        <span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded">Chapter</span>
                    `;
                    fileList.appendChild(div);
                });

                fileCount.innerText = `${mdFiles.length}개`;
                fileListContainer.classList.remove('hidden');
                convertBtn.disabled = false;
                
                // Update file title suggestion if generic
                if (bookTitleInput.value === '변환된 전자책') {
                    bookTitleInput.value = file.name.replace('.zip', '');
                }

                progressContainer.classList.add('hidden');
                resetBtn.classList.remove('hidden');
                dropZone.classList.add('hidden'); // Hide dropzone to save space

            } catch (err) {
                console.error(err);
                alert('파일을 읽는 중 오류가 발생했습니다.');
                progressContainer.classList.add('hidden');
            }
        }

        async function generateEpub() {
            convertBtn.disabled = true;
            progressContainer.classList.remove('hidden');
            statusText.innerText = 'Markdown 변환 및 EPUB 생성 중...';
            progressBar.style.width = '0%';

            const epubZip = new JSZip();
            const bookTitle = bookTitleInput.value || 'Untitled';
            const bookAuthor = bookAuthorInput.value || 'Unknown';
            const uuid = 'urn:uuid:' + crypto.randomUUID();
            const timestamp = new Date().toISOString();

            // 1. mimetype (Must be first, no compression)
            epubZip.file("mimetype", "application/epub+zip", { compression: "STORE" });

            // 2. META-INF/container.xml
            epubZip.folder("META-INF").file("container.xml", 
`<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
    <rootfiles>
        <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
    </rootfiles>
</container>`);

            const oebps = epubZip.folder("OEBPS");
            
            // Generate CSS
            oebps.file("style.css", `
body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 1em; }
h1, h2, h3 { color: #333; margin-top: 1.5em; page-break-after: avoid; }
code { background-color: #f4f4f4; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
pre { background-color: #f4f4f4; padding: 1em; overflow-x: auto; border-radius: 5px; }
blockquote { border-left: 4px solid #ddd; margin-left: 0; padding-left: 1em; color: #666; }
img { max-width: 100%; height: auto; }
`);

            // 3. Process Chapters
            let manifestItems = '';
            let spineItems = '';
            let navPoints = '';
            let navLi = '';

            const totalFiles = mdFiles.length;

            for (let i = 0; i < totalFiles; i++) {
                const fileData = mdFiles[i];
                const fileId = `chap${i + 1}`;
                const fileName = `${fileId}.xhtml`;
                
                // Read MD content
                const mdContent = await loadedZip.file(fileData.path).async("string");
                
                // Convert MD to HTML
                let htmlContent = marked.parse(mdContent);

                // Try to find a header in the content to use as title if the filename title is weak
                // Only a heuristic check for # Heading
                const headingMatch = mdContent.match(/^#\s+(.+)$/m);
                let chapterTitle = fileData.title;
                if (headingMatch && headingMatch[1]) {
                    chapterTitle = headingMatch[1].trim();
                }

                // Wrap in XHTML
                const xhtml = `<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
    <title>${escapeXml(chapterTitle)}</title>
    <link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
    <section class="chapter" title="${escapeXml(chapterTitle)}">
        ${htmlContent}
    </section>
</body>
</html>`;

                oebps.file(fileName, xhtml);

                // Add to manifest/spine/toc
                manifestItems += `<item id="${fileId}" href="${fileName}" media-type="application/xhtml+xml"/>\n`;
                spineItems += `<itemref idref="${fileId}"/>\n`;
                
                navPoints += `
    <navPoint id="navPoint-${i+1}" playOrder="${i+1}">
        <navLabel><text>${escapeXml(chapterTitle)}</text></navLabel>
        <content src="${fileName}"/>
    </navPoint>`;

                navLi += `<li><a href="${fileName}">${escapeXml(chapterTitle)}</a></li>\n`;

                // Update Progress
                const percent = Math.round(((i + 1) / totalFiles) * 80);
                progressBar.style.width = `${percent}%`;
            }

            // 4. Generate content.opf
            const contentOpf = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="3.0">
    <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
        <dc:title>${escapeXml(bookTitle)}</dc:title>
        <dc:creator>${escapeXml(bookAuthor)}</dc:creator>
        <dc:identifier id="BookId">${uuid}</dc:identifier>
        <dc:language>ko</dc:language>
        <meta property="dcterms:modified">${timestamp}</meta>
    </metadata>
    <manifest>
        <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
        <item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"/>
        <item id="style" href="style.css" media-type="text/css"/>
        ${manifestItems}
    </manifest>
    <spine toc="ncx">
        ${spineItems}
    </spine>
</package>`;

            oebps.file("content.opf", contentOpf);

            // 5. Generate toc.ncx (EPUB 2 backward compatibility)
            const tocNcx = `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
    <head>
        <meta name="dtb:uid" content="${uuid}"/>
        <meta name="dtb:depth" content="1"/>
        <meta name="dtb:totalPageCount" content="0"/>
        <meta name="dtb:maxPageNumber" content="0"/>
    </head>
    <docTitle><text>${escapeXml(bookTitle)}</text></docTitle>
    <navMap>
        ${navPoints}
    </navMap>
</ncx>`;

            oebps.file("toc.ncx", tocNcx);

            // 6. Generate nav.xhtml (EPUB 3 Navigation)
            const navXhtml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
    <title>${escapeXml(bookTitle)}</title>
</head>
<body>
    <nav epub:type="toc" id="toc">
        <h1>목차</h1>
        <ol>
            ${navLi}
        </ol>
    </nav>
</body>
</html>`;

            oebps.file("nav.xhtml", navXhtml);

            progressBar.style.width = '90%';
            statusText.innerText = 'EPUB 파일 패키징 중...';

            // 7. Generate Final ZIP
            const blob = await epubZip.generateAsync({ type: "blob" });
            
            progressBar.style.width = '100%';
            statusText.innerText = '완료! 다운로드가 시작됩니다.';
            
            // Clean filename
            const safeTitle = bookTitle.replace(/[^a-zA-Z0-9가-힣]/g, "_");
            saveAs(blob, `${safeTitle}.epub`);

            setTimeout(() => {
                convertBtn.disabled = false;
                statusText.innerText = '다운로드 완료';
            }, 1000);
        }

        // Helper: Escape XML special characters
        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }

    </script>
</body>
</html>
